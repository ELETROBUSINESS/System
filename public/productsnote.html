<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Precificador Unitário - Ianetama</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --warning: #f59e0b; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; padding: 20px; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .header-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .box label { display: block; font-weight: bold; font-size: 13px; color: var(--primary); margin-bottom: 5px; }
        
        textarea { width: 100%; height: 120px; border: 1px solid #cbd5e1; border-radius: 6px; padding: 10px; font-size: 12px; margin-bottom: 15px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { background: #1e293b; color: white; padding: 10px; text-align: left; }
        td { padding: 8px 10px; border-bottom: 1px solid #e2e8f0; }
        
        .highlight-venda { background: #fefce8; font-weight: bold; color: #9a3412; font-size: 1.1em; }
        .multiplicador { color: var(--primary); font-weight: bold; }
        .btn-green { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-grid">
        <div class="box">
            <label>Margem de Lucro (%):</label>
            <input type="number" id="marginInput" value="30" style="width: 60px; padding: 5px;">
        </div>
        <div class="box">
            <label>Resumo do Pedido:</label>
            <div id="summary">Aguardando processamento...</div>
        </div>
        <div class="box" style="text-align: right;">
            <button class="btn-green" onclick="processar()">Calcular Preços</button>
            <button class="btn-green" style="background:#0f172a; margin-top:5px" onclick="exportar()">Salvar Excel</button>
        </div>
    </div>

    <textarea id="inputText" placeholder="Cole o texto do PDF aqui..."></textarea>

    <table id="mainTable">
        <thead>
            <tr>
                <th>Item</th>
                <th>Código</th>
                <th>Descrição (Saneada)</th>
                <th>Fator (X)</th>
                <th>Estoque Total</th>
                <th>Custo Un.</th>
                <th class="highlight-venda">Venda Sugerida</th>
                <th>EAN</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    let produtos = [];

    function processar() {
        const text = document.getElementById('inputText').value;
        const margin = parseFloat(document.getElementById('marginInput').value) / 100;
        const lines = text.split('\n');
        const body = document.getElementById('tableBody');
        body.innerHTML = '';
        produtos = [];

        let consolidated = [];
        let temp = "";
        lines.forEach(l => {
            if (/^\d+\s+\d+/.test(l.trim())) {
                if (temp) consolidated.push(temp);
                temp = l.trim();
            } else { temp += " " + l.trim(); }
        });
        if (temp) consolidated.push(temp);

        consolidated.forEach(line => {
            const parts = line.split(/\s+/);
            if (parts.length < 8) return;

            const ean = parts.pop();
            const totalNota = parts.pop();
            const custoPackStr = parts.pop();
            const qtdCompradaStr = parts.pop();
            const un = parts.pop();

            const itemNum = parts.shift();
            const cod = parts.shift();
            let desc = parts.join(" ").replace(/0,00\s+0,00/g, "").replace(/DESCONHECIDO/g, "").trim();

            // Lógica de Extração do Multiplicador (Ex: 24X1 ou C/60 UN)
            let fator = 1;
            const matchX = desc.match(/(\d+)X\d+/); // Padrão 24X1
            const matchC = desc.match(/C\/\s*(\d+)/); // Padrão C/60
            const matchNum = desc.match(/(\d+)$/); // Número isolado no fim (EMB)

            if (matchX) fator = parseInt(matchX[1]);
            else if (matchC) fator = parseInt(matchC[1]);
            else if (matchNum && parts.length > 5) fator = parseInt(matchNum[1]);

            // Limpeza final da descrição (remove o fator do texto para não poluir)
            desc = desc.replace(matchX ? matchX[0] : "", "").replace(matchC ? matchC[0] : "", "").trim();

            const custoPack = parseFloat(custoPackStr.replace(',', '.'));
            const qtdComprada = parseFloat(qtdCompradaStr.replace(',', '.'));
            
            const custoUnitarioReal = custoPack / fator;
            const precoVenda = custoUnitarioReal * (1 + margin);
            const estoqueTotal = qtdComprada * fator;

            const p = {
                item: itemNum, cod, desc, fator, 
                estoque: estoqueTotal,
                custo: custoUnitarioReal.toFixed(2),
                venda: precoVenda.toFixed(2),
                ean
            };

            produtos.push(p);
            body.innerHTML += `
                <tr>
                    <td>${p.item}</td>
                    <td>${p.cod}</td>
                    <td>${p.desc}</td>
                    <td class="multiplicador">${p.fator} un/cx</td>
                    <td>${p.estoque}</td>
                    <td>R$ ${p.custo.replace('.',',')}</td>
                    <td class="highlight-venda">R$ ${p.venda.replace('.',',')}</td>
                    <td>${p.ean}</td>
                </tr>`;
        });
        document.getElementById('summary').innerHTML = `<b>${produtos.length}</b> itens processados.`;
    }

    function exportar() {
        let csv = "\uFEFFItem;Codigo;Descricao;Fator;Estoque_Total;Custo_Unit;Venda;EAN\n";
        produtos.forEach(p => {
            csv += `${p.item};${p.cod};"${p.desc}";${p.fator};${p.estoque};${p.custo};${p.venda};${p.ean}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "precificacao_final.csv";
        a.click();
    }
</script>
</body>
</html>