<!DOCTYPE html>
<html lang="pt-br" data-view="mobile">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loja ELETRO | D'TUDO</title>
    <link rel="icon" href="/assets/img/iconWeb.png">

    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href='https://cdn-uicons.flaticon.com/2.6.0/uicons-solid-straight/css/uicons-solid-straight.css'
        rel='stylesheet'>
    <link href='https://cdn-uicons.flaticon.com/2.6.0/uicons-regular-rounded/css/uicons-regular-rounded.css'
        rel='stylesheet'>

    <!-- Estilos Unificados e Main -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/style26.css">

    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Inter', sans-serif;
            padding-bottom: 90px;
        }

        .product-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            padding: 16px;
            margin-bottom: 0;
            /* Grid handles gap, or manual margins for list */
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .product-card:active {
            transform: scale(0.98);
        }

        .highlight-price {
            color: var(--bs-color);
            font-weight: 800;
        }

        .rent-badge {
            background-color: #e0f2fe;
            color: var(--main);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
        }

        .trust-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: #16a34a;
            background: #dcfce7;
            padding: 4px 10px;
            border-radius: 20px;
            width: fit-content;
        }

        /* Grid Layout Responsive */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* Mobile default */
            gap: 12px;
        }

        @media (min-width: 640px) {
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                /* Adaptive on larger screens */
                gap: 20px;
                justify-content: center;
            }
        }

        /* Cart Badge */
        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: bold;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        /* New Product Image Container */
        .product-image-container {
            width: 100%;
            aspect-ratio: 4/3;
            /* Consistent rectangular shape */
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: #fff;
            border-radius: 12px;
            border: 1px solid #f3f4f6;
            margin-bottom: 12px;
        }

        .product-image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 8px;
            transition: transform 0.3s ease;
        }

        .product-card:hover .product-image-container img {
            transform: scale(1.05);
        }
    </style>
</head>

<body>

    <!-- Header Simples -->
    <!-- Header Simples -->
    <header class="fixed top-0 w-full bg-white/90 backdrop-blur-md z-50 shadow-sm transition-all duration-300">
        <div class="w-full max-w-4xl mx-auto px-4 md:px-8 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3" onclick="window.history.back()">
                <i class='bx bx-arrow-back text-2xl text-gray-700 cursor-pointer'></i>
                <div>
                    <h1 class="text-lg font-bold text-gray-800 tracking-wide">ELETRO</h1>
                    <p class="text-[10px] text-gray-400 font-medium tracking-wider uppercase">Loja Oficial</p>
                </div>
            </div>
        </div>
    </header>

    <div id="shop-page" class="pt-24 px-4 md:px-8 w-full max-w-4xl mx-auto animate-[fadeIn_0.3s_ease] pb-32">

        <!-- User Profile (Minimalist) -->
        <!-- User Profile (Compact & Minimalist) -->
        <div class="bg-white rounded-xl p-3 shadow-sm mb-6 border-gray-100 flex items-center justify-between w-full">
            <div class="flex items-center gap-3 min-w-0">
                <div
                    class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex shrink-0 items-center justify-center font-bold text-xs border-blue-100">
                    NU
                </div>
                <div class="min-w-0 flex-1">
                    <h2 class="text-xs font-bold text-gray-800 leading-tight truncate">A N F da Silva LTDA</h2>
                    <div class="flex items-center gap-1.5 text-[9px] text-gray-400 mt-0.5">
                        <span class="font-medium">Nubia</span>
                        <span class="w-0.5 h-0.5 bg-gray-300 rounded-full"></span>
                        <span class="font-mono truncate">45.692.327/0001-00</span>
                    </div>
                </div>
            </div>
            <div class="pl-4 border-l border-gray-100 shrink-0 text-right ml-2">
                <p class="text-[8px] text-gray-400 uppercase font-bold tracking-widest mb-0.5">Cashback</p>
                <div class="flex items-center justify-end gap-1">
                    <i class='bx bx-dollar-circle text-blue-600 text-sm'></i>
                    <span class="text-sm font-bold text-gray-800">R$ 0,70</span>
                </div>
            </div>
        </div>

        <!-- Seção: Uso em loja -->
        <div class="mb-4 mt-6">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Uso em loja</h3>
        </div>

        <div class="product-grid">
            <!-- Produto: 10 Rolos Bobina (Destaque) -->
            <div class="product-card">
                <div class="product-image-container">
                    <img src="https://http2.mlstatic.com/D_NQ_NP_818796-MLU74423648966_022024-O.webp" alt="Bobina">
                </div>
                <div class="flex-1 flex flex-col">
                    <span
                        class="bg-red-50 text-red-600 text-[9px] font-bold px-2 py-1 rounded w-fit mb-2 uppercase tracking-wide">Tempo
                        Limitado</span>
                    <h2 class="text-sm font-bold text-gray-800 leading-tight mb-2 line-clamp-2">10 Rolos Bobina Epson
                        Tm-t20x</h2>
                    <div class="mt-auto">
                        <p class="text-xs text-gray-400 line-through">R$ 99,90</p>
                        <p class="text-base highlight-price text-black mb-1">R$ 69,90</p>
                        <p class="text-xs text-emerald-600 font-bold mb-2">Economize R$ 30,00</p>
                        <button
                            onclick="addToCart('10 Rolos Bobina Epson Tm-t20x', 69.90, 'https://http2.mlstatic.com/D_NQ_NP_818796-MLU74423648966_022024-O.webp', 1, 0, 99.90)"
                            class="w-full bg-blue-900 text-white py-2 rounded-lg text-sm font-bold shadow-sm hover:opacity-90 transition-all">
                            Adicionar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Produto 1: Leitor Fixo -->
            <div class="product-card">
                <div class="product-image-container">
                    <img src="https://http2.mlstatic.com/D_Q_NP_669652-MLA99474119254_112025-O.webp" alt="Leitor Fixo">
                </div>
                <div class="flex-1 flex flex-col">
                    <h2 class="text-sm font-bold text-gray-800 leading-tight mb-2 line-clamp-2">Leitor Código De Barras
                        Fixo Basic-model</h2>
                    <div class="mt-auto">
                        <p class="text-xs text-gray-400 line-through">R$ 259,90</p>
                        <p class="text-base highlight-price text-black mb-1">R$ 234,90 <span
                                class="text-xs font-normal text-gray-500">ou 2x</span></p>
                        <p class="text-xs text-emerald-600 font-bold mb-2">Economize R$ 25,00 no pix</p>
                        <div class="grid grid-cols-1 gap-2">
                            <button
                                onclick="addToCart('Leitor Fixo Basic-model', 234.90, 'https://http2.mlstatic.com/D_Q_NP_669652-MLA99474119254_112025-O.webp', 2, 0, 259.90)"
                                class="w-full bg-blue-900 text-white py-2 rounded-lg text-sm font-bold shadow-sm hover:opacity-90 transition-all">
                                Adicionar
                            </button>
                            <div class="text-center bg-blue-50/50 rounded py-1 border border-blue-100/50 hidden">
                                <span class="text-[10px] text-blue-600 font-bold">Aluguel: R$ 16,90</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Produto: Leitor Baisec -->
            <div class="product-card">
                <div class="product-image-container">
                    <img src="https://http2.mlstatic.com/D_NQ_NP_2X_751925-MLB78325191660_082024-F.webp"
                        alt="Leitor Baisec">
                </div>
                <div class="flex-1 flex flex-col">
                    <h2 class="text-sm font-bold text-gray-800 leading-tight mb-2 line-clamp-2">Leitor De Codigo De
                        Barras Com Fio Baisec</h2>
                    <div class="mt-auto">
                        <p class="text-base highlight-price text-black mb-2">R$ 97,90 <span
                                class="text-xs font-normal text-gray-500">ou 2x</span></p>
                        <div class="grid grid-cols-1 gap-2">
                            <button
                                onclick="addToCart('Leitor Com Fio Baisec', 97.90, 'https://http2.mlstatic.com/D_NQ_NP_2X_751925-MLB78325191660_082024-F.webp', 2, 0, 0)"
                                class="w-full bg-blue-900 text-white py-2 rounded-lg text-sm font-bold shadow-sm hover:opacity-90 transition-all">
                                Adicionar
                            </button>
                            <div class="text-center bg-blue-50/50 rounded py-1 border border-blue-100/50 hidden">
                                <span class="text-[10px] text-blue-600 font-bold">Aluguel: R$ 9,90</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Produto: Leitor Exbom -->
            <div class="product-card">
                <div class="product-image-container grayscale opacity-75">
                    <img src="https://http2.mlstatic.com/D_NQ_NP_2X_664423-MLA99533126136_122025-F.webp"
                        alt="Leitor Exbom">
                </div>
                <div class="flex-1 flex flex-col">
                    <h2 class="text-sm font-bold text-gray-500 leading-tight mb-2 line-clamp-2">Leitor De Código De
                        Barra Com Fio Exbom</h2>
                    <div class="mt-auto">
                        <p class="text-base highlight-price text-gray-500 mb-2">R$ 117,49 <span
                                class="text-xs font-normal text-gray-400">ou 2x</span></p>
                        <button disabled
                            class="w-full bg-gray-300 text-gray-500 py-2 rounded-lg text-sm font-bold shadow-sm cursor-not-allowed">
                            Esgotado
                        </button>
                    </div>
                </div>
            </div>



            <!-- New Product: Kit Computador Sistema -->
            <div class="product-card">
                <div class="product-image-container">
                    <img src="https://media.pichau.com.br/media/catalog/product/cache/2f958555330323e505eba7ce930bdf27/5/1/51689591-e6fb-486f-be93-832bb11f86fe_1_18.jpg"
                        alt="Kit Computador Sistema">
                </div>
                <div class="flex-1 flex flex-col">
                    <h2 class="text-sm font-bold text-gray-800 leading-tight mb-2 line-clamp-2">Kit Computador p/
                        Sistema</h2>
                    <div class="mt-auto">
                        <p class="text-xs text-gray-400 line-through">R$ 1.430,50</p>
                        <p class="text-base highlight-price text-black mb-1">R$ 1.102,90 <span
                                class="text-xs font-normal text-gray-500">ou 4x</span></p>
                        <p class="text-xs text-emerald-600 font-bold mb-2">Economize R$ 327,60 no pix</p>
                        <button
                            onclick="addToCart('Kit Computador Sistema', 1102.90, 'https://media.pichau.com.br/media/catalog/product/cache/2f958555330323e505eba7ce930bdf27/5/1/51689591-e6fb-486f-be93-832bb11f86fe_1_18.jpg', 4, 0, 1430.50)"
                            class="w-full bg-blue-900 text-white py-2 rounded-lg text-sm font-bold shadow-sm hover:opacity-90 transition-all">
                            Adicionar
                        </button>
                    </div>
                </div>
            </div>

            <!-- New Product: Kit Computador + Cadeira -->
            <div class="product-card">
                <div class="product-image-container">
                    <img src="https://media.pichau.com.br/media/catalog/product/cache/2f958555330323e505eba7ce930bdf27/c/c/cc5251ab-15a7-429e-98dc-99a380ae1aa7.jpg"
                        alt="Kit Computador + Cadeira">
                </div>
                <div class="flex-1 flex flex-col">
                    <h2 class="text-sm font-bold text-gray-800 leading-tight mb-2 line-clamp-2">Kit computador p/
                        sistema + Cadeira</h2>
                    <div class="mt-auto">
                        <p class="text-xs text-gray-400 line-through">R$ 1.659,90</p>
                        <p class="text-base highlight-price text-black mb-1">R$ 1.342,80 <span
                                class="text-xs font-normal text-gray-500">ou 4x</span></p>
                        <p class="text-xs text-emerald-600 font-bold mb-2">Economize R$ 317,10 no pix</p>
                        <button
                            onclick="addToCart('Kit computador p/ sistema + Cadeira', 1342.80, 'https://media.pichau.com.br/media/catalog/product/cache/2f958555330323e505eba7ce930bdf27/c/c/cc5251ab-15a7-429e-98dc-99a380ae1aa7.jpg', 4, 0, 1659.90)"
                            class="w-full bg-blue-900 text-white py-2 rounded-lg text-sm font-bold shadow-sm hover:opacity-90 transition-all">
                            Adicionar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Produto: Leitor Knup -->
            <div class="product-card">
                <div class="product-image-container">
                    <img src="https://http2.mlstatic.com/D_NQ_NP_2X_910337-MLA95493924308_102025-F.webp"
                        alt="Leitor Knup">
                </div>
                <div class="flex-1 flex flex-col">
                    <h2 class="text-sm font-bold text-gray-800 leading-tight mb-2 line-clamp-2">Leitor De Código De
                        Barras Knup</h2>
                    <div class="mt-auto">
                        <p class="text-xs text-gray-400 line-through">R$ 179,90</p>
                        <p class="text-base highlight-price text-black mb-1">R$ 159,90 <span
                                class="text-xs font-normal text-gray-500">ou 2x</span></p>
                        <p class="text-xs text-emerald-600 font-bold mb-2">Economize R$ 20,00 no pix</p>
                        <div class="grid grid-cols-1 gap-2">
                            <button
                                onclick="addToCart('Leitor Knup Com Suporte', 159.90, 'https://http2.mlstatic.com/D_NQ_NP_2X_910337-MLA95493924308_102025-F.webp', 2, 0, 179.90)"
                                class="w-full bg-blue-900 text-white py-2 rounded-lg text-sm font-bold shadow-sm hover:opacity-90 transition-all">
                                Adicionar
                            </button>
                            <div class="text-center bg-blue-50/50 rounded py-1 border border-blue-100/50 hidden">
                                <span class="text-[10px] text-blue-600 font-bold">Aluguel: R$ 14,20</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Produto: Camera Kateluo -->
            <div class="product-card">
                <div class="product-image-container">
                    <img src="https://http2.mlstatic.com/D_NQ_NP_2X_711866-MLA101431313907_122025-F.webp" alt="Camera">
                </div>
                <div class="flex-1 flex flex-col">
                    <h2 class="text-sm font-bold text-gray-800 leading-tight mb-2 line-clamp-2">Câmera De Segurança
                        Smart Ip Wifi</h2>
                    <div class="mt-auto">
                        <p class="text-xs text-gray-400 line-through">R$ 155,79</p>
                        <p class="text-base highlight-price text-black mb-1">R$ 134,90</p>
                        <p class="text-xs text-emerald-600 font-bold mb-2">Economize R$ 20,89 no pix</p>
                        <button
                            onclick="addToCart('Câmera Smart Ip Wifi Kateluo', 134.90, 'https://http2.mlstatic.com/D_NQ_NP_2X_711866-MLA101431313907_122025-F.webp', 1, 0, 155.79)"
                            class="w-full bg-blue-900 text-white py-2 rounded-lg text-sm font-bold shadow-sm hover:opacity-90 transition-all">
                            Adicionar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Produto: Leitor Sem Fio -->
            <div class="product-card">
                <div class="product-image-container">
                    <img src="https://images.tcdn.com.br/img/img_prod/1214924/leitor_de_codigo_de_barra_sem_fio_a_1484_24110_2_6d75d135ebccafeb787ef6452efded8b.jpg"
                        alt="Leitor Sem Fio">
                </div>
                <div class="flex-1 flex flex-col">
                    <h2 class="text-sm font-bold text-gray-800 leading-tight mb-2 line-clamp-2">Leitor Sem Fio
                        Livre-Avance</h2>
                    <div class="mt-auto">
                        <p class="text-xs text-gray-400 line-through">R$ 199,99</p>
                        <p class="text-base highlight-price text-black mb-2">R$ 199,99 <span
                                class="text-xs font-normal text-gray-500">ou 2x</span></p>
                        <div class="grid grid-cols-1 gap-2">
                            <button
                                onclick="addToCart('Leitor Sem Fio Livre-Avance', 199.99, 'https://images.tcdn.com.br/img/img_prod/1214924/leitor_de_codigo_de_barra_sem_fio_a_1484_24110_2_6d75d135ebccafeb787ef6452efded8b.jpg', 2, 0, 0)"
                                class="w-full bg-blue-900 text-white py-2 rounded-lg text-sm font-bold shadow-sm hover:opacity-90 transition-all">
                                Adicionar
                            </button>
                            <div class="text-center bg-blue-50/50 rounded py-1 border border-blue-100/50 hidden">
                                <span class="text-[10px] text-blue-600 font-bold">Aluguel: R$ 12,90</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Produto: Teclado -->
            <div class="product-card">
                <div class="product-image-container">
                    <img src="https://http2.mlstatic.com/D_Q_NP_735713-MLA99973706633_112025-F.webp" alt="Teclado">
                </div>
                <div class="flex-1 flex flex-col">
                    <h2 class="text-sm font-bold text-gray-800 leading-tight mb-2 line-clamp-2">Kit Teclado e Mouse
                        Logtech</h2>
                    <div class="mt-auto">
                        <p class="text-xs text-gray-400 line-through">R$ 179,90</p>
                        <p class="text-base highlight-price text-black mb-1">R$ 164,90</p>
                        <p class="text-xs text-emerald-600 font-bold mb-2">Economize R$ 15,00 no pix</p>
                        <button
                            onclick="addToCart('Kit Teclado e Mouse Logtech', 164.90, 'https://http2.mlstatic.com/D_Q_NP_735713-MLA99973706633_112025-F.webp', 1, 0, 179.90)"
                            class="w-full bg-blue-900 text-white py-2 rounded-lg text-sm font-bold shadow-sm hover:opacity-90 transition-all">
                            Adicionar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Produto: Kit PC (Esgotado) -->
            <div class="product-card">
                <div class="product-image-container grayscale opacity-75">
                    <img src="https://m.magazineluiza.com.br/a-static/420x420/computador-completo-intel-core-i5-8gb-hd-500gb-monitor-hdmi-19-5-windows-10-quantum-flex/3greentechnology/39851/1fc652c085a4844458a3cd9e01f200ab.jpeg"
                        alt="Kit PC">
                </div>
                <div class="flex-1 flex flex-col">
                    <h2 class="text-sm font-bold text-gray-500 leading-tight mb-2 line-clamp-2">Kit Computador p/ Ponto
                        de Venda</h2>
                    <div class="mt-auto">
                        <p class="text-xs text-gray-400 line-through">R$ 1.300,90</p>
                        <p class="text-base highlight-price text-gray-500 mb-2">R$ 1.097,90 <span
                                class="text-xs font-normal text-gray-400">ou 4x</span></p>
                        <button disabled
                            class="w-full bg-gray-300 text-gray-500 py-2 rounded-lg text-sm font-bold shadow-sm cursor-not-allowed">
                            Esgotado
                        </button>
                    </div>
                </div>
            </div>

            <!-- Produto: Crachá -->
            <div class="product-card">
                <div class="product-image-container">
                    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEjfF_2HVi3Cb--rTz-wnIG5NobrMX3oid8J0cecE_wOcqhF1rsibATsVTnThQshupdNtvPeTO1LETgWiMgGhNXTlVpLHO0Na-iGcO-GAdXmbEwolZFun8hI7rNdZ_6JOuW03ZR8EkAK_z8QRqHpGZn5Wo9EbVGj21_e0MSy1CJRwf1pVmV-bOXvaCDnIxY"
                        alt="Crachá">
                </div>
                <div class="flex-1 flex flex-col">
                    <h2 class="text-sm font-bold text-gray-800 leading-tight mb-2 line-clamp-2">Crachá Personalizado
                        D'Tudo</h2>
                    <div class="mt-auto">
                        <p class="text-base highlight-price text-black mb-2">R$ 29,90 <span
                                class="text-xs font-normal text-gray-500">un</span></p>
                        <button
                            onclick="addToCart('Crachá Personalizado', 29.90, 'https://blogger.googleusercontent.com/img/a/AVvXsEjfF_2HVi3Cb--rTz-wnIG5NobrMX3oid8J0cecE_wOcqhF1rsibATsVTnThQshupdNtvPeTO1LETgWiMgGhNXTlVpLHO0Na-iGcO-GAdXmbEwolZFun8hI7rNdZ_6JOuW03ZR8EkAK_z8QRqHpGZn5Wo9EbVGj21_e0MSy1CJRwf1pVmV-bOXvaCDnIxY', 1, 0, 0)"
                            class="w-full bg-blue-900 text-white py-2 rounded-lg text-sm font-bold shadow-sm hover:opacity-90 transition-all">
                            Adicionar
                        </button>
                    </div>
                </div>
            </div>
        </div>



        <!-- Toast Container -->
        <div id="toast-container"
            style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 350px; pointer-events: none;">
        </div>

        <!-- Modal Pagamento -->
        <div id="modalPagamento" class="modal"
            style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: flex-end; justify-content: center;">
            <div
                class="bg-white w-full max-w-[500px] rounded-t-3xl p-6 shadow-2xl animate-[slideInUp_0.3s_ease] relative">

                <!-- Close Button -->
                <button onclick="fecharModal()"
                    class="absolute top-4 right-4 p-2 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200 transition-colors">
                    <i class='bx bx-x text-xl'></i>
                </button>

                <div class="text-center mb-6 mt-2">
                    <div
                        class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600">
                        <i class='bx bx-check-shield text-2xl'></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">Finalizar Compra</h2>
                    <p class="text-xs text-gray-500 mt-1">Ambiente seguro verificado</p>
                </div>

                <div class="bg-gray-50 p-4 rounded-xl mb-6 border border-gray-100">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Produto</p>
                            <h3 id="pagamento-descricao" class="text-sm font-semibold text-gray-800 leading-tight">...
                            </h3>
                        </div>
                    </div>
                    <div class="border-t border-gray-200 my-3"></div>
                    <div class="flex justify-between items-end">
                        <span class="text-xs font-medium text-gray-500">Total a pagar:</span>
                        <h2 id="pagamento-valor" class="text-2xl font-bold text-black leading-none">...</h2>
                    </div>
                </div>

                <div id="payment-area">
                    <div class="space-y-3">
                        <div class="flex items-center gap-3 p-3 border border-blue-200 bg-blue-50 rounded-lg">
                            <i class='bx bx-qr text-2xl text-blue-600'></i>
                            <div>
                                <p class="text-sm font-bold text-gray-800">Pix Instantâneo</p>
                                <p class="text-[10px] text-blue-700">Aprovação imediata</p>
                            </div>
                            <div class="ml-auto">
                                <i class='bx bxs-check-circle text-blue-600 text-lg'></i>
                            </div>
                        </div>
                    </div>

                    <button id="btnGerarPix" onclick="gerarPagamento()"
                        class="w-full mt-6 bg-[var(--bs-color)] text-white py-4 rounded-xl font-bold text-base shadow-lg hover:opacity-90 transition-all flex items-center justify-center gap-2">
                        <i class='bx bx-lock-alt'></i> Comprar Agora
                    </button>

                    <p class="text-[10px] text-center text-gray-400 mt-4 flex items-center justify-center gap-1">
                        <i class='bx bx-shield-quarter'></i> Seus dados estão protegidos.
                    </p>
                </div>
            </div>
        </div>
        <!-- Seção: Itens Adquiridos (Moved to Bottom) -->
        <div class="product-card mt-8 mb-6">
            <h3 class="text-xs font-bold text-gray-800 uppercase tracking-widest mb-4 border-b border-gray-100 pb-2">
                Itens Adquiridos</h3>

            <!-- Item 1 -->
            <div class="flex items-center gap-4 py-3 border-b border-gray-50 last:border-0">
                <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600">
                    <i class='bx bx-barcode text-xl'></i>
                </div>
                <div class="flex-1">
                    <h4 class="text-sm font-bold text-gray-800">Leitor de código de Barras c/fio</h4>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xs text-gray-400 line-through">Mensal: R$ 13,90</span>
                        <span class="text-xs font-bold text-blue-600">R$ 0,00</span>
                    </div>
                    <p class="text-[10px] text-blue-500 font-medium mt-2">Benefício de subsídio | Gilvan</p>
                </div>
                <div class="text-right">
                    <p class="text-sm font-bold text-gray-800">R$ 99,90</p>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Adquirido</span>
                </div>
            </div>

            <!-- Item 2 -->
            <div class="flex items-center gap-4 py-3">
                <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600">
                    <i class='bx bx-purchase-tag-alt text-xl'></i>
                </div>
                <div class="flex-1">
                    <h4 class="text-sm font-bold text-gray-800">Etiquetadora de preços</h4>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xs text-gray-400 line-through">Mensal: R$ 9,90</span>
                        <span class="text-xs font-bold text-blue-600">R$ 0,00</span>
                    </div>
                    <p class="text-[10px] text-blue-500 font-medium mt-2">Benefício de subsídio | Gilvan</p>
                </div>
                <div class="text-right">
                    <p class="text-sm font-bold text-gray-800">R$ 79,90</p>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Adquirido</span>
                </div>
            </div>
        </div>
    </div> <!-- End of Shop Page -->

    <!-- Orders Page -->
    <div id="orders-page" class="pt-24 px-4 md:px-8 w-full max-w-4xl mx-auto hidden animate-[fadeIn_0.3s_ease]">

        <h2 class="text-lg font-bold text-gray-800 mb-4 px-2">Meus Pedidos</h2>

        <div id="dynamic-orders"></div>

        <!-- Order 1 -->
        <div class="bg-white rounded-2xl p-5 shadow-sm mb-4 border border-gray-100">
            <div class="flex gap-4">
                <div class="w-16 h-16 bg-blue-50 rounded-xl flex items-center justify-center text-blue-500">
                    <i class='bx bx-cube text-2xl'></i>
                </div>
                <div class="flex-1">
                    <p class="text-[10px] uppercase font-bold text-blue-900 mb-1 tracking-wide">Em Trânsito</p>
                    <h3 class="text-sm font-bold text-gray-800 leading-tight">Suporte A.AQUA V83B PT</h3>
                    <p class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded w-fit mt-1">Pix parcelado
                        2x R$ 114,95</p>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-100">
                <div class="flex items-start gap-3">
                    <div class="flex flex-col items-center gap-1 mt-1">
                        <div class="w-2 h-2 rounded-full bg-gray-300"></div>
                        <div class="w-0.5 h-6 bg-gray-200"></div>
                        <div class="w-2 h-2 rounded-full bg-blue-600"></div>
                    </div>
                    <div class="flex-1 space-y-4">
                        <div>
                            <p class="text-xs font-bold text-gray-700">Localização Atual</p>
                            <p class="text-xs text-gray-500">Galpão Logístico em Belém</p>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-gray-700">Previsão de Entrega</p>
                            <p class="text-xs text-gray-500">16 a 19 de fevereiro</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-100">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Local da nota fiscal:</p>
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-100 cursor-pointer hover:bg-gray-100 transition-colors"
                    onclick="openInvoiceModal('140ucpgy5CnYlvRCtTm9DzIT7KOBVHLmY')">
                    <div class="flex items-center gap-3">
                        <i class='bx bxs-file-pdf text-red-500 text-xl'></i>
                        <span class="text-xs text-gray-700 font-bold">Nota Fiscal (R$ 229,90)</span>
                    </div>
                    <button
                        class="text-[10px] font-bold text-blue-600 hover:text-blue-800 uppercase tracking-wide bg-white px-3 py-1.5 rounded-lg border border-gray-200 shadow-sm">
                        Visualizar
                    </button>
                </div>
            </div>
        </div>

        <!-- Order 2 -->
        <div class="bg-white rounded-2xl p-5 shadow-sm mb-4 border border-gray-100 opacity-80">
            <div class="flex gap-4">
                <div class="w-16 h-16 bg-gray-100 rounded-xl flex items-center justify-center text-gray-500">
                    <i class='bx bx-check text-2xl'></i>
                </div>
                <div class="flex-1">
                    <p class="text-[10px] uppercase font-bold text-gray-500 mb-1 tracking-wide">Entregue</p>
                    <h3 class="text-sm font-bold text-gray-800 leading-tight">Adaptador Bluetooth Conector Pc</h3>
                    <p class="text-xs text-gray-500 mt-1">R$ 35,00</p>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-100">
                <div>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Entregue em</p>
                    <p class="text-xs text-gray-500">D'Tudo Variedades, Jarbas Passarinho, Ipixuna do Pará.</p>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-100">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Local da nota fiscal:</p>
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-100 cursor-pointer hover:bg-gray-100 transition-colors"
                    onclick="openInvoiceModal('1GQjQOw7xq9Y52B-NY9p8gtPr9HK4eGzE')">
                    <div class="flex items-center gap-3">
                        <i class='bx bxs-file-pdf text-red-500 text-xl'></i>
                        <span class="text-xs text-gray-700 font-bold">Nota Fiscal (R$ 35,00)</span>
                    </div>
                    <button
                        class="text-[10px] font-bold text-blue-600 hover:text-blue-800 uppercase tracking-wide bg-white px-3 py-1.5 rounded-lg border border-gray-200 shadow-sm">
                        Visualizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Page (New) -->
    <div id="cart-page" class="pt-24 px-4 md:px-8 w-full max-w-4xl mx-auto hidden animate-[fadeIn_0.3s_ease]">
        <!-- Cart Content Will Be Injected Here via JS -->
    </div>

    <!-- Floating Navbar -->
    <!-- Floating Navbar (Redesigned) -->
    <div
        class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-[350px] bg-white/90 backdrop-blur-xl border-white/40 shadow-2xl rounded-2xl px-2 py-3 flex items-center justify-evenly z-50">
        <button onclick="switchPage('shop')" id="nav-shop"
            class="flex flex-col items-center gap-1 text-blue-900 transition-all active:scale-95 w-12">
            <div class="relative">
                <i class='bx bx-store-alt text-2xl'></i>
                <span id="shop-notification"
                    class="absolute -top-1 -right-2 w-2.5 h-2.5 bg-red-500 rounded-full border border-white"></span>
            </div>
        </button>

        <button onclick="switchPage('cart')" id="nav-cart"
            class="relative flex flex-col items-center gap-1 text-gray-400 hover:text-blue-900 transition-all active:scale-95 w-12">
            <i class='bx bx-basket text-2xl'></i>
            <span id="cart-count"
                class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center border border-white hidden">0</span>
        </button>

        <button onclick="switchPage('orders')" id="nav-orders"
            class="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-900 transition-all active:scale-95 w-12">
            <i class='bx bx-map-alt text-2xl'></i>
        </button>


    </div>



    <!-- Purchase Animation Overlay -->
    <div id="purchase-overlay" class="fixed inset-0 z-[3000] hidden items-center justify-center overflow-hidden">
        <!-- Expanding Sphere -->
        <div id="purchase-sphere"
            class="absolute w-10 h-10 bg-blue-900 rounded-full transform scale-0 transition-transform duration-700 ease-in-out">
        </div>

        <!-- Content -->
        <div id="purchase-content"
            class="relative z-10 flex flex-col items-center text-white opacity-0 transition-opacity duration-500 delay-300">
            <h2 class="text-3xl font-bold text-center px-4">Já é quase seu...</h2>
            <div class="mt-6 w-12 h-12 border-4 border-white/30 border-t-white rounded-full animate-spin"></div>
        </div>
    </div>

    <!-- Invoice Modal Removed (Opened in new tab instead) -->

    <script>
        let cart = [];
        let userCashbackBalance = 0.70;
        let useCashback = false;

        function toggleCashback(checked) {
            useCashback = checked;
            renderCartPage();
        }

        const toastContainer = document.getElementById('toast-container');

        // ... (existing code remains until utils) ...

        // Helper to render the specific Cart UI into the modal (Obsolete)

        // --- Core Logic ---


        function calculateProRata(monthlyPrice) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            let targetDate = new Date(currentYear, currentMonth, 23);
            targetDate.setHours(0, 0, 0, 0);

            if (today.getTime() > targetDate.getTime()) {
                targetDate = new Date(currentYear, currentMonth + 1, 23);
                targetDate.setHours(0, 0, 0, 0);
            }

            const diffTime = Math.abs(targetDate - today);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const dailyRate = monthlyPrice / 30;
            return {
                days: diffDays,
                price: dailyRate * diffDays
            };
        }

        function addToCart(name, price, img, maxInstallments = 1, rentPrice = 0, originalPrice = 0) {
            const id = Date.now().toString(36) + Math.random().toString(36).substr(2);
            cart.push({
                id,
                name,
                basePrice: price,
                img,
                maxInstallments,
                rentPrice,
                originalPrice: originalPrice || 0,
                type: 'buy', // 'buy' or 'rent'
                installments: 1, // 1 to maxInstallments
                quantity: 1
            });
            updateCartIcon();
            showToast('Adicionado ao carrinho!', 'success');
        }

        // Adapter for Legacy calls (Revenda Section)
        function comprarProduto(nome, valor, isRental, maxQty, allowInstallments) {
            addToCart(nome, valor, '', allowInstallments ? 2 : 1, 0);
        }

        function updateCartIcon() {
            const el = document.getElementById('cart-count');
            const nav = document.getElementById('nav-cart');
            el.innerText = cart.length;
            if (cart.length > 0) {
                el.classList.remove('hidden');
                nav.classList.add('text-blue-900');
                nav.classList.remove('text-gray-400');
            } else {
                el.classList.add('hidden');
                nav.classList.remove('text-blue-900');
                nav.classList.add('text-gray-400');
            }
        }

        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            renderCartItems();
            updateCartIcon();
        }

        function updateItemType(id, type) {
            const item = cart.find(i => i.id === id);
            if (item) {
                item.type = type;
                item.installments = 1; // Reset installments on type change
                renderCartItems(); // Re-render to show/hide installment selector
            }
        }

        function updateItemInstallments(id, n) {
            const item = cart.find(i => i.id === id);
            if (item) {
                item.installments = parseInt(n);
                renderCartItems(); // Re-render to update totals
            }
        }

        function updateItemQuantity(id, qty) {
            const item = cart.find(i => i.id === id);
            if (item) {
                item.quantity = parseInt(qty);
                renderCartItems();
            }
        }

        // --- Cart Modal & rendering ---

        // --- Cart Page & Rendering ---

        // --- Cart Page & Rendering ---

        function switchPage(page) {
            const shopPage = document.getElementById('shop-page');
            const ordersPage = document.getElementById('orders-page');
            const cartPage = document.getElementById('cart-page');
            const cardPage = document.getElementById('card-page');

            const navShop = document.getElementById('nav-shop');
            const navOrders = document.getElementById('nav-orders');
            const navCart = document.getElementById('nav-cart');
            const navCard = document.getElementById('nav-card');

            // Reset
            [shopPage, ordersPage, cartPage, cardPage].forEach(el => el && el.classList.add('hidden'));
            [navShop, navOrders, navCart, navCard].forEach(el => {
                if (el) {
                    el.classList.remove('text-blue-900');
                    el.classList.add('text-gray-400');
                }
            });

            // Active
            if (page === 'shop') {
                shopPage.classList.remove('hidden');
                navShop.classList.add('text-blue-900');
                navShop.classList.remove('text-gray-400');
                const badge = document.getElementById('shop-notification');
                if (badge) badge.classList.add('hidden');
            } else if (page === 'orders') {
                const ordersPage = document.getElementById('orders-page');
                const navOrders = document.getElementById('nav-orders');
                if (ordersPage) ordersPage.classList.remove('hidden');
                if (navOrders) {
                    navOrders.classList.add('text-blue-900');
                    navOrders.classList.remove('text-gray-400');
                }
                if (typeof loadOrders === 'function') loadOrders();
            } else if (page === 'cart') {
                cartPage.classList.remove('hidden');
                navCart.classList.add('text-blue-900');
                navCart.classList.remove('text-gray-400');
                renderCartPage();
            } else if (page === 'card') {
                cardPage.classList.remove('hidden');
                navCard.classList.add('text-blue-900');
                navCard.classList.remove('text-gray-400');
                loadCardData();
            }
        }

        // --- Card Logic ---
        function loadCardData() {
            const orders = JSON.parse(localStorage.getItem('myOrders') || '[]');
            const totalLimit = 2000;
            let usedLimit = 0;
            const today = new Date();

            let installments = JSON.parse(localStorage.getItem('myInstallments') || '[]');

            // Group by Month
            const futureInvoices = {};

            installments.forEach(inst => {
                usedLimit += inst.value;

                const key = `${inst.month}/${inst.year}`;
                if (!futureInvoices[key]) futureInvoices[key] = 0;
                futureInvoices[key] += inst.value;
            });

            // Update Limit UI (New IDs)
            const available = totalLimit - usedLimit;
            const limitDisplay = document.getElementById('card-val-avail');
            const limitBarCurrent = document.getElementById('card-bar-current');
            const limitBarFuture = document.getElementById('card-bar-future'); // Not fully utilized yet
            const limitTotalText = document.getElementById('card-limit-total-text');
            const heroInvoice = document.getElementById('card-hero-invoice');

            if (limitDisplay && limitBarCurrent) {
                if (available >= 0) {
                    limitDisplay.innerText = `DISP. ${available.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`;
                    limitDisplay.className = "text-emerald-500 font-black text-xs uppercase tracking-widest";
                } else {
                    limitDisplay.innerText = `EXCEDIDO ${Math.abs(available).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`;
                    limitDisplay.className = "text-red-500 font-black text-xs uppercase tracking-widest";
                }

                const percent = (usedLimit / totalLimit) * 100;
                limitBarCurrent.style.width = `${Math.min(percent, 100)}%`;

                if (limitTotalText) limitTotalText.innerText = usedLimit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            // Hero Invoice (Current Month or Next)
            // For now, let's sum up everything as "Open Invoice" for simplicity or take the first month
            // Let's assume the 'current open invoice' is the total of the nearest future month.
            let currentInvoiceValue = 0;
            const sortedKeys = Object.keys(futureInvoices).sort((a, b) => {
                const [ma, ya] = a.split('/');
                const [mb, yb] = b.split('/');
                return new Date(ya, ma - 1) - new Date(yb, mb - 1);
            });

            if (sortedKeys.length > 0) {
                currentInvoiceValue = futureInvoices[sortedKeys[0]];
            }
            if (heroInvoice) heroInvoice.innerText = currentInvoiceValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });


            // Render Carousel (New Rich UI)
            const listEl = document.getElementById('card-invoices-carousel'); // Changed to container ID

            if (listEl) {
                listEl.innerHTML = '';

                if (sortedKeys.length === 0) {
                    listEl.innerHTML = `
                        <div class="w-full text-center py-10 opacity-50">
                            <i class='bx bx-check-circle text-4xl mb-2'></i>
                            <p class="text-xs font-bold uppercase">Tudo em dia!</p>
                        </div>
                     `;
                } else {
                    const months = ["JAN", "FEV", "MAR", "ABR", "MAI", "JUN", "JUL", "AGO", "SET", "OUT", "NOV", "DEZ"];

                    sortedKeys.forEach(key => {
                        const [m, y] = key.split('/');
                        const dateObj = new Date(y, m - 1, 10);
                        const isCurrent = key === sortedKeys[0];
                        const status = isCurrent ? { txt: "ABERTA", bg: "bg-blue-50", col: "text-blue-600" } : { txt: "FUTURA", bg: "bg-slate-50", col: "text-slate-400" };
                        const valParts = futureInvoices[key].toLocaleString('pt-BR', { minimumFractionDigits: 2 }).split(',');

                        const card = document.createElement('div');
                        card.className = 'min-w-[260px] bg-white rounded-[32px] p-6 shadow-lg border border-slate-50 snap-center flex flex-col justify-between active:scale-95 transition-all';
                        // card.style.boxShadow = "0 10px 20px -5px rgba(0,0,0,0.05)";

                        card.innerHTML = `
                            <div class="flex justify-between items-start mb-6">
                                <span class="text-[10px] font-black text-slate-300 uppercase tracking-widest">${months[dateObj.getMonth()]} ${y}</span>
                                <span class="px-3 py-1 rounded-full text-[9px] font-black ${status.bg} ${status.col} uppercase tracking-widest">${status.txt}</span>
                            </div>
                            <div class="mb-6">
                                <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-1">Total da Fatura</p>
                                <div class="text-3xl font-black text-slate-900 tracking-tighter">
                                    <span class="text-sm">R$</span> ${valParts[0]}<span class="text-sm">,${valParts[1]}</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center pt-4 border-t border-slate-50">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Vence ${dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })}</span>
                                <i class='bx bx-right-arrow-alt text-2xl text-slate-300'></i>
                            </div>
                         `;
                        listEl.appendChild(card);
                    });
                }
            }
        }

        // Helper to render the specific Cart UI into the full page
        function renderCartPage() {
            const container = document.getElementById('cart-page');

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-8 mt-10 animate-[fadeIn_0.5s_ease]">
                        <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6 text-blue-200">
                             <i class='bx bx-basket text-5xl'></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800 mb-3">Seu carrinho está vazio</h2>
                        <p class="text-gray-500 mb-8 text-sm px-8">Adicione produtos para ver as melhores ofertas e cashbacks disponíveis para você.</p>
                        <button onclick="switchPage('shop')" class="px-8 py-3 bg-blue-900 text-white rounded-xl font-bold text-sm shadow-lg hover:bg-blue-800 transition-all transform hover:scale-105">
                            Começar a comprar
                        </button>
                    </div>
                 `;
                return;
            }

            let itemsHtml = '';
            let totalDueNow = 0;
            let totalInstallmentSum = 0;
            let monthlyPayments = []; // Array to store { name: 'Month', total: 0 }
            let totalCashback = 0;
            let totalSavings = 0;

            cart.forEach(item => {
                let itemTotal = 0;
                let priceDisplayHtml = '';
                let cashbackFooterHtml = '';
                const quantity = item.quantity || 1;
                let cashback = 0;
                let original = 0;
                let price = 0;

                if (item.type === 'rent') {
                    const proRata = calculateProRata(item.rentPrice);
                    itemTotal = proRata.price;
                    price = itemTotal;

                    priceDisplayHtml = `
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-blue-800">Aluguel: ${itemTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                            <span class="text-[10px] text-gray-500">Mensal: ${item.rentPrice.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                        </div>
                    `;

                    totalDueNow += itemTotal * quantity;
                } else {
                    // Buy
                    price = item.basePrice;
                    original = item.originalPrice || 0;

                    if (original > price) {
                        totalSavings += (original - price) * quantity;
                    }

                    if (item.installments === 1) {
                        itemTotal = price;
                        // Cashback
                        if (item.maxInstallments > 1 || item.type === 'buy') {
                            cashback = price * 0.02 * quantity;
                            totalCashback += cashback;
                        }
                    } else {
                        itemTotal = price / item.installments;
                    }

                    // Calculate Display Price for Template
                    const totalValue = item.installments > 1
                        ? (price / item.installments * quantity).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
                        : (price * quantity).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                    priceDisplayHtml = `
                        <div class="flex flex-wrap items-baseline gap-2">
                             <span class="text-lg font-bold text-blue-900">${totalValue}</span>
                             ${item.installments > 1 ? '<span class="text-xs text-gray-400 font-normal">/mês</span>' : ''}
                             ${original > price ? `<span class="text-[10px] text-gray-400 line-through">${(original * quantity).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>` : ''}
                        </div>
                    `;

                    if (cashback > 0) {
                        cashbackFooterHtml = `
                        <div class="mt-3 bg-yellow-50 rounded-xl p-3 flex items-center justify-between border border-yellow-100">
                             <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-yellow-200 flex items-center justify-center text-yellow-700 text-xs"><i class='bx bx-coin-stack'></i></div>
                                <span class="text-xs font-bold text-yellow-800">Cashback</span>
                             </div>
                             <span class="text-xs font-bold text-yellow-700">+${cashback.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                        </div>
                        `;
                    }

                    // Add to totals
                    let currentItemInstallmentValue = 0;
                    let installmentsCount = 1;
                    if (item.installments > 1) {
                        currentItemInstallmentValue = (price / item.installments) * quantity;
                        installmentsCount = item.installments;
                    } else {
                        currentItemInstallmentValue = price * quantity;
                    }
                    totalInstallmentSum += currentItemInstallmentValue;

                    // Track monthly payments
                    const today = new Date();
                    for (let i = 0; i < installmentsCount; i++) {
                        const futureDate = new Date(today.getFullYear(), today.getMonth() + i, 1);
                        const monthName = futureDate.toLocaleDateString('pt-BR', { month: 'long' });
                        if (!monthlyPayments[i]) monthlyPayments[i] = { name: monthName, total: 0 };
                        monthlyPayments[i].total += currentItemInstallmentValue;
                    }

                    totalDueNow += price * quantity;
                }

                // Controls - Simplified Generation (No internal labels)
                let installSelect = '';
                if (item.type === 'buy' && item.maxInstallments > 1) {
                    let opts = '';
                    for (let i = 1; i <= item.maxInstallments; i++) {
                        opts += `<option value="${i}" ${item.installments === i ? 'selected' : ''}>${i}x de ${(item.basePrice / i).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</option>`;
                    }
                    installSelect = `
                        <div class="relative w-full">
                            <select onchange="updateItemInstallments('${item.id}', this.value)" class="appearance-none w-full bg-gray-50 border border-gray-200 text-gray-700 py-2.5 px-3 pr-8 rounded-xl leading-tight focus:outline-none focus:bg-white focus:border-blue-500 text-xs font-bold truncate">
                                ${opts}
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                <i class='bx bx-chevron-down text-base'></i>
                            </div>
                        </div>
                    `;
                } else if (item.type === 'buy') {
                    installSelect = `
                        <div class="py-2.5 px-3 bg-gray-50 border border-gray-100 rounded-xl text-xs font-bold text-gray-500 text-center w-full">
                            À vista
                        </div>
                     `;
                } else {
                    // Rent Placeholder
                    installSelect = `
                        <div class="py-2.5 px-3 bg-blue-50 border border-blue-100 rounded-xl text-xs font-bold text-blue-600 text-center w-full">
                             Mensal
                        </div>
                     `;
                }

                // Quantity Selector
                let qtyOpts = '';
                for (let k = 1; k <= 10; k++) {
                    qtyOpts += `<option value="${k}" ${quantity === k ? 'selected' : ''}>${k}</option>`;
                }

                let qtySelect = `
                    <div class="relative w-full">
                        <select onchange="updateItemQuantity('${item.id}', this.value)" class="appearance-none w-full bg-gray-50 border border-gray-200 text-gray-700 py-2.5 px-3 pr-8 rounded-xl leading-tight focus:outline-none focus:bg-white focus:border-blue-500 text-xs font-bold text-center">
                            ${qtyOpts}
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                            <i class='bx bx-chevron-down text-base'></i>
                        </div>
                    </div>
                `;

                // New Card Layout
                itemsHtml += `
                    <div class="bg-white border border-gray-100 rounded-3xl p-5 shadow-sm hover:shadow-md transition-all animate-[fadeIn_0.3s_ease] relative overflow-hidden group">
                        
                        <div class="flex gap-4">
                            <!-- Image -->
                            <div class="w-20 h-20 bg-white rounded-2xl border border-gray-100 flex items-center justify-center p-2 shrink-0 overflow-hidden">
                                 ${item.img ? `<img src="${item.img}" class="w-full h-full object-contain">` : `<i class='bx bx-package text-gray-300 text-4xl'></i>`}
                            </div>
                            
                            <!-- Info -->
                            <div class="flex-1 min-w-0 pr-8">
                                <div class="flex items-center gap-2 mb-1">
                                     <span class="bg-emerald-50 text-emerald-600 text-[9px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wide">Frete Grátis</span>
                                </div>
                                <h4 class="text-sm font-bold text-gray-800 line-clamp-2 leading-snug mb-1">${item.name}</h4>
                                
                                <!-- Price Inline via Variable -->
                                ${priceDisplayHtml}
                            </div>
                            
                            <!-- Trash Absolute -->
                            <button onclick="removeFromCart('${item.id}')" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 transition-colors bg-white rounded-full p-1"><i class='bx bx-trash text-lg'></i></button>
                        </div>

                        <!-- Controls Row -->
                        <div class="mt-4 pt-4 border-t border-gray-50 flex items-center gap-3">
                            <div class="flex-1">
                                <label class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1 block pl-1">Opção</label>
                                ${installSelect}
                            </div>
                            <div class="w-20">
                                <label class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1 block pl-1 text-center">Qtd</label>
                                ${qtySelect}
                            </div>
                        </div>

                        <!-- Cashback Footer via Variable -->
                        ${cashbackFooterHtml}

                    </div>
                `;
            });

            // Determine display values
            const hasInstallments = cart.some(i => i.installments > 1 && i.type === 'buy');
            let mainTotalLabel = 'Total a Pagar';
            let mainTotalValue = totalDueNow;
            let mainTotalSuffix = '';
            let paymentMethodText = 'via pix';
            let monthlyBreakdownHtml = '';

            if (useCashback) {
                mainTotalValue -= userCashbackBalance;
                if (mainTotalValue < 0) mainTotalValue = 0;
            }

            if (hasInstallments) {
                mainTotalLabel = 'Total Mensal';
                mainTotalValue = totalInstallmentSum;
                if (useCashback) {
                    mainTotalValue -= userCashbackBalance;
                    if (mainTotalValue < 0) mainTotalValue = 0;
                }
                mainTotalSuffix = '<span class="text-sm font-normal text-gray-400">/mês</span>';
                paymentMethodText = 'via Pix Parcelado';

                monthlyBreakdownHtml = `<div class="bg-gray-50 rounded-xl p-4 mb-8 space-y-2 border border-gray-100">`;
                monthlyPayments.forEach((month, index) => {
                    if (month && month.total > 0) {
                        monthlyBreakdownHtml += `
                            <div class="flex justify-between items-center text-xs text-gray-600">
                                <span class="capitalize font-bold">${month.name}</span>
                                <span class="font-bold">${month.total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                            </div>
                         `;
                    }
                });
                monthlyBreakdownHtml += `</div>`;
            }

            container.innerHTML = `
                <div class="flex items-center justify-between mb-8 max-w-6xl mx-auto w-full px-4 lg:px-0">
                     <h2 class="text-2xl font-bold text-gray-800">Meu Carrinho</h2>
                     <span class="bg-blue-100 text-blue-800 text-sm font-bold px-4 py-1.5 rounded-full">${cart.length} item(s)</span>
                </div>

                <div class="flex flex-col lg:flex-row gap-8 mb-32 max-w-6xl mx-auto w-full px-4 lg:px-0">
                    <!-- Items List (Left) -->
                    <div class="flex-1 space-y-6">
                        ${itemsHtml}
                    </div>
                    
                    <!-- Summary Card (Right - Sticky on Desktop) -->
                    <div class="w-full lg:w-[380px] shrink-0">
                        <div class="bg-white p-6 rounded-3xl shadow-lg border border-gray-100 sticky top-4">
                            <div class="space-y-3 mb-6">
                                <div class="flex justify-between items-center text-gray-500 text-sm">
                                    <span>Valor dos produtos</span>
                                    <span class="font-medium">${totalDueNow.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                                </div>
                                
                                <div class="flex justify-between items-center text-emerald-600 text-sm">
                                    <span>Descontos / Economia</span>
                                    <span class="font-bold">-${totalSavings.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                                </div>

                                <div class="flex justify-between items-center text-gray-500 text-sm">
                                    <span>Frete</span>
                                    <span class="text-emerald-600 font-bold">Grátis</span>
                                </div>

                                ${useCashback ? `
                                <div class="flex justify-between items-center text-blue-600 text-sm animate-[fadeIn_0.3s_ease]">
                                    <span>Cashback Utilizado</span>
                                    <span class="font-bold">-${userCashbackBalance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                                </div>
                                ` : ''}
                            </div>

                             <!-- Cashback Toggle -->
                            <div class="flex items-center justify-between py-3 mb-4 rounded-xl bg-blue-50/50 border border-blue-100 px-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                                        <i class='bx bx-coin-stack'></i>
                                    </div>
                                    <div>
                                        <p class="text-xs font-bold text-gray-700">Usar Cashback</p>
                                        <p class="text-[10px] text-gray-500">Saldo: R$ ${userCashbackBalance.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" onchange="toggleCashback(this.checked)" ${useCashback ? 'checked' : ''}>
                                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            ${totalCashback > 0 ? `
                            <div class="flex justify-between items-center mb-6 bg-yellow-50 p-4 rounded-2xl border border-yellow-100">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-yellow-200 flex items-center justify-center text-yellow-700">
                                        <i class='bx bx-coin-stack text-lg'></i>
                                    </div>
                                    <div>
                                        <p class="text-xs text-yellow-800 font-bold">Cashback a receber</p>
                                        <p class="text-[10px] text-yellow-600">Creditado após confirmação</p>
                                    </div>
                                </div>
                                <span class="text-lg font-bold text-yellow-700 tracking-tight">+${totalCashback.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                            </div>
                            ` : ''}
                            
                            <div class="border-t border-gray-100 my-6"></div>
                            
                            <div class="flex justify-between items-end mb-8">
                                <span class="text-base font-bold text-gray-600">${mainTotalLabel}</span>
                                <div class="text-right">
                                    <h2 class="text-3xl font-black text-blue-900 leading-none">${mainTotalValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} ${mainTotalSuffix}</h2>
                                    <p class="text-xs text-gray-400 mt-1 font-medium">${paymentMethodText}</p>
                                </div>
                            </div>

                            ${monthlyBreakdownHtml}
                            
                            <div id="payment-area">
                                <button id="btnGerarPix" onclick="gerarPagamento()" class="w-full bg-blue-900 text-white py-4 rounded-xl font-bold text-lg shadow-xl shadow-blue-200 hover:shadow-blue-300 hover:scale-[1.01] active:scale-[0.99] transition-all flex items-center justify-center gap-3 group">
                                    <i class='bx bx-check-double text-2xl'></i>
                                    <span>Pagar com Pix</span>
                                </button>
                            </div>
                            
                            <p class="text-[10px] text-center text-gray-400 mt-6 flex items-center justify-center gap-1 opacity-70">
                                <i class='bx bx-shield-quarter'></i> Ambiente seguro e certificado
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCartItems() {
            renderCartPage();
        }

        // --- Payment Generation (Bulk) ---

        async function gerarPagamento() {
            // Logic moved to script block at end of file to support Modal
        }

        function confirmarPagamento() {
            // Logic moved to script block at end of file
        }

    </script>

    <script>
        // --- View & Navigation Utils ---

        function loadOrders() {
            const orders = JSON.parse(localStorage.getItem('myOrders') || '[]');
            const container = document.getElementById('dynamic-orders');
            if (!container) return;

            if (orders.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            orders.forEach(order => {
                const isTwoTimes = order.name.includes('2x');
                html += `
            <div class="bg-white rounded-2xl p-5 shadow-sm mb-4 border border-gray-100 animate-[fadeIn_0.5s_ease]">
                <div class="flex gap-4">
                    <div class="w-16 h-16 bg-gray-50 rounded-xl flex items-center justify-center text-gray-600 border border-gray-100">
                        <i class='bx bx-package text-2xl'></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-[10px] uppercase font-bold text-blue-900 mb-1 tracking-wide">Em separação</p>
                        <h3 class="text-sm font-bold text-gray-800 leading-tight">${order.name}</h3>
                        <p class="text-xs text-gray-500 mt-1">${order.price.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <div>
                        <p class="text-xs font-bold text-gray-700">Status atual:</p>
                        <div class="flex items-center gap-2 mt-1">
                            <i class='bx bx-loader-alt bx-spin text-blue-600'></i>
                            <span class="text-xs text-gray-500">Estamos separando seu pedido.</span>
                        </div>
                    </div>
                </div>
            </div>`;
            });
            container.innerHTML = html;
        }

        function showToast(msg, type) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.style.background = type === 'success' ? '#22c55e' : '#1e3a8a';
            t.style.color = 'white';
            t.style.padding = '12px 20px';
            t.style.borderRadius = '50px';
            t.style.fontSize = '0.9rem';
            t.style.fontWeight = '600';
            t.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
            t.style.zIndex = '9999';
            t.innerHTML = `<span>${msg}</span>`;

            if (toastContainer) {
                toastContainer.appendChild(t);
                t.animate([{ transform: 'translateY(20px)', opacity: 0 }, { transform: 'translateY(0)', opacity: 1 }], { duration: 300, fill: 'forwards' });
                setTimeout(() => {
                    t.animate([{ opacity: 1 }, { opacity: 0 }], { duration: 300, fill: 'forwards' }).onfinish = () => t.remove();
                }, 3000);
            }
        }

        // --- Invoice Modal ---
        function openInvoice() {
            window.open('https://drive.google.com/file/d/1GQjQOw7xq9Y52B-NY9p8gtPr9HK4eGzE/view?usp=sharing', '_blank');
        }

        function closeInvoice() {
            // no op
        }


        // Modal helpers for general purpose if needed (though we removed the cart modal usage)
        function fecharModal() {
            document.getElementById('modalPagamento').style.display = 'none';
        }
    </script>

    <!-- PIX PAYMENT PAGE (FULL SCREEN) -->
    <div id="pix-payment-page"
        class="fixed inset-0 z-[100] hidden flex-col bg-slate-50 overflow-y-auto animate-[fadeIn_0.3s_ease]">
        <!-- Header -->
        <div class="bg-white shadow-sm p-4 sticky top-0 z-10 w-full">
            <div class="flex items-center justify-between max-w-lg mx-auto w-full">
                <button onclick="closePixPage()"
                    class="text-slate-400 hover:text-slate-600 transition-colors p-2 -ml-2 rounded-full hover:bg-slate-100">
                    <i class='bx bx-chevron-left text-3xl'></i>
                </button>
                <h1 class="text-base font-bold text-slate-800">Finalizar Pagamento</h1>
                <div class="w-8"></div>
            </div>
        </div>

        <!-- Content -->
        <div class="flex-1 flex flex-col items-center justify-center p-4 md:p-8 max-w-md mx-auto w-full">

            <h2 class="text-xl md:text-2xl font-bold text-slate-800 text-center mb-6 leading-tight">Pagamento via Pix
            </h2>

            <!-- Status Badge -->
            <div id="payment-status-badge"
                class="inline-flex items-center gap-2 px-4 py-3 bg-blue-50 text-blue-700 rounded-2xl text-xs font-bold mb-8 border border-blue-100 shadow-sm text-center max-w-xs leading-relaxed">
                <div class="w-2.5 h-2.5 bg-blue-500 rounded-full animate-pulse shrink-0"></div>
                <span id="payment-status-text">Pague agora e tenha mais agilidade na entrega!</span>
            </div>

            <!-- QR Code Card -->
            <div
                class="bg-white p-6 rounded-3xl shadow-xl shadow-slate-200/60 w-full mb-8 border border-slate-100 relative overflow-hidden group">
                <div
                    class="absolute inset-0 bg-blue-600/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                </div>

                <div class="flex justify-center mb-6 relative min-h-[200px]">
                    <img id="pix-qr-image" src=""
                        class="w-56 h-56 object-contain opacity-50 transition-all duration-500 scale-95 mix-blend-multiply"
                        alt="QR Code Pix">
                    <div id="pix-qr-loading"
                        class="absolute inset-0 flex flex-col items-center justify-center bg-white z-10 transition-opacity duration-300">
                        <i class='bx bx-loader-alt bx-spin text-4xl text-blue-600 mb-3'></i>
                        <span class="text-sm font-bold text-slate-400">Gerando seu Pix...</span>
                    </div>
                </div>

                <!-- Copy Paste -->
                <div class="relative">
                    <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider">Pix Copia e
                        Cola</label>
                    <div
                        class="flex shadow-sm rounded-xl overflow-hidden border border-slate-200 focus-within:ring-2 focus-within:ring-blue-100 transition-all">
                        <input type="text" id="pix-copy-paste" readonly
                            class="w-full bg-slate-50 text-slate-600 text-xs py-3.5 px-4 font-mono truncate focus:outline-none focus:bg-white"
                            value="Carregando...">
                        <button onclick="copyPixCode()"
                            class="bg-white px-5 border-l border-slate-100 text-blue-600 hover:bg-blue-50 transition-colors font-bold text-xs flex items-center gap-1 active:bg-blue-100">
                            <i class='bx bx-copy'></i>
                            COPIAR
                        </button>
                    </div>
                </div>
            </div>

            <!-- Value Display -->
            <div class="w-full mb-8 flex flex-col items-center justify-center text-center">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Valor a pagar este mês</p>
                <p id="pix-value-display" class="text-4xl font-black text-slate-800 tracking-tight">R$ 0,00</p>
            </div>

            <p class="text-xs text-slate-400 text-center max-w-[250px] leading-relaxed">
                <i class='bx bx-info-circle align-middle mr-1'></i>
                A confirmação é automática. Assim que o pagamento for identificado, você será redirecionado.
            </p>

        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const CLOUD_FUNCTION_URL = "https://us-central1-super-app25.cloudfunctions.net/createPayment";
        // Assuming checkPaymentStatus expects ?id=<ID>
        const CHECK_STATUS_URL = "https://us-central1-super-app25.cloudfunctions.net/checkPaymentStatus";

        let activePaymentInterval = null;
        let pId_global = null; // Store Mercado Pago Payment ID

        // ... Existing init ...

        // --- PAGE CONTROLS ---
        function closePixPage() {
            document.getElementById('pix-payment-page').classList.add('hidden');
            document.getElementById('pix-payment-page').classList.remove('flex');
            if (activePaymentInterval) clearInterval(activePaymentInterval);
        }

        // Updated startPurchaseAnimation to target new Page
        async function startPurchaseAnimation() {
            const overlay = document.getElementById('purchase-overlay');
            const sphere = document.getElementById('purchase-sphere');
            const content = document.getElementById('purchase-content');

            // Reset
            sphere.style.transform = 'scale(0)';
            content.classList.remove('opacity-100');
            content.classList.add('opacity-0');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');

            // Trigger animation
            void sphere.offsetWidth;
            sphere.style.transform = 'scale(150)';

            // Fade in Text
            setTimeout(() => {
                content.classList.remove('opacity-0');
                content.classList.add('opacity-100');
            }, 100);

            // Wait minimum time (limit logic requested) - keeping strict 3s to match sphere feel or user request "respeitar animação"
            // The user said "waiting for the minimum limit of seconds there". 
            // In original code it was around 3000ms.
            await new Promise(resolve => setTimeout(resolve, 3000));
            content.classList.remove('opacity-100');
            content.classList.add('opacity-0');

            // Hide overlay
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            sphere.style.transform = 'scale(0)';

            await gerarPagamento();
        }

        function copyPixCode() {
            const copyText = document.getElementById("pix-copy-paste");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value).then(() => {
                showToast('Código Pix copiado!', 'success');
            }).catch(err => {
                // Fallback
                document.execCommand('copy');
                showToast('Código Pix copiado!', 'success');
            });
        }

        async function gerarPagamento() {
            // 1. Calculate Total
            let totalToPayNow = 0;
            let orderItems = [];

            cart.forEach(item => {
                let quantity = item.quantity || 1;
                let unitPrice = item.basePrice;
                if (item.installments > 1 && item.type === 'buy') {
                    unitPrice = item.basePrice / item.installments;
                }
                totalToPayNow += unitPrice * quantity;

                orderItems.push({
                    id: item.id,
                    name: `${quantity}x ${item.name} (${item.installments > 1 ? item.installments + 'x' : 'À vista'})`,
                    quantity: 1,
                    priceNew: unitPrice * quantity
                });
            });

            if (useCashback) {
                totalToPayNow -= userCashbackBalance;
                if (totalToPayNow < 0) totalToPayNow = 0;
            }

            // 2. Prepare UI (Target NEW Page IDs)
            const page = document.getElementById('pix-payment-page');
            const qrImage = document.getElementById('pix-qr-image');
            const qrLoading = document.getElementById('pix-qr-loading');
            const copyInput = document.getElementById('pix-copy-paste');
            const valueDisplay = document.getElementById('pix-value-display');
            const statusText = document.getElementById('payment-status-text');
            const statusBadge = document.getElementById('payment-status-badge');

            valueDisplay.innerText = totalToPayNow.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            qrImage.style.opacity = '0.1';
            qrImage.style.transform = 'scale(0.95)';
            qrLoading.style.display = 'flex';
            copyInput.value = "Gerando Pix...";
            statusText.innerText = "Pague agora e tenha mais agilidade na entrega!";
            statusBadge.className = "inline-flex items-center gap-2 px-6 py-2 bg-blue-50 text-blue-700 rounded-full text-xs font-bold mb-8 border border-blue-100 shadow-sm text-center";

            // Show Page
            page.classList.remove('hidden');
            page.classList.add('flex');

            try {
                const currentOrderId = 'ORD-' + Date.now();
                const payload = {
                    orderId: currentOrderId,
                    payment_data: {
                        transaction_amount: Number(totalToPayNow.toFixed(2)),
                        payment_method_id: 'pix',
                        description: `Pagamento Pedido ${currentOrderId}`,
                        payer: {
                            email: 'cliente@eletro.com',
                            first_name: 'Cliente',
                            last_name: 'Teste',
                            identification: { type: 'CPF', number: '19100000000' }
                        }
                    },
                    items: orderItems,
                    account: 'default',
                    customPayer: {
                        email: 'cliente@eletro.com',
                        first_name: 'Cliente',
                        last_name: 'Eletro',
                        identification: { type: 'CPF', number: '12345678909' },
                        address: { zip_code: '68637000', street_name: 'Rua Principal', street_number: '100', city: 'Ipixuna' }
                    }
                };

                const response = await fetch(CLOUD_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Erro ao gerar Pix');

                const qrCodeBase64 = data.point_of_interaction?.transaction_data?.qr_code_base64;
                const copyPasteCode = data.point_of_interaction?.transaction_data?.qr_code;
                const mpPaymentId = data.id; // Get Mercado Pago ID for polling

                if (qrCodeBase64 && copyPasteCode && mpPaymentId) {
                    qrImage.src = `data:image/png;base64,${qrCodeBase64}`;
                    qrImage.style.opacity = '1';
                    qrImage.style.transform = 'scale(1)';
                    qrLoading.style.display = 'none'; // Fade out handled by css usually but here aggressive hidden
                    copyInput.value = copyPasteCode;

                    statusText.innerText = "Pague agora e tenha mais agilidade na entrega!";
                    statusBadge.className = "inline-flex items-center gap-2 px-6 py-2 bg-blue-50 text-blue-700 rounded-full text-xs font-bold mb-8 border border-blue-100 shadow-sm text-center";

                    // Start Polling
                    startPolling(mpPaymentId);

                } else {
                    throw new Error('Dados do Pix incompletos');
                }

            } catch (error) {
                console.error(error);
                alert('Erro ao gerar pagamento: ' + error.message);
                closePixPage();
            }
        }

        function startPolling(paymentId) {
            if (activePaymentInterval) clearInterval(activePaymentInterval);

            activePaymentInterval = setInterval(async () => {
                try {
                    // Call checkPaymentStatus with id param
                    const response = await fetch(`${CHECK_STATUS_URL}?id=${paymentId}`);
                    const data = await response.json();

                    // Logic based on likely MP response or our wrapper response
                    // Usually { status: 'approved', ... }
                    if (data.status === 'approved') {
                        clearInterval(activePaymentInterval);

                        // Success Animation on Badge
                        const statusText = document.getElementById('payment-status-text');
                        const statusBadge = document.getElementById('payment-status-badge');
                        statusText.innerText = "Pagamento Aprovado!";
                        statusBadge.className = "inline-flex items-center gap-2 px-6 py-2 bg-green-50 text-green-700 rounded-full text-sm font-bold mb-8 border border-green-100";

                        // Small delay to read success
                        setTimeout(() => {
                            closePixPage();
                            confirmarPagamento();
                        }, 1500);
                    }
                } catch (e) {
                    console.log("Polling error:", e);
                }
            }, 5000); // Check every 5 seconds
        }

        function confirmarPagamento() {
            // Function logic remains almost the same, just removed the random ID generation since we might have one,
            // but for safety let's regenerate or match.

            // Note: In a robust app, we would use the 'currentOrderId' we generated earlier.

            const storedOrders = JSON.parse(localStorage.getItem('myOrders') || '[]');
            const storedInstallments = JSON.parse(localStorage.getItem('myInstallments') || '[]');

            cart.forEach(item => {
                let priceDisplay = 0;
                let quantity = item.quantity || 1;

                if (item.type === 'rent') {
                    priceDisplay = calculateProRata(item.rentPrice).price * quantity;
                } else {
                    priceDisplay = item.basePrice * quantity;
                }

                // Add Installments
                if (item.type === 'buy' && item.installments > 1) {
                    const monthlyValue = (item.basePrice / item.installments) * quantity;
                    // FIX: Start from CURRENT month (Entry)
                    const currentMonth = new Date().getMonth();
                    let year = new Date().getFullYear();

                    for (let i = 0; i < item.installments; i++) {
                        let m = currentMonth + i;
                        let y = year;

                        // Adjust year if month overflows 11 (December)
                        // Example: m=12 (Jan next year), m=13 (Fev next year)
                        while (m > 11) {
                            m -= 12;
                            y++;
                        }

                        storedInstallments.push({
                            name: `${item.name} (${quantity}x)`,
                            value: monthlyValue,
                            month: m + 1, // Store as 1-based index for display (1=Jan, 2=Fev)
                            year: y,
                            status: i === 0 ? 'Pago' : 'Pendente' // 1st installment is the Entry (Paid via Pix now)
                        });
                    }
                }

                storedOrders.unshift({
                    id: currentOrderId || 'ORD-' + Math.floor(Math.random() * 1000000),
                    name: `${quantity}x ${item.name} (${item.type === 'rent' ? 'Aluguel' : item.installments + 'x Pix Parcelado'})`,
                    price: priceDisplay,
                    status: 'Em separação',
                    date: new Date().toLocaleDateString('pt-BR'),
                    timestamp: Date.now() // Add timestamp for expiration
                });
            });

            localStorage.setItem('myOrders', JSON.stringify(storedOrders));
            localStorage.setItem('myInstallments', JSON.stringify(storedInstallments));

            cart = [];
            updateCartIcon();

            switchPage('orders');
            loadOrders();
            showToast('Pagamento confirmado! Pedido em preparação.', 'success');
        }

    </script>
    <!-- Invoice Preview Modal -->
    <div id="invoiceModal"
        class="hidden fixed inset-0 z-[3000] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-[fadeIn_0.2s_ease]">
        <div class="bg-white w-full max-w-4xl h-[85vh] rounded-2xl overflow-hidden flex flex-col shadow-2xl relative">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white z-10">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-red-50 text-red-500 rounded-lg flex items-center justify-center"><i
                            class='bx bxs-file-pdf text-xl'></i></div>
                    <div>
                        <h3 class="font-bold text-gray-800 text-sm">Visualização da Nota Fiscal</h3>
                        <p class="text-[10px] text-gray-400">Documento oficial</p>
                    </div>
                </div>
                <button onclick="document.getElementById('invoiceModal').classList.add('hidden')"
                    class="p-2 hover:bg-gray-100 rounded-full transition-colors"><i
                        class='bx bx-x text-2xl text-gray-400'></i></button>
            </div>
            <div class="flex-1 bg-gray-100 relative w-full h-full">
                <iframe id="invoiceFrame" src="" class="absolute inset-0 w-full h-full" border="0"></iframe>
            </div>
        </div>
    </div>

    <script>
        function loadOrders() {
            const dynamicContainer = document.getElementById('dynamic-orders');
            if (!dynamicContainer) return;

            // Load from Storage
            let storedOrders = JSON.parse(localStorage.getItem('myOrders') || '[]');
            const now = Date.now();
            const expirationTime = 30 * 60 * 1000; // 30 minutes in ms

            // Filter expired
            const validOrders = storedOrders.filter(order => {
                // If legacy order without timestamp, expire it immediately or set a policy.
                // For now, let's keep them if user just added them in this session (timestamp missing means old).
                // But strict user request: 30 mins validity. So if no timestamp, it's invalid/expired.
                if (!order.timestamp) return false;
                return (now - order.timestamp) < expirationTime;
            });

            // Update Storage if changed
            if (storedOrders.length !== validOrders.length) {
                localStorage.setItem('myOrders', JSON.stringify(validOrders));
            }

            // Render
            if (validOrders.length === 0) {
                dynamicContainer.innerHTML = '';
                return;
            }

            dynamicContainer.innerHTML = validOrders.map(order => `
                <div class="bg-white rounded-2xl p-5 shadow-sm mb-4 border border-gray-100 animate-[fadeIn_0.3s_ease]">
                    <div class="flex gap-4">
                        <div class="w-16 h-16 bg-blue-50 rounded-xl flex items-center justify-center text-blue-500">
                            <i class='bx bx-cube text-2xl'></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-[10px] uppercase font-bold text-blue-900 mb-1 tracking-wide">Em Separação</p>
                            <h3 class="text-sm font-bold text-gray-800 leading-tight">${order.name}</h3>
                            <p class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded w-fit mt-1">
                                ${order.price.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                            </p>
                        </div>
                    </div>
                     <div class="mt-4 pt-4 border-t border-gray-100">
                        <div class="flex items-start gap-3">
                            <div class="flex flex-col items-center gap-1 mt-1">
                                <div class="w-2 h-2 rounded-full bg-blue-600 animate-pulse"></div>
                                <div class="w-0.5 h-6 bg-gray-200"></div>
                                <div class="w-2 h-2 rounded-full bg-gray-300"></div>
                            </div>
                            <div class="flex-1 space-y-4">
                                <div>
                                    <p class="text-xs font-bold text-gray-700">Status do Pedido</p>
                                    <p class="text-xs text-gray-500">Aguardando envio</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openInvoiceModal(fileId) {
            const url = `https://drive.google.com/file/d/${fileId}/preview`;
            const modal = document.getElementById('invoiceModal');
            const iframe = document.getElementById('invoiceFrame');
            iframe.src = url;
            modal.classList.remove('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (window.location.hash === '#rastreio') {
                switchPage('orders');
            }
        });
    </script>
</body>

</html>