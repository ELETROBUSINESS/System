<!DOCTYPE html>
<html lang="pt-br" data-view="mobile" data-minimized="false">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-9060080612658200">
    <link rel="icon" href="/assets/img/iconWeb.png">
    <title>Crediário | Nubia</title>

    <!-- Libs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- BoxIcons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/2.6.0/uicons-solid-straight/css/uicons-solid-straight.css'>
    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/2.6.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <!-- CSS Global -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/style26.css">

    <!-- View Transitions API -->
    <meta name="view-transition" content="same-origin">

    <!-- Navbar Anti-Flash -->
    <script>
        (function () {
            const savedState = localStorage.getItem('acc_navbar');
            if (savedState !== null) {
                document.documentElement.setAttribute('data-minimized', savedState);
                if (savedState === 'true') {
                    document.documentElement.classList.add('sidebar-minimized-init');
                }
            }
        })();
    </script>

    <style>
        /* Custom Card Styles */
        .client-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            /* Minimal shadow */
            border: 1px solid #f3f4f6;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .client-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border-color: #e5e7eb;
        }

        .client-avatar {
            width: 48px;
            height: 48px;
            min-width: 48px;
            border-radius: 12px;
            background: #f9fafb;
            /* Lighter minimal bg */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: #374151;
            /* Darker gray */
            font-weight: 600;
        }

        .progress-bar-bg {
            width: 100%;
            height: 4px;
            /* Thinner */
            background-color: #f3f4f6;
            border-radius: 999px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: var(--brand-color);
            /* Updated to Brand Color */
            border-radius: 999px;
            transition: width 1s ease-in-out;
        }

        .skeleton-pulse {
            animation: pulse-bg 1.5s infinite;
        }

        @keyframes pulse-bg {
            0% {
                background-color: #f3f4f6;
            }

            50% {
                background-color: #e5e7eb;
            }

            100% {
                background-color: #f3f4f6;
            }
        }
    </style>
</head>

<body style="--marker-x: 0%; --marker-y: 50%;">

    <div id="chart-tooltip"></div>

    <div id="app-container" class="page-crediario">
        <!-- Info Profile -->
        <div class="info">
            <div class="photo-profile">
                <img src="/users/45692327000100/CD1/adm/nb/img/profile_photo.jpg">
                <div class="detals">
                    <h1>Olá, Nubia!</h1>
                    <p>CEO: D'TUDO | Dupão</p>
                </div>
                <i class="fi fi-rr-shield-trust"></i>
            </div>
            <div class="balance">
                <p>Recebível Total</p>
                <div class="saldo">
                    <span id="total-receivable" class="">R$ 0,00</span>
                    <i class="bx bx-show" id="toggle-balance-icon"></i>
                </div>
            </div>
        </div>

        <!-- Mobile Back Button -->
        <div class="w-full px-4 mt-4 -mb-2 md:hidden">
            <button onclick="window.location.href='conta.html'"
                class="flex items-center text-gray-500 hover:text-gray-800 font-semibold transition-colors">
                <i class='bx bx-chevron-left text-3xl'></i>
                <span class="-ml-1">Voltar</span>
            </button>
        </div>

        <!-- KPIs -->
        <div class="kpi-area grid-kpi cols-3 mb-6">
            <!-- Crédito a Receber -->
            <div class="finance-card kpi-card flex flex-col justify-center h-24">
                <span class="kpi-label">Crédito a Receber</span>
                <div class="flex items-baseline mt-1">
                    <span class="kpi-value text-2xl text-gray-900" id="kpi-cred-val">R$ 0</span>
                    <span class="text-xs ml-0.5 text-gray-500 font-bold" id="kpi-cred-dec">,00</span>
                </div>
            </div>

            <!-- Em Atraso (New) -->
            <div class="finance-card kpi-card flex flex-col justify-center h-24">
                <span class="kpi-label">Em Atraso</span>
                <div class="flex items-baseline mt-1">
                    <span class="kpi-value text-gray-900 text-2xl" id="kpi-overdue-val">R$ 0</span>
                    <span class="text-xs ml-0.5 text-gray-500 font-bold" id="kpi-overdue-dec">,00</span>
                </div>
            </div>

            <!-- Quantidade de Clientes -->
            <div class="finance-card kpi-card flex flex-col justify-center h-24">
                <span class="kpi-label">Carteira de Clientes</span>
                <div class="flex items-baseline mt-1">
                    <span class="kpi-value text-gray-900 text-2xl" id="kpi-clients-count">0</span>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="finance-card w-full max-w-full bg-transparent shadow-none border-none" style="padding: 0;">
            <!-- Header -->
            <div class="flex items-center justify-between mb-4 md:mb-6 px-1">
                <h3 class="text-xs uppercase font-bold text-gray-400 tracking-widest">Carteira de Crédito</h3>
            </div>

            <!-- Search Area -->
            <div class="client-search-wrapper w-full mb-8 relative">
                <i class='bx bx-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-lg'></i>
                <input type="text" id="client-search-input"
                    class="w-full pl-12 pr-4 py-4 border-none shadow-sm rounded-2xl focus:ring-2 focus:ring-gray-200 transition-all bg-white text-gray-700 placeholder-gray-400"
                    placeholder="Buscar cliente..." autocomplete="off">
            </div>

            <!-- Clients Grid -->
            <div id="clients-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20">
                <!-- SKELETON LOADING -->
                <div class="client-card animate-pulse">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gray-100"></div>
                        <div class="flex-1">
                            <div class="h-4 bg-gray-100 rounded w-3/4 mb-2"></div>
                            <div class="h-3 bg-gray-100 rounded w-1/2"></div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="h-8 bg-gray-100 rounded w-full"></div>
                        <div class="h-2 bg-gray-100 rounded-full w-full"></div>
                        <div class="flex justify-between gap-2 mt-4">
                            <div class="h-10 bg-gray-100 rounded w-1/2"></div>
                            <div class="h-10 bg-gray-100 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
                <!-- More skeletons for visual -->
                <div class="client-card animate-pulse hidden md:block">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gray-100"></div>
                        <div class="flex-1">
                            <div class="h-4 bg-gray-100 rounded w-3/4 mb-2"></div>
                            <div class="h-3 bg-gray-100 rounded w-1/2"></div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="h-8 bg-gray-100 rounded w-full"></div>
                        <div class="h-2 bg-gray-100 rounded-full w-full"></div>
                        <div class="flex justify-between gap-2 mt-4">
                            <div class="h-10 bg-gray-100 rounded w-1/2"></div>
                            <div class="h-10 bg-gray-100 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
                <!-- More skeletons for visual -->
                <div class="client-card animate-pulse hidden lg:block">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gray-100"></div>
                        <div class="flex-1">
                            <div class="h-4 bg-gray-100 rounded w-3/4 mb-2"></div>
                            <div class="h-3 bg-gray-100 rounded w-1/2"></div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="h-8 bg-gray-100 rounded w-full"></div>
                        <div class="h-2 bg-gray-100 rounded-full w-full"></div>
                        <div class="flex justify-between gap-2 mt-4">
                            <div class="h-10 bg-gray-100 rounded w-1/2"></div>
                            <div class="h-10 bg-gray-100 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Navbar -->
    <div class="nav-container hidden-mobile-paged">
        <div class="nav-marker" id="nav-marker"></div>
        <div class="nav-bg" id="nav-bg"></div>
        <nav class="nav-overlay" id="nav-overlay">
            <div class="nav-header-toggle">
                <div class="btn-toggle-sidebar" onclick="toggleSidebar()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        id="toggle-icon" style="transition: transform 0.3s ease;">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </div>
            </div>

            <div class="nav-links-container">
                <div class="nav-item" onclick="navigateTo('conta.html')">
                    <div class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                    </div>
                    <span class="nav-label">Casa</span>
                </div>

                <div class="nav-item" onclick="navigateTo('metricas.html')">
                    <div class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                    </div>
                    <span class="nav-label">Métricas</span>
                </div>

                <div class="nav-item desktop-only" onclick="navigateTo('/pdv/index.html')">
                    <div class="nav-icon">
                        <i class="bx bx-cart-minus" style="font-size: 24px;"></i>
                    </div>
                    <span class="nav-label">PDV</span>
                </div>

                <div class="nav-item desktop-only" onclick="navigateTo('manager.html')">
                    <div class="nav-icon">
                        <i class='bxr bx-scan-barcode'></i>
                    </div>
                    <span class="nav-label">Despesas</span>
                </div>

                <div class="nav-item" onclick="navigateTo('extrato.html')">
                    <div class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <line x1="10" y1="9" x2="8" y2="9"></line>
                        </svg>
                    </div>
                    <span class="nav-label">Extrato</span>
                </div>

                <div class="nav-item active desktop-only" onclick="navigateTo('crediario.html')">
                    <div class="nav-icon">
                        <i class='bxr bx-wallet-cards'></i>
                    </div>
                    <span class="nav-label">Crediário</span>
                </div>

                <div class="nav-item"
                    onclick="localStorage.removeItem('session_token'); window.location.href='/users/e-finance.html'">
                    <div class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </div>
                    <span class="nav-label">Sair</span>
                </div>
            </div>
        </nav>
    </div>

    <!-- Modals -->

    <!-- Details Modal -->
    <div class="modal-overlay" id="cliente-details-modal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header sticky top-0 bg-white z-10 border-b border-gray-100 pb-4">
                <h3 class="flex items-center gap-2"><i class='bx bx-id-card text-gray-400'></i> Ficha do Cliente</h3>
                <button class="close-modal-btn" data-target="cliente-details-modal"><i class='bx bx-x'></i></button>
            </div>
            <div class="modal-body pt-4">
                <div class="client-profile-header mb-6">
                    <div
                        class="client-avatar-lg bg-gray-100 text-gray-500 rounded-full w-16 h-16 flex items-center justify-center text-3xl">
                        <span id="detail-cliente-avatar-text">U</span>
                    </div>
                    <div style="flex-grow: 1;">
                        <h4 id="detail-cliente-nome" class="text-xl font-bold text-gray-800">Carregando...</h4>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="detail-cliente-apelido"
                                class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs font-semibold">...</span>
                            <span id="detail-cliente-status-badge"></span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="p-4 bg-gray-50 rounded-2xl border border-gray-200">
                        <span class="block text-xs uppercase font-bold text-gray-400 mb-1">Saldo Devedor</span>
                        <span class="block text-xl font-bold text-gray-900" id="detail-cliente-saldo">R$ 0,00</span>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-2xl border border-gray-100">
                        <span class="block text-xs uppercase font-bold text-gray-400 mb-1">Próximo Venc.</span>
                        <span class="block text-lg font-semibold text-gray-700"
                            id="detail-cliente-vencimento">--/--</span>
                    </div>
                </div>

                <div class="limit-container mb-8">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-sm font-semibold text-gray-700">Limite de Crédito</span>
                        <strong id="detail-cliente-limite-total" class="text-sm text-gray-900">R$ 0,00</strong>
                    </div>
                    <div class="progress-track bg-gray-200 h-3 rounded-full overflow-hidden">
                        <div class="progress-fill h-full bg-gray-900 transition-all duration-500"
                            id="detail-cliente-progress" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between mt-2 text-xs text-gray-400 font-medium">
                        <span id="detail-cliente-percentual">0% Utilizado</span>
                        <span id="detail-cliente-disponivel" class="text-gray-600">Disp: R$ 0,00</span>
                    </div>
                </div>

                <!-- Tabs or Sections for History -->
                <div class="border-t border-gray-100 pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-gray-800"><i class='bx bx-history text-gray-400 mr-1'></i> Histórico
                            de Compras</h4>
                        <button class="text-xs text-blue-600 font-semibold hover:underline">Ver completo</button>
                    </div>

                    <div id="detail-history-container" class="space-y-3">
                        <!-- Mocked History Items for Visual -->
                        <div class="p-3 rounded-xl border border-gray-100 bg-white flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center">
                                    <i class='bx bx-cart'></i>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-800">Compra no PDV</p>
                                    <p class="text-xs text-gray-400">Há 2 dias</p>
                                </div>
                            </div>
                            <span class="font-bold text-gray-800">R$ 45,90</span>
                        </div>
                        <!-- Placeholder if empty -->
                        <div class="text-center py-4 hidden">
                            <p class="text-sm text-gray-400 italic">Nenhuma compra recente.</p>
                        </div>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t border-gray-100">
                    <p class="text-xs font-bold text-gray-400 uppercase mb-3">Dados de Contato</p>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3 text-sm text-gray-600">
                            <i class='bx bx-phone w-5 text-center'></i>
                            <span id="detail-cliente-telefone">--</span>
                        </div>
                        <div class="flex items-center gap-3 text-sm text-gray-600">
                            <i class='bx bx-map w-5 text-center'></i>
                            <span id="detail-cliente-endereco">--</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer grid grid-cols-2 gap-3 mt-6">
                <button class="btn btn-secondary w-full close-modal-btn"
                    data-target="cliente-details-modal">Voltar</button>
                <button class="btn btn-primary w-full bg-black text-white hover:bg-gray-800"
                    onclick="alert('Funcionalidade em desenvolvimento')"><i class='bx bx-printer mr-1'></i>
                    Extrato</button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal-overlay" id="cliente-pay-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Receber Pagamento</h3>
                <button class="close-modal-btn" data-target="cliente-pay-modal"><i class='bx bx-x'></i></button>
            </div>
            <form id="cliente-pay-form">
                <div class="modal-body">
                    <p class="mb-4 text-gray-600">Recebendo de <strong id="pay-cliente-nome"
                            class="text-gray-900">...</strong></p>
                    <div class="p-6 bg-gray-50 rounded-2xl border border-gray-200 mb-6 text-center">
                        <p class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">Dívida Total Atual</p>
                        <p class="text-3xl font-bold text-gray-900" id="pay-cliente-saldo-atual">R$ 0,00</p>
                    </div>

                    <div class="form-group mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Valor do Pagamento (R$)</label>
                        <input type="number" id="pay-valor" step="0.01" min="0.01" placeholder="0,00" required
                            class="w-full text-2xl font-bold text-gray-900 p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-500 focus:border-gray-500 outline-none transition-all">
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Forma de Pagamento</label>
                        <select id="pay-metodo" required
                            class="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-900 focus:border-gray-900 outline-none">
                            <option value="Dinheiro">Dinheiro (Espécie)</option>
                            <option value="PIX">PIX</option>
                            <option value="Cartão">Cartão de Crédito/Débito</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer grid grid-cols-2 gap-3">
                    <button type="button" class="btn btn-secondary w-full close-modal-btn"
                        data-target="cliente-pay-modal">Cancelar</button>
                    <button type="submit"
                        class="btn btn-primary w-full bg-black text-white hover:bg-gray-800">Confirmar</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Script Unificado -->
    <script src="/assets/js/script26.js"></script>

    <!-- Crediário Main Logic -->
    <script>
        // --- Firebase Configuration (Same as PDV) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAVQ3tf6Qu4_9PajpJclZAJjVvRgB4ZE2I",
            authDomain: "super-app25.firebaseapp.com",
            projectId: "super-app25",
            storageBucket: "super-app25.firebasestorage.app",
            messagingSenderId: "810900166273",
            appId: "1:810900166273:web:24b8f055a68c9f0a6b5f80"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.firestore();

        // --- Configs & Globals ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzB7dluoiNyJ4XK6oDK_iyuKZfwPTAJa4ua4RetQsUX9cMObgE-k_tFGI82HxW_OyMf/exec";
        let localClientCache = [];
        let selectedClientForPayment = null;

        // --- Utils ---
        const formatCurrency = (val) => {
            const n = Number(val);
            return isNaN(n) ? 'R$ 0,00' : n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        const parseDataSegura = (dataStr) => {
            if (!dataStr) return null;
            if (dataStr instanceof Date) return dataStr;
            if (dataStr.seconds) return new Date(dataStr.seconds * 1000); // Firestore Timestamp

            // Formats: dd/mm/yyyy or yyyy-mm-dd
            if (dataStr.includes('/')) {
                const parts = dataStr.split('/');
                if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return new Date(dataStr);
        };

        const simpleDate = (date) => {
            if (!date) return '--/--';
            const d = new Date(date);
            return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        };

        const getInitials = (name) => {
            if (!name) return '?';
            const parts = name.trim().split(' ');
            if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        };

        // --- Core Logic ---

        async function loadClientsFromFirebase() {
            const grid = document.getElementById('clients-grid');
            // Skeleton is already there by default static HTML, but if we reload:
            renderSkeleton(grid);

            try {
                const response = await fetch(`${SCRIPT_URL}?action=listarClientes`);
                const result = await response.json();

                if (result.status === 'success' && Array.isArray(result.data)) {
                    localClientCache = result.data; // Cache global
                    renderCards(localClientCache);
                    updateDashboardTotals();
                } else {
                    throw new Error(result.message || "Formato inválido");
                }
            } catch (error) {
                console.error("Erro ao carregar clientes:", error);
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-400">
                        <i class='bx bx-error-circle text-4xl mb-2'></i>
                        <p>Erro ao carregar dados. <button onclick="loadClientsFromFirebase()" class="underline text-red-500">Tentar novamente</button></p>
                    </div>`;
            }
        }

        function renderSkeleton(container) {
            // Generates 6 skeleton cards
            let html = '';
            for (let i = 0; i < 6; i++) {
                html += `
                <div class="client-card animate-pulse">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gray-200"></div>
                        <div class="flex-1">
                            <div class="h-4 bg-gray-100 rounded w-3/4 mb-2"></div>
                            <div class="h-3 bg-gray-100 rounded w-1/2"></div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="h-8 bg-gray-100 rounded w-full"></div>
                        <div class="h-2 bg-gray-100 rounded-full w-full"></div>
                        <div class="flex justify-between gap-2 mt-4">
                            <div class="h-10 bg-gray-100 rounded w-1/2"></div>
                            <div class="h-10 bg-gray-100 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }

        function renderCards(clients) {
            const grid = document.getElementById('clients-grid');
            const searchInput = document.getElementById('client-search-input');
            const searchVal = searchInput ? searchInput.value.toLowerCase() : '';
            grid.innerHTML = '';

            const filtered = clients.filter(c => {
                const term = searchVal;
                const name = c.nomeExibicao || c.nome || '';
                const apelido = c.apelido || '';
                const cpf = c.cpf || '';
                return name.toLowerCase().includes(term) || apelido.toLowerCase().includes(term) || cpf.includes(term);
            });

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-12 text-gray-400">Nenhum cliente encontrado.</div>`;
                return;
            }

            // Same sorting logic as before
            filtered.sort((a, b) => {
                const getVars = (c) => {
                    const saldo = parseFloat(c.saldoDevedor || 0);
                    const venc = parseDataSegura(c.proximoVencimento);
                    const isValidDate = venc && !isNaN(venc.getTime());
                    const diffDays = isValidDate ? Math.ceil((venc - new Date()) / (1000 * 60 * 60 * 24)) : 0;
                    return { saldo, diffDays };
                };
                const dA = getVars(a);
                const dB = getVars(b);

                const isQuitadoA = dA.saldo <= 0.01;
                const isQuitadoB = dB.saldo <= 0.01;
                if (isQuitadoA && !isQuitadoB) return -1;
                if (!isQuitadoA && isQuitadoB) return 1;
                if (isQuitadoA && isQuitadoB) return (a.nome || '').localeCompare(b.nome || '');

                const isAtrasadoA = dA.diffDays < 0;
                const isAtrasadoB = dB.diffDays < 0;
                if (!isAtrasadoA && isAtrasadoB) return -1;
                if (isAtrasadoA && !isAtrasadoB) return 1;

                if (isAtrasadoA && isAtrasadoB) return dB.diffDays - dA.diffDays;
                return dA.diffDays - dB.diffDays;
            });

            filtered.forEach(client => {
                const saldo = parseFloat(client.saldoDevedor || 0);
                const venc = parseDataSegura(client.proximoVencimento);
                const diffDays = venc ? Math.ceil((venc - new Date()) / (1000 * 60 * 60 * 24)) : 0;
                const clientName = client.nomeExibicao || client.nome || 'Cliente';
                const initials = getInitials(clientName);

                // Limit Calculation for Mini Bar
                const limite = parseFloat(client.limite || 0);
                let percent = 0;
                let barColor = 'bg-[var(--brand-color)]'; // Use brand color
                if (limite > 0) {
                    percent = Math.min(100, (saldo / limite) * 100);
                }

                const installmentText = (saldo > 0) ? `1x ${formatCurrency(saldo)}` : '--';

                // Status Logic - Minimalist
                let statusLabel = '';
                let statusClass = '';
                let statusIcon = '';

                if (saldo <= 0.01) {
                    statusLabel = 'Quitado';
                    statusClass = 'bg-gray-50 text-gray-400';
                    statusIcon = 'bx-check';
                } else if (diffDays < 0) {
                    statusLabel = `Atraso (${Math.abs(diffDays)}d)`;
                    statusClass = 'bg-gray-100 text-gray-900 font-bold';
                    statusIcon = 'bx-time';
                } else if (diffDays === 0) {
                    statusLabel = 'Vence Hoje';
                    statusClass = 'bg-gray-100 text-gray-900 font-medium';
                    statusIcon = 'bx-bell';
                } else {
                    statusLabel = 'Em Dia';
                    statusClass = 'bg-transparent border border-gray-100 text-gray-500';
                    statusIcon = 'bx-calendar';
                }

                const card = document.createElement('div');
                card.className = 'client-card flex flex-col justify-between h-full';
                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <div class="client-avatar text-gray-500 bg-gray-50">
                                    ${initials}
                                </div>
                                <div class="overflow-hidden">
                                    <h4 class="font-bold text-gray-900 text-sm md:text-base truncate" title="${clientName}">${clientName}</h4>
                                    <p class="text-xs text-gray-400 truncate">${client.apelido || 'Novo cliente'}</p>
                                </div>
                            </div>
                            <span class="px-2 py-1 rounded text-[10px] uppercase tracking-wider flex items-center gap-1 ${statusClass}">
                                <i class='bx ${statusIcon}'></i> ${statusLabel}
                            </span>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-[10px] text-gray-400 font-semibold uppercase mb-1">Saldo Devedor</p>
                            <!-- New Line: Installment Info -->
                            <p class="text-xs font-medium text-gray-500 mb-0.5">${installmentText}</p>
                            
                            <div class="flex items-baseline gap-1">
                                <span class="text-xl font-bold text-gray-900">${formatCurrency(saldo)}</span>
                            </div>
                            ${saldo > 0 ? `<p class="text-xs text-gray-400 mt-1"><i class='bx bx-calendar'></i> ${venc ? simpleDate(venc) : '--/--'}</p>` : ''}
                        </div>

                         ${limite > 0 ? `
                        <div class="w-full h-1 bg-gray-100 rounded-full mb-1 overflow-hidden">
                            <div class="h-full ${barColor}" style="width: ${percent}%"></div>
                        </div>
                        <p class="text-[10px] text-gray-400 text-right w-full mb-4">${percent.toFixed(0)}% do limite</p>
                        ` : ''}
                    </div>

                    <div class="flex gap-2 mt-auto">
                        <button onclick="openDetails('${client.idCliente}')" class="flex-1 py-3 rounded-xl bg-gray-50 text-gray-600 hover:bg-gray-100 hover:text-gray-900 text-sm font-semibold transition-colors flex items-center justify-center gap-1 border border-transparent hover:border-gray-200">
                            Detalhes
                        </button>
                        <button onclick="togglePaymentLock(this)" class="flex-1 py-3 rounded-xl bg-[#db0038] text-white hover:bg-red-700 text-sm font-semibold transition-all duration-300 flex items-center justify-center gap-1 shadow-md shadow-red-100">
                            <i class='bx bx-dollar-circle icon-state'></i> <span class="text-state">Receber</span>
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        window.togglePaymentLock = (btn) => {
            const isLocked = btn.classList.contains('locked-state');
            const icon = btn.querySelector('.icon-state');
            const text = btn.querySelector('.text-state');

            if (!isLocked) {
                // Change to Locked State
                btn.classList.add('locked-state');
                btn.classList.remove('bg-[#db0038]', 'hover:bg-red-700', 'shadow-red-100');
                btn.classList.add('bg-black', 'hover:bg-gray-900', 'shadow-gray-200');

                if (icon) icon.className = 'bx bx-lock-alt icon-state text-lg';
                if (text) text.innerText = 'Bloqueado';
            } else {
                // Revert to Default State (Optional: if the user wants it to toggle back)
                btn.classList.remove('locked-state');
                btn.classList.remove('bg-black', 'hover:bg-gray-900', 'shadow-gray-200');
                btn.classList.add('bg-[#db0038]', 'hover:bg-red-700', 'shadow-red-100');

                if (icon) icon.className = 'bx bx-dollar-circle icon-state';
                if (text) text.innerText = 'Receber';
            }
        }

        function updateDashboardTotals() {
            let totalReceivable = 0;
            let totalOverdue = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            localClientCache.forEach(c => {
                const saldo = parseFloat(c.saldoDevedor || 0);
                if (saldo > 0.01) {
                    totalReceivable += saldo;
                    const venc = parseDataSegura(c.proximoVencimento);
                    if (venc && venc < today) {
                        totalOverdue += saldo;
                    }
                }
            });

            // Update Top Balance
            if (document.getElementById('total-receivable')) document.getElementById('total-receivable').innerText = formatCurrency(totalReceivable);

            // Update New KPI Cards
            const formattedTotal = totalReceivable.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const parts = formattedTotal.split(',');
            if (document.getElementById('kpi-cred-val')) {
                if (parts.length === 2) {
                    document.getElementById('kpi-cred-val').innerText = parts[0];
                    document.getElementById('kpi-cred-dec').innerText = ',' + parts[1];
                } else {
                    document.getElementById('kpi-cred-val').innerText = formattedTotal;
                    document.getElementById('kpi-cred-dec').innerText = '';
                }
            }

            // Update Overdue KPI
            const formattedOverdue = totalOverdue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const partsOverdue = formattedOverdue.split(',');
            if (document.getElementById('kpi-overdue-val')) {
                if (partsOverdue.length === 2) {
                    document.getElementById('kpi-overdue-val').innerText = partsOverdue[0];
                    document.getElementById('kpi-overdue-dec').innerText = ',' + partsOverdue[1];
                } else {
                    document.getElementById('kpi-overdue-val').innerText = formattedOverdue;
                    document.getElementById('kpi-overdue-dec').innerText = '';
                }
            }

            if (document.getElementById('kpi-clients-count')) {
                document.getElementById('kpi-clients-count').innerText = localClientCache.length;
            }
        }

        // --- Modals Logic ---

        window.openDetails = (clientId) => {
            const client = localClientCache.find(c => c.idCliente == clientId || c.id == clientId);
            if (!client) return;

            document.getElementById('detail-cliente-nome').innerText = client.nome || 'Nome não inf.';
            document.getElementById('detail-cliente-apelido').innerText = client.apelido || '';
            document.getElementById('detail-cliente-avatar-text').innerText = getInitials(client.nome);

            // Generate Status Badge
            const saldo = parseFloat(client.saldoDevedor || 0);
            const venc = parseDataSegura(client.proximoVencimento);
            const diffDays = venc ? Math.ceil((venc - new Date()) / (1000 * 60 * 60 * 24)) : 0;
            let badgeHtml = '';
            if (saldo <= 0.01) {
                badgeHtml = `<span class="bg-gray-100 text-gray-500 font-bold px-2 py-0.5 rounded text-xs uppercase">Quitado</span>`;
            } else if (diffDays < 0) {
                badgeHtml = `<span class="bg-gray-100 text-gray-900 font-bold px-2 py-0.5 rounded text-xs uppercase">Atrasado</span>`;
            } else {
                badgeHtml = `<span class="bg-gray-50 text-gray-900 font-bold px-2 py-0.5 rounded text-xs uppercase">Em Dia</span>`;
            }
            document.getElementById('detail-cliente-status-badge').innerHTML = badgeHtml;

            document.getElementById('detail-cliente-saldo').innerText = formatCurrency(saldo);
            document.getElementById('detail-cliente-vencimento').innerText = venc ? simpleDate(venc) : '--/--';

            // Limit Logic
            const limite = parseFloat(client.limite || 0);
            const disponivel = Math.max(0, limite - saldo);
            let percent = 0;
            if (limite > 0) percent = Math.min(100, (saldo / limite) * 100);

            document.getElementById('detail-cliente-limite-total').innerText = formatCurrency(limite);
            document.getElementById('detail-cliente-disponivel').innerText = `Disp: ${formatCurrency(disponivel)}`;
            document.getElementById('detail-cliente-percentual').innerText = `${percent.toFixed(0)}% Utilizado`;

            const bar = document.getElementById('detail-cliente-progress');
            bar.style.width = `${percent}%`;
            bar.className = 'progress-fill h-full transition-all duration-500 bg-[var(--brand-color)]'; // Brand Color

            // Contacts
            document.getElementById('detail-cliente-telefone').innerText = client.telefone || 'Sem contato';
            document.getElementById('detail-cliente-endereco').innerText = client.endereco || 'Sem endereço';

            // Show Modal
            openModal('cliente-details-modal');
        }

        window.openPayment = (clientId) => {
            const client = localClientCache.find(c => c.idCliente == clientId || c.id == clientId);
            if (!client) return;

            selectedClientForPayment = client;
            document.getElementById('pay-cliente-nome').innerText = client.apelido || client.nome;
            document.getElementById('pay-cliente-saldo-atual').innerText = formatCurrency(client.saldoDevedor || 0);
            document.getElementById('pay-valor').value = '';

            openModal('cliente-pay-modal');
        }

        // Generic Modal Helpers
        function openModal(id) {
            const m = document.getElementById(id);
            if (m) m.classList.add('active');
        }

        // Setup Close Buttons
        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = btn.getAttribute('data-target');
                document.getElementById(targetId).classList.remove('active');
            });
        });

        // Search Listener
        document.getElementById('client-search-input').addEventListener('input', () => {
            renderCards(localClientCache);
        });

        // Payment Form Submit
        document.getElementById('cliente-pay-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedClientForPayment) return;

            const valor = parseFloat(document.getElementById('pay-valor').value);
            const metodo = document.getElementById('pay-metodo').value;

            if (!valor || valor <= 0) {
                alert("Digite um valor válido.");
                return;
            }

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class='bx bx-loader-alt bx-spin'></i> Processando...`;
            btn.disabled = true;

            try {
                const payload = {
                    action: 'registrarPagamento',
                    idCliente: selectedClientForPayment.idCliente || selectedClientForPayment.id,
                    valor: valor,
                    formaPagamento: metodo,
                    origem: 'Painel Admin'
                };

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                const resText = await response.text();
                alert("Pagamento registrado com sucesso!");
                document.getElementById('cliente-pay-modal').classList.remove('active');
                loadClientsFromFirebase(); // Reload

            } catch (err) {
                console.error(err);
                alert("Erro ao registrar pagamento. Verifique a conexão.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // Initial Load
        document.addEventListener('DOMContentLoaded', () => {
            loadClientsFromFirebase();
        });

    </script>
</body>

</html>