<!DOCTYPE html>
<html lang="pt-br" data-view="mobile" data-minimized="false">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-9060080612658200">
    <link rel="icon" href="/assets/img/iconWeb.png">
    <title>Crediário | Nubia</title>

    <!-- Libs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- BoxIcons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/2.6.0/uicons-solid-straight/css/uicons-solid-straight.css'>
    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/2.6.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <!-- CSS Global -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/style26.css">

    <!-- View Transitions API -->
    <meta name="view-transition" content="same-origin">

    <!-- Navbar Anti-Flash -->
    <script>
        (function () {
            const savedState = localStorage.getItem('acc_navbar');
            if (savedState !== null) {
                document.documentElement.setAttribute('data-minimized', savedState);
                if (savedState === 'true') {
                    document.documentElement.classList.add('sidebar-minimized-init');
                }
            }
        })();
    </script>
</head>

<body style="--marker-x: 0%; --marker-y: 50%;">

    <div id="chart-tooltip"></div>

    <div id="app-container" class="page-crediario">
        <!-- Info Profile -->
        <div class="info">
            <div class="photo-profile">
                <img src="/users/45692327000100/CD1/adm/nb/img/profile_photo.jpg">
                <div class="detals">
                    <h1>Olá, Nubia!</h1>
                    <p>CEO: D'TUDO | Dupão</p>
                </div>
                <i class="fi fi-rr-shield-trust"></i>
            </div>
            <div class="balance">
                <p>Recebível Total</p>
                <div class="saldo">
                    <span id="total-receivable" class="">R$ 0,00</span>
                    <i class="bx bx-show" id="toggle-balance-icon"></i>
                </div>
                <!-- Pending removed from banner -->
            </div>
        </div>

        <!-- Mobile Back Button -->
        <div class="w-full px-4 mt-4 -mb-2 md:hidden">
            <button onclick="window.location.href='conta.html'"
                class="flex items-center text-gray-500 hover:text-gray-800 font-semibold transition-colors">
                <i class='bx bx-chevron-left text-3xl'></i>
                <span class="-ml-1">Voltar</span>
            </button>
        </div>

        <!-- KPIs -->
        <div class="kpi-area grid-kpi cols-3 mb-6">
            <!-- Crédito a Receber -->
            <div class="finance-card kpi-card">
                <span class="kpi-label">Crédito a Receber</span>
                <div class="flex items-baseline">
                    <span class="kpi-value" id="kpi-cred-val">R$ 0</span>
                    <span class="text-xs ml-0.5 text-gray-500 font-bold" id="kpi-cred-dec">,00</span>
                </div>
                <span class="kpi-trend text-green-500" id="trend-cred">Ativos</span>
            </div>

            <!-- Em Atraso (New) -->
            <div class="finance-card kpi-card">
                <span class="kpi-label">Em Atraso</span>
                <div class="flex items-baseline">
                    <span class="kpi-value" id="kpi-overdue-val">R$ 0</span>
                    <span class="text-xs ml-0.5 text-gray-500 font-bold" id="kpi-overdue-dec">,00</span>
                </div>
                <span class="kpi-trend text-red-500" id="trend-overdue">Vencidos</span>
            </div>

            <!-- Quantidade de Clientes -->
            <div class="finance-card kpi-card">
                <span class="kpi-label">Carteira de Clientes</span>
                <div class="flex items-baseline">
                    <span class="kpi-value" id="kpi-clients-count">0</span>
                </div>
                <span class="kpi-trend text-blue-500" id="trend-clients">Cadastrados</span>
            </div>
        </div>

        <!-- Content -->
        <div class="finance-card p-6 w-full max-w-full" style="min-height: 80vh;">
            <!-- Header -->
            <h3 class="text-[10px] uppercase font-bold text-gray-400 tracking-widest mb-4">Carteira de Crédito</h3>

            <!-- Search Area -->
            <div class="client-search-wrapper w-full mb-6 relative">
                <i class='bx bx-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-lg'></i>
                <input type="text" id="client-search-input"
                    class="w-full pl-12 pr-4 py-3 border border-gray-200 rounded-full focus:outline-none focus:border-red-500 transition-colors"
                    placeholder="Buscar por nome, apelido ou CPF..." autocomplete="off">
            </div>

            <!-- Clients Table -->
            <div class="crediario-table-container">
                <table class="finance-table w-full">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Status Crediário</th>
                            <th>Dívida Atual</th>
                            <th>Próx. Venc.</th>
                            <th class="text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="clients-table-body">
                        <tr>
                            <td colspan="5" class="text-center py-8 text-gray-400">
                                <i class='bx bx-loader-alt bx-spin text-2xl mb-2'></i><br>Carregando clientes...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Navbar -->
    <div class="nav-container hidden-mobile-paged">
        <div class="nav-marker" id="nav-marker"></div>
        <div class="nav-bg" id="nav-bg"></div>
        <nav class="nav-overlay" id="nav-overlay">
            <div class="nav-header-toggle">
                <div class="btn-toggle-sidebar" onclick="toggleSidebar()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        id="toggle-icon" style="transition: transform 0.3s ease;">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </div>
            </div>

            <div class="nav-links-container">
                <div class="nav-item" onclick="navigateTo('conta.html')">
                    <div class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                    </div>
                    <span class="nav-label">Casa</span>
                </div>

                <div class="nav-item" onclick="navigateTo('metricas.html')">
                    <div class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                    </div>
                    <span class="nav-label">Métricas</span>
                </div>

                <div class="nav-item desktop-only" onclick="navigateTo('/pdv/index.html')">
                    <div class="nav-icon">
                        <i class="bx bx-cart-minus" style="font-size: 24px;"></i>
                    </div>
                    <span class="nav-label">PDV</span>
                </div>

                <div class="nav-item desktop-only" onclick="navigateTo('manager.html')">
                    <div class="nav-icon">
                        <i class='bxr bx-scan-barcode'></i>
                    </div>
                    <span class="nav-label">Despesas</span>
                </div>

                <div class="nav-item" onclick="navigateTo('extrato.html')">
                    <div class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <line x1="10" y1="9" x2="8" y2="9"></line>
                        </svg>
                    </div>
                    <span class="nav-label">Extrato</span>
                </div>

                <div class="nav-item active desktop-only" onclick="navigateTo('crediario.html')">
                    <div class="nav-icon">
                        <i class='bxr bx-wallet-cards'></i>
                    </div>
                    <span class="nav-label">Crediário</span>
                </div>

                <div class="nav-item"
                    onclick="localStorage.removeItem('session_token'); window.location.href='/users/e-finance.html'">
                    <div class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </div>
                    <span class="nav-label">Sair</span>
                </div>
            </div>
        </nav>
    </div>

    <!-- Modals -->

    <!-- Details Modal -->
    <div class="modal-overlay" id="cliente-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ficha do Cliente</h3>
                <button class="close-modal-btn" data-target="cliente-details-modal"><i class='bx bx-x'></i></button>
            </div>
            <div class="modal-body">
                <div class="client-profile-header">
                    <div class="client-avatar-lg"><i class='bx bx-user'></i></div>
                    <div style="flex-grow: 1;">
                        <h4 id="detail-cliente-nome" class="text-lg font-bold">Carregando...</h4>
                        <p id="detail-cliente-apelido" class="text-light text-sm">...</p>
                    </div>
                </div>
                <div class="client-stats-grid">
                    <div class="stat-box">
                        <span class="stat-label">Saldo Devedor</span>
                        <span class="stat-value danger" id="detail-cliente-saldo">R$ 0,00</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">Próximo Venc.</span>
                        <span class="stat-value" id="detail-cliente-vencimento">--/--/----</span>
                    </div>
                </div>

                <div class="limit-container">
                    <div class="limit-header">
                        <span>Limite de Crédito</span>
                        <strong id="detail-cliente-limite-total">R$ 0,00</strong>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" id="detail-cliente-progress"></div>
                    </div>
                    <div class="limit-header mt-2 text-xs text-gray-400">
                        <span id="detail-cliente-disponivel">Disp: R$ 0,00</span>
                        <span id="detail-cliente-percentual">0%</span>
                    </div>
                </div>

                <div class="history-section mt-6">
                    <h4><i class='bx bx-history'></i> Histórico Recente</h4>
                    <div id="detail-history-container">
                        <!-- History Items -->
                    </div>
                </div>

                <div class="mt-6">
                    <p class="text-xs font-bold text-gray-500 uppercase mb-2">Contato</p>
                    <p class="text-sm text-gray-700 mb-1"><i class='bx bx-phone mr-2'></i> <span
                            id="detail-cliente-telefone">--</span></p>
                    <p class="text-sm text-gray-700"><i class='bx bx-map mr-2'></i> <span
                            id="detail-cliente-endereco">--</span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal-btn" data-target="cliente-details-modal"
                    style="width: auto;">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal-overlay" id="cliente-pay-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Receber Pagamento</h3>
                <button class="close-modal-btn" data-target="cliente-pay-modal"><i class='bx bx-x'></i></button>
            </div>
            <form id="cliente-pay-form">
                <div class="modal-body">
                    <p class="mb-4">Cliente: <strong id="pay-cliente-nome">...</strong></p>
                    <div class="p-4 bg-red-50 rounded-lg border border-red-100 mb-4 text-center">
                        <p class="text-xs text-red-600 font-bold uppercase">Dívida Total</p>
                        <p class="text-2xl font-bold text-red-700" id="pay-cliente-saldo-atual">R$ 0,00</p>
                    </div>

                    <div class="form-group">
                        <label>Valor a Receber (R$)</label>
                        <input type="number" id="pay-valor" step="0.01" min="0.01" placeholder="0,00" required
                            class="text-lg font-bold text-green-700">
                    </div>

                    <div class="form-group">
                        <label>Forma de Pagamento</label>
                        <select id="pay-metodo" required>
                            <option value="Dinheiro">Dinheiro (Espécie)</option>
                            <option value="PIX">PIX</option>
                            <option value="Cartão">Cartão de Crédito/Débito</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal-btn" data-target="cliente-pay-modal"
                        style="width: auto;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="background:#16a34a;">Confirmar
                        Recebimento</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Script Unificado -->
    <script src="/assets/js/script26.js"></script>

    <!-- Crediário Main Logic -->
    <script>
        // --- Firebase Configuration (Same as PDV) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAVQ3tf6Qu4_9PajpJclZAJjVvRgB4ZE2I",
            authDomain: "super-app25.firebaseapp.com",
            projectId: "super-app25",
            storageBucket: "super-app25.firebasestorage.app",
            messagingSenderId: "810900166273",
            appId: "1:810900166273:web:24b8f055a68c9f0a6b5f80"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.firestore();

        // --- Configs & Globals ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzB7dluoiNyJ4XK6oDK_iyuKZfwPTAJa4ua4RetQsUX9cMObgE-k_tFGI82HxW_OyMf/exec";
        const REGISTRO_VENDA_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCCaxdYdC6J_QKsaoWTDquH915MHUnM9BykD39ZUujR2LB3lx9d9n5vAsHdJZJByaa7w/exec";
        let localClientCache = [];
        let selectedClientForPayment = null;

        // --- Utils ---
        const formatCurrency = (val) => {
            const n = Number(val);
            return isNaN(n) ? 'R$ 0,00' : n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        const parseDataSegura = (dataStr) => {
            if (!dataStr) return null;
            if (dataStr instanceof Date) return dataStr;
            if (dataStr.seconds) return new Date(dataStr.seconds * 1000); // Firestore Timestamp

            // Formats: dd/mm/yyyy or yyyy-mm-dd
            if (dataStr.includes('/')) {
                const parts = dataStr.split('/');
                if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return new Date(dataStr);
        };

        const simpleDate = (date) => {
            if (!date) return '--/--/--';
            const d = new Date(date);
            return d.toLocaleDateString('pt-BR');
        };

        // --- Core Logic ---

        async function loadClientsFromFirebase() {
            const tbody = document.getElementById('clients-table-body');
            tbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-400"><i class='bx bx-loader-alt bx-spin text-2xl mb-2'></i><br>Atualizando base de dados...</td></tr>`;

            try {
                // Corrected action from 'getClientes' to 'listarClientes' based on pdv/script.js
                // Also parsing result.data as the API returns wrapped object {status: 'success', data: [...]}
                const response = await fetch(`${SCRIPT_URL}?action=listarClientes`);
                const result = await response.json();

                if (result.status === 'success' && Array.isArray(result.data)) {
                    localClientCache = result.data; // Cache global
                    renderTable(localClientCache);
                    updateDashboardTotals();
                } else {
                    throw new Error(result.message || "Formato inválido");
                }
            } catch (error) {
                console.error("Erro ao carregar clientes:", error);
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-red-400">Erro ao carregar dados: ${error.message}</td></tr>`;
            }
        }

        function renderTable(clients) {
            const tbody = document.getElementById('clients-table-body');
            const searchInput = document.getElementById('client-search-input');
            const searchVal = searchInput ? searchInput.value.toLowerCase() : '';
            tbody.innerHTML = '';

            const filtered = clients.filter(c => {
                const term = searchVal;
                // Using 'nomeExibicao' as primary name field, fallback to 'nome'
                const name = c.nomeExibicao || c.nome || '';
                const apelido = c.apelido || '';
                const cpf = c.cpf || '';

                return name.toLowerCase().includes(term) ||
                    apelido.toLowerCase().includes(term) ||
                    cpf.includes(term);
            });

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-400">Nenhum cliente encontrado.</td></tr>`;
                return;
            }

            // Sort by debt desc
            filtered.sort((a, b) => (b.saldoDevedor || 0) - (a.saldoDevedor || 0));

            filtered.forEach(client => {
                const saldo = parseFloat(client.saldoDevedor || 0);
                const venc = parseDataSegura(client.proximoVencimento);
                const diffDays = venc ? Math.ceil((venc - new Date()) / (1000 * 60 * 60 * 24)) : 0;
                const clientName = client.nomeExibicao || client.nome || 'Cliente';

                let statusBadge = '';
                if (saldo <= 0.01) {
                    statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700 uppercase tracking-wider"><i class='bx bx-check mr-1'></i>Quitado</span>`;
                } else if (diffDays < 0) {
                    statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700 uppercase tracking-wider"><i class='bx bx-time mr-1'></i>Atrasado</span>`;
                } else if (diffDays === 0) {
                    statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-yellow-100 text-yellow-800 uppercase tracking-wider"><i class='bx bx-bell mr-1'></i>Hoje</span>`;
                } else {
                    statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-blue-100 text-blue-700 uppercase tracking-wider">Em dia</span>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td class="col-name">
                <div class="font-bold text-gray-800">${clientName}</div>
                <div class="text-xs text-gray-400">${client.apelido && client.apelido !== clientName ? client.apelido : ''}</div>
            </td>
            <td class="col-status">${statusBadge}</td>
            <td class="col-debt font-bold ${saldo > 0 ? 'text-red-500' : 'text-green-600'}">${formatCurrency(saldo)}</td>
            <td class="col-venc text-sm">${venc ? simpleDate(venc) : '-'}</td>
            <td class="col-actions text-right">
                <button class="btn-icon-small hover:bg-gray-100 p-2 rounded-full" onclick="openDetails('${client.idCliente}')" title="Detalhes"><i class='bx bx-zoom-in' style="font-size: 1.2rem;"></i></button>
            </td>
        `;
                tbody.appendChild(tr);
            });
        }

        function updateDashboardTotals() {
            let totalReceivable = 0;
            let totalOverdue = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            localClientCache.forEach(c => {
                const saldo = parseFloat(c.saldoDevedor || 0);
                if (saldo > 0.01) {
                    totalReceivable += saldo;
                    const venc = parseDataSegura(c.proximoVencimento);
                    if (venc && venc < today) {
                        totalOverdue += saldo;
                    }
                }
            });

            // Update Top Balance (kept for compatibility if needed, but UI changed)
            if (document.getElementById('total-receivable')) document.getElementById('total-receivable').innerText = formatCurrency(totalReceivable);
            if (document.getElementById('total-overdue')) document.getElementById('total-overdue').innerText = formatCurrency(totalOverdue);

            // Update New KPI Cards
            const formattedTotal = totalReceivable.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const parts = formattedTotal.split(',');
            if (document.getElementById('kpi-cred-val')) {
                if (parts.length === 2) {
                    document.getElementById('kpi-cred-val').innerText = parts[0];
                    document.getElementById('kpi-cred-dec').innerText = ',' + parts[1];
                } else {
                    document.getElementById('kpi-cred-val').innerText = formattedTotal;
                    document.getElementById('kpi-cred-dec').innerText = '';
                }
            }

            // Update Overdue KPI
            const formattedOverdue = totalOverdue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const partsOverdue = formattedOverdue.split(',');
            if (document.getElementById('kpi-overdue-val')) {
                if (partsOverdue.length === 2) {
                    document.getElementById('kpi-overdue-val').innerText = partsOverdue[0];
                    document.getElementById('kpi-overdue-dec').innerText = ',' + partsOverdue[1];
                } else {
                    document.getElementById('kpi-overdue-val').innerText = formattedOverdue;
                    document.getElementById('kpi-overdue-dec').innerText = '';
                }
            }

            if (document.getElementById('kpi-clients-count')) {
                document.getElementById('kpi-clients-count').innerText = localClientCache.length;
            }
        }

        // --- Modals Logic ---

        window.openDetails = (clientId) => {
            const client = localClientCache.find(c => c.idCliente == clientId || c.id == clientId);
            if (!client) return;

            document.getElementById('detail-cliente-nome').innerText = client.nome || 'Nome não inf.';
            document.getElementById('detail-cliente-apelido').innerText = client.apelido || '';
            document.getElementById('detail-cliente-saldo').innerText = formatCurrency(client.saldoDevedor || 0);

            const venc = parseDataSegura(client.proximoVencimento);
            document.getElementById('detail-cliente-vencimento').innerText = venc ? simpleDate(venc) : 'Não definido';

            // Limit Logic
            const limite = parseFloat(client.limite || 0);
            const saldo = parseFloat(client.saldoDevedor || 0);
            const disponivel = Math.max(0, limite - saldo);
            let percent = 0;
            if (limite > 0) percent = Math.min(100, (saldo / limite) * 100);

            document.getElementById('detail-cliente-limite-total').innerText = formatCurrency(limite);
            document.getElementById('detail-cliente-disponivel').innerText = `Disp: ${formatCurrency(disponivel)}`;
            document.getElementById('detail-cliente-percentual').innerText = `${percent.toFixed(0)}% Utilizado`;

            const bar = document.getElementById('detail-cliente-progress');
            bar.style.width = `${percent}%`;
            bar.className = 'progress-fill';
            if (percent > 90) bar.classList.add('danger');
            else if (percent > 70) bar.classList.add('warning');

            // Contacts
            document.getElementById('detail-cliente-telefone').innerText = client.telefone || 'Sem contato';
            document.getElementById('detail-cliente-endereco').innerText = client.endereco || 'Sem endereço';

            // History (Mock or Fetch from detailed endpoint if needed, but for now we show basic debt)
            const histContainer = document.getElementById('detail-history-container');
            histContainer.innerHTML = `<p class="text-sm text-gray-400 italic">Histórico detalhado disponível no PDV.</p>`;

            // Show Modal
            openModal('cliente-details-modal');
        }

        window.openPayment = (clientId) => {
            const client = localClientCache.find(c => c.idCliente == clientId || c.id == clientId);
            if (!client) return;

            selectedClientForPayment = client;
            document.getElementById('pay-cliente-nome').innerText = client.apelido || client.nome;
            document.getElementById('pay-cliente-saldo-atual').innerText = formatCurrency(client.saldoDevedor || 0);
            document.getElementById('pay-valor').value = '';

            openModal('cliente-pay-modal');
        }

        // Generic Modal Helpers
        function openModal(id) {
            const m = document.getElementById(id);
            if (m) m.classList.add('active');
        }

        // Setup Close Buttons
        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = btn.getAttribute('data-target');
                document.getElementById(targetId).classList.remove('active');
            });
        });

        // Search Listener
        document.getElementById('client-search-input').addEventListener('input', () => {
            renderTable(localClientCache);
        });

        // Payment Form Submit
        document.getElementById('cliente-pay-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedClientForPayment) return;

            const valor = parseFloat(document.getElementById('pay-valor').value);
            const metodo = document.getElementById('pay-metodo').value;

            if (!valor || valor <= 0) {
                alert("Digite um valor válido.");
                return;
            }

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class='bx bx-loader-alt bx-spin'></i> Processando...`;
            btn.disabled = true;

            try {
                // Construct Payload similar to PDV
                const payload = {
                    action: 'registrarPagamento',
                    idCliente: selectedClientForPayment.idCliente || selectedClientForPayment.id,
                    valor: valor,
                    formaPagamento: metodo,
                    origem: 'Painel Admin'
                };

                // Use URL encoded form data as PDV likely does
                // actually PDV uses JSON or URL params? Looking at pdv/script.js:
                // It usually posts to REGISTRO_VENDA_SCRIPT_URL or SCRIPT_URL. 
                // Let's assume standard POST to SCRIPT_URL for client updates.

                // Note: In provided context, `registrarPagamentoClienteAPI` uses `fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })`.

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                const resText = await response.text();
                // Apps script often calls text() or json().

                alert("Pagamento registrado com sucesso!");
                document.getElementById('cliente-pay-modal').classList.remove('active');
                loadClientsFromFirebase(); // Reload

            } catch (err) {
                console.error(err);
                alert("Erro ao registrar pagamento. Verifique a conexão.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // Initial Load
        document.addEventListener('DOMContentLoaded', () => {
            loadClientsFromFirebase();
        });

    </script>
</body>

</html>