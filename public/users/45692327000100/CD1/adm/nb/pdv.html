<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="/assets/img/iconWeb.png">
    <title>Frente de Caixa (PDV) - Seu Sistema</title>
    <!-- Importação da Fonte (Inter) --><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Importação da biblioteca Boxicons --><link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <style>
        /* ======================================== */
        /* == ESTILOS GLOBAIS E VARIÁVEIS        == */
        /* ======================================== */
        
        :root {
            --primary-red: #db0038; 
            --primary-red-dark: #c00030;
            --bg-light: #FAFAFA;
            --card-white: #FFFFFF;
            --text-dark: #222222;
            --text-light: #777777;
            --border-color: #F0F0F0;
            --success-green: #28a745;
            --warning-red: #E53935;
            --info-blue: #1976D2; 
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            display: block;
            min-height: 100vh; /* Garante altura mínima */
            padding-bottom: 60px; /* Espaço para o rodapé do relógio */
            position: relative; /* Para posicionar o relógio */
        }

        /* ======================================== */
        /* == ANIMAÇÕES                          == */
        /* ======================================== */
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes flash {
            0% { background-color: rgba(219, 0, 56, 0.1); }
            100% { background-color: transparent; }
        }
        .new-item-flash { animation: flash 0.5s ease-out; }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .pop-animation { animation: pop 0.3s ease-out; }

        @keyframes bx-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .bx-spin { animation: bx-spin 1s linear infinite; }

        /* Animação do ponto pulsante do relógio */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ======================================== */
        /* == ESTILOS DE ATALHO / ACESSIBILIDADE == */
        /* ======================================== */
        
        .shortcut-hint {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 8px;
            padding-left: 4px;
            transition: opacity 0.2s ease;
        }

        .nav-focus {
            outline: 2px solid var(--info-blue) !important;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.3) !important;
            border-radius: 8px; 
        }
        
        .discount-nav-hint {
            display: none; 
            font-size: 0.85rem;
            color: var(--info-blue);
            font-weight: 500;
            margin-top: 8px;
            text-align: center;
        }


        /* ======================================== */
        /* == ESTILOS DE DESCONTO E PAGAMENTO    == */
        /* ======================================== */
        .summary-row-interactive {
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-radius: 8px;
            padding: 8px 0; 
            margin: -8px 0; 
        }
        .summary-row-interactive:hover { background-color: var(--bg-light); }
        
        .summary-row .value.editable {
            color: var(--primary-red);
            font-weight: 600;
            text-decoration: underline dashed 1px;
            text-underline-offset: 4px;
        }

        .discount-popover {
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease-out;
            background-color: var(--bg-light);
            padding: 0 16px;
            margin: 8px 0;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .discount-popover.active {
            max-height: 300px; 
            padding: 16px 16px;
        }
        .discount-popover label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .discount-popover-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .discount-perc-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .perc-btn {
            flex-grow: 1;
            padding: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 8px;
            border: 1px solid #ddd;
            background-color: var(--card-white);
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .perc-btn:hover {
            background-color: var(--primary-red);
            border-color: var(--primary-red);
            color: white;
        }

        .btn-remove-discount {
            background: none; border: none;
            color: var(--warning-red);
            font-size: 0.9rem; font-weight: 600;
            cursor: pointer; margin-top: 16px;
            display: flex; align-items: center; gap: 4px;
            padding: 8px; width: 100%; justify-content: center;
            border: 1px dashed transparent;
        }
        .btn-remove-discount:hover { text-decoration: underline; }
        .btn-remove-discount.nav-focus {
             border: 1px dashed var(--info-blue);
             background-color: var(--card-white);
        }

        .effective-discount-display {
            display: flex; align-items: center; gap: 6px;
            font-size: 0.85rem; color: var(--text-light); font-weight: 500;
            margin-top: 12px; min-height: 1.2em; 
        }
        .effective-discount-display i { color: var(--text-light); }

        /* ======================================== */
        /* == TOOLTIPS                           == */
        /* ======================================== */
        
        .tooltip { position: relative; display: block; }
        .tooltip .tooltip-text {
            visibility: hidden; width: max-content; max-width: 220px;
            background-color: #333; color: #fff; text-align: center;
            border-radius: 6px; padding: 8px 12px;
            position: absolute; z-index: 10; bottom: 110%; left: 50%;
            transform: translateX(-50%); opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
            font-size: 0.85rem; font-weight: 500;
        }
        .tooltip .tooltip-text::after {
            content: ""; position: absolute; top: 100%; left: 50%;
            margin-left: -5px; border-width: 5px; border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* ======================================== */
        /* == NAVBAR                             == */
        /* ======================================== */
        .navbar {
            display: flex; gap: 16px; /* Diminuído gap */
            flex-wrap: wrap; /* Permite quebra de linha */
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 24px; position: relative;
        }
        .navbar-item {
            padding: 12px 0; text-decoration: none; color: var(--text-light);
            font-weight: 600; position: relative; transition: color 0.2s ease;
            cursor: pointer; 
            white-space: nowrap; /* Evita quebra de linha no nome */
        }
        .navbar-item:hover { color: var(--text-dark); }
        .navbar-item.active { color: var(--primary-red); }
        .navbar-highlight {
            position: absolute; bottom: -1px; height: 3px;
            background-color: var(--primary-red);
            transition: left 0.3s ease, width 0.3s ease;
            border-radius: 2px;
        }

        /* ======================================== */
        /* == CONTEÚDO PRINCIPAL (PDV)           == */
        /* ======================================== */
        
        .main-content {
            width: 100%; height: 100%; 
            padding: 32px; overflow-y: auto;
        }
        
        .page-content { animation: slideInUp 0.5s ease-out; }
        .page-content h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 16px; }

        .main-content h1 { font-size: 2rem; font-weight: 700; margin-bottom: 16px; }

        .pdv-layout {
            display: grid; grid-template-columns: 2fr 1fr; gap: 24px;
            min-height: calc(100vh - 200px - 60px); 
        }

        .pdv-main { display: flex; flex-direction: column; gap: 16px; }

        .card {
            background-color: var(--card-white); border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03); padding: 24px; 
        }

        .barcode-scanner { position: relative; }
        .barcode-scanner i {
            position: absolute; left: 18px; top: 50%;
            transform: translateY(-50%); color: var(--text-light);
        }
        .barcode-scanner input {
            width: 100%; padding: 18px 18px 18px 50px; font-size: 1rem;
            border-radius: 12px; border: 1px solid #ddd; transition: all 0.2s ease;
        }
        .barcode-scanner input:disabled { background-color: #f9f9f9; cursor: wait; }
        .barcode-scanner input:focus {
            outline: none; border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(219, 0, 56, 0.2);
        }

        .item-list-container {
            flex-grow: 1; overflow-y: auto; border: 1px solid var(--border-color);
            border-radius: 16px; background-color: var(--card-white); padding: 0; 
        }
        .item-list-container.empty {
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; color: var(--text-light); min-height: 300px;
        }
        .item-list-container.empty span { font-size: 1.1rem; font-weight: 500; }

        .item-list-table { width: 100%; border-collapse: collapse; }
        .item-list-table th, .item-list-table td { padding: 16px; text-align: left; }
        .item-list-table thead { border-bottom: 1px solid var(--border-color); background-color: #fdfdfd; }
        .item-list-table th {
            font-size: 0.8rem; text-transform: uppercase;
            color: var(--text-light); font-weight: 600;
        }
        .item-list-table tbody tr { border-bottom: 1px solid var(--border-color); }
        .item-list-table tbody tr:last-child { border-bottom: none; }
        .product-info { display: flex; align-items: center; gap: 12px; }
        .product-image {
            width: 48px; height: 48px; border-radius: 8px; background-color: var(--bg-light);
            display: flex; align-items: center; justify-content: center;
            color: var(--text-light); flex-shrink: 0;
        }
        .product-details .name { font-weight: 600; color: var(--text-dark); }
        .product-details .barcode { font-size: 0.85rem; color: var(--text-light); }
        .quantity-control { display: flex; align-items: center; gap: 8px; }
        .qty-btn {
            background-color: var(--bg-light); border: 1px solid var(--border-color);
            border-radius: 50%; width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-dark); transition: all 0.2s ease;
        }
        .qty-btn:hover { background-color: #eee; }
        .qty-display { font-weight: 600; min-width: 20px; text-align: center; }
        .item-price { font-weight: 500; }
        .item-total { font-weight: 600; }
        .remove-btn {
            background: none; border: none; color: var(--text-light); cursor: pointer;
            padding: 4px; border-radius: 4px; transition: all 0.2s ease;
        }
        .remove-btn:hover { color: var(--warning-red); background-color: #FFEBEE; }

        .pdv-summary .card { padding: 24px; display: flex; flex-direction: column; height: 100%; }
        .pdv-summary h2 {
            font-size: 1.5rem; font-weight: 600; margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color); padding-bottom: 16px;
        }
        .summary-row { display: flex; justify-content: space-between; font-size: 1rem; margin-bottom: 16px; }
        .summary-row .label { color: var(--text-light); display: flex; align-items: center; gap: 8px; }
        .summary-row .value { font-weight: 500; }
        .summary-total { border-top: 1px dashed var(--border-color); padding-top: 24px; margin-top: auto; }
        .summary-total .label { font-size: 1.2rem; font-weight: 600; }
        .summary-total .value {
            font-size: 2.2rem; font-weight: 700; color: var(--primary-red);
            transition: transform 0.2s ease; 
        }
        
        .btn {
            font-family: 'Inter', sans-serif; width: 100%; padding: 16px;
            font-size: 1rem; font-weight: 600; border: none; border-radius: 12px;
            cursor: pointer; transition: all 0.2s ease; margin-top: 8px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background-color: #ccc; color: #888; cursor: not-allowed; }
        .btn-primary:disabled { background-color: #f0a0b8; color: #fff; }
        .btn-secondary:disabled { background-color: #eee; color: #aaa; border-color: #ddd; }
        .btn-primary { background-color: var(--primary-red); color: white; }
        .btn-primary:hover { background-color: var(--primary-red-dark); }
        .btn-secondary { background-color: var(--card-white); color: var(--text-dark); border: 1px solid #ddd; }
        .btn-secondary:hover { background-color: var(--bg-light); }
        .btn-danger { background-color: var(--warning-red); color: white; }
        .btn-danger:hover { background-color: #D32F2F; }
        .btn-success { background-color: var(--success-green); color: white; }
        .btn-success:hover { background-color: #1e7e34; }


        /* ======================================== */
        /* == MODAIS                             == */
        /* ======================================== */
        
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); /* Mais escuro */
            display: grid; place-items: center; opacity: 0; visibility: hidden;
            transition: all 0.3s ease; /* Transição mais suave */
            z-index: 1000;
            overflow-y: auto; /* Permite rolar modals longos */
            padding: 20px; /* Espaçamento para não colar nas bordas */
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--card-white); border-radius: 16px; padding: 0; /* Removido padding geral */
            width: 100%; max-width: 550px; /* Aumentado para o modal de cliente */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: scale(0.95) translateY(10px); /* Efeito de entrada */
            transition: all 0.3s ease;
            overflow: hidden; /* Para conter o padding interno */
        }
        .modal-overlay.active .modal-content { transform: scale(1) translateY(0); }
        .modal-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 20px 24px; /* Padding interno */
            border-bottom: 1px solid var(--border-color);
        }
        .modal-header h3 { font-size: 1.5rem; font-weight: 600; margin: 0; }
        .close-modal-btn { background: none; border: none; cursor: pointer; color: var(--text-light); padding: 4px; line-height: 1; }
        .modal-body { padding: 24px; /* Padding interno */ }
        .modal-body p { color: var(--text-light); margin-bottom: 24px; line-height: 1.6; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 8px; }
        .form-group input, .form-group textarea, .form-group select { /* Adicionado select */
            width: 100%; padding: 12px 14px; font-size: 1rem; font-family: 'Inter', sans-serif;
            border-radius: 8px; border: 1px solid #ddd; resize: vertical; 
        }
        .form-group input[type="number"]::-webkit-inner-spin-button, 
        .form-group input[type="number"]::-webkit-outer-spin-button { 
           -webkit-appearance: none; margin: 0; 
        } /* Esconde setas do number input */
        .form-group input[type="number"] { -moz-appearance: textfield; }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
             outline: none; border-color: var(--primary-red);
             box-shadow: 0 0 0 3px rgba(219, 0, 56, 0.2);
        }
        .modal-footer { 
            padding: 20px 24px; /* Padding interno */
            display: flex; gap: 12px; justify-content: flex-end; 
            border-top: 1px solid var(--border-color);
            background-color: #f9f9f9; /* Fundo levemente diferente */
        }
        
        /* Modal de Pagamento */
        .payment-options { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .payment-option {
            border: 1px solid var(--border-color); border-radius: 12px; padding: 24px 16px;
            display: flex; flex-direction: column; align-items: center; gap: 12px;
            cursor: pointer; transition: all 0.2s ease;
        }
        .payment-option:hover, .payment-option.selected, .payment-option.nav-focus { 
            border-color: var(--primary-red); background-color: rgba(219, 0, 56, 0.05);
            color: var(--primary-red);
        }
        .payment-option span { font-weight: 600; }
        /* (NOVO) Pagamento Dividido */
        .split-payment-area {
            margin-top: 24px;
            border-top: 1px dashed var(--border-color);
            padding-top: 24px;
        }
        .split-payment-area h4 { font-weight: 600; margin-bottom: 16px; }
        .split-payment-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px; align-items: end; }
        .split-payment-remaining { text-align: right; font-weight: 600; color: var(--primary-red); margin-top: 8px; }
        
        /* Modal de Recibo / Confirmação / Alerta */
        .modal-icon {
            width: 80px; height: 80px; border-radius: 50%; display: grid;
            place-items: center; margin: 0 auto 24px auto;
        }
        .modal-icon.success { background-color: rgba(40, 167, 69, 0.1); color: var(--success-green); }
        .modal-icon.danger { background-color: rgba(229, 57, 53, 0.1); color: var(--warning-red); }
        .modal-icon.info { background-color: rgba(25, 118, 210, 0.1); color: var(--info-blue); }
        .modal-body.centered { text-align: center; }

        /* Estilos específicos do Modal Adicionar Cliente */
        .add-cliente-step { display: none; } 
        .add-cliente-step.active { display: block; animation: slideInUp 0.3s ease-out; } 
        .modal-progress-bar {
            width: 100%; height: 8px; background-color: var(--border-color);
            border-radius: 4px; margin-bottom: 24px; overflow: hidden;
        }
        .progress {
            height: 100%; width: 50%; background-color: var(--primary-red);
            transition: width 0.3s ease;
        }
        .modal-footer-multi-step { justify-content: space-between; } 
        .input-error {
            border-color: var(--warning-red) !important;
            box-shadow: 0 0 0 3px rgba(229, 57, 53, 0.2) !important;
        }
        
        /* (NOVO) Estilos dos Modais de Caixa */
        .caixa-options { display: flex; flex-direction: column; gap: 16px; }
        .caixa-options .btn { margin-top: 0; } /* Remove margem superior dos botões */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }


        /* ======================================== */
        /* == PÁGINAS ADICIONAIS                 == */
        /* ======================================== */
        
        /* Tabela genérica para Produtos e Clientes */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        .data-table th, .data-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { background-color: var(--bg-light); font-size: 0.9rem; color: var(--text-light); }
        .data-table td { font-weight: 500; vertical-align: middle; }
        .data-table td:first-child { font-weight: 600; color: var(--text-dark); }
        .data-table .currency { text-align: right; } 
        .data-table .actions { text-align: center; } 
        .data-table .actions button { background: none; border: none; cursor: pointer; color: var(--text-light); padding: 4px; }
        .data-table .actions button:hover { color: var(--primary-red); }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border-color); }
        .setting-info { max-width: 70%; }
        .setting-info h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; }
        .setting-info p { font-size: 0.9rem; color: var(--text-light); line-height: 1.5; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 28px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary-red); }
        input:focus + .slider { box-shadow: 0 0 1px var(--primary-red); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* ======================================== */
        /* == ESTILOS DO RELÓGIO                 == */
        /* ======================================== */
        .pn {
            position: fixed; /* Fixa no rodapé */
            bottom: 0; left: 0; width: 100%;
            background-color: var(--card-white); border-top: 1px solid var(--border-color);
            padding: 10px 20px; display: flex; justify-content: flex-end; /* Alinha à direita */
            align-items: center; z-index: 500; /* Garante que fique acima de outros conteúdos */
        }
        .pn-hr { display: flex; align-items: center; gap: 10px; }
        .loading1 { /* O ponto pulsante */
            width: 10px; height: 10px; border-radius: 50%;
            background-color: var(--success-green); /* Verde para indicar "online" */
            animation: pulse 1.5s infinite ease-in-out;
        }
        .horario { font-weight: 600; color: var(--text-dark); font-size: 1rem; }

        /* ======================================== */
        /* == RESPONSIVIDADE                     == */
        /* ======================================== */
        
        @media (max-width: 1024px) {
            .pdv-layout { grid-template-columns: 1fr; height: auto; }
            .pdv-summary .card { height: auto; }
            .main-content { padding: 24px; }
            body { padding-bottom: 50px; } /* Ajuste no padding para relógio menor */
            .pn { padding: 8px 16px; }
            .horario { font-size: 0.9rem; }
            .modal-content { max-width: 90%; } /* Ajuste modal */
        }
        
        @media (max-width: 768px) {
            body { display: block; padding-bottom: 40px; } /* Ajuste menor ainda */
            .sidebar { display: none; }
            .main-content { padding: 16px; height: auto; min-height: 100vh; width: 100%; }
            .main-content h1 { font-size: 1.5rem; margin-bottom: 16px; }
            .pdv-layout { min-height: auto; gap: 16px; }
            .modal-content { max-width: 95%; padding: 0; } /* Ajuste modal mobile */
            .modal-header, .modal-body, .modal-footer { padding: 16px; } /* Padding interno modal mobile */
            .payment-options { grid-template-columns: 1fr; }
            .navbar { gap: 16px; margin-bottom: 16px; overflow-x: auto; /* Permite rolar a navbar se não couber */ }
            .navbar-item { font-size: 0.9rem; white-space: nowrap; /* Impede quebra de linha */ }
            .pn { justify-content: center; } /* Centraliza relógio no mobile */
            .page-header { flex-direction: column; align-items: flex-start; gap: 10px; } /* Ajusta cabeçalho da página */
            .page-header .btn { width: 100%; } /* Botão Adicionar Cliente ocupa largura total */
            .data-table { font-size: 0.9rem; } /* Diminui fonte da tabela */
            .data-table th, .data-table td { padding: 8px 10px; } /* Diminui padding da tabela */
            .form-grid { grid-template-columns: 1fr; } /* Empilha campos no mobile */
            .split-payment-row { grid-template-columns: 1fr; gap: 10px; } /* Empilha pagamento dividido */
        }

    </style>
</head>
<body>

    <main class="main-content">
        <h1>Frente de Caixa (PDV)</h1>

        <!-- Navbar Estilizada --><nav class="navbar" id="main-navbar">
            <span class="navbar-item active" data-page="pdv">PDV</span> <!-- Volta a ser ativo por padrão -->
            <span class="navbar-item" data-page="produtos">Produtos</span>
            <span class="navbar-item" data-page="clientes">Clientes</span> 
             <!-- (NOVO) Item Caixa -->
            <span class="navbar-item" data-page="caixa">Caixa</span> 
            <span class="navbar-item" data-page="configuracoes">Configurações</span>
            <div class="navbar-highlight" id="navbar-highlight"></div>
        </nav>

        <!-- PÁGINA 1: PDV --><div id="pdv-page" class="page-content"> <!-- Começa ativo -->
            <div class="pdv-layout">
                <!-- Coluna da Esquerda: Itens --><div class="pdv-main">
                    <div class="tooltip">
                        <div class="barcode-scanner">
                            <i class='bx bx-barcode-reader'></i> 
                            <input type="text" id="barcode-input" placeholder="Carregando produtos..." disabled>
                        </div>
                        <span class="tooltip-text">Digite o código ou nome para adicionar</span> 
                    </div>
                    <p class="shortcut-hint" id="barcode-hint">Carregando produtos...</p>
                    
                    <div class="item-list-container" id="item-list-container">
                        <div class="empty-state" id="empty-state">
                            <span>Nenhum item na venda</span>
                        </div>
                        <table class="item-list-table" id="item-list-table" style="display: none;">
                            <thead> <tr> <th>Produto</th> <th>Qtd.</th> <th>Preço Unit.</th> <th>Total</th> <th></th> </tr> </thead>
                            <tbody id="cart-items-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Coluna da Direita: Resumo --><aside class="pdv-summary">
                    <div class="card">
                        <h2>Resumo da Venda</h2>
                        <div class="summary-row"> <span class="label">Subtotal (<span id="item-count">0</span> itens)</span> <span class="value" id="summary-subtotal">R$ 0,00</span> </div>
                        <div class="summary-row summary-row-interactive" id="discount-toggle-row" title="Adicionar desconto"> <span class="label"> <i class='bx bx-purchase-tag' ></i> Descontos (F3) </span> <span class="value editable" id="summary-discount">- R$ 0,00</span> </div>
                        <div class="discount-popover" id="discount-popover"> <div class="form-group"> <label for="discount-input-r">Valor do Desconto (R$)</label> <input type="number" id="discount-input-r" placeholder="0,00" step="0.01"> </div> <span class="discount-popover-label">Desconto Rápido (%)</span> <div class="discount-perc-buttons" id="perc-btn-container"> <button class="perc-btn" data-perc="1">1%</button> <button class="perc-btn" data-perc="3">3%</button> <button class="perc-btn" data-perc="5">5%</button> <button class="perc-btn" data-perc="8">8%</button> </div> <div class="effective-discount-display" id="effective-discount-display"> <i class='bx bx-badge-percent'></i><span id="discount-percentage-text"></span> </div> <button class="btn-remove-discount" id="remove-discount-btn"> <i class='bx bx-x' ></i> Remover Desconto </button> <span class="discount-nav-hint" id="remove-discount-hint">Pressione 'Enter' para remover</span> </div>
                        <div class="summary-row summary-row-interactive" id="payment-toggle-row" title="Selecionar forma de pagamento"> <span class="label"> <i class='bx bx-credit-card' ></i> Pagamento (F4) </span> <span class="value editable" id="summary-payment-method">Não selecionado</span> </div>
                        <div class="summary-total"> <div class="summary-row"> <span class="label">Total</span> <span class="value" id="summary-total">R$ 0,00</span> </div> </div>
                        <div class="tooltip"> <button class="btn btn-primary" id="finish-sale-btn"> <i class='bx bx-check-circle'></i> Finalizar Venda (F9) </button> <span class="tooltip-text">Registra a venda e abre opções de recibo</span> </div> 
                        <div class="tooltip"> <button class="btn btn-secondary" id="cancel-sale-btn"> <i class='bx bx-x-circle'></i> Cancelar Venda (F10) </button> <span class="tooltip-text">Limpa todos os itens da venda atual</span> </div>
                    </div>
                </aside>
            </div>
        </div>
        
        <!-- PÁGINA 2: PRODUTOS --><div id="produtos-page" class="page-content" style="display: none;">
            <div class="card" style="max-width: 800px; margin: 0 auto;">
                 <div class="page-header">
                     <h2>Produtos Cadastrados</h2>
                 </div>
                <p style="color: var(--text-light); margin-top: -16px; margin-bottom: 16px;"> Novos produtos adicionados pelo "Cadastro Rápido" do PDV aparecerão aqui. </p>
                <div id="produtos-table-container"></div>
            </div>
        </div>

        <!-- PÁGINA 3: CLIENTES --><div id="clientes-page" class="page-content" style="display: none;"> <!-- Começa escondido -->
            <div class="card">
                 <div class="page-header">
                    <h2>Clientes (Crediário)</h2>
                    <button class="btn btn-primary" id="add-cliente-btn" style="width: auto; padding: 10px 16px;">
                        <i class='bx bx-user-plus'></i> Adicionar Cliente +
                    </button>
                 </div>
                <p style="color: var(--text-light); margin-top: -16px; margin-bottom: 16px;"> Gerencie os clientes com pagamentos pendentes. </p>
                <div id="clientes-list-container">
                    <p style="text-align: center; color: var(--text-light); padding: 20px 0;">
                        <i class='bx bx-loader-alt bx-spin'></i> Carregando clientes...
                    </p>
                </div>
            </div>
        </div>

         <!-- (NOVO) PÁGINA 5: CAIXA --><div id="caixa-page" class="page-content" style="display: none;">
             <div class="card" style="max-width: 600px; margin: 0 auto;">
                 <div class="page-header">
                    <h2>Gerenciamento de Caixa</h2>
                 </div>
                 <p style="color: var(--text-light); margin-top: -16px; margin-bottom: 24px;"> Registre a abertura e o fechamento do seu caixa diário. </p>
                
                 <div class="caixa-options">
                    <button class="btn btn-success" id="open-caixa-modal-btn">
                         <i class='bx bx-play-circle'></i> Abrir Caixa
                    </button>
                    <button class="btn btn-danger" id="close-caixa-modal-btn">
                         <i class='bx bx-stop-circle'></i> Fechar Caixa
                    </button>
                 </div>
             </div>
        </div>
        
        <!-- PÁGINA 6: CONFIGURAÇÕES --><div id="configuracoes-page" class="page-content" style="display: none;">
            <div class="card" style="max-width: 800px; margin: 0 auto;">
                 <div class="page-header">
                    <h2>Configurações</h2>
                 </div>
                <div class="setting-row"> <div class="setting-info"> <h3>Arredondamento Inteligente de Troco</h3> <p> Quando ativado, os descontos por porcentagem arredondam o valor total da compra para o R$ 0,50 mais próximo, facilitando o troco. </p> </div> <label class="toggle-switch"> <input type="checkbox" id="smart-rounding-toggle" checked> <span class="slider"></span> </label> </div>
                <div class="setting-row"> 
                    <div class="setting-info"> 
                        <h3>Cache de Produtos</h3> 
                        <!-- (MODIFICADO) Texto atualizado -->
                        <p> Recarrega a lista de produtos do banco de dados. Útil se você fez alterações externas. </p> 
                    </div> 
                    <button class="btn btn-secondary" id="reload-cache-btn" style="width: auto; padding: 10px 16px;"> <i class='bx bx-sync'></i> Recarregar </button> 
                </div>
            </div>
        </div>
    </main>

    <!-- MODAIS -->
    <!-- Modal 1: Cadastro Rápido --><div class="modal-overlay" id="quick-add-modal"> <div class="modal-content"> <div class="modal-header"> <h3>Produto não encontrado</h3> <button class="close-modal-btn" data-target="quick-add-modal"><i class='bx bx-x'></i></button> </div> <div class="modal-body"> <p>O código <strong id="scanned-barcode"></strong> não está cadastrado. Adicione um item rápido para esta venda.</p> <form id="quick-add-form"> <div class="form-group"> <label for="quick-product-name">Nome do Produto</label> <input type="text" id="quick-product-name" required data-primary-focus="true"> </div> <div class="form-group"> <label for="quick-product-price">Preço (R$)</label> <input type="number" id="quick-product-price" step="0.01" min="0.01" placeholder="0,00" required> </div> </form> </div> <div class="modal-footer"> <button class="btn btn-secondary close-modal-btn" data-target="quick-add-modal">Cancelar</button> <button class="btn btn-primary" id="quick-add-submit-btn">Adicionar à Venda</button> </div> </div> </div>
    
    <!-- (MODIFICADO) Modal 2: Seleção de Pagamento (Com Split) -->
    <div class="modal-overlay" id="payment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Forma de Pagamento</h3>
                <button class="close-modal-btn" data-target="payment-modal"><i class='bx bx-x'></i></button>
            </div>
            <div class="modal-body">
                <p>Valor total: <strong id="payment-total">R$ 0,00</strong>. Como o cliente irá pagar?</p>
                
                <!-- Opções Únicas -->
                <div class="payment-options" id="single-payment-options">
                     <div class="payment-option" data-method="Dinheiro" data-primary-focus="true"> <i class='bx bx-dollar-circle' style="font-size: 32px;"></i> <span>Dinheiro (F6)</span> </div> 
                     <div class="payment-option" data-method="PIX"> <i class='bx bx-scan' style="font-size: 32px;"></i> <span>PIX (F7)</span> </div> 
                     <div class="payment-option" data-method="Cartão"> <i class='bx bx-credit-card' style="font-size: 32px;"></i> <span>Cartão (F8)</span> </div>
                </div>

                <!-- Botão para Dividir -->
                 <button class="btn btn-secondary" id="split-payment-toggle-btn" style="margin-top: 20px;">
                    <i class='bx bx-columns'></i> Dividir Pagamento
                 </button>

                 <!-- Área de Pagamento Dividido (Oculta por padrão) -->
                 <div class="split-payment-area" id="split-payment-area" style="display: none;">
                    <h4>Dividir Pagamento</h4>
                    <div class="split-payment-row">
                        <div class="form-group">
                            <label for="split-method-1">Forma 1</label>
                            <select id="split-method-1">
                                <option value="" disabled selected>Selecione...</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="PIX">PIX</option>
                                <option value="Cartão">Cartão</option>
                            </select>
                        </div>
                        <div class="form-group">
                             <label for="split-value-1">Valor 1 (R$)</label>
                             <input type="number" id="split-value-1" step="0.01" min="0.01" placeholder="0,00">
                        </div>
                    </div>
                     <div class="split-payment-row">
                        <div class="form-group">
                            <label for="split-method-2">Forma 2</label>
                            <select id="split-method-2">
                                <option value="" disabled selected>Selecione...</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="PIX">PIX</option>
                                <option value="Cartão">Cartão</option>
                            </select>
                        </div>
                        <div class="form-group">
                             <label for="split-value-2">Valor 2 (R$)</label>
                             <input type="number" id="split-value-2" step="0.01" min="0.01" placeholder="0,00">
                        </div>
                    </div>
                    <div class="split-payment-remaining" id="split-payment-remaining">
                        Restante: R$ 0,00
                    </div>
                    <button class="btn btn-primary" id="confirm-split-payment-btn" style="margin-top: 16px;" disabled>
                        Confirmar Divisão
                    </button>
                 </div>

            </div>
        </div>
    </div>

    <!-- Modal 3: Recibo --><div class="modal-overlay" id="receipt-modal"> <div class="modal-content"> <div class="modal-body centered"> <div class="modal-icon success"><i class='bx bx-check' style="font-size: 40px;"></i></div> <h3 style="font-size: 1.5rem; margin-bottom: 8px;">Venda Finalizada!</h3> <p>Venda no valor de <strong id="receipt-total">R$ 0,00</strong> registrada com sucesso.</p> <div class="modal-footer" style="flex-direction: column;"> <button class="btn btn-primary" id="print-receipt-btn"> <i class='bx bx-printer'></i> Imprimir Recibo (Não Fiscal) </button> <button class="btn btn-secondary" id="new-sale-btn" data-primary-focus="true"> <i class='bx bx-rotate-left'></i> Nova Venda </button> </div> </div> </div> </div>
    <!-- Modal 4: Confirmação --><div class="modal-overlay" id="confirm-modal"> <div class="modal-content"> <div class="modal-body centered"> <div class="modal-icon danger"><i class='bx bx-error-alt' style="font-size: 40px;"></i></div> <h3 style="font-size: 1.5rem; margin-bottom: 8px;" id="confirm-title">Tem certeza?</h3> <p id="confirm-message">Esta ação não pode ser desfeita.</p> <div class="modal-footer" style="justify-content: center;"> <button class="btn btn-secondary close-modal-btn" data-target="confirm-modal">Cancelar</button> <button class="btn btn-danger" id="confirm-action-btn" data-primary-focus="true">Confirmar</button> </div> </div> </div> </div>
    <!-- Modal 5: Alerta --><div class="modal-overlay" id="alert-modal"> <div class="modal-content"> <div class="modal-body centered"> <div class="modal-icon info"><i class='bx bx-info-circle' style="font-size: 40px;"></i></div> <h3 style="font-size: 1.5rem; margin-bottom: 8px;" id="alert-title">Atenção</h3> <p id="alert-message">Ocorreu um erro.</p> <div class="modal-footer" style="justify-content: center;"> <button class="btn btn-primary close-modal-btn" data-target="alert-modal" data-primary-focus="true">Entendi</button> </div> </div> </div> </div>
    <!-- Modal 6: Adicionar Cliente (Multi-Step) --><div class="modal-overlay" id="add-cliente-modal"> <div class="modal-content"> <div class="modal-header"> <h3>Adicionar Novo Cliente</h3> <button class="close-modal-btn" data-target="add-cliente-modal"><i class='bx bx-x'></i></button> </div> <div class="modal-body"> <div class="modal-progress-bar"> <div class="progress" id="add-cliente-progress"></div> </div> <form id="add-cliente-form"> <div id="cliente-step-1" class="add-cliente-step active"> <h4>Parte 1: Dados Pessoais</h4> <br> <div class="form-group"> <label for="cliente-apelido">Apelido *</label> <input type="text" id="cliente-apelido" required data-primary-focus="true"> <small class="shortcut-hint">Identificação rápida.</small> </div> <div class="form-group"> <label for="cliente-nome">Nome Completo</label> <input type="text" id="cliente-nome"> </div> <div class="form-group"> <label for="cliente-telefone">Telefone</label> <input type="tel" id="cliente-telefone" placeholder="(XX) XXXXX-XXXX"> </div> <div class="form-group"> <label for="cliente-endereco">Endereço</label> <textarea id="cliente-endereco" rows="2"></textarea> </div> </div> <div id="cliente-step-2" class="add-cliente-step"> <h4>Parte 2: Compra Inicial</h4> <br> <div class="form-group"> <label for="compra-valor">Valor (R$) *</label> <input type="number" id="compra-valor" step="0.01" min="0.01" placeholder="0,00" required> </div> <div class="form-group"> <label for="compra-parcelas">Nº Parcelas *</label> <input type="number" id="compra-parcelas" min="1" step="1" placeholder="1" required> </div> <div class="form-group"> <label for="compra-vencimento">1º Vencimento *</label> <input type="date" id="compra-vencimento" required> </div> </div> </form> </div> <div class="modal-footer modal-footer-multi-step"> <button class="btn btn-secondary" id="cliente-prev-btn" style="display: none;"> <i class='bx bx-chevron-left'></i> Anterior </button> <button class="btn btn-primary" id="cliente-next-btn"> Próximo <i class='bx bx-chevron-right'></i> </button> <button class="btn btn-success" id="cliente-save-btn" style="display: none;"> <i class='bx bx-save'></i> Salvar Cliente </button> </div> </div> </div>

    <!-- (NOVO) Modal 7: Gerenciamento de Caixa (Escolha) -->
     <div class="modal-overlay" id="manage-caixa-modal">
        <div class="modal-content" style="max-width: 400px;"> <!-- Menor -->
            <div class="modal-header">
                <h3>Gerenciar Caixa</h3>
                <button class="close-modal-btn" data-target="manage-caixa-modal"><i class='bx bx-x'></i></button>
            </div>
            <div class="modal-body caixa-options">
                <button class="btn btn-success" id="open-caixa-form-btn">
                     <i class='bx bx-play-circle'></i> Abrir Caixa
                </button>
                <button class="btn btn-danger" id="close-caixa-form-btn">
                     <i class='bx bx-stop-circle'></i> Fechar Caixa
                </button>
             </div>
        </div>
    </div>
    
    <!-- (NOVO) Modal 8: Abrir Caixa (Formulário) -->
    <div class="modal-overlay" id="open-caixa-modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>Abrir Caixa</h3>
                <button class="close-modal-btn" data-target="open-caixa-modal"><i class='bx bx-x'></i></button>
            </div>
            <form id="open-caixa-form">
                <div class="modal-body">
                    <p>Informe o valor inicial disponível para troco.</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="open-caixa-notas">Valor em Notas (R$) *</label>
                            <input type="number" id="open-caixa-notas" step="0.01" min="0" placeholder="0,00" required data-primary-focus="true">
                        </div>
                        <div class="form-group">
                            <label for="open-caixa-moedas">Valor em Moedas (R$) *</label>
                            <input type="number" id="open-caixa-moedas" step="0.01" min="0" placeholder="0,00" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal-btn" data-target="open-caixa-modal">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="open-caixa-save-btn">
                        <i class='bx bx-check'></i> Confirmar Abertura
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- (NOVO) Modal 9: Fechar Caixa (Formulário) -->
    <div class="modal-overlay" id="close-caixa-modal">
        <div class="modal-content" style="max-width: 550px;"> <!-- Um pouco maior -->
             <div class="modal-header">
                <h3>Fechar Caixa</h3>
                <button class="close-modal-btn" data-target="close-caixa-modal"><i class='bx bx-x'></i></button>
            </div>
            <form id="close-caixa-form">
                <div class="modal-body">
                    <p>Informe os valores apurados no fechamento do caixa.</p>
                    <h4>Valores Contados</h4>
                     <div class="form-grid">
                        <div class="form-group">
                            <label for="close-caixa-notas">Valor Final em Notas (R$) *</label>
                            <input type="number" id="close-caixa-notas" step="0.01" min="0" placeholder="0,00" required data-primary-focus="true">
                        </div>
                        <div class="form-group">
                            <label for="close-caixa-moedas">Valor Final em Moedas (R$) *</label>
                            <input type="number" id="close-caixa-moedas" step="0.01" min="0" placeholder="0,00" required>
                        </div>
                    </div>
                    <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                    <h4>Outras Entradas</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="close-caixa-cartao">Venda Maquininha Cartão (R$) *</label>
                            <input type="number" id="close-caixa-cartao" step="0.01" min="0" placeholder="0,00" required>
                        </div>
                         <div class="form-group">
                            <label for="close-caixa-pix">Venda Pix Fixo QR Code (R$) </label>
                            <input type="number" id="close-caixa-pix" step="0.01" min="0" placeholder="0,00">
                             <small class="shortcut-hint">Opcional.</small>
                        </div>
                    </div>
                     <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                     <h4>Destino do Dinheiro Contado</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="close-caixa-deposito">Valor para Depósito (R$) *</label>
                            <input type="number" id="close-caixa-deposito" step="0.01" min="0" placeholder="0,00" required>
                        </div>
                        <div class="form-group">
                            <label for="close-caixa-fica">Valor que Fica no Caixa (R$) *</label>
                            <input type="number" id="close-caixa-fica" step="0.01" min="0" placeholder="0,00" required>
                        </div>
                    </div>
                     <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                      <div class="form-group">
                         <label for="close-caixa-assinatura">Assinatura (Nome do Responsável) *</label>
                         <input type="text" id="close-caixa-assinatura" required>
                    </div>
                </div>
                 <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal-btn" data-target="close-caixa-modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger" id="close-caixa-save-btn">
                        <i class='bx bx-lock-alt'></i> Confirmar Fechamento
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Relógio no rodapé -->
    <div class="pn"> <div class="pn-hr"> <div class="loading1"></div> <p class="horario" id="horario">00:00:00</p> </div> </div>


    <!-- SCRIPT --><script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- URLs DAS APIs (Google Apps Script) ---
            // Certifique-se de que esta é a URL correta após publicar o script 'apps-script-backend-caixa.gs'
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzvd0BBLEEQlu-ksnIbsmnYcjQNQuZcTrsCmXMKHGM5g7DPEk3Nj95X47LKbj7rRSAT/exec"; 
            // Certifique-se de que esta é a URL correta do script que recebe dados do seu formulário antigo
            const REGISTRO_VENDA_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCCaxdYdC6J_QKsaoWTDquH915MHUnM9BykD39ZUujR2LB3lx9d9n5vAsHdJZJByaa7w/exec"; 

            // --- Estado da Aplicação ---
            let localProductCache = null; 
            let localClientCache = null; 
            let cart = []; 
            let lastScannedBarcode = null;
            let confirmCallback = null; 
            let discount = 0; 
            let selectedPaymentMethod = null; 
            let elementToRestoreFocus = null; 
            let isSmartRoundingEnabled = true; 
            let lastSaleData = null; 
            let barcodeScanTimeout = null; 
            let currentClienteStep = 1; 
            let currentSplitPayments = { 
                method1: null, value1: 0,
                method2: null, value2: 0,
                remaining: 0, totalSaleValue: 0
            };

            // --- Seletores do DOM ---
            const barcodeInput = document.getElementById('barcode-input');
            const barcodeHint = document.getElementById('barcode-hint'); 
            const cartItemsBody = document.getElementById('cart-items-body');
            const itemListContainer = document.getElementById('item-list-container');
            const emptyState = document.getElementById('empty-state');
            const itemListTable = document.getElementById('item-list-table');
            const summarySubtotal = document.getElementById('summary-subtotal');
            const summaryTotal = document.getElementById('summary-total');
            const itemCount = document.getElementById('item-count');
            const summaryDiscount = document.getElementById('summary-discount');
            const discountToggleRow = document.getElementById('discount-toggle-row'); // Corrigido aqui
            const discountPopover = document.getElementById('discount-popover');
            const discountInputR = document.getElementById('discount-input-r');
            const percBtnContainer = document.getElementById('perc-btn-container');
            const removeDiscountBtn = document.getElementById('remove-discount-btn');
            const effectiveDiscountDisplay = document.getElementById('effective-discount-display'); 
            const discountPercentageText = document.getElementById('discount-percentage-text'); 
            const paymentToggleRow = document.getElementById('payment-toggle-row');
            const summaryPaymentMethod = document.getElementById('summary-payment-method');
            const finishSaleBtn = document.getElementById('finish-sale-btn');
            const cancelSaleBtn = document.getElementById('cancel-sale-btn');
            const quickAddModal = document.getElementById('quick-add-modal');
            const paymentModal = document.getElementById('payment-modal');
            const paymentTotalEl = document.getElementById('payment-total');
            const singlePaymentOptions = document.getElementById('single-payment-options'); 
            const paymentOptions = paymentModal.querySelectorAll('.payment-option'); 
            const splitPaymentToggleBtn = document.getElementById('split-payment-toggle-btn'); 
            const splitPaymentArea = document.getElementById('split-payment-area'); 
            const splitMethod1 = document.getElementById('split-method-1'); 
            const splitValue1 = document.getElementById('split-value-1'); 
            const splitMethod2 = document.getElementById('split-method-2'); 
            const splitValue2 = document.getElementById('split-value-2'); 
            const splitPaymentRemaining = document.getElementById('split-payment-remaining'); 
            const confirmSplitPaymentBtn = document.getElementById('confirm-split-payment-btn'); 
            const receiptModal = document.getElementById('receipt-modal');
            const receiptTotalEl = document.getElementById('receipt-total');
            const newSaleBtn = document.getElementById('new-sale-btn'); 
            const printReceiptBtn = document.getElementById('print-receipt-btn'); 
            const confirmModal = document.getElementById('confirm-modal');
            const alertModal = document.getElementById('alert-modal');
            const scannedBarcodeEl = document.getElementById('scanned-barcode');
            const quickAddForm = document.getElementById('quick-add-form');
            const quickAddName = document.getElementById('quick-product-name');
            const quickAddPrice = document.getElementById('quick-product-price');
            const quickAddSubmitBtn = document.getElementById('quick-add-submit-btn');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            const mainNavbar = document.getElementById('main-navbar');
            const navbarItems = document.querySelectorAll('.navbar-item');
            const navbarHighlight = document.getElementById('navbar-highlight');
            const allPages = document.querySelectorAll('.page-content');
            const produtosTableContainer = document.getElementById('produtos-table-container');
            const clientesListContainer = document.getElementById('clientes-list-container'); 
            const smartRoundingToggle = document.getElementById('smart-rounding-toggle');
            const reloadCacheBtn = document.getElementById('reload-cache-btn'); 
            const discountNavElements = [ discountInputR, ...document.querySelectorAll('.perc-btn'), removeDiscountBtn ];
            let discountNavIndex = 0;
            const removeDiscountHint = document.getElementById('remove-discount-hint');
            const horarioElement = document.getElementById('horario'); 
            const addClienteBtn = document.getElementById('add-cliente-btn'); 
            const addClienteModal = document.getElementById('add-cliente-modal'); 
            const addClienteForm = document.getElementById('add-cliente-form'); 
            const clienteStep1 = document.getElementById('cliente-step-1');
            const clienteStep2 = document.getElementById('cliente-step-2');
            const addClienteProgress = document.getElementById('add-cliente-progress');
            const clientePrevBtn = document.getElementById('cliente-prev-btn');
            const clienteNextBtn = document.getElementById('cliente-next-btn');
            const clienteSaveBtn = document.getElementById('cliente-save-btn');
            const clienteApelidoInput = document.getElementById('cliente-apelido');
            const clienteNomeInput = document.getElementById('cliente-nome');
            const clienteTelefoneInput = document.getElementById('cliente-telefone');
            const clienteEnderecoInput = document.getElementById('cliente-endereco');
            const compraValorInput = document.getElementById('compra-valor');
            const compraParcelasInput = document.getElementById('compra-parcelas');
            const compraVencimentoInput = document.getElementById('compra-vencimento');
            const manageCaixaModal = document.getElementById('manage-caixa-modal');
            const openCaixaModalBtn = document.getElementById('open-caixa-modal-btn');
            const closeCaixaModalBtn = document.getElementById('close-caixa-modal-btn');
            const openCaixaModal = document.getElementById('open-caixa-modal');
            const openCaixaForm = document.getElementById('open-caixa-form');
            const openCaixaNotasInput = document.getElementById('open-caixa-notas');
            const openCaixaMoedasInput = document.getElementById('open-caixa-moedas');
            const openCaixaSaveBtn = document.getElementById('open-caixa-save-btn');
            const closeCaixaModal = document.getElementById('close-caixa-modal');
            const closeCaixaForm = document.getElementById('close-caixa-form');
            const closeCaixaNotasInput = document.getElementById('close-caixa-notas');
            const closeCaixaMoedasInput = document.getElementById('close-caixa-moedas');
            const closeCaixaCartaoInput = document.getElementById('close-caixa-cartao');
            const closeCaixaPixInput = document.getElementById('close-caixa-pix');
            const closeCaixaDepositoInput = document.getElementById('close-caixa-deposito');
            const closeCaixaFicaInput = document.getElementById('close-caixa-fica');
            const closeCaixaAssinaturaInput = document.getElementById('close-caixa-assinatura');
            const closeCaixaSaveBtn = document.getElementById('close-caixa-save-btn');


            // --- Funções de Formatação ---
            const formatCurrency = (value) => { const numericValue = Number(value); if (isNaN(numericValue)) return 'R$ 0,00'; return numericValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); };
            const formatTimestamp = (date) => { const pad = (n) => n < 10 ? '0' + n : n; const d = date.getDate(), mo = date.getMonth() + 1, y = date.getFullYear(); const h = date.getHours(), mi = date.getMinutes(), s = date.getSeconds(); return `${pad(d)}/${pad(mo)}/${y} ${pad(h)}:${pad(mi)}:${pad(s)}`; };
            const formatTime = (date) => { const pad = (n) => n < 10 ? '0' + n : n; const h = date.getHours(), mi = date.getMinutes(), s = date.getSeconds(); return `${pad(h)}:${pad(mi)}:${pad(s)}`; };

            // --- Funções de Renderização ---
            const renderCart = () => { /* ... (sem alterações) ... */ cartItemsBody.innerHTML = ''; if (cart.length === 0) { emptyState.style.display = 'flex'; itemListTable.style.display = 'none'; itemListContainer.classList.add('empty'); } else { emptyState.style.display = 'none'; itemListTable.style.display = 'table'; itemListContainer.classList.remove('empty'); cart.forEach(item => { const tr = document.createElement('tr'); tr.dataset.id = item.id; if (item.isNew) { tr.classList.add('new-item-flash'); delete item.isNew; setTimeout(() => { tr.classList.remove('new-item-flash'); }, 500); } tr.innerHTML = `<td><div class="product-info"><div class="product-image"><i class='bx bx-package'></i></div><div class="product-details"><span class="name">${item.name}</span><span class="barcode">#${item.id}</span></div></div></td><td><div class="quantity-control"><button class="qty-btn" data-action="decrease" data-id="${item.id}"><i class='bx bx-minus'></i></button><span class="qty-display">${item.quantity}</span><button class="qty-btn" data-action="increase" data-id="${item.id}"><i class='bx bx-plus'></i></button></div></td><td class="item-price">${formatCurrency(item.price)}</td> <td class="item-total">${formatCurrency(item.price * item.quantity)}</td><td><button class="remove-btn" data-id="${item.id}" title="Remover item"><i class='bx bx-trash'></i></button></td>`; cartItemsBody.appendChild(tr); }); } updateSummary(); };
            const updateSummary = () => { /* ... (sem alterações) ... */ const subtotal = getSubtotal(); const totalItems = cart.reduce((acc, item) => acc + item.quantity, 0); const total = subtotal - discount; summarySubtotal.textContent = formatCurrency(subtotal); summaryDiscount.textContent = formatCurrency(discount > 0 ? discount * -1 : 0); if (discount > 0 && subtotal > 0) { const percentage = (discount / subtotal) * 100; discountPercentageText.textContent = `(${percentage.toFixed(2)}% efetivo)`; effectiveDiscountDisplay.style.display = 'flex'; } else { discountPercentageText.textContent = ''; effectiveDiscountDisplay.style.display = 'none'; } summaryTotal.textContent = formatCurrency(total); itemCount.textContent = totalItems; paymentTotalEl.textContent = formatCurrency(total); receiptTotalEl.textContent = formatCurrency(total); if (totalItems > 0 || cart.length > 0) { summaryTotal.classList.add('pop-animation'); setTimeout(() => { summaryTotal.classList.remove('pop-animation'); }, 300); } lastSaleData = { subtotal: subtotal, discount: discount, total: total, paymentMethod: selectedPaymentMethod }; }; // Atualiza lastSaleData aqui
            const renderProdutosPage = () => { /* ... (sem alterações, usa cache) ... */ produtosTableContainer.innerHTML = ''; if (!localProductCache) { produtosTableContainer.innerHTML = '<p style="text-align: center; color: var(--text-light);"><i class="bx bx-loader-alt bx-spin"></i> Carregando...</p>'; if (localProductCache === null) carregarCacheDeProdutos(); return; } if (localProductCache.length === 0) { produtosTableContainer.innerHTML = '<p style="text-align: center; color: var(--text-light);">Nenhum produto.</p>'; return; } const table = document.createElement('table'); table.className = 'data-table products-table'; table.innerHTML = `<thead><tr><th>Nome</th><th>Código</th><th>Preço</th></tr></thead><tbody></tbody>`; const tbody = table.querySelector('tbody'); localProductCache.forEach(product => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${product.name}</td><td>${product.id}</td><td class="currency">${formatCurrency(product.price)}</td>`; tbody.appendChild(tr); }); produtosTableContainer.appendChild(table); };
            const renderClientesPage = () => { /* ... (sem alterações, usa cache) ... */ clientesListContainer.innerHTML = ''; if (localClientCache === null) { clientesListContainer.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px 0;"><i class="bx bx-loader-alt bx-spin"></i> Carregando...</p>'; return; } if (localClientCache.length === 0) { clientesListContainer.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px 0;">Nenhum cliente.</p>'; return; } const table = document.createElement('table'); table.className = 'data-table clients-table'; table.innerHTML = `<thead><tr><th>Nome / Apelido</th><th>Saldo Devedor</th><th>Próximo Venc.</th><th>Ações</th></tr></thead><tbody></tbody>`; const tbody = table.querySelector('tbody'); localClientCache.forEach(cliente => { const tr = document.createElement('tr'); tr.dataset.clientId = cliente.idCliente; tr.innerHTML = `<td>${cliente.nomeExibicao} ${cliente.apelido && cliente.nomeExibicao !== cliente.apelido ? '(' + cliente.apelido + ')' : ''}</td><td class="currency">${formatCurrency(cliente.saldoDevedor)}</td><td>${cliente.proximoVencimento}</td><td class="actions"><button title="Detalhes/Pagar"><i class='bx bx-show'></i></button> <button title="Add Compra"><i class='bx bx-cart-add'></i></button></td>`; tbody.appendChild(tr); }); clientesListContainer.appendChild(table); };

            // --- Funções de Lógica do Carrinho ---
            const addToCart = (product) => { const existingItem = cart.find(item => item.id === product.id); if (existingItem) { existingItem.quantity += 1; } else { cart.push({ ...product, quantity: 1, isNew: true }); } renderCart(); };
            const updateQuantity = (id, action) => { const item = cart.find(item => item.id === id); if (!item) return; if (action === 'increase') { item.quantity += 1; } else if (action === 'decrease') { item.quantity -= 1; if (item.quantity === 0) { removeFromCart(id); return; } } renderCart(); };
            const removeFromCart = (id) => { cart = cart.filter(item => item.id !== id); renderCart(); };
            const clearCart = () => { cart = []; removeDiscount(); resetPaymentMethod(); lastSaleData = null; renderCart(); };
 
            // Funções de Modal com Acessibilidade
            const openModal = (modalEl) => { elementToRestoreFocus = document.activeElement; modalEl.classList.add('active'); const primaryFocus = modalEl.querySelector('[data-primary-focus="true"]'); if (primaryFocus) { setTimeout(() => primaryFocus.focus(), 100); } };
            const closeModal = (modalEl) => { modalEl.classList.remove('active'); if (elementToRestoreFocus) { elementToRestoreFocus.focus(); elementToRestoreFocus = null; } };
            const showCustomAlert = (title, message) => { alertTitle.textContent = title; alertMessage.textContent = message; openModal(alertModal); };
            const showCustomConfirm = (title, message, onConfirm) => { confirmTitle.textContent = title; confirmMessage.textContent = message; confirmCallback = onConfirm; openModal(confirmModal); };
            const resetPaymentMethod = () => { selectedPaymentMethod = null; summaryPaymentMethod.textContent = "Não selecionado"; summaryPaymentMethod.style.fontWeight = '500'; summaryPaymentMethod.style.color = 'var(--text-light)'; updateSummary(); };

            // --- Funções de Desconto ---
            const getSubtotal = () => cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const applyDiscount = (requestedDiscount, isPercentage = false) => { const subtotal = getSubtotal(); if (subtotal === 0) { if (requestedDiscount !== 0) { showCustomAlert("Vazio", "Adicione itens."); } return; } let calculatedDiscount = isPercentage ? subtotal * (requestedDiscount / 100) : requestedDiscount; const newTotal = subtotal - calculatedDiscount; const roundedTotal = isSmartRoundingEnabled ? Math.round(newTotal * 2) / 2 : newTotal; const finalDiscount = subtotal - roundedTotal; discount = (finalDiscount > subtotal) ? subtotal : ((finalDiscount < 0) ? 0 : finalDiscount); discountInputR.value = discount > 0 ? discount.toFixed(2) : ''; updateSummary(); };
            const removeDiscount = () => { discount = 0; discountInputR.value = ''; updateSummary(); };

            // --- Funções de API ---
            async function carregarCacheDeProdutos() { barcodeInput.disabled = true; barcodeInput.placeholder = "Carregando..."; barcodeHint.textContent = "Carregando..."; localProductCache = null; try { const response = await fetch(SCRIPT_URL + "?action=listarProdutos"); if (!response.ok) throw new Error("Erro rede."); const result = await response.json(); if (result.status === 'success') { localProductCache = result.data; console.log(`Cache prod: ${localProductCache.length}`); barcodeHint.textContent = "F2 para focar"; } else { throw new Error(result.message || "Erro API."); } } catch (error) { console.error("Erro cache prod:", error); showCustomAlert("Erro Cache Prod", error.message); localProductCache = []; barcodeHint.textContent = "Erro. F5."; } finally { barcodeInput.disabled = false; barcodeInput.placeholder = "Ler código..."; barcodeInput.focus(); } }
            function buscarProdutoLocalmente(barcode) { if (localProductCache === null) { showCustomAlert("Aguarde", "Cache carregando."); return null; } return localProductCache.find(p => p.id === barcode) || null; }
            async function cadastrarProdutoNaAPI(product) { quickAddSubmitBtn.disabled = true; quickAddSubmitBtn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Cadastrando..."; try { const params = new URLSearchParams({ action: 'cadastrarProduto', codigo: product.id, nome: product.name, preco: product.price }); const response = await fetch(`${SCRIPT_URL}?${params.toString()}`, { method: 'GET' }); if (!response.ok) throw new Error("Erro rede."); const result = await response.json(); if (result.status === 'success') { if (localProductCache) { localProductCache.push(result.data); } return result.data; } else { throw new Error(result.message || "Erro API."); } } catch (error) { console.error("Erro cadastro prod:", error); showCustomAlert("Erro Cadastro Prod", error.message); return null; } finally { quickAddSubmitBtn.disabled = false; quickAddSubmitBtn.innerHTML = "Adicionar"; } }
            async function registrarVendaAtual(payments) { if (!lastSaleData) { throw new Error("Sem dados venda."); } if (!REGISTRO_VENDA_SCRIPT_URL || REGISTRO_VENDA_SCRIPT_URL.includes("COLE_A_URL")) { throw new Error("URL registro não config."); } const now = new Date(); const timestamp = formatTimestamp(now); const baseData = { formType: 'venda', seller: 'nubia', type: 'entrada', value: lastSaleData.subtotal.toFixed(2), desconto: lastSaleData.discount.toFixed(2), Timestamp: timestamp }; const fetchPromises = payments.map(payment => { const paymentData = { ...baseData, payment: payment.method || 'N/A', total: payment.value.toFixed(2) }; const formData = new URLSearchParams(paymentData); console.log("Enviando parte registro:", formData.toString()); return fetch(REGISTRO_VENDA_SCRIPT_URL, { redirect: "follow", method: "POST", body: formData.toString(), headers: { "Content-Type": "application/x-www-form-urlencoded" }, }); }); const responses = await Promise.all(fetchPromises); const allOk = responses.every(response => response.ok); if (allOk) { console.log("Registro OK!"); } else { const firstErrorResponse = responses.find(response => !response.ok); let errorText = `Falha registro. Status: ${firstErrorResponse?.status || '?'}`; try { if (firstErrorResponse) errorText = await firstErrorResponse.text(); } catch(readError) {} throw new Error(errorText); } }
            async function carregarClientesDaAPI() { clientesListContainer.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px 0;"><i class="bx bx-loader-alt bx-spin"></i> Carregando...</p>'; localClientCache = null; try { const response = await fetch(SCRIPT_URL + "?action=listarClientes"); if (!response.ok) throw new Error("Erro rede."); const result = await response.json(); if (result.status === 'success') { localClientCache = result.data; console.log(`Cache cli: ${localClientCache.length}`); renderClientesPage(); } else { throw new Error(result.message || "Erro API."); } } catch (error) { console.error("Erro carregar cli:", error); clientesListContainer.innerHTML = `<p style="text-align: center; color: var(--warning-red); padding: 20px 0;">${error.message}</p>`; localClientCache = []; } }
            async function salvarClienteNaAPI(clienteData) { clienteSaveBtn.disabled = true; clienteSaveBtn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Salvando..."; try { const params = new URLSearchParams({ action: 'cadastrarCliente', ...clienteData }); const response = await fetch(`${SCRIPT_URL}?${params.toString()}`, { method: 'GET' }); if (!response.ok) throw new Error("Erro rede."); const result = await response.json(); if (result.status === 'success') { showCustomAlert("Sucesso!", result.message || "Cliente cadastrado!"); closeModal(addClienteModal); if (localClientCache !== null) { localClientCache.push(result.data); localClientCache.sort((a, b) => (a.apelido || a.nomeExibicao).localeCompare(b.apelido || b.nomeExibicao)); } renderClientesPage(); } else { throw new Error(result.message || "Erro API."); } } catch (error) { console.error("Erro salvar cli:", error); showCustomAlert("Erro Salvar", error.message); } finally { clienteSaveBtn.disabled = false; clienteSaveBtn.innerHTML = "<i class='bx bx-save'></i> Salvar"; } }
            async function abrirCaixaAPI(data) { openCaixaSaveBtn.disabled = true; openCaixaSaveBtn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Abrindo..."; try { const params = new URLSearchParams({ action: 'abrirCaixa', ...data }); const response = await fetch(`${SCRIPT_URL}?${params.toString()}`, { method: 'GET' }); if (!response.ok) throw new Error("Erro rede."); const result = await response.json(); if (result.status === 'success') { showCustomAlert("Sucesso!", result.message || "Caixa aberto!"); closeModal(openCaixaModal); } else { throw new Error(result.message || "Erro API."); } } catch (error) { console.error("Erro abrir caixa:", error); showCustomAlert("Erro Abrir Caixa", error.message); } finally { openCaixaSaveBtn.disabled = false; openCaixaSaveBtn.innerHTML = "<i class='bx bx-check'></i> Confirmar"; } }
            async function fecharCaixaAPI(data) { closeCaixaSaveBtn.disabled = true; closeCaixaSaveBtn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Fechando..."; try { const params = new URLSearchParams({ action: 'fecharCaixa', ...data }); const response = await fetch(`${SCRIPT_URL}?${params.toString()}`, { method: 'GET' }); if (!response.ok) throw new Error("Erro rede."); const result = await response.json(); if (result.status === 'success') { showCustomAlert("Sucesso!", result.message || "Caixa fechado!"); closeModal(closeCaixaModal); } else { throw new Error(result.message || "Erro API."); } } catch (error) { console.error("Erro fechar caixa:", error); showCustomAlert("Erro Fechar Caixa", error.message); } finally { closeCaixaSaveBtn.disabled = false; closeCaixaSaveBtn.innerHTML = "<i class='bx bx-lock-alt'></i> Confirmar"; } }

            // --- Handlers de Ação ---
            const handleScan = () => { const barcode = barcodeInput.value.trim(); if (!barcode) return; const product = buscarProdutoLocalmente(barcode); if (product) { addToCart(product); } else if (localProductCache !== null) { lastScannedBarcode = barcode; scannedBarcodeEl.textContent = barcode; quickAddForm.reset(); openModal(quickAddModal); } barcodeInput.value = ''; };
            const debounce = (func, delay) => { clearTimeout(barcodeScanTimeout); barcodeScanTimeout = setTimeout(func, delay); };
            const handleQuickAddSubmit = async () => { const name = quickAddName.value; const price = parseFloat(quickAddPrice.value); if (!name || isNaN(price) || price <= 0) { showCustomAlert("Inválido", "Nome e preço."); return; } const newProduct = { id: lastScannedBarcode, name: name, price: price }; const produtoCadastrado = await cadastrarProdutoNaAPI(newProduct); if (produtoCadastrado) { addToCart(produtoCadastrado); closeModal(quickAddModal); } };
            const handlePaymentSelection = (method) => { if (splitPaymentArea.style.display === 'none') { selectedPaymentMethod = method; summaryPaymentMethod.textContent = method; summaryPaymentMethod.style.fontWeight = '600'; summaryPaymentMethod.style.color = 'var(--text-dark)'; updateSummary(); closeModal(paymentModal); } else { showCustomAlert("Atenção", "Confirme/cancele divisão."); } };
            const handlePrintReceipt = () => { if (!lastSaleData || cart.length === 0) { showCustomAlert("Erro", "Sem dados venda."); return; } const now = new Date(); const cnpj = "45.692.327/0001-00"; const nomeFantasia = "Dtudo Variedades e Utilidades"; const endereco = "Rua Jarbas Passarinho, SN"; let itemLinesHtml = ''; cart.forEach(item => { itemLinesHtml += `<div class="receipt-item"><div class="item-name">${item.name}</div><div class="item-details">${item.quantity} x ${formatCurrency(item.price)}<span>${formatCurrency(item.quantity * item.price)}</span></div></div>`; }); const receiptHtml = `<html><head><title>Recibo</title><style>@media print{body{margin:0;padding:0;background:#fff;}.print-iframe{display:none;}}@page{margin:5mm;}body{font-family:'Courier New','monospace';font-size:10pt;color:#000;max-width:300px;margin:0 auto;padding:10px;}.receipt-header{text-align:center;padding-bottom:10px;border-bottom:1px dashed #000;}.receipt-header h3{margin:0 0 5px 0;font-size:1.2rem;}.receipt-header p{margin:2px 0;font-size:0.9rem;}.receipt-title{text-align:center;font-weight:bold;margin:10px 0;font-size:0.9rem;}.receipt-items{border-bottom:1px dashed #000;padding-bottom:10px;}.receipt-item{margin-bottom:8px;font-size:0.9rem;}.item-name{font-weight:bold;}.item-details{display:flex;justify-content:space-between;padding-left:10px;}.receipt-summary{padding-top:10px;}.summary-line{display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.9rem;}.summary-line.total{font-size:1.1rem;font-weight:bold;margin-top:8px;}.receipt-footer{text-align:center;margin-top:20px;font-size:0.8rem;}</style></head><body><div class="receipt-header"><h3>${nomeFantasia}</h3><p>${endereco}</p><p>CNPJ: ${cnpj}</p><p>${formatTimestamp(now)}</p></div><p class="receipt-title">COMPROVANTE (NÃO É DOCUMENTO FISCAL)</p><div class="receipt-items">${itemLinesHtml}</div><div class="receipt-summary"><div class="summary-line"><span>Subtotal:</span><span>${formatCurrency(lastSaleData.subtotal)}</span></div><div class="summary-line"><span>Desconto:</span><span>${formatCurrency(lastSaleData.discount > 0 ? lastSaleData.discount * -1 : 0)}</span></div><div class="summary-line total"><span>TOTAL:</span><span>${formatCurrency(lastSaleData.total)}</span></div><div class="summary-line"><span>Pagamento:</span><span>${selectedPaymentMethod || 'N/A'}</span></div></div><div class="receipt-footer"><p>Obrigado!</p></div></body></html>`; const iframe = document.createElement('iframe'); iframe.style.display = 'none'; iframe.className = 'print-iframe'; document.body.appendChild(iframe); iframe.contentDocument.open(); iframe.contentDocument.write(receiptHtml); iframe.contentDocument.close(); iframe.onload = () => { try { iframe.contentWindow.focus(); iframe.contentWindow.print(); } catch (error) { console.error("Erro imprimir:", error); showCustomAlert("Erro Impressão", "Não foi possível abrir."); } setTimeout(() => { document.body.removeChild(iframe); }, 1000); }; };
            const updateDiscountNavFocus = (focusEl = true) => { discountNavElements.forEach(el => el.classList.remove('nav-focus')); const currentEl = discountNavElements[discountNavIndex]; if (currentEl) { currentEl.classList.add('nav-focus'); if (focusEl) { currentEl.focus(); if (currentEl.tagName === 'INPUT') { currentEl.select(); } } removeDiscountHint.style.display = (currentEl.id === 'remove-discount-btn') ? 'block' : 'none'; } };
            const navigateClienteSteps = (direction) => { const nextStep = currentClienteStep + direction; if (direction === 1 && currentClienteStep === 1) { if (!validateStep1()) return; } if (nextStep >= 1 && nextStep <= 2) { document.getElementById(`cliente-step-${currentClienteStep}`).classList.remove('active'); document.getElementById(`cliente-step-${nextStep}`).classList.add('active'); currentClienteStep = nextStep; updateClienteModalUI(); } };
            const updateClienteModalUI = () => { addClienteProgress.style.width = currentClienteStep === 1 ? "50%" : "100%"; clientePrevBtn.style.display = currentClienteStep === 1 ? "none" : "inline-flex"; clienteNextBtn.style.display = currentClienteStep === 2 ? "none" : "inline-flex"; clienteSaveBtn.style.display = currentClienteStep === 2 ? "inline-flex" : "none"; const firstInput = document.querySelector(`#cliente-step-${currentClienteStep} [data-primary-focus="true"], #cliente-step-${currentClienteStep} input, #cliente-step-${currentClienteStep} textarea`); if (firstInput) { setTimeout(() => firstInput.focus(), 150); } };
            const validateStep1 = () => { let isValid = true; [clienteApelidoInput].forEach(input => { if (!input.value.trim()) { input.classList.add('input-error'); isValid = false; } else { input.classList.remove('input-error'); } }); if (!isValid) showCustomAlert("Obrigatório", "Preencha Apelido."); return isValid; };
            const validateStep2 = () => { let isValid = true; [compraValorInput, compraParcelasInput, compraVencimentoInput].forEach(input => { input.classList.remove('input-error'); let value = input.value.trim(); let numValue = input.type === 'number' ? parseFloat(value) : value; if (!value || (input.type === 'number' && (isNaN(numValue) || numValue <= 0)) || (input.type === 'date' && isNaN(new Date(value).getTime()))) { input.classList.add('input-error'); isValid = false; } }); if (!isValid) showCustomAlert("Obrigatório", "Preencha dados da compra."); return isValid; };
            const resetClienteModal = () => { addClienteForm.reset(); [clienteApelidoInput, clienteNomeInput, clienteTelefoneInput, clienteEnderecoInput, compraValorInput, compraParcelasInput, compraVencimentoInput].forEach(input => input.classList.remove('input-error')); currentClienteStep = 1; document.getElementById(`cliente-step-2`).classList.remove('active'); document.getElementById(`cliente-step-1`).classList.add('active'); updateClienteModalUI(); };
            const updateSplitRemaining = () => { const total = lastSaleData?.total || 0; const val1 = parseFloat(splitValue1.value) || 0; const val2 = parseFloat(splitValue2.value) || 0; const sum = val1 + val2; const remaining = total - sum; currentSplitPayments.remaining = remaining; currentSplitPayments.totalSaleValue = total; splitPaymentRemaining.textContent = `Restante: ${formatCurrency(remaining)}`; confirmSplitPaymentBtn.disabled = !( Math.abs(remaining) < 0.01 && splitMethod1.value && val1 > 0 && splitMethod2.value && val2 > 0 && splitMethod1.value !== splitMethod2.value ); splitPaymentRemaining.style.color = remaining < -0.01 ? 'var(--warning-red)' : 'var(--primary-red)'; };

            // --- Event Listeners ---
            barcodeInput.addEventListener('focus', () => barcodeHint.style.opacity = '0');
            barcodeInput.addEventListener('blur', () => barcodeHint.style.opacity = '1');
            barcodeInput.addEventListener('input', () => { debounce(handleScan, 300); });
            cartItemsBody.addEventListener('click', (e) => { const button = e.target.closest('button'); if (!button) return; const { action, id } = button.dataset; if (action === 'increase' || action === 'decrease') { updateQuantity(id, action); } else if (button.classList.contains('remove-btn')) { showCustomConfirm("Remover Item", "Tem certeza?", () => { removeFromCart(id); closeModal(confirmModal); }); } });
            discountToggleRow.addEventListener('click', () => { discountPopover.classList.toggle('active'); });
            percBtnContainer.addEventListener('click', (e) => { const button = e.target.closest('.perc-btn'); if (button && button.dataset.perc) { applyDiscount(parseFloat(button.dataset.perc), true); } });
            discountInputR.addEventListener('input', (e) => { applyDiscount(parseFloat(e.target.value) || 0, false); });
            removeDiscountBtn.addEventListener('click', removeDiscount);
            paymentToggleRow.addEventListener('click', () => { if (cart.length > 0) { splitPaymentArea.style.display = 'none'; singlePaymentOptions.style.display = 'grid'; splitPaymentToggleBtn.innerHTML = "<i class='bx bx-columns'></i> Dividir Pagamento"; splitPaymentToggleBtn.classList.remove('active'); splitValue1.value = ''; splitValue2.value = ''; splitMethod1.value = ''; splitMethod2.value = ''; confirmSplitPaymentBtn.disabled = true; updateSplitRemaining(); openModal(paymentModal); } else { showCustomAlert("Vazio", "Adicione itens."); } });
            splitPaymentToggleBtn.addEventListener('click', () => { const isActive = splitPaymentArea.style.display !== 'none'; splitPaymentArea.style.display = isActive ? 'none' : 'block'; singlePaymentOptions.style.display = isActive ? 'grid' : 'none'; splitPaymentToggleBtn.innerHTML = isActive ? "<i class='bx bx-columns'></i> Dividir Pagamento" : "<i class='bx bx-x'></i> Cancelar Divisão"; splitPaymentToggleBtn.classList.toggle('active'); if (!isActive) { currentSplitPayments.totalSaleValue = lastSaleData?.total || 0; updateSplitRemaining(); splitMethod1.focus(); } else { confirmSplitPaymentBtn.disabled = true; } });
            [splitValue1, splitValue2, splitMethod1, splitMethod2].forEach(el => { el.addEventListener('input', updateSplitRemaining); el.addEventListener('change', updateSplitRemaining); });
             confirmSplitPaymentBtn.addEventListener('click', () => { if (Math.abs(currentSplitPayments.remaining) >= 0.01) { showCustomAlert("Erro", "Soma não bate."); return; } if (!splitMethod1.value || !splitMethod2.value || splitMethod1.value === splitMethod2.value) { showCustomAlert("Erro", "Selecione 2 formas diferentes."); return; } currentSplitPayments.method1 = splitMethod1.value; currentSplitPayments.value1 = parseFloat(splitValue1.value) || 0; currentSplitPayments.method2 = splitMethod2.value; currentSplitPayments.value2 = parseFloat(splitValue2.value) || 0; selectedPaymentMethod = `Dividido (${currentSplitPayments.method1} + ${currentSplitPayments.method2})`; summaryPaymentMethod.textContent = selectedPaymentMethod; summaryPaymentMethod.style.fontWeight = '600'; summaryPaymentMethod.style.color = 'var(--text-dark)'; updateSummary(); closeModal(paymentModal); });
            finishSaleBtn.addEventListener('click', async () => { if (cart.length === 0) { showCustomAlert("Vazio", "Adicione itens."); return; } if (!selectedPaymentMethod) { showCustomAlert("Pagamento", "Selecione forma."); openModal(paymentModal); return; } finishSaleBtn.disabled = true; finishSaleBtn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Registrando..."; let paymentsToSend = []; if (selectedPaymentMethod.startsWith("Dividido")) { paymentsToSend.push({ method: currentSplitPayments.method1, value: currentSplitPayments.value1 }); paymentsToSend.push({ method: currentSplitPayments.method2, value: currentSplitPayments.value2 }); } else { paymentsToSend.push({ method: selectedPaymentMethod, value: lastSaleData.total }); } try { await registrarVendaAtual(paymentsToSend); openModal(receiptModal); } catch (error) { console.error("Erro registro antes recibo:", error); showCustomAlert("Erro Registro", `Não foi possível registrar: ${error.message}. Tente de novo.`); } finally { finishSaleBtn.disabled = false; finishSaleBtn.innerHTML = "<i class='bx bx-check-circle'></i> Finalizar (F9)"; } });
            cancelSaleBtn.addEventListener('click', () => { if (cart.length === 0) return; showCustomConfirm("Cancelar Venda", "Tem certeza?", () => { clearCart(); closeModal(confirmModal); }); });
            confirmActionBtn.addEventListener('click', () => { if (confirmCallback) { confirmCallback(); confirmCallback = null; } });
            document.querySelectorAll('.close-modal-btn').forEach(btn => { btn.addEventListener('click', (e) => { const modal = e.target.closest('.modal-overlay'); if (modal && modal.id !== 'receipt-modal') { closeModal(modal); if (modal.id === 'add-cliente-modal') { resetClienteModal(); } else if (modal.id === 'open-caixa-modal') { openCaixaForm.reset(); } else if (modal.id === 'close-caixa-modal') { closeCaixaForm.reset(); } } }); }); 
            printReceiptBtn.addEventListener('click', handlePrintReceipt);
            newSaleBtn.addEventListener('click', () => { closeModal(receiptModal); clearCart(); barcodeInput.focus(); });
            quickAddName.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); quickAddPrice.focus(); } });
            quickAddPrice.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); quickAddSubmitBtn.click(); } });
            quickAddSubmitBtn.addEventListener('click', handleQuickAddSubmit);
            quickAddForm.addEventListener('submit', (e) => { e.preventDefault(); handleQuickAddSubmit(); });
            paymentOptions.forEach(option => { option.addEventListener('click', () => { handlePaymentSelection(option.dataset.method); }); });
            smartRoundingToggle.addEventListener('change', (e) => { isSmartRoundingEnabled = e.target.checked; if (discount > 0) { applyDiscount(discount, false); } });
            reloadCacheBtn.addEventListener('click', () => { showCustomConfirm("Recarregar Produtos", "Buscar lista recente?", () => { closeModal(confirmModal); carregarCacheDeProdutos(); }); });

            // Lógica da Navbar SPA
            const updateNavbarHighlight = (activeItem) => { if (!activeItem) return; const itemRect = activeItem.getBoundingClientRect(); const navbarRect = mainNavbar.getBoundingClientRect(); navbarHighlight.style.width = `${itemRect.width}px`; navbarHighlight.style.left = `${itemRect.left - navbarRect.left}px`; };
            navbarItems.forEach(item => { item.addEventListener('click', (e) => { e.preventDefault(); const previouslyActive = document.querySelector('.navbar-item.active'); if (previouslyActive === item) { if (item.dataset.page === 'caixa') openModal(manageCaixaModal); return; } navbarItems.forEach(navItem => navItem.classList.remove('active')); item.classList.add('active'); updateNavbarHighlight(item); allPages.forEach(page => page.style.display = 'none'); const pageId = item.dataset.page + '-page'; const targetPage = document.getElementById(pageId); if (pageId === 'caixa-page') { openModal(manageCaixaModal); } else if (targetPage) { targetPage.style.display = 'block'; } if (pageId === 'produtos-page') { renderProdutosPage(); } else if (pageId === 'clientes-page') { if(localClientCache === null) { carregarClientesDaAPI(); } else { renderClientesPage(); } } }); });
            window.addEventListener('resize', () => { updateNavbarHighlight(document.querySelector('.navbar-item.active')); });
            
            // Listeners do Modal Adicionar Cliente
            addClienteBtn.addEventListener('click', () => { resetClienteModal(); openModal(addClienteModal); });
            clienteNextBtn.addEventListener('click', () => navigateClienteSteps(1));
            clientePrevBtn.addEventListener('click', () => navigateClienteSteps(-1));
            clienteSaveBtn.addEventListener('click', () => { if (!validateStep2()) return; const clienteData = { nomeCompleto: clienteNomeInput.value.trim(), apelido: clienteApelidoInput.value.trim(), telefone: clienteTelefoneInput.value.trim(), endereco: clienteEnderecoInput.value.trim(), valorCompra: compraValorInput.value, numParcelas: compraParcelasInput.value, primeiroVencimento: compraVencimentoInput.value }; salvarClienteNaAPI(clienteData); });
            addClienteForm.addEventListener('keydown', (e) => { if (e.key === 'Enter' && currentClienteStep === 2 && document.activeElement !== clienteEnderecoInput) { e.preventDefault(); clienteSaveBtn.click(); } });
           
           // Listeners dos Modais de Caixa
            openCaixaModalBtn.addEventListener('click', () => { closeModal(manageCaixaModal); openCaixaForm.reset(); openModal(openCaixaModal); });
            closeCaixaModalBtn.addEventListener('click', () => { closeModal(manageCaixaModal); closeCaixaForm.reset(); openModal(closeCaixaModal); });
            openCaixaForm.addEventListener('submit', (e) => { e.preventDefault(); const data = { valorNotas: openCaixaNotasInput.value, valorMoedas: openCaixaMoedasInput.value }; abrirCaixaAPI(data); });
            closeCaixaForm.addEventListener('submit', (e) => { e.preventDefault(); const finalNotas = parseFloat(closeCaixaNotasInput.value) || 0; const finalMoedas = parseFloat(closeCaixaMoedasInput.value) || 0; const deposito = parseFloat(closeCaixaDepositoInput.value) || 0; const fica = parseFloat(closeCaixaFicaInput.value) || 0; const totalContado = finalNotas + finalMoedas; const totalDestinado = deposito + fica; if (Math.abs(totalContado - totalDestinado) > 0.01) { showCustomAlert("Valores Incompatíveis", `Soma depósito (${formatCurrency(deposito)}) + fica caixa (${formatCurrency(fica)}) não bate com total contado (${formatCurrency(totalContado)}).`); return; } const data = { valorFinalNotas: finalNotas.toFixed(2), valorFinalMoedas: finalMoedas.toFixed(2), vendaCartao: (parseFloat(closeCaixaCartaoInput.value) || 0).toFixed(2), vendaPixFixo: (parseFloat(closeCaixaPixInput.value) || 0).toFixed(2), valorDeposito: deposito.toFixed(2), valorFicaCaixa: fica.toFixed(2), assinatura: closeCaixaAssinaturaInput.value.trim() }; if(!data.assinatura) { showCustomAlert("Obrigatório", "Informe responsável."); closeCaixaAssinaturaInput.classList.add('input-error'); return; } else { closeCaixaAssinaturaInput.classList.remove('input-error'); } fecharCaixaAPI(data); });

            function updateClock() { if (horarioElement) { horarioElement.textContent = formatTime(new Date()); } }

            // Listener Global de Teclas de Atalho
            document.addEventListener('keydown', (e) => {
                 const openModals = document.querySelectorAll('.modal-overlay.active');
                 if (openModals.length > 0) {
                     const topModal = openModals[openModals.length - 1]; 
                    if (topModal.id === 'discount-popover' && ['ArrowDown', 'ArrowRight', 'ArrowUp', 'ArrowLeft', 'Enter'].includes(e.key)) { if (['ArrowDown', 'ArrowRight', 'ArrowUp', 'ArrowLeft'].includes(e.key)) { e.preventDefault(); } if (e.key === 'Enter' && document.activeElement === discountInputR) { e.preventDefault(); discountInputR.blur(); barcodeInput.focus(); return; } switch (e.key) { case 'ArrowDown': discountNavIndex = (discountNavIndex < 5) ? 5 : 0; break; case 'ArrowRight': discountNavIndex = (discountNavIndex < 4) ? discountNavIndex + 1 : (discountNavIndex === 4 ? 0 : 0); break; case 'ArrowUp': discountNavIndex = (discountNavIndex === 5) ? 0 : (discountNavIndex > 0 ? discountNavIndex - 1 : 5); break; case 'ArrowLeft': discountNavIndex = (discountNavIndex > 0 && discountNavIndex < 5) ? discountNavIndex - 1 : (discountNavIndex === 0 ? 4 : 4); break; case 'Enter': e.preventDefault(); const currentEl = discountNavElements[discountNavIndex]; if (currentEl && currentEl.tagName === 'BUTTON') currentEl.click(); break; } updateDiscountNavFocus(); return; }
                    else if (topModal.id === 'payment-modal') { switch (e.key) { case 'F6': e.preventDefault(); handlePaymentSelection('Dinheiro'); break; case 'F7': e.preventDefault(); handlePaymentSelection('PIX'); break; case 'F8': e.preventDefault(); handlePaymentSelection('Cartão'); break; case 'Escape': e.preventDefault(); closeModal(paymentModal); break; } return; }
                    else if (topModal.id === 'confirm-modal') { if (e.key === 'Enter') { e.preventDefault(); confirmActionBtn.click(); } if (e.key === 'Escape') { e.preventDefault(); closeModal(confirmModal); } return; }
                    else if (topModal.id === 'receipt-modal') { if (e.key === 'Enter' || e.key === 'Escape') { e.preventDefault(); newSaleBtn.click(); } return; } 
                    else if (topModal.id === 'alert-modal') { if (e.key === 'Enter' || e.key === 'Escape') { e.preventDefault(); closeModal(alertModal); } return; }
                    else if (topModal.id === 'quick-add-modal') { if (e.key === 'Escape') { e.preventDefault(); closeModal(quickAddModal); } return; } 
                    else if (topModal.id === 'add-cliente-modal') { if (e.key === 'Escape') { e.preventDefault(); closeModal(addClienteModal); resetClienteModal(); } return; } 
                    else if (topModal.id === 'manage-caixa-modal') { if (e.key === 'Escape') { e.preventDefault(); closeModal(manageCaixaModal); } return; } 
                    else if (topModal.id === 'open-caixa-modal') { if (e.key === 'Escape') { e.preventDefault(); closeModal(openCaixaModal); } return; } 
                    else if (topModal.id === 'close-caixa-modal') { if (e.key === 'Escape') { e.preventDefault(); closeModal(closeCaixaModal); } return; } 
                 }
                switch (e.key) { case 'F2': e.preventDefault(); barcodeInput.focus(); barcodeInput.select(); break; case 'F3': e.preventDefault(); discountToggleRow.click(); discountNavIndex = 0; updateDiscountNavFocus(); break; case 'F4': e.preventDefault(); paymentToggleRow.click(); break; case 'F9': e.preventDefault(); finishSaleBtn.click(); break; case 'F10': e.preventDefault(); cancelSaleBtn.click(); break; }
             });

            // --- Inicialização ---
            renderCart(); resetPaymentMethod(); 
            const initialActivePage = 'pdv'; // Volta para PDV como padrão
            const initialActiveNavbarItem = document.querySelector(`.navbar-item[data-page="${initialActivePage}"]`);
            if (initialActiveNavbarItem) { setTimeout(() => { updateNavbarHighlight(initialActiveNavbarItem); allPages.forEach(page => page.style.display = 'none'); document.getElementById(initialActivePage + '-page').style.display = 'block'; if (initialActivePage === 'clientes') carregarClientesDaAPI(); else if (initialActivePage === 'produtos') renderProdutosPage(); }, 50); }
            updateClock(); setInterval(updateClock, 1000); 
            carregarCacheDeProdutos(); // Carrega produtos em segundo plano
        });
    </script>
</body>
</html>

