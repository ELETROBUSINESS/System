<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/assets/img/iconWeb.png">
    <title>Ponto de Venda | ELETRO</title>
    <!-- Importação da Fonte (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Importação da biblioteca Boxicons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/2.6.0/uicons-solid-straight/css/uicons-solid-straight.css'>
    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/2.6.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>


    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>


    <script>

        // ============================================================
        // 1. ESCOPO GLOBAL (VARIÁVEIS E BANCO DE DADOS)
        // ============================================================

        let db; // Variável do Banco de Dados
        let realtimeOrdersUnsubscribe = null;

        // Variáveis de Pedidos Online (Globais para evitar o erro ReferenceError)
        let activeOrdersData = [];
        let currentOrderStatusFilter = 'pendente';

        // Configuração e Inicialização Imediata do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAVQ3tf6Qu4_9PajpJclZAJjVvRgB4ZE2I",
            authDomain: "super-app25.firebaseapp.com",
            projectId: "super-app25",
            storageBucket: "super-app25.firebasestorage.app",
            messagingSenderId: "810900166273",
            appId: "1:810900166273:web:24b8f055a68c9f0a6b5f80"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app();
        }

        db = firebase.firestore(); // db agora existe globalmente
        console.log("Firebase inicializado globalmente!");

        // Credenciais e URLs
        const FIREBASE_CONFIG_ID = 'floralchic-loja';
        const STORE_OWNER_UID = "3zYT9Y6hXWeJSuvmEYP4FMZa5gI2";
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzvd0BBLEEQlu-ksnIbsmnYcjQNQuZcTrsCmXMKHGM5g7DPEk3Nj95X47LKbj7rRSAT/exec";
        const REGISTRO_VENDA_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCCaxdYdC6J_QKsaoWTDquH915MHUnM9BykD39ZUujR2LB3lx9d9n5vAsHdJZJByaa7w/exec";

        // Funções Auxiliares Globais (Necessárias para as funções abaixo)
        const formatCurrency = (value) => { const n = Number(value); if (isNaN(n)) return 'R$ 0,00'; return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); };
        const formatTime = (date) => { const pad = (n) => n < 10 ? '0' + n : n; return `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`; };
        const mapStatusFirebaseToUI = (fbStatus) => {
            if (fbStatus === 'approved') return 'pendente';
            if (fbStatus === 'preparation') return 'preparando';
            if (fbStatus === 'shipped') return 'enviado';
            if (fbStatus === 'delivered') return 'finalizado';
            return fbStatus;
        };

        // ============================================================
        // 2. FUNÇÕES GLOBAIS DE PEDIDOS (Para o HTML acessar)
        // ============================================================

        // Função de Renderização (Movemos para fora do DOMContentLoaded)
        const renderDummyOrders = () => {
            const container = document.getElementById('orders-grid-container');
            const badgeNavbar = document.getElementById('pedidos-badge');

            // Atualiza Badge
            const pendingCount = activeOrdersData.filter(o => o.status === 'pendente').length;
            if (badgeNavbar) {
                badgeNavbar.innerText = pendingCount;
                if (pendingCount > 0) badgeNavbar.classList.add('active'); else badgeNavbar.classList.remove('active');
            }

            // Atualiza contadores nas abas
            const countPendenteEl = document.getElementById('count-pendente');
            const countPreparandoEl = document.getElementById('count-preparando');
            if (countPendenteEl) countPendenteEl.innerText = pendingCount;
            if (countPreparandoEl) countPreparandoEl.innerText = activeOrdersData.filter(o => o.status === 'preparando').length;

            // Só renderiza se a aba estiver visível e o container existir
            const pedidosPage = document.getElementById('pedidos-page');
            if (!pedidosPage || pedidosPage.style.display === 'none' || !container) return;

            const filteredOrders = activeOrdersData.filter(order => order.status === currentOrderStatusFilter);
            container.innerHTML = '';

            if (filteredOrders.length === 0) {
                container.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: var(--text-light); padding: 60px;"><i class='bx bx-check-circle' style="font-size: 3rem; opacity:0.3;"></i><p>Nenhum pedido "${currentOrderStatusFilter}".</p></div>`;
                return;
            }

            filteredOrders.forEach(order => {
                const card = document.createElement('div');
                card.className = 'order-card';
                let statusColor = '#856404'; let statusBg = '#fff3cd';
                if (order.status === 'preparando') { statusColor = '#004085'; statusBg = '#cce5ff'; }
                if (order.status === 'enviado' || order.status === 'finalizado') { statusColor = '#155724'; statusBg = '#d4edda'; }

                card.innerHTML = `
                    <div class="order-status" style="background:${statusBg}; color:${statusColor}">${order.status.toUpperCase()}</div>
                    <div class="order-header"><span class="order-id">#${order.displayId}</span><span class="order-time">${order.time}</span></div>
                    <div class="order-client">
                        <div class="client-avatar-small"><i class='bx bx-user'></i></div>
                        <div class="client-info"><h4>${order.client}</h4><p>${order.address}</p></div>
                    </div>
                    <div class="order-items-summary"><strong>Itens:</strong> ${order.items}</div>
                    <div class="order-footer">
                        <span class="order-total">${order.total}</span>
                        <div class="order-actions">
                            <button class="btn-main-action" onclick="openOrderDetailModal('${order.id}')">Detalhes <i class='bx bx-chevron-right'></i></button>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
        };

        // Função de Polling (Escuta do Firebase)
        // Função de Polling (Escuta do Firebase) - ATUALIZADA COM ENDEREÇO DE COLETA
        function startOrderPolling() {
            if (realtimeOrdersUnsubscribe) realtimeOrdersUnsubscribe();

            const q = db.collection('orders').orderBy('createdAt', 'desc').limit(50);

            console.log("Iniciando monitoramento de pedidos...");

            realtimeOrdersUnsubscribe = q.onSnapshot((snapshot) => {
                const fetchedOrders = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'pending_payment' || data.status === 'cancelled' || data.status === 'rejected') return;

                    const dateObj = data.createdAt ? data.createdAt.toDate() : new Date();
                    let itemsStr = "Sem itens";
                    if (data.items && Array.isArray(data.items)) itemsStr = data.items.map(i => `${i.quantity}x ${i.name}`).join(', ');

                    // --- LÓGICA DO ENDEREÇO DE COLETA ---
                    let addressDisplay = 'Endereço não informado';
                    if (data.shipping) {
                        if (data.shipping.mode === 'pickup') {
                            // Se for retirada, mostra a loja
                            // Extrai o nome da cidade ou loja da string salva ou usa fallback
                            const storeName = data.shipping.address.replace('Retirada: ', '') || 'Loja';
                            addressDisplay = `<i class='bx bxs-store' style="color:var(--info-blue)"></i> Coleta na loja de ${storeName}`;
                        } else {
                            // Se for entrega, mostra o endereço normal
                            addressDisplay = `<i class='bx bxs-truck' style="color:#666"></i> ${data.shipping.address}`;
                        }
                    }
                    // ------------------------------------

                    fetchedOrders.push({
                        id: doc.id,
                        displayId: data.orderId || doc.id.substring(0, 6),
                        time: formatTime(dateObj),
                        client: data.client ? data.client.name : 'Cliente Online',
                        address: addressDisplay, // Usa a string formatada
                        status: mapStatusFirebaseToUI(data.status),
                        total: formatCurrency(data.total || 0),
                        items: itemsStr,
                        shippingMode: data.shipping?.mode || 'delivery' // Guarda o modo para usar no modal
                    });
                });

                activeOrdersData = fetchedOrders;
                renderDummyOrders();

            }, (error) => {
                console.error("Erro pedidos:", error);
            });
        }

        // ============================================================
        // 3. INÍCIO DO DOMContentLoaded (LÓGICA DE UI E EVENTOS)
        // ============================================================
        document.addEventListener('DOMContentLoaded', () => {

            // Inicia o listener de pedidos imediatamente
            startOrderPolling();

            // --- Constantes Locais de UI ---
            const TOKEN_KEY = 'caixaToken';
            const TOKEN_EXPIRATION_KEY = 'caixaTokenExpiration';
            const TOKEN_DURATION_HOURS = 20;


            // Inicializa o Firebase apenas se ainda não foi inicializado
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            } else {
                firebase.app(); // se já existe, usa o padrão
            }

            // Define a variável global 'db' que o nosso script do PDV usa
            const db = firebase.firestore();

            console.log("Firebase inicializado com sucesso!");

            let selectedCrediarioClient = null; // Para armazenar o cliente selecionado no pagamento

            // --- Estado da Aplicação ---
            let localProductCache = null;
            let localClientCache = null;
            let cart = [];
            let lastScannedBarcode = null;
            let confirmCallback = null;
            let discount = 0;
            let selectedPaymentMethod = null;
            let elementToRestoreFocus = null;
            let isSmartRoundingEnabled = true;
            let lastSaleData = null;
            let barcodeScanTimeout = null;
            let currentClienteStep = 1;
            let currentFecharCaixaStep = 1;
            let currentSplitPayments = { method1: null, value1: 0, method2: null, value2: 0, remaining: 0, totalSaleValue: 0 };

            // --- Seletores do DOM ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            const mainContent = document.getElementById('main-content');
            const headerCloseCaixaBtn = document.getElementById('header-close-caixa-btn');
            const barcodeInput = document.getElementById('barcode-input');
            const barcodeHint = document.getElementById('barcode-hint');
            const cartItemsBody = document.getElementById('cart-items-body');
            const itemListContainer = document.getElementById('item-list-container');
            const emptyState = document.getElementById('empty-state');
            const itemListTable = document.getElementById('item-list-table');
            const summarySubtotal = document.getElementById('summary-subtotal');
            const summaryTotal = document.getElementById('summary-total');
            const itemCount = document.getElementById('item-count');
            const summaryDiscount = document.getElementById('summary-discount');
            const discountToggleRow = document.getElementById('discount-toggle-row');
            const discountPopover = document.getElementById('discount-popover');
            const discountInputR = document.getElementById('discount-input-r');
            const percBtnContainer = document.getElementById('perc-btn-container');
            const removeDiscountBtn = document.getElementById('remove-discount-btn');
            const effectiveDiscountDisplay = document.getElementById('effective-discount-display');
            const discountPercentageText = document.getElementById('discount-percentage-text');
            const paymentToggleRow = document.getElementById('payment-toggle-row');
            const summaryPaymentMethod = document.getElementById('summary-payment-method');
            const finishSaleBtn = document.getElementById('finish-sale-btn');
            const cancelSaleBtn = document.getElementById('cancel-sale-btn');
            const quickAddModal = document.getElementById('quick-add-modal');
            const paymentModal = document.getElementById('payment-modal');
            const paymentTotalEl = document.getElementById('payment-total');
            const singlePaymentOptions = document.getElementById('single-payment-options');
            const paymentOptions = paymentModal.querySelectorAll('.payment-option');
            const splitPaymentToggleBtn = document.getElementById('split-payment-toggle-btn');
            const splitPaymentArea = document.getElementById('split-payment-area');
            const splitMethod1 = document.getElementById('split-method-1');
            const splitValue1 = document.getElementById('split-value-1');
            const splitMethod2 = document.getElementById('split-method-2');
            const splitValue2 = document.getElementById('split-value-2');
            const splitPaymentRemaining = document.getElementById('split-payment-remaining');
            const confirmSplitPaymentBtn = document.getElementById('confirm-split-payment-btn');
            const receiptModal = document.getElementById('receipt-modal');
            const receiptTotalEl = document.getElementById('receipt-total');
            const newSaleBtn = document.getElementById('new-sale-btn');
            const printReceiptBtn = document.getElementById('print-receipt-btn');
            const confirmModal = document.getElementById('confirm-modal');
            const alertModal = document.getElementById('alert-modal');
            const scannedBarcodeEl = document.getElementById('scanned-barcode');
            const quickAddForm = document.getElementById('quick-add-form');
            const quickAddName = document.getElementById('quick-product-name');
            const quickAddPrice = document.getElementById('quick-product-price');
            const quickAddSubmitBtn = document.getElementById('quick-add-submit-btn');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            const mainNavbar = document.getElementById('main-navbar');
            const navbarItems = document.querySelectorAll('.navbar-item');
            const navbarHighlight = document.getElementById('navbar-highlight');
            const allPages = document.querySelectorAll('.page-content');
            const produtosTableContainer = document.getElementById('produtos-table-container');
            const clientesListContainer = document.getElementById('clientes-list-container');
            const smartRoundingToggle = document.getElementById('smart-rounding-toggle');
            const reloadCacheBtn = document.getElementById('reload-cache-btn');
            const discountNavElements = [discountInputR, ...document.querySelectorAll('.perc-btn'), removeDiscountBtn];
            let discountNavIndex = 0;
            const removeDiscountHint = document.getElementById('remove-discount-hint');
            const horarioElement = document.getElementById('horario');
            const addClienteBtn = document.getElementById('add-cliente-btn');
            const addClienteModal = document.getElementById('add-cliente-modal');
            const addClienteForm = document.getElementById('add-cliente-form');
            const clienteStep1 = document.getElementById('cliente-step-1');
            const clienteStep2 = document.getElementById('cliente-step-2');
            const addClienteProgress = document.getElementById('add-cliente-progress');
            const clientePrevBtn = document.getElementById('cliente-prev-btn');
            const clienteNextBtn = document.getElementById('cliente-next-btn');
            const clienteSaveBtn = document.getElementById('cliente-save-btn');
            const clienteApelidoInput = document.getElementById('cliente-apelido');
            const clienteNomeInput = document.getElementById('cliente-nome');
            const clienteTelefoneInput = document.getElementById('cliente-telefone');
            const clienteEnderecoInput = document.getElementById('cliente-endereco');
            const compraValorInput = document.getElementById('compra-valor');
            const compraParcelasInput = document.getElementById('compra-parcelas');
            const compraVencimentoInput = document.getElementById('compra-vencimento');
            const openCaixaModal = document.getElementById('open-caixa-modal');
            const openCaixaForm = document.getElementById('open-caixa-form');
            const openCaixaNotasInput = document.getElementById('open-caixa-notas');
            const openCaixaMoedasInput = document.getElementById('open-caixa-moedas');
            const openCaixaSemValorCheckbox = document.getElementById('open-caixa-sem-valor');
            const openCaixaSaveBtn = document.getElementById('open-caixa-save-btn');
            const closeCaixaModal = document.getElementById('close-caixa-modal');
            const closeCaixaForm = document.getElementById('close-caixa-form');
            const closeCaixaProgress = document.getElementById('close-caixa-progress');
            const closeCaixaPrevBtn = document.getElementById('close-caixa-prev-btn');
            const closeCaixaNextBtn = document.getElementById('close-caixa-next-btn');
            const closeCaixaNotasInput = document.getElementById('close-caixa-notas');
            const closeCaixaMoedasInput = document.getElementById('close-caixa-moedas');
            const closeCaixaCartaoInput = document.getElementById('close-caixa-cartao');
            const closeCaixaPixInput = document.getElementById('close-caixa-pix');
            const closeCaixaDepositoInput = document.getElementById('close-caixa-deposito');
            const closeCaixaFicaInput = document.getElementById('close-caixa-fica');
            const closeCaixaAssinaturaInput = document.getElementById('close-caixa-assinatura');
            const closeCaixaSaveBtn = document.getElementById('close-caixa-save-btn');


            // Novos Seletores para Fluxo de Cliente
            const clientSelectionModal = document.getElementById('client-selection-modal');
            const clientSelectionInput = document.getElementById('client-selection-input');
            const clientSelectionResults = document.getElementById('client-selection-results');
            const clientSearchHint = document.getElementById('client-search-hint');
            const btnNewClientModal = document.getElementById('btn-new-client-modal');

            // Seletores do Resumo (Sidebar)
            const summaryClientCard = document.getElementById('summary-client-card');
            const summaryClientNameText = document.getElementById('summary-client-name-text');
            const btnChangeSummaryClient = document.getElementById('btn-change-summary-client');
            const summaryLimitFill = document.getElementById('summary-limit-fill');
            const summaryLimitValue = document.getElementById('summary-limit-value');

            // Modais e Botões do Fluxo Novo
            const crediarioFlowModal = document.getElementById('crediario-flow-modal');
            const btnForcePrint = document.getElementById('btn-force-print');
            const btnFinishCrediarioFinal = document.getElementById('btn-finish-crediario-final');
            const credStep1 = document.getElementById('cred-step-1');
            const credStep2 = document.getElementById('cred-step-2');
            const credFlowClientName = document.getElementById('cred-flow-client-name');


            // Handler para Opções de Pagamento
            paymentOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const method = option.dataset.method;

                    if (method === 'Crediário') {
                        // 1. Fecha modal de pagamento
                        closeModal(paymentModal);

                        // 2. Abre modal de seleção de cliente
                        // (Reseta a busca antes)
                        clientSelectionInput.value = '';
                        clientSelectionResults.innerHTML = '';
                        clientSelectionResults.style.display = 'none';
                        clientSearchHint.style.display = 'block';

                        openModal(clientSelectionModal);
                        setTimeout(() => clientSelectionInput.focus(), 100);
                    } else {
                        // Fluxo normal (Dinheiro, Pix, Cartão)
                        selectedCrediarioClient = null;
                        updateSummaryClientCard(); // Esconde o card

                        handlePaymentSelection(method);
                    }
                });
            });


            // --- Busca de Cliente (Novo Modal) ---
            clientSelectionInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                clientSelectionResults.innerHTML = '';

                if (term.length < 2) {
                    clientSelectionResults.style.display = 'none';
                    clientSearchHint.style.display = 'block';
                    return;
                }

                clientSearchHint.style.display = 'none';

                if (!localClientCache) { carregarClientesDaAPI(); return; }

                const filtered = localClientCache.filter(c =>
                    (c.nomeExibicao && c.nomeExibicao.toLowerCase().includes(term)) ||
                    (c.apelido && c.apelido.toLowerCase().includes(term))
                );

                if (filtered.length > 0) {
                    clientSelectionResults.style.display = 'block';
                    filtered.forEach(client => {
                        const div = document.createElement('div');
                        div.className = 'client-result-item';
                        // Mostra Nome + Saldo atual na busca
                        div.innerHTML = `
                        <div>
                            <strong>${client.nomeExibicao}</strong> 
                            <small style="color:#777">(${client.apelido || '-'})</small>
                        </div>
                        <div style="font-size:0.85rem; font-weight:600; color:${client.saldoDevedor > 0 ? 'var(--warning-red)' : 'var(--success-green)'}">
                            Dívida: ${formatCurrency(client.saldoDevedor)}
                        </div>
                    `;
                        div.addEventListener('click', () => confirmClientSelection(client));
                        clientSelectionResults.appendChild(div);
                    });
                } else {
                    clientSelectionResults.style.display = 'none';
                    clientSearchHint.textContent = "Nenhum cliente encontrado.";
                    clientSearchHint.style.display = 'block';
                }
            });

            // Botão "+" no modal de busca
            btnNewClientModal.addEventListener('click', () => {
                closeModal(clientSelectionModal);
                resetClienteModal();
                openModal(addClienteModal);
            });

            // Ação ao Clicar num Cliente
            const confirmClientSelection = (client) => {
                selectedCrediarioClient = client;
                selectedPaymentMethod = 'Crediário'; // Define o método

                // Atualiza UI
                updateSummary(); // Para atualizar o texto "Pagamento: Crediário"
                summaryPaymentMethod.textContent = "Crediário";
                summaryPaymentMethod.style.fontWeight = '600';

                // Mostra o Card no Resumo
                updateSummaryClientCard();

                // Fecha modal
                closeModal(clientSelectionModal);
            };

            // Botão "Alterar" no Sidebar
            btnChangeSummaryClient.addEventListener('click', () => {
                clientSelectionInput.value = '';
                clientSelectionResults.style.display = 'none';
                clientSearchHint.style.display = 'block';
                openModal(clientSelectionModal);
                setTimeout(() => clientSelectionInput.focus(), 100);
            });

            const updateSummaryClientCard = () => {
                if (selectedCrediarioClient && selectedPaymentMethod === 'Crediário') {
                    summaryClientCard.style.display = 'block';
                    summaryClientNameText.textContent = selectedCrediarioClient.nomeExibicao;

                    // Cálculo do Limite em Tempo Real
                    const limite = parseFloat(selectedCrediarioClient.limite) || 0;
                    const dividaAntiga = parseFloat(selectedCrediarioClient.saldoDevedor) || 0;
                    const compraAtual = lastSaleData ? lastSaleData.total : 0;

                    // Disponível AGORA (antes de consolidar a compra atual)
                    const disponivelReal = limite - dividaAntiga;

                    // Como ficará APÓS a compra
                    const saldoFinalPrevisto = disponivelReal - compraAtual;

                    if (limite > 0) {
                        summaryLimitValue.textContent = formatCurrency(saldoFinalPrevisto);

                        // Barra de progresso baseada no uso total (Dívida + Compra)
                        const usoTotal = dividaAntiga + compraAtual;
                        let percentual = (usoTotal / limite) * 100;
                        if (percentual > 100) percentual = 100;

                        summaryLimitFill.style.width = `${percentual}%`;

                        if (saldoFinalPrevisto < 0) {
                            summaryLimitFill.classList.add('danger');
                            summaryLimitValue.style.color = 'var(--warning-red)';
                            summaryLimitValue.textContent = `Estourado: ${formatCurrency(saldoFinalPrevisto)}`;
                        } else {
                            summaryLimitFill.classList.remove('danger');
                            summaryLimitValue.style.color = 'var(--text-dark)';
                        }
                    } else {
                        // Sem limite definido
                        summaryLimitFill.style.width = '0%';
                        summaryLimitValue.textContent = "Ilimitado / Não def.";
                    }

                } else {
                    summaryClientCard.style.display = 'none';
                }
            };


            // --- Funções de Token ---
            const verificarToken = () => { const token = localStorage.getItem(TOKEN_KEY); const expiration = localStorage.getItem(TOKEN_EXPIRATION_KEY); const now = Date.now(); if (token && expiration && now < parseInt(expiration)) { console.log("Token válido."); return true; } else { console.log("Token inválido/expirado."); localStorage.removeItem(TOKEN_KEY); localStorage.removeItem(TOKEN_EXPIRATION_KEY); return false; } };
            const salvarToken = () => { const now = Date.now(); const expirationTime = now + TOKEN_DURATION_HOURS * 60 * 60 * 1000; const tokenValue = `caixaAberto_${now}`; localStorage.setItem(TOKEN_KEY, tokenValue); localStorage.setItem(TOKEN_EXPIRATION_KEY, expirationTime.toString()); console.log("Token salvo, expira:", new Date(expirationTime)); };
            const limparToken = () => { localStorage.removeItem(TOKEN_KEY); localStorage.removeItem(TOKEN_EXPIRATION_KEY); console.log("Token limpo."); };

            // --- Funções de Formatação ---
            const formatCurrency = (value) => { const numericValue = Number(value); if (isNaN(numericValue)) return 'R$ 0,00'; return numericValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); };
            const formatTimestamp = (date) => { const pad = (n) => n < 10 ? '0' + n : n; const d = date.getDate(), mo = date.getMonth() + 1, y = date.getFullYear(); const h = date.getHours(), mi = date.getMinutes(), s = date.getSeconds(); return `${pad(d)}/${pad(mo)}/${y} ${pad(h)}:${pad(mi)}:${pad(s)}`; };
            const formatTime = (date) => { const pad = (n) => n < 10 ? '0' + n : n; const h = date.getHours(), mi = date.getMinutes(), s = date.getSeconds(); return `${pad(h)}:${pad(mi)}:${pad(s)}`; };

            // --- Funções de Renderização ---

            const renderCart = () => {
                cartItemsBody.innerHTML = '';

                // Bloqueio de Desconto Global se houver itens do Firebase
                const hasFirebaseItems = cart.some(i => i.isFirebase);
                if (hasFirebaseItems) {
                    discountInputR.disabled = true;
                    discountInputR.placeholder = "Bloqueado (Ofertas)";
                    document.querySelectorAll('.perc-btn').forEach(b => b.disabled = true);
                    if (discount > 0) { discount = 0; discountInputR.value = ''; updateSummary(); }
                } else {
                    discountInputR.disabled = false;
                    discountInputR.placeholder = "0,00";
                    document.querySelectorAll('.perc-btn').forEach(b => b.disabled = false);
                }

                if (cart.length === 0) {
                    emptyState.style.display = 'flex';
                    itemListTable.style.display = 'none';
                    itemListContainer.classList.add('empty');
                } else {
                    emptyState.style.display = 'none';
                    itemListTable.style.display = 'table';
                    itemListContainer.classList.remove('empty');

                    cart.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.dataset.id = item.id;
                        if (item.isNew) { tr.classList.add('new-item-flash'); delete item.isNew; setTimeout(() => tr.classList.remove('new-item-flash'), 500); }

                        // Visual do Input de Desconto
                        let discountInputHtml = '';
                        if (item.isFirebase) {
                            const colorStyle = item.discountPercent > 0 ? 'color:var(--success-green);font-weight:bold' : 'color:#999';
                            discountInputHtml = `<span style="${colorStyle}">${item.discountPercent.toFixed(0)}%</span>`;
                        } else {
                            discountInputHtml = `<input type="number" style="width:50px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center;" value="${item.discountPercent}" min="0" max="100" onchange="updateCartItem('${item.id}', 'discountPercent', this.value)"> %`;
                        }

                        tr.innerHTML = `
                        <td>
                            <div class="product-info">
                                <div class="product-image"><i class='bx bx-package'></i></div>
                                <div class="product-details">
                                    <span class="name">${item.name}</span>
                                    <span class="barcode">#${item.id}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="quantity-control">
                                <button class="qty-btn" onclick="updateCartItem('${item.id}', 'quantity', 'decrease')"><i class='bx bx-minus'></i></button>
                                <span class="qty-display">${item.quantity}</span>
                                <button class="qty-btn" onclick="updateCartItem('${item.id}', 'quantity', 'increase')"><i class='bx bx-plus'></i></button>
                            </div>
                        </td>
                        <td class="item-price">${formatCurrency(item.originalPrice)}</td>
                        
                        <td class="item-offer" style="text-align:center;">${discountInputHtml}</td>
                        
                        <td class="item-total">${formatCurrency(item.price * item.quantity)}</td>
                        
                        <td><button class="remove-btn" onclick="removeFromCart('${item.id}')" title="Remover"><i class='bx bx-trash'></i></button></td>
                    `;
                        cartItemsBody.appendChild(tr);
                    });
                }
                updateSummary();
            };


            const updateSummary = () => {
                // 1. Subtotal Bruto (Soma dos preços cheios originais)
                const subtotalGross = cart.reduce((acc, item) => acc + (item.originalPrice * item.quantity), 0);

                // 2. Total Líquido (Soma dos preços reais com desconto aplicado nos itens)
                const totalNetItems = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);

                // 3. Desconto Total (Diferença entre Bruto e Líquido + Desconto Global se houver)
                // Nota: Se houver itens Firebase, 'discount' global será 0 pela lógica do renderCart
                const totalDiscount = (subtotalGross - totalNetItems) + discount;

                // 4. Total Final a Pagar
                const finalTotal = subtotalGross - totalDiscount;

                // Atualiza Interface
                const totalItems = cart.reduce((acc, item) => acc + item.quantity, 0);

                summarySubtotal.textContent = formatCurrency(subtotalGross);
                summaryDiscount.textContent = formatCurrency(totalDiscount > 0 ? totalDiscount * -1 : 0); // Exibe negativo visualmente

                // Exibe porcentagem efetiva se houver desconto
                if (totalDiscount > 0 && subtotalGross > 0) {
                    const percentage = (totalDiscount / subtotalGross) * 100;
                    discountPercentageText.textContent = `(${percentage.toFixed(2)}% econ.)`;
                    effectiveDiscountDisplay.style.display = 'flex';
                } else {
                    discountPercentageText.textContent = '';
                    effectiveDiscountDisplay.style.display = 'none';
                }

                summaryTotal.textContent = formatCurrency(finalTotal);
                itemCount.textContent = totalItems;
                paymentTotalEl.textContent = formatCurrency(finalTotal);
                receiptTotalEl.textContent = formatCurrency(finalTotal);

                // Atualiza dados globais da venda para o recibo
                lastSaleData = {
                    subtotal: subtotalGross,
                    discount: totalDiscount,
                    total: finalTotal,
                    paymentMethod: selectedPaymentMethod
                };

                updateSummaryClientCard();
            };

            const renderProdutosPage = () => { produtosTableContainer.innerHTML = ''; if (!localProductCache) { produtosTableContainer.innerHTML = '<p style="text-align: center; color: var(--text-light);"><i class="bx bx-loader-alt bx-spin"></i> Carregando...</p>'; if (localProductCache === null) carregarCacheDeProdutos(); return; } if (localProductCache.length === 0) { produtosTableContainer.innerHTML = '<p style="text-align: center; color: var(--text-light);">Nenhum produto.</p>'; return; } const table = document.createElement('table'); table.className = 'data-table products-table'; table.innerHTML = `<thead><tr><th>Nome</th><th>Código</th><th>Preço</th></tr></thead><tbody></tbody>`; const tbody = table.querySelector('tbody'); localProductCache.forEach(product => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${product.name}</td><td>${product.id}</td><td class="currency">${formatCurrency(product.price)}</td>`; tbody.appendChild(tr); }); produtosTableContainer.appendChild(table); };

            const renderClientesPage = () => {
                const container = document.getElementById('clientes-list-container');
                const searchInput = document.getElementById('clientes-page-search');

                // Limpa container
                container.innerHTML = '';

                // Verifica carregamento
                if (localClientCache === null) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px 0;"><i class="bx bx-loader-alt bx-spin"></i> Carregando...</p>';
                    return;
                }

                // Lógica de Filtragem
                const term = searchInput ? searchInput.value.toLowerCase() : "";

                const clientesFiltrados = localClientCache.filter(c =>
                    (c.nomeExibicao && c.nomeExibicao.toLowerCase().includes(term)) ||
                    (c.apelido && c.apelido.toLowerCase().includes(term))
                );

                if (clientesFiltrados.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px 0;">Nenhum cliente encontrado.</p>';
                    return;
                }

                // Renderiza Tabela
                const table = document.createElement('table');
                table.className = 'data-table clients-table';
                table.innerHTML = `
                <thead>
                    <tr>
                        <th>Nome / Apelido</th>
                        <th>Saldo Devedor</th>
                        <th>Próximo Venc.</th>
                        <th style="text-align: center;">Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;

                const tbody = table.querySelector('tbody');

                clientesFiltrados.forEach(cliente => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>
                        ${cliente.nomeExibicao} 
                        <span style="font-size: 0.85rem; color: var(--text-light);">
                            ${cliente.apelido && cliente.nomeExibicao !== cliente.apelido ? '(' + cliente.apelido + ')' : ''}
                        </span>
                    </td>
                    <td class="currency" style="color: ${cliente.saldoDevedor > 0 ? 'var(--warning-red)' : 'var(--success-green)'}">
                        ${formatCurrency(cliente.saldoDevedor)}
                    </td>
                    <td>${cliente.proximoVencimento || '-'}</td>
                    <td class="actions">
                        <button class="btn-view-client" data-id="${cliente.idCliente}" title="Ver Detalhes">
                            <i class='bx bx-show'></i>
                        </button> 
                        <button class="btn-pay-client" data-id="${cliente.idCliente}" title="Registrar Pagamento">
                            <i class='bx bx-money'></i>
                        </button>
                    </td>
                `;
                    tbody.appendChild(tr);
                });

                container.appendChild(table);

                // Reatribui os eventos aos botões da tabela filtrada
                document.querySelectorAll('.btn-view-client').forEach(btn => {
                    btn.addEventListener('click', () => openClienteDetails(btn.dataset.id));
                });

                document.querySelectorAll('.btn-pay-client').forEach(btn => {
                    btn.addEventListener('click', () => openClientePayment(btn.dataset.id));
                });
            };

            // --- Variáveis Globais Novas ---
            let currentSeller = localStorage.getItem('pdv_last_seller') || null; // Carrega do cache

            // --- Seletores Novos ---
            const sellerToggleRow = document.getElementById('seller-toggle-row');
            const sellerPopover = document.getElementById('seller-popover');
            const summarySellerName = document.getElementById('summary-seller-name');
            const sellerButtons = document.querySelectorAll('.seller-btn');
            const btnRefreshHistory = document.getElementById('btn-refresh-history');
            const salesHistoryList = document.getElementById('sales-history-list');

            // --- Inicialização do Vendedor ---
            if (currentSeller) {
                summarySellerName.textContent = currentSeller;
                summarySellerName.style.color = 'var(--text-dark)';
                // Marca visualmente o botão
                sellerButtons.forEach(btn => {
                    if (btn.dataset.name === currentSeller) btn.style.backgroundColor = 'var(--primary-red)';
                });
            }

            // --- Lógica de Seleção de Vendedor ---
            sellerToggleRow.addEventListener('click', () => {
                sellerPopover.classList.toggle('active');
            });

            sellerButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove estilo dos outros
                    sellerButtons.forEach(b => {
                        b.style.backgroundColor = 'var(--card-white)';
                        b.style.color = 'var(--text-dark)';
                    });

                    // Aplica ao selecionado
                    currentSeller = btn.dataset.name;
                    localStorage.setItem('pdv_last_seller', currentSeller); // Salva no cache

                    btn.style.backgroundColor = 'var(--primary-red)';
                    btn.style.color = 'white';

                    summarySellerName.textContent = currentSeller;
                    summarySellerName.style.color = 'var(--text-dark)';
                    sellerPopover.classList.remove('active');
                });
            });

            // Função para enviar os dados para o Histórico
            async function salvarVendaNoHistorico(dadosVenda) {
                // SCRIPT_URL é a variável com seu link ".../exec"
                if (!SCRIPT_URL) {
                    console.error("SCRIPT_URL não definida!");
                    return;
                }

                // Estrutura exata que seu backend espera receber
                const payload = {
                    action: "registrarHistorico", // Isso ativa o if no doPost
                    cliente: dadosVenda.cliente || "Cliente Balcão",
                    vendedor: dadosVenda.vendedor || "Caixa",
                    valor: dadosVenda.valorTotal, // Certifique-se que é número ou string formatada
                    produtos: formatarListaProdutos(dadosVenda.itens), // Transforma array em string
                    pagamento: dadosVenda.metodoPagamento,
                    idVenda: dadosVenda.id || Date.now().toString()
                };

                const options = {
                    method: 'POST', // OBRIGATÓRIO ser POST para cair no doPost
                    body: JSON.stringify(payload) // OBRIGATÓRIO converter para string JSON
                };

                try {
                    console.log("Enviando histórico...", payload);

                    // O fetch dispara o request
                    // mode: 'no-cors' NÃO deve ser usado se você quer ler a resposta JSON
                    const response = await fetch(SCRIPT_URL, options);

                    const jsonResponse = await response.json();

                    if (jsonResponse.status === "success") {
                        console.log("Histórico registrado com sucesso!");
                    } else {
                        console.error("Erro no backend:", jsonResponse.message);
                    }
                } catch (error) {
                    console.error("Erro na requisição:", error);
                }
            }

            // Função auxiliar para transformar o array de itens numa string legível na planilha
            function formatarListaProdutos(itens) {
                if (!itens || !Array.isArray(itens)) return "N/A";

                // CORREÇÃO: Alterado de 'item.qtd' para 'item.quantity' e 'item.nome' para 'item.name'
                return itens.map(item => `${item.quantity || 1}x ${item.name || item.nome || "Item"}`).join(", ");
            }

            // --- Lógica da Página de Histórico ---
            const carregarHistorico = async () => {
                salesHistoryList.innerHTML = '<p style="text-align: center; padding: 20px;"><i class="bx bx-loader-alt bx-spin"></i> Atualizando...</p>';

                try {
                    const response = await fetch(`${SCRIPT_URL}?action=listarHistoricoVendas`);
                    const result = await response.json();

                    if (result.status === 'success' && result.data.length > 0) {
                        salesHistoryList.innerHTML = ''; // Limpa

                        result.data.forEach(venda => {
                            // Cria o cartão da venda
                            const card = document.createElement('div');
                            card.style.border = '1px solid var(--border-color)';
                            card.style.borderRadius = '12px';
                            card.style.padding = '16px';
                            card.style.backgroundColor = '#fff';

                            card.innerHTML = `
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <strong style="font-size:1rem;">${venda.cliente}</strong>
                                <span style="color:var(--success-green); font-weight:bold;">${formatCurrency(venda.valor)}</span>
                            </div>
                            <div style="font-size:0.85rem; color:#666; margin-bottom:8px;">
                                <i class='bx bx-user'></i> Vend: ${venda.vendedor} &bull; 
                                <i class='bx bx-credit-card'></i> ${venda.pagamento} &bull; 
                                <i class='bx bx-time'></i> ${venda.data}
                            </div>
                            <div style="font-size:0.8rem; background:#f9f9f9; padding:8px; border-radius:6px; color:#444;">
                                ${venda.produtos}
                            </div>
                        `;
                            salesHistoryList.appendChild(card);
                        });
                    } else {
                        salesHistoryList.innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">Nenhuma venda registrada hoje.</p>';
                    }
                } catch (e) {
                    salesHistoryList.innerHTML = '<p style="text-align: center; color: var(--warning-red);">Erro ao carregar histórico.</p>';
                }
            };

            // Botão de Atualizar e Clique na Aba
            btnRefreshHistory.addEventListener('click', carregarHistorico);

            // --- Funções de Lógica do Carrinho ---

            const addToCart = (product) => {
                const existingItem = cart.find(item => item.id === product.id);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    // 1. Define o Preço Original (Sempre o preço cheio da tabela)
                    let basePrice = product.price;

                    // 2. Define o Preço Efetivo e o Desconto
                    let finalPrice = basePrice;
                    let discountPct = 0;
                    let isOffer = false;

                    // Se for Firebase e tiver oferta válida, calcula o preço final
                    if (product.isFirebase && product.priceOffer > 0 && product.priceOffer < basePrice) {
                        finalPrice = product.priceOffer;
                        discountPct = ((basePrice - finalPrice) / basePrice) * 100;
                        isOffer = true;
                    }

                    cart.push({
                        ...product,
                        originalPrice: basePrice, // NUNCA MUDA (Preço de Tabela)
                        price: finalPrice,        // MUDA com desconto (Preço de Venda)
                        quantity: 1,
                        isNew: true,
                        discountPercent: discountPct,
                        hasOffer: isOffer
                    });
                }
                renderCart();
            };

            const updateQuantity = (id, action) => { const item = cart.find(item => item.id === id); if (!item) return; if (action === 'increase') { item.quantity += 1; } else if (action === 'decrease') { item.quantity -= 1; if (item.quantity === 0) { removeFromCart(id); return; } } renderCart(); };
            const removeFromCart = (id) => { cart = cart.filter(item => item.id !== id); renderCart(); };
            const clearCart = () => { cart = []; removeDiscount(); resetPaymentMethod(); lastSaleData = null; renderCart(); };

            // Funções de Modal com Acessibilidade
            const openModal = (modalEl) => { elementToRestoreFocus = document.activeElement; modalEl.classList.add('active'); const primaryFocus = modalEl.querySelector('[data-primary-focus="true"]'); if (primaryFocus) { setTimeout(() => primaryFocus.focus(), 100); } };
            const closeModal = (modalEl) => { modalEl.classList.remove('active'); if (elementToRestoreFocus && elementToRestoreFocus.focus) { try { elementToRestoreFocus.focus(); } catch (e) { console.warn("Não foi possível restaurar o foco:", e); } } elementToRestoreFocus = null; };
            const showCustomAlert = (title, message) => { alertTitle.textContent = title; alertMessage.textContent = message; openModal(alertModal); };
            const showCustomConfirm = (title, message, onConfirm) => { confirmTitle.textContent = title; confirmMessage.textContent = message; confirmCallback = onConfirm; openModal(confirmModal); };
            const resetPaymentMethod = () => { selectedPaymentMethod = null; summaryPaymentMethod.textContent = "Não selecionado"; summaryPaymentMethod.style.fontWeight = '500'; summaryPaymentMethod.style.color = 'var(--text-light)'; updateSummary(); };

            // --- Funções de Desconto ---
            const getSubtotal = () => cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const applyDiscount = (requestedDiscount, isPercentage = false) => { const subtotal = getSubtotal(); if (subtotal === 0) { if (requestedDiscount !== 0) { showCustomAlert("Vazio", "Adicione itens."); } return; } let calculatedDiscount = isPercentage ? subtotal * (requestedDiscount / 100) : requestedDiscount; const newTotal = subtotal - calculatedDiscount; const roundedTotal = isSmartRoundingEnabled ? Math.round(newTotal * 2) / 2 : newTotal; const finalDiscount = subtotal - roundedTotal; discount = (finalDiscount > subtotal) ? subtotal : ((finalDiscount < 0) ? 0 : finalDiscount); discountInputR.value = discount > 0 ? discount.toFixed(2) : ''; updateSummary(); };
            const removeDiscount = () => { discount = 0; discountInputR.value = ''; updateSummary(); };


            // --- Funções de API (ATUALIZADA: GOOGLE SHEETS + FIREBASE) ---

            // Função auxiliar para buscar produtos do Firebase
            async function fetchFirebaseProductsForCache() {
                try {
                    const productsRef = db.collection('artifacts').doc(FIREBASE_CONFIG_ID)
                        .collection('users').doc(STORE_OWNER_UID)
                        .collection('products');
                    const snapshot = await productsRef.get();
                    if (snapshot.empty) return [];

                    return snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: data.code || doc.id,
                            name: data.name,
                            price: parseValueFirebase(data.price),
                            priceOffer: parseValueFirebase(data['price-oferta']), // AGORA PEGANDO A OFERTA
                            stock: data.stock || 0,
                            isFirebase: true,
                            docId: doc.id
                        };
                    }).filter(p => p.id);
                } catch (e) {
                    console.error("Erro Firebase:", e);
                    return [];
                }
            }

            window.updateCartItem = (id, field, value) => {
                const item = cart.find(i => i.id === id);
                if (!item) return;

                if (field === 'quantity') {
                    if (value === 'increase') item.quantity++;
                    else if (value === 'decrease') {
                        item.quantity--;
                        if (item.quantity === 0) return removeFromCart(id);
                    }
                } else if (field === 'discountPercent') {
                    // Só permite editar se NÃO for produto Firebase (oferta fixa)
                    if (!item.isFirebase) {
                        let percent = parseFloat(value) || 0;
                        // Travas de segurança
                        if (percent < 0) percent = 0;
                        if (percent > 100) percent = 100;

                        item.discountPercent = percent;

                        // CÁLCULO: Preço Final = Preço Original * (1 - %)
                        // O 'originalPrice' continua sendo o preço cheio.
                        item.price = item.originalPrice * (1 - (percent / 100));
                    }
                }
                renderCart();
            };

            // Função Principal de Carregamento (Híbrida)
            async function carregarCacheDeProdutos() {
                barcodeInput.disabled = true;
                barcodeInput.placeholder = "Carregando sistema...";
                barcodeHint.textContent = "Sincronizando estoques...";
                localProductCache = [];

                try {
                    // 1. Busca Google Sheets e Firebase em paralelo
                    const [sheetResponse, firebaseProducts] = await Promise.all([
                        fetch(SCRIPT_URL + "?action=listarProdutos"),
                        fetchFirebaseProductsForCache()
                    ]);

                    // 2. Processa Google Sheets
                    if (!sheetResponse.ok) throw new Error("Erro rede Sheets.");
                    const sheetResult = await sheetResponse.json();
                    let sheetProducts = [];

                    if (sheetResult.status === 'success') {
                        sheetProducts = sheetResult.data.map(p => ({
                            ...p,
                            price: parseFloat(p.price) // Garante numérico
                        }));
                    }

                    // 3. Lógica de Mesclagem (Firebase Sobrescreve Sheets)
                    // Cria um mapa usando o ID (código de barras) como chave
                    const productMap = new Map();

                    // Adiciona produtos da Planilha primeiro
                    sheetProducts.forEach(p => productMap.set(String(p.id).trim(), p));

                    // Adiciona/Sobrescreve com produtos do Firebase
                    firebaseProducts.forEach(p => {
                        // Se já existe, o Firebase ganha (atualiza preço/nome)
                        // Se não existe, é adicionado
                        productMap.set(String(p.id).trim(), p);
                    });

                    // Converte de volta para array
                    localProductCache = Array.from(productMap.values());

                    console.log(`Cache unificado: ${localProductCache.length} produtos.`);
                    barcodeHint.textContent = "F2 para focar";

                } catch (error) {
                    console.error("Erro cache prod:", error);
                    showCustomAlert("Erro Sincronização", "Falha ao carregar produtos. Verifique a internet.");
                    localProductCache = [];
                    barcodeHint.textContent = "Erro. F5.";
                } finally {
                    barcodeInput.disabled = false;
                    barcodeInput.placeholder = "Ler código...";
                    if (verificarToken()) barcodeInput.focus();
                }
            }


            function buscarProdutoLocalmente(barcode) { if (localProductCache === null) { showCustomAlert("Aguarde", "Cache carregando."); return null; } return localProductCache.find(p => p.id === barcode) || null; }
            async function cadastrarProdutoNaAPI(product) { quickAddSubmitBtn.disabled = true; quickAddSubmitBtn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Cadastrando..."; try { const params = new URLSearchParams({ action: 'cadastrarProduto', codigo: product.id, nome: product.name, preco: product.price }); const response = await fetch(`${SCRIPT_URL}?${params.toString()}`, { method: 'GET' }); if (!response.ok) throw new Error("Erro rede."); const result = await response.json(); if (result.status === 'success') { if (localProductCache) { localProductCache.push(result.data); } return result.data; } else { throw new Error(result.message || "Erro API."); } } catch (error) { console.error("Erro cadastro prod:", error); showCustomAlert("Erro Cadastro Prod", error.message); return null; } finally { quickAddSubmitBtn.disabled = false; quickAddSubmitBtn.innerHTML = "Adicionar"; } }
            async function registrarVendaAtual(payments) { if (!lastSaleData) { throw new Error("Sem dados venda."); } if (!REGISTRO_VENDA_SCRIPT_URL || REGISTRO_VENDA_SCRIPT_URL.includes("COLE_A_URL")) { throw new Error("URL registro não config."); } const now = new Date(); const timestamp = formatTimestamp(now); const baseData = { formType: 'venda', seller: 'nubia', type: 'entrada', value: lastSaleData.subtotal.toFixed(2), desconto: lastSaleData.discount.toFixed(2), Timestamp: timestamp }; const fetchPromises = payments.map(payment => { const paymentData = { ...baseData, payment: payment.method || 'N/A', total: payment.value.toFixed(2) }; const formData = new URLSearchParams(paymentData); console.log("Enviando parte registro:", formData.toString()); return fetch(REGISTRO_VENDA_SCRIPT_URL, { redirect: "follow", method: "POST", body: formData.toString(), headers: { "Content-Type": "application/x-www-form-urlencoded" }, }); }); const responses = await Promise.all(fetchPromises); const allOk = responses.every(response => response.ok); if (allOk) { console.log("Registro OK!"); } else { const firstErrorResponse = responses.find(response => !response.ok); let errorText = `Falha registro. Status: ${firstErrorResponse?.status || '?'}`; try { if (firstErrorResponse) errorText = await firstErrorResponse.text(); } catch (readError) { } throw new Error(errorText); } }

            // Função para abater estoque no Firebase
            async function abaterEstoqueFirebase(itensVendidos) {
                const batch = db.batch();
                let updatesCount = 0;

                itensVendidos.forEach(item => {
                    // Só abate se o produto veio do Firebase e tem um ID de documento válido
                    if (item.isFirebase && item.docId) {
                        const ref = db.collection('artifacts').doc(FIREBASE_CONFIG_ID)
                            .collection('users').doc(STORE_OWNER_UID)
                            .collection('products').doc(item.docId);

                        // Decrementa a quantidade atômica (seguro contra concorrência)
                        batch.update(ref, {
                            stock: firebase.firestore.FieldValue.increment(-item.quantity),
                            updatedAt: new Date().toISOString()
                        });
                        updatesCount++;
                    }
                });

                if (updatesCount > 0) {
                    try {
                        await batch.commit();
                        console.log(`Estoque atualizado: ${updatesCount} itens abatidos no Firebase.`);
                    } catch (e) {
                        console.error("Erro ao abater estoque:", e);
                        // Não paramos a venda por erro de estoque, apenas logamos
                    }
                }
            }

            async function carregarClientesDaAPI() { clientesListContainer.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px 0;"><i class="bx bx-loader-alt bx-spin"></i> Carregando...</p>'; localClientCache = null; try { const response = await fetch(SCRIPT_URL + "?action=listarClientes"); if (!response.ok) throw new Error("Erro rede."); const result = await response.json(); if (result.status === 'success') { localClientCache = result.data; console.log(`Cache cli: ${localClientCache.length}`); renderClientesPage(); } else { throw new Error(result.message || "Erro API."); } } catch (error) { console.error("Erro carregar cli:", error); clientesListContainer.innerHTML = `<p style="text-align: center; color: var(--warning-red); padding: 20px 0;">${error.message}</p>`; localClientCache = []; } }
            async function salvarClienteNaAPI(clienteData) { clienteSaveBtn.disabled = true; clienteSaveBtn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Salvando..."; try { const params = new URLSearchParams({ action: 'cadastrarCliente', ...clienteData }); const response = await fetch(`${SCRIPT_URL}?${params.toString()}`, { method: 'GET' }); if (!response.ok) throw new Error("Erro rede."); const result = await response.json(); if (result.status === 'success') { showCustomAlert("Sucesso!", result.message || "Cliente cadastrado!"); closeModal(addClienteModal); if (localClientCache !== null) { localClientCache.push(result.data); localClientCache.sort((a, b) => (a.apelido || a.nomeExibicao).localeCompare(b.apelido || b.nomeExibicao)); } renderClientesPage(); } else { throw new Error(result.message || "Erro API."); } } catch (error) { console.error("Erro salvar cli:", error); showCustomAlert("Erro Salvar", error.message); } finally { clienteSaveBtn.disabled = false; clienteSaveBtn.innerHTML = "<i class='bx bx-save'></i> Salvar"; } }
            async function abrirCaixaAPI(data) {
                openCaixaSaveBtn.disabled = true; openCaixaSaveBtn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Abrindo..."; try {
                    const params = new URLSearchParams({ action: 'abrirCaixa', ...data }); const response = await fetch(`${SCRIPT_URL}?${params.toString()}`, { method: 'GET' }); if (!response.ok) throw new Error("Erro rede."); const result = await response.json(); if (result.status === 'success') {
                        salvarToken(); liberarSistema(); showCustomAlert("Sucesso!", result.message || "Caixa aberto!"); closeModal(openCaixaModal);
                    } else { throw new Error(result.message || "Erro API."); }
                } catch (error) { console.error("Erro abrir caixa:", error); showCustomAlert("Erro Abrir Caixa", error.message); } finally { openCaixaSaveBtn.disabled = false; openCaixaSaveBtn.innerHTML = "<i class='bx bx-check'></i> Confirmar"; }
            }
            async function fecharCaixaAPI(data) {
                closeCaixaSaveBtn.disabled = true; closeCaixaSaveBtn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Fechando..."; try {
                    const params = new URLSearchParams({ action: 'fecharCaixa', ...data }); const response = await fetch(`${SCRIPT_URL}?${params.toString()}`, { method: 'GET' }); if (!response.ok) throw new Error("Erro rede."); const result = await response.json(); if (result.status === 'success') {
                        limparToken(); bloquearSistema("Caixa fechado! Recarregue a página (F5) para reabrir."); // Mensagem atualizada
                        showCustomAlert("Sucesso!", result.message || "Caixa fechado!"); closeModal(closeCaixaModal);
                    } else { throw new Error(result.message || "Erro API."); }
                } catch (error) { console.error("Erro fechar caixa:", error); showCustomAlert("Erro Fechar Caixa", error.message); } finally { closeCaixaSaveBtn.disabled = false; closeCaixaSaveBtn.innerHTML = "<i class='bx bx-lock-alt'></i> Confirmar"; }
            }

            // --- Funções para controlar UI (baseado no token) ---
            const bloquearSistema = (message = "Abertura de caixa necessária.") => {
                mainContent.style.display = 'none';
                loadingOverlay.classList.remove('hidden');
                loadingMessage.textContent = message;
                headerCloseCaixaBtn.style.display = 'none';
            };

            const liberarSistema = () => {
                loadingOverlay.classList.add('hidden');
                mainContent.style.display = 'block';
                headerCloseCaixaBtn.style.display = 'inline-flex';

                if (localProductCache === null) carregarCacheDeProdutos();
                const activePage = document.querySelector('.navbar-item.active')?.dataset.page;
                if (activePage === 'clientes' && localClientCache === null) carregarClientesDaAPI();

                const activeItem = document.querySelector('.navbar-item.active');
                if (activeItem) updateNavbarHighlight(activeItem);
            };

            // --- Handlers de Ação ---
            const handleScan = () => { const barcode = barcodeInput.value.trim(); if (!barcode) return; const product = buscarProdutoLocalmente(barcode); if (product) { addToCart(product); } else if (localProductCache !== null) { lastScannedBarcode = barcode; scannedBarcodeEl.textContent = barcode; quickAddForm.reset(); openModal(quickAddModal); } barcodeInput.value = ''; };
            const debounce = (func, delay) => { clearTimeout(barcodeScanTimeout); barcodeScanTimeout = setTimeout(func, delay); };
            const handleQuickAddSubmit = async () => { const name = quickAddName.value; const price = parseFloat(quickAddPrice.value); if (!name || isNaN(price) || price <= 0) { showCustomAlert("Inválido", "Nome e preço."); return; } const newProduct = { id: lastScannedBarcode, name: name, price: price }; const produtoCadastrado = await cadastrarProdutoNaAPI(newProduct); if (produtoCadastrado) { addToCart(produtoCadastrado); closeModal(quickAddModal); } };
            const handlePaymentSelection = (method) => { if (splitPaymentArea.style.display === 'none') { selectedPaymentMethod = method; summaryPaymentMethod.textContent = method; summaryPaymentMethod.style.fontWeight = '600'; summaryPaymentMethod.style.color = 'var(--text-dark)'; updateSummary(); closeModal(paymentModal); } else { showCustomAlert("Atenção", "Confirme/cancele divisão."); } };
            // --- Lógica de Impressão (Atualizada: Sem QR Code, Com A4) ---

            let tempClientNameForSignature = null; // Variável auxiliar

            // 1. Abre o Modal de Seleção
            const handlePrintReceipt = (clientNameForSignature = null) => {
                if (!lastSaleData || cart.length === 0) {
                    showCustomAlert("Erro", "Sem dados venda."); return;
                }
                tempClientNameForSignature = clientNameForSignature;
                openModal(document.getElementById('print-selection-modal'));
            };

            // 2. Listeners das Opções
            document.getElementById('btn-print-thermal').onclick = () => {
                closeModal(document.getElementById('print-selection-modal'));
                printThermal(tempClientNameForSignature);
            };

            document.getElementById('btn-print-a4').onclick = () => {
                closeModal(document.getElementById('print-selection-modal'));
                printA4(tempClientNameForSignature);
            };

            // --- Layout 1: Cupom Térmico ---
            const printThermal = (clientName) => {
                const now = new Date();
                const uniqueSaleID = formatTimestamp(now);

                let itemLinesHtml = '';
                cart.forEach(item => {
                    itemLinesHtml += `<div class="receipt-item"><div class="item-name">${item.name}</div><div class="item-details">${item.quantity} x ${formatCurrency(item.price)}<span>${formatCurrency(item.quantity * item.price)}</span></div></div>`;
                });

                let signatureHtml = '';
                if (clientName) {
                    signatureHtml = `<div style="margin-top:30px;text-align:center;border-top:1px solid #000;padding-top:5px;">Assinatura</div><div style="text-align:center;font-weight:bold;">${clientName}</div>`;
                }

                const html = `<html><head><style>@media print{body{margin:0;padding:0;}iframe{display:none;}}body{font-family:'Courier New',monospace;font-size:10pt;color:#000;max-width:300px;margin:0 auto;padding:10px;}.header{text-align:center;border-bottom:1px dashed #000;padding-bottom:10px;margin-bottom:10px;}.items{border-bottom:1px dashed #000;padding-bottom:10px;}.item-details{display:flex;justify-content:space-between;}.summary{padding-top:10px;}.line{display:flex;justify-content:space-between;}</style></head><body>
            <div class="header"><h3>Dtudo Variedades</h3><p>CNPJ: 45.692.327/0001-00</p><p>${uniqueSaleID}</p></div>
            <p style="text-align:center;font-weight:bold">COMPROVANTE</p>
            <div class="items">${itemLinesHtml}</div>
            <div class="summary">
                <div class="line"><span>TOTAL:</span><span>${formatCurrency(lastSaleData.total)}</span></div>
                <div class="line"><span>Pagto:</span><span>${selectedPaymentMethod || 'N/A'}</span></div>
            </div>
            ${signatureHtml}
            <div style="text-align:center;margin-top:20px;font-size:0.8rem"><p>Não é documento fiscal</p></div>
            </body></html>`;

                executePrint(html);
            };

            // --- Layout 2: Nota Auxiliar A4 ---
            const printA4 = (clientName) => {
                const now = new Date();
                const uniqueSaleID = formatTimestamp(now);

                // Dados do Cliente
                let clientHtml = '<p>Consumidor Final</p>';
                if (selectedCrediarioClient) {
                    clientHtml = `
                    <p><strong>Cliente:</strong> ${selectedCrediarioClient.nomeCompleto || selectedCrediarioClient.nomeExibicao}</p>
                    <p><strong>Endereço:</strong> ${selectedCrediarioClient.endereco || 'Não informado'}</p>
                    <p><strong>Telefone:</strong> ${selectedCrediarioClient.telefone || 'Não informado'}</p>
                `;
                }

                let rows = '';
                cart.forEach((item, idx) => {
                    rows += `<tr><td style="text-align:center">${idx + 1}</td><td>${item.name}</td><td style="text-align:center">${item.quantity}</td><td style="text-align:right">${formatCurrency(item.price)}</td><td style="text-align:right">${formatCurrency(item.price * item.quantity)}</td></tr>`;
                });

                const html = `<html><head><style>
                @media print { @page { size: A4; margin: 10mm; } }
                body { font-family: Arial, sans-serif; color: #333; max-width: 210mm; margin: 0 auto; padding: 20px; }
                .header { border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; }
                h1 { color: #db0038; margin: 0; font-size: 24px; }
                .box { background: #f9f9f9; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px; }
                th { background: #333; color: #fff; padding: 10px; text-align: left; }
                td { padding: 10px; border-bottom: 1px solid #eee; }
                .total { font-size: 18px; font-weight: bold; color: #db0038; text-align: right; }
                .footer { margin-top: 50px; display: flex; justify-content: flex-end; }
                .sig-line { width: 300px; text-align: center; border-top: 1px solid #000; padding-top: 5px; }
            </style></head><body>
                <div class="header">
                    <div><h1>Dtudo Variedades</h1><p>Rua Jarbas Passarinho, SN<br>CNPJ: 45.692.327/0001-00</p></div>
                    <div style="text-align:right"><h2>NOTA AUXILIAR DE VENDA</h2><p>Data: ${formatTimestamp(now)}<br>ID: ${uniqueSaleID}</p></div>
                </div>
                <div class="box"><h3>Dados do Cliente</h3>${clientHtml}</div>
                
                <h3 style="text-align:center; margin: 30px 0;">COMPROVANTE DE COMPRA</h3>

                <table>
                    <thead><tr><th>#</th><th>Descrição</th><th>Qtd</th><th>Unit.</th><th>Total</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                <div class="total">TOTAL A PAGAR: ${formatCurrency(lastSaleData.total)}</div>
                <div class="footer">
                    <div class="sig-line"><p><strong>${clientName || 'Cliente'}</strong></p><small>Assinatura</small></div>
                </div>
                <p style="text-align:center; margin-top: 50px; font-size: 10px; color: #999;">Documento auxiliar de venda. Não possui valor fiscal.</p>
            </body></html>`;

                executePrint(html);
            };

            const executePrint = (html) => {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                iframe.contentDocument.open();
                iframe.contentDocument.write(html);
                iframe.contentDocument.close();
                iframe.onload = () => {
                    setTimeout(() => {
                        try { iframe.contentWindow.focus(); iframe.contentWindow.print(); } catch (e) { }
                        setTimeout(() => document.body.removeChild(iframe), 1000);
                    }, 500);
                };
            };
            const updateDiscountNavFocus = (focusEl = true) => { discountNavElements.forEach(el => el.classList.remove('nav-focus')); const currentEl = discountNavElements[discountNavIndex]; if (currentEl) { currentEl.classList.add('nav-focus'); if (focusEl) { currentEl.focus(); if (currentEl.tagName === 'INPUT') { currentEl.select(); } } removeDiscountHint.style.display = (currentEl.id === 'remove-discount-btn') ? 'block' : 'none'; } };
            const navigateClienteSteps = (direction) => { const nextStep = currentClienteStep + direction; if (direction === 1 && currentClienteStep === 1) { if (!validateStep1()) return; } if (nextStep >= 1 && nextStep <= 2) { document.getElementById(`cliente-step-${currentClienteStep}`).classList.remove('active'); document.getElementById(`cliente-step-${nextStep}`).classList.add('active'); currentClienteStep = nextStep; updateClienteModalUI(); } };
            const updateClienteModalUI = () => { addClienteProgress.style.width = currentClienteStep === 1 ? "50%" : "100%"; clientePrevBtn.style.display = currentClienteStep === 1 ? "none" : "inline-flex"; clienteNextBtn.style.display = currentClienteStep === 2 ? "none" : "inline-flex"; clienteSaveBtn.style.display = currentClienteStep === 2 ? "inline-flex" : "none"; const firstInput = document.querySelector(`#cliente-step-${currentClienteStep} [data-primary-focus="true"], #cliente-step-${currentClienteStep} input, #cliente-step-${currentClienteStep} textarea`); if (firstInput) { setTimeout(() => firstInput.focus(), 150); } };
            const validateStep1 = () => { let isValid = true;[clienteApelidoInput].forEach(input => { if (!input.value.trim()) { input.classList.add('input-error'); isValid = false; } else { input.classList.remove('input-error'); } }); if (!isValid) showCustomAlert("Obrigatório", "Preencha Apelido."); return isValid; };
            const validateStep2 = () => { let isValid = true;[compraValorInput, compraParcelasInput, compraVencimentoInput].forEach(input => { input.classList.remove('input-error'); let value = input.value.trim(); let numValue = input.type === 'number' ? parseFloat(value) : value; if (!value || (input.type === 'number' && (isNaN(numValue) || numValue <= 0)) || (input.type === 'date' && isNaN(new Date(value).getTime()))) { input.classList.add('input-error'); isValid = false; } }); if (!isValid) showCustomAlert("Obrigatório", "Preencha dados da compra."); return isValid; };
            const resetClienteModal = () => { addClienteForm.reset();[clienteApelidoInput, clienteNomeInput, clienteTelefoneInput, clienteEnderecoInput, compraValorInput, compraParcelasInput, compraVencimentoInput].forEach(input => input.classList.remove('input-error')); currentClienteStep = 1; document.getElementById(`cliente-step-2`).classList.remove('active'); document.getElementById(`cliente-step-1`).classList.add('active'); updateClienteModalUI(); };
            const updateSplitRemaining = () => { const total = lastSaleData?.total || 0; const val1 = parseFloat(splitValue1.value) || 0; const val2 = parseFloat(splitValue2.value) || 0; const sum = val1 + val2; const remaining = total - sum; currentSplitPayments.remaining = remaining; currentSplitPayments.totalSaleValue = total; splitPaymentRemaining.textContent = `Restante: ${formatCurrency(remaining)}`; confirmSplitPaymentBtn.disabled = !(Math.abs(remaining) < 0.01 && splitMethod1.value && val1 > 0 && splitMethod2.value && val2 > 0 && splitMethod1.value !== splitMethod2.value); splitPaymentRemaining.style.color = remaining < -0.01 ? 'var(--warning-red)' : 'var(--primary-red)'; };
            const navigateFecharCaixaSteps = (direction) => { const nextStep = currentFecharCaixaStep + direction; if (direction === 1) { if (currentFecharCaixaStep === 1 && !validateFecharCaixaStep1()) return; if (currentFecharCaixaStep === 2 && !validateFecharCaixaStep2()) return; if (currentFecharCaixaStep === 3 && !validateFecharCaixaStep3()) return; } if (nextStep >= 1 && nextStep <= 4) { document.querySelectorAll('#close-caixa-form .form-step').forEach(el => el.classList.remove('active')); document.getElementById(`close-caixa-step-${nextStep}`).classList.add('active'); currentFecharCaixaStep = nextStep; updateFecharCaixaModalUI(); } };
            const updateFecharCaixaModalUI = () => { const progress = currentFecharCaixaStep * 25; closeCaixaProgress.style.width = `${progress}%`; closeCaixaPrevBtn.style.display = currentFecharCaixaStep === 1 ? "none" : "inline-flex"; closeCaixaNextBtn.style.display = currentFecharCaixaStep === 4 ? "none" : "inline-flex"; closeCaixaSaveBtn.style.display = currentFecharCaixaStep === 4 ? "inline-flex" : "none"; const firstInput = document.querySelector(`#close-caixa-step-${currentFecharCaixaStep} [data-primary-focus="true"], #close-caixa-step-${currentFecharCaixaStep} input`); if (firstInput) setTimeout(() => firstInput.focus(), 150); };
            const validateFecharCaixaStep1 = () => { let isValid = true;[closeCaixaNotasInput, closeCaixaMoedasInput].forEach(input => { const val = parseFloat(input.value); if (input.value.trim() === '' || isNaN(val) || val < 0) { input.classList.add('input-error'); isValid = false; } else { input.classList.remove('input-error'); } }); if (!isValid) showCustomAlert("Inválido", "Notas e Moedas devem ser >= 0."); return isValid; }; // Exige preenchimento
            const validateFecharCaixaStep2 = () => { let isValid = true;[closeCaixaCartaoInput].forEach(input => { const val = parseFloat(input.value); if (input.value.trim() === '' || isNaN(val) || val < 0) { input.classList.add('input-error'); isValid = false; } else { input.classList.remove('input-error'); } }); const pixVal = parseFloat(closeCaixaPixInput.value); if (closeCaixaPixInput.value && (isNaN(pixVal) || pixVal < 0)) { closeCaixaPixInput.classList.add('input-error'); isValid = false; } else { closeCaixaPixInput.classList.remove('input-error'); } if (!isValid) showCustomAlert("Inválido", "Cartão e Pix (se preenchido) >= 0."); return isValid; }; // Exige preenchimento cartão
            const validateFecharCaixaStep3 = () => { let isValid = true; const finalNotas = parseFloat(closeCaixaNotasInput.value) || 0; const finalMoedas = parseFloat(closeCaixaMoedasInput.value) || 0; const deposito = parseFloat(closeCaixaDepositoInput.value); const fica = parseFloat(closeCaixaFicaInput.value); const totalContado = finalNotas + finalMoedas; const totalDestinado = deposito + fica;[closeCaixaDepositoInput, closeCaixaFicaInput].forEach(input => { const val = parseFloat(input.value); if (input.value.trim() === '' || isNaN(val) || val < 0) { input.classList.add('input-error'); isValid = false; } else { input.classList.remove('input-error'); } }); if (isValid && Math.abs(totalContado - totalDestinado) > 0.01) { closeCaixaDepositoInput.classList.add('input-error'); closeCaixaFicaInput.classList.add('input-error'); isValid = false; showCustomAlert("Incompatível", `Soma Depósito+Fica (${formatCurrency(totalDestinado)}) != Total Contado (${formatCurrency(totalContado)}).`); } if (!isValid && Math.abs(totalContado - totalDestinado) <= 0.01) showCustomAlert("Inválido", "Depósito e Fica Caixa >= 0."); return isValid; }; // Exige preenchimento
            const validateFecharCaixaStep4 = () => { let isValid = true; if (!closeCaixaAssinaturaInput.value.trim()) { closeCaixaAssinaturaInput.classList.add('input-error'); isValid = false; } else { closeCaixaAssinaturaInput.classList.remove('input-error'); } if (!isValid) showCustomAlert("Obrigatório", "Informe responsável."); return isValid; };
            const resetFecharCaixaModal = () => { closeCaixaForm.reset(); document.querySelectorAll('#close-caixa-form .input-error').forEach(el => el.classList.remove('input-error')); currentFecharCaixaStep = 1; document.querySelectorAll('#close-caixa-form .form-step').forEach(el => el.classList.remove('active')); document.getElementById('close-caixa-step-1').classList.add('active'); updateFecharCaixaModalUI(); };


            // --- Event Listeners ---
            barcodeInput.addEventListener('focus', () => barcodeHint.style.opacity = '0');
            barcodeInput.addEventListener('blur', () => barcodeHint.style.opacity = '1');

            // --- Listener das Abas de Pedidos (FILTROS) ---
            const orderTabs = document.querySelectorAll('#order-status-tabs .order-tab');
            orderTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove classe active de todas
                    orderTabs.forEach(t => t.classList.remove('active'));

                    // Adiciona na clicada
                    tab.classList.add('active');

                    // Atualiza o filtro global
                    currentOrderStatusFilter = tab.dataset.status;

                    // Re-renderiza a lista
                    renderDummyOrders();
                });
            });

            barcodeInput.addEventListener('input', () => { debounce(handleScan, 300); });
            cartItemsBody.addEventListener('click', (e) => { const button = e.target.closest('button'); if (!button) return; const { action, id } = button.dataset; if (action === 'increase' || action === 'decrease') { updateQuantity(id, action); } else if (button.classList.contains('remove-btn')) { showCustomConfirm("Remover Item", "Tem certeza?", () => { removeFromCart(id); closeModal(confirmModal); }); } });
            discountToggleRow.addEventListener('click', () => { discountPopover.classList.toggle('active'); });
            percBtnContainer.addEventListener('click', (e) => { const button = e.target.closest('.perc-btn'); if (button && button.dataset.perc) { applyDiscount(parseFloat(button.dataset.perc), true); } });
            discountInputR.addEventListener('input', (e) => { applyDiscount(parseFloat(e.target.value) || 0, false); });
            removeDiscountBtn.addEventListener('click', removeDiscount);
            paymentToggleRow.addEventListener('click', () => { if (cart.length > 0) { splitPaymentArea.style.display = 'none'; singlePaymentOptions.style.display = 'grid'; splitPaymentToggleBtn.innerHTML = "<i class='bx bx-columns'></i> Dividir Pagamento"; splitPaymentToggleBtn.classList.remove('active'); splitValue1.value = ''; splitValue2.value = ''; splitMethod1.value = ''; splitMethod2.value = ''; confirmSplitPaymentBtn.disabled = true; updateSplitRemaining(); openModal(paymentModal); } else { showCustomAlert("Vazio", "Adicione itens."); } });
            splitPaymentToggleBtn.addEventListener('click', () => { const isActive = splitPaymentArea.style.display !== 'none'; splitPaymentArea.style.display = isActive ? 'none' : 'block'; singlePaymentOptions.style.display = isActive ? 'grid' : 'none'; splitPaymentToggleBtn.innerHTML = isActive ? "<i class='bx bx-columns'></i> Dividir Pagamento" : "<i class='bx bx-x'></i> Cancelar Divisão"; splitPaymentToggleBtn.classList.toggle('active'); if (!isActive) { currentSplitPayments.totalSaleValue = lastSaleData?.total || 0; updateSplitRemaining(); splitMethod1.focus(); } else { confirmSplitPaymentBtn.disabled = true; } });
            [splitValue1, splitValue2, splitMethod1, splitMethod2].forEach(el => { el.addEventListener('input', updateSplitRemaining); el.addEventListener('change', updateSplitRemaining); });
            confirmSplitPaymentBtn.addEventListener('click', () => { if (Math.abs(currentSplitPayments.remaining) >= 0.01) { showCustomAlert("Erro", "Soma não bate."); return; } if (!splitMethod1.value || !splitMethod2.value || splitMethod1.value === splitMethod2.value) { showCustomAlert("Erro", "Selecione 2 formas diferentes."); return; } currentSplitPayments.method1 = splitMethod1.value; currentSplitPayments.value1 = parseFloat(splitValue1.value) || 0; currentSplitPayments.method2 = splitMethod2.value; currentSplitPayments.value2 = parseFloat(splitValue2.value) || 0; selectedPaymentMethod = `Dividido (${currentSplitPayments.method1} + ${currentSplitPayments.method2})`; summaryPaymentMethod.textContent = selectedPaymentMethod; summaryPaymentMethod.style.fontWeight = '600'; summaryPaymentMethod.style.color = 'var(--text-dark)'; updateSummary(); closeModal(paymentModal); });

            // --- VARIÁVEIS GLOBAIS DE IMPRESSÃO ---
            let selectedPrintFormat = 'thermal'; // 'thermal' ou 'a4'

            // --- 1. BOTÃO FINALIZAR VENDA (F9) ---
            // Agora ele apenas abre a seleção de impressão. Nada é registrado ainda.
            finishSaleBtn.addEventListener('click', () => {
                if (cart.length === 0) {
                    showCustomAlert("Vazio", "Adicione itens.");
                    return;
                }

                if (!selectedPaymentMethod) {
                    showCustomAlert("Pagamento", "Selecione forma.");
                    openModal(paymentModal);
                    return;
                }

                // Validação extra para Crediário
                if (selectedPaymentMethod === 'Crediário' && !selectedCrediarioClient) {
                    showCustomAlert("Atenção", "Selecione o cliente para o Crediário.");
                    openModal(clientSelectionModal);
                    return;
                }

                // Abre escolha de impressão
                openModal(document.getElementById('print-selection-modal'));
            });

            // --- 1. LISTENERS DOS BOTÕES DE SELEÇÃO DE IMPRESSÃO ---
            // Ao clicar, fechamos o modal de seleção e iniciamos o processo único
            document.getElementById('btn-print-thermal').onclick = () => {
                closeModal(document.getElementById('print-selection-modal'));
                processFinalSale('thermal');
            };

            document.getElementById('btn-print-a4').onclick = () => {
                closeModal(document.getElementById('print-selection-modal'));
                processFinalSale('a4');
            };

            // --- 2. FUNÇÃO MESTRA: REGISTRAR, IMPRIMIR E AVANÇAR ---
            async function processFinalSale(format) {
                // 1. Feedback Visual Imediato (Bloqueia a tela)
                loadingOverlay.classList.remove('hidden');
                loadingMessage.innerHTML = "Registrando Venda...<br>Aguarde a impressão.";

                // Desabilita botão original para evitar cliques extras no fundo
                finishSaleBtn.disabled = true;

                try {
                    const now = new Date();
                    const timestamp = formatTimestamp(now);

                    // --- CORREÇÃO AQUI: Prepara e envia para o Histórico ---
                    const dadosParaHistorico = {
                        cliente: selectedCrediarioClient ? selectedCrediarioClient.nomeExibicao : "Cliente Balcão",
                        vendedor: currentSeller || "Caixa", // Pega o vendedor selecionado ou define Caixa
                        valorTotal: lastSaleData.total.toFixed(2),
                        itens: cart, // Passa o array do carrinho
                        metodoPagamento: selectedPaymentMethod,
                        id: timestamp
                    };

                    // Chama a função que envia para a planilha 'historic' (sem await para não travar a impressão)
                    salvarVendaNoHistorico(dadosParaHistorico);
                    // -------------------------------------------------------

                    // 2. PREPARAR DADOS DO PAGAMENTO
                    let paymentsToSend = [];
                    if (selectedPaymentMethod && selectedPaymentMethod.startsWith("Dividido")) {
                        paymentsToSend.push({ method: currentSplitPayments.method1, value: currentSplitPayments.value1 });
                        paymentsToSend.push({ method: currentSplitPayments.method2, value: currentSplitPayments.value2 });
                    } else {
                        paymentsToSend.push({ method: selectedPaymentMethod, value: lastSaleData.total });
                    }

                    // ============================================================
                    // NOVO: ABATER ESTOQUE NO FIREBASE (Executa em paralelo)
                    // ============================================================
                    const promiseEstoque = abaterEstoqueFirebase(cart);
                    const promiseRegistro = registrarVendaAtual(paymentsToSend);

                    // Aguarda o registro financeiro (obrigatório) e o estoque (desejável)
                    await Promise.all([promiseRegistro, promiseEstoque]);
                    // ============================================================

                    // 4. SE FOR CREDIÁRIO: REGISTRAR DÍVIDA (LOG)
                    if (selectedPaymentMethod === 'Crediário') {
                        const paramsCliente = new URLSearchParams({
                            action: 'registrarTransacao',
                            idCliente: selectedCrediarioClient.idCliente,
                            tipo: 'Compra',
                            valor: lastSaleData.total.toFixed(2),
                            timestamp: timestamp
                        });
                        // Envia o log. Não precisamos esperar (await) a resposta do log para imprimir, 
                        // mas é bom garantir para evitar erros de validação depois.
                        await fetch(`${SCRIPT_URL}?${paramsCliente.toString()}`, { method: 'GET' });
                    }

                    // 5. IMPRIMIR (Dispara a janela do navegador UMA VEZ)
                    const clientName = selectedCrediarioClient ? selectedCrediarioClient.nomeExibicao : null;

                    if (format === 'a4') {
                        printA4(clientName);
                    } else {
                        printThermal(clientName);
                    }

                    // 6. ATUALIZAR A TELA (Pós-Impressão)
                    loadingOverlay.classList.add('hidden');
                    finishSaleBtn.disabled = false;
                    finishSaleBtn.innerHTML = "<i class='bx bx-check-circle'></i> Finalizar Venda (F9)";

                    // LÓGICA DE NAVEGAÇÃO:
                    if (selectedPaymentMethod === 'Crediário') {
                        // Se for Crediário, já imprimimos no passo 5.
                        // Então abrimos o modal DIRETO no Passo 2 (Validação), pulando o botão de imprimir.

                        credFlowClientName.textContent = selectedCrediarioClient.nomeExibicao;

                        // Esconde Passo 1 (Impressão)
                        document.getElementById('cred-step-1').style.display = 'none';

                        // Mostra Passo 2 (Validação)
                        const step2 = document.getElementById('cred-step-2');
                        step2.style.display = 'block';
                        step2.style.opacity = '1';
                        step2.classList.remove('locked-step');

                        // Atualiza QR Code (caso use) ou apenas prepara a tela
                        const qrImg = document.querySelector('#cred-step-2 .qr-img-wrapper img');
                        if (qrImg) {
                            const baseUrl = "http://eletrobusiness.com.br/comprovante/buy/valid55102.html";
                            const finalUrl = `${baseUrl}?id=${selectedCrediarioClient.idCliente}`;
                            qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(finalUrl)}`;
                        }

                        openModal(crediarioFlowModal);
                    } else {
                        // Se for Venda Comum, apenas mostra o Recibo de Sucesso
                        openModal(receiptModal);
                    }

                } catch (error) {
                    console.error("Erro fatal na venda:", error);
                    loadingOverlay.classList.add('hidden');
                    finishSaleBtn.disabled = false;
                    finishSaleBtn.innerHTML = "<i class='bx bx-check-circle'></i> Finalizar Venda (F9)";
                    showCustomAlert("Erro", "Falha ao registrar. Verifique sua conexão.");
                }
            }

            // 2. Botão Concluir Final (AGORA SÓ LIMPA A TELA)
            // Como já salvamos no passo anterior, este botão serve apenas para fechar o ciclo.
            btnFinishCrediarioFinal.addEventListener('click', () => {
                showCustomAlert("Sucesso", "Processo de crediário finalizado!");

                closeModal(crediarioFlowModal);

                // Limpa tudo e prepara para nova venda
                clearCart();
                selectedCrediarioClient = null;
                // Reseta botão de imprimir para a próxima vez
                btnForcePrint.disabled = false;
                btnForcePrint.innerHTML = "<i class='bx bx-printer'></i> Imprimir Comprovante";

                barcodeInput.focus();
            });

            cancelSaleBtn.addEventListener('click', () => { if (cart.length === 0) return; showCustomConfirm("Cancelar Venda", "Tem certeza?", () => { clearCart(); closeModal(confirmModal); }); });
            confirmActionBtn.addEventListener('click', () => { if (confirmCallback) { confirmCallback(); confirmCallback = null; } });
            document.querySelectorAll('.close-modal-btn').forEach(btn => { btn.addEventListener('click', (e) => { const modal = e.target.closest('.modal-overlay'); if (modal && modal.id !== 'receipt-modal' && modal.id !== 'open-caixa-modal') { closeModal(modal); if (modal.id === 'add-cliente-modal') { resetClienteModal(); } else if (modal.id === 'close-caixa-modal') { resetFecharCaixaModal(); } } }); });
            printReceiptBtn.addEventListener('click', handlePrintReceipt);
            newSaleBtn.addEventListener('click', () => { closeModal(receiptModal); clearCart(); barcodeInput.focus(); });
            quickAddName.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); quickAddPrice.focus(); } });
            quickAddPrice.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); quickAddSubmitBtn.click(); } });
            quickAddSubmitBtn.addEventListener('click', handleQuickAddSubmit);
            quickAddForm.addEventListener('submit', (e) => { e.preventDefault(); handleQuickAddSubmit(); });
            paymentOptions.forEach(option => { option.addEventListener('click', () => { handlePaymentSelection(option.dataset.method); }); });
            smartRoundingToggle.addEventListener('change', (e) => { isSmartRoundingEnabled = e.target.checked; if (discount > 0) { applyDiscount(discount, false); } });
            reloadCacheBtn.addEventListener('click', () => { showCustomConfirm("Recarregar Produtos", "Buscar lista recente?", () => { closeModal(confirmModal); carregarCacheDeProdutos(); }); });

            // Lógica da Navbar SPA (Atualizada)
            const updateNavbarHighlight = (activeItem) => { if (!activeItem) return; const itemRect = activeItem.getBoundingClientRect(); const navbarRect = mainNavbar.getBoundingClientRect(); navbarHighlight.style.width = `${itemRect.width}px`; navbarHighlight.style.left = `${itemRect.left - navbarRect.left}px`; };

            // --- CORREÇÃO DA NAVBAR (EVITA O ERRO RESOURCE EXHAUSTED) ---
            // --- Navegação SPA (Navbar) - CORRIGIDA ---
            navbarItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();

                    // 1. ATUALIZAÇÃO VISUAL DA NAVBAR
                    const previouslyActive = document.querySelector('.navbar-item.active');
                    if (previouslyActive === item && item.dataset.page !== 'pedidos') { return; }
                    
                    navbarItems.forEach(navItem => navItem.classList.remove('active'));
                    item.classList.add('active');
                    updateNavbarHighlight(item);

                    // 2. TROCA DE PÁGINA (VISIBILIDADE)
                    // Fazemos isso ANTES de qualquer lógica específica para garantir que o elemento exista e esteja visível
                    allPages.forEach(page => page.style.display = 'none');
                    const pageId = item.dataset.page + '-page';
                    const targetPage = document.getElementById(pageId);
                    
                    if (targetPage) targetPage.style.display = 'block';

                    // 3. LÓGICA ESPECÍFICA DE CADA PÁGINA
                    
                    // --- CORREÇÃO AQUI: RESET DA ABA PEDIDOS ---
                    if (item.dataset.page === 'pedidos') {
                        // Limpa notificações
                        item.classList.remove('notify-active');
                        const badge = document.getElementById('pedidos-badge');
                        if (badge) badge.classList.remove('active');

                        // Reseta Filtro
                        currentOrderStatusFilter = 'pendente';

                        // Reseta Abas Visuais
                        const orderTabs = document.querySelectorAll('#order-status-tabs .order-tab');
                        orderTabs.forEach(t => t.classList.remove('active'));
                        const defaultTab = document.querySelector('#order-status-tabs .order-tab[data-status="pendente"]');
                        if (defaultTab) defaultTab.classList.add('active');

                        // Renderiza (Agora vai funcionar pois a página já está display: block)
                        renderDummyOrders();
                    }

                    // Carregamentos das outras páginas
                    if (pageId === 'produtos-page' && !localProductCache) carregarCacheDeProdutos();
                    if (pageId === 'clientes-page' && !localClientCache) carregarClientesDaAPI();
                    if (pageId === 'historico-page') carregarHistorico();
                });
            });


            window.addEventListener('resize', () => { updateNavbarHighlight(document.querySelector('.navbar-item.active')); });

            // Listeners do Modal Adicionar Cliente
            addClienteBtn.addEventListener('click', () => { resetClienteModal(); openModal(addClienteModal); });
            clienteNextBtn.addEventListener('click', () => navigateClienteSteps(1));
            clientePrevBtn.addEventListener('click', () => navigateClienteSteps(-1));
            clienteSaveBtn.addEventListener('click', () => { if (!validateStep2()) return; const clienteData = { nomeCompleto: clienteNomeInput.value.trim(), apelido: clienteApelidoInput.value.trim(), telefone: clienteTelefoneInput.value.trim(), endereco: clienteEnderecoInput.value.trim(), valorCompra: compraValorInput.value, numParcelas: compraParcelasInput.value, primeiroVencimento: compraVencimentoInput.value }; salvarClienteNaAPI(clienteData); });
            addClienteForm.addEventListener('keydown', (e) => { if (e.key === 'Enter' && currentClienteStep === 2 && document.activeElement !== clienteEnderecoInput) { e.preventDefault(); clienteSaveBtn.click(); } });

            // Listeners dos Modais de Caixa
            headerCloseCaixaBtn.addEventListener('click', () => {
                resetFecharCaixaModal();
                openModal(closeCaixaModal);
            });

            // Submit Abrir Caixa
            openCaixaForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const abrirSemValor = openCaixaSemValorCheckbox.checked;
                const notasInput = openCaixaNotasInput.value.trim();
                const moedasInput = openCaixaMoedasInput.value.trim();
                const notas = parseFloat(notasInput) || 0;
                const moedas = parseFloat(moedasInput) || 0;

                if (!abrirSemValor && !notasInput && !moedasInput) {
                    showCustomAlert("Valor Inválido", "Informe Notas ou Moedas, ou marque 'Abrir sem valor'.");
                    if (!notasInput) openCaixaNotasInput.classList.add('input-error'); else openCaixaNotasInput.classList.remove('input-error');
                    if (!moedasInput) openCaixaMoedasInput.classList.add('input-error'); else openCaixaMoedasInput.classList.remove('input-error');
                    return;
                }
                if ((notasInput && notas < 0) || (moedasInput && moedas < 0)) {
                    showCustomAlert("Valor Inválido", "Valores não podem ser negativos.");
                    if (notasInput && notas < 0) openCaixaNotasInput.classList.add('input-error'); else openCaixaNotasInput.classList.remove('input-error');
                    if (moedasInput && moedas < 0) openCaixaMoedasInput.classList.add('input-error'); else openCaixaMoedasInput.classList.remove('input-error');
                    return;
                }

                openCaixaNotasInput.classList.remove('input-error');
                openCaixaMoedasInput.classList.remove('input-error');

                const data = {
                    valorNotas: abrirSemValor ? '0.00' : notas.toFixed(2),
                    valorMoedas: abrirSemValor ? '0.00' : moedas.toFixed(2)
                };
                abrirCaixaAPI(data);
            });

            // Listener para Checkbox Abrir sem Valor
            openCaixaSemValorCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                openCaixaNotasInput.disabled = isChecked;
                openCaixaMoedasInput.disabled = isChecked;
                openCaixaNotasInput.classList.remove('input-error');
                openCaixaMoedasInput.classList.remove('input-error');
                if (isChecked) {
                    openCaixaNotasInput.value = '0.00';
                    openCaixaMoedasInput.value = '0.00';
                } else {
                    openCaixaNotasInput.value = '';
                    openCaixaMoedasInput.value = '';
                }
            });

            // Listeners para Navegação Fechar Caixa
            closeCaixaNextBtn.addEventListener('click', () => navigateFecharCaixaSteps(1));
            closeCaixaPrevBtn.addEventListener('click', () => navigateFecharCaixaSteps(-1));

            // Submit Fechar Caixa (agora no botão Salvar)
            closeCaixaForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!validateFecharCaixaStep4()) return;
                if (!validateFecharCaixaStep3()) { // Revalida passo anterior
                    navigateFecharCaixaSteps(-1); // Volta se inválido
                    return;
                };

                const data = {
                    valorFinalNotas: (parseFloat(closeCaixaNotasInput.value) || 0).toFixed(2),
                    valorFinalMoedas: (parseFloat(closeCaixaMoedasInput.value) || 0).toFixed(2),
                    vendaCartao: (parseFloat(closeCaixaCartaoInput.value) || 0).toFixed(2),
                    vendaPixFixo: (parseFloat(closeCaixaPixInput.value) || 0).toFixed(2),
                    valorDeposito: (parseFloat(closeCaixaDepositoInput.value) || 0).toFixed(2),
                    valorFicaCaixa: (parseFloat(closeCaixaFicaInput.value) || 0).toFixed(2),
                    assinatura: closeCaixaAssinaturaInput.value.trim()
                };
                fecharCaixaAPI(data);
            });

            function updateClock() { if (horarioElement) { horarioElement.textContent = formatTime(new Date()); } }

            // Listener Global de Teclas de Atalho
            document.addEventListener('keydown', (e) => {
                const openModals = document.querySelectorAll('.modal-overlay.active');

                // Se Abrir Caixa está aberto, só permite Enter e Tab (e teclas de digitação)
                if (openCaixaModal.classList.contains('active')) {
                    if (e.key === 'Escape') {
                        e.preventDefault(); // Bloqueia Escape
                    } else if (e.key !== 'Enter' && e.key !== 'Tab' && !['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key) && e.target.tagName !== 'INPUT') {
                        // Permite Enter (para submit), Tab e Setas (navegação), e digitação nos inputs
                    } else if (e.key === 'Enter' && document.activeElement.closest('form') === openCaixaForm) {
                        // Deixa o Enter submeter
                    } else if (!['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) {
                        // Bloqueia outros atalhos se o foco não estiver num campo editável
                        // e.preventDefault(); // Comentado para testar se causa o bug de digitação
                    }
                    return;
                }


                if (openModals.length > 0) {
                    const topModal = openModals[openModals.length - 1];
                    if (topModal.id === 'discount-popover' && ['ArrowDown', 'ArrowRight', 'ArrowUp', 'ArrowLeft', 'Enter'].includes(e.key)) { /* ... Lógica setas desconto ... */ if (['ArrowDown', 'ArrowRight', 'ArrowUp', 'ArrowLeft'].includes(e.key)) { e.preventDefault(); } if (e.key === 'Enter' && document.activeElement === discountInputR) { e.preventDefault(); discountInputR.blur(); barcodeInput.focus(); return; } switch (e.key) { case 'ArrowDown': discountNavIndex = (discountNavIndex < 5) ? 5 : 0; break; case 'ArrowRight': discountNavIndex = (discountNavIndex < 4) ? discountNavIndex + 1 : (discountNavIndex === 4 ? 0 : 0); break; case 'ArrowUp': discountNavIndex = (discountNavIndex === 5) ? 0 : (discountNavIndex > 0 ? discountNavIndex - 1 : 5); break; case 'ArrowLeft': discountNavIndex = (discountNavIndex > 0 && discountNavIndex < 5) ? discountNavIndex - 1 : (discountNavIndex === 0 ? 4 : 4); break; case 'Enter': e.preventDefault(); const currentEl = discountNavElements[discountNavIndex]; if (currentEl && currentEl.tagName === 'BUTTON') currentEl.click(); break; } updateDiscountNavFocus(); return; }
                    else if (topModal.id === 'payment-modal') { switch (e.key) { case 'F6': e.preventDefault(); handlePaymentSelection('Dinheiro'); break; case 'F7': e.preventDefault(); handlePaymentSelection('PIX'); break; case 'F8': e.preventDefault(); handlePaymentSelection('Cartão'); break; case 'Escape': e.preventDefault(); closeModal(paymentModal); break; } return; }
                    else if (topModal.id === 'confirm-modal') { if (e.key === 'Enter') { e.preventDefault(); confirmActionBtn.click(); } if (e.key === 'Escape') { e.preventDefault(); closeModal(confirmModal); } return; }
                    else if (topModal.id === 'receipt-modal') { if (e.key === 'Enter' || e.key === 'Escape') { e.preventDefault(); newSaleBtn.click(); } return; }
                    else if (topModal.id === 'alert-modal') { if (e.key === 'Enter' || e.key === 'Escape') { e.preventDefault(); closeModal(alertModal); } return; }
                    else if (topModal.id === 'quick-add-modal') { if (e.key === 'Escape') { e.preventDefault(); closeModal(quickAddModal); } return; }
                    else if (topModal.id === 'add-cliente-modal') { if (e.key === 'Escape') { e.preventDefault(); closeModal(addClienteModal); resetClienteModal(); } return; }
                    else if (topModal.id === 'close-caixa-modal') {
                        if (e.key === 'Escape') { e.preventDefault(); closeModal(closeCaixaModal); resetFecharCaixaModal(); }
                        else if (e.key === 'Enter') {
                            if (closeCaixaNextBtn.style.display !== 'none') {
                                e.preventDefault(); closeCaixaNextBtn.click();
                            } else if (closeCaixaSaveBtn.style.display !== 'none' && document.activeElement !== closeCaixaAssinaturaInput) {
                                e.preventDefault(); // Submete o form via JS para garantir validação
                                closeCaixaForm.dispatchEvent(new Event('submit', { cancelable: true }));
                            }
                        }
                        return;
                    }
                } else if (openModals.length === 0) {
                    switch (e.key) {
                        case 'F2': e.preventDefault(); barcodeInput.focus(); barcodeInput.select(); break;
                        case 'F3': e.preventDefault(); discountToggleRow.click(); discountNavIndex = 0; updateDiscountNavFocus(); break;
                        case 'F4': e.preventDefault(); paymentToggleRow.click(); break;
                        case 'F8':
                            e.preventDefault();
                            if (verificarToken()) {
                                resetFecharCaixaModal();
                                openModal(closeCaixaModal);
                            } else {
                                showCustomAlert("Atenção", "Caixa precisa estar aberto.");
                            }
                            break;
                        case 'F9': e.preventDefault(); finishSaleBtn.click(); break;
                        case 'F10': e.preventDefault(); cancelSaleBtn.click(); break;
                    }
                }
            });

            // --- Inicialização ---
            renderCart(); resetPaymentMethod();
            updateClock(); setInterval(updateClock, 1000);

            // Lógica de Inicialização com Token
            if (verificarToken()) {
                console.log("Iniciando com token válido.");
                liberarSistema();
            } else {
                console.log("Iniciando sem token. Abrindo caixa...");
                loadingOverlay.classList.add('hidden');
                openCaixaForm.reset();
                openCaixaSemValorCheckbox.checked = false;
                openCaixaNotasInput.disabled = false;
                openCaixaMoedasInput.disabled = false;
                openModal(openCaixaModal);
            }

            // Define a aba ativa inicial e ajusta o highlight 
            const initialActivePage = 'pdv';
            const initialActiveNavbarItem = document.querySelector(`.navbar-item[data-page="${initialActivePage}"]`);
            if (initialActiveNavbarItem) {
                navbarItems.forEach(item => item.classList.remove('active'));
                initialActiveNavbarItem.classList.add('active');
                setTimeout(() => {
                    updateNavbarHighlight(initialActiveNavbarItem);
                    if (verificarToken()) {
                        allPages.forEach(page => page.style.display = 'none');
                        document.getElementById(initialActivePage + '-page').style.display = 'block';
                    }
                }, 50);
            }

            // --- Novas Variáveis Globais ---

            // --- LÓGICA DO GERENCIADOR FIREBASE ---

            // Seletores
            const btnLoadFirebase = document.getElementById('btn-load-firebase');
            const firebaseListContainer = document.getElementById('firebase-products-list');

            // Função Auxiliar de Limpeza de Valor (igual ao seu index.js)
            function parseValueFirebase(val) {
                if (!val) return 0;
                if (typeof val === 'number') return val;
                let str = String(val);
                str = str.replace(/[^\d,.-]/g, '');
                str = str.replace(',', '.');
                return parseFloat(str) || 0;
            }

            // Carregar Produtos
            btnLoadFirebase.addEventListener('click', async () => {
                firebaseListContainer.innerHTML = '<p style="text-align: center; padding: 20px;"><i class="bx bx-loader-alt bx-spin"></i> Conectando ao Firebase...</p>';

                try {
                    // Verifica se o objeto 'db' existe (SDK Firebase carregado)
                    if (typeof db === 'undefined') {
                        throw new Error("SDK do Firebase não encontrado. Verifique os scripts no <head>.");
                    }

                    const productsRef = db.collection('artifacts').doc(FIREBASE_CONFIG_ID)
                        .collection('users').doc(STORE_OWNER_UID)
                        .collection('products');

                    const snapshot = await productsRef.get();

                    if (snapshot.empty) {
                        firebaseListContainer.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum produto encontrado no banco de dados.</p>';
                        return;
                    }

                    firebaseListContainer.innerHTML = ''; // Limpa lista

                    snapshot.forEach(doc => {
                        const prod = doc.data();
                        const id = doc.id;
                        renderFirebaseRow(id, prod);
                    });

                } catch (error) {
                    console.error("Erro Firebase:", error);
                    firebaseListContainer.innerHTML = `<p style="text-align: center; color: var(--warning-red); padding: 20px;">Erro: ${error.message}</p>`;
                }
            });

            // Renderizar Linha
            // --- Renderizar Linha (Atualizado: Estoque + Design Novo) ---
            function renderFirebaseRow(id, prod) {
                // Dados Básicos
                const imgUrl = prod.imgUrl || 'https://placehold.co/100x100/f5f5f5/999?text=IMG';
                const name = prod.name || 'Produto sem nome';
                const currentCode = prod.code || '';
                // Pega o estoque atual (se não existir, assume 0)
                const currentStock = prod.stock !== undefined ? prod.stock : 0;

                // Cálculos de Preço
                const valNormal = parseValueFirebase(prod.price);
                const valOferta = parseValueFirebase(prod['price-oferta']);
                const hasOffer = (valOferta > 0 && valOferta < valNormal);

                let priceHtml = '';

                if (hasOffer) {
                    // Cálculo da Porcentagem
                    const percent = ((valNormal - valOferta) / valNormal) * 100;

                    // Design: Preço preto e tag limpa "-XX%"
                    priceHtml = `
            <div class="fb-old-price">${formatCurrency(valNormal)}</div>
            <div class="fb-new-price">
                ${formatCurrency(valOferta)}
                <span class="fb-discount-tag">-${Math.round(percent)}%</span>
            </div>
        `;
                } else {
                    priceHtml = `<div class="fb-new-price">${formatCurrency(valNormal)}</div>`;
                }

                // Criação do Elemento HTML
                const row = document.createElement('div');
                row.className = 'firebase-item-row';

                // Estrutura Grid: Produto | Preço | Estoque | Código | Botão
                row.innerHTML = `
        <div class="fb-prod-info">
            <img src="${imgUrl}" class="fb-prod-img" alt="Prod">
            <span class="fb-prod-name">${name}</span>
        </div>
        
        <div class="fb-price-box">
            ${priceHtml}
        </div>

        <div>
            <input type="number" class="fb-input-stock" id="input-stock-${id}" value="${currentStock}" min="0" placeholder="0">
        </div>

        <div>
            <input type="text" class="fb-input-code" id="input-code-${id}" value="${currentCode}" placeholder="Digite o código...">
        </div>

        <div style="text-align: center;">
            <button class="btn btn-primary" onclick="saveFirebaseProduct('${id}')" style="width: 40px; height: 40px; padding: 0; display: inline-flex; align-items: center; justify-content: center;" title="Salvar Alterações">
                <i class='bx bx-save'></i>
            </button>
        </div>
    `;

                firebaseListContainer.appendChild(row);
            }

            // --- Função para Salvar Código E Estoque ---
            window.saveFirebaseProduct = async (docId) => {
                // Seleciona os inputs baseados no ID do documento
                const codeInput = document.getElementById(`input-code-${docId}`);
                const stockInput = document.getElementById(`input-stock-${docId}`);
                const btn = codeInput.parentElement.nextElementSibling.querySelector('button');

                const newCode = codeInput.value.trim();
                const newStock = parseInt(stockInput.value) || 0; // Garante que é número

                // Feedback Visual (Loading)
                btn.disabled = true;
                btn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i>";

                try {
                    const productRef = db.collection('artifacts').doc(FIREBASE_CONFIG_ID)
                        .collection('users').doc(STORE_OWNER_UID)
                        .collection('products').doc(docId);

                    // Atualiza Código, Estoque e Data
                    await productRef.update({
                        code: newCode,
                        stock: newStock,
                        updatedAt: new Date().toISOString()
                    });

                    // Sucesso
                    btn.innerHTML = "<i class='bx bx-check'></i>";
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');

                    showToastFirebase("Produto atualizado!");

                    // Reseta botão após 2 segundos
                    setTimeout(() => {
                        btn.innerHTML = "<i class='bx bx-save'></i>";
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-primary');
                        btn.disabled = false;
                    }, 2000);

                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    btn.innerHTML = "<i class='bx bx-error'></i>";
                    btn.classList.add('btn-danger');
                    alert("Erro ao salvar: " + error.message);
                    btn.disabled = false;
                }
            };

            // Função Global para Salvar (chamada pelo botão HTML acima)
            window.saveBarcodeToFirebase = async (docId) => {
                const input = document.getElementById(`input-code-${docId}`);
                const btn = input.parentElement.nextElementSibling.querySelector('button');
                const newCode = input.value.trim();
                const originalIcon = btn.innerHTML;

                // Feedback Visual (Loading)
                btn.disabled = true;
                btn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i>";

                try {
                    const productRef = db.collection('artifacts').doc(FIREBASE_CONFIG_ID)
                        .collection('users').doc(STORE_OWNER_UID)
                        .collection('products').doc(docId);

                    // Atualiza apenas o campo 'code' e o 'updatedAt'
                    await productRef.update({
                        code: newCode,
                        updatedAt: new Date().toISOString()
                    });

                    // Sucesso
                    btn.innerHTML = "<i class='bx bx-check'></i>";
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');

                    // Toca um som ou mostra notificação (opcional)
                    showToastFirebase("Código atualizado com sucesso!");

                    // Reseta botão após 2 segundos
                    setTimeout(() => {
                        btn.innerHTML = "<i class='bx bx-save'></i>";
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-primary');
                        btn.disabled = false;
                    }, 2000);

                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    btn.innerHTML = "<i class='bx bx-error'></i>";
                    btn.classList.add('btn-danger');
                    alert("Erro ao salvar no Firebase: " + error.message);
                    btn.disabled = false;
                }
            };

            // Pequeno Toast para feedback (opcional, pode usar o seu showCustomAlert)
            function showToastFirebase(msg) {
                // Se você já tiver uma função de toast, use ela. Senão, cria uma simples:
                const div = document.createElement('div');
                div.style.cssText = "position:fixed; bottom:20px; right:20px; background:#333; color:#fff; padding:12px 24px; border-radius:8px; z-index:9999; animation: slideInUp 0.3s;";
                div.textContent = msg;
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 3000);
            }


            let currentSelectedClientId = null;

            // --- Seletores dos Novos Modais ---
            const clienteDetailsModal = document.getElementById('cliente-details-modal');
            const clientePayModal = document.getElementById('cliente-pay-modal');
            const clientePayForm = document.getElementById('cliente-pay-form');

            // --- Seletores da Barra de Limite ---
            const detailLimitTotal = document.getElementById('detail-cliente-limite-total');
            const detailProgressBar = document.getElementById('detail-cliente-progress');
            const detailLimitAvailable = document.getElementById('detail-cliente-disponivel');
            const detailLimitPercent = document.getElementById('detail-cliente-percentual');
            const btnAlterarLimite = document.getElementById('btn-alterar-limite');

            // --- Função Lógica de Abrir Modal de Detalhes (ATUALIZADA COM HISTÓRICO) ---
            const openClienteDetails = async (id) => {
                const cliente = localClientCache.find(c => c.idCliente == id);
                if (!cliente) return;

                // 1. Preenche dados básicos (Síncrono - Instantâneo)
                document.getElementById('detail-cliente-nome').textContent = cliente.nomeCompleto || cliente.nomeExibicao;
                document.getElementById('detail-cliente-apelido').textContent = cliente.apelido || 'Sem apelido';
                document.getElementById('detail-cliente-saldo').textContent = formatCurrency(cliente.saldoDevedor);
                document.getElementById('detail-cliente-vencimento').textContent = cliente.proximoVencimento || '--/--/----';
                document.getElementById('detail-cliente-telefone').textContent = cliente.telefone || 'Não informado';
                document.getElementById('detail-cliente-endereco').textContent = cliente.endereco || 'Não informado';

                // 2. Atualiza Barra de Limite
                const limite = parseFloat(cliente.limite) || 0;
                const saldo = parseFloat(cliente.saldoDevedor) || 0;
                detailLimitTotal.textContent = formatCurrency(limite);

                if (limite > 0) {
                    const disponivel = limite - saldo;
                    const porcentagemUso = (saldo / limite) * 100;

                    detailLimitAvailable.textContent = `Disponível: ${formatCurrency(disponivel)}`;
                    detailLimitPercent.textContent = `${porcentagemUso.toFixed(1)}% usado`;

                    let width = porcentagemUso > 100 ? 100 : (porcentagemUso < 0 ? 0 : porcentagemUso);
                    detailProgressBar.style.width = `${width}%`;

                    detailProgressBar.className = 'progress-fill';
                    if (disponivel < 0) {
                        detailProgressBar.classList.add('danger');
                        detailLimitAvailable.style.color = 'var(--warning-red)';
                    } else {
                        detailLimitAvailable.style.color = 'var(--success-green)';
                    }
                } else {
                    detailProgressBar.style.width = '0%';
                    detailLimitAvailable.textContent = "Ilimitado";
                    detailLimitPercent.textContent = "-";
                }

                // 3. Abre o modal
                openModal(clienteDetailsModal);

                // 4. Carrega o Histórico (Assíncrono - Loading)
                const historyContainer = document.getElementById('detail-history-container');
                historyContainer.innerHTML = '<p style="text-align:center; padding:20px; color:#777;"><i class="bx bx-loader-alt bx-spin"></i> Buscando histórico...</p>';

                try {
                    const response = await fetch(`${SCRIPT_URL}?action=obterHistorico&idCliente=${id}`);
                    const result = await response.json();

                    if (result.status === 'success' && result.data.length > 0) {
                        let html = '<table class="history-table"><thead><tr><th>Data</th><th>Tipo</th><th>Valor</th><th>Anexo</th></tr></thead><tbody>';

                        result.data.forEach(item => {
                            const isCompra = item.valor > 0; // Positivo = Dívida (Compra)
                            const tipoClass = isCompra ? 'type-compra' : 'type-pagamento';
                            const valorColor = isCompra ? 'var(--warning-red)' : 'var(--success-green)';

                            // Ícone de anexo se houver link
                            let anexoHtml = '-';
                            if (item.anexo && item.anexo.startsWith('http')) {
                                anexoHtml = `<button class="btn-link-receipt" onclick="window.openReceiptViewer('${item.anexo}')" style="background:none; border:none; font-family:inherit; font-size:inherit; cursor:pointer;" title="Ver Comprovante"><i class='bx bx-show'></i> Ver</button>`;
                            }

                            html += `
                            <tr>
                                <td>${item.data}<br><small style="color:#999">${item.obs || ''}</small></td>
                                <td><span class="history-type-tag ${tipoClass}">${isCompra ? 'COMPRA' : 'PAGTO'}</span></td>
                                <td style="color:${valorColor}; font-weight:600;">${formatCurrency(Math.abs(item.valor))}</td>
                                <td>${anexoHtml}</td>
                            </tr>
                        `;
                        });
                        html += '</tbody></table>';
                        historyContainer.innerHTML = html;
                    } else {
                        historyContainer.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Nenhum histórico encontrado.</p>';
                    }
                } catch (error) {
                    console.error("Erro histórico:", error);
                    historyContainer.innerHTML = '<p style="text-align:center; padding:20px; color:var(--warning-red);">Erro ao carregar.</p>';
                }
            };

            // --- Listener para o Botão Alterar Limite ---
            if (btnAlterarLimite) {
                btnAlterarLimite.addEventListener('click', () => {
                    showCustomAlert(
                        "Acesso Restrito",
                        "Somente um administrador pode alterar o limite de crédito de forma segura no momento."
                    );
                });
            }

            // --- Lógica de Abrir Modal de Pagamento ---
            const openClientePayment = (id) => {
                const cliente = localClientCache.find(c => c.idCliente == id);
                if (!cliente) return;

                currentSelectedClientId = id;

                // Preenche info básica
                document.getElementById('pay-cliente-nome').textContent = cliente.nomeExibicao;
                document.getElementById('pay-cliente-saldo-atual').textContent = formatCurrency(cliente.saldoDevedor);

                // Reseta form e foca no valor
                clientePayForm.reset();
                openModal(clientePayModal);
            };

            // --- Função Atualizada: Fluxo de Caixa + Abatimento de Dívida ---
            async function registrarPagamentoClienteAPI(cliente, valor, metodo) {
                // Validação das URLs
                if (!REGISTRO_VENDA_SCRIPT_URL || REGISTRO_VENDA_SCRIPT_URL.includes("COLE_A_URL")) {
                    throw new Error("URL de registro de vendas não configurada.");
                }
                if (!SCRIPT_URL || SCRIPT_URL.includes("COLE_A_URL")) {
                    throw new Error("URL de script de clientes não configurada.");
                }

                const now = new Date();
                const timestamp = formatTimestamp(now);
                const descricaoAutomatica = `Crediário ${cliente.nomeExibicao}`;

                // --- PREPARAÇÃO REQUISIÇÃO 1: FLUXO DE CAIXA (Vendas) ---
                const vendaData = {
                    formType: 'venda',
                    seller: 'nubia',
                    type: 'entrada',
                    value: valor.toFixed(2), // Valor Positivo (Entrou dinheiro)
                    desconto: '0.00',
                    Timestamp: timestamp,
                    payment: metodo,
                    total: valor.toFixed(2),
                    description: descricaoAutomatica,
                    obs: `Recebimento ID: ${cliente.idCliente}`
                };
                const formVenda = new URLSearchParams(vendaData);

                // --- PREPARAÇÃO REQUISIÇÃO 2: ABATIMENTO DÍVIDA (Clientes) ---
                // Envia valor negativo para reduzir o saldo devedor na planilha
                const valorAbatimento = (valor * -1).toFixed(2);

                const paramsCliente = new URLSearchParams({
                    action: 'registrarTransacao', // Nome da ação que seu Google Script deve esperar
                    idCliente: cliente.idCliente,
                    tipo: 'Pagamento',
                    valor: valorAbatimento,       // Ex: -50.00
                    timestamp: timestamp
                });

                console.log("Processando Pagamento Duplo...");

                // --- DISPARO SIMULTÂNEO (Promise.all) ---
                // Dispara as duas requisições ao mesmo tempo para ser mais rápido
                const [resVenda, resCliente] = await Promise.all([
                    // 1. Post no Fluxo de Caixa
                    fetch(REGISTRO_VENDA_SCRIPT_URL, {
                        redirect: "follow",
                        method: "POST",
                        body: formVenda.toString(),
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    }),
                    // 2. Get no Script de Clientes (seguindo o padrão de salvarCliente)
                    fetch(`${SCRIPT_URL}?${paramsCliente.toString()}`, {
                        method: 'GET'
                    })
                ]);

                // Verificação de Erros
                if (!resVenda.ok) {
                    throw new Error(`Erro no Registro de Venda: ${resVenda.status}`);
                }
                if (!resCliente.ok) {
                    // Tentamos ler o erro se possível
                    throw new Error(`Erro no Abatimento da Dívida: ${resCliente.status}`);
                }

                // Opcional: Ler a resposta do cliente para garantir que o script processou "success"
                const resultCliente = await resCliente.json();
                if (resultCliente.status !== 'success') {
                    console.warn("Aviso do Script Cliente:", resultCliente.message);
                    // Não vamos jogar erro aqui se a venda passou, apenas logar o aviso
                }

                return true;
            }

            // --- Listener Otimizado do Submit de Pagamento ---
            clientePayForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const valorInput = document.getElementById('pay-valor');
                const valorPago = parseFloat(valorInput.value);
                const metodo = document.getElementById('pay-metodo').value;
                const submitBtn = clientePayForm.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;

                if (!currentSelectedClientId) return;
                if (isNaN(valorPago) || valorPago <= 0) {
                    showCustomAlert("Valor Inválido", "Insira um valor maior que zero.");
                    return;
                }

                // Encontrar o cliente no cache local
                const cliente = localClientCache.find(c => c.idCliente == currentSelectedClientId);
                if (!cliente) {
                    showCustomAlert("Erro", "Cliente não encontrado no cache.");
                    return;
                }

                // 1. Estado de Carregamento (Bloqueia botão)
                submitBtn.disabled = true;
                submitBtn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Processando...";

                try {
                    // 2. Envia para o Google Sheets
                    await registrarPagamentoClienteAPI(cliente, valorPago, metodo);

                    // 3. Atualiza o Cache Local (Otimismo)
                    // Subtrai o valor pago do saldo devedor visualmente
                    let novoSaldo = parseFloat(cliente.saldoDevedor) - valorPago;
                    cliente.saldoDevedor = novoSaldo < 0 ? 0 : novoSaldo; // Evita negativo se pagar a mais

                    // 4. Atualiza a Tabela e Fecha Modal
                    renderClientesPage(); // Re-renderiza a lista com o novo saldo
                    closeModal(clientePayModal);
                    showCustomAlert("Sucesso", `Pagamento de ${formatCurrency(valorPago)} registrado para ${cliente.nomeExibicao}!`);

                } catch (error) {
                    console.error("Erro ao registrar pagamento:", error);
                    showCustomAlert("Erro", "Falha ao registrar o pagamento. Tente novamente.");
                } finally {
                    // 5. Restaura o botão
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            });


            // ============================================================
            // FUNÇÕES DO MODAL DE PEDIDOS (Adicionar no final do DOMContentLoaded)
            // ============================================================

            let currentOpenOrder = null; // Variável local para saber qual pedido está aberto

            // 1. Função para Abrir o Modal (Lógica de Navegação Corrigida)
            // 1. Função para Abrir o Modal (ATUALIZADA COM STATUS DE RETIRADA)
        window.openOrderDetailModal = (orderId) => {
            const order = activeOrdersData.find(o => o.id === orderId);
            if (!order) return;

            currentOpenOrder = order;

            document.getElementById('modal-order-id').textContent = `#${order.displayId}`;
            document.getElementById('modal-order-client').textContent = order.client;
            // O address já vem com o ícone HTML da função anterior, então usamos innerHTML
            document.getElementById('modal-order-address').innerHTML = order.address;
            document.getElementById('modal-calc-total').textContent = order.total;
            
            // Preenche lista de itens
            const itemsContainer = document.getElementById('modal-order-items-list');
            itemsContainer.innerHTML = '';
            const divItem = document.createElement('div');
            divItem.className = 'modal-order-item';
            divItem.innerHTML = `<span class="item-info-text">${order.items}</span>`;
            itemsContainer.appendChild(divItem);

            // --- LÓGICA DO STEPPER ADAPTÁVEL (ENTREGA vs RETIRADA) ---
            
            // 1. Ajusta os Textos e Ícones baseados no modo de envio
            const stepEnviado = document.getElementById('step-enviado');
            const stepFinalizado = document.getElementById('step-finalizado');
            
            if (order.shippingMode === 'pickup') {
                // Modo Retirada
                if(stepEnviado) {
                    stepEnviado.querySelector('span').textContent = "Pronto p/ Retirada";
                    stepEnviado.querySelector('.step-icon').innerHTML = "<i class='bx bxs-store'></i>";
                    stepEnviado.title = "Mudar para Pronto p/ Retirada";
                }
                if(stepFinalizado) {
                    stepFinalizado.querySelector('span').textContent = "Retirado";
                    stepFinalizado.title = "Mudar para Retirado";
                }
            } else {
                // Modo Entrega (Padrão)
                if(stepEnviado) {
                    stepEnviado.querySelector('span').textContent = "Enviado";
                    stepEnviado.querySelector('.step-icon').innerHTML = "<i class='bx bx-car'></i>";
                    stepEnviado.title = "Mudar para Enviado";
                }
                if(stepFinalizado) {
                    stepFinalizado.querySelector('span').textContent = "Entregue";
                    stepFinalizado.title = "Mudar para Entregue";
                }
            }

            // 2. Aplica as classes Active/Completed/Locked
            const steps = ['pendente', 'preparando', 'enviado', 'finalizado'];
            let currentStatus = order.status.toLowerCase();
            // Normalização
            if (currentStatus === 'approved') currentStatus = 'pendente';
            if (currentStatus === 'preparation') currentStatus = 'preparando';
            if (currentStatus === 'shipped') currentStatus = 'enviado';
            if (currentStatus === 'delivered') currentStatus = 'finalizado';

            const currentIndex = steps.indexOf(currentStatus);

            steps.forEach((stepName, index) => {
                const el = document.getElementById(`step-${stepName}`);
                if (el) {
                    el.classList.remove('active', 'completed', 'locked');
                    el.onclick = null; 

                    if (index < currentIndex) {
                        el.classList.add('completed');
                        el.onclick = () => manualSetStatus(stepName);
                    } 
                    else if (index === currentIndex) {
                        el.classList.add('active');
                        el.style.cursor = 'default';
                    } 
                    else {
                        el.classList.add('locked');
                    }
                }
            });

            openModal(document.getElementById('order-details-modal'));
        };

            // 2. Função para Mudar Status Manualmente
            window.manualSetStatus = async (targetUiStatus) => {
                if (!currentOpenOrder) return;

                // Mapeamento Inverso
                const mapStatusUIToFirebase = (uiStatus) => {
                    if (uiStatus === 'pendente') return 'approved';
                    if (uiStatus === 'preparando') return 'preparation';
                    if (uiStatus === 'enviado') return 'shipped';
                    if (uiStatus === 'finalizado') return 'delivered';
                    return uiStatus; // Fallback
                };

                const newFbStatus = mapStatusUIToFirebase(targetUiStatus);
                const btn = document.getElementById('btn-update-status');
                const originalText = btn.innerHTML;

                // Verifica se clicou no status que já está
                if (currentOpenOrder.status === targetUiStatus) return;

                btn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Atualizando...";
                btn.disabled = true;

                try {
                    // Atualiza APENAS o status para evitar sobrescrever outros dados
                    await db.collection('orders').doc(currentOpenOrder.id).update({
                        status: newFbStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp() // Usa timestamp do servidor
                    });

                    // Atualiza visualmente o objeto local para refletir na hora sem esperar o listener
                    currentOpenOrder.status = targetUiStatus;

                    // Recarrega o visual do modal para pintar as bolinhas certas
                    window.openOrderDetailModal(currentOpenOrder.id);

                    // O listener global (startOrderPolling) vai atualizar a lista de trás automaticamente

                } catch (error) {
                    console.error("Erro status:", error);
                    // Se der erro de cota, avisa amigavelmente
                    if (error.code === 'resource-exhausted') {
                        showCustomAlert("Erro de Cota", "Muitas atualizações recentes. Aguarde um momento.");
                    } else {
                        showCustomAlert("Erro", "Falha ao atualizar status.");
                    }
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            };
            // 3. Botão "Avançar Status" (Lógica sequencial)
            const btnUpdateStatus = document.getElementById('btn-update-status');
            if (btnUpdateStatus) {
                btnUpdateStatus.onclick = () => {
                    if (!currentOpenOrder) return;
                    const steps = ['pendente', 'preparando', 'enviado', 'finalizado'];
                    const currentIndex = steps.indexOf(currentOpenOrder.status);

                    if (currentIndex < steps.length - 1) {
                        const nextStatus = steps[currentIndex + 1];
                        window.manualSetStatus(nextStatus);
                    } else {
                        alert("Pedido já finalizado.");
                    }
                };
            }
        });
    </script>

    <style>
        /* ======================================== */
        /* == ESTILOS GLOBAIS E VARIÁVEIS        == */
        /* ======================================== */

        :root {
            --primary-red: #db0038;
            --primary-red-dark: #c00030;
            --bg-light: #FAFAFA;
            --card-white: #FFFFFF;
            --text-dark: #222222;
            --text-light: #777777;
            --border-color: #F0F0F0;
            --success-green: #28a745;
            --warning-red: #E53935;
            --info-blue: #d21919;
            --black-friday: #000000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            display: block;
            min-height: 100vh;
            padding-bottom: 60px;
            position: relative;
        }

        /* Overlay de Carregamento Inicial / Bloqueio */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            /* Começa visível */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            text-align: center;
            color: var(--text-dark);
            transition: opacity 0.3s ease;
        }

        #loading-overlay i {
            font-size: 48px;
            color: var(--primary-red);
            margin-bottom: 16px;
        }

        #loading-overlay p {
            font-size: 1.2rem;
            font-weight: 600;
        }

        #loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            /* Garante que não interfira com cliques */
        }


        /* ======================================== */
        /* == ANIMAÇÕES                          == */
        /* ======================================== */

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes flash {
            0% {
                background-color: rgba(219, 0, 56, 0.1);
            }

            100% {
                background-color: transparent;
            }
        }

        .new-item-flash {
            animation: flash 0.5s ease-out;
        }

        @keyframes pop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .pop-animation {
            animation: pop 0.3s ease-out;
        }

        @keyframes bx-spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .bx-spin {
            animation: bx-spin 1s linear infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.5);
                opacity: 0.5;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* ======================================== */
        /* == ESTILOS DE ATALHO / ACESSIBILIDADE == */
        /* ======================================== */

        .shortcut-hint {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 8px;
            padding-left: 4px;
            transition: opacity 0.2s ease;
        }

        .nav-focus {
            outline: 2px solid var(--info-blue) !important;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.3) !important;
            border-radius: 8px;
        }

        .discount-nav-hint {
            display: none;
            font-size: 0.85rem;
            color: var(--info-blue);
            font-weight: 500;
            margin-top: 8px;
            text-align: center;
        }

        /* ======================================== */
        /* == ESTILOS DE DESCONTO E PAGAMENTO    == */
        /* ======================================== */
        .summary-row-interactive {
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-radius: 8px;
            padding: 8px 0;
            margin: -8px 0;
        }

        .summary-row-interactive:hover {
            background-color: var(--bg-light);
        }

        .summary-row .value.editable {
            color: var(--primary-red);
            font-weight: 600;
            text-decoration: underline dashed 1px;
            text-underline-offset: 4px;
        }

        .discount-popover {
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease-out;
            background-color: var(--bg-light);
            padding: 0 16px;
            margin: 8px 0;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .discount-popover.active {
            max-height: 300px;
            padding: 16px 16px;
        }

        .discount-popover label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .discount-popover-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .discount-perc-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .perc-btn {
            flex-grow: 1;
            padding: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 8px;
            border: 1px solid #ddd;
            background-color: var(--card-white);
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .perc-btn:hover {
            background-color: var(--primary-red);
            border-color: var(--primary-red);
            color: white;
        }

        .btn-remove-discount {
            background: none;
            border: none;
            color: var(--warning-red);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px;
            width: 100%;
            justify-content: center;
            border: 1px dashed transparent;
        }

        .btn-remove-discount:hover {
            text-decoration: underline;
        }

        .btn-remove-discount.nav-focus {
            border: 1px dashed var(--info-blue);
            background-color: var(--card-white);
        }

        .effective-discount-display {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 500;
            margin-top: 12px;
            min-height: 1.2em;
        }

        .effective-discount-display i {
            color: var(--text-light);
        }

        /* ======================================== */
        /* == TOOLTIPS                           == */
        /* ======================================== */

        .tooltip {
            position: relative;
            display: block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: max-content;
            max-width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 10;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* ======================================== */
        /* == HEADER E NAVBAR                    == */
        /* ======================================== */

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .app-header h1 {
            margin-bottom: 0;
        }

        #header-close-caixa-btn {
            width: auto;
            padding: 10px 16px;
            font-size: 0.9rem;
            margin-top: 0;
        }

        .navbar {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 24px;
            position: relative;
        }

        .navbar-item {
            padding: 12px 0;
            text-decoration: none;
            color: var(--text-light);
            font-weight: 600;
            position: relative;
            transition: color 0.2s ease;
            cursor: pointer;
            white-space: nowrap;
        }

        .navbar-item:hover {
            color: var(--text-dark);
        }

        .navbar-item.active {
            color: var(--primary-red);
        }

        .navbar-highlight {
            position: absolute;
            bottom: -1px;
            height: 3px;
            background-color: var(--primary-red);
            transition: left 0.3s ease, width 0.3s ease;
            border-radius: 2px;
        }

        /* ======================================== */
        /* == CONTEÚDO PRINCIPAL (PDV)           == */
        /* ======================================== */

        .main-content {
            width: 100%;
            height: 100%;
            padding: 32px;
            overflow-y: auto;
            display: none;
            /* Começa oculto */
        }

        .page-content {
            animation: slideInUp 0.5s ease-out;
        }

        .page-content h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .pdv-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            min-height: calc(100vh - 200px - 60px);
        }

        .pdv-main {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .card {
            background-color: var(--card-white);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            padding: 24px;
        }

        .barcode-scanner {
            position: relative;
        }

        .barcode-scanner i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .barcode-scanner input {
            width: 100%;
            padding: 18px 18px 18px 50px;
            font-size: 1rem;
            border-radius: 12px;
            border: 1px solid #ddd;
            transition: all 0.2s ease;
        }

        .barcode-scanner input:disabled {
            background-color: #f9f9f9;
            cursor: wait;
        }

        .barcode-scanner input:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(219, 0, 56, 0.2);
        }

        .item-list-container {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            background-color: var(--card-white);
            padding: 0;
        }

        .item-list-container.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: var(--text-light);
            min-height: 300px;
        }

        .item-list-container.empty span {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .item-list-table {
            width: 100%;
            border-collapse: collapse;
        }

        .item-list-table th,
        .item-list-table td {
            padding: 16px;
            text-align: left;
        }

        .item-list-table thead {
            border-bottom: 1px solid var(--border-color);
            background-color: #fdfdfd;
        }

        .item-list-table th {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-light);
            font-weight: 600;
        }

        .item-list-table tbody tr {
            border-bottom: 1px solid var(--border-color);
        }

        .item-list-table tbody tr:last-child {
            border-bottom: none;
        }

        .product-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .product-image {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background-color: var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            flex-shrink: 0;
        }

        .product-details .name {
            font-weight: 600;
            color: var(--text-dark);
        }

        .product-details .barcode {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qty-btn {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-dark);
            transition: all 0.2s ease;
        }

        .qty-btn:hover {
            background-color: #eee;
        }

        .qty-display {
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .item-price {
            font-weight: 500;
        }

        .item-total {
            font-weight: 600;
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .remove-btn:hover {
            color: var(--warning-red);
            background-color: #FFEBEE;
        }

        .pdv-summary .card {
            padding: 24px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .pdv-summary h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 16px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 1rem;
            margin-bottom: 16px;
        }

        .summary-row .label {
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-row .value {
            font-weight: 500;
        }

        .summary-total {
            border-top: 1px dashed var(--border-color);
            padding-top: 24px;
            margin-top: auto;
        }

        .summary-total .label {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .summary-total .value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-red);
            transition: transform 0.2s ease;
        }

        .btn {
            font-family: 'Inter', sans-serif;
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            background-color: #ccc;
            color: #888;
            cursor: not-allowed;
        }

        .btn-primary:disabled {
            background-color: #f0a0b8;
            color: #fff;
        }

        .btn-secondary:disabled {
            background-color: #eee;
            color: #aaa;
            border-color: #ddd;
        }

        .btn-primary {
            background-color: var(--primary-red);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-red-dark);
        }

        .btn-secondary {
            background-color: var(--card-white);
            color: var(--text-dark);
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background-color: var(--bg-light);
        }

        .btn-danger {
            background-color: var(--primary-red);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c90000;
        }

        .btn-success {
            background-color: var(--success-green);
            color: white;
        }

        .btn-success:hover {
            background-color: #1e7e34;
        }


        /* ======================================== */
        /* == MODAIS                             == */
        /* ======================================== */

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: grid;
            place-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-white);
            border-radius: 16px;
            padding: 0;
            width: 100%;
            max-width: 550px;
            /* Define a altura máxima como 90% da altura da tela */
            max-height: 90vh;
            /* Cria um layout flexível para manter cabeçalho e rodapé fixos */
            display: flex;
            flex-direction: column;

            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: scale(0.95) translateY(10px);
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            /* Impede que o cabeçalho encolha */
            flex-shrink: 0;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .close-modal-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-light);
            padding: 4px;
            line-height: 1;
        }

        .modal-body {
            padding: 24px;
            /* Permite scroll vertical apenas nesta área */
            overflow-y: auto;
            /* Faz o corpo ocupar todo o espaço disponível */
            flex-grow: 1;
        }

        .modal-body p {
            color: var(--text-light);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 14px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            border-radius: 8px;
            border: 1px solid #ddd;
            resize: vertical;
        }

        .form-group input[type="number"]::-webkit-inner-spin-button,
        .form-group input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .form-group input[type="number"] {
            -moz-appearance: textfield;
        }

        .form-group input:disabled,
        .form-group textarea:disabled,
        .form-group select:disabled {
            background-color: #f5f5f5;
            color: #aaa;
            cursor: not-allowed;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(219, 0, 56, 0.2);
        }

        .modal-footer {
            padding: 20px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-top: 1px solid var(--border-color);
            background-color: #f9f9f9;
            /* Impede que o rodapé encolha */
            flex-shrink: 0;
        }

        /* Modal de Pagamento */
        .payment-options {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .payment-option {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .payment-option:hover,
        .payment-option.selected,
        .payment-option.nav-focus {
            border-color: var(--primary-red);
            background-color: rgba(219, 0, 56, 0.05);
            color: var(--primary-red);
        }

        .payment-option span {
            font-weight: 600;
        }

        /* Pagamento Dividido */
        .split-payment-area {
            margin-top: 24px;
            border-top: 1px dashed var(--border-color);
            padding-top: 24px;
        }

        .split-payment-area h4 {
            font-weight: 600;
            margin-bottom: 16px;
        }

        .split-payment-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 12px;
            align-items: end;
        }

        .split-payment-remaining {
            text-align: right;
            font-weight: 600;
            color: var(--primary-red);
            margin-top: 8px;
        }

        /* Modal Recibo / Confirmação / Alerta */
        .modal-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            margin: 0 auto 24px auto;
        }

        .modal-icon.success {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success-green);
        }

        .modal-icon.danger {
            background-color: rgba(229, 57, 53, 0.1);
            color: var(--warning-red);
        }

        .modal-icon.info {
            background-color: rgba(25, 118, 210, 0.1);
            color: var(--info-blue);
        }

        .modal-body.centered {
            text-align: center;
        }

        /* Modal Adicionar Cliente / Fechar Caixa (Multi-Step) */
        .multi-step-form .form-step {
            display: none;
        }

        .multi-step-form .form-step.active {
            display: block;
            animation: slideInUp 0.3s ease-out;
        }

        .modal-progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background-color: var(--primary-red);
            transition: width 0.3s ease;
        }

        .modal-footer-multi-step {
            justify-content: space-between;
        }

        .input-error {
            border-color: var(--warning-red) !important;
            box-shadow: 0 0 0 3px rgba(229, 57, 53, 0.2) !important;
        }

        /* Modais de Caixa */
        .caixa-options {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .caixa-options .btn {
            margin-top: 0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Toggle Switch UI */
        .toggle-switch-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
            cursor: pointer;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary-red);
        }

        input:focus+.slider {
            box-shadow: 0 0 1px var(--primary-red);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        .toggle-switch-group label {
            margin-bottom: 0;
            font-weight: normal;
            color: var(--text-light);
            cursor: pointer;
        }

        /* ======================================== */
        /* == PÁGINAS ADICIONAIS                 == */
        /* ======================================== */

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background-color: var(--bg-light);
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .data-table td {
            font-weight: 500;
            vertical-align: middle;
        }

        .data-table td:first-child {
            font-weight: 600;
            color: var(--text-dark);
        }

        .data-table .currency {
            text-align: right;
        }

        .data-table .actions {
            text-align: center;
        }

        .data-table .actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-light);
            padding: 4px;
        }

        .data-table .actions button:hover {
            color: var(--primary-red);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-info {
            max-width: 70%;
        }

        .setting-info h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .setting-info p {
            font-size: 0.9rem;
            color: var(--text-light);
            line-height: 1.5;
        }

        /* Reutilizando a classe toggle-switch para configurações */

        /* ======================================== */
        /* == ESTILOS DO RELÓGIO                 == */
        /* ======================================== */
        .pn {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--card-white);
            border-top: 1px solid var(--border-color);
            padding: 10px 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            z-index: 500;
        }

        .pn-hr {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading1 {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success-green);
            animation: pulse 1.5s infinite ease-in-out;
        }

        .horario {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 1rem;
        }

        /* ======================================== */
        /* == RESPONSIVIDADE                     == */
        /* ======================================== */

        @media (max-width: 1024px) {
            .pdv-layout {
                grid-template-columns: 1fr;
                height: auto;
            }

            .pdv-summary .card {
                height: auto;
            }

            .main-content {
                padding: 24px;
            }

            body {
                padding-bottom: 50px;
            }

            .pn {
                padding: 8px 16px;
            }

            .horario {
                font-size: 0.9rem;
            }

            .modal-content {
                max-width: 90%;
            }
        }

        @media (max-width: 768px) {
            body {
                display: block;
                padding-bottom: 40px;
            }

            .sidebar {
                display: none;
            }

            .main-content {
                padding: 16px;
                height: auto;
                min-height: 100vh;
                width: 100%;
            }

            .app-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .app-header h1 {
                font-size: 1.5rem;
            }

            #header-close-caixa-btn {
                width: 100%;
            }

            .pdv-layout {
                min-height: auto;
                gap: 16px;
            }

            .modal-content {
                max-width: 95%;
                padding: 0;
            }

            .modal-header,
            .modal-body,
            .modal-footer {
                padding: 16px;
            }

            .payment-options {
                grid-template-columns: 1fr;
            }

            .navbar {
                gap: 16px;
                margin-bottom: 16px;
                overflow-x: auto;
            }

            .navbar-item {
                font-size: 0.9rem;
                white-space: nowrap;
            }

            .pn {
                justify-content: center;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .page-header .btn {
                width: 100%;
            }

            .data-table {
                font-size: 0.9rem;
            }

            .data-table th,
            .data-table td {
                padding: 8px 10px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .split-payment-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .toggle-switch-group {
                flex-direction: row-reverse;
                justify-content: flex-end;
            }
        }

        /* ======================================== */
        /* == ESTILOS BLACK FRIDAY (FAIXA TOPO)  == */
        /* ======================================== */

        /* Ajuste para o conteúdo não ficar escondido atrás da faixa */
        body {
            padding-top: 40px;
            /* Mesma altura da faixa */
        }

        .bf-top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background-color: #000000;
            /* Fundo Preto */
            color: #ffffff;
            /* Texto Branco (ou mude para #FFD700 para Dourado) */
            z-index: 1500;
            /* Acima do cabeçalho, abaixo do overlay de loading */
            overflow: hidden;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            border-bottom: 2px solid #db0038;
            /* Uma linha fina vermelha para combinar com seu sistema */
        }

        .bf-track {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
        }

        .bf-content {
            display: inline-block;
            padding-left: 100%;
            /* Começa fora da tela */
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: marquee-top 20s linear infinite;
        }

        /* Animação do texto correndo da direita para esquerda */
        @keyframes marquee-top {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(-100%, 0);
            }
        }

        /* Ajuste Responsivo: garante que a faixa não quebre em celular */
        @media (max-width: 768px) {
            .bf-top-bar {
                height: 35px;
            }

            body {
                padding-top: 35px;
            }

            .bf-content {
                font-size: 0.85rem;
            }
        }

        /* Estilos Detalhes do Cliente */
        .client-profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 24px;
        }

        .client-avatar {
            width: 80px;
            height: 80px;
            background-color: #eee;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-size: 40px;
            color: var(--text-light);
            margin-bottom: 12px;
            border: 2px solid var(--border-color);
        }

        .client-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-box {
            background-color: var(--bg-light);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .stat-value {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .stat-value.danger {
            color: var(--warning-red);
        }

        .info-box {
            background-color: var(--bg-light);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .info-box p {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-dark);
        }

        .info-box p:last-child {
            margin-bottom: 0;
        }

        /* Estilos da Barra de Limite */
        .limit-container {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .limit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        .btn-edit-limit {
            background: none;
            border: none;
            color: var(--info-blue);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 4px;
            transition: color 0.2s;
        }

        .btn-edit-limit:hover {
            color: var(--primary-red);
        }

        .progress-track {
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--success-green);
            width: 0%;
            transition: width 0.5s ease, background-color 0.3s ease;
        }

        /* Se estiver perto do limite ou estourado */
        .progress-fill.warning {
            background-color: #ff9800;
        }

        .progress-fill.danger {
            background-color: var(--warning-red);
        }

        .limit-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* --- Modal de Seleção de Cliente --- */
        .search-box-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .search-icon-input {
            position: relative;
            flex-grow: 1;
        }

        .search-icon-input i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 1.2rem;
        }

        .search-icon-input input {
            padding-left: 40px;
            /* Espaço para o ícone */
            width: 100%;
        }

        .client-results-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: none;
            /* Oculto inicialmente */
        }

        .client-result-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .client-result-item:hover {
            background-color: var(--bg-light);
        }

        .client-result-item:last-child {
            border-bottom: none;
        }

        /* --- Cartão do Cliente no Resumo (Sidebar) --- */
        .summary-client-card {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
            display: none;
            /* Oculto por padrão */
            animation: slideInUp 0.3s ease;
        }

        .summary-client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .summary-client-name {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-change-client {
            font-size: 0.75rem;
            padding: 4px 8px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            color: var(--info-blue);
        }

        .btn-change-client:hover {
            border-color: var(--info-blue);
        }

        .summary-limit-bar {
            height: 6px;
            background-color: #ddd;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .summary-limit-fill {
            height: 100%;
            background-color: var(--success-green);
            width: 0%;
            transition: width 0.5s;
        }

        .summary-limit-fill.danger {
            background-color: var(--warning-red);
        }

        .summary-limit-text {
            font-size: 0.75rem;
            color: var(--text-light);
            display: flex;
            justify-content: space-between;
        }

        /* Estilos do Histórico do Cliente */
        .history-section {
            margin-top: 20px;
            border-top: 1px dashed var(--border-color);
            padding-top: 16px;
        }

        .history-section h4 {
            font-size: 1rem;
            margin-bottom: 12px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-list-container {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #fff;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .history-table th {
            background: var(--bg-light);
            padding: 8px;
            text-align: left;
            position: sticky;
            top: 0;
            border-bottom: 1px solid #ddd;
            color: var(--text-light);
        }

        .history-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .history-type-tag {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .type-compra {
            background: rgba(219, 0, 56, 0.1);
            color: var(--primary-red);
        }

        .type-pagamento {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-green);
        }

        .btn-link-receipt {
            color: var(--info-blue);
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .btn-link-receipt:hover {
            text-decoration: underline;
        }

        /* Efeito Hover para os cartões de impressão */
        #btn-print-thermal:hover,
        #btn-print-a4:hover {
            border-color: var(--primary-red) !important;
            background-color: #fff0f3;
        }


        /* --- Barra de Pesquisa Moderna (Aba Clientes) --- */
        .client-search-container {
            position: relative;
            width: 100%;
            margin-bottom: 24px;
        }

        .client-search-input {
            width: 100%;
            padding: 16px 16px 16px 52px;
            /* Espaço para o ícone */
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: var(--text-dark);
            background-color: #ffffff;
            border: 1px solid transparent;
            /* Borda invisível inicialmente */
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            /* Sombra suave */
            transition: all 0.3s ease;
        }

        .client-search-input::placeholder {
            color: #aaa;
            font-weight: 400;
        }

        /* Efeito ao clicar (Foco) */
        .client-search-input:focus {
            outline: none;
            background-color: #fff;
            border-color: rgba(219, 0, 56, 0.3);
            /* Vermelho bem clarinho */
            box-shadow: 0 8px 25px rgba(219, 0, 56, 0.15);
            /* Sombra colorida difusa */
            transform: translateY(-2px);
            /* Leve subida */
        }

        .client-search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.4rem;
            color: #bbb;
            transition: color 0.3s ease;
            pointer-events: none;
            /* O clique passa pelo ícone e vai pro input */
        }

        /* Quando o input está focado, muda a cor do ícone */
        .client-search-input:focus+.client-search-icon,
        .client-search-container:focus-within .client-search-icon {
            color: var(--primary-red);
        }



        /* --- Estilos do Gerenciador Firebase (Atualizado - Com Estoque) --- */
        .firebase-list-header {
            display: grid;
            /* Ajustado para 5 colunas: Produto | Preço | Estoque | Código | Botão */
            grid-template-columns: 2fr 1.2fr 0.8fr 1.5fr 60px;
            padding: 16px;
            background-color: #fdfdfd;
            border-bottom: 1px solid var(--border-color);
            text-transform: uppercase;
            font-size: 0.8rem;
            color: var(--text-light);
            font-weight: 600;
        }

        .firebase-item-row {
            display: grid;
            grid-template-columns: 2fr 1.2fr 0.8fr 1.5fr 60px;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            gap: 12px;
            background: #fff;
            transition: background 0.2s;
        }

        .firebase-item-row:hover {
            background-color: var(--bg-light);
        }

        .fb-prod-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .fb-prod-img {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid var(--border-color);
            background-color: var(--bg-light);
        }

        .fb-prod-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-dark);
            line-height: 1.3;
        }

        .fb-price-box {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .fb-old-price {
            text-decoration: line-through;
            color: var(--text-light);
            font-size: 0.75rem;
        }

        .fb-new-price {
            font-weight: 700;
            color: #000000;
            /* Cor preta solicitada */
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Tag de Desconto (Compacta, sem ícone) */
        .fb-discount-tag {
            font-size: 0.75rem;
            font-weight: 700;
            color: #00a650;
            /* Verde ML */
            background-color: rgba(0, 166, 80, 0.1);
            padding: 1px 4px;
            /* Fundo bem justo */
            border-radius: 4px;
            line-height: 1;
        }

        /* Inputs (Código e Estoque) */
        .fb-input-code,
        .fb-input-stock {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            text-align: center;
            /* Centraliza texto nos inputs */
            transition: all 0.2s ease;
        }

        .fb-input-stock {
            font-weight: 600;
            /* Destaque para o número do estoque */
        }

        .fb-input-code:focus,
        .fb-input-stock:focus {
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(219, 0, 56, 0.1);
            outline: none;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .firebase-list-header {
                display: none;
            }

            .firebase-item-row {
                grid-template-columns: 1fr;
                /* Empilha tudo no celular */
                gap: 16px;
                padding: 20px;
                border: 1px solid var(--border-color);
                margin-bottom: 16px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            }

            .fb-prod-img {
                width: 60px;
                height: 60px;
            }

            .fb-input-code,
            .fb-input-stock {
                text-align: left;
            }
        }




        /* --- Estilos da Página de Pedidos --- */

        /* Abas de Filtro */
        .orders-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .order-tab {
            background: var(--card-white);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .order-tab.active {
            background: var(--text-dark);
            color: #fff;
            border-color: var(--text-dark);
        }

        .order-tab .badge {
            background: var(--primary-red);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* Grid de Pedidos */
        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            /* Responsivo */
            gap: 20px;
        }

        /* Card do Pedido Individual */
        .order-card {
            background: var(--card-white);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .order-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            border-color: #ddd;
        }

        /* Cabeçalho do Card */
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 12px;
        }

        .order-id {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-dark);
        }

        .order-time {
            font-size: 0.85rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Status Tag */
        .order-status {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
            text-transform: uppercase;
        }

        .status-pendente {
            background: #fff3cd;
            color: #856404;
        }

        /* Amarelo */
        .status-aprovado {
            background: #d4edda;
            color: #155724;
        }

        /* Verde */
        .status-cancelado {
            background: #f8d7da;
            color: #721c24;
        }

        /* Vermelho */

        /* Informações do Cliente */
        .order-client {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .client-avatar-small {
            width: 36px;
            height: 36px;
            background: var(--bg-light);
            border-radius: 50%;
            display: grid;
            place-items: center;
            color: var(--text-light);
        }

        .client-info h4 {
            font-size: 0.95rem;
            margin: 0;
            color: var(--text-dark);
        }

        .client-info p {
            font-size: 0.8rem;
            margin: 0;
            color: var(--text-light);
        }

        /* Resumo de Itens */
        .order-items-summary {
            background: var(--bg-light);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--text-dark);
            max-height: 80px;
            overflow: hidden;
            /* Corta se for muito longo */
            position: relative;
        }

        /* Rodapé do Card */
        .order-footer {
            margin-top: auto;
            /* Empurra para baixo */
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-total {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-red);
        }

        .order-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon-action {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: white;
            cursor: pointer;
            display: grid;
            place-items: center;
            transition: all 0.2s;
            color: var(--text-light);
        }

        .btn-icon-action:hover {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
        }

        .btn-main-action {
            background: var(--text-dark);
            color: white;
            border: none;
            padding: 0 16px;
            height: 36px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .btn-main-action:hover {
            background: black;
        }

        /* --- Estilo da Notificação na Navbar --- */
        .navbar-item {
            position: relative;
            /* Necessário para posicionar a bolinha */
        }

        .nav-badge {
            position: absolute;
            top: -5px;
            right: -12px;
            background-color: var(--primary-red);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-light);
            /* Borda branca para destacar */
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .nav-badge.active {
            opacity: 1;
            transform: scale(1);
        }

        /* Ajuste na responsividade para a bolinha não sumir */
        @media (max-width: 768px) {
            .nav-badge {
                top: 0;
                right: 0;
            }
        }

        /* ======================================== */
        /* == ANIMAÇÃO DE NOTIFICAÇÃO (PEDIDOS)  == */
        /* ======================================== */

        @keyframes nav-notify-pulse {
            0% {
                color: var(--text-light);
                transform: scale(1);
            }

            50% {
                color: var(--primary-red);
                transform: scale(1.15);
                /* Aumenta um pouco */
                text-shadow: 0 0 8px rgba(219, 0, 56, 0.3);
                /* Brilho suave */
            }

            100% {
                color: var(--text-light);
                transform: scale(1);
            }
        }

        .navbar-item.notify-active {
            animation: nav-notify-pulse 1s ease-in-out infinite;
            /* Pisca a cada 1s */
            font-weight: 700 !important;
            /* Deixa negrito */
        }

        /* --- Estilos do Modal de Detalhes de Pedido --- */

        /* Barra de Progresso Visual */
        .order-progress-track {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            position: relative;
            padding: 0 10px;
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            z-index: 2;
            /* Fica acima da linha */
            opacity: 0.5;
            transition: all 0.3s;
        }

        .step-item.active {
            opacity: 1;
        }

        .step-item.active .step-icon {
            background-color: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(219, 0, 56, 0.3);
        }

        .step-item.completed .step-icon {
            background-color: var(--success-green);
            border-color: var(--success-green);
            color: white;
        }

        .step-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: white;
            border: 2px solid #ddd;
            display: grid;
            place-items: center;
            font-size: 1.1rem;
            color: #999;
            transition: all 0.3s;
        }

        .step-item span {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .step-line {
            flex-grow: 1;
            height: 2px;
            background-color: #eee;
            margin: 0 -5px;
            /* Conecta os bolinhas */
            margin-bottom: 20px;
            /* Alinha com o ícone */
            z-index: 1;
        }

        /* Lista de Itens dentro do Modal */
        .order-items-scroll {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .modal-order-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .modal-order-item:last-child {
            border-bottom: none;
        }

        .modal-item-qty {
            font-weight: 700;
            color: var(--primary-red);
            margin-right: 8px;
        }

        /* --- Estilos Atualizados do Modal de Pedidos (Varejo) --- */

        /* Lista de Itens com Conferência */
        .modal-order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Centraliza verticalmente */
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 0.95rem;
            transition: background-color 0.2s;
        }

        .item-info-text {
            flex-grow: 1;
        }

        /* Estado: Item Esgotado */
        .modal-order-item.item-unavailable {
            background-color: #fff5f5;
            color: #ccc;
            text-decoration: line-through;
        }

        .modal-order-item.item-unavailable .modal-item-qty {
            color: #ccc;
            /* Tira o vermelho da quantidade */
        }

        /* Botões de Ação do Item (Estoque) */
        .item-stock-actions {
            display: flex;
            gap: 8px;
        }

        .btn-stock-check {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background: white;
            color: #ddd;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-stock-check:hover {
            background-color: #f0f0f0;
        }

        /* Botão Confirmar (Verde) */
        .btn-stock-check.confirmed {
            background-color: var(--success-green);
            border-color: var(--success-green);
            color: white;
        }

        /* Botão Esgotado (Vermelho) */
        .btn-stock-check.missing {
            background-color: white;
            border-color: var(--warning-red);
            color: var(--warning-red);
        }

        .btn-stock-check.missing.active {
            background-color: var(--warning-red);
            color: white;
        }

        /* Botão Fechar Gigante */
        .btn-close-modal-lg {
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 10px;
            background-color: #f1f1f1;
            color: var(--text-dark);
            border: 1px solid #ddd;
        }

        .btn-close-modal-lg:hover {
            background-color: #e0e0e0;
        }



        /* --- Resumo Financeiro no Modal --- */
        .financial-breakdown {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
            font-size: 0.95rem;
        }

        .financial-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: var(--text-light);
        }

        .financial-row.danger {
            color: var(--warning-red);
        }

        .financial-row.final {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-top: 12px;
            border-top: 1px solid #eee;
            padding-top: 12px;
        }

        /* Botão desativado visualmente */
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        /* --- Navegação na Timeline (Interativa) --- */
        .step-item {
            cursor: pointer;
            /* Mostra a mãozinha */
            position: relative;
            transition: transform 0.2s ease;
        }

        .step-item:hover {
            transform: translateY(-3px);
            /* Leve pulo ao passar o mouse */
        }

        .step-item:hover .step-icon {
            border-color: var(--primary-red);
            color: var(--primary-red);
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
        }

        /* Quando estiver ativo ou completado, mantém as cores originais no hover */
        .step-item.active:hover .step-icon,
        .step-item.completed:hover .step-icon {
            transform: none;
            /* Remove efeito extra se já estiver ativo */
        }

        /* --- Bloqueio de Navegação na Timeline --- */
        .step-item.locked {
            cursor: not-allowed;
            /* Mostra o símbolo de bloqueio */
            opacity: 0.6;
            /* Deixa um pouco mais apagado */
            pointer-events: none;
            /* (Opcional) Impede o clique via CSS também */
        }

        .step-item.locked:hover {
            transform: none;
            /* Remove a animação de pulo */
        }

        .step-item.locked .step-icon {
            border-color: #ddd;
            /* Mantém cinza */
            color: #999;
        }
    </style>
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BV6V3GTMR0"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-BV6V3GTMR0');
</script>

<body>

    <div class="bf-top-bar">
        <div class="bf-track">
            <span class="bf-content">
                BLACK FRIDAY • OFERTAS IMPERDÍVEIS • DESCONTOS REAIS • BLACK FRIDAY • 22/11 DIVULGAÇÃO •
                BLACK FRIDAY • OFERTAS IMPERDÍVEIS • DESCONTOS REAIS • BLACK FRIDAY • 22/11 DIVULGAÇÃO •
                BLACK FRIDAY • OFERTAS IMPERDÍVEIS • DESCONTOS REAIS • BLACK FRIDAY • 22/11 DIVULGAÇÃO •
            </span>
        </div>
    </div>

    <div class="modal-overlay" id="print-selection-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Imprimir Comprovante</h3>
                <button class="close-modal-btn" data-target="print-selection-modal"><i class='bx bx-x'></i></button>
            </div>
            <div class="modal-body">
                <p style="text-align: center; margin-bottom: 20px; color: var(--text-dark);">Selecione o formato de
                    impressão:</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div id="btn-print-thermal"
                        style="border: 2px solid #eee; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s;">
                        <i class='bx bx-receipt'
                            style="font-size: 50px; color: var(--text-dark); margin-bottom: 10px;"></i>
                        <h4 style="margin-bottom: 5px;">Cupom (Térmica)</h4>
                        <p style="font-size: 0.8rem; color: #777;">Formato pequeno (80mm)</p>
                    </div>

                    <div id="btn-print-a4"
                        style="border: 2px solid #eee; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s;">
                        <i class='bx bx-file-blank'
                            style="font-size: 50px; color: var(--primary-red); margin-bottom: 10px;"></i>
                        <h4 style="margin-bottom: 5px;">Nota Auxiliar (A4)</h4>
                        <p style="font-size: 0.8rem; color: #777;">Folha inteira com detalhes</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay de Carregamento / Bloqueio -->
    <div id="loading-overlay">
        <i class='bx bx-loader-alt bx-spin'></i>
        <p id="loading-message">Verificando status do caixa...</p>
    </div>

    <div class="modal-overlay" id="client-selection-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Selecionar Cliente</h3>
                <button class="close-modal-btn" data-target="client-selection-modal"><i class='bx bx-x'></i></button>
            </div>
            <div class="modal-body">
                <div class="search-box-wrapper">
                    <div class="search-icon-input">
                        <i class='bx bx-search'></i>
                        <input type="text" id="client-selection-input" placeholder="Busque por nome ou apelido..."
                            autocomplete="off" data-primary-focus="true">
                    </div>
                    <button class="btn btn-primary" id="btn-new-client-modal" style="width: auto; padding: 10px 14px;"
                        title="Novo Cliente">
                        <i class='bx bx-plus'></i>
                    </button>
                </div>

                <div class="client-results-list" id="client-selection-results">
                </div>

                <p style="text-align: center; color: var(--text-light); margin-top: 20px; font-size: 0.9rem;"
                    id="client-search-hint">
                    Digite para buscar...
                </p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="image-viewer-modal" style="z-index: 2000;">
        <div class="modal-content"
            style="max-width: 90%; height: 90vh; display: flex; flex-direction: column; padding: 0;">
            <div class="modal-header" style="padding: 10px 20px;">
                <h3>Visualizar Comprovante</h3>
                <button class="close-modal-btn" data-target="image-viewer-modal"><i class='bx bx-x'></i></button>
            </div>
            <div class="modal-body"
                style="flex-grow: 1; padding: 0; overflow: hidden; background-color: #f4f4f9; position: relative;">
                <p id="viewer-loading"
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #777;">
                    <i class='bx bx-loader-alt bx-spin'></i> Carregando imagem...
                </p>
                <iframe id="viewer-iframe" src=""
                    style="width: 100%; height: 100%; border: none; position: relative; z-index: 2;"></iframe>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cliente-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ficha do Cliente</h3>
                <button class="close-modal-btn" data-target="cliente-details-modal"><i class='bx bx-x'></i></button>
            </div>
            <div class="modal-body">
                <div class="client-profile-header">
                    <div class="client-avatar"><i class='bx bx-user'></i></div>
                    <h4 id="detail-cliente-nome">Carregando...</h4>
                    <p id="detail-cliente-apelido" style="color: var(--text-light);">...</p>
                </div>

                <div class="client-stats-grid">
                    <div class="stat-box">
                        <span class="stat-label">Saldo Devedor</span>
                        <span class="stat-value danger" id="detail-cliente-saldo">R$ 0,00</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">Próximo Venc.</span>
                        <span class="stat-value" id="detail-cliente-vencimento">--/--/----</span>
                    </div>
                </div>

                <div class="limit-container">
                    <div class="limit-header">
                        <span>Limite: <strong id="detail-cliente-limite-total">R$ 0,00</strong></span>
                        <button class="btn-edit-limit" id="btn-alterar-limite" title="Alterar Limite"><i
                                class='bx bx-edit-alt'></i></button>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" id="detail-cliente-progress"></div>
                    </div>
                    <div class="limit-stats">
                        <span id="detail-cliente-disponivel">Disponível: R$ 0,00</span>
                        <span id="detail-cliente-percentual">0% usado</span>
                    </div>
                </div>

                <div class="history-section">
                    <h4><i class='bx bx-history'></i> Histórico Recente</h4>
                    <div class="history-list-container" id="detail-history-container">
                        <p style="text-align:center; padding:20px; color:#999;">Carregando...</p>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 16px;">
                    <label>Contato</label>
                    <div class="info-box">
                        <p><i class='bx bx-phone'></i> <span id="detail-cliente-telefone">--</span></p>
                        <p><i class='bx bx-map'></i> <span id="detail-cliente-endereco">--</span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal-btn" data-target="cliente-details-modal">Fechar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cliente-pay-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Receber de Cliente</h3>
                <button class="close-modal-btn" data-target="cliente-pay-modal"><i class='bx bx-x'></i></button>
            </div>
            <form id="cliente-pay-form">
                <div class="modal-body">
                    <p>Registrar pagamento para: <strong id="pay-cliente-nome">...</strong></p>
                    <p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 16px;">
                        Saldo Atual: <span id="pay-cliente-saldo-atual"
                            style="color: var(--warning-red); font-weight: 600;">R$ 0,00</span>
                    </p>

                    <div class="form-group">
                        <label for="pay-valor">Valor do Pagamento (R$) *</label>
                        <input type="number" id="pay-valor" step="0.01" min="0.01" placeholder="0,00" required
                            data-primary-focus="true">
                    </div>

                    <div class="form-group">
                        <label for="pay-metodo">Forma de Pagamento *</label>
                        <select id="pay-metodo" required>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="PIX">PIX</option>
                            <option value="Cartão">Cartão</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal-btn"
                        data-target="cliente-pay-modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class='bx bx-dollar-circle'></i> Confirmar Pagamento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="main-content" id="main-content">

        <!-- Header com Botão Fechar Caixa -->
        <div class="app-header">
            <h1>Ponto de Venda</h1>
            <button class="btn btn-danger" id="header-close-caixa-btn" style="display: none;">
                <i class='bx bx-stop-circle'></i> Fechar Caixa (F8)
            </button>
        </div>

        <!-- Navbar Estilizada -->
        <nav class="navbar" id="main-navbar">
            <span class="navbar-item active" data-page="pdv">PDV</span>

            <span class="navbar-item" data-page="pedidos">
                Pedidos
                <span class="nav-badge" id="pedidos-badge">0</span>
            </span>

            <span class="navbar-item" data-page="produtos">Produtos</span>
            <span class="navbar-item" data-page="clientes">Clientes</span>
            <span class="navbar-item" data-page="historico">Histórico</span>
            <span class="navbar-item" data-page="configuracoes">Configurações</span>
            <div class="navbar-highlight" id="navbar-highlight"></div>
        </nav>

        <!-- PÁGINA 1: PDV -->
        <div id="pdv-page" class="page-content">
            <div class="pdv-layout">
                <!-- Coluna da Esquerda: Itens -->
                <div class="pdv-main">
                    <div class="tooltip">
                        <div class="barcode-scanner">
                            <i class='bx bx-barcode-reader'></i>
                            <input type="text" id="barcode-input" placeholder="Carregando produtos..." disabled>
                        </div>
                        <span class="tooltip-text">Digite o código ou nome para adicionar</span>
                    </div>
                    <p class="shortcut-hint" id="barcode-hint">Carregando produtos...</p>

                    <div class="item-list-container" id="item-list-container">
                        <div class="empty-state" id="empty-state">
                            <span>Nenhum item na venda</span>
                        </div>
                        <table class="item-list-table" id="item-list-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Qtd.</th>
                                    <th>Preço Unit.</th>
                                    <th style="text-align: center;">Oferta %</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="cart-items-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Coluna da Direita: Resumo -->
                <aside class="pdv-summary">
                    <div class="card">
                        <div class="summary-client-card" id="summary-client-card">
                            <div class="summary-client-header">
                                <span class="summary-client-name">
                                    <i class='bx bx-user'></i> <span id="summary-client-name-text">Nome do
                                        Cliente</span>
                                </span>
                                <button class="btn-change-client" id="btn-change-summary-client">Alterar</button>
                            </div>
                            <div class="summary-limit-bar">
                                <div class="summary-limit-fill" id="summary-limit-fill"></div>
                            </div>
                            <div class="summary-limit-text">
                                <span id="summary-limit-label">Limite Disp.</span>
                                <span id="summary-limit-value">R$ 0,00</span>
                            </div>
                        </div>
                        <h2>Resumo da Venda</h2>
                        <div class="summary-row"> <span class="label">Subtotal (<span id="item-count">0</span>
                                itens)</span> <span class="value" id="summary-subtotal">R$ 0,00</span> </div>
                        <div class="summary-row summary-row-interactive" id="discount-toggle-row"
                            title="Adicionar desconto"> <span class="label"> <i class='bx bx-purchase-tag'></i>
                                Descontos (F3) </span> <span class="value editable" id="summary-discount">- R$
                                0,00</span> </div>
                        <div class="discount-popover" id="discount-popover">
                            <div class="form-group"> <label for="discount-input-r">Valor do Desconto (R$)</label> <input
                                    type="number" id="discount-input-r" placeholder="0,00" step="0.01"> </div> <span
                                class="discount-popover-label">Desconto Rápido (%)</span>
                            <div class="discount-perc-buttons" id="perc-btn-container"> <button class="perc-btn"
                                    data-perc="1">1%</button> <button class="perc-btn" data-perc="3">3%</button> <button
                                    class="perc-btn" data-perc="5">5%</button> <button class="perc-btn"
                                    data-perc="8">8%</button> </div>
                            <div class="effective-discount-display" id="effective-discount-display"> <i
                                    class='bx bx-badge-percent'></i><span id="discount-percentage-text"></span> </div>
                            <button class="btn-remove-discount" id="remove-discount-btn"> <i class='bx bx-x'></i>
                                Remover Desconto </button> <span class="discount-nav-hint"
                                id="remove-discount-hint">Pressione 'Enter' para remover</span>
                        </div>
                        <div class="summary-row summary-row-interactive" id="payment-toggle-row"
                            title="Selecionar forma de pagamento"> <span class="label"> <i
                                    class='bx bx-credit-card'></i> Pagamento (F4) </span> <span class="value editable"
                                id="summary-payment-method">Não selecionado</span> </div>

                        <!-- ... dentro de <aside class="pdv-summary"> ... -->

                        <!-- SELETOR DE VENDEDOR -->
                        <div class="summary-row summary-row-interactive" id="seller-toggle-row"
                            title="Selecionar Vendedor">
                            <span class="label">
                                <i class='bx bx-id-card'></i> Vendedor
                            </span>
                            <span class="value editable" id="summary-seller-name">Não informado</span>
                        </div>

                        <!-- Popover de Vendedores (Escondido) -->
                        <div class="discount-popover" id="seller-popover">
                            <span class="discount-popover-label">Quem está vendendo?</span>
                            <div class="seller-grid"
                                style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px;">
                                <button class="perc-btn seller-btn" data-name="Nubia">Nubia</button>
                                <button class="perc-btn seller-btn" data-name="Evelyn">Evelyn</button>
                                <button class="perc-btn seller-btn" data-name="Ryan">Ryan</button>
                            </div>
                        </div>

                        <div class="summary-total">
                            <div class="summary-row"> <span class="label">Total</span> <span class="value"
                                    id="summary-total">R$ 0,00</span> </div>
                        </div>
                        <div class="tooltip"> <button class="btn btn-primary" id="finish-sale-btn"> <i
                                    class='bx bx-check-circle'></i> Finalizar Venda (F9) </button> <span
                                class="tooltip-text">Registra a venda e abre opções de recibo</span> </div>
                        <div class="tooltip"> <button class="btn btn-secondary" id="cancel-sale-btn"> <i
                                    class='bx bx-x-circle'></i> Cancelar Venda (F10) </button> <span
                                class="tooltip-text">Limpa todos os itens da venda atual</span> </div>
                    </div>
                </aside>
            </div>
        </div>

        <div id="pedidos-page" class="page-content" style="display: none;">
            <div class="card"
                style="max-width: 1000px; margin: 0 auto; background: transparent; border: none; box-shadow: none;">

                <div class="page-header"
                    style="background: var(--card-white); padding: 20px; border-radius: 16px; border: 1px solid var(--border-color); margin-bottom: 24px;">
                    <div>
                        <h2><i class='bx bx-shopping-bag'></i> Pedidos Online</h2>
                        <p style="color: var(--text-light); margin-bottom: 0;">Gerencie as vendas em tempo real.</p>
                    </div>
                    <div>
                        <button class="btn btn-secondary" style="width: auto; padding: 10px 16px;">
                            <i class='bx bx-refresh'></i> Atualizar
                        </button>
                    </div>
                </div>

                <div class="orders-tabs" id="order-status-tabs">
                    <div class="order-tab active" data-status="pendente">
                        Pendentes <span class="badge warning" id="count-pendente">0</span>
                    </div>
                    <div class="order-tab" data-status="preparando">
                        Preparando <span class="badge" id="count-preparando"
                            style="background:#eee; color:#333">0</span>
                    </div>
                    <div class="order-tab" data-status="enviado">
                        Enviados
                    </div>
                    <div class="order-tab" data-status="finalizado">
                        Finalizados
                    </div>
                </div>

                <div id="orders-grid-container" class="orders-grid">
                    <p style="grid-column: 1/-1; text-align: center; color: var(--text-light); padding: 40px;">
                        <i class='bx bx-loader-alt bx-spin' style="font-size: 2rem;"></i><br>Carregando...
                    </p>
                </div>

            </div>
        </div>

        <!-- PÁGINA 2: PRODUTOS -->
        <div id="produtos-page" class="page-content" style="display: none;">
            <div class="card" style="max-width: 800px; margin: 0 auto 24px auto;">
                <div class="page-header">
                    <h2><i class='bx  bx-discount'></i> Black Friday Produtos</h2>
                    <button class="btn btn-secondary" id="btn-load-firebase" style="width: auto; padding: 10px 16px;">
                        <i class='bx bx-cloud-download'></i> Carregar Produtos
                    </button>
                </div>
                <p style="color: var(--text-light); margin-top: -16px; margin-bottom: 24px;">
                    Sincronize os códigos de barras da loja online com o sistema local.
                </p>

                <div class="firebase-list-header">
                    <span>Produto</span>
                    <span>Preço</span>
                    <span style="text-align: center;">Estoque</span> <span>Código de Barras</span>
                    <span style="text-align: center;">Salvar</span>
                </div>

                <div id="firebase-products-list" class="firebase-products-container">
                    <div
                        style="display: flex; flex-direction: column; align-items: center; padding: 40px; color: var(--text-light);">
                        <i class='bx bx-cloud' style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;"></i>
                        <span>Clique em "Carregar Produtos" para iniciar.</span>
                    </div>
                </div>
            </div>

            <div class="card" style="max-width: 800px; margin: 0 auto;">
                <div class="page-header">
                    <h2>Produtos Cadastrados</h2>
                </div>
                <p style="color: var(--text-light); margin-top: -16px; margin-bottom: 16px;"> Novos produtos adicionados
                    pelo "Cadastro Rápido" do PDV aparecerão aqui. </p>
                <div id="produtos-table-container"></div>
            </div>
        </div>

        <!-- PÁGINA 3: CLIENTES -->
        <div id="clientes-page" class="page-content" style="display: none;">
            <div class="card">
                <div class="page-header">
                    <h2>Clientes (Crediário)</h2>
                    <button class="btn btn-primary" id="add-cliente-btn" style="width: auto; padding: 10px 16px;">
                        <i class='bx bx-user-plus'></i> Adicionar Cliente +
                    </button>
                </div>
                <p style="color: var(--text-light); margin-top: -16px; margin-bottom: 16px;"> Gerencie os clientes com
                    pagamentos pendentes. </p>

                <div class="search-box-wrapper" style="margin-bottom: 20px;">


                    <div class="client-search-container">
                        <i class='bx bx-search client-search-icon'></i>
                        <input type="text" id="clientes-page-search" class="client-search-input"
                            placeholder="Buscar cliente por nome ou apelido..." autocomplete="off">
                    </div>
                </div>
                <div id="clientes-list-container">
                    <p style="text-align: center; color: var(--text-light); padding: 20px 0;">
                        <i class='bx bx-loader-alt bx-spin'></i> Carregando clientes...
                    </p>
                </div>
            </div>
        </div>

        <!-- PÁGINA 5: CAIXA (Agora vazia, apenas como placeholder se necessário) -->
        <div id="caixa-page" class="page-content" style="display: none;"></div>


        <!-- PÁGINA 7: HISTÓRICO DE VENDAS -->
        <div id="historico-page" class="page-content" style="display: none;">
            <div class="card">
                <div class="page-header">
                    <h2>Histórico de Vendas (Dia)</h2>
                    <button class="btn btn-secondary" id="btn-refresh-history" style="width: auto; padding: 8px 12px;">
                        <i class='bx bx-refresh'></i> Atualizar
                    </button>
                </div>

                <div id="sales-history-list" style="display: flex; flex-direction: column; gap: 12px;">
                    <p style="text-align: center; color: #999; padding: 20px;">Carregando...</p>
                </div>
            </div>
        </div>

        <!-- PÁGINA 6: CONFIGURAÇÕES -->
        <div id="configuracoes-page" class="page-content" style="display: none;">
            <div class="card" style="max-width: 800px; margin: 0 auto;">
                <div class="page-header">
                    <h2>Configurações</h2>
                </div>
                <div class="setting-row">
                    <div class="setting-info">
                        <h3>Arredondamento Inteligente de Troco</h3>
                        <p> Quando ativado, os descontos por porcentagem arredondam o valor total da compra para o R$
                            0,50 mais próximo, facilitando o troco. </p>
                    </div> <label class="toggle-switch"> <input type="checkbox" id="smart-rounding-toggle" checked>
                        <span class="slider"></span> </label>
                </div>
                <div class="setting-row">
                    <div class="setting-info">
                        <h3>Cache de Produtos</h3>
                        <p> Recarrega a lista de produtos do banco de dados. Útil se você fez alterações externas. </p>
                    </div>
                    <button class="btn btn-secondary" id="reload-cache-btn" style="width: auto; padding: 10px 16px;"> <i
                            class='bx bx-sync'></i> Recarregar </button>
                </div>
            </div>
        </div>
    </div> <!-- Fim do main-content -->

    <!-- MODAIS -->
    <!-- Modal 1: Cadastro Rápido -->
    <div class="modal-overlay" id="quick-add-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Produto não encontrado</h3> <button class="close-modal-btn" data-target="quick-add-modal"><i
                        class='bx bx-x'></i></button>
            </div>
            <div class="modal-body">
                <p>O código <strong id="scanned-barcode"></strong> não está cadastrado. Adicione um item rápido para
                    esta venda.</p>
                <form id="quick-add-form">
                    <div class="form-group"> <label for="quick-product-name">Nome do Produto</label> <input type="text"
                            id="quick-product-name" required data-primary-focus="true"> </div>
                    <div class="form-group"> <label for="quick-product-price">Preço (R$)</label> <input type="number"
                            id="quick-product-price" step="0.01" min="0.01" placeholder="0,00" required> </div>
                </form>
            </div>
            <div class="modal-footer"> <button class="btn btn-secondary close-modal-btn"
                    data-target="quick-add-modal">Cancelar</button> <button class="btn btn-primary"
                    id="quick-add-submit-btn">Adicionar à Venda</button> </div>
        </div>
    </div>

    <!-- Modal crediario select-->
    <div class="modal-overlay" id="crediario-flow-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Finalizar Crediário</h3>
                <button class="close-modal-btn" data-target="crediario-flow-modal"><i class='bx bx-x'></i></button>
            </div>
            <div class="modal-body">

                <div id="cred-step-1" class="qr-step-container">
                    <div class="modal-icon info"><i class='bx bx-printer' style="font-size: 40px;"></i></div>
                    <p class="step-instruction">Imprima o comprovante para assinatura do cliente.</p>
                    <p class="step-subtext">Cliente: <strong id="cred-flow-client-name">...</strong></p>
                    <button class="btn btn-primary" id="btn-force-print">
                        <i class='bx bx-printer'></i> Imprimir Comprovante
                    </button>
                </div>

                <div id="cred-step-2" class="qr-step-container locked-step"
                    style="display:none; opacity: 0; transition: opacity 0.5s;">
                    <p class="step-instruction">Anexar Comprovante Assinado</p>
                    <p class="step-subtext" style="margin-bottom: 10px;">Escaneie para enviar a foto:</p>

                    <div class="qr-img-wrapper">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://eletrobusiness.com.br/comprovante/buy/valid55102.html"
                            alt="QR Code Comprovante">
                    </div>
                    <p style="font-size: 0.8rem; color: #777;">Link: eletrobusiness.com.br/comprovante...</p>

                    <div style="margin-top: 24px;">
                        <button class="btn btn-success" id="btn-finish-crediario-final">
                            <i class='bx bx-check-double'></i> Concluir Conta e Salvar
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal 2: Seleção de Pagamento (Com Split) -->
    <div class="modal-overlay" id="payment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Forma de Pagamento</h3>
                <button class="close-modal-btn" data-target="payment-modal"><i class='bx bx-x'></i></button>
            </div>
            <div class="modal-body">
                <p>Valor total: <strong id="payment-total">R$ 0,00</strong>. Como o cliente irá pagar?</p>

                <div class="payment-options" id="single-payment-options">
                    <div class="payment-option" data-method="Dinheiro"> <i class='bx bx-dollar-circle'
                            style="font-size: 32px;"></i> <span>Dinheiro (F6)</span> </div>
                    <div class="payment-option" data-method="PIX"> <i class='bx bx-scan' style="font-size: 32px;"></i>
                        <span>PIX (F7)</span>
                    </div>
                    <div class="payment-option" data-method="Cartão"> <i class='bx bx-credit-card'
                            style="font-size: 32px;"></i> <span>Cartão (F8)</span> </div>
                    <div class="payment-option" data-method="Crediário" id="opt-crediario"> <i class='bx bx-user-check'
                            style="font-size: 32px;"></i> <span>Crediário</span> </div>
                </div>

                <div id="crediario-limit-feedback" style="display: none;">
                    <div class="mini-limit-bar">
                        <div class="mini-limit-fill" id="crediario-limit-fill"></div>
                    </div>
                    <div class="mini-limit-info">
                        <span id="crediario-limit-text">Limite disponível: R$ 0,00</span>
                        <span id="crediario-status-text"></span>
                    </div>
                </div>
            </div>

            <button class="btn btn-secondary" id="split-payment-toggle-btn" style="margin-top: 20px;"> <i
                    class='bx bx-columns'></i> Dividir Pagamento </button>

            <div class="split-payment-area" id="split-payment-area" style="display: none;">
                <h4>Dividir Pagamento</h4>
                <div class="split-payment-row">
                    <div class="form-group"> <label for="split-method-1">Forma 1</label> <select id="split-method-1">
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="PIX">PIX</option>
                            <option value="Cartão">Cartão</option>
                        </select> </div>
                    <div class="form-group"> <label for="split-value-1">Valor 1 (R$)</label> <input type="number"
                            id="split-value-1" step="0.01"> </div>
                </div>
                <div class="split-payment-row">
                    <div class="form-group"> <label for="split-method-2">Forma 2</label> <select id="split-method-2">
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="PIX">PIX</option>
                            <option value="Cartão">Cartão</option>
                        </select> </div>
                    <div class="form-group"> <label for="split-value-2">Valor 2 (R$)</label> <input type="number"
                            id="split-value-2" step="0.01"> </div>
                </div>
                <div class="split-payment-remaining" id="split-payment-remaining"> Restante: R$ 0,00 </div>
                <button class="btn btn-primary" id="confirm-split-payment-btn" style="margin-top: 16px;" disabled>
                    Confirmar Divisão </button>
            </div>
        </div>
    </div>
    </div>
    </div>

    <!-- Modal 3: Recibo -->
    <div class="modal-overlay" id="receipt-modal">
        <div class="modal-content">
            <div class="modal-body centered">
                <div class="modal-icon success"><i class='bx bx-check' style="font-size: 40px;"></i></div>
                <h3 style="font-size: 1.5rem; margin-bottom: 8px;">Venda Finalizada!</h3>
                <p>Venda no valor de <strong id="receipt-total">R$ 0,00</strong> registrada com sucesso.</p>
                <div class="modal-footer" style="flex-direction: column;"> <button class="btn btn-primary"
                        id="print-receipt-btn"> <i class='bx bx-printer'></i> Imprimir Recibo (Não Fiscal) </button>
                    <button class="btn btn-secondary" id="new-sale-btn" data-primary-focus="true"> <i
                            class='bx bx-rotate-left'></i> Nova Venda </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="order-details-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Pedido <span id="modal-order-id" style="color: var(--text-light);">#0000</span></h3>
                <button class="close-modal-btn" data-target="order-details-modal"><i class='bx bx-x'></i></button>
            </div>

            <div class="modal-body">
                <div class="order-progress-track">
                    <div class="step-item" id="step-pendente" onclick="manualSetStatus('pendente')"
                        title="Voltar para Recebido">
                        <div class="step-icon"><i class='bx bx-list-ul'></i></div>
                        <span>Recebido</span>
                    </div>

                    <div class="step-line"></div>

                    <div class="step-item" id="step-preparando" onclick="manualSetStatus('preparando')"
                        title="Mudar para Separando">
                        <div class="step-icon"><i class='bx bx-box'></i></div>
                        <span>Separando</span>
                    </div>

                    <div class="step-line"></div>

                    <div class="step-item" id="step-enviado" onclick="manualSetStatus('enviado')"
                        title="Mudar para Enviado">
                        <div class="step-icon"><i class='bx bx-car'></i></div>
                        <span>Enviado</span>
                    </div>

                    <div class="step-line"></div>

                    <div class="step-item" id="step-finalizado" onclick="manualSetStatus('finalizado')"
                        title="Mudar para Entregue">
                        <div class="step-icon"><i class='bx bx-check-double'></i></div>
                        <span>Entregue</span>
                    </div>
                </div>

                <div style="background: var(--bg-light); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="font-size: 0.95rem; margin-bottom: 8px; display:flex; align-items:center; gap:8px;">
                        <i class='bx bx-user'></i> <span id="modal-order-client">Nome do Cliente</span>
                    </h4>
                    <p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 4px;">
                        <i class='bx bx-map'></i> <span id="modal-order-address">Endereço...</span>
                    </p>
                    <div style="display:flex; justify-content:space-between; margin-top:8px;">
                        <span style="font-size: 0.8rem; background: #eee; padding: 4px 8px; border-radius: 4px;"
                            id="modal-payment-method">Pagamento: --</span>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="font-size: 1rem; margin:0;">Conferência de Estoque</h4>
                    <small style="color:var(--text-light);">Marque os itens disponíveis</small>
                </div>

                <div id="modal-order-items-list" class="order-items-scroll">
                </div>

                <div class="financial-breakdown">
                    <div class="financial-row">
                        <span>Subtotal</span>
                        <span id="modal-calc-subtotal">R$ 0,00</span>
                    </div>
                    <div class="financial-row danger" id="row-canceled-items" style="display: none;">
                        <span>Itens Cancelados/Sem Estoque</span>
                        <span id="modal-calc-canceled">- R$ 0,00</span>
                    </div>
                    <div class="financial-row final">
                        <span>Total Final</span>
                        <span id="modal-calc-total" style="color: var(--primary-red);">R$ 0,00</span>
                    </div>
                </div>
            </div>

            <div class="modal-footer" style="flex-direction: column; gap: 10px;">
                <button id="btn-update-status" class="btn btn-primary">
                    Avançar Status
                </button>
                <button class="btn btn-close-modal-lg close-modal-btn" data-target="order-details-modal">
                    Fechar Janela
                </button>
            </div>

        </div>
    </div>

    <!-- Modal 4: Confirmação -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-content">
            <div class="modal-body centered">
                <div class="modal-icon danger"><i class='bx bx-error-alt' style="font-size: 40px;"></i></div>
                <h3 style="font-size: 1.5rem; margin-bottom: 8px;" id="confirm-title">Tem certeza?</h3>
                <p id="confirm-message">Esta ação não pode ser desfeita.</p>
                <div class="modal-footer" style="justify-content: center;"> <button
                        class="btn btn-secondary close-modal-btn" data-target="confirm-modal">Cancelar</button> <button
                        class="btn btn-danger" id="confirm-action-btn" data-primary-focus="true">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal 5: Alerta -->
    <div class="modal-overlay" id="alert-modal">
        <div class="modal-content">
            <div class="modal-body centered">
                <div class="modal-icon info"><i class='bx bx-info-circle' style="font-size: 40px;"></i></div>
                <h3 style="font-size: 1.5rem; margin-bottom: 8px;" id="alert-title">Atenção</h3>
                <p id="alert-message">Ocorreu um erro.</p>
                <div class="modal-footer" style="justify-content: center;"> <button
                        class="btn btn-primary close-modal-btn" data-target="alert-modal"
                        data-primary-focus="true">Entendi</button> </div>
            </div>
        </div>
    </div>
    <!-- Modal 6: Adicionar Cliente (Multi-Step) -->
    <div class="modal-overlay" id="add-cliente-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Adicionar Novo Cliente</h3> <button class="close-modal-btn" data-target="add-cliente-modal"><i
                        class='bx bx-x'></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-progress-bar">
                    <div class="progress" id="add-cliente-progress"></div>
                </div>
                <form id="add-cliente-form">
                    <div id="cliente-step-1" class="add-cliente-step active">
                        <h4>Parte 1: Dados Pessoais</h4> <br>
                        <div class="form-group"> <label for="cliente-apelido">Apelido *</label> <input type="text"
                                id="cliente-apelido" required data-primary-focus="true"> <small
                                class="shortcut-hint">Identificação rápida.</small> </div>
                        <div class="form-group"> <label for="cliente-nome">Nome Completo</label> <input type="text"
                                id="cliente-nome"> </div>
                        <div class="form-group"> <label for="cliente-telefone">Telefone</label> <input type="tel"
                                id="cliente-telefone" placeholder="(XX) XXXXX-XXXX"> </div>
                        <div class="form-group"> <label for="cliente-endereco">Endereço</label> <textarea
                                id="cliente-endereco" rows="2"></textarea> </div>
                    </div>
                    <div id="cliente-step-2" class="add-cliente-step">
                        <h4>Parte 2: Compra Inicial</h4> <br>
                        <div class="form-group"> <label for="compra-valor">Valor (R$) *</label> <input type="number"
                                id="compra-valor" step="0.01" min="0.01" placeholder="0,00" required> </div>
                        <div class="form-group"> <label for="compra-parcelas">Nº Parcelas *</label> <input type="number"
                                id="compra-parcelas" min="1" step="1" placeholder="1" required> </div>
                        <div class="form-group"> <label for="compra-vencimento">1º Vencimento *</label> <input
                                type="date" id="compra-vencimento" required> </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer-multi-step"> <button class="btn btn-secondary" id="cliente-prev-btn"
                    style="display: none;"> <i class='bx bx-chevron-left'></i> Anterior </button> <button
                    class="btn btn-primary" id="cliente-next-btn"> Próximo <i class='bx bx-chevron-right'></i> </button>
                <button class="btn btn-primary" id="cliente-save-btn" style="display: none;"> <i class='bx bx-save'></i>
                    Salvar Cliente </button>
            </div>
        </div>
    </div>

    <!-- Modal 7: Gerenciamento de Caixa (REMOVIDO) -->

    <!-- Modal 8: Abrir Caixa (Formulário) -->
    <div class="modal-overlay" id="open-caixa-modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>Abrir Caixa</h3>
            </div>
            <form id="open-caixa-form">
                <div class="modal-body">
                    <p>Informe o valor inicial para troco ou abra sem valor.</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="open-caixa-notas">Valor em Notas (R$) </label>
                            <input type="number" id="open-caixa-notas" step="0.01" min="0" placeholder="0,00"
                                data-primary-focus="true">
                        </div>
                        <div class="form-group">
                            <label for="open-caixa-moedas">Valor em Moedas (R$) </label>
                            <input type="number" id="open-caixa-moedas" step="0.01" min="0" placeholder="0,00">
                        </div>
                    </div>
                    <!-- (MODIFICADO) Toggle Switch UI -->
                    <div class="toggle-switch-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="open-caixa-sem-valor">
                            <span class="slider"></span>
                        </label>
                        <label for="open-caixa-sem-valor">Abrir caixa sem valor inicial</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" id="open-caixa-save-btn">
                        <i class='bx bx-check'></i> Confirmar Abertura
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- (MODIFICADO) Modal 9: Fechar Caixa (Multi-Step) -->
    <div class="modal-overlay" id="close-caixa-modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h3>Fechar Caixa</h3>
                <button class="close-modal-btn" data-target="close-caixa-modal"><i class='bx bx-x'></i></button>
            </div>
            <div class="modal-body">
                <!-- Barra de Progresso -->
                <div class="modal-progress-bar">
                    <div class="progress" id="close-caixa-progress" style="width: 25%;"></div>
                </div>
                <form id="close-caixa-form" class="multi-step-form">

                    <!-- Etapa 1: Valores Contados -->
                    <div id="close-caixa-step-1" class="form-step active">
                        <h4>Etapa 1: Valores Contados</h4> <br>
                        <div class="form-grid">
                            <div class="form-group"> <label for="close-caixa-notas">Notas (R$) *</label> <input
                                    type="number" id="close-caixa-notas" step="0.01" min="0" placeholder="0,00" required
                                    data-primary-focus="true"> </div>
                            <div class="form-group"> <label for="close-caixa-moedas">Moedas (R$) *</label> <input
                                    type="number" id="close-caixa-moedas" step="0.01" min="0" placeholder="0,00"
                                    required> </div>
                        </div>
                    </div>

                    <!-- Etapa 2: Outras Entradas -->
                    <div id="close-caixa-step-2" class="form-step">
                        <h4>Etapa 2: Outras Entradas</h4> <br>
                        <div class="form-grid">
                            <div class="form-group"> <label for="close-caixa-cartao">Maquininha Cartão (R$) *</label>
                                <input type="number" id="close-caixa-cartao" step="0.01" min="0" placeholder="0,00"
                                    required>
                            </div>
                            <div class="form-group"> <label for="close-caixa-pix">Pix Fixo QR Code (R$) </label> <input
                                    type="number" id="close-caixa-pix" step="0.01" min="0" placeholder="0,00"> <small
                                    class="shortcut-hint">Opcional.</small> </div>
                        </div>
                    </div>

                    <!-- Etapa 3: Destino do Dinheiro -->
                    <div id="close-caixa-step-3" class="form-step">
                        <h4>Etapa 3: Destino do Dinheiro Contado</h4> <br>
                        <div class="form-grid">
                            <div class="form-group"> <label for="close-caixa-deposito">Valor p/ Depósito (R$) *</label>
                                <input type="number" id="close-caixa-deposito" step="0.01" min="0" placeholder="0,00"
                                    required>
                            </div>
                            <div class="form-group"> <label for="close-caixa-fica">Valor Fica Caixa (R$) *</label>
                                <input type="number" id="close-caixa-fica" step="0.01" min="0" placeholder="0,00"
                                    required>
                            </div>
                        </div>
                    </div>

                    <!-- Etapa 4: Assinatura -->
                    <div id="close-caixa-step-4" class="form-step">
                        <h4>Etapa 4: Responsável</h4> <br>
                        <div class="form-group"> <label for="close-caixa-assinatura">Assinatura (Nome do Responsável)
                                *</label> <input type="text" id="close-caixa-assinatura" required> </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer-multi-step">
                <button class="btn btn-secondary" id="close-caixa-prev-btn" style="display: none;"> <i
                        class='bx bx-chevron-left'></i> Anterior </button>
                <button class="btn btn-primary" id="close-caixa-next-btn"> Próximo <i class='bx bx-chevron-right'></i>
                </button>
                <button type="submit" form="close-caixa-form" class="btn btn-danger" id="close-caixa-save-btn"
                    style="display: none;"> <i class='bx bx-lock-alt'></i> Confirmar Fechamento </button>
            </div>
        </div>
    </div>


    <!-- Relógio no rodapé -->
    <div class="pn">
        <div class="pn-hr">
            <div class="loading1"></div>
            <p class="horario" id="horario">00:00:00</p>
        </div>
    </div>


</body>

</html>