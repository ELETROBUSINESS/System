<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </meta>

    <title>Área de Vendas | Nubia</title>
    <link rel="icon" href="/assets/img/iconWeb.png">

    <!-- Link To CSS -->
    <link rel="stylesheet" href="/assets/CSS/main.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/2.6.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-brands/css/uicons-brands.css'>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BV6V3GTMR0"></script>
<script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-BV6V3GTMR0'); </script>

<body onload="AnimationLoading();">
    <header>
        <div class="loading">
            <div class="efect-loading"></div>
        </div>
    </header>
    <div class="generatedReceipt" id="generatedReceipt">
        <div class="container-comprovante">
            <div class="comprovante">
                <div class="date-info">
                    <i class='bx bx-detail'></i>
                    <p class="title">Comprovante</p>
                </div>
                <div class="date-info">
                    <p>Operação:</p>
                    <p id="hrInfo">11:30:11</p>
                </div>
                <div class="TypeMov">
                    <h1 id="paymentInfo">Pix - QRCODE</h1>
                    <p>Cliente Anonimo</p>
                    <span id="valueInfo">R$0,00</span>
                </div>
                <div class="Resumo">
                    <div class="quest1">
                        <p>Vendedor</p>
                        <span id="sellerInfo">Ryan</span>
                    </div>
                    <div class="quest1">
                        <p>Desconto</p>
                        <span id="desInfo">R$0,00</span>
                    </div>
                </div>
            </div>
            <div class="infoAdd">
                <a href="/users/45692327000100/CD1/adm/nb/formsPush.html" class="b-function">
                    <i class='bx bxs-cart-add'></i>
                    Nova venda
                </a>
                <a href="/users/45692327000100/CD1/adm/nb/extrato.html" class="b-function">
                    <i class='bx bx-copy-alt'></i>
                    Ver extrato
                </a>
            </div>
        </div>
    </div>

    <main id="calculator_container">
        <div id="calc_header">
            <a class="btn-back" href="/users/45692327000100/CD1/adm/nb/conta.html">
                <i class='bx bx-left-arrow-alt'></i>
            </a>
            <h1 id="calc_title">Nova Venda</h1>
        </div>

        <div id="calc_display">
            <span id="display-value">R$ 0,00</span>
        </div>

        <div id="calculator_grid">
            <div class="calc-btn" data-value="1">1</div>
            <div class="calc-btn" data-value="2">2</div>
            <div class="calc-btn" data-value="3">3</div>
            <div class="calc-btn" data-value="4">4</div>
            <div class="calc-btn" data-value="5">5</div>
            <div class="calc-btn" data-value="6">6</div>
            <div class="calc-btn" data-value="7">7</div>
            <div class="calc-btn" data-value="8">8</div>
            <div class="calc-btn" data-value="9">9</div>
            <div class="calc-btn special-btn" data-action="backspace">
                <i class='bx bx-x'></i>
            </div>
            <div class="calc-btn" data-value="0">0</div>
            <div class="calc-btn special-btn" data-action="add-item">
                <i class='bx bx-plus'></i>
            </div>
        </div>

        <div id="cart_info">
            <div class="cart-details">
                <i class='bx bx-cart-alt'></i>
                <span id="item-count">0 itens</span>
            </div>
            <div class="cart-total">
                <span id="cart-total-value">R$ 0,00</span>
            </div>
        </div>

        <button id="next-step-btn" class="btn-default" disabled>
            Vender
        </button>
    </main>

    <div class="new_nav main-container">
        <main id="form_container">
            <div id="form_header">
                <h1 id="form_title">Nova Venda</h1>
                <a class="btn-default" href="/users/45692327000100/CD1/adm/nb/conta.html" target="_self">
                    <i class='bx bxs-left-arrow-circle'></i>
                </a>
            </div>

            <form action="" id="form-sell-adm">
                <input type="hidden" name="formType" value="venda">

                <div id="input_container">
                    <div class="input-box">
                        <label for="value" class="form-label">
                            Venda Bruta
                        </label>
                        <div class="input-field">
                            <input type="number" name="value" id="value" class="form-control" placeholder="R$0.00"
                                autocomplete="off" step="0.01">
                            <ion-icon name="cart-sharp"></ion-icon>
                        </div>
                        <span class="error"></span>
                    </div>

                    <div class="custom-select-wrapper">
                        <label class="form-label">Forma de pagamento</label>
                        <div class="custom-select" id="customSelect">
                            <div class="selected">
                                <i class="fa-regular fa-credit-card"></i> Escolha a forma de pagamento
                            </div>
                            <div class="options">
                                <div data-value="dinheiro"><i class="fi fi-rr-money"></i> Dinheiro</div>
                                <div data-value="pixQR-F"><i class="fi fi-rr-money-coin-transfer"></i> Pix | QRCODE
                                </div>
                                <div data-value="pixQR-G"><i class="fi fi-rr-point-of-sale-bill"></i> Pix | Maquininha
                                </div>

                                <div data-value="movCard"><i class="fi fi-rr-money-transfer-smartphone"></i> MovCard
                                </div>

                                <div data-value="c-debitoVisa"><i class="fi fi-rr-credit-card"></i> Débito | Master+Visa
                                </div>
                                <div data-value="c-debito+"><i class="fi fi-rr-credit-card"></i> Débito | Outros</div>
                                <div data-value="c-creditoVisa1x"><i class="fi fi-rr-credit-card"></i> Crédito 1x |
                                    Master+Visa</div>
                                <div data-value="c-creditoVisa2x"><i class="fi fi-rr-credit-card"></i> Crédito 2x |
                                    Master+Visa</div>
                                <div data-value="c-creditoVisa3x"><i class="fi fi-rr-credit-card"></i> Crédito 3x |
                                    Master+Visa</div>
                                <div data-value="c-credito+1x"><i class="fi fi-rr-credit-card"></i> Crédito 1x | Outro
                                </div>
                                <div data-value="c-credito+2x"><i class="fi fi-rr-credit-card"></i> Crédito 2x | Outro
                                </div>
                                <div data-value="c-credito+3x"><i class="fi fi-rr-credit-card"></i> Crédito 3x | Outro
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="payment" id="paymentModal">
                    </div>

                    <script>
                        const customSelect = document.getElementById('customSelect');
                        const selected = customSelect.querySelector('.selected');
                        const options = customSelect.querySelector('.options');
                        const hiddenInput = document.getElementById('paymentModal');

                        selected.addEventListener('click', () => {
                            customSelect.classList.toggle('active');
                        });

                        options.querySelectorAll('div').forEach(option => {
                            option.addEventListener('click', () => {
                                selected.innerHTML = option.innerHTML;
                                hiddenInput.value = option.dataset.value;
                                customSelect.classList.remove('active');
                            });
                        });

                        // Fecha se clicar fora
                        document.addEventListener('click', (e) => {
                            if (!customSelect.contains(e.target)) {
                                customSelect.classList.remove('active');
                            }
                        });
                    </script>

                    <div class="radio-container">
                        <label class="form-label">Vendedora</label>

                        <div id="payment_inputs">
                            <div class="radio-box">
                                <input type="radio" name="seller" id="seller" class="form-control" value="nubia"
                                    checked="on">
                                <label for="nubia" class="form-label">Nubia</label>
                            </div>
                        </div>
                    </div>

                    <div class="radio-container">
                        <label class="form-label">Type</label>

                        <div id="payment_inputs">
                            <div class="radio-box">
                                <input type="radio" name="type" id="entrada" class="form-control" value="entrada"
                                    checked="on">
                                <label for="entrada" class="form-label">Entrada</label>
                            </div>
                        </div>
                    </div>

                    <div class="input-box">
                        <label for="desconto" class="form-label">
                            Desconto
                        </label>
                        <div class="input-field">
                            <input type="number" name="desconto" id="desconto" class="form-control" placeholder="R$0,00"
                                autocomplete="off" step="0.01">
                            <ion-icon name="pricetag-sharp"></ion-icon>
                        </div>
                    </div>

                    <div class="input-box">
                        <label for="total" class="form-label">
                            Valor final
                        </label>
                        <div class="input-field">
                            <input type="number" name="total" id="total" class="form-control" placeholder="R$0,00"
                                autocomplete="off" readonly>
                            <ion-icon name="bag-handle-sharp"></ion-icon>
                        </div>
                    </div>
                    <br>
                </div>

                <div class="radio-box">
                    <button onclick="calcular()" type="submit" class="btn-default" id="submit-button-ADM">
                        <div class="icon">
                            <i class='bx bxs-cart-alt'></i>
                        </div>
                        Vender
                    </button>
                </div>
            </form>
        </main>
        <audio id="songSell" src="/assets/audio/Sell.MP3"></audio>
        <div id="pushBox"></div>
    </div>

    <div class="pn">
        <div class="pn-hr">
            <div class="loading1">
                <div class="efect-loading1"></div>
            </div>
            <p class="horario" id="horario">00:00:00</p>
        </div>
    </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Referências dos elementos do DOM
            const calculatorContainer = document.getElementById('calculator_container');
            const formContainer = document.getElementById('form_container');

            // Elementos da calculadora
            const displayValue = document.getElementById('display-value');
            const calcBtns = document.querySelectorAll('.calc-btn');
            const nextStepBtn = document.getElementById('next-step-btn');
            const itemCountSpan = document.getElementById('item-count');
            const cartTotalSpan = document.getElementById('cart-total-value');

            // Elementos do formulário
            const valueInput = document.getElementById('value'); // Referência corrigida para o ID 'value'
            const descontoInput = document.getElementById('desconto');
            const totalInputForm = document.getElementById('total');
            const formSellAdm = document.getElementById('form-sell-adm');
            const backBtnForm = document.getElementById('back-btn-form');

            // Variáveis de estado
            let currentInput = '000'; // Inicializado com 3 dígitos para centavos
            let totalValue = 0;
            let itemCount = 0;

            // --- Funções da Calculadora ---

            function formatAndDisplay() {
                let numericValue = parseFloat(currentInput) / 100;
                displayValue.textContent = numericValue.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL',
                    minimumFractionDigits: 2
                });
            }

            function updateTotalCart() {
                const formattedTotal = totalValue.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL',
                    minimumFractionDigits: 2
                });
                cartTotalSpan.textContent = formattedTotal;
                itemCountSpan.textContent = `${itemCount} itens`;

                nextStepBtn.disabled = totalValue === 0;
            }

            calcBtns.forEach(button => {
                button.addEventListener('click', () => {
                    const value = button.dataset.value;
                    const action = button.dataset.action;

                    if (action === 'backspace') {
                        if (currentInput.length > 3) {
                            currentInput = currentInput.slice(0, -1);
                        } else if (currentInput.length === 3) {
                            currentInput = '000';
                        }
                    } else if (action === 'add-item') {
                        const itemPrice = parseFloat(currentInput) / 100;
                        if (itemPrice > 0) {
                            totalValue += itemPrice;
                            itemCount++;
                            currentInput = '000'; // Reseta a entrada para o próximo item
                            updateTotalCart();
                        }
                    } else {
                        if (currentInput === '000') {
                            currentInput = value;
                        } else {
                            currentInput += value;
                        }
                    }
                    formatAndDisplay();
                });
            });

            nextStepBtn.addEventListener('click', () => {
                if (totalValue > 0) {
                    // Esconde a calculadora e mostra o formulário
                    calculatorContainer.classList.add('hidden');
                    formContainer.classList.remove('hidden');

                    // Esta é a linha que atualiza o valor do input "value"
                    valueInput.value = totalValue.toFixed(2);
                    // E esta linha atualiza o valor do input "Valor Final"
                    totalInputForm.value = totalValue.toFixed(2);
                }
            });

            // --- Funções do Formulário ---

            // Lógica para o botão de voltar do formulário
            if (backBtnForm) {
                backBtnForm.addEventListener('click', (e) => {
                    e.preventDefault(); // Impede a navegação padrão do link
                    // Volta para a calculadora
                    formContainer.classList.add('hidden');
                    calculatorContainer.classList.remove('hidden');
                });
            }

            // Lógica de cálculo do desconto no formulário, agora usando o campo 'value'
            if (descontoInput && valueInput && totalInputForm) {
                descontoInput.addEventListener('input', () => {
                    const vendaBruta = parseFloat(valueInput.value) || 0; // Referência corrigida aqui
                    const desconto = parseFloat(descontoInput.value) || 0;
                    const valorFinal = vendaBruta - desconto;
                    totalInputForm.value = valorFinal.toFixed(2);
                });
            }

            formSellAdm.addEventListener('submit', (e) => {
                e.preventDefault();

                console.log('Formulário enviado!');

                // Lógica de envio de dados para o backend (API)
                const formData = new FormData(formSellAdm);

                // Exemplo: logar os dados antes de enviar
                for (let pair of formData.entries()) {
                    console.log(pair[0] + ': ' + pair[1]);
                }

                // Simulação de envio com sucesso
                setTimeout(() => {
                    // Limpa dados e volta para a tela inicial
                    totalValue = 0;
                    itemCount = 0;
                    currentInput = '000';
                    updateTotalCart();
                    formSellAdm.reset();

                    // Retorna para a tela da calculadora
                    formContainer.classList.add('hidden');
                    calculatorContainer.classList.remove('hidden');
                }, 1000);
            });

            // --- Inicialização ---

            // Adiciona o valor padrão no campo de desconto para evitar "NaN"
            if (descontoInput) {
                descontoInput.value = '0.00';
            }

            // Exibe a calculadora e esconde o formulário no carregamento inicial da página
            calculatorContainer.classList.remove('hidden');
            formContainer.classList.add('hidden');

            formatAndDisplay();
            updateTotalCart();
        });
    </script>

    <script src="/assets/js/loading.js"></script>
    <script src="/assets/js/new-mov-ADM.js"></script>
    <script src="/assets/js/time.js"></script>
</body>

</html>