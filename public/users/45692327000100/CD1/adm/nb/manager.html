<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Financeiro | Gest칚o</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #c50037; --primary-dark: #9e002c; --accent: #2c3e50;
      --bg-body: #f8fafc; --bg-card: #ffffff;
      --text-main: #1e293b; --text-muted: #64748b;
      --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
      --radius: 20px;
      --header-height: 70px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      margin: 0;
      padding-bottom: 100px;
    }

    /* --- LAYOUT --- */
    header {
      position: sticky; top: 0; z-index: 1000;
      background-color: var(--bg-body);
      padding: 15px 20px 5px 20px;
      display: flex; align-items: center; justify-content: space-between;
      height: var(--header-height);
    }

    .scrollable-header-content {
        padding: 0 20px;
        background-color: var(--bg-body);
        position: relative;
        z-index: 900;
    }

    .sticky-dashboard {
      position: sticky;
      top: var(--header-height); 
      z-index: 990;
      padding: 5px 20px 15px 20px;
      background-color: var(--bg-body);
      transition: all 0.3s ease;
      box-shadow: 0 15px 15px -10px rgba(248, 250, 252, 1); 
    }

    /* Elementos */
    header .icon-btn {
      color: var(--text-main); font-size: 24px; padding: 8px; border-radius: 50%;
      background: white; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      display: flex; cursor: pointer; border: none;
    }
    header .icon-btn:active { transform: scale(0.95); }
    header h1 { margin: 0; font-size: 1.1rem; font-weight: 700; }

    .search-box { position: relative; margin-bottom: 15px; }
    .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
    .search-box input { 
        padding-left: 40px; border-radius: 50px; background: #fff; border: none; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); width: 100%; padding-top:12px; padding-bottom:12px; font-family: inherit;
    }

    /* GR츼FICO */
    .chart-wrapper {
        background: white; border-radius: var(--radius); padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px;
        overflow: hidden;
        transition: max-height 0.5s ease, opacity 0.5s ease, padding 0.5s ease, filter 0.3s ease;
        max-height: 400px; opacity: 1;
    }
    .chart-wrapper.collapsed {
        max-height: 0; opacity: 0; padding: 0 20px; margin-bottom: 0;
    }
    .chart-toggle-btn {
        width: 100%; text-align: center; font-size: 0.8rem; color: var(--primary);
        cursor: pointer; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 5px;
    }
    .chart-header h3 { margin: 0 0 15px 0; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

    /* Dashboard Card */
    .finance-card {
      background: white; border-radius: var(--radius); padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.02);
    }

    .month-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .month-nav button { background: #f1f5f9; border: none; width: 32px; height: 32px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .month-label { font-size: 0.9rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); }

    .total-display { text-align: center; margin-bottom: 20px; }
    .total-display span { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; }
    .total-display strong { display: block; font-size: 2rem; font-weight: 800; color: var(--primary); letter-spacing: -1px; }

    /* PRIVACIDADE (Blur) */
    .blur-value { filter: blur(8px); user-select: none; opacity: 0.5; transition: all 0.3s; }

    /* Barra */
    .limit-container { margin-top: 10px; }
    .limit-labels { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 8px; font-weight: 600; color: var(--text-muted); }
    .segmented-bar { display: flex; height: 12px; border-radius: 6px; overflow: hidden; background-color: #e2e8f0; position: relative; }
    .seg-used { background-color: var(--primary); height: 100%; transition: width 0.6s ease; }
    .seg-today { background-color: var(--warning); height: 100%; transition: width 0.6s ease; }
    
    /* Lista */
    main { padding: 0 20px; margin-top: 5px; } 
    .section-title { font-size: 0.85rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 15px; }
    #contas-container { display: flex; flex-direction: column; gap: 12px; }

    .conta-card {
      background: var(--bg-card); border-radius: 16px; padding: 16px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
      display: flex; align-items: center; gap: 15px; border: 1px solid transparent; 
      opacity: 0; animation: slideInUp 0.4s ease-out forwards;
    }
    .conta-card:active { transform: scale(0.98); }
    .conta-card.pago { opacity: 0.6 !important; background: #f1f5f9; border: 1px dashed #cbd5e1; box-shadow: none; }
    .conta-card.pago .date-box { background: #e2e8f0; color: #94a3b8; }
    .conta-card.pago h3 { text-decoration: line-through; color: #94a3b8; }

    @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .conta-card:nth-child(1) { animation-delay: 0.05s; }
    .conta-card:nth-child(2) { animation-delay: 0.1s; }
    .conta-card:nth-child(3) { animation-delay: 0.15s; }

    .date-box { background: #f1f5f9; min-width: 52px; height: 52px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); font-weight: 700; }
    .date-box .d { font-size: 1.1rem; line-height: 1; }
    .date-box .m { font-size: 0.65rem; text-transform: uppercase; margin-top: 2px; }

    .conta-info { flex: 1; overflow: hidden; }
    .conta-info h3 { margin: 0 0 4px 0; font-size: 0.95rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conta-info p { margin: 0; font-size: 0.9rem; font-weight: 500; color: var(--text-muted); }

    .conta-card.status-hoje { border: 1px solid var(--warning); background: #fffbeb; }
    .status-hoje .date-box { background: rgba(245, 158, 11, 0.2); color: #d97706; }
    .conta-card.status-vencido { border: 1px solid var(--danger); background: #fef2f2; }
    .status-vencido .date-box { background: rgba(239, 68, 68, 0.15); color: #dc2626; }

    /* FAB */
    .fab-container { position: fixed; bottom: 30px; right: 25px; z-index: 1000; display: flex; flex-direction: column-reverse; align-items: center; gap: 15px; }
    .fab-main { width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; border: none; box-shadow: 0 8px 20px rgba(197, 0, 55, 0.3); font-size: 2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.3s; }
    .fab-option { width: 0; height: 0; opacity: 0; border-radius: 50%; border: none; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: all 0.2s; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); position: relative; }
    .fab-option::after { content: attr(data-label); position: absolute; right: 60px; background: white; color: var(--text-main); padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; white-space: nowrap; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .fab-container.active .fab-main { transform: rotate(45deg); background: var(--text-main); }
    .fab-container.active .fab-option { width: 50px; height: 50px; opacity: 1; }
    .fab-container.active .fab-option::after { opacity: 1; }
    #btnOpcaoNova { background: var(--success); }
    #btnOpcaoSaida { background: var(--accent); }

    .modal { display: none; position: fixed; z-index: 2000; inset: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); justify-content: center; align-items: flex-end; }
    .modal-content { background: white; width: 100%; max-width: 500px; padding: 30px 25px; border-radius: 25px 25px 0 0; animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    input, select { width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; margin-top: 8px; outline: none; background: #f8fafc; }
    input:focus { border-color: var(--primary); background: white; }
    .btn-submit { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; margin-top: 20px; font-size: 1rem; }
    
    #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 350px; pointer-events: none; }
    .toast { background: #1e293b; color: white; padding: 14px 20px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); display: flex; align-items: center; gap: 10px; justify-content: center; opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; }
    .toast.success { background: var(--success); } .toast.error { background: var(--danger); }

    .skeleton-card { background: white; border-radius: 16px; padding: 16px; display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
    .sk-box { width: 52px; height: 52px; border-radius: 12px; background: #e2e8f0; }
    .sk-lines { flex: 1; display: flex; flex-direction: column; gap: 8px; }
    .sk-line { height: 12px; border-radius: 4px; background: #e2e8f0; }
    .shimmer { animation: shimmer 1.5s infinite linear; background: linear-gradient(to right, #eff1f3 4%, #e2e2e2 25%, #eff1f3 36%); background-size: 1000px 100%; }
    @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
  </style>
</head>

<body>

  <header>
    <div class="header-actions">
        <a href="/users/45692327000100/CD1/adm/nb/conta.html" class="icon-btn"><i class='bx bx-chevron-left'></i></a>
    </div>
    <h1>Financeiro</h1>
    <div class="header-actions">
        <button class="icon-btn" id="btnPrivacy" onclick="togglePrivacy()"><i class='bx bx-show'></i></button>
    </div>
  </header>

  <div class="scrollable-header-content">
      <div class="search-box">
        <i class='bx bx-search'></i>
        <input type="text" id="inputBusca" placeholder="Buscar boleto...">
      </div>

      <div class="chart-wrapper sensitive-data" id="chartWrapper">
          <div class="chart-header">
              <h3>Hist칩rico de Gastos</h3>
          </div>
          <div style="height: 180px; position: relative;">
            <canvas id="expenseChart"></canvas>
          </div>
      </div>
      
      <div class="chart-toggle-btn" id="chartBtn" onclick="toggleChart()">
          Ver Gr치fico <i class='bx bx-chevron-down'></i>
      </div>
  </div>

  <div class="sticky-dashboard">
    <div class="finance-card">
      <div class="month-nav">
        <button id="prevMonth"><i class='bx bx-chevron-left'></i></button>
        <span class="month-label" id="currentMonthLabel">...</span>
        <button id="nextMonth"><i class='bx bx-chevron-right'></i></button>
      </div>

      <div class="total-display">
        <span id="labelTotalTitle">Total a Pagar</span>
        <strong id="monthTotal" class="sensitive-data">R$ 0,00</strong>
      </div>

      <div class="limit-container">
        <div class="limit-labels">
          <span id="labelUtilizado" class="sensitive-data">Utilizado: R$ 0</span>
          <span id="labelTeto">Teto: R$ 15k</span>
        </div>
        <div class="segmented-bar">
          <div class="seg-used" id="barUsed" style="width: 0%"></div>
          <div class="seg-today" id="barToday" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>

  <main>
    <div class="section-title">Lan칞amentos</div>
    <div id="contas-container"></div>
    <div style="height: 40px;"></div>
  </main>

  <div class="fab-container" id="fabMenu">
    <button class="fab-option" id="btnOpcaoSaida" data-label="Sa칤da"><i class='bx bx-trending-down'></i></button>
    <button class="fab-option" id="btnOpcaoNova" data-label="Entrada"><i class='bx bx-plus'></i></button>
    <button class="fab-main" id="fabTrigger"><i class='bx bx-plus'></i></button>
  </div>

  <div id="modalNovaConta" class="modal">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Nova Conta</h2>
        <i class='bx bx-x' style="font-size:1.5rem; padding:10px;" onclick="document.getElementById('modalNovaConta').style.display='none'"></i>
      </div>
      <form id="formNovaConta" style="margin-top:20px;">
        <label>Benefici치rio</label>
        <input type="text" id="beneficiario" required placeholder="Nome do favorecido">
        <label style="display:block; margin-top:15px;">Valor</label>
        <input type="tel" id="valor" required placeholder="R$ 0,00" inputmode="numeric">
        <label style="display:block; margin-top:15px;">Vencimento</label>
        <input type="text" id="vencimento" required placeholder="DD/MM/AAAA" maxlength="10" inputmode="numeric">
        <button type="submit" class="btn-submit">Registrar</button>
      </form>
    </div>
  </div>

  <div id="modalPagarConta" class="modal">
    <div class="modal-content">
      <h2 style="margin:0 0 5px 0;">Baixar Conta</h2>
      <p style="color:#64748b; margin:0 0 15px 0;">Confirmar pagamento de:</p>
      <h3 id="pagar-descricao">...</h3>
      <h2 id="pagar-valor" style="color:var(--primary); margin:5px 0 20px 0;">...</h2>
      <label>Forma de Pagamento</label>
      <select id="forma-pagamento">
        <option value="Pix">Pix</option>
        <option value="Boleto">Boleto</option>
        <option value="Dinheiro">Dinheiro</option>
        <option value="Cart칚o">Cart칚o</option>
      </select>
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button style="flex:1; padding:15px; border-radius:12px; border:none; background:#f1f5f9; font-weight:600;" onclick="document.getElementById('modalPagarConta').style.display='none'">Cancelar</button>
        <button id="btnConfirmarPagamento" style="flex:1; padding:15px; border-radius:12px; border:none; background:var(--success); color:white; font-weight:700;">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzkAs8dsJMepkQBhdL--XwO3wUQuQgvA-DFPEwraiz8ijiX9gkPMBuAeM5udQjzmJvzqQ/exec";
    
    // MAPA DE DATAS COMERCIAIS
    const DATAS_COMERCIO = {
        0: "Sald칚o",        // Jan
        1: "Carnaval",      // Fev (Variavel, mas ok fixar ref)
        2: "Dia Consumidor",// Mar
        3: "P치scoa",        // Abr
        4: "Dia das M칚es",  // Mai
        5: "Namorados",     // Jun
        6: "",              // Jul
        7: "Dia dos Pais",  // Ago
        8: "Dia Cliente",   // Set
        9: "Dia Crian칞as",  // Out
        10: "Black Friday", // Nov
        11: "Natal"         // Dez
    };

    let todasContas = [];
    let currentDate = new Date();
    let isPrivacyMode = false; 
    let myChart = null; 
    let isChartOpen = false;

    // DOM References
    const contasContainer = document.getElementById('contas-container');
    const labelMonth = document.getElementById('currentMonthLabel');
    const labelTotal = document.getElementById('monthTotal');
    const labelTotalTitle = document.getElementById('labelTotalTitle');
    const barUsed = document.getElementById('barUsed');
    const barToday = document.getElementById('barToday');
    const labelUtilizado = document.getElementById('labelUtilizado');
    const labelTeto = document.getElementById('labelTeto');
    const chartWrapper = document.getElementById('chartWrapper');
    const chartBtn = document.getElementById('chartBtn');
    
    const toastContainer = document.createElement('div');
    toastContainer.id = 'toast-container';
    document.body.appendChild(toastContainer);

    document.addEventListener('DOMContentLoaded', () => {
      renderSkeleton();
      carregarContas();
      updateDateLabel();
      initChartTimer();
    });

    // --- GR츼FICO ---
    function initChartTimer() {
        // Abre inicialmente
        isChartOpen = true;
        updateChartBtn();
        // Fecha ap칩s 45s
        setTimeout(() => {
            isChartOpen = false;
            chartWrapper.classList.add('collapsed');
            updateChartBtn();
        }, 45000);
    }

    function toggleChart() {
        isChartOpen = !isChartOpen;
        if(isChartOpen) chartWrapper.classList.remove('collapsed');
        else chartWrapper.classList.add('collapsed');
        updateChartBtn();
    }

    function updateChartBtn() {
        if(isChartOpen) chartBtn.innerHTML = `Ocultar Gr치fico <i class='bx bx-chevron-up'></i>`;
        else chartBtn.innerHTML = `Ver Gr치fico <i class='bx bx-chevron-down'></i>`;
    }

    function renderChart() {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        const labels = [], dataValues = [];
        
        // Gera 칰ltimos 6 meses
        for(let i=5; i>=0; i--) {
            const d = new Date(); d.setMonth(d.getMonth() - i);
            const m = d.getMonth() + 1, y = d.getFullYear(), monthIdx = d.getMonth();
            
            // L칩gica de Label com Data Comemorativa
            let labelBase = d.toLocaleString('pt-BR', { month: 'short' }).replace('.','').toUpperCase();
            let evento = DATAS_COMERCIO[monthIdx];
            // ChartJS aceita Array para m칰ltiplas linhas no eixo X
            if(evento && evento !== "") {
                labels.push([labelBase, `(${evento})`]);
            } else {
                labels.push(labelBase);
            }

            const total = todasContas.reduce((acc, c) => {
                const [day, month, year] = c.vencimento.split('/');
                return (parseInt(month)===m && parseInt(year)===y) ? acc + parseFloat(c.valor) : acc;
            }, 0);
            dataValues.push(total);
        }

        if(myChart) myChart.destroy();

        // Plugin para desenhar valor no topo
        const topLabels = {
            id: 'topLabels',
            afterDatasetsDraw(chart, args, pluginOptions) {
                const { ctx, data } = chart;
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    meta.data.forEach((bar, index) => {
                        const value = dataset.data[index];
                        if (value > 0) {
                            let formattedValue = value >= 1000 
                                ? (value / 1000).toFixed(1).replace('.', ',') + ' mil' 
                                : value.toFixed(0);
                            
                            ctx.fillStyle = '#c50037';
                            ctx.font = 'bold 10px "Plus Jakarta Sans"';
                            ctx.textAlign = 'center';
                            ctx.fillText(formattedValue, bar.x, bar.y - 8);
                        }
                    });
                });
            }
        }

        myChart = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels, 
                datasets: [{ 
                    data: dataValues, 
                    backgroundColor: '#c50037', 
                    borderRadius: 4, 
                    barThickness: 25,
                    borderSkipped: false 
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false }, tooltip: { enabled: false } }, 
                scales: { 
                    y: { display: false, beginAtZero: true, grace: '20%' }, 
                    x: { 
                        grid: { display: false, drawBorder: false }, 
                        ticks: { font: { size: 9, family: 'Plus Jakarta Sans' }, color: '#64748b' },
                        border: { display: false }
                    } 
                },
                layout: { padding: { top: 20 } }
            },
            plugins: [topLabels]
        });
    }

    // --- DADOS ---
    async function carregarContas() {
      try {
        const res = await fetch(`${SCRIPT_URL}?action=getContas`);
        const data = await res.json();
        todasContas = data.error ? [] : data;
        renderizarPainel();
        renderChart();
      } catch (e) { showToast("Erro ao carregar", "error"); }
    }

    function renderizarPainel() {
      const mesFiltro = currentDate.getMonth() + 1;
      const anoFiltro = currentDate.getFullYear();
      const hoje = new Date(); hoje.setHours(0,0,0,0);
      const hojeMes = hoje.getMonth() + 1;
      const hojeAno = hoje.getFullYear();

      let LIMITE_ATUAL = 15000.00;
      let textoTeto = "R$ 15k";
      if (mesFiltro === 1 || mesFiltro === 2) { LIMITE_ATUAL = 22500.00; textoTeto = "R$ 22.5k 游닄"; } 
      else if (mesFiltro === 10) { LIMITE_ATUAL = 22500.00; textoTeto = "R$ 22.5k 游꾸"; }
      labelTeto.innerHTML = `Teto: ${textoTeto}`;

      const isPastMonth = (anoFiltro < hojeAno) || (anoFiltro === hojeAno && mesFiltro < hojeMes);
      const isCurrentMonth = (anoFiltro === hojeAno && mesFiltro === hojeMes);

      const contasDoMes = todasContas.filter(c => {
        const [d, m, a] = c.vencimento.split('/');
        return parseInt(m) === mesFiltro && parseInt(a) === anoFiltro;
      });

      let totalGeral=0, totalVenceHoje=0, totalPendentes=0, totalPagas=0;
      contasDoMes.forEach(c => {
        const val = parseFloat(c.valor);
        const [d, m, a] = c.vencimento.split('/');
        const dt = new Date(a, m - 1, d);
        if (c.status === 'pago') totalPagas += val;
        else {
             totalPendentes += val;
             if (dt.getTime() === hoje.getTime()) totalVenceHoje += val;
        }
      });

      if (isPastMonth) {
          labelTotalTitle.textContent = "Total Pago";
          totalGeral = totalPagas;
          const pct = (totalPagas / LIMITE_ATUAL) * 100;
          barUsed.style.width = `${Math.min(pct, 100)}%`; barToday.style.width = '0%';
      } else {
          labelTotalTitle.textContent = "Comprometido";
          totalGeral = totalPagas + totalPendentes;
          const pctOut = ((totalGeral - totalVenceHoje) / LIMITE_ATUAL) * 100;
          const pctHoj = (totalVenceHoje / LIMITE_ATUAL) * 100;
          const fat = (pctOut+pctHoj) > 100 ? (100/(pctOut+pctHoj)) : 1;
          barUsed.style.width = `${pctOut * fat}%`; barToday.style.width = `${pctHoj * fat}%`;
      }

      labelTotal.textContent = 'R$ ' + totalGeral.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
      labelUtilizado.textContent = `Utilizado: R$ ${totalGeral.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;

      contasContainer.innerHTML = '';
      if (isCurrentMonth && totalPendentes === 0 && contasDoMes.length > 0) celebrarConquista();

      if (contasDoMes.length === 0) {
        contasContainer.innerHTML = `<div style="text-align:center; padding:40px 20px; color:#94a3b8;">Nenhum registro.</div>`;
        return;
      }

      contasDoMes.sort((a, b) => {
        if (a.status !== 'pago' && b.status === 'pago') return -1;
        if (a.status === 'pago' && b.status !== 'pago') return 1;
        const [da, ma, aa] = a.vencimento.split('/'); const [db, mb, ab] = b.vencimento.split('/');
        return new Date(aa, ma - 1, da) - new Date(ab, mb - 1, db);
      });

      contasDoMes.forEach(conta => {
        const [dia, mes, ano] = conta.vencimento.split('/');
        const dataConta = new Date(ano, mes - 1, dia);
        const mesTexto = dataConta.toLocaleString('pt-BR', { month: 'short' }).replace('.', '');
        
        let statusClass = '', iconHtml = "<i class='bx bx-chevron-right' style='font-size:1.5rem'></i>", clickAction = `onclick="abrirModalPagar(this, '${conta.id}', '${conta.descricao}', '${conta.valor}')"`;

        if (conta.status === 'pago') {
            statusClass = 'pago'; iconHtml = "<i class='bx bx-check-double' style='font-size:1.5rem; color:#10b981;'></i>"; clickAction = ""; 
        } else {
            if (dataConta.getTime() === hoje.getTime()) statusClass = 'status-hoje';
            else if (dataConta < hoje) statusClass = 'status-vencido';
        }

        const blurClass = isPrivacyMode ? 'blur-value' : '';
        const card = document.createElement('div');
        card.className = `conta-card ${statusClass}`;
        card.innerHTML = `
            <div class="date-box"><span class="d">${dia}</span><span class="m">${mesTexto}</span></div>
            <div class="conta-info" ${clickAction}><h3>${conta.descricao}</h3><p class="${blurClass}">R$ ${parseFloat(conta.valor).toFixed(2).replace('.', ',')}</p></div>
            <div style="color:#cbd5e1;">${iconHtml}</div>`;
        contasContainer.appendChild(card);
      });
    }

    // --- UTILS ---
    function celebrarConquista() { var end = Date.now() + 2000; (function frame() { confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0 } }); confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 } }); if (Date.now() < end) requestAnimationFrame(frame); }()); }
    
    // ATUALIZADO: Privacy afeta tudo com classe sensitive-data (Valores + Gr치fico)
    function togglePrivacy() { 
        isPrivacyMode = !isPrivacyMode; 
        const btn = document.getElementById('btnPrivacy').querySelector('i');
        btn.className = isPrivacyMode ? 'bx bx-hide' : 'bx bx-show'; 
        
        const elements = document.querySelectorAll('.sensitive-data');
        elements.forEach(el => {
            if(isPrivacyMode) el.classList.add('blur-value');
            else el.classList.remove('blur-value');
        });
        
        // Re-render lista para aplicar nos itens individuais
        renderizarPainel(); 
    }

    function showToast(msg, type) { if(navigator.vibrate) navigator.vibrate(50); const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = (type==='success'?"<i class='bx bx-check'></i>":"<i class='bx bx-x'></i>") + `<span>${msg}</span>`; toastContainer.appendChild(t); requestAnimationFrame(()=> { t.style.opacity='1'; t.style.transform='translateY(0)'; }); setTimeout(()=> { t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 3000); }
    
    document.getElementById('prevMonth').onclick = () => changeMonth(-1);
    document.getElementById('nextMonth').onclick = () => changeMonth(1);
    function changeMonth(delta) { currentDate.setMonth(currentDate.getMonth() + delta); updateDateLabel(); renderSkeleton(); setTimeout(renderizarPainel, 300); }
    function updateDateLabel() { const months = ['Janeiro', 'Fevereiro', 'Mar칞o', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro']; labelMonth.textContent = `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`; }
    function renderSkeleton() { contasContainer.innerHTML = '<div class="skeleton-card"><div class="sk-box shimmer"></div><div class="sk-lines"><div class="sk-line shimmer"></div></div></div>'.repeat(3); }

    const fabTrigger = document.getElementById('fabTrigger'); const fabMenu = document.getElementById('fabMenu');
    fabTrigger.onclick = () => fabMenu.classList.toggle('active');
    document.getElementById('btnOpcaoNova').onclick = () => { fabMenu.classList.remove('active'); document.getElementById('modalNovaConta').style.display='flex'; };
    document.getElementById('btnOpcaoSaida').onclick = () => window.location.href = "/users/45692327000100/CD1/adm/nb/pushBuy.html";
    window.abrirModalPagar = (el, id, desc, val) => { document.getElementById('pagar-descricao').textContent = desc; document.getElementById('pagar-valor').textContent = 'R$ ' + parseFloat(val).toFixed(2).replace('.', ','); document.getElementById('btnConfirmarPagamento').dataset.id = id; document.getElementById('modalPagarConta').style.display = 'flex'; };

    document.getElementById('formNovaConta').addEventListener('submit', async (e) => { e.preventDefault(); const btn = e.target.querySelector('button'); btn.innerText='...'; try { const [d,m,a] = document.getElementById('vencimento').value.split('/'); const payload = { id:Date.now().toString(), descricao:document.getElementById('beneficiario').value, valor: document.getElementById('valor').value.replace(/\D/g,'')/100, vencimento:`${a}-${m}-${d}` }; await fetch(SCRIPT_URL, { method:'POST', body:JSON.stringify({action:'adicionarConta', data:payload}) }); document.getElementById('modalNovaConta').style.display='none'; showToast('Salvo!','success'); carregarContas(); } catch(err) { showToast('Erro','error'); } btn.innerText='Registrar'; });
    document.getElementById('btnConfirmarPagamento').onclick = async (e) => { const btn = e.target; btn.innerText='...'; try { await fetch(SCRIPT_URL, { method:'POST', body:JSON.stringify({action:'pagarConta', id:btn.dataset.id, paymentMethod:document.getElementById('forma-pagamento').value}) }); document.getElementById('modalPagarConta').style.display='none'; showToast('Pago!','success'); carregarContas(); } catch(err) { showToast('Erro','error'); } btn.innerText='Confirmar'; };
    document.getElementById('inputBusca').addEventListener('input', (e) => { const t = e.target.value.toLowerCase(); document.querySelectorAll('.conta-card').forEach(c => c.style.display = c.innerText.toLowerCase().includes(t) ? 'flex':'none'); });
    document.getElementById('valor').addEventListener('input', (e) => { let v=e.target.value.replace(/\D/g,''); e.target.value='R$ '+(parseInt(v||0)/100).toLocaleString('pt-BR',{minimumFractionDigits:2}); });
    document.getElementById('vencimento').addEventListener('input', (e) => { let v=e.target.value.replace(/\D/g,''); if(v.length>2)v=v.slice(0,2)+'/'+v.slice(2); if(v.length>5)v=v.slice(0,5)+'/'+v.slice(5,9); e.target.value=v; });

  </script>
</body>
</html>