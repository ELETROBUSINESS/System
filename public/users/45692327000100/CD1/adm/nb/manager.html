<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gestão Financeira Semanal | Premium</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
    rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel='stylesheet'
    href='https://cdn-uicons.flaticon.com/2.6.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #c50037;
      /* Deep Elegant Red */
      --primary-soft: #fdf2f4;
      --secondary: #1e293b;
      /* Slate 800 */
      --bg-body: #f8fafc;
      /* Slate 50 */
      --bg-card: #ffffff;
      --text-main: #0f172a;
      /* Slate 900 */
      --text-muted: #64748b;
      /* Slate 500 */
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-sm: 12px;
      --header-height: 70px;
      --shadow-sm: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
      --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      margin: 0;
      padding-bottom: 120px;
      /* Space for FAB */
    }

    /* --- LAYOUT --- */
    header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: rgba(248, 250, 252, 0.9);
      backdrop-filter: blur(10px);
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: var(--header-height);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    header h1 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-main);
    }

    header a {
      text-decoration: none;
    }

    header .icon-btn {
      color: var(--text-main);
      font-size: 20px;
      padding: 10px;
      border-radius: 50%;
      background: white;
      box-shadow: var(--shadow-sm);
      display: flex;
      cursor: pointer;
      border: 1px solid #e2e8f0;
      transition: all 0.2s;
    }

    header .icon-btn:active {
      transform: scale(0.95);
    }

    /* --- DASHBOARD SECTION --- */
    .dashboard-container {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    .month-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 10px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      margin-bottom: 20px;
    }

    .month-nav button {
      background: #f1f5f9;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: var(--secondary);
      transition: background 0.2s;
    }

    .month-nav button:active {
      background: #e2e8f0;
    }

    .month-label {
      font-size: 1rem;
      font-weight: 700;
      color: var(--secondary);
      text-transform: capitalize;
    }

    /* FINANCIAL CARD (Updated) */
    .finance-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: 25px;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
      border: 1px solid #f1f5f9;
    }

    .finance-card::before {
      display: none;
    }

    .total-display {
      text-align: center;
      margin-bottom: 25px;
    }

    .total-display span {
      display: block;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 5px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .total-display strong {
      display: block;
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary);
      letter-spacing: -1.5px;
      line-height: 1;
    }

    .blur-value {
      filter: blur(8px);
      user-select: none;
      opacity: 0.6;
    }

    /* Progress Bar */
    .limit-container {
      margin-top: 10px;
    }

    .segmented-bar {
      display: flex;
      height: 14px;
      border-radius: 7px;
      background-color: #f1f5f9;
      overflow: hidden;
    }

    .seg-paid {
      background-color: var(--primary);
      height: 100%;
      cursor: pointer;
    }

    .seg-today {
      background-color: #cbd5e1;
      height: 100%;
      cursor: pointer;
    }

    .seg-pending {
      background-color: #e2e8f0;
      height: 100%;
      cursor: pointer;
    }

    .bar-line-legend {
      text-align: center;
      margin-top: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      min-height: 20px;
      transition: opacity 0.3s;
      opacity: 0;
    }

    .limit-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    /* CHART WRAPPER (Moved) */
    .chart-wrapper {
      background: white;
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-sm);
      border: 1px solid #f1f5f9;
      margin-top: 10px;
      transition: all 0.3s ease;
      height: auto;
      overflow: hidden;
      display: block;
    }

    .chart-wrapper.collapsed {
      display: none;
    }

    .chart-toggle-btn {
      width: 100%;
      text-align: center;
      font-size: 0.8rem;
      color: var(--primary);
      cursor: pointer;
      font-weight: 700;
      padding: 10px;
      margin-top: -10px;
      background: transparent;
      border: none;
    }

    /* --- WEEKLY BREAKDOWN --- */
    .weekly-list {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .week-group {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .week-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding: 0 5px;
    }

    .week-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--secondary);
    }

    .week-dates {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
      display: block;
      margin-top: 2px;
    }

    .week-total {
      text-align: right;
    }

    .week-total .val {
      font-weight: 800;
      color: var(--primary);
      font-size: 0.95rem;
    }

    .week-total .lbl {
      font-size: 0.7rem;
      color: var(--text-muted);
      display: block;
    }

    /* Weekly Forecast Card (Mini) */
    .week-forecast-card {
      background: white;
      border-radius: var(--radius-md);
      padding: 15px;
      margin-bottom: 12px;
      border: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
    }

    .wf-item {
      flex: 1;
    }

    .wf-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .wf-value {
      font-size: 1rem;
      font-weight: 700;
      color: var(--secondary);
    }

    .wf-value.income {
      color: var(--secondary);
    }

    .wf-value.expense {
      color: var(--primary);
    }

    .wf-bar-bg {
      width: 100%;
      height: 6px;
      background: #f1f5f9;
      border-radius: 3px;
      margin-top: 8px;
    }

    .wf-bar-fill {
      height: 100%;
      border-radius: 3px;
    }

    /* CONTA CARD (List Items) */
    .conta-card {
      background: white;
      border-radius: var(--radius-md);
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
      border: 1px solid #f1f5f9;
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .conta-card:active {
      transform: scale(0.98);
      background: #f8fafc;
    }

    .conta-card.status-pago {
      opacity: 0.7;
      background: #f8fafc;
      border: 1px dashed #cbd5e1;
    }

    .conta-card.status-pago h3 {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .conta-card.status-hoje {
      border: 1px solid var(--warning);
      background: #fffbeb;
    }

    .conta-card.status-vencido {
      border: 1px solid var(--danger);
      background: #fef2f2;
    }

    .date-box {
      background: #f1f5f9;
      min-width: 48px;
      height: 48px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .date-box .d {
      font-size: 1rem;
      font-weight: 700;
      line-height: 1;
    }

    .date-box .m {
      font-size: 0.6rem;
      text-transform: uppercase;
      font-weight: 600;
      margin-top: 2px;
    }

    .conta-info {
      flex: 1;
      overflow: hidden;
    }

    .conta-info h3 {
      margin: 0 0 2px 0;
      font-size: 0.9rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--secondary);
    }

    .conta-info p {
      margin: 0;
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--primary);
    }

    .conta-card.status-pago .conta-info p {
      color: var(--text-muted);
      font-weight: 500;
    }

    /* FAB */
    .fab-container {
      position: fixed;
      bottom: 30px;
      right: 25px;
      z-index: 1000;
      display: flex;
      flex-direction: column-reverse;
      align-items: center;
      gap: 15px;
    }

    .fab-main {
      width: 60px;
      height: 60px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      border: none;
      box-shadow: 0 8px 20px rgba(197, 0, 55, 0.4);
      font-size: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.3s;
    }

    .fab-option {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      background: var(--secondary);
      opacity: 0;
      transform: translateY(20px);
      position: absolute;
      visibility: hidden;
    }

    .fab-container.active .fab-main {
      transform: rotate(45deg) scale(1.1);
      background: var(--secondary);
    }

    .fab-container.active .fab-option {
      opacity: 1;
      transform: translateY(0);
      position: relative;
      visibility: visible;
    }

    /* Helper for FAB content */
    .fab-option::after {
      content: attr(data-label);
      position: absolute;
      right: 60px;
      background: white;
      color: var(--text-main);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* MODAL */
    .modal {
      display: none;
      display: none;
      /* Hidden by default */
      position: fixed;
      z-index: 2000;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      align-items: flex-end;
      /* Bottom Sheet style */
      justify-content: center;
    }

    .modal-content {
      background: white;
      width: 100%;
      max-width: 600px;
      border-radius: 24px 24px 0 0;
      padding: 30px 25px;
      animation: slideUp 0.3s ease-out;
      box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.1);
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }

      to {
        transform: translateY(0);
      }
    }

    input,
    select {
      width: 100%;
      padding: 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 1rem;
      margin-top: 8px;
      outline: none;
      background: #f8fafc;
      transition: border-color 0.2s;
    }

    input:focus {
      border-color: var(--primary);
      background: white;
    }

    .btn-submit {
      width: 100%;
      padding: 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      margin-top: 25px;
      font-size: 1rem;
      cursor: pointer;
    }

    /* TOAST */
    #toast-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 90%;
      max-width: 350px;
      pointer-events: none;
    }

    .toast {
      background: var(--secondary);
      color: white;
      padding: 14px 20px;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.warning {
      background: var(--warning);
      color: #FFF;
    }
  </style>
</head>

<body>

  <header>
    <a href="/users/45692327000100/CD1/adm/nb/conta.html" class="icon-btn"><i class='bx bx-chevron-left'></i></a>
    <h1>Gestão de Contas</h1>
    <button class="icon-btn" id="btnPrivacy" onclick="togglePrivacy()"><i class='bx bx-show'></i></button>
  </header>

  <div class="dashboard-container">

    <!-- MONTH NAV -->
    <div class="month-nav">
      <button id="prevMonth"><i class='bx bx-chevron-left'></i></button>
      <span class="month-label" id="currentMonthLabel">...</span>
      <button id="nextMonth"><i class='bx bx-chevron-right'></i></button>
    </div>

    <!-- FINANCE CARD -->
    <div class="finance-card">
      <div class="total-display">
        <span id="labelTotalTitle">Resumo do Mês</span>
        <strong id="monthTotal" class="sensitive-data">R$ 0,00</strong>
      </div>

      <div class="limit-container">
        <div class="segmented-bar">
          <div class="seg-paid" id="barPaid" style="width: 0%"></div>
          <div class="seg-today" id="barToday" style="width: 0%"></div>
          <div class="seg-pending" id="barPending" style="width: 0%"></div>
        </div>
        <div class="limit-labels">
          <span id="labelUtilizado" class="sensitive-data">Pago: R$ 0</span>
          <span id="labelTeto">Limite: R$ 15k</span>
        </div>
        <div id="barLegend" class="bar-line-legend"></div>
      </div>
    </div>



    <!-- WEEKLY LIST -->
    <div id="weeklyContainer" class="weekly-list">
      <!-- Content generated by JS -->
    </div>

  </div>

  <!-- FAB -->
  <div class="fab-container" id="fabMenu">
    <button class="fab-option" id="btnOpcaoSaida" data-label="Nova Despesa"><i class='bx bx-trending-down'></i></button>
    <button class="fab-option" id="btnOpcaoNova" data-label="Nova Conta"><i class='bx bx-plus'></i></button>
    <button class="fab-main" id="fabTrigger"><i class='bx bx-plus'></i></button>
  </div>

  <!-- MODALS -->
  <div id="modalNovaConta" class="modal">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Nova Conta</h2>
        <i class='bx bx-x' style="font-size:1.5rem; padding:10px;"
          onclick="document.getElementById('modalNovaConta').style.display='none'"></i>
      </div>
      <form id="formNovaConta" style="margin-top:20px;">
        <label>Beneficiário</label>
        <input type="text" id="beneficiario" required placeholder="Nome do favorecido">
        <label style="display:block; margin-top:15px;">Valor</label>
        <input type="tel" id="valor" required placeholder="R$ 0,00" inputmode="numeric">
        <label style="display:block; margin-top:15px;">Vencimento</label>
        <input type="text" id="vencimento" required placeholder="DD/MM/AAAA" maxlength="10" inputmode="numeric">

        <label style="display:block; margin-top:15px;">Parcelas</label>
        <select id="parcelas" style="margin-top:8px;">
          <option value="1">À vista (1x)</option>
          <option value="2">2x</option>
          <option value="3">3x</option>
          <option value="4">4x</option>
          <option value="5">5x</option>
          <option value="6">6x</option>
        </select>

        <button type="submit" class="btn-submit">Registrar</button>
      </form>
    </div>
  </div>

  <div id="modalNovaDespesa" class="modal">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Nova Despesa</h2>
        <i class='bx bx-x' style="font-size:1.5rem; padding:10px;"
          onclick="document.getElementById('modalNovaDespesa').style.display='none'"></i>
      </div>
      <form id="formNovaDespesa" style="margin-top:20px;">
        <label>Valor da Operação</label>
        <input type="tel" id="despesa-valor" required placeholder="R$ 0,00" inputmode="numeric">

        <label style="display:block; margin-top:15px;">Categoria</label>
        <select id="despesa-declaracao">
          <option value="">Selecione...</option>
          <option value="Aquisição de Mercadoria">Aquisição de Mercadoria</option>
          <option value="Folha de pagamento">Folha de pagamento</option>
          <option value="Manutenção da Loja">Manutenção da Loja</option>
          <option value="Campanhas">Campanhas</option>
          <option value="Combustíveis">Combustíveis</option>
          <option value="Energia">Energia</option>
          <option value="Outras despesas">Outras despesas</option>
        </select>

        <label style="display:block; margin-top:15px;">Forma de Pagamento</label>
        <select id="despesa-pagamento">
          <option value="Dinheiro">Dinheiro</option>
          <option value="Pix">Pix</option>
          <option value="Cartão de Débito">Cartão de Débito</option>
        </select>

        <label style="display:block; margin-top:15px;">Descrição</label>
        <input type="text" id="despesa-descricao" required placeholder="Detalhes (opcional)">

        <button type="submit" class="btn-submit">Lançar Despesa</button>
      </form>
    </div>
  </div>

  <div id="modalPagarConta" class="modal">
    <div class="modal-content">
      <h2 style="margin:0 0 5px 0; color: var(--secondary);">Detalhes da Conta</h2>
      <div style="background: #f8fafc; padding: 20px; border-radius: 16px; margin: 20px 0;">
        <p style="color:#64748b; margin:0 0 5px 0; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">
          Beneficiário</p>
        <h3 id="pagar-descricao" style="margin:0 0 15px 0; font-size: 1.1rem; color: var(--text-main);">...</h3>

        <div style="display: flex; gap: 20px;">
          <div>
            <p
              style="color:#64748b; margin:0 0 5px 0; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">
              Valor</p>
            <h2 id="pagar-valor" style="color:var(--primary); margin:0; line-height: 1;">...</h2>
          </div>
          <div id="invoice-section" style="border-left: 2px solid #e2e8f0; padding-left: 20px;">
            <p
              style="color:#64748b; margin:0 0 5px 0; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">
              Nota Fiscal</p>
            <div style="font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px;">
              <i class='bx bx-file-blank'></i>
              <span id="invoice-status">Será emitida ao pagar</span>
            </div>
          </div>
        </div>
      </div>

      <label style="font-weight: 600; color: var(--secondary); font-size: 0.9rem;">Forma de Pagamento</label>
      <select id="forma-pagamento" style="border-color: #cbd5e1;">
        <option value="Pix">Pix</option>
        <option value="Boleto">Boleto</option>
        <option value="Dinheiro">Dinheiro</option>
        <option value="Cartão">Cartão</option>
      </select>

      <div style="display:flex; gap:10px; margin-top:25px;">
        <button
          style="flex:1; padding:15px; border-radius:12px; border:none; background:transparent; color: var(--text-muted); font-weight:600; border: 1px solid #e2e8f0;"
          onclick="document.getElementById('modalPagarConta').style.display='none'">Fechar</button>
        <button id="btnConfirmarPagamento"
          style="flex:2; padding:15px; border-radius:12px; border:none; background:var(--secondary); color:white; font-weight:700; display: flex; align-items: center; justify-content: center; gap: 8px;">
          <i class='bx bx-check-circle'></i> Confirmar Baixa
        </button>
      </div>
    </div>
  </div>

  <div id="modalPagarEletro" class="modal">
    <div class="modal-content">
      <h2 style="margin:0 0 5px 0; color: var(--secondary);">Pagamento Eletro</h2>
      <div style="background: #f8fafc; padding: 20px; border-radius: 16px; margin: 20px 0;">
        <p style="color:#64748b; margin:0 0 5px 0; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">
          Descrição</p>
        <h3 id="eletro-descricao" style="margin:0 0 15px 0; font-size: 1.1rem; color: var(--text-main);">...</h3>

        <div style="display: flex; gap: 20px;">
          <div>
            <p
              style="color:#64748b; margin:0 0 5px 0; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">
              Valor</p>
            <h2 id="eletro-valor" style="color:var(--primary); margin:0; line-height: 1;">...</h2>
          </div>
          <div id="invoice-section" style="border-left: 2px solid #e2e8f0; padding-left: 20px;">
            <p
              style="color:#64748b; margin:0 0 5px 0; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">
              Nota Fiscal</p>
            <div style="font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px;">
              <i class="bx bx-file-blank"></i>
              <span id="invoice-status">Será emitida ao pagar</span>
            </div>
          </div>
        </div>
      </div>

      <div id="eletro-payment-area">
        <!-- Content Injected via JS -->
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzkAs8dsJMepkQBhdL--XwO3wUQuQgvA-DFPEwraiz8ijiX9gkPMBuAeM5udQjzmJvzqQ/exec";
    const DATAS_COMERCIO = { 0: "Volta às aulas", 1: "Carnaval", 2: "Consumidor", 3: "Páscoa", 4: "Mães", 5: "Namorados", 7: "Pais", 9: "Crianças", 10: "Black Friday", 11: "Natal" };

    let todasContas = [];
    let currentDate = new Date();
    let isPrivacyMode = false;

    // DOM Elements
    const weeklyContainer = document.getElementById('weeklyContainer');
    const labelMonth = document.getElementById('currentMonthLabel');
    const labelTotal = document.getElementById('monthTotal');
    const labelTotalTitle = document.getElementById('labelTotalTitle');
    const barPaid = document.getElementById('barPaid');
    const barPending = document.getElementById('barPending');
    const barToday = document.getElementById('barToday');
    const labelUtilizado = document.getElementById('labelUtilizado');
    const labelTeto = document.getElementById('labelTeto');

    // Toast
    const toastContainer = document.createElement('div');
    toastContainer.id = 'toast-container';
    document.body.appendChild(toastContainer);

    document.addEventListener('DOMContentLoaded', () => {
      carregarContas();
      updateDateLabel();

      const showLegend = (msg) => {
        const el = document.getElementById('barLegend');
        el.textContent = msg;
        el.style.opacity = '1';
        if (el.timeout) clearTimeout(el.timeout);
        el.timeout = setTimeout(() => el.style.opacity = '0', 3000);
      };

      barPaid.onclick = () => showLegend('Total já pago no mês (Confirmado)');
      barToday.onclick = () => showLegend('Contas vencendo hoje');
      barPending.onclick = () => showLegend('Restante a pagar (Pendente)');
    });

    // --- DATA FETCHING ---
    async function carregarContas() {
      try {
        const res = await fetch(`${SCRIPT_URL}?action=getContas`);
        const data = await res.json();
        todasContas = data.error ? [] : data;
        renderizarPainel();
      } catch (e) {
        showToast("Erro ao carregar dados", "error");
      }
    }

    // --- RENDER LOGIC ---
    function renderizarPainel() {
      const mesFiltro = currentDate.getMonth() + 1;
      const anoFiltro = currentDate.getFullYear();
      const hoje = new Date(); hoje.setHours(0, 0, 0, 0);

      // Limites e Teto
      let LIMITE_ATUAL = 15000.00;
      let htmlTeto = "Teto: R$ 15k";
      if (mesFiltro === 1 || mesFiltro === 2) { LIMITE_ATUAL = 28500.00; htmlTeto = `Teto: R$ 28.5k`; }
      else if (mesFiltro === 10) { LIMITE_ATUAL = 22500.00; htmlTeto = `Teto: R$ 22.5k`; }
      labelTeto.innerHTML = htmlTeto;

      // Filtrar Contas do Mês
      const contasDoMes = todasContas.filter(c => {
        const [d, m, a] = c.vencimento.split('/');
        return parseInt(m) === mesFiltro && parseInt(a) === anoFiltro;
      });

      // Cálculos Totais
      let totalPagas = 0, totalPendentes = 0, totalVenceHoje = 0;
      contasDoMes.forEach(c => {
        const val = parseFloat(c.valor);
        const [d, m, a] = c.vencimento.split('/');
        const dt = new Date(a, m - 1, d);
        if (c.status === 'pago') totalPagas += val;
        else {
          totalPendentes += val;
          if (dt.getTime() === hoje.getTime()) totalVenceHoje += val;
        }
      });

      const totalGeral = totalPagas + totalPendentes;

      // Update Header Card
      const pctPaid = (totalPagas / LIMITE_ATUAL) * 100;
      const pctPend = ((totalPendentes - totalVenceHoje) / LIMITE_ATUAL) * 100; // Pendente puro
      const pctHoje = (totalVenceHoje / LIMITE_ATUAL) * 100;

      // Ajuste visual para não estourar a barra
      const totalPct = pctPaid + pctPend + pctHoje;
      const fator = totalPct > 100 ? (100 / totalPct) : 1;

      barPaid.style.width = `${pctPaid * fator}%`;
      barToday.style.width = `${pctHoje * fator}%`;
      barPending.style.width = `${pctPend * fator}%`;

      labelTotal.textContent = `R$ ${totalGeral.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
      labelUtilizado.textContent = `Pago: R$ ${totalPagas.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;

      // --- WEEKLY GROUPING LOGIC ---
      weeklyContainer.innerHTML = '';
      if (contasDoMes.length === 0) {
        weeklyContainer.innerHTML = `<div style="text-align:center; padding:40px; color:#94a3b8;">Nenhum registro encontrado.</div>`;
        return;
      }

      // Group by Week (Simple 7 days chunks or Calendar?)
      // Calendar Week is better.
      const weeks = {};

      // Helper to get week number of month (approximate)
      // W1: 1-7, W2: 8-14, W3: 15-21, W4: 22-28, W5: 29-31
      // Or by Calendar Week (Sunday start)?
      // For simplicity and clarity mentioned in request ("organizar"), simple date ranges are often best understood visually.
      // Let's stick to 7-day chunks for consistency in "Weeks".

      contasDoMes.forEach(c => {
        const day = parseInt(c.vencimento.split('/')[0]);
        let weekNum = Math.ceil(day / 7);
        if (weekNum > 5) weekNum = 5; // Should fit in 5 weeks max (31 days)

        if (!weeks[weekNum]) {
          weeks[weekNum] = {
            id: weekNum,
            bills: [],
            total: 0,
            start: (weekNum - 1) * 7 + 1,
            end: Math.min(weekNum * 7, 31)
          };
        }
        weeks[weekNum].bills.push(c);
        weeks[weekNum].total += parseFloat(c.valor);
      });

      // Render Weeks
      Object.keys(weeks).sort().forEach(weekKey => {
        const week = weeks[weekKey];
        const weekTotalFmt = week.total.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        const pendingTotal = week.bills.reduce((acc, c) => c.status !== 'pago' ? acc + parseFloat(c.valor) : acc, 0);
        const pendingFmt = pendingTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 });

        const allPaid = week.bills.length > 0 && pendingTotal === 0;

        // Determine displayed value and label
        let displayVal = allPaid ? `R$ ${weekTotalFmt}` : `R$ ${pendingFmt}`;
        let displayLbl = allPaid ? "Total Finalizado" : "Pendente na Semana";
        let valColor = allPaid ? "var(--success)" : "var(--primary)";

        const uniqueId = `week-list-${weekKey}`;
        const iconId = `week-icon-${weekKey}`;

        const weekDiv = document.createElement('div');
        weekDiv.className = 'week-group';
        weekDiv.style.marginBottom = '20px';

        // Header with Toggle
        let htmlHeader = `
            <div class="week-header" onclick="toggleWeek('${uniqueId}', '${iconId}')" style="cursor:pointer; user-select:none;">
                <div>
                   <div class="week-title">Semana ${weekKey}</div>
                   <span class="week-dates">Dia ${week.start} a ${week.end}</span>
                </div>
                <div class="week-total" style="display:flex; align-items:center; gap:10px;">
                    <div>
                        <span class="val" style="color:${valColor}">${displayVal}</span>
                        <span class="lbl">${displayLbl}</span>
                    </div>
                    <i id="${iconId}" class='bx bx-chevron-${allPaid ? 'down' : 'up'}' style="font-size:1.5rem; color:var(--text-muted); transition: transform 0.3s;"></i>
                </div>
            </div>`;

        weekDiv.innerHTML = htmlHeader;

        // List Container
        const listDiv = document.createElement('div');
        listDiv.id = uniqueId;
        // If all paid, start collapsed (none), else start visible (block)
        listDiv.style.display = allPaid ? 'none' : 'block';
        listDiv.style.marginTop = '10px';

        // SORTING logic...
        week.bills.sort((a, b) => {
          let aPaid = (a.status === 'pago');
          let bPaid = (b.status === 'pago');
          if (!aPaid && bPaid) return -1;
          if (aPaid && !bPaid) return 1;
          const [da, ma, aa] = a.vencimento.split('/');
          const [db, mb, ab] = b.vencimento.split('/');
          return new Date(aa, ma - 1, da) - new Date(ab, mb - 1, db);
        });

        week.bills.forEach(conta => {
          const [d, m, a] = conta.vencimento.split('/');
          const dataConta = new Date(a, m - 1, d);
          const mesTexto = dataConta.toLocaleString('pt-BR', { month: 'short' }).replace('.', '');

          let statusClass = '';
          let icon = "<i class='bx bx-chevron-right' style='font-size:1.5rem'></i>";
          // Pass explicit click handler to row
          let clickAction = `abrirModalPagar(this, '${conta.id}', '${conta.descricao}', '${conta.valor}')`;

          if (conta.status === 'pago') {
            statusClass = 'status-pago';
            icon = "<i class='bx bx-check-double' style='font-size:1.5rem; color:var(--primary);'></i>";
          } else if (dataConta.getTime() === hoje.getTime()) {
            statusClass = 'status-hoje';
            icon = "<i class='bx bxs-error-circle' style='font-size:1.5rem; color:var(--primary);'></i>";
          } else if (dataConta < hoje) {
            statusClass = 'status-vencido';
            icon = "<i class='bx bxs-error' style='font-size:1.5rem; color:var(--primary);'></i>";
          }

          const blurClass = isPrivacyMode ? 'blur-value' : '';
          const valFmt = parseFloat(conta.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 });

          const card = document.createElement('div');
          card.className = `conta-card ${statusClass}`;
          card.setAttribute('onclick', clickAction);

          card.innerHTML = `
                <div class="date-box">
                    <span class="d">${d}</span>
                    <span class="m">${mesTexto}</span>
                </div>
                <div class="conta-info">
                    <h3>${conta.descricao}</h3>
                    <p class="${blurClass}">R$ ${valFmt}</p>
                </div>
                <div style="color:#cbd5e1;">${icon}</div>
             `;
          listDiv.appendChild(card);
        });

        weekDiv.appendChild(listDiv);
        weeklyContainer.appendChild(weekDiv);
      });
    }

    // Toggle function for week
    window.toggleWeek = (listId, iconId) => {
      const list = document.getElementById(listId);
      const icon = document.getElementById(iconId);
      if (list.style.display === 'none') {
        list.style.display = 'block';
        icon.className = 'bx bx-chevron-up';
      } else {
        list.style.display = 'none';
        icon.className = 'bx bx-chevron-down';
      }
    };

    // --- COMMON UTILS ---
    function showToast(msg, type) {
      if (navigator.vibrate) navigator.vibrate(50);
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<span>${msg}</span>`;
      toastContainer.appendChild(t);
      requestAnimationFrame(() => { t.style.opacity = '1'; t.style.transform = 'translateY(0)'; });
      setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000);
    }

    function togglePrivacy() {
      isPrivacyMode = !isPrivacyMode;
      document.getElementById('btnPrivacy').querySelector('i').className = isPrivacyMode ? 'bx bx-hide' : 'bx bx-show';
      const elements = document.querySelectorAll('.sensitive-data');
      elements.forEach(el => { isPrivacyMode ? el.classList.add('blur-value') : el.classList.remove('blur-value'); });
      renderizarPainel();
    }

    // Month Navigation
    document.getElementById('prevMonth').onclick = () => changeMonth(-1);
    document.getElementById('nextMonth').onclick = () => changeMonth(1);
    function changeMonth(delta) {
      currentDate.setMonth(currentDate.getMonth() + delta);
      updateDateLabel();
      renderizarPainel();
    }
    function updateDateLabel() {
      const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      labelMonth.textContent = `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
    }

    // FAB
    const fabTrigger = document.getElementById('fabTrigger'); const fabMenu = document.getElementById('fabMenu');
    fabTrigger.onclick = () => fabMenu.classList.toggle('active');
    document.getElementById('btnOpcaoNova').onclick = () => { fabMenu.classList.remove('active'); document.getElementById('modalNovaConta').style.display = 'flex'; };
    document.getElementById('btnOpcaoSaida').onclick = () => { fabMenu.classList.remove('active'); document.getElementById('modalNovaDespesa').style.display = 'flex'; };

    // Payment Logic & Eletro
    let currentEletroId = null;
    let currentEletroVal = 0;

    window.abrirModalPagar = (el, id, desc, val) => {
      if (desc && desc.toUpperCase().startsWith('ELETRO')) {
        currentEletroId = id;
        currentEletroVal = parseFloat(val);
        document.getElementById('eletro-descricao').textContent = desc;
        document.getElementById('eletro-valor').textContent = 'R$ ' + currentEletroVal.toFixed(2).replace('.', ',');

        document.getElementById('eletro-payment-area').innerHTML = `
            <label style="font-weight: 600; color: var(--secondary); font-size: 0.9rem;">Forma de Pagamento</label>
            <div style="margin-bottom: 25px; margin-top:5px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; color: var(--text-main); background: #f8fafc; font-weight:500;">Pix (Pagamento Instantâneo)</div>

            <div style="display:flex; gap:10px;">
                <button onclick="closeEletroModal()" style="flex:1; padding:15px; border-radius:12px; border:none; background:transparent; color: var(--text-muted); font-weight:600; border: 1px solid #e2e8f0; cursor: pointer;">Fechar</button>
                <button id="btnPagarAgora" onclick="gerarPixEletro()" style="flex:2; padding:15px; border-radius:12px; border:none; background:var(--secondary); color:white; font-weight:700; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;">
                    <i class='bx bx-qr'></i> Gerar Pix
                </button>
            </div>
        `;
        document.getElementById('modalPagarEletro').style.display = 'flex';
      } else {
        document.getElementById('pagar-descricao').textContent = desc;
        document.getElementById('pagar-valor').textContent = 'R$ ' + parseFloat(val).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        document.getElementById('btnConfirmarPagamento').dataset.id = id;
        document.getElementById('modalPagarConta').style.display = 'flex';
      }
    };

    function closeEletroModal() {
      document.getElementById('modalPagarEletro').style.display = 'none';
    }

    async function gerarPixEletro() {
      const area = document.getElementById('eletro-payment-area');
      area.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:20px;"><i class='bx bx-loader-alt bx-spin' style="font-size:2rem;"></i><p style="margin-top:10px;">Gerando Pix...</p></div>`;

      try {
        const payload = {
          orderId: currentEletroId,
          transaction_amount: currentEletroVal,
          payment_method_id: 'pix',
          description: document.getElementById('eletro-descricao').textContent,
          payment_data: {
            transaction_amount: currentEletroVal,
            payment_method_id: 'pix',
            payer: { email: 'cliente@eletrobusiness.com.br' }
          },
          customPayer: {
            email: 'cliente@eletrobusiness.com.br',
            first_name: 'Cliente',
            last_name: 'Eletro'
          }
        };

        const res = await fetch('https://us-central1-super-app25.cloudfunctions.net/createPayment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.status === 'pending' || data.status === 'created' || data.point_of_interaction) {
          const qrCode = data.point_of_interaction.transaction_data.qr_code;
          const qrBase64 = data.point_of_interaction.transaction_data.qr_code_base64;

          area.innerHTML = `
                    <div style="text-align:center; animation: slideInUp 0.3s ease;">
                        <img src="data:image/png;base64,${qrBase64}" style="width:180px; height:180px; margin-bottom:15px; border-radius:8px; border:1px solid #e2e8f0;">
                        <textarea readonly style="width:100%; height:60px; font-size:0.7rem; color:#64748b; background:#f1f5f9; border:none; border-radius:8px; padding:8px; margin-bottom:10px; resize:none;">${qrCode}</textarea>
                        <button onclick="navigator.clipboard.writeText('${qrCode}'); showToast('Copiado!','success')" style="background:var(--primary); color:white; border:none; padding:12px 20px; border-radius:12px; font-weight:700; width:100%; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                            <i class='bx bx-copy'></i> Copiar Código
                        </button>
                        <p style="margin-top:15px; font-size:0.85rem; color:var(--success); font-weight:600; display:flex; align-items:center; justify-content:center; gap:5px;">
                            <i class='bx bx-time'></i> Aguardando pagamento...
                        </p>
                    </div>
                `;
        } else {
          throw new Error(data.message || "Erro desconhecido");
        }
      } catch (e) {
        console.error(e);
        area.innerHTML = `
                <div style="text-align:center; color:var(--danger); padding:20px;">
                    <i class='bx bx-error-circle' style="font-size:3rem; margin-bottom:10px;"></i>
                    <p>Erro ao gerar cobrança.</p>
                    <small>${e.message}</small>
                    <button onclick="closeEletroModal()" style="margin-top:15px; padding:10px 20px; background:#f1f5f9; border:none; border-radius:12px; font-weight:600; cursor:pointer;">Fechar</button>
                </div>
            `;
      }
    }

    // Submits
    document.getElementById('formNovaConta').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      if (btn.disabled) return;
      btn.disabled = true;
      btn.innerText = 'Registrando...';

      try {
        const [d, m, a] = document.getElementById('vencimento').value.split('/');
        const parcelas = parseInt(document.getElementById('parcelas').value);
        const descricaoBase = document.getElementById('beneficiario').value;
        const valorTotal = parseFloat(document.getElementById('valor').value.replace(/\D/g, '') || 0) / 100;

        const promises = [];

        for (let i = 0; i < parcelas; i++) {
          let targetMonthIndex = parseInt(m) - 1 + i;
          let targetYear = parseInt(a) + Math.floor(targetMonthIndex / 12);
          let targetMonth = targetMonthIndex % 12;
          let maxDayOfMonth = new Date(targetYear, targetMonth + 1, 0).getDate();
          let targetDay = Math.min(parseInt(d), maxDayOfMonth);

          const dataBase = new Date(targetYear, targetMonth, targetDay);
          const dia = String(dataBase.getDate()).padStart(2, '0');
          const mes = String(dataBase.getMonth() + 1).padStart(2, '0');
          const ano = dataBase.getFullYear();

          const desc = parcelas > 1 ? `${descricaoBase} (${i + 1}/${parcelas})` : descricaoBase;

          const payload = {
            id: Date.now().toString() + i,
            descricao: desc,
            valor: valorTotal,
            vencimento: `${ano}-${mes}-${dia}`
          };

          promises.push(fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'adicionarConta', data: payload }) }));
        }

        await Promise.all(promises);

        document.getElementById('modalNovaConta').style.display = 'none';
        showToast('Contas Salvas!', 'success');
        document.getElementById('beneficiario').value = '';
        document.getElementById('valor').value = '';
        document.getElementById('vencimento').value = '';
        document.getElementById('parcelas').value = '1';
        setTimeout(carregarContas, 1000);
      } catch (err) {
        showToast('Erro ao salvar', 'error');
        console.error(err);
      }
      btn.innerText = 'Registrar';
      btn.disabled = false;
    });

    document.getElementById('formNovaDespesa').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      if (btn.disabled) return;

      const valorRaw = document.getElementById('despesa-valor').value.replace(/\D/g, '');
      const valor = parseFloat(valorRaw) / 100;
      const declaracao = document.getElementById('despesa-declaracao').value;
      const pagamento = document.getElementById('despesa-pagamento').value;
      const descricao = document.getElementById('despesa-descricao').value;

      if (!declaracao) { showToast('Selecione uma declaração!', 'error'); return; }
      if (valor <= 0) { showToast('Valor inválido!', 'error'); return; }

      btn.disabled = true;
      btn.innerText = 'Lançando...';

      try {
        const hoje = new Date();
        const dia = String(hoje.getDate()).padStart(2, '0');
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const ano = hoje.getFullYear();

        const payload = {
          id: Date.now().toString(),
          descricao: `${declaracao} - ${descricao}`,
          valor: valor,
          vencimento: `${ano}-${mes}-${dia}`,
          status: 'pago',
          forma_pagamento: pagamento
        };

        await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'adicionarConta', data: payload })
        });

        document.getElementById('modalNovaDespesa').style.display = 'none';
        showToast('Despesa lançada!', 'success');
        document.getElementById('despesa-valor').value = '';
        document.getElementById('despesa-descricao').value = '';
        document.getElementById('despesa-declaracao').value = '';
        carregarContas();

      } catch (err) {
        console.error(err);
        showToast('Erro ao lançar', 'error');
      }
      btn.disabled = false;
      btn.innerText = 'Lançar Despesa';
    });

    document.getElementById('btnConfirmarPagamento').onclick = async (e) => {
      const btn = e.target;
      if (btn.disabled) return;
      btn.disabled = true;
      btn.innerText = '...';
      try {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'pagarConta', id: btn.dataset.id, paymentMethod: document.getElementById('forma-pagamento').value })
        });
        document.getElementById('modalPagarConta').style.display = 'none';
        showToast('Pago!', 'success');
        carregarContas();
      } catch (err) {
        showToast('Erro', 'error');
      }
      btn.innerText = 'Confirmar';
      btn.disabled = false;
    };

    // Formatting Inputs
    document.getElementById('vencimento').addEventListener('input', function (e) {
      let v = e.target.value.replace(/\D/g, '');
      if (v.length > 8) v = v.substring(0, 8);
      if (v.length > 4) {
        v = v.replace(/^(\d{2})(\d{2})(\d+)/, '$1/$2/$3');
      } else if (v.length > 2) {
        v = v.replace(/^(\d{2})(\d+)/, '$1/$2');
      }
      e.target.value = v;
    });

    document.getElementById('valor').addEventListener('input', (e) => formatCurrency(e.target));
    document.getElementById('despesa-valor').addEventListener('input', (e) => formatCurrency(e.target));
    function formatCurrency(el) {
      let v = el.value.replace(/\D/g, '');
      el.value = 'R$ ' + (parseInt(v || 0) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
    }
  </script>
</body>

</html>