<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" href="/assets/img/iconWeb.png">
  <title>A N F da Silva LTDA</title>

  <!-- Link To CSS -->
  <link rel="stylesheet" href="/assets/CSS/main.css">
  <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel='stylesheet'
    href='https://cdn-uicons.flaticon.com/3.0.0/uicons-regular-straight/css/uicons-regular-straight.css'>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BV6V3GTMR0"></script>
<script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-BV6V3GTMR0'); </script>

<body class="painel-adm1" onload="AnimationLoading();">
  <header>
    <div class="loading">
      <div class="efect-loading"></div>
    </div>
  </header>
  <div class="info">
    <div class="photo-profile">
      <img src="/users/45692327000100/CD1/adm/nb/img/profile_photo.jpg">
      <div class="detals">
        <h1>Olá, Nubia!</h1>
        <p>CEO: D'TUDO | Dupão</p>
      </div>
      <i class="fi fi-rr-shield-trust"></i>
    </div>
    <div class="balance">
      <p>Débitos Pendentes</p>
      <div class="saldo">
        <span id="boletosPayDate" class="skeleton shimmer"></span>
      </div>
    </div>
  </div>
  <br>

  <script>
    function carregarDadosPagina2() {
      const url = `https://script.google.com/macros/s/AKfycby8x6--ITfvIW7ui6c24reBqzL3LUhqL30hf4-gaJCS0xB0EDPM50TcSji_W-IuNU33/exec?pagina=2`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          const campos = [
            'boletosPayDate'
          ];

          campos.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
              el.textContent = data[id];
              el.classList.remove('skeleton', 'shimmer');
            }
          });
        })
        .catch(error => {
          console.error('Erro ao buscar dados da página 2:', error);
        });
    } document.addEventListener('DOMContentLoaded', () => {
      carregarDadosPagina2(); // Carrega ao abrir a página
      setInterval(carregarDadosPagina2, 30000); // Atualiza a cada 10 segundos
    });

  </script>

  <div class="back">
    <a class="btn-default" href="/users/45692327000100/CD1/adm/nb/conta.html" target="_self">
      Voltar<i class='bx bxs-left-arrow-circle'></i>
    </a>
  </div>

  <div class="new_nav">
    <div class="conta-info">
      <p>Gerenciar</p>
      <div class="option">
        <div class="card-option">
          <a href="/users/45692327000100/CD1/adm/nb/pushBuy.html">
            <i class='bxr  bx-dollar-circle'></i>
            <h3>Saída</h3>
          </a>
        </div>
        <div class="card-option">
          <a href="/users/45692327000100/CD1/adm/nb/slip.html">
            <i class='bxr  bx-scan-detail'></i>
            <h3>Ler Boleto</h3>
          </a>
        </div>
        <div class="card-option">
          <a href="/users/45692327000100/CD1/adm/nb/bills.html">
            <i class='bxr  bx-form'></i>
            <h3>Nova conta</h3>
          </a>
        </div>
        <div class="card-option">
          <a href="/users/45692327000100/CD1/adm/nb/debts.html">
            <i class='bx  bx-copy-list'></i>
            <h3>Todos as contas</h3>
          </a>
        </div>
      </div>

      <div id="updateBoletoModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
          <span class="close-btn">&times;</span>
          <h2 id="modal-empresa"></h2>
          <p>Vencimento: <span id="modal-vencimento"></span></p>
          <p>Valor: <span id="modal-valor"></span></p>
          <button id="btn-marcar-pago" class="confirm-btn">Marcar como Pago</button>
          <p id="modal-status-message"></p>
        </div>
      </div>

      <div>
        <p class="message">Contas prestes a vencer</p>
        <div class="shop container">
          <div class="mainContainer">
            <div class="boletosContainer">
              <div class="boletos-vencer" id="boletosContainer"></div>
            </div>
          </div>
        </div>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const container = document.getElementById('boletosContainer');

          // =================================================================
          // !!!!! IMPORTANTE !!!!!
          // COLE A URL GERADA NO PASSO 1 (AO PUBLICAR A PLANILHA) AQUI
          // =================================================================
          const URL_PLANILHA_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQt6seiP0hxPrVNPEWeRBNJuvKTTag52r4vxyyiOKQxoKS1IibyWF92O3di1Bb_9YL8ONRSRdNbQR8Q/pub?gid=16033507&single=true&output=csv";

          function showLoader() {
            container.innerHTML = `<p class="loading">Carregando contas...</p>`;
          }

          async function fetchBoletos() {
            showLoader();

            if (URL_PLANILHA_CSV === "COLE_A_SUA_URL_CSV_AQUI") {
              container.innerHTML = `<p class="error">ERRO: Você precisa colar a URL da sua planilha publicada na variável URL_PLANILHA_CSV no código.</p>`;
              return;
            }

            try {
              // 1. Busca o arquivo CSV
              const response = await fetch(URL_PLANILHA_CSV);
              if (!response.ok) {
                throw new Error(`Não foi possível carregar a planilha. Status: ${response.statusText}`);
              }
              const csvText = await response.text();

              // 2. Converte o texto CSV em um array de dados
              const linhas = csvText.split('\n');
              const dados = linhas.slice(1).map(linha => linha.split(',')); // Ignora a primeira linha (cabeçalho)

              // 3. Define as colunas (começando do 0) e a loja a ser filtrada
              const COLUNA_LOJA = 0;   // Coluna A
              const COLUNA_VALOR = 1;  // Coluna B
              const COLUNA_EMPRESA = 2;// Coluna C
              const COLUNA_VENCIMENTO = 3; // Coluna D
              const COLUNA_STATUS = 4; // Coluna E
              const lojaParaFiltrar = 'nubia';

              // 4. Filtra e processa apenas os boletos que importam
              const boletos = dados.filter(linha =>
                linha[COLUNA_LOJA] && linha[COLUNA_STATUS] &&
                linha[COLUNA_LOJA].trim().toLowerCase() === lojaParaFiltrar &&
                linha[COLUNA_STATUS].trim().toLowerCase() === 'a pagar'
              );

              container.innerHTML = ''; // Limpa a mensagem de "carregando"

              if (boletos.length === 0) {
                container.innerHTML = '<p>Nenhum boleto "a pagar" encontrado para esta loja.</p>';
                return;
              }

              // 5. Exibe os boletos na tela
              boletos.forEach(boleto => {
                const empresa = boleto[COLUNA_EMPRESA];
                const valor = boleto[COLUNA_VALOR];
                const vencimento = boleto[COLUNA_VENCIMENTO];

                // Tenta formatar a data de 'MM/DD/YYYY' ou 'YYYY-MM-DD' para 'DD/MM'
                let vencimentoFormatado = vencimento;
                try {
                  const dataObj = new Date(vencimento);
                  if (!isNaN(dataObj.getTime())) {
                    const dia = ('0' + dataObj.getDate()).slice(-2);
                    const mes = ('0' + (dataObj.getMonth() + 1)).slice(-2);
                    vencimentoFormatado = `${dia}/${mes}`;
                  }
                } catch (e) { }

                const div = document.createElement('div');
                div.className = 'boleto-item';
                div.innerHTML = `<strong>${empresa}</strong> | Vencimento: ${vencimentoFormatado} | Valor: R$ ${valor}`;
                container.appendChild(div);
              });

            } catch (err) {
              container.innerHTML = `<p class="error">ERRO FATAL: ${err.message}</p>`;
              console.error(err);
            }
          }

          fetchBoletos();
        });
      </script>

      <!-- Link To JS -->
      <script src="/assets/js/loading.js"></script>