<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Financeiro | Gestão</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <style>
    :root {
      /* Cores do Projeto */
      --primary: #c50037;       /* Vermelho (Usado para 'Já utilizado') */
      --primary-dark: #9e002c;
      --accent: #2c3e50;
      
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      
      --text-main: #1e293b;
      --text-muted: #64748b;
      
      --success: #10b981;
      --warning: #f59e0b;       /* Amarelo (Usado para 'Vence Hoje') */
      --danger: #ef4444;
      
      --shadow-card: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
      --radius: 20px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      margin: 0;
      padding-bottom: 100px;
    }

    /* --- HEADER --- */
    header {
      padding: 20px 20px 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header .back-button {
      color: var(--text-main);
      font-size: 24px;
      text-decoration: none;
      padding: 8px;
      border-radius: 50%;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
    }

    header h1 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
    }

    /* --- DASHBOARD & BARRA DE LIMITE --- */
    .dashboard-wrapper { padding: 10px 20px 20px 20px; }

    .finance-card {
        background: white;
        border-radius: var(--radius);
        padding: 24px;
        box-shadow: var(--shadow-card);
    }

    /* Navegação Mês */
    .month-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .month-nav button {
        background: #f1f5f9; border: none; width: 32px; height: 32px; border-radius: 10px;
        color: var(--text-main); cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .month-label { font-size: 0.9rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); }

    /* Total */
    .total-display { text-align: center; margin-bottom: 25px; }
    .total-display span { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; }
    .total-display strong { display: block; font-size: 2rem; font-weight: 800; color: var(--primary); letter-spacing: -1px; }

    /* BARRA SEGMENTADA (Lógica Nova) */
    .limit-container { margin-top: 10px; }
    
    .limit-labels {
        display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 8px; font-weight: 600; color: var(--text-muted);
    }

    /* O Container da barra */
    .segmented-bar {
        display: flex;
        height: 14px;
        border-radius: 7px;
        overflow: hidden;
        background-color: #e2e8f0; /* Cor do fundo (Cinza - Disponível) */
        position: relative;
    }

    /* Segmentos */
    .seg-used { background-color: var(--primary); height: 100%; transition: width 0.6s ease; }
    .seg-today { background-color: var(--warning); height: 100%; transition: width 0.6s ease; }
    
    /* Legenda da Barra */
    .bar-legend {
        display: flex; gap: 15px; justify-content: center; margin-top: 12px;
    }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.7rem; color: var(--text-muted); }
    .dot { width: 8px; height: 8px; border-radius: 50%; }


    /* --- LISTA DE CARTÕES (Estilo Preferido) --- */
    main { padding: 0 20px; }
    .section-title { font-size: 0.85rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 15px; }

    #contas-container { display: flex; flex-direction: column; gap: 12px; }

    .conta-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03); /* Sombra suave */
      display: flex; align-items: center; gap: 15px;
      position: relative;
      border: 1px solid transparent;
      transition: transform 0.1s;
    }
    .conta-card:active { transform: scale(0.98); }
    
    /* Box da Data */
    .date-box {
        background: #f1f5f9;
        min-width: 52px; height: 52px; border-radius: 12px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: var(--text-muted); font-weight: 700;
    }
    .date-box .d { font-size: 1.1rem; line-height: 1; }
    .date-box .m { font-size: 0.65rem; text-transform: uppercase; margin-top: 2px; }

    /* Detalhes */
    .conta-info { flex: 1; overflow: hidden; }
    .conta-info h3 { margin: 0 0 4px 0; font-size: 0.95rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conta-info p { margin: 0; font-size: 0.9rem; font-weight: 500; color: var(--text-muted); }
    
    /* Destaques visuais para Hoje/Vencido */
    .conta-card.status-hoje { border: 1px solid var(--warning); background: #fffbeb; }
    .status-hoje .date-box { background: rgba(245, 158, 11, 0.2); color: #d97706; }
    
    .conta-card.status-vencido { border: 1px solid var(--danger); background: #fef2f2; }
    .status-vencido .date-box { background: rgba(239, 68, 68, 0.15); color: #dc2626; }


    /* --- SKELETON LOADING (Estilo Penúltima Versão) --- */
    .skeleton-card {
        background: white; border-radius: 16px; padding: 16px; display: flex; align-items: center; gap: 15px; margin-bottom: 12px;
    }
    .sk-box { width: 52px; height: 52px; border-radius: 12px; background: #e2e8f0; }
    .sk-lines { flex: 1; display: flex; flex-direction: column; gap: 8px; }
    .sk-line { height: 12px; border-radius: 4px; background: #e2e8f0; }
    
    .shimmer {
        animation: shimmer 1.5s infinite linear;
        background: linear-gradient(to right, #eff1f3 4%, #e2e2e2 25%, #eff1f3 36%);
        background-size: 1000px 100%;
    }
    @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }


    /* --- FAB (SPEED DIAL) --- */
    .fab-container {
        position: fixed; bottom: 30px; right: 25px; z-index: 900;
        display: flex; flex-direction: column-reverse; align-items: center; gap: 15px;
    }
    .fab-main {
        width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%;
        border: none; box-shadow: 0 8px 20px rgba(197, 0, 55, 0.3); font-size: 2rem;
        display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.3s;
    }
    .fab-option {
        width: 0; height: 0; opacity: 0; border-radius: 50%; border: none; color: white;
        display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer;
        transition: all 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1); position: relative;
    }
    .fab-option::after {
        content: attr(data-label); position: absolute; right: 60px; background: white; color: var(--text-main);
        padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; white-space: nowrap;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1); opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .fab-container.active .fab-main { transform: rotate(45deg); background: var(--text-main); }
    .fab-container.active .fab-option { width: 50px; height: 50px; opacity: 1; }
    .fab-container.active .fab-option::after { opacity: 1; }
    #btnOpcaoNova { background: var(--success); }
    #btnOpcaoSaida { background: var(--accent); }

    /* --- MODAIS --- */
    .modal { display: none; position: fixed; z-index: 2000; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); justify-content: center; align-items: flex-end; }
    .modal-content { background: white; width: 100%; max-width: 500px; padding: 30px 25px; border-radius: 25px 25px 0 0; animation: slideUp 0.3s; }
    @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
    
    input, select { width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; margin-top: 8px; outline: none; background: #f8fafc; }
    input:focus { border-color: var(--primary); background: white; }
    .btn-submit { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; margin-top: 20px; font-size: 1rem; }

  </style>
</head>

<body>

  <header>
    <a href="/users/45692327000100/CD1/adm/nb/conta.html" class="back-button"><i class='bx bx-chevron-left'></i></a>
    <h1>Gestão Financeira</h1>
    <div style="width: 40px;"></div>
  </header>

  <div class="dashboard-wrapper">
      <div class="finance-card">
          <div class="month-nav">
              <button id="prevMonth"><i class='bx bx-chevron-left'></i></button>
              <span class="month-label" id="currentMonthLabel">...</span>
              <button id="nextMonth"><i class='bx bx-chevron-right'></i></button>
          </div>

          <div class="total-display">
              <span>Total a Pagar</span>
              <strong id="monthTotal">R$ 0,00</strong>
          </div>

          <div class="limit-container">
              <div class="limit-labels">
                  <span id="labelUtilizado">Utilizado: R$ 0</span>
                  <span>Teto: R$ 15.000</span>
              </div>
              
              <div class="segmented-bar">
                  <div class="seg-used" id="barUsed" style="width: 0%"></div>
                  <div class="seg-today" id="barToday" style="width: 0%"></div>
              </div>

              <div class="bar-legend">
                  <div class="legend-item"><div class="dot" style="background:var(--primary)"></div>Já Utilizado</div>
                  <div class="legend-item"><div class="dot" style="background:var(--warning)"></div>Vence Hoje</div>
                  <div class="legend-item"><div class="dot" style="background:#e2e8f0"></div>Disponível</div>
              </div>
          </div>
      </div>
  </div>

  <main>
    <div class="section-title">Lançamentos do Mês</div>
    <div id="contas-container">
        </div>
    <div style="height: 40px;"></div>
  </main>

  <div class="fab-container" id="fabMenu">
      <button class="fab-option" id="btnOpcaoSaida" data-label="Registrar Saída"><i class='bx bx-trending-down'></i></button>
      <button class="fab-option" id="btnOpcaoNova" data-label="Nova Conta"><i class='bx bx-plus'></i></button>
      <button class="fab-main" id="fabTrigger"><i class='bx bx-plus'></i></button>
  </div>

  <div id="modalNovaConta" class="modal">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 style="margin:0;">Nova Conta</h2>
          <i class='bx bx-x' style="font-size:1.5rem; padding:10px;" onclick="document.getElementById('modalNovaConta').style.display='none'"></i>
      </div>
      <form id="formNovaConta" style="margin-top:20px;">
          <label>Beneficiário</label>
          <input type="text" id="beneficiario" required placeholder="Nome do favorecido">
          <label style="display:block; margin-top:15px;">Valor</label>
          <input type="tel" id="valor" required placeholder="R$ 0,00" inputmode="numeric">
          <label style="display:block; margin-top:15px;">Vencimento</label>
          <input type="text" id="vencimento" required placeholder="DD/MM/AAAA" maxlength="10" inputmode="numeric">
          <button type="submit" class="btn-submit">Registrar</button>
      </form>
    </div>
  </div>

  <div id="modalPagarConta" class="modal">
    <div class="modal-content">
      <h2 style="margin:0 0 5px 0;">Baixar Conta</h2>
      <p style="color:#64748b; margin:0 0 15px 0;">Confirmar pagamento de:</p>
      <h3 id="pagar-descricao">...</h3>
      <h2 id="pagar-valor" style="color:var(--primary); margin:5px 0 20px 0;">...</h2>
      <label>Forma de Pagamento</label>
      <select id="forma-pagamento">
          <option value="Pix">Pix</option>
          <option value="Boleto">Boleto</option>
          <option value="Dinheiro">Dinheiro</option>
          <option value="Cartão">Cartão</option>
      </select>
      <div style="display:flex; gap:10px; margin-top:20px;">
          <button style="flex:1; padding:15px; border-radius:12px; border:none; background:#f1f5f9; font-weight:600;" onclick="document.getElementById('modalPagarConta').style.display='none'">Cancelar</button>
          <button id="btnConfirmarPagamento" style="flex:1; padding:15px; border-radius:12px; border:none; background:var(--success); color:white; font-weight:700;">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzkAs8dsJMepkQBhdL--XwO3wUQuQgvA-DFPEwraiz8ijiX9gkPMBuAeM5udQjzmJvzqQ/exec";
    const LIMITE_SUGERIDO = 15000.00;

    let todasContas = [];
    let currentDate = new Date();

    const contasContainer = document.getElementById('contas-container');
    const labelMonth = document.getElementById('currentMonthLabel');
    const labelTotal = document.getElementById('monthTotal');
    const barUsed = document.getElementById('barUsed');
    const barToday = document.getElementById('barToday');
    const labelUtilizado = document.getElementById('labelUtilizado');

    // --- INICIALIZAÇÃO ---
    document.addEventListener('DOMContentLoaded', () => {
        renderSkeleton(); // Começa com o skeleton
        carregarContas();
        updateDateLabel();
    });

    // --- NAVEGAÇÃO E DATAS ---
    document.getElementById('prevMonth').onclick = () => changeMonth(-1);
    document.getElementById('nextMonth').onclick = () => changeMonth(1);

    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        updateDateLabel();
        renderSkeleton();
        // Simula um delay pequeno para transição suave se os dados já estiverem em memória
        setTimeout(renderizarPainel, 300); 
    }

    function updateDateLabel() {
        const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        labelMonth.textContent = `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
    }

    // --- SKELETON UI (CARREGAMENTO ANTIGO) ---
    function renderSkeleton() {
        let html = '';
        for(let i=0; i<4; i++) {
            html += `
            <div class="skeleton-card">
                <div class="sk-box shimmer"></div>
                <div class="sk-lines">
                    <div class="sk-line shimmer" style="width: 70%"></div>
                    <div class="sk-line shimmer" style="width: 40%"></div>
                </div>
            </div>`;
        }
        contasContainer.innerHTML = html;
        // Zera a barra enquanto carrega
        barUsed.style.width = '0%';
        barToday.style.width = '0%';
        labelTotal.textContent = '...';
    }

    // --- LÓGICA DE DADOS ---
    async function carregarContas() {
        try {
            const response = await fetch(`${SCRIPT_URL}?action=getContas`);
            const data = await response.json();
            todasContas = data.error ? [] : data;
            renderizarPainel();
        } catch (error) {
            contasContainer.innerHTML = `<p style="text-align:center; padding:20px;">Erro de conexão.</p>`;
        }
    }

    function renderizarPainel() {
        const mesFiltro = currentDate.getMonth() + 1;
        const anoFiltro = currentDate.getFullYear();
        const hoje = new Date(); 
        hoje.setHours(0,0,0,0);

        // Filtra contas do mês
        const contasDoMes = todasContas.filter(c => {
            const [d, m, a] = c.vencimento.split('/');
            return parseInt(m) === mesFiltro && parseInt(a) === anoFiltro;
        });

        // 1. CÁLCULO DA BARRA DE LIMITE (LÓGICA PEDIDA)
        let totalGeral = 0;
        let totalVenceHoje = 0;
        let totalOutros = 0;

        contasDoMes.forEach(c => {
            const valor = parseFloat(c.valor);
            totalGeral += valor;
            
            const [d, m, a] = c.vencimento.split('/');
            const dataConta = new Date(a, m-1, d);
            
            if(dataConta.getTime() === hoje.getTime()) {
                totalVenceHoje += valor;
            } else {
                totalOutros += valor;
            }
        });

        // Atualiza Texto Total
        labelTotal.textContent = 'R$ ' + totalGeral.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        labelUtilizado.textContent = `Utilizado: R$ ${totalGeral.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;

        // Atualiza Largura da Barra
        // A barra cinza (fundo) é 100%. As divs internas ocupam % relativas ao LIMITE TOTAL.
        const pctOutros = (totalOutros / LIMITE_SUGERIDO) * 100;
        const pctHoje = (totalVenceHoje / LIMITE_SUGERIDO) * 100;

        // Trava visualmente em 100% pra não quebrar layout se estourar o limite
        const totalPct = pctOutros + pctHoje;
        const fatorAjuste = totalPct > 100 ? (100 / totalPct) : 1;

        barUsed.style.width = `${pctOutros * fatorAjuste}%`;
        barToday.style.width = `${pctHoje * fatorAjuste}%`;


        // 2. RENDERIZAR LISTA (CARD ESTILO ANTIGO)
        contasContainer.innerHTML = '';
        if (contasDoMes.length === 0) {
            contasContainer.innerHTML = `<div style="text-align:center; padding:30px; color:#94a3b8;">Mês livre de contas.</div>`;
            return;
        }

        // Ordenar por data
        contasDoMes.sort((a,b) => {
             const [da, ma, aa] = a.vencimento.split('/');
             const [db, mb, ab] = b.vencimento.split('/');
             return new Date(aa,ma-1,da) - new Date(ab,mb-1,db);
        });

        contasDoMes.forEach(conta => {
            const [dia, mes, ano] = conta.vencimento.split('/');
            const dataConta = new Date(ano, mes - 1, dia);
            const mesTexto = dataConta.toLocaleString('pt-BR', { month: 'short' }).replace('.', '');
            
            let statusClass = '';
            if (dataConta.getTime() === hoje.getTime()) statusClass = 'status-hoje';
            else if (dataConta < hoje) statusClass = 'status-vencido';

            const card = document.createElement('div');
            card.className = `conta-card ${statusClass}`;
            card.onclick = () => abrirModalPagar(conta);
            
            card.innerHTML = `
                <div class="date-box">
                    <span class="d">${dia}</span>
                    <span class="m">${mesTexto}</span>
                </div>
                <div class="conta-info">
                    <h3>${conta.descricao}</h3>
                    <p>R$ ${parseFloat(conta.valor).toFixed(2).replace('.', ',')}</p>
                </div>
                <div style="color:#cbd5e1;"><i class='bx bx-chevron-right' style="font-size:1.5rem"></i></div>
            `;
            contasContainer.appendChild(card);
        });
    }

    // --- INTERAÇÕES DO FAB ---
    const fabTrigger = document.getElementById('fabTrigger');
    const fabMenu = document.getElementById('fabMenu');
    
    fabTrigger.addEventListener('click', () => fabMenu.classList.toggle('active'));
    document.addEventListener('click', (e) => { if (!fabMenu.contains(e.target)) fabMenu.classList.remove('active'); });

    document.getElementById('btnOpcaoNova').onclick = () => {
        fabMenu.classList.remove('active');
        document.getElementById('formNovaConta').reset();
        document.getElementById('modalNovaConta').style.display = 'flex';
    };
    document.getElementById('btnOpcaoSaida').onclick = () => {
        window.location.href = "/users/45692327000100/CD1/adm/nb/pushBuy.html";
    };

    // --- MODAIS ---
    window.abrirModalPagar = (conta) => {
        document.getElementById('pagar-descricao').textContent = conta.descricao;
        document.getElementById('pagar-valor').textContent = 'R$ ' + parseFloat(conta.valor).toFixed(2).replace('.', ',');
        document.getElementById('btnConfirmarPagamento').dataset.id = conta.id;
        document.getElementById('modalPagarConta').style.display = 'flex';
    };

    document.getElementById('formNovaConta').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const txt = btn.innerText; btn.innerText = '...'; btn.disabled = true;
        try {
            const [d, m, a] = document.getElementById('vencimento').value.split('/');
            const payload = {
                id: Date.now().toString(),
                descricao: document.getElementById('beneficiario').value,
                valor: document.getElementById('valor').value.replace(/\D/g,'') / 100,
                vencimento: `${a}-${m}-${d}`
            };
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'adicionarConta', data: payload }) });
            document.getElementById('modalNovaConta').style.display = 'none';
            carregarContas();
        } catch (err) { alert('Erro'); }
        btn.innerText = txt; btn.disabled = false;
    });

    document.getElementById('btnConfirmarPagamento').onclick = async (e) => {
        const btn = e.target; btn.innerText = '...';
        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'pagarConta',
                    id: btn.dataset.id,
                    paymentMethod: document.getElementById('forma-pagamento').value
                })
            });
            document.getElementById('modalPagarConta').style.display = 'none';
            carregarContas();
        } catch (err) { alert('Erro'); }
        btn.innerText = 'Confirmar';
    };

    // Máscaras Input
    document.getElementById('valor').addEventListener('input', (e) => {
        let v = e.target.value.replace(/\D/g, '');
        v = (parseInt(v || 0, 10) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        e.target.value = 'R$ ' + v;
    });
    document.getElementById('vencimento').addEventListener('input', (e) => {
        let v = e.target.value.replace(/\D/g, '');
        if (v.length > 2) v = v.slice(0, 2) + '/' + v.slice(2);
        if (v.length > 5) v = v.slice(0, 5) + '/' + v.slice(5, 9);
        e.target.value = v;
    });

  </script>
</body>
</html>