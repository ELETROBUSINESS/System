<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A N F da Silva LTDA | Gerenciamento</title>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/assets/css/main.css">

  <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel='stylesheet'
    href='https://cdn-uicons.flaticon.com/2.6.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>
  <style>
    /* O CSS permanece o mesmo da versão anterior, com um pequeno acréscimo para o novo campo de seleção */
    :root {
      --cor-primaria: #c50037;
      --cor-secundaria: #8f2d56;
      --cor-fundo: #f8f9fa;
      --cor-card: #ffffff;
      --cor-texto-principal: #212529;
      --cor-texto-secundario: #6c757d;
      --cor-sombra: rgba(0, 0, 0, 0.08);
      --cor-sucesso: #28a745;
      --cor-borda: #dee2e6;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      background-color: var(--cor-fundo);
      color: var(--cor-texto-principal);
    }

    header {
      background-color: var(--cor-primaria);
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 5px var(--cor-sombra);
      border-bottom-left-radius: 20px;
      border-bottom-right-radius: 20px;
    }

    header .back-button {
      color: white;
      font-size: 1.8em;
      text-decoration: none;
      margin-right: 15px;
    }

    header h1 {
      margin: 0;
      font-size: 1.4em;
    }

    main {
      padding: 20px 15px;
    }

    .section-title {
      font-size: 1em;
      font-weight: 500;
      color: var(--cor-texto-secundario);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 15px;
      padding-left: 5px;
    }

    #contas-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .conta-card {
      background-color: #e8e9eb;
      border-radius: 12px;
      padding: 15px;
      display: flex;
      align-items: center;
      box-shadow: 0 4px 12px var(--cor-sombra);
      position: relative;
      overflow: hidden;
    }

    .conta-card .icon-container {
      background-color: #fff;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-right: 15px;
    }

    .conta-card .icon-container i {
      color: var(--cor-primaria);
      font-size: 1.8em;
    }

    .conta-detalhes {
      flex-grow: 1;
    }

    .conta-detalhes .descricao {
      font-weight: 600;
      font-size: 1.1em;
      margin-bottom: 2px;
    }

    .conta-detalhes .valor {
      font-size: 1em;
      color: var(--cor-texto-principal);
    }

    .conta-card .vencimento {
      font-weight: 500;
      color: var(--cor-texto-secundario);
      font-size: 0.9em;
      align-self: flex-start;
    }

    .btn-pagar {
      background-color: var(--cor-primaria);
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.8em;
      margin-top: 8px;
    }

    .option {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .card-opcao {
      background-color: var(--cor-card);
      border-radius: 12px;
      box-shadow: 0 4px 12px var(--cor-sombra);
      cursor: pointer;
    }

    .card-opcao a {
      text-decoration: none;
      color: var(--cor-texto-principal);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px 10px;
    }

    .card-opcao i {
      font-size: 2.2em;
      color: var(--cor-primaria);
    }

    .card-opcao h3 {
      margin: 8px 0 0 0;
      font-size: 0.9em;
      font-weight: 500;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal-content {
      background-color: var(--cor-card);
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }

    #modalNovaConta .modal-content {
      padding: 20px;
    }

    #modalNovaConta .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    #modalNovaConta .modal-header h2 {
      margin: 0;
      font-size: 1.8em;
      font-weight: 700;
    }

    #modalNovaConta .modal-header h2 span {
      border-bottom: 3px solid var(--cor-primaria);
    }

    #modalNovaConta .modal-header .icon-wrapper {
      background-color: var(--cor-primaria);
      color: white;
      border-radius: 8px;
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.4em;
    }

    #formNovaConta .form-group {
      margin-bottom: 20px;
    }

    #formNovaConta .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--cor-texto-secundario);
      font-size: 0.9em;
    }

    #formNovaConta .form-group input[type="text"],
    #formNovaConta .form-group input[type="number"] {
      width: 100%;
      padding: 14px;
      border: none;
      background-color: #f0f2f5;
      border-radius: 10px;
      box-sizing: border-box;
      font-size: 1em;
    }

    #formNovaConta .form-group-icon {
      position: relative;
    }

    #formNovaConta .form-group-icon i {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--cor-texto-secundario);
    }

    #formNovaConta .btn-submit {
      background-color: var(--cor-primaria);
      color: white;
      padding: 14px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      font-size: 1.1em;
      font-weight: bold;
      transition: background-color 0.2s;
    }

    #formNovaConta .btn-submit:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    #modalPagarConta .modal-content {
      padding: 25px;
    }

    #modalPagarConta .modal-header h2 {
      margin: 0 0 15px 0;
      font-size: 1.4em;
    }

    .info-pagamento {
      margin-bottom: 20px;
    }

    .info-pagamento p {
      margin: 8px 0;
      color: var(--cor-texto-secundario);
    }

    .info-pagamento span {
      font-weight: 600;
      color: var(--cor-texto-principal);
    }

    /* Estilo para o novo campo de seleção */
    .info-pagamento select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--cor-borda);
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 1em;
      margin-top: 5px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .modal-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
    }

    #btnConfirmarPagamento {
      background-color: var(--cor-sucesso);
      color: white;
    }

    #btnCancelarPagamento {
      background-color: #e9ecef;
      color: var(--cor-texto-principal);
    }

    #feedback {
      text-align: center;
      margin: 10px 0;
      font-weight: bold;
    }

    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-top: 4px solid var(--cor-primaria);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }


    /* NOVOS ESTILOS PARA A MÁSCARA DE PAGAMENTO */
    .payment-mask {
      display: none;
      /* Começa escondido */
      position: fixed;
      z-index: 2000;
      /* Z-index alto para ficar sobre todos os elementos */
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.85);
      /* Fundo branco semitransparente */
      backdrop-filter: blur(4px);
      /* Efeito de desfoque (para navegadores modernos) */
      justify-content: center;
      align-items: center;
      flex-direction: column;
      animation: fadeIn 0.3s;
    }

    .payment-mask .spinner {
      border: 5px solid rgba(0, 0, 0, 0.1);
      border-top: 5px solid var(--cor-primaria);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    .payment-mask p {
      margin-top: 20px;
      font-size: 1.1em;
      font-weight: 500;
      color: var(--cor-texto-principal);
    }
  </style>
</head>

<body>
  <div id="payment-mask" class="payment-mask">
    <div class="payment-mask-content">
      <div class="spinner"></div>
      <p>Processando pagamento...</p>
    </div>
  </div>

  <header>
    <a href="/users/45692327000100/CD1/adm/nb/conta.html" class="back-button"><i class='bx bx-arrow-back'></i></a>
    <h1>Contas a Pagar</h1>
  </header>
  <main>
    <br><br>
    <h2 class="section-title">Prestes a vencer</h2>
    <div id="feedback"></div>
    <div id="contas-container"></div>
    <h2 class="section-title" style="margin-top: 30px;">Opções</h2>
    <div class="option">
      <div class="card-opcao">
        <a href="/users/45692327000100/CD1/adm/nb/pushBuy.html">
          <i class='bx bx-dollar-circle'></i>
          <h3>Saída</h3>
        </a>
      </div>
      <div class="card-opcao">
        <a id="btnNovaConta">
          <i class='bx bx-form'></i>
          <h3>Nova conta</h3>
        </a>
      </div>
    </div>
  </main>

  <div id="modalNovaConta" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><span>Nova</span> conta</h2>
        <div class="icon-wrapper"><i class='bx bx-plus'></i></div>
      </div>
      <form id="formNovaConta">
        <div class="form-group">
          <label for="beneficiario">Pessoa/Empresa beneficiária</label>
          <input type="text" id="beneficiario" placeholder="Digite o nome" required>
        </div>
        <div class="form-group">
          <label for="valor">Valor da conta</label>
          <input type="text" id="valor" placeholder="R$ 0,00" required>
        </div>
        <div class="form-group form-group-icon">
          <label for="vencimento">Data de Vencimento</label>
          <input type="text" id="vencimento" placeholder="DD/MM/AAAA" maxlength="10" required>
          <i class='bx bx-calendar'></i>
        </div>
        <button type="submit" class="btn-submit">Registrar</button>
      </form>
    </div>
  </div>

  <div id="modalPagarConta" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Confirmar Pagamento</h2>
      </div>
      <div class="info-pagamento">
        <p>Descrição: <span id="pagar-descricao"></span></p>
        <p>Valor: <span id="pagar-valor"></span></p>
        <p>Vencimento: <span id="pagar-vencimento"></span></p>

        <div class="form-group" style="margin-top:15px;">
          <label for="forma-pagamento" style="font-weight:600;">Forma de Pagamento</label>
          <select id="forma-pagamento" required>
            <option value="Boleto">Boleto</option>
            <option value="Dinheiro">Dinheiro</option>
            <option value="Pix">Pix</option>
            <option value="Cartão de Crédito">Cartão de Crédito</option>
            <option value="Cartão de Débito">Cartão de Débito</option>
          </select>
        </div>
      </div>
      <div class="modal-buttons">
        <button id="btnCancelarPagamento">Cancelar</button>
        <button id="btnConfirmarPagamento">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    // *** SUA URL DO APPS SCRIPT ***
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzkAs8dsJMepkQBhdL--XwO3wUQuQgvA-DFPEwraiz8ijiX9gkPMBuAeM5udQjzmJvzqQ/exec";

    // Seletores de Elementos
    // Adicione esta linha junto com os outros 'const' no topo do script
    const paymentMask = document.getElementById('payment-mask');
    const contasContainer = document.getElementById('contas-container');
    const feedbackEl = document.getElementById('feedback');
    const modalNovaConta = document.getElementById('modalNovaConta');
    const btnNovaConta = document.getElementById('btnNovaConta');
    const formNovaConta = document.getElementById('formNovaConta');
    const modalPagarConta = document.getElementById('modalPagarConta');
    const btnConfirmarPagamento = document.getElementById('btnConfirmarPagamento');
    const btnCancelarPagamento = document.getElementById('btnCancelarPagamento');
    const inputVencimento = document.getElementById('vencimento');
    const inputValor = document.getElementById('valor');

    // LÓGICA DO MODAL
    btnNovaConta.onclick = () => { formNovaConta.reset(); modalNovaConta.style.display = 'flex'; };
    window.onclick = (event) => {
      if (event.target == modalNovaConta) modalNovaConta.style.display = 'none';
      if (event.target == modalPagarConta) modalPagarConta.style.display = 'none';
    };

    // FORMATAÇÃO AUTOMÁTICA DE INPUTS
    inputVencimento.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 2) value = value.slice(0, 2) + '/' + value.slice(2);
      if (value.length > 5) value = value.slice(0, 5) + '/' + value.slice(5, 9);
      e.target.value = value;
    });
    inputValor.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '');
      value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
      if (value === 'NaN') value = '';
      e.target.value = 'R$ ' + value;
    });

    // CARREGAR CONTAS
    document.addEventListener('DOMContentLoaded', carregarContas);
    async function carregarContas() {
      setLoading(true, 'Carregando contas...');
      try {
        const response = await fetch(`${SCRIPT_URL}?action=getContas`);
        if (!response.ok) throw new Error(`Erro de comunicação com o servidor.`);
        const contas = await response.json();
        renderizarContas(contas);
      } catch (error) {
        mostrarErro(error);
      }
    }

    function renderizarContas(contas) {
      setLoading(false);
      contasContainer.innerHTML = '';
      if (contas.error) return mostrarErro({ message: contas.message });
      if (contas.length === 0) {
        contasContainer.innerHTML = '<p>Nenhuma conta a pagar encontrada. ✨</p>';
        return;
      }
      contas.forEach(conta => {
        const card = document.createElement('div');
        card.className = 'conta-card';
        card.innerHTML = `
                    <div class="icon-container"><i class='bx bx-dollar'></i></div>
                    <div class="conta-detalhes">
                        <span class="descricao">${conta.descricao}</span>
                        <span class="valor">R$ ${parseFloat(conta.valor).toFixed(2).replace('.', ',')}</span>
                        <button class="btn-pagar" data-id="${conta.id}" data-descricao="${conta.descricao}" data-valor="R$ ${parseFloat(conta.valor).toFixed(2).replace('.', ',')}" data-vencimento="${conta.vencimento}">Pagar</button>
                    </div>
                    <span class="vencimento">${conta.vencimento}</span>`;
        contasContainer.appendChild(card);
      });
      document.querySelectorAll('.btn-pagar').forEach(button => button.addEventListener('click', handleAbrirModalPagar));
    }

    // ADICIONAR NOVA CONTA
    formNovaConta.addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitButton = formNovaConta.querySelector('.btn-submit');
      submitButton.disabled = true;
      submitButton.textContent = 'Salvando...';
      modalNovaConta.style.display = 'none';
      setLoading(true, 'Registrando...');
      try {
        const now = new Date();
        const pad = (num) => num.toString().padStart(2, '0');
        const id = `${pad(now.getDate())}${pad(now.getMonth() + 1)}${now.getFullYear()}${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
        const [dia, mes, ano] = inputVencimento.value.split('/');
        const dataFormatada = `${ano}-${mes}-${dia}`;
        const valorNumerico = inputValor.value.replace(/\D/g, '') / 100;
        const dadosConta = { id, descricao: document.getElementById('beneficiario').value, valor: valorNumerico, vencimento: dataFormatada };
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'adicionarConta', data: dadosConta }) });
        const result = await response.json();
        if (!result.success) throw new Error(result.message);
        await carregarContas();
      } catch (error) {
        mostrarErro(error);
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Registrar';
      }
    });

    // LÓGICA DO PAGAMENTO COM MODAL
    function handleAbrirModalPagar(event) {
      const button = event.target;
      document.getElementById('pagar-descricao').textContent = button.dataset.descricao;
      document.getElementById('pagar-valor').textContent = button.dataset.valor;
      document.getElementById('pagar-vencimento').textContent = button.dataset.vencimento;
      btnConfirmarPagamento.dataset.id = button.dataset.id;
      modalPagarConta.style.display = 'flex';
    }

    btnCancelarPagamento.onclick = () => modalPagarConta.style.display = 'none';

    // SUBSTITUA A VERSÃO ANTIGA DESTA FUNÇÃO PELA NOVA
    btnConfirmarPagamento.addEventListener('click', async (event) => {
      const idConta = event.target.dataset.id;
      const formaPagamento = document.getElementById('forma-pagamento').value;

      modalPagarConta.style.display = 'none'; // Esconde o modal de confirmação
      paymentMask.style.display = 'flex';     // MOSTRA a máscara de processamento

      try {
        // Envia o ID e a forma de pagamento para o script
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'pagarConta',
            id: idConta,
            paymentMethod: formaPagamento
          })
        });
        const result = await response.json();
        if (!result.success) throw new Error(result.message);

        // Espera a lista de contas ser atualizada
        await carregarContas();

      } catch (error) {
        // Se der erro, mostra a mensagem de erro
        mostrarErro(error);
      } finally {
        // O bloco 'finally' garante que a máscara será escondida
        // tanto em caso de sucesso quanto em caso de erro.
        paymentMask.style.display = 'none'; // ESCONDE a máscara
      }
    });

    // FUNÇÕES AUXILIARES
    function setLoading(isLoading, message = '') {
      feedbackEl.innerHTML = isLoading ? `<div class="loading-spinner"></div><p>${message}</p>` : '';
      if (isLoading) feedbackEl.style.color = 'var(--cor-texto)';
    }
    function mostrarErro(error) {
      setLoading(false);
      feedbackEl.textContent = `Erro: ${error.message}`;
      feedbackEl.style.color = 'var(--cor-primaria)';
    }
  </script>
</body>

</html>