<!DOCTYPE html>
<html lang="pt-br" data-view="mobile" data-minimized="false">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Produtos | D'TUDO</title>
    <link rel="icon" href="/assets/img/iconWeb.png">

    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>

    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/2.6.0/uicons-solid-straight/css/uicons-solid-straight.css'>
    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/2.6.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>

    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

    <!-- Estilos Unificados e Main -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/style26.css">

    <!-- View Transitions API -->
    <meta name="view-transition" content="same-origin">

    <!-- Navbar Anti-Flash -->
    <script>
        (function () {
            const savedState = localStorage.getItem('acc_navbar');
            if (savedState !== null) {
                document.documentElement.setAttribute('data-minimized', savedState);
                if (savedState === 'true') {
                    document.documentElement.classList.add('sidebar-minimized-init');
                }
            }
        })();
    </script>
</head>

<body style="--marker-x: 10%; --marker-y: 65%;">

    <div id="app-container" class="dashboard-grid">

        <!-- Info Block -->
        <div class="info">
            <div class="photo-profile">
                <!-- User Profile IDs added as requested/observed in other files -->
                <img id="user-profile-img" src="/users/45692327000100/CD1/adm/nb/img/profile_photo.jpg"
                    style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                <div class="detals">
                    <h1 id="user-full-name">Olá, Nubia!</h1>
                    <p id="user-role-display">Gerenciamento de Produtos</p>
                </div>
                <i class="fi fi-rr-shield-trust"></i>
            </div>
            <!-- Hiding balance on this page -->
            <div class="balance" style="opacity: 0; pointer-events: none;">
                <p>Saldo</p>
                <div class="saldo">
                    <span id="valor1">R$&nbsp;</span>
                </div>
            </div>
        </div>

        <!-- VIEW: LIST (Default) -->
        <div id="view-list" class="finance-card p-6 col-span-2" style="grid-column: span 2; display: block;">
            <div class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4">
                <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide self-start md:self-center">Meus
                    Produtos</h3>

                <div class="flex w-full md:w-auto gap-3">
                    <!-- Search Bar -->
                    <div class="relative w-full md:w-64">
                        <i class='bx bx-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400'></i>
                        <input type="text" id="search-input" onkeyup="filterProducts()" placeholder="Buscar produtos..."
                            class="w-full pl-10 pr-4 py-2 bg-gray-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-[var(--brand-color)] outline-none">
                    </div>

                    <!-- Add Button -->
                    <button onclick="showForm()"
                        class="flex items-center justify-center gap-2 px-4 py-2 bg-[var(--brand-color)] text-white rounded-xl text-sm font-bold hover:bg-[var(--brand-future)] transition-colors shadow-lg hover:shadow-xl shrink-0">
                        <i class='bx bx-plus text-lg'></i>
                        <span class="hidden md:inline">Novo</span>
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-12 text-center">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <i class='bx bx-package text-3xl text-gray-400'></i>
                </div>
                <h4 class="text-gray-800 font-bold mb-1">Nenhum produto encontrado</h4>
                <p class="text-xs text-gray-500 max-w-[200px]">Cadastre seus produtos para gerenciar o estoque e preços.
                </p>
                <button onclick="showForm()"
                    class="mt-4 text-xs font-bold text-[var(--brand-color)] uppercase tracking-wide hover:underline">
                    Começar agora
                </button>
            </div>

            <!-- Product Grid -->
            <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Products will be injected here via JS -->
            </div>
        </div>

        <!-- VIEW: FORM (Hidden by default) -->
        <div id="view-form" class="finance-card p-6 col-span-2 hidden" style="grid-column: span 2;">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide" id="form-title">Novo Produto</h3>
                <button onclick="showList()"
                    class="text-xs font-semibold text-gray-400 hover:text-red-600 transition-colors flex items-center gap-1">
                    <i class='bx bx-arrow-back'></i> Voltar
                </button>
            </div>

            <form id="product-form" class="space-y-6" onsubmit="handleSaveProduct(event)">
                <input type="hidden" id="edit-id">

                <!-- Image Upload Section -->
                <div class="flex flex-col items-center justify-center w-full">
                    <label for="dropzone-file"
                        class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-300 border-dashed rounded-2xl cursor-pointer bg-gray-50 hover:bg-gray-100 transition-all relative overflow-hidden group">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6" id="upload-placeholder">
                            <i
                                class='bx bx-cloud-upload text-4xl text-gray-400 mb-2 group-hover:scale-110 transition-transform'></i>
                            <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Clique para enviar</span>
                                ou solte</p>
                        </div>
                        <img id="preview-image" src="#" alt="Preview"
                            class="hidden w-full h-full object-contain absolute inset-0 z-10 bg-white p-2" />
                        <!-- Remove button overlaid on image -->
                        <button type="button" id="remove-img-btn" onclick="removeImage(event)"
                            class="hidden absolute top-2 right-2 z-20 bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600 transition-colors">
                            <i class='bx bx-trash text-sm'></i>
                        </button>
                        <input id="dropzone-file" type="file" class="hidden" accept="image/*"
                            onchange="previewFile()" />
                    </label>
                </div>

                <!-- Product Details -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Name -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 uppercase">Nome do Produto</label>
                        <input type="text" id="prod-name" placeholder="Ex: Coca-Cola 2L" required
                            class="w-full p-4 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-[var(--brand-color)] outline-none transition-all text-sm font-medium text-gray-700">
                    </div>

                    <!-- Code/SKU -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 uppercase">Código / SKU</label>
                        <div class="relative">
                            <input type="text" id="prod-sku" placeholder="000123" required
                                class="w-full p-4 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-[var(--brand-color)] outline-none transition-all text-sm font-medium text-gray-700">
                            <i
                                class='bx bx-barcode absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-xl'></i>
                        </div>
                    </div>

                    <!-- Category -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 uppercase">Categoria</label>
                        <select id="prod-category" required
                            class="w-full p-4 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-[var(--brand-color)] outline-none transition-all text-sm font-medium text-gray-700 appearance-none">
                            <option value="">Selecione...</option>
                            <option value="Bebidas">Bebidas</option>
                            <option value="Alimentos">Alimentos</option>
                            <option value="Limpeza">Limpeza</option>
                            <option value="Higiene">Higiene</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>

                    <!-- Stock -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 uppercase">Estoque</label>
                        <input type="number" id="prod-stock" placeholder="0" required
                            class="w-full p-4 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-[var(--brand-color)] outline-none transition-all text-sm font-medium text-gray-700">
                    </div>

                    <!-- Cost Price -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 uppercase">Preço de Custo</label>
                        <div class="relative">
                            <span
                                class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 font-bold text-sm">R$</span>
                            <input type="text" id="prod-cost" placeholder="0,00" required oninput="maskMoney(this)"
                                class="w-full pl-10 p-4 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-[var(--brand-color)] outline-none transition-all text-sm font-medium text-gray-700">
                        </div>
                    </div>

                    <!-- Sale Price -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 uppercase">Preço de Venda</label>
                        <div class="relative">
                            <span
                                class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 font-bold text-sm">R$</span>
                            <input type="text" id="prod-price" placeholder="0,00" required oninput="maskMoney(this)"
                                class="w-full pl-10 p-4 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-[var(--brand-color)] outline-none transition-all text-sm font-medium text-gray-700">
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase">Descrição</label>
                    <textarea id="prod-desc" rows="3" placeholder="Detalhes do produto... (Opcional)"
                        class="w-full p-4 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-[var(--brand-color)] outline-none transition-all text-sm font-medium text-gray-700 resize-none"></textarea>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-4 pt-4">
                    <button type="button" onclick="showList()"
                        class="flex-1 p-4 rounded-xl font-bold text-sm text-gray-500 hover:bg-gray-100 transition-colors">Cancelar</button>
                    <button type="submit"
                        class="flex-1 p-4 rounded-xl font-bold text-sm text-white bg-[var(--brand-color)] hover:bg-[var(--brand-future)] shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
                        Salvar Produto
                    </button>
                </div>
            </form>
        </div>

    </div>

    <!-- Navbar -->
    <div class="nav-container">
        <div class="nav-marker" id="nav-marker"></div>
        <div class="nav-bg" id="nav-bg"></div>
        <nav class="nav-overlay" id="nav-overlay">
            <div class="nav-header-toggle">
                <div class="btn-toggle-sidebar" onclick="toggleSidebar()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        id="toggle-icon" style="transition: transform 0.3s ease;">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </div>
            </div>

            <div class="nav-links-container">
                <div class="nav-item" onclick="navigateTo('conta.html')">
                    <div class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                    </div>
                    <span class="nav-label">Casa</span>
                </div>

                <div class="nav-item" onclick="navigateTo('metricas.html')">
                    <div class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                    </div>
                    <span class="nav-label">Métricas</span>
                </div>

                <div class="nav-item desktop-only" onclick="navigateTo('/pdv/index.html')">
                    <div class="nav-icon">
                        <i class="bx bx-cart-minus" style="font-size: 24px;"></i>
                    </div>
                    <span class="nav-label">PDV</span>
                </div>

                <div class="nav-item active" onclick="navigateTo('produtos.html')">
                    <div class="nav-icon">
                        <i class='bx bx-package' style="font-size: 24px;"></i>
                    </div>
                    <span class="nav-label">Produtos</span>
                </div>

                <div class="nav-item desktop-only" onclick="navigateTo('manager.html')">
                    <div class="nav-icon">
                        <i class='bxr bx-scan-barcode'></i>
                    </div>
                    <span class="nav-label">Despesas</span>
                </div>

                <div class="nav-item" onclick="navigateTo('extrato.html')">
                    <div class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <line x1="10" y1="9" x2="8" y2="9"></line>
                        </svg>
                    </div>
                    <span class="nav-label">Extrato</span>
                </div>

                <div class="nav-item desktop-only" onclick="navigateTo('crediario.html')">
                    <div class="nav-icon">
                        <i class='bxr bx-wallet-cards'></i>
                    </div>
                    <span class="nav-label">Crediário</span>
                </div>

                <div class="nav-item"
                    onclick="localStorage.removeItem('session_token'); window.location.href='/users/e-finance.html'">
                    <div class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </div>
                    <span class="nav-label">Sair</span>
                </div>
            </div>
        </nav>
    </div>

    <!-- Script Unificado -->
    <script src="/assets/js/script26.js"></script>
    <script>
        // --- DATA MANAGEMENT (LOCAL MOCK) ---
        const DB_KEY = 'products_db';
        let products = JSON.parse(localStorage.getItem(DB_KEY) || '[]');

        function saveToLocal() {
            localStorage.setItem(DB_KEY, JSON.stringify(products));
            renderProducts();
        }

        // --- APP LOGIC ---
        let originalImageBase64 = null; // Store base64 string

        window.onload = function () {
            renderProducts();

            // Try to load user profile if script26 doesn't catch it automatically or for redundancy
            if (typeof loadUserProfile === 'function') {
                loadUserProfile();
            }
        };

        function showForm(editId = null) {
            document.getElementById('view-list').classList.add('hidden');
            document.getElementById('view-form').classList.remove('hidden');
            document.getElementById('view-form').classList.add('fade-in');

            // Reset Form (or Fill)
            const form = document.getElementById('product-form');
            form.reset();
            resetImagePreview();

            if (editId) {
                const prod = products.find(p => p.id === editId);
                if (prod) {
                    document.getElementById('form-title').innerText = 'Editar Produto';
                    document.getElementById('edit-id').value = prod.id;
                    document.getElementById('prod-name').value = prod.name;
                    document.getElementById('prod-sku').value = prod.sku;
                    document.getElementById('prod-category').value = prod.category;
                    document.getElementById('prod-stock').value = prod.stock;
                    document.getElementById('prod-cost').value = prod.costPrice;
                    document.getElementById('prod-price').value = prod.salePrice;
                    document.getElementById('prod-desc').value = prod.description || '';

                    if (prod.image) {
                        setImagePreview(prod.image);
                    }
                }
            } else {
                document.getElementById('form-title').innerText = 'Novo Produto';
                document.getElementById('edit-id').value = '';
            }
        }

        function showList() {
            document.getElementById('view-form').classList.add('hidden');
            document.getElementById('view-list').classList.remove('hidden');
            document.getElementById('view-list').classList.add('fade-in');
        }

        function handleSaveProduct(e) {
            e.preventDefault();

            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('prod-name').value;
            const sku = document.getElementById('prod-sku').value;
            const category = document.getElementById('prod-category').value;
            const stock = document.getElementById('prod-stock').value;
            const cost = document.getElementById('prod-cost').value;
            const price = document.getElementById('prod-price').value;
            const desc = document.getElementById('prod-desc').value;
            const img = originalImageBase64; // Get from global var set by previewFile

            if (!id) {
                // Create
                const newProd = {
                    id: Date.now().toString(),
                    name, sku, category, stock,
                    costPrice: cost,
                    salePrice: price,
                    description: desc,
                    image: img,
                    createdAt: new Date().toISOString()
                };
                products.unshift(newProd); // Add to top
            } else {
                // Update
                const idx = products.findIndex(p => p.id === id);
                if (idx > -1) {
                    products[idx] = {
                        ...products[idx],
                        name, sku, category, stock,
                        costPrice: cost,
                        salePrice: price,
                        description: desc,
                        // Only update image if a new one was selected (originalImageBase64 not null), 
                        // BUT if we cleared it, we usually set it to null. 
                        // Logic: if preview is hidden, image is null. If hidden is removed, check src.
                        image: !document.getElementById('preview-image').classList.contains('hidden') ?
                            document.getElementById('preview-image').src : null
                    };
                }
            }

            saveToLocal();
            showList();
            // Optional toast or alert
        }

        function deleteProduct(id) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                products = products.filter(p => p.id !== id);
                saveToLocal();
            }
        }

        function renderProducts(filterText = '') {
            const grid = document.getElementById('product-grid');
            const empty = document.getElementById('empty-state');
            grid.innerHTML = '';

            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(filterText.toLowerCase()) ||
                p.sku.toLowerCase().includes(filterText.toLowerCase())
            );

            if (filtered.length === 0) {
                grid.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            empty.classList.add('hidden');

            filtered.forEach(p => {
                const imgUrl = p.image || '/assets/img/iconWeb.png'; // Fallback
                // Card HTML
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-shadow relative group";
                card.innerHTML = `
                    <div class="h-32 w-full bg-gray-50 rounded-xl mb-4 overflow-hidden relative flex items-center justify-center">
                        <img src="${imgUrl}" class="w-full h-full object-contain mix-blend-multiply" alt="${p.name}">
                        <span class="absolute top-2 left-2 bg-white/90 backdrop-blur text-[10px] font-bold px-2 py-1 rounded-lg uppercase text-gray-500 shadow-sm">${p.category || 'Geral'}</span>
                    </div>
                    
                    <div class="flex flex-col gap-1">
                        <h4 class="font-bold text-gray-800 text-sm leading-tight line-clamp-2" title="${p.name}">${p.name}</h4>
                        <p class="text-[10px] text-gray-400 font-mono tracking-wide">SKU: ${p.sku}</p>
                        
                        <div class="flex justify-between items-end mt-2">
                            <div>
                                <p class="text-[10px] text-gray-400">Venda</p>
                                <p class="text-base font-bold text-[var(--brand-color)]">${p.salePrice}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-gray-400">Estoque</p>
                                <p class="text-xs font-bold text-gray-700">${p.stock} un</p>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="absolute top-4 right-4 flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="showForm('${p.id}')" class="w-8 h-8 rounded-full bg-white text-gray-600 shadow-md flex items-center justify-center hover:bg-blue-50 hover:text-blue-600 transition-colors">
                            <i class='bx bx-edit-alt'></i>
                        </button>
                        <button onclick="deleteProduct('${p.id}')" class="w-8 h-8 rounded-full bg-white text-gray-600 shadow-md flex items-center justify-center hover:bg-red-50 hover:text-red-600 transition-colors">
                            <i class='bx bx-trash'></i>
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function filterProducts() {
            const val = document.getElementById('search-input').value;
            renderProducts(val);
        }

        // --- IMG HANDLERS ---
        function previewFile() {
            const preview = document.getElementById('preview-image');
            const placeholder = document.getElementById('upload-placeholder');
            const removeBtn = document.getElementById('remove-img-btn');
            const file = document.querySelector('input[type=file]').files[0];
            const reader = new FileReader();

            reader.addEventListener("load", function () {
                originalImageBase64 = reader.result; // Save base64
                preview.src = reader.result;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                removeBtn.classList.remove('hidden');
            }, false);

            if (file) {
                reader.readAsDataURL(file);
            }
        }

        function removeImage(e) {
            e.stopPropagation(); // prevent label click
            resetImagePreview();
        }

        function resetImagePreview() {
            const preview = document.getElementById('preview-image');
            const placeholder = document.getElementById('upload-placeholder');
            const fileInput = document.getElementById('dropzone-file');
            const removeBtn = document.getElementById('remove-img-btn');

            preview.src = '#';
            preview.classList.add('hidden');
            placeholder.classList.remove('hidden');
            removeBtn.classList.add('hidden');
            fileInput.value = ''; // clear input
            originalImageBase64 = null;
        }

        function setImagePreview(src) {
            const preview = document.getElementById('preview-image');
            const placeholder = document.getElementById('upload-placeholder');
            const removeBtn = document.getElementById('remove-img-btn');

            preview.src = src;
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
            removeBtn.classList.remove('hidden');
            originalImageBase64 = src; // Keep existing image logic
        }

        // --- MASK HELPERS ---
        function maskMoney(input) {
            let value = input.value.replace(/\D/g, "");
            value = (value / 100).toFixed(2) + "";
            value = value.replace(".", ",");
            value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
            input.value = value;
        }
    </script>
</body>

</html>