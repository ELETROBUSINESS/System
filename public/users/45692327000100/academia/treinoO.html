<!doctype html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diário de Treino — SPA</title>

  <!-- Tailwind CDN (mobile-first). Configuração rápida: dark mode class -->
  <script>
    // Tailwind config
    window.tailwind = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui'],
          }
        }
      }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Font Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    /* Small UI polish */
    :root { color-scheme: dark; }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    /* Simple floating modal background */
    .modal-backdrop { background: rgba(0,0,0,0.6); }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 antialiased min-h-screen">

  <!-- NOTE: The app expects globals: __app_id (string) and __firebase_config (object).
       Example to set them (put before the main script):
       <script>
         window.__app_id = "myApp123";
         window.__firebase_config = { apiKey: "...", authDomain: "...", projectId: "...", ... };
       </script>
  -->

  <!-- App container -->
  <div id="app" class="max-w-lg mx-auto px-4 py-6">

    <!-- LOGIN VIEW -->
    <div id="login-view" class="view block">
      <div class="mb-6">
        <h1 class="text-2xl font-bold">Diário de Treino</h1>
        <p class="text-sm text-gray-400">Faça login para começar a registrar seus treinos.</p>
      </div>

      <div class="space-y-4">
        <div class="bg-gray-800 rounded-lg p-4">
          <label class="block text-xs text-gray-300 mb-1">Email</label>
          <input id="email-input" type="email" placeholder="seu@exemplo.com" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 outline-none" />
        </div>

        <div class="bg-gray-800 rounded-lg p-4">
          <label class="block text-xs text-gray-300 mb-1">Senha</label>
          <input id="password-input" type="password" placeholder="••••••••" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 outline-none" />
        </div>

        <div class="flex gap-3">
          <button id="login-btn" class="flex-1 bg-emerald-500 hover:bg-emerald-400 text-black font-semibold rounded-lg py-2">Login</button>
          <button id="register-btn" class="flex-1 bg-transparent border border-gray-700 hover:border-gray-500 rounded-lg py-2">Registrar</button>
        </div>

        <div class="text-center">
          <button id="google-login-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white rounded-lg py-2 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C34.9 33 30.6 36 24 36 14.8 36 7.6 28.9 7.6 20S14.8 4 24 4c6.3 0 10.8 2.5 13.2 5.8l-6 5.1C30.6 12.2 27.5 11 24 11 16.8 11 11 16.8 11 24s5.8 13 13 13c7.4 0 12.2-5 12.2-12 0-.8-.1-1.4-.2-2.5z"/><path fill="#FF3D00" d="M6.3 14.6l6.6 4.8C14.1 16 18.7 13 24 13c3.5 0 6.6 1.2 8.8 3.2l6.4-5.6C36 6.9 30 4 24 4 15.3 4 7.9 9.3 6.3 14.6z"/><path fill="#4CAF50" d="M24 44c6.1 0 11.7-2.3 15.8-6.1l-7.1-5.8C30.6 34.8 27.4 36 24 36c-6.6 0-11.9-3-15.3-8.1L1.7 33C4.5 39 13 44 24 44z"/><path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3C36.4 30.5 31 36 24 36v0c6.6 0 12-6 12-12 0-.8-.1-1.4-.2-2.5z"/></svg>
            Login com Google
          </button>
        </div>

        <p id="login-message" class="text-xs text-red-400"></p>
      </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="dashboard-view" class="view hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Meus Treinos</h2>
        <div class="flex items-center gap-2">
          <button id="open-new-workout-btn" class="bg-emerald-500 px-3 py-2 rounded-lg text-black font-semibold">Iniciar Novo Treino</button>
          <button id="signout-btn" class="bg-transparent border border-gray-700 px-3 py-2 rounded-lg text-sm">Sair</button>
        </div>
      </div>

      <!-- Current summary card -->
      <div class="bg-gray-800 rounded-lg p-4 mb-4">
        <p class="text-sm text-gray-300">Histórico de Treinos — atualizando em tempo real</p>
      </div>

      <!-- Last workouts list -->
      <div id="history-list" class="space-y-3">
        <!-- Items rendered here -->
      </div>
    </div>

    <!-- WORKOUT VIEW -->
    <div id="workout-view" class="view hidden">
      <div class="mb-3 flex items-center justify-between">
        <h3 class="text-lg font-semibold">Treino Ativo</h3>
        <div class="flex gap-2">
          <button id="cancel-workout-btn" class="bg-transparent border border-gray-700 px-3 py-1 rounded-lg text-sm">Cancelar</button>
          <button id="finish-workout-btn" class="bg-blue-600 px-3 py-1 rounded-lg text-white">Finalizar Treino</button>
        </div>
      </div>

      <div class="bg-gray-800 rounded-lg p-4 mb-4">
        <label class="block text-xs text-gray-300 mb-1">Nome do Treino</label>
        <input id="workout-name" placeholder="Treino de Peito A" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2" />
      </div>

      <div class="bg-gray-800 rounded-lg p-4 mb-4">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold">Exercícios</h4>
          <button id="add-exercise-btn" class="bg-emerald-500 px-3 py-1 rounded-lg text-black text-sm">Adicionar Exercício</button>
        </div>

        <div id="exercises-container" class="space-y-2">
          <!-- exercise rows appended here -->
        </div>
      </div>
    </div>

    <!-- MODALS (hidden by default) -->
    <div id="exercise-modal" class="fixed inset-0 hidden items-center justify-center z-50">
      <div class="modal-backdrop absolute inset-0"></div>
      <div class="relative bg-gray-800 rounded-2xl p-4 w-full max-w-md z-10">
        <h4 class="font-semibold mb-2">Adicionar Exercício</h4>
        <div class="space-y-2">
          <input id="ex-name" placeholder="Nome do exercício (ex: Supino)" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2" />
          <div class="grid grid-cols-3 gap-2">
            <input id="ex-sets" type="number" placeholder="Séries" class="bg-gray-900 border border-gray-700 rounded-md px-3 py-2" />
            <input id="ex-reps" type="number" placeholder="Reps" class="bg-gray-900 border border-gray-700 rounded-md px-3 py-2" />
            <input id="ex-weight" type="number" placeholder="Peso (kg)" class="bg-gray-900 border border-gray-700 rounded-md px-3 py-2" />
          </div>
          <div class="flex gap-2 justify-end">
            <button id="close-ex-modal" class="px-3 py-2 rounded-lg border border-gray-700">Fechar</button>
            <button id="save-ex-btn" class="px-3 py-2 rounded-lg bg-emerald-500 text-black">Salvar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- small notification area -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden"></div>

  </div>

  <!-- === MAIN SCRIPT: Firebase modules + App logic (single file) === -->
  <script type="module">
    // ---------- Configuration expectations ----------
    // The host page must set:
    // window.__app_id (string) and window.__firebase_config (object).
    // Optionally window.__initial_auth_token for pre-auth flows.
    const APP_ID = window.__app_id || null;
    const FIREBASE_CONFIG = window.__firebase_config || null;
    const INITIAL_AUTH_TOKEN = window.__initial_auth_token || null;

    // Basic UI helper
    function showToast(msg, time = 3000) {
      const t = document.getElementById('toast');
      t.innerHTML = `<div class="bg-gray-800 border border-gray-700 text-sm text-gray-200 px-4 py-2 rounded-lg">${msg}</div>`;
      t.classList.remove('hidden');
      setTimeout(()=> t.classList.add('hidden'), time);
    }

    function showView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
      const el = document.getElementById(viewId);
      if (el) el.style.display = 'block';
      // small scroll to top for mobile feel
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Minimal DOM refs
    const loginView = document.getElementById('login-view');
    const dashboardView = document.getElementById('dashboard-view');
    const workoutView = document.getElementById('workout-view');
    const exerciseModal = document.getElementById('exercise-modal');

    // Auth UI elements
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const googleLoginBtn = document.getElementById('google-login-btn');
    const loginMessage = document.getElementById('login-message');
    const signOutBtn = document.getElementById('signout-btn');

    // Dashboard / workout UI
    const openNewWorkoutBtn = document.getElementById('open-new-workout-btn');
    const historyList = document.getElementById('history-list');

    const workoutNameInput = document.getElementById('workout-name');
    const exercisesContainer = document.getElementById('exercises-container');
    const addExerciseBtn = document.getElementById('add-exercise-btn');
    const finishWorkoutBtn = document.getElementById('finish-workout-btn');
    const cancelWorkoutBtn = document.getElementById('cancel-workout-btn');

    // Modal elements
    const exNameInput = document.getElementById('ex-name');
    const exSetsInput = document.getElementById('ex-sets');
    const exRepsInput = document.getElementById('ex-reps');
    const exWeightInput = document.getElementById('ex-weight');
    const saveExBtn = document.getElementById('save-ex-btn');
    const closeExModalBtn = document.getElementById('close-ex-modal');

    // Local state
    let currentUser = null;
    let currentUserId = null;
    let exercises = []; // array of { nome, series, reps, peso }
    let unsubscribeSnapshot = null;
    let db = null, auth = null;

    // ---------------- Firebase imports & init ----------------
    if (!FIREBASE_CONFIG) {
      // If firebase config not provided, show login view but disable actions.
      showToast('Atenção: __firebase_config não encontrado. Defina window.__firebase_config antes de carregar este arquivo.');
      showView('login-view');
    }

    // Import firebase modular SDKs from CDN
    import { initializeApp, getApps, setLogLevel } from 'https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js';
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signInWithPopup,
      GoogleAuthProvider,
      signOut,
      onAuthStateChanged,
      signInWithCustomToken
    } from 'https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js';
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      onSnapshot,
      doc,
      getDoc,
      query,
      orderBy
    } from 'https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js';

    // set debug logging
    setLogLevel('debug');

    // Initialize app
    let app;
    try {
      if (getApps().length === 0 && FIREBASE_CONFIG) {
        app = initializeApp(FIREBASE_CONFIG);
      } else {
        // if already initialized, use existing
        app = getApps()[0];
      }
      auth = getAuth(app);
      db = getFirestore(app);
    } catch (err) {
      console.error('Erro inicializando Firebase:', err);
      showToast('Erro ao inicializar Firebase. Veja console para detalhes.');
      // still continue to show login so user can see UI
      showView('login-view');
    }

    // If an initial auth token is provided (custom token), sign in with it
    if (INITIAL_AUTH_TOKEN && auth) {
      signInWithCustomToken(auth, INITIAL_AUTH_TOKEN).catch(e => {
        console.warn('Falha no signInWithCustomToken:', e);
      });
    }

    // ---------------- Auth state handling ----------------
    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        currentUserId = user.uid;
        showToast('Bem-vindo! Carregando seus treinos...');
        showView('dashboard-view');
        startListeningWorkouts();
      } else {
        currentUserId = null;
        exercises = [];
        renderExercises();
        if (unsubscribeSnapshot) {
          unsubscribeSnapshot();
          unsubscribeSnapshot = null;
        }
        showView('login-view');
      }
    });

    // ---------------- Auth actions ----------------
    loginBtn.addEventListener('click', async () => {
      loginMessage.textContent = '';
      const email = emailInput.value.trim();
      const pass = passwordInput.value;
      if (!email || !pass) {
        loginMessage.textContent = 'Preencha email e senha.';
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        emailInput.value = '';
        passwordInput.value = '';
        loginMessage.textContent = '';
      } catch (e) {
        console.error(e);
        loginMessage.textContent = e.message || 'Erro ao efetuar login.';
      }
    });

    registerBtn.addEventListener('click', async () => {
      loginMessage.textContent = '';
      const email = emailInput.value.trim();
      const pass = passwordInput.value;
      if (!email || !pass) {
        loginMessage.textContent = 'Preencha email e senha.';
        return;
      }
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
        emailInput.value = '';
        passwordInput.value = '';
        showToast('Conta criada com sucesso!');
      } catch (e) {
        console.error(e);
        loginMessage.textContent = e.message || 'Erro ao registrar.';
      }
    });

    googleLoginBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.error('Google sign-in erro:', e);
        showToast('Login com Google falhou.');
      }
    });

    signOutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        showToast('Você saiu.');
      } catch (e) {
        console.error(e);
        showToast('Erro no logout.');
      }
    });

    // ---------------- Workouts Firestore logic ----------------
    function workoutsCollectionRef(uid) {
      // path: artifacts/{appId}/users/{userId}/workouts
      if (!APP_ID) {
        console.warn('APP_ID não definido. Usando "defaultApp".');
      }
      const appId = APP_ID || 'defaultApp';
      return collection(db, `artifacts/${appId}/users/${uid}/workouts`);
    }

    function startListeningWorkouts() {
      if (!currentUserId) return;
      const colRef = workoutsCollectionRef(currentUserId);
      // use onSnapshot to listen for live updates
      unsubscribeSnapshot = onSnapshot(colRef, snap => {
        const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        // sort by 'data' timestamp descending in JavaScript (safe as requested)
        items.sort((a, b) => {
          const ta = a.data ? (a.data.seconds || 0) : 0;
          const tb = b.data ? (b.data.seconds || 0) : 0;
          return tb - ta;
        });
        renderHistory(items);
      }, err => {
        console.error('Erro no onSnapshot:', err);
        showToast('Erro ao escutar histórico.');
      });
    }

    async function saveWorkoutToFirestore(obj) {
      if (!currentUserId) {
        showToast('Usuário não autenticado.');
        return;
      }
      const colRef = workoutsCollectionRef(currentUserId);
      try {
        const docRef = await addDoc(colRef, obj);
        showToast('Treino salvo!');
        console.log('Saved workout id:', docRef.id);
      } catch (e) {
        console.error('Erro ao salvar workout:', e);
        showToast('Erro ao salvar treino.');
      }
    }

    // ---------------- UI render helpers ----------------
    function renderHistory(items) {
      historyList.innerHTML = '';
      if (!items || items.length === 0) {
        historyList.innerHTML = `<div class="bg-gray-800 rounded-lg p-4 text-sm text-gray-400">Nenhum treino ainda.</div>`;
        return;
      }

      items.forEach(it => {
        const dateObj = it.data ? (it.data.toDate ? it.data.toDate() : new Date(it.data.seconds * 1000)) : new Date();
        const dateStr = dateObj.toLocaleString();
        const card = document.createElement('div');
        card.className = 'bg-gray-800 rounded-lg p-4 flex justify-between items-start gap-4';
        const left = document.createElement('div');
        left.innerHTML = `<div class="font-semibold">${escapeHtml(it.nome || 'Sem nome')}</div>
                          <div class="text-xs text-gray-400">${dateStr}</div>
                          <div class="mt-2 text-sm text-gray-300">${(it.exercicios || []).length} exerc. </div>`;
        const right = document.createElement('div');
        right.className = 'text-xs text-gray-300';
        right.innerHTML = `<button data-id="${it.id}" class="open-workout-detail px-2 py-1 rounded-md border border-gray-700 text-sm">Ver</button>`;
        card.appendChild(left);
        card.appendChild(right);
        historyList.appendChild(card);
      });

      // add listeners to "Ver" buttons to show details
      document.querySelectorAll('.open-workout-detail').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.dataset.id;
          // fetch doc and display modal-like detail (simple alert)
          try {
            const d = await getDoc(doc(db, `artifacts/${APP_ID || 'defaultApp'}/users/${currentUserId}/workouts/${id}`));
            const data = d.data();
            let details = `Treino: ${data.nome || 'Sem nome'}\nData: ${data.data ? (data.data.toDate ? data.data.toDate().toLocaleString() : new Date(data.data.seconds*1000).toLocaleString()) : '-' }\n\nExercícios:\n`;
            (data.exercicios || []).forEach((ex, idx) => {
              details += `${idx+1}. ${ex.nome} — ${ex.series}x${ex.reps} @ ${ex.peso}kg\n`;
            });
            alert(details);
          } catch (err) {
            console.error(err);
            showToast('Erro ao carregar detalhes.');
          }
        });
      });
    }

    function renderExercises() {
      exercisesContainer.innerHTML = '';
      if (exercises.length === 0) {
        exercisesContainer.innerHTML = `<div class="text-sm text-gray-400">Nenhum exercício adicionado.</div>`;
        return;
      }
      exercises.forEach((ex, idx) => {
        const row = document.createElement('div');
        row.className = 'bg-gray-900 border border-gray-700 rounded-md p-3 flex items-center justify-between gap-3';
        row.innerHTML = `<div>
            <div class="font-semibold">${escapeHtml(ex.nome)}</div>
            <div class="text-xs text-gray-400">${ex.series} séries • ${ex.reps} reps • ${ex.peso} kg</div>
          </div>
          <div class="flex gap-2">
            <button data-idx="${idx}" class="remove-ex-btn px-2 py-1 text-xs rounded-md border border-gray-700">Remover</button>
          </div>`;
        exercisesContainer.appendChild(row);
      });
      // listeners for remove
      document.querySelectorAll('.remove-ex-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const i = Number(e.currentTarget.dataset.idx);
          exercises.splice(i, 1);
          renderExercises();
        });
      });
    }

    // escape for safe insertion
    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    // ---------------- Workout flow ----------------
    openNewWorkoutBtn.addEventListener('click', () => {
      exercises = [];
      workoutNameInput.value = '';
      renderExercises();
      showView('workout-view');
    });

    cancelWorkoutBtn.addEventListener('click', () => {
      if (confirm('Cancelar treino atual? As informações não salvas serão perdidas.')) {
        exercises = [];
        renderExercises();
        showView('dashboard-view');
      }
    });

    finishWorkoutBtn.addEventListener('click', async () => {
      const nome = workoutNameInput.value.trim() || 'Treino sem nome';
      if (exercises.length === 0) {
        if (!confirm('Nenhum exercício adicionado. Deseja salvar mesmo assim?')) return;
      }
      const payload = {
        nome,
        data: serverTimestamp(),
        exercicios: exercises.map(e => ({
          nome: e.nome,
          series: Number(e.series) || 0,
          reps: Number(e.reps) || 0,
          peso: Number(e.peso) || 0
        }))
      };
      await saveWorkoutToFirestore(payload);
      // reset
      exercises = [];
      renderExercises();
      workoutNameInput.value = '';
      showView('dashboard-view');
    });

    // ---------------- Exercise modal ----------------
    addExerciseBtn.addEventListener('click', () => {
      exNameInput.value = '';
      exSetsInput.value = '';
      exRepsInput.value = '';
      exWeightInput.value = '';
      exerciseModal.style.display = 'flex';
    });

    closeExModalBtn.addEventListener('click', () => {
      exerciseModal.style.display = 'none';
    });

    saveExBtn.addEventListener('click', () => {
      const nome = exNameInput.value.trim();
      const series = exSetsInput.value.trim();
      const reps = exRepsInput.value.trim();
      const peso = exWeightInput.value.trim();
      if (!nome) {
        showToast('Informe o nome do exercício.');
        return;
      }
      exercises.push({ nome, series: series || 0, reps: reps || 0, peso: peso || 0 });
      renderExercises();
      exerciseModal.style.display = 'none';
    });

    // close modal on backdrop click
    exerciseModal.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-backdrop')) {
        exerciseModal.style.display = 'none';
      }
    });

    // utility: getDoc used earlier, need to import doc/getDoc; ensure available
    // (getDoc & doc imported above)

    // ---------------- Helpers & Init ----------------
    // Show login as default until auth state tells otherwise
    showView('login-view');

    // Expose some debugging to window
    window.__diarioTreino = {
      startListeningWorkouts,
      saveWorkoutToFirestore,
      getExercises: () => exercises,
      getCurrentUser: () => currentUser
    };
  </script>
</body>
</html>
