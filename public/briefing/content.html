<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrega de Designs - Lívia</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVQ3tf6Qu4_9PajpJclZAJjVvRgB4ZE2I",
            authDomain: "super-app25.firebaseapp.com",
            projectId: "super-app25",
            storageBucket: "super-app25.firebasestorage.app",
            messagingSenderId: "810900166273",
            appId: "1:810900166273:web:24b8f055a68c9f0a6b5f80"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.fs = { collection, onSnapshot, addDoc, deleteDoc, doc, query, where, getDocs };
    </script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        /* PDF Marker Styles */
        .pdf-page-wrapper {
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
            border-radius: 8px;
            display: inline-block;
            background: white;
            transition: transform 0.3s ease;
        }

        .pdf-page-wrapper:hover {
            transform: translateY(-5px);
        }

        .pdf-marker {
            position: absolute;
            width: 32px;
            height: 32px;
            background: #b91c1c;
            /* red-700 */
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
            transform: translate(-50%, -50%) scale(1);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .pdf-marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .pdf-marker::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid #b91c1c;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .pdf-marker:hover::after {
            opacity: 1;
            animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        @keyframes ping {

            75%,
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* Marker Tooltip */
        .marker-tooltip {
            position: absolute;
            bottom: 140%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(4px);
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: all 0.2s;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            z-index: 20;
        }

        .pdf-marker:hover .marker-tooltip {
            opacity: 1;
            bottom: 150%;
        }

        /* Edit Overlay */
        .pdf-edit-overlay {
            position: absolute;
            inset: 0;
            cursor: crosshair;
            z-index: 5;
            display: none;
        }

        .edit-mode-active .pdf-edit-overlay {
            display: block;
        }

        /* ... existing animations ... */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 font-sans selection:bg-red-100 min-h-screen relative pb-40">
    <!-- Header Minimalista -->
    <header class="bg-white border-b border-slate-100 sticky top-0 z-20">
        <div class="max-w-5xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-full bg-red-700 text-white flex items-center justify-center font-serif text-lg select-none shadow-sm">
                    L </div>
                <div>
                    <h1 class="text-sm font-semibold text-slate-900">Lívia</h1>
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Advogada</p>
                </div>
            </div>
            <div class="text-xs font-medium text-slate-400 border border-slate-200 px-3 py-1 rounded-full select-none">
                Entrega Final </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 md:px-6 py-8 md:py-12">
        <!-- Intro Section -->
        <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
            <div>
                <h2 class="text-2xl font-light text-slate-900 mb-2">Identidade Visual & Materiais</h2>
                <p class="text-slate-500 max-w-lg">Explore o brandbook completo abaixo. Clique nos marcadores para
                    baixar as versões finais de cada item. </p>
            </div>
            <div class="flex gap-2"><button id="btn-toggle-edit" onclick="toggleEditMode()"
                    class="px-4 py-2 text-xs font-semibold rounded-lg border border-slate-200 hover:bg-slate-50 transition-colors flex items-center gap-2"><i
                        data-lucide="settings-2" class="w-4 h-4 text-slate-500"></i>Modo Edição </button></div>
        </div>
        <!-- Abas de Categoria -->
        <div
            class="flex items-center gap-4 mb-8 border-b border-slate-200 overflow-x-auto whitespace-nowrap scrollbar-hide">
            <button onclick="setCategory('brandbook')" id="tab-brandbook"
                class="pb-3 text-sm font-medium transition-colors border-b-2 border-red-700 text-red-700">Brandbook
                Interativo </button><button onclick="setCategory('feed')" id="tab-feed"
                class="pb-3 text-sm font-medium transition-colors border-b-2 border-transparent text-slate-500 hover:text-slate-800">Feed
                / Post </button><button onclick="setCategory('story')" id="tab-story"
                class="pb-3 text-sm font-medium transition-colors border-b-2 border-transparent text-slate-500 hover:text-slate-800">Stories
            </button>
        </div>
        <!-- PDF VIEWER CONTAINER -->
        <div id="pdf-viewer-container"
            class="relative bg-slate-100 rounded-2xl border border-slate-200 min-h-[600px] mb-12">
            <div id="pdf-loader-status"
                class="absolute inset-0 flex flex-col items-center justify-center bg-white z-10 transition-opacity">
                <div class="w-10 h-10 border-4 border-slate-200 border-t-red-600 rounded-full animate-spin">
                </div>
                <p class="mt-4 text-sm font-medium text-slate-600">Carregando Brandbook...</p>
            </div>
            <!-- Canvas container for PDF pages -->
            <div id="pdf-pages-container" class="p-4 md:p-8 space-y-12 flex flex-col items-center scroll-smooth w-full">
                <!-- Pages will be injected here -->
            </div>
            <!-- Toolbar flutuante do PDF -->
            <div
                class="absolute bottom-6 left-1/2 -translate-x-1/2 flex items-center gap-2 bg-white/90 backdrop-blur-md border border-slate-200 px-4 py-2 rounded-full shadow-lg z-20">
                <button onclick="zoomOut()" class="p-1 hover:bg-slate-100 rounded-full transition-colors"><i
                        data-lucide="minus" class="w-4 h-4"></i></button><span id="zoom-percent"
                    class="text-xs font-bold w-12 text-center">100%</span><button onclick="zoomIn()"
                    class="p-1 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="plus"
                        class="w-4 h-4"></i></button>
                <div class="w-px h-4 bg-slate-200 mx-2"></div><button onclick="scrollToTop()"
                    class="p-1 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="chevron-up"
                        class="w-4 h-4"></i></button>
            </div>
            <!-- Status de Edição -->
            <div id="edit-status-badge"
                class="absolute top-6 left-6 bg-red-600 text-white px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest hidden shadow-lg animate-pulse z-20">
                MODO EDIÇÃO ATIVO: Clique na página para marcar </div>
        </div>
        <!-- Toolbar (Original para Feed/Story) -->
        <div id="original-toolbar" class="hidden justify-between items-center mb-6 select-none"><button
                id="btn-select-all"
                class="text-sm font-medium text-slate-600 hover:text-slate-900 transition-colors flex items-center gap-2 group">
                <div id="checkbox-all"
                    class="w-4 h-4 rounded border border-slate-300 flex items-center justify-center transition-colors">
                    <span id="check-wrapper" class="flex items-center justify-center opacity-0 transition-opacity"><i
                            data-lucide="check" class="text-white w-2.5 h-2.5"></i></span>
                </div><span id="text-select-all">Selecionar todos desta seção</span>
            </button><span id="selection-count" class="text-sm text-slate-400">0 selecionados </span>
        </div>
        <!-- Grid de Designs (Original) -->
        <div id="designs-grid" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 min-h-[400px]">
            <!-- Cards inseridos via JS -->
        </div>
    </main>
    <div
        class="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-white via-white to-transparent pointer-events-none z-30">
        <div class="max-w-xl mx-auto space-y-4 pointer-events-auto">
            <!-- Botão de Download (Para Feed e Stories) -->
            <button id="btn-action" disabled
                class="w-full py-4 rounded-xl font-medium text-sm transition-all duration-300 flex items-center justify-center gap-3 shadow-xl bg-slate-200 text-slate-400 cursor-not-allowed hidden">
                <i data-lucide="download" class="w-4 h-4"></i>
                <span>Selecione itens para baixar</span>
            </button>

        </div>
    </div>
    <!-- TELA CHEIA DE CHECKOUT -->
    <div id="fullscreen-checkout" class="fixed inset-0 z-50 bg-white hidden overflow-y-auto">
        <!-- ETAPA 1: RESUMO DO PEDIDO -->
        <div id="step-summary"
            class="min-h-screen flex flex-col items-center justify-center p-6 slide-up w-full max-w-lg mx-auto">
            <!-- Ícone de Sucesso/Download -->
            <div class="flex justify-center mb-8">
                <div
                    class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center shadow-sm">
                    <i data-lucide="check-circle-2" class="w-8 h-8"></i>
                </div>
            </div>
            <div class="text-center mb-10">
                <h2 class="text-3xl font-light text-slate-900 mb-3">Download
                    Iniciado !</h2>
                <p class="text-slate-500">Seus arquivos estão sendo baixados.
                    Enquanto isso,
                    você pode finalizar o pagamento do pacote contratado. </p>
            </div>
            <!-- Card de Fatura -->
            <div class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-6 mb-8 shadow-sm">
                <div class="flex justify-between items-center mb-6 pb-6 border-b border-slate-200/60">
                    <div>
                        <p class="text-sm font-semibold text-slate-900">
                            Pacote de Edição de Imagens</p>
                        <p class="text-xs text-slate-500 mt-0.5">Prestação
                            de Serviço</p>
                    </div><span class="text-lg font-bold text-slate-900">R$
                        50,
                        00</span>
                </div>
                <!-- Nota Fiscal -->
                <div
                    class="flex items-center justify-between bg-white border border-dashed border-slate-200 rounded-lg p-3 mb-2 opacity-70">
                    <div class="flex items-center gap-2 text-slate-400">
                        <i data-lucide="file-text" class="w-4 h-4"></i><span
                            class="text-xs font-medium uppercase tracking-wide">Nota
                            Fiscal</span>
                    </div>
                    <div class="flex items-center gap-1.5 text-xs text-slate-400">
                        <span>Disponível após pgto.</span><i data-lucide="lock" class="w-3 h-3"></i>
                    </div>
                </div>
            </div>
            <!-- Botão Continuar --><button onclick="goToStep2()"
                class="w-full py-4 bg-slate-900 hover:bg-slate-800 text-white rounded-xl font-medium text-lg shadow-xl shadow-slate-900/10 transition-all flex items-center justify-center gap-3"><span>Continuar</span><i
                    data-lucide="arrow-right" class="w-5 h-5"></i></button>
            <p class="text-center text-xs text-slate-400 mt-6">Etapa 1
                de 2 </p>
        </div>
        <!-- ETAPA 2: GORJETA (Escondida Inicialmente) -->
        <div id="step-tip" class="min-h-screen flex-col items-center justify-center p-6 w-full max-w-lg mx-auto hidden">
            <div class="w-full text-center mb-12 fade-in">
                <div
                    class="w-14 h-14 bg-amber-50 text-amber-500 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="coffee" class="w-7 h-7"></i>
                </div>
                <h2 class="text-2xl font-semibold text-slate-900 mb-3">Gostou do
                    Atendimento Personalizado?</h2>
                <p class="text-slate-500 text-sm leading-relaxed px-4">Nosso
                    time se esforçou para entregar tudo no prazo. Se quiser,
                    você pode adicionar uma gorjeta extra como agradecimento
                    (opcional). </p>
            </div>
            <!-- Input Gigante -->
            <div class="w-full mb-12 relative fade-in" style="animation-delay: 0.1s;"><label
                    class="block text-center text-xs uppercase tracking-widest text-slate-400 mb-4 font-medium">Valor
                    da Gorjeta (Opcional)</label>
                <div class="relative max-w-[240px] mx-auto group"><span
                        class="absolute left-6 top-1/2 -translate-y-1/2 text-slate-400 text-2xl font-light">R$</span><input
                        type="number" id="tip-input" oninput="updateTotal(this.value)" placeholder="0,00"
                        class="w-full pl-16 pr-6 py-6 bg-white border-2 border-slate-100 rounded-2xl text-4xl text-slate-900 font-bold focus:outline-none focus:border-slate-900 focus:shadow-xl transition-all text-center placeholder:text-slate-200"
                        min="0" step="0.01" autofocus></div>
            </div>
            <!-- Botão Finalizar -->
            <div class="w-full space-y-4 fade-in" style="animation-delay: 0.2s;"><button onclick="finalizePayment()"
                    id="btn-final-pay"
                    class="w-full py-4 bg-slate-900 hover:bg-slate-800 text-white rounded-xl font-medium text-lg shadow-xl shadow-slate-900/10 transition-all flex items-center justify-center gap-3"><span>Pagar
                        R$ 50,
                        00</span><i data-lucide="check" class="w-5 h-5"></i></button><button onclick="skipTip()"
                    class="w-full py-3 text-sm text-slate-400 hover:text-slate-600 transition-colors">Pagar
                    sem gorjeta </button></div>
        </div>
        <!-- ETAPA: LOADING SIMULADO -->
        <div id="step-loading-pix"
            class="min-h-screen flex flex-col items-center justify-center p-6 w-full max-w-lg mx-auto hidden">
            <div class="flex flex-col items-center gap-6">
                <div class="relative">
                    <div class="w-20 h-20 border-4 border-slate-100 border-t-emerald-500 rounded-full animate-spin">
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i data-lucide="qr-code" class="w-8 h-8 text-emerald-500/50"></i>
                    </div>
                </div>
                <div class="text-center">
                    <h3 class="text-xl font-bold text-slate-900 mb-2">Gerando seu Pix...</h3>
                    <p class="text-slate-400 text-sm">Preparando código com taxa zero.</p>
                </div>
            </div>
        </div>

        <!-- ETAPA 3: PIX (Gerado) -->
        <!-- ETAPA 4: PIX FIXO (Taxa Zero) -->
        <div id="step-pix-static"
            class="min-h-screen flex flex-col items-center justify-center p-6 w-full max-w-lg mx-auto hidden transition-all duration-500">
            <div class="w-full text-center mb-8">
                <div
                    class="w-14 h-14 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="qr-code" class="w-7 h-7"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Pagamento via Pix</h2>
                <p class="text-slate-500 text-sm">Escaneie o QR Code ou use o Copia e Cola para liberar o download sem
                    taxas extras.</p>
            </div>

            <!-- QR Code Estático Placeholder -->
            <div class="bg-white p-6 rounded-3xl shadow-2xl border border-slate-100 mb-8 w-full max-w-[280px]">
                <div
                    class="aspect-square bg-slate-50 rounded-2xl overflow-hidden flex items-center justify-center border border-slate-100 p-2">
                    <img id="static-pix-qrcode" class="w-full h-full object-contain"
                        src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=COLE_SEU_PIX_AQUI"
                        alt="QR Code Pix Estático">
                </div>
            </div>

            <!-- Copia e Cola Estático -->
            <div class="w-full mb-8">
                <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Pix Copia e
                    Cola</label>
                <div class="flex gap-2">
                    <input type="text" id="static-pix-value" readonly
                        value="00020126620014br.gov.bcb.pix0114626420760001780222Payment 2/2 servide ID5204000053039865406250.005802BR592462.642.076 GILVAN LAURIA6009Sao Paulo62240520daqr268338934018219363049D41"
                        class="flex-1 bg-slate-50 border border-slate-200 text-slate-600 text-xs rounded-xl px-4 py-4 focus:outline-none font-mono truncate">
                    <button onclick="copyStaticPix()"
                        class="bg-slate-900 text-white px-5 rounded-xl hover:bg-slate-800 transition-all flex items-center justify-center">
                        <i data-lucide="copy" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <button onclick="closeCheckout()"
                class="w-full py-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-2xl font-bold text-lg shadow-lg shadow-emerald-200 transition-all flex items-center justify-center gap-3">
                <span>Já realizei o pagamento</span>
                <i data-lucide="check-circle" class="w-5 h-5"></i>
            </button>
            <button onclick="closeCheckout()"
                class="mt-4 text-slate-400 text-sm font-medium hover:text-slate-600">Fechar</button>
        </div>
    </div>
    <!-- STORY VIEWER OVERLAY -->
    <div id="story-viewer" class="fixed inset-0 z-40 bg-black hidden flex-col items-center justify-center">
        <!-- Progress Bars -->
        <div id="story-progress-container" class="absolute top-4 left-4 right-4 flex gap-1 z-50">
            <!-- Bars injected via JS -->
        </div>
        <!-- Header Controls -->
        <div class="absolute top-8 left-0 right-0 p-4 z-50 flex justify-between items-center text-white/90">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center font-bold text-xs"
                    id="story-avatar">L</div><span class="text-sm font-semibold text-shadow">Stories</span><span
                    class="text-xs opacity-70 ml-2" id="story-counter">1/6</span>
            </div><button onclick="closeStoryViewer()" class="p-2 hover:bg-white/10 rounded-full"><i data-lucide="x"
                    class="w-6 h-6"></i></button>
        </div>
        <!-- Story Content -->
        <div class="relative w-full h-full max-w-md mx-auto flex items-center justify-center bg-black/20">
            <!-- Image --><img id="story-image" src="" class="max-h-full max-w-full object-contain" alt="Story">
            <!-- Navigation Tap Areas -->
            <div class="absolute inset-y-0 left-0 w-1/3 z-20" onclick="prevStory()"></div>
            <div class="absolute inset-y-0 right-0 w-1/3 z-20" onclick="nextStory()"></div>
            <!-- Selection Overlay (Big Check) -->
            <div id="story-selected-indicator"
                class="absolute inset-0 z-10 flex items-center justify-center bg-black/40 hidden pointer-events-none">
                <i data-lucide="check-circle-2"
                    class="w-24 h-24 text-red-500 drop-shadow-lg animate-in fade-in zoom-in duration-300"></i>
            </div>
        </div>
        <!-- Footer / Select Button -->
        <div class="absolute bottom-10 z-50"><button id="btn-story-select" onclick="toggleCurrentStory()"
                class="px-8 py-3 rounded-full font-bold shadow-lg transition-all transform active:scale-95 flex items-center gap-2 text-sm bg-white text-slate-900 border-2 border-white">
                <div id="story-btn-check-icon"
                    class="w-5 h-5 rounded-full border border-slate-300 flex items-center justify-center">
                    <i data-lucide="check" class="w-3 h-3 opacity-0"></i>
                </div>
                <span>Selecionar para Baixar</span>
            </button></div>
    </div>
    <!-- MODAL DE DETALHES DO MARCADOR (Ver Mais) -->
    <div id="marker-detail-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeMarkerModal()"></div>
        <div class="bg-white rounded-3xl w-full max-w-md mx-4 overflow-hidden shadow-2xl relative animate-story-next">
            <div class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <div id="modal-marker-thumb-container"
                        class="w-24 h-24 bg-slate-50 rounded-2xl overflow-hidden border border-slate-100 flex items-center justify-center">
                        <img id="modal-marker-thumb" src="" alt="Thumbnail" class="w-full h-full object-contain hidden">
                        <div id="modal-marker-icon-fallback" class="text-red-600"><i data-lucide="layout"
                                class="w-8 h-8"></i></div>
                    </div>
                    <button onclick="closeMarkerModal()"
                        class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="x"
                            class="w-5 h-5 text-slate-400"></i></button>
                </div>
                <div class="flex items-center gap-2 mb-2">
                    <h3 id="modal-marker-title" class="text-2xl font-bold text-slate-900">Nome da Arte</h3>
                </div>
                <p class="text-slate-500 mb-8 leading-relaxed text-sm">Este arquivo faz
                    parte da sua identidade visual aprovada. Selecione o formato desejado para baixar a
                    versão em alta resolução.</p>
                <div id="download-options-container" class="space-y-3">
                    <!-- Botões de download injetados via JS -->
                </div>
            </div>
        </div>
    </div>
    <!-- MODAL DE CRIAÇÃO (Admin Only) -->
    <div id="marker-create-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeCreateModal()"></div>
        <div class="bg-white rounded-3xl w-full max-w-md mx-4 p-8 shadow-2xl relative">
            <h3 class="text-xl font-bold text-slate-900 mb-6 flex items-center gap-3">
                <i data-lucide="plus-circle" class="text-red-600"></i>Novo
                Marcador
            </h3>
            <div class="flex gap-4 p-1 bg-slate-100 rounded-2xl mb-6">
                <button id="type-btn-file" onclick="setMarkerType('file')"
                    class="flex-1 py-3 text-xs font-black uppercase rounded-xl transition-all bg-white text-slate-800 shadow-sm">Arquivo</button>
                <button id="type-btn-text" onclick="setMarkerType('text')"
                    class="flex-1 py-3 text-xs font-black uppercase rounded-xl transition-all text-slate-500">Texto /
                    Cor</button>
            </div>

            <div>
                <label class="block text-xs font-black uppercase text-slate-400 mb-2">Nome do Item</label>
                <input type="text" id="input-marker-name" placeholder="Ex: Logotipo Principal"
                    class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded-xl focus:outline-none focus:border-red-600 transition-colors font-medium">
            </div>

            <!-- Campos de Arquivo -->
            <div id="fields-file" class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Link PNG</label>
                    <input type="text" id="input-marker-link-png" placeholder="Link do arquivo PNG"
                        class="w-full px-4 py-2 bg-slate-50 border border-slate-100 rounded-xl focus:outline-none focus:border-red-600 transition-colors text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Link PDF</label>
                    <input type="text" id="input-marker-link-pdf" placeholder="Link do arquivo PDF"
                        class="w-full px-4 py-2 bg-slate-50 border border-slate-100 rounded-xl focus:outline-none focus:border-red-600 transition-colors text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Link SVG</label>
                    <input type="text" id="input-marker-link-svg" placeholder="Link do arquivo SVG"
                        class="w-full px-4 py-2 bg-slate-50 border border-slate-100 rounded-xl focus:outline-none focus:border-red-600 transition-colors text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Link DOCX</label>
                    <input type="text" id="input-marker-link-docx" placeholder="Link do arquivo Word/DOCX"
                        class="w-full px-4 py-2 bg-slate-50 border border-slate-100 rounded-xl focus:outline-none focus:border-red-600 transition-colors text-sm">
                </div>
            </div>

            <!-- Campo de Texto -->
            <div id="fields-text" class="hidden">
                <label class="block text-xs font-black uppercase text-slate-400 mb-2">Conteúdo para Copiar</label>
                <textarea id="input-marker-text" placeholder="Ex: #B91C1C ou Pantone 186C"
                    class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded-xl focus:outline-none focus:border-red-600 transition-colors font-medium min-h-[100px]"></textarea>
            </div>
            <div class="pt-4 flex gap-3"><button onclick="saveNewMarker()"
                    class="flex-1 py-4 bg-red-600 text-white rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-700 transition-all">Salvar
                    Marcador </button><button onclick="closeCreateModal()"
                    class="px-6 py-4 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-all">Cancelar
                </button></div>
        </div>
    </div>
    </div>
    <script> // --- CONFIGURAÇÃO PDF ---
        const PDF_URL = 'brandbook.pdf';
        let pdfDoc = null;
        let pdfScale = 1.0;
        let isEditMode = false;
        let pendingMarkerCoords = null;
        let markers = [];
        let currentMarkerType = 'file';

        // --- Firebase Sycn ---
        async function initFirebaseSync() {
            if (!window.db) {
                setTimeout(initFirebaseSync, 500);
                return;
            }

            const q = window.fs.query(window.fs.collection(window.db, "briefing_livia_markers"));
            window.fs.onSnapshot(q, (snapshot) => {
                markers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (pdfDoc) {
                    for (let i = 1; i <= pdfDoc.numPages; i++) {
                        const wrapper = document.getElementById(`page-wrapper-${i}`);
                        if (wrapper) renderMarkers(i);
                    }
                }
            }, (error) => {
                console.error("Erro na sincronização Firebase:", error);
                if (error.code === 'permission-denied') {
                    console.warn("Acesso negado: Verifique as regras do Firestore no Console do Firebase.");
                }
            });
        }
        initFirebaseSync();

        // --- Dados Originais (para fallback se o user quiser voltar) ---
        const designs = [{
            id: 1, category: 'feed', title: "Área de Atuação - Modelo 1", type: "Feed", url: "area-de-atuacao-mdl1.png", downloadUrl: "area-de-atuacao-mdl1.png"
        }

            ,
        {
            id: 2, category: 'feed', title: "Área de Atuação - Modelo 2", type: "Feed", url: "area-de-atuacao-mdl2.png", downloadUrl: "area-de-atuacao-mdl2.png"
        }

            ,
        {
            id: 3, category: 'feed', title: "Salário Maternidade", type: "Feed", url: "salario-maternidade.png", downloadUrl: "salario-maternidade.png"
        }

            ,
        {
            id: 4, category: 'feed', title: "Direito Previdenciário", type: "Feed", url: "previdenciario.png", downloadUrl: "previdenciario.png"
        }

            ,
        {
            id: 5, category: 'story', title: "Story 01", type: "Story", url: "1.png", downloadUrl: "1.png"
        }

            ,
        {
            id: 6, category: 'story', title: "Story 02", type: "Story", url: "2.png", downloadUrl: "2.png"
        }

            ,
        {
            id: 7, category: 'story', title: "Story 03", type: "Story", url: "3.png", downloadUrl: "3.png"
        }

            ,
        {
            id: 8, category: 'story', title: "Story 04", type: "Story", url: "4.png", downloadUrl: "4.png"
        }

            ,
        {
            id: 9, category: 'story', title: "Story 05", type: "Story", url: "5.png", downloadUrl: "5.png"
        }

            ,
        {
            id: 10, category: 'story', title: "Story 06", type: "Story", url: "6.png", downloadUrl: "6.png"
        }

        ];

        let selectedIds = [];
        let currentCategory = 'brandbook';

        let isDownloading = false;
        let currentTip = 0;
        const basePrice = 50;

        // Elementos DOM
        let gridContainer,
            btnSelectAll,
            checkboxAll,
            textSelectAll,
            selectionCount,
            btnAction;
        let tabFeed,
            tabStory;
        let fullscreenCheckout,
            checkWrapper,
            btnFinalPay;
        let stepSummary,
            stepTip,
            stepPix;

        // Story Viewer Elements
        let storyViewer,
            storyImage,
            storyProgressContainer,
            storySelectedIndicator,
            btnStorySelect,
            storyCounter;
        let storyInterval;
        let currentStoryIndex = 0;
        let activeStoryList = [];

        // --- INICIALIZAÇÃO ---
        async function loadPDF() {
            try {
                const loadingTask = pdfjsLib.getDocument(PDF_URL);
                pdfDoc = await loadingTask.promise;
                document.getElementById('pdf-loader-status').classList.add('opacity-0');
                setTimeout(() => document.getElementById('pdf-loader-status').classList.add('hidden'), 500);
                renderAllPages();
            }

            catch (error) {
                console.error('PDF JS ERRO:', error);
                document.getElementById('pdf-loader-status').innerHTML = ` <p class="text-red-500 font-bold">Erro ao carregar PDF.</p><p class="text-xs text-slate-400 mt-2">Verifique se o link do Drive está público.</p>`;
            }
        }

        async function renderAllPages() {
            const container = document.getElementById('pdf-pages-container');
            container.innerHTML = '';

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'pdf-page-wrapper';

                wrapper.id = `page-wrapper-${i}`;

                const canvas = document.createElement('canvas');
                wrapper.appendChild(canvas);

                // Overlay de edição
                const overlay = document.createElement('div');
                overlay.className = 'pdf-edit-overlay';
                overlay.onclick = (e) => handlePageClick(e, i, wrapper);
                wrapper.appendChild(overlay);

                container.appendChild(wrapper);
                await renderPage(i, canvas);
                renderMarkers(i);
            }

            if (window.lucide) window.lucide.createIcons();
        }

        async function renderPage(num, canvas) {
            const page = await pdfDoc.getPage(num);
            const container = document.getElementById('pdf-pages-container');
            const padding = window.innerWidth < 768 ? 32 : 64;
            const availableWidth = container.clientWidth - padding;

            const unscaledViewport = page.getViewport({
                scale: 1.0
            });
            const fitScale = availableWidth / unscaledViewport.width;
            const scale = fitScale * pdfScale;

            const viewport = page.getViewport({
                scale: scale
            });
            const context = canvas.getContext('2d');

            // Suporte para telas de alta densidade (Retina)
            const dpr = window.devicePixelRatio || 1;
            canvas.width = viewport.width * dpr;
            canvas.height = viewport.height * dpr;
            canvas.style.width = viewport.width + 'px';
            canvas.style.height = viewport.height + 'px';

            context.scale(dpr, dpr);

            await page.render({
                canvasContext: context, viewport: viewport
            }).promise;
        }

        // --- MODOS E CATEGORIAS ---
        window.setCategory = function (cat) {
            currentCategory = cat;
            const tabs = ['brandbook',
                'feed',
                'story'];

            tabs.forEach(t => {
                const el = document.getElementById(`tab-${t}`);

                if (t === cat) {
                    el.classList.add('text-red-700', 'border-red-700');
                    el.classList.remove('text-slate-500', 'border-transparent');
                }

                else {
                    el.classList.remove('text-red-700', 'border-red-700');
                    el.classList.add('text-slate-500', 'border-transparent');
                }
            });

            document.getElementById('pdf-viewer-container').classList.toggle('hidden', cat !== 'brandbook');
            document.getElementById('original-toolbar').classList.toggle('hidden', cat === 'brandbook');
            document.getElementById('designs-grid').classList.toggle('hidden', cat === 'brandbook');

            // --- Toggle Footer Buttons ---
            const btnAction = document.getElementById('btn-action');
            if (btnAction) btnAction.classList.toggle('hidden', cat === 'brandbook');

            const btnPayment = document.getElementById('btn-payment');
            if (btnPayment) btnPayment.classList.toggle('hidden', cat !== 'brandbook');

            if (cat === 'brandbook') {
                if (storyViewer) storyViewer.classList.add('hidden');
                if (!pdfDoc) loadPDF();
            }
            else if (cat === 'feed') {
                if (storyViewer) storyViewer.classList.add('hidden');
                document.getElementById('designs-grid').classList.remove('hidden');
                renderGrid();
            }
            else if (cat === 'story') {
                document.getElementById('designs-grid').classList.add('hidden');
                openStoryViewer();
            }
        }

            ;

        window.toggleEditMode = function () {
            isEditMode = !isEditMode;
            document.getElementById('pdf-viewer-container').classList.toggle('edit-mode-active', isEditMode);
            document.getElementById('edit-status-badge').classList.toggle('hidden', !isEditMode);
            const btn = document.getElementById('btn-toggle-edit');
            btn.classList.toggle('bg-red-50', isEditMode);
            btn.classList.toggle('border-red-200', isEditMode);
            btn.querySelector('span') && (btn.querySelector('span').innerText = isEditMode ? 'Sair da Edição' : 'Modo Edição');

            if (isEditMode) {
                alert("Modo Edição Ativado: Clique em qualquer lugar do PDF para adicionar um marcador.");
            }
        }

            ;

        // --- LÓGICA DE MARCADORES ---
        function handlePageClick(e, pageNum, wrapper) {
            if (!isEditMode) return;

            const rect = wrapper.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;

            pendingMarkerCoords = {
                page: pageNum, x, y
            }

                ;
            openCreateModal();
        }

        function renderMarkers(pageNum) {
            const wrapper = document.getElementById(`page-wrapper-${pageNum}`);
            // Limpa marcadores existentes desta página
            wrapper.querySelectorAll('.pdf-marker').forEach(m => m.remove());

            const pageMarkers = markers.filter(m => m.page === pageNum);

            pageMarkers.forEach(m => {
                const markerEl = document.createElement('div');
                markerEl.className = 'pdf-marker';

                markerEl.style.left = `${m.x}%`;

                markerEl.style.top = `${m.y}%`;
                const iconType = m.type === 'text' ? 'type' : 'info';
                markerEl.innerHTML = `<i data-lucide="${iconType}" class="w-4 h-4" ></i>`;

                const tooltip = document.createElement('div');
                tooltip.className = 'marker-tooltip';

                tooltip.innerHTML = `<p class="font-bold text-xs" >${m.name}</p><p class="text-[9px] opacity-60" >Clique para ver mais</p>`;
                markerEl.appendChild(tooltip);

                markerEl.onclick = (e) => {
                    e.stopPropagation();

                    if (isEditMode) {
                        if (confirm(`Remover marcador "${m.name}"?`)) {
                            if (m.id) {
                                window.fs.deleteDoc(window.fs.doc(window.db, "briefing_livia_markers", m.id));
                            }
                        }
                    } else {
                        // Toggle persistent info instead of immediate modal
                        const existingInfo = wrapper.querySelector('.marker-info-popover');
                        if (existingInfo) existingInfo.remove();
                        const popover = document.createElement('div');
                        popover.className = 'marker-info-popover absolute z-50 bg-white p-4 rounded-xl shadow-2xl border border-slate-100 animate-in fade-in zoom-in duration-200';
                        popover.style.left = `${m.x}%`;
                        popover.style.top = `${m.y - 5}%`;
                        popover.style.transform = 'translate(-50%, -100%)';

                        if (m.type === 'text') {
                            popover.innerHTML = `
                                                                            <div class="flex flex-col gap-3 min-w-[160px]">
                                                                                <p class="text-[10px] font-black uppercase text-slate-400">Conteúdo para Copiar</p>
                                                                                <p class="text-sm font-bold text-slate-800 break-all bg-slate-50 p-2 rounded-lg border border-slate-100">${m.textContent || m.name}</p>
                                                                                <button onclick="event.stopPropagation(); copyTextToClipboard('${m.textContent || m.name}', this)" class="px-4 py-2 bg-slate-900 text-white text-xs font-bold rounded-lg hover:bg-slate-800 transition-colors flex items-center justify-center gap-2">
                                                                                    Copiar Texto <i data-lucide="copy" class="w-3 h-3"></i>
                                                                                </button>
                                                                            </div>
                                                                            <div class="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-full w-0 h-0 border-l-[8px] border-l-transparent border-r-[8px] border-r-transparent border-t-[8px] border-t-white"></div>
                                                                        `;
                        } else {
                            popover.innerHTML = `
                                                                            <div class="flex flex-col gap-3 min-w-[160px]">
                                                                                <p class="text-sm font-bold text-slate-800">${m.name}</p>
                                                                                <button onclick="event.stopPropagation(); showMarkerDetailsById('${m.name}')" class="px-4 py-2 bg-red-600 text-white text-xs font-bold rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center gap-2">
                                                                                    Ver Mais <i data-lucide="external-link" class="w-3 h-3"></i>
                                                                                </button>
                                                                            </div>
                                                                            <div class="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-full w-0 h-0 border-l-[8px] border-l-transparent border-r-[8px] border-r-transparent border-t-[8px] border-t-white"></div>
                                                                        `;
                        }

                        wrapper.appendChild(popover);
                        if (window.lucide) window.lucide.createIcons();

                        // Close on click elsewhere
                        const closeHandler = (ev) => {
                            if (!popover.contains(ev.target)) {
                                popover.remove();
                                document.removeEventListener('click', closeHandler);
                            }
                        };
                        setTimeout(() => document.addEventListener('click', closeHandler), 10);
                    }
                };

                wrapper.appendChild(markerEl);
            });
            if (window.lucide) window.lucide.createIcons();
        }
        async function downloadFile(url, filename) {
            if (!url) return;
            let finalUrl = url;

            // Converter links do Google Drive para links de conteúdo direto altamente eficientes
            if (url.includes('drive.google.com')) {
                const driveId = url.includes('id=') ? url.split('id=').pop().split('&')[0] : url.split('/d/')[1]?.split('/')[0];
                if (driveId) {
                    const isImage = filename && (filename.toLowerCase().endsWith('.png') || filename.toLowerCase().endsWith('.jpg') || filename.toLowerCase().endsWith('.jpeg') || filename.toLowerCase().endsWith('.svg'));

                    if (isImage) {
                        // O domínio lh3 é otimizado para entrega de imagem e costuma ignorar prompts de login se o arquivo for público
                        finalUrl = `https://lh3.googleusercontent.com/d/${driveId}`;
                    } else {
                        // confirm=t ajuda a evitar a tela de "arquivo grande" para downloads automáticos
                        finalUrl = `https://drive.google.com/uc?export=download&id=${driveId}&confirm=t`;
                    }
                }
            }

            // Fallback robusto via Iframe invisível (Garante que o usuário não saia da página mesmo se o Drive pedir login/confirmação)
            const triggerIframeDownload = (dUrl) => {
                const iframeId = 'hidden-download-iframe';
                let iframe = document.getElementById(iframeId);
                if (!iframe) {
                    iframe = document.createElement('iframe');
                    iframe.id = iframeId;
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                }
                iframe.src = dUrl;
            };

            try {
                // Tentativa via Fetch/Blob (Funciona se o CORS permitir ou for mesma origem)
                const response = await fetch(finalUrl, { mode: 'cors' });
                if (!response.ok) throw new Error('CORS fail');

                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = blobUrl;
                a.download = filename || 'download';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(blobUrl);
                }, 100);
            } catch (error) {
                console.warn("Download via fetch falhou (CORS), disparando via Iframe silencioso:", error);
                // Via Iframe é o método mais eficiente para disparar downloads do Drive sem abrir novas abas ou redirecionar
                triggerIframeDownload(finalUrl);
            }
        }

        function showMarkerDetails(marker) {
            document.getElementById('modal-marker-title').innerText = marker.name;

            // Thumbnail Logic (Prefers PNG, then others)
            const primaryLink = marker.links?.png || marker.links?.pdf || marker.links?.svg || marker.driveUrl;
            const driveId = primaryLink?.includes('id=') ? primaryLink.split('id=').pop().split('&')[0] : primaryLink?.split('/d/')[1]?.split('/')[0];

            const thumbImg = document.getElementById('modal-marker-thumb');
            const fallbackIcon = document.getElementById('modal-marker-icon-fallback');

            if (driveId) {
                thumbImg.src = `https://drive.google.com/thumbnail?id=${driveId}&sz=w400`;
                thumbImg.classList.remove('hidden');
                fallbackIcon.classList.add('hidden');
                thumbImg.onerror = () => {
                    thumbImg.classList.add('hidden');
                    fallbackIcon.classList.remove('hidden');
                };
            } else {
                thumbImg.classList.add('hidden');
                fallbackIcon.classList.remove('hidden');
            }

            // Download Buttons Logic
            const container = document.getElementById('download-options-container');
            container.innerHTML = '';

            const links = marker.links || { png: marker.driveUrl }; // Fallback para marcadores antigos

            Object.entries(links).forEach(([format, url]) => {
                if (!url) return;

                const btn = document.createElement('button');
                btn.className = "w-full py-4 bg-slate-900 hover:bg-slate-800 text-white rounded-2xl font-bold flex items-center justify-center gap-3 transition-all";
                const label = format.toUpperCase();
                btn.innerHTML = `<i data-lucide="download" class="w-5 h-5"></i> Baixar em ${label}`;

                const safeName = marker.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                const filename = `${safeName}.${format}`;

                btn.onclick = () => downloadFile(url, filename);
                container.appendChild(btn);
            });

            if (window.lucide) window.lucide.createIcons();
            document.getElementById('marker-detail-modal').classList.remove('hidden');
        }

        window.copyTextToClipboard = function (text, btn) {
            navigator.clipboard.writeText(text);
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `Copiado! <i data-lucide="check" class="w-3 h-3"></i>`;
            btn.classList.add('bg-emerald-600');
            btn.classList.remove('bg-slate-900');
            if (window.lucide) window.lucide.createIcons();

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('bg-emerald-600');
                btn.classList.add('bg-slate-900');
                if (window.lucide) window.lucide.createIcons();
            }, 2000);
        };

        window.showMarkerDetailsById = function (name) {
            const m = markers.find(item => item.name === name);
            if (m) showMarkerDetails(m);
        };

        window.closeMarkerModal = () => document.getElementById('marker-detail-modal').classList.add('hidden');

        // --- CRUD Marcadores ---
        function openCreateModal() {
            document.getElementById('marker-create-modal').classList.remove('hidden');
            document.getElementById('input-marker-name').focus();
        }

        window.closeCreateModal = () => document.getElementById('marker-create-modal').classList.add('hidden');

        window.setMarkerType = function (type) {
            currentMarkerType = type;
            const btnFile = document.getElementById('type-btn-file');
            const btnText = document.getElementById('type-btn-text');
            const fieldsFile = document.getElementById('fields-file');
            const fieldsText = document.getElementById('fields-text');

            if (type === 'file') {
                btnFile.classList.add('bg-white', 'text-slate-800', 'shadow-sm');
                btnFile.classList.remove('text-slate-500');
                btnText.classList.remove('bg-white', 'text-slate-800', 'shadow-sm');
                btnText.classList.add('text-slate-500');
                fieldsFile.classList.remove('hidden');
                fieldsText.classList.add('hidden');
            } else {
                btnText.classList.add('bg-white', 'text-slate-800', 'shadow-sm');
                btnText.classList.remove('text-slate-500');
                btnFile.classList.remove('bg-white', 'text-slate-800', 'shadow-sm');
                btnFile.classList.add('text-slate-500');
                fieldsText.classList.remove('hidden');
                fieldsFile.classList.add('hidden');
            }
        };

        window.saveNewMarker = function () {
            const name = document.getElementById('input-marker-name').value;

            if (!name) {
                alert("Preencha o nome!");
                return;
            }

            let newMarker = {
                ...pendingMarkerCoords,
                name: name,
                type: currentMarkerType
            };

            if (currentMarkerType === 'file') {
                const linkPng = document.getElementById('input-marker-link-png').value;
                const linkPdf = document.getElementById('input-marker-link-pdf').value;
                const linkSvg = document.getElementById('input-marker-link-svg').value;
                const linkDocx = document.getElementById('input-marker-link-docx').value;

                if (!linkPng && !linkPdf && !linkSvg && !linkDocx) {
                    alert("Preencha ao menos um link!");
                    return;
                }

                newMarker.links = { png: linkPng, pdf: linkPdf, svg: linkSvg, docx: linkDocx };
            } else {
                const text = document.getElementById('input-marker-text').value;
                if (!text) {
                    alert("Preencha o conteúdo do texto!");
                    return;
                }
                newMarker.textContent = text;
            }

            window.fs.addDoc(window.fs.collection(window.db, "briefing_livia_markers"), newMarker);
            closeCreateModal();

            // Reset fields
            document.getElementById('input-marker-name').value = '';
            document.getElementById('input-marker-link-png').value = '';
            document.getElementById('input-marker-link-pdf').value = '';
            document.getElementById('input-marker-link-svg').value = '';
            document.getElementById('input-marker-link-docx').value = '';
            document.getElementById('input-marker-text').value = '';
            setMarkerType('file');
        }

        // --- ZOOM & NAV ---
        window.zoomIn = () => {
            pdfScale += 0.2;
            renderAllPages();
            updateZoomUI();
        }

            ;

        window.zoomOut = () => {
            if (pdfScale > 0.6) {
                pdfScale -= 0.2;
                renderAllPages();
                updateZoomUI();
            }
        }

            ;

        function updateZoomUI() {
            document.getElementById('zoom-percent').innerText = `${Math.round(pdfScale * 100)}%`;
        }

        window.scrollToTop = () => document.getElementById('pdf-pages-container').scrollTo({
            top: 0, behavior: 'smooth'
        });

        // --- GRID ORIGINAL (Fallback logic) ---
        function renderGrid() {
            const grid = document.getElementById('designs-grid');
            const filtered = designs.filter(d => d.category === currentCategory);
            grid.innerHTML = filtered.map(d => ` <div onclick="toggleSelection(${d.id})"
                class="group relative cursor-pointer bg-slate-100 aspect-[3/4] overflow-hidden"

                > <img src="${d.url}" alt="${d.title}" class="w-full h-full object-cover transition-opacity hover:opacity-90" > <!-- Overlay de Seleção --> <div class="absolute inset-0 bg-black/40 flex items-center justify-center transition-all duration-200 ${selectedIds.includes(d.id) ? 'opacity-100' : 'opacity-0'}" > <i data-lucide="check" class="text-white w-8 h-8 drop-shadow-md" ></i> </div> <!-- Check icon canto superior --> $ {
                    selectedIds.includes(d.id) ? '<div class="absolute top-2 right-2 bg-red-600 w-3 h-3 rounded-full border border-white"></div>' : ''
                }

                </div> `).join('');
            if (window.lucide) window.lucide.createIcons();
        }

        // --- Lógica de Seleção ---
        window.toggleSelection = function (id) {
            if (isDownloading) return;

            if (selectedIds.includes(id)) {
                selectedIds = selectedIds.filter(itemId => itemId !== id);
            }

            else {
                selectedIds.push(id);
            }

            // Apenas re-renderiza se estiver no feed, senao é o story viewer lidando
            if (currentCategory === 'feed') renderGrid();
            else updateStoryUI();

            updateUI();
        }

            ;

        function handleSelectAll() {
            if (isDownloading) return;
            const items = designs.filter(d => d.category === currentCategory);
            const currentIds = items.map(d => d.id);
            const allSelected = currentIds.every(id => selectedIds.includes(id));

            if (allSelected) {
                selectedIds = selectedIds.filter(id => !currentIds.includes(id));
            }

            else {
                currentIds.forEach(id => {
                    if (!selectedIds.includes(id)) selectedIds.push(id);
                });
            }

            if (currentCategory === 'feed') renderGrid();
            else updateStoryUI(); // Atualiza botão do viewer

            updateUI();
        }

        // --- STORY VIEWER LOGIC ---

        function openStoryViewer() {
            activeStoryList = designs.filter(d => d.category === 'story');
            if (activeStoryList.length === 0) return;

            currentStoryIndex = 0;
            storyViewer.classList.remove('hidden');
            storyViewer.classList.add('flex');

            loadStory(0);
            resetTimer();
        }

        window.closeStoryViewer = function () {
            setCategory('feed');
            clearInterval(storyInterval);
        }

        function loadStory(index, direction = 'next') {
            if (index < 0) index = 0;

            if (index >= activeStoryList.length) {
                index = 0;
            }

            currentStoryIndex = index;
            const story = activeStoryList[index];

            // Remove previous animations
            storyImage.classList.remove('animate-story-next', 'animate-story-prev');
            void storyImage.offsetWidth; // Trigger reflow

            // Apply Animation
            if (direction === 'next') {
                storyImage.classList.add('animate-story-next');
            }

            else {
                storyImage.classList.add('animate-story-prev');
            }

            // Update Image
            storyImage.src = story.url;
            storyImage.style.opacity = '1';

            // Update Counter
            storyCounter.innerText = `${index + 1}/${activeStoryList.length}`;

            updateStoryUI();
            renderProgressBars();
        }

        function resetTimer() {
            clearInterval(storyInterval);

            storyInterval = setInterval(() => {
                nextStory();
            }

                , 5000); // 5 segundos por story
        }

        window.nextStory = function () {
            if (currentStoryIndex < activeStoryList.length - 1) {
                loadStory(currentStoryIndex + 1, 'next');
                resetTimer();
            }

            else {
                loadStory(0, 'next');
                resetTimer();
            }
        }

        window.prevStory = function () {
            if (currentStoryIndex > 0) {
                loadStory(currentStoryIndex - 1, 'prev');
                resetTimer();
            }

            else {
                loadStory(activeStoryList.length - 1, 'prev');
                resetTimer();
            }
        }

        window.toggleCurrentStory = function () {
            const story = activeStoryList[currentStoryIndex];
            toggleSelection(story.id);
        }

        function updateStoryUI() {
            const story = activeStoryList[currentStoryIndex];
            if (!story) return;

            const isSelected = selectedIds.includes(story.id);
            const btnIcon = document.getElementById('story-btn-check-icon');
            const btnSpan = btnStorySelect.querySelector('span');

            if (isSelected) {
                storySelectedIndicator.classList.remove('hidden');
                btnStorySelect.classList.remove('bg-white', 'text-slate-900', 'border-white');
                btnStorySelect.classList.add('bg-red-600', 'text-white', 'border-red-600');
                btnSpan.innerText = "Selecionado";

                if (btnIcon) {
                    btnIcon.classList.remove('border-slate-300');
                    btnIcon.classList.add('border-white', 'bg-white/20');
                    const i = btnIcon.querySelector('i');
                    if (i) i.classList.remove('opacity-0');
                }
            }

            else {
                storySelectedIndicator.classList.add('hidden');
                btnStorySelect.classList.add('bg-white', 'text-slate-900', 'border-white');
                btnStorySelect.classList.remove('bg-red-600', 'text-white', 'border-red-600');
                btnSpan.innerText = "Selecionar para Baixar";

                if (btnIcon) {
                    btnIcon.classList.add('border-slate-300');
                    btnIcon.classList.remove('border-white', 'bg-white/20');
                    const i = btnIcon.querySelector('i');
                    if (i) i.classList.add('opacity-0');
                }
            }
        }

        function renderProgressBars() {
            storyProgressContainer.innerHTML = activeStoryList.map((_, idx) => {
                let bgClass = "bg-white/30";
                if (idx < currentStoryIndex) bgClass = "bg-white";
                if (idx === currentStoryIndex) bgClass = "bg-red-500 animate-pulse";

                return `<div class="h-1 flex-1 rounded-full overflow-hidden ${bgClass} transition-colors duration-300" ></div>`;
            }).join('');
        }

        // --- Atualização da UI ---
        function updateUI() {
            if (selectionCount) selectionCount.innerText = `${selectedIds.length} selecionados (Total)`;

            const currentIds = designs.filter(d => d.category === currentCategory).map(d => d.id);
            const hasItems = currentIds.length > 0;
            const allCurrentSelected = hasItems && currentIds.every(id => selectedIds.includes(id));

            if (checkboxAll && checkWrapper) {
                if (allCurrentSelected) {
                    checkboxAll.classList.add('bg-slate-900', 'border-slate-900');
                    checkboxAll.classList.remove('border-slate-300');
                    checkWrapper.classList.remove('opacity-0');
                    textSelectAll.innerText = "Desmarcar esta seção";
                }

                else {
                    checkboxAll.classList.remove('bg-slate-900', 'border-slate-900');
                    checkboxAll.classList.add('border-slate-300');
                    checkWrapper.classList.add('opacity-0');
                    textSelectAll.innerText = "Selecionar todos desta seção";
                }
            }

            if (btnAction) {
                if (selectedIds.length > 0) {
                    btnAction.disabled = false;
                    btnAction.classList.remove('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                    btnAction.classList.add('bg-slate-900', 'text-white', 'hover:bg-slate-800', 'hover:shadow-2xl', 'hover:-translate-y-1', 'cursor-pointer');

                    const countText = selectedIds.length === 1 ? 'arquivo' : 'arquivos';

                    btnAction.innerHTML = `<i data-lucide="download" class="w-4 h-4"></i><span>Baixar ${selectedIds.length} ${countText}</span>`;
                }

                else {
                    btnAction.disabled = true;
                    btnAction.classList.add('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                    btnAction.classList.remove('bg-slate-900', 'text-white', 'hover:bg-slate-800', 'hover:shadow-2xl', 'hover:-translate-y-1', 'cursor-pointer');
                    btnAction.innerHTML = `<i data-lucide="download" class="w-4 h-4"></i><span>Selecione itens para baixar</span>`;
                }
            }

            if (window.lucide) window.lucide.createIcons();
        }

        // --- FLUXO DE DOWNLOAD E PAGAMENTO ---

        async function handleAction(e) {
            if (e && e.preventDefault) e.preventDefault();

            if (selectedIds.length === 0 || isDownloading) return;

            isDownloading = true;

            // Estado de Loading
            btnAction.innerHTML = ` <div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin-custom"></div><span>Iniciando Download...</span>`;

            // 1. Download
            for (const id of selectedIds) {
                const design = designs.find(d => d.id === id);

                if (design) {
                    const url = design.downloadUrl || design.url;
                    const filename = `Design-Livia-${design.title.replace(/\s+/g, '-')}.png`;

                    await downloadFile(url, filename);
                    await new Promise(r => setTimeout(r, 800));
                }
            }

            // 2. Abrir Tela de Checkout (Step 1) SE NÃO PAGO
            const hasPaid = localStorage.getItem('hasPaidDesignsLivia') === 'true';

            setTimeout(() => {
                isDownloading = false;

                if (!hasPaid) {
                    fullscreenCheckout.classList.remove('hidden');
                }

                else {
                    // Feedback visual se já pago (opcional, ou apenas reseta UI)
                    updateUI();
                }
            }

                , 800);
        }

        // --- Navegação entre Steps do Checkout ---

        window.goToStep2 = function () {
            stepSummary.classList.add('hidden');
            stepTip.classList.remove('hidden');
            stepTip.classList.add('flex'); // Precisa ser flex para centralizar

            // Focar no input de gorjeta automaticamente
            setTimeout(() => {
                const input = document.getElementById('tip-input');
                if (input) input.focus();
            }

                , 100);
        }

        // --- Lógica de Gorjeta ---

        window.updateTotal = function (val) {
            const tip = parseFloat(val);

            if (!isNaN(tip) && tip >= 0) {
                currentTip = tip;
            }

            else {
                currentTip = 0;
            }

            if (btnAction) {
                const total = basePrice + currentTip;
                if (btnFinalPay) {
                    btnFinalPay.innerHTML = `<span>Pagar R$ ${total.toFixed(2).replace('.', ',')}</span><i data-lucide="check" class="w-5 h-5"></i>`;
                }
            }
        }

            ;

        window.skipTip = function () {
            currentTip = 0;
            finalizePayment();
        }

        // --- FLUXO DE PAGAMENTO REAL ELETRO/PIX ---
        let pollInterval = null;

        window.finalizePayment = async function () {
            if (btnFinalPay) {
                btnFinalPay.disabled = true;
                btnFinalPay.innerHTML = ` <div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin-custom"></div><span>Gerando Pix ELETRO...</span>`;
            }

            try {

                // 1. Gera ID único para o Pedido
                const orderId = `Briefing_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
                const totalAmount = basePrice + currentTip;

                // 2. Chama Backend (ELETRO)
                const response = await fetch("https://us-central1-super-app25.cloudfunctions.net/createPayment", {

                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    }

                    ,
                    body: JSON.stringify({
                        account: "default", // Alterado para default conforme pedido

                        orderId: orderId,
                        payment_data: {

                            transaction_amount: totalAmount,
                            payment_method_id: "pix",
                            description: "Pacote Design - Lívia",
                            payer: {
                                email: "livia.designs@eletro.com", // Placeholder interno
                                first_name: "Lívia",
                                last_name: "Cliente"
                            }
                        }
                    })
                });

                if (!response.ok) {
                    const errPath = await response.json();
                    throw new Error(errPath.message || "Erro na geração do Pix");
                }

                const data = await response.json();

                // 3. Extrai Dados do Pix
                const qrCodeBase64 = data.point_of_interaction.transaction_data.qr_code_base64;
                const qrCodeCopy = data.point_of_interaction.transaction_data.qr_code;

                // 4. Mostra Interface Pix
                showPixUI(qrCodeBase64, qrCodeCopy, orderId);

            }

            catch (error) {
                console.error(error);
                alert("Erro ao criar pagamento: " + error.message);

                if (btnFinalPay) {
                    btnFinalPay.disabled = false;
                    btnFinalPay.innerHTML = `<span>Tentar Novamente</span><i data-lucide="refresh-cw" class="w-5 h-5"></i>`;
                }
            }
        }

            ;

        function showPixUI(base64, copyCode, orderId) {
            stepTip.classList.add('hidden');
            stepTip.classList.remove('flex');

            stepPix.classList.remove('hidden');
            stepPix.classList.add('flex');

            const img = document.getElementById('pix-qrcode-img');
            const loader = document.getElementById('pix-loader');
            const input = document.getElementById('pix-copypaste');

            if (img) {
                img.src = `data:image/png;base64,${base64}`;

                img.onload = () => {
                    if (loader) loader.classList.add('hidden');
                }

                    ;
            }

            if (input) input.value = copyCode;

            // Inicia Polling
            startPolling(orderId);
            if (window.lucide) window.lucide.createIcons();
        }

        window.copyPixCode = function () {
            const input = document.getElementById('pix-copypaste');

            if (input) {
                input.select();
                input.setSelectionRange(0, 99999);
                navigator.clipboard.writeText(input.value);
                alert("Código Pix copiado!");
            }
        }

        function startPolling(orderId) {
            if (pollInterval) clearInterval(pollInterval);

            pollInterval = setInterval(async () => {
                try {
                    const res = await fetch(`https: //us-central1-super-app25.cloudfunctions.net/checkPaymentStatus?orderId=${orderId}`);
                    const data = await res.json();

                    if (data.status === 'approved') {
                        clearInterval(pollInterval);
                        handlePaymentSuccess();
                    }
                }

                catch (e) {
                    console.error("Polling error", e);
                }
            }

                , 4000); // Checa a cada 4s
        }

        function handlePaymentSuccess() {
            const statusBox = document.getElementById('status-icon-container');
            const statusText = document.getElementById('status-text');
            const spinner = document.getElementById('status-spinner');
            const check = document.getElementById('status-check');
            const btnFinish = document.getElementById('btn-finish-process');

            if (statusBox) {
                statusBox.classList.remove('bg-slate-200');
                statusBox.classList.add('bg-emerald-500', 'text-white', 'shadow-lg', 'shadow-emerald-200');
            }

            if (spinner) spinner.classList.add('hidden');
            if (check) check.classList.remove('hidden');

            if (statusText) {
                statusText.innerText = "Pagamento Confirmado!";
                statusText.classList.add('text-emerald-600');
            }

            if (btnFinish) {
                btnFinish.classList.remove('hidden');
                // Trigger reflow for animation
                void btnFinish.offsetWidth;
                btnFinish.classList.remove('opacity-0', 'slide-up'); // Se existisse a classe slide-up antes
                btnFinish.classList.add('animate-in', 'fade-in', 'slide-in-from-bottom-4');
                btnFinish.style.opacity = '1';
            }

            // Persistir Pagamento
            localStorage.setItem('hasPaidDesignsLivia', 'true');
        }

        window.closeCheckout = function () {
            const checkout = document.getElementById('fullscreen-checkout');
            if (checkout) checkout.classList.add('hidden');
            // Resetar UI se necessário ou recarregar
            alert("Obrigado! Seus arquivos foram liberados definitivamente.");
            window.location.reload();
        }

        window.openPixPayment = function () {
            const checkout = document.getElementById('fullscreen-checkout');
            if (checkout) checkout.classList.remove('hidden');

            // Esconde todos os containers
            const steps = ['step-summary', 'step-tip', 'step-pix', 'step-pix-static', 'step-loading-pix'];
            steps.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            // Mostra o Loading primeiro
            const loadingStep = document.getElementById('step-loading-pix');
            if (loadingStep) {
                loadingStep.classList.remove('hidden');
                loadingStep.classList.add('flex');
                if (window.lucide) window.lucide.createIcons();
            }

            // Simula geração do Pix (1.5 segundos)
            setTimeout(() => {
                if (loadingStep) {
                    loadingStep.classList.remove('flex');
                    loadingStep.classList.add('hidden');
                }

                const staticPix = document.getElementById('step-pix-static');
                const pixCode = document.getElementById('static-pix-value').value;
                const qrImg = document.getElementById('static-pix-qrcode');

                if (qrImg && pixCode) {
                    qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(pixCode)}`;
                }

                if (staticPix) {
                    staticPix.classList.remove('hidden');
                    staticPix.classList.add('flex');
                    if (window.lucide) window.lucide.createIcons();
                }
            }, 1500);
        };

        window.copyStaticPix = function () {
            const pixCode = document.getElementById('static-pix-value').value;
            if (pixCode === 'COLE_O_CODIGO_PIX_ESTATICO_AQUI') {
                alert("O código Pix ainda não foi configurado.");
                return;
            }
            navigator.clipboard.writeText(pixCode);
            alert("Código Pix copiado com sucesso!");
        };

        // --- Inicialização ---
        function init() {
            gridContainer = document.getElementById('designs-grid');
            btnSelectAll = document.getElementById('btn-select-all');
            checkboxAll = document.getElementById('checkbox-all');
            textSelectAll = document.getElementById('text-select-all');
            selectionCount = document.getElementById('selection-count');
            btnAction = document.getElementById('btn-action');
            checkWrapper = document.getElementById('check-wrapper');

            tabFeed = document.getElementById('tab-feed');
            tabStory = document.getElementById('tab-story');

            fullscreenCheckout = document.getElementById('fullscreen-checkout');
            stepSummary = document.getElementById('step-summary');
            stepTip = document.getElementById('step-tip');
            stepPix = document.getElementById('step-pix');
            btnFinalPay = document.getElementById('btn-final-pay');

            storyViewer = document.getElementById('story-viewer');
            storyImage = document.getElementById('story-image');
            storyProgressContainer = document.getElementById('story-progress-container');
            storySelectedIndicator = document.getElementById('story-selected-indicator');
            btnStorySelect = document.getElementById('btn-story-select');
            storyCounter = document.getElementById('story-counter');

            // Listeners
            if (btnSelectAll) btnSelectAll.addEventListener('click', handleSelectAll);
            if (btnAction) btnAction.addEventListener('click', handleAction);

            // Iniciar na aba brandbook
            setCategory('brandbook');
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>

</html>