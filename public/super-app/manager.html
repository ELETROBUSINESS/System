<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1554/1554591.png">
    <title>Gerenciador | Dtudo</title>

    <!-- Fontes e Ícones -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <!-- Scanner Barcode -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

    <style>
        :root {
            --color-primary: #db0038; /* Vermelho Dtudo */
            --color-primary-dark: #b71c1c;
            --color-bg: #f5f5f5;
            --color-white: #ffffff;
            --color-text: #333333;
            --color-text-light: #666666;
            --color-border: #e0e0e0;
            --color-offer: #7c3aed; /* Roxo Oferta */
            --color-mp-blue: #009ee3; /* Azul Mercado Pago */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }

        body { background-color: var(--color-bg); padding-bottom: 90px; color: var(--color-text); }

        /* --- LOGIN OVERLAY (BLOQUEIO) --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center;
        }
        
        .login-card {
            background: white; padding: 40px 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 400px; width: 100%;
        }
        
        .login-logo { width: 80px; margin-bottom: 20px; border-radius: 10px; }
        
        .google-btn {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 30px;
            background: white; color: #555; font-weight: 500; font-size: 1rem;
            cursor: pointer; transition: all 0.2s; margin-top: 20px;
        }
        .google-btn:hover { background: #f8f9fa; border-color: #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .google-btn i { font-size: 1.4rem; color: #db0038; }

        /* CONTEÚDO PRINCIPAL (Oculto até login) */
        #app-content { display: none; }

        /* HEADER */
        .admin-header {
            background: var(--color-primary);
            color: white;
            padding: 20px 20px 60px 20px;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: var(--shadow-md);
            position: relative;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .btn-icon-header {
            background: rgba(255,255,255,0.2); border-radius: 50%; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center; color: white; text-decoration: none;
            backdrop-filter: blur(4px); transition: 0.2s; cursor: pointer; border: none;
        }
        .btn-icon-header:hover { background: rgba(255,255,255,0.3); }

        .header-title h1 { font-size: 1.2rem; font-weight: 700; }
        .header-title span { font-size: 0.8rem; opacity: 0.9; font-weight: 400; }

        /* DASHBOARD OFERTAS (Chamativo) */
        .offer-dashboard {
            background: linear-gradient(135deg, #7c3aed 0%, #4c1d95 100%);
            color: white;
            border-radius: var(--radius);
            margin: -40px 20px 20px 20px;
            padding: 15px;
            position: relative;
            z-index: 10;
            box-shadow: 0 8px 20px rgba(124, 58, 237, 0.3);
            display: flex; flex-direction: column; gap: 10px;
        }

        .offer-dash-row { display: flex; justify-content: space-between; align-items: center; }
        .offer-dash-label { font-size: 0.8rem; opacity: 0.9; }
        .offer-dash-value { font-size: 1.5rem; font-weight: 900; letter-spacing: -0.5px; }
        
        .btn-reset-offers {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .btn-reset-offers:hover { background: rgba(255, 255, 255, 0.3); }

        /* SEARCH BAR */
        .search-container { margin: 0 20px 20px 20px; }
        .search-box {
            background: white; border-radius: var(--radius); height: 50px;
            display: flex; align-items: center; padding: 0 15px;
            box-shadow: var(--shadow-sm); border: 1px solid var(--color-border);
        }
        .search-box i { color: #999; font-size: 1.2rem; margin-right: 10px; }
        .search-box input {
            border: none; outline: none; width: 100%; font-size: 0.95rem; color: var(--color-text);
        }

        /* PRODUCT LIST */
        .product-list { padding: 0 20px; display: grid; gap: 12px; }

        .prod-item {
            background: white; border-radius: var(--radius); padding: 12px;
            display: flex; gap: 12px; align-items: center;
            box-shadow: var(--shadow-sm); transition: transform 0.2s;
            cursor: pointer; border: 1px solid transparent; position: relative;
        }
        .prod-item:active { transform: scale(0.98); }

        .prod-thumb {
            width: 70px; height: 70px; border-radius: 8px; background: #eee;
            object-fit: cover; flex-shrink: 0;
        }
        
        .prod-info { flex: 1; min-width: 0; }
        .prod-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .prod-meta { font-size: 0.75rem; color: var(--color-text-light); display: flex; gap: 10px; margin-bottom: 4px; }
        
        .prod-prices { display: flex; align-items: baseline; gap: 8px; }
        .price-current { color: var(--color-primary); font-weight: 700; font-size: 1rem; }
        .price-old { color: #aaa; text-decoration: line-through; font-size: 0.8rem; }
        
        .stock-tag {
            font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #e0f2f1; color: #00695c; font-weight: 600;
        }
        .stock-tag.low { background: #ffebee; color: #c62828; }

        /* OFFER BUTTON IN LIST (Estilo FAB Mini) */
        .btn-quick-offer {
            width: 40px; height: 40px; border-radius: 50%; 
            background: white; color: var(--color-offer);
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.4rem; border: 1px solid #f3e8ff;
            cursor: pointer; transition: 0.2s; margin-left: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .btn-quick-offer:hover { background: #f3e8ff; transform: scale(1.05); }
        .btn-quick-offer.active { 
            background: var(--color-offer); color: white; 
            border-color: var(--color-offer);
            box-shadow: 0 4px 10px rgba(124, 58, 237, 0.4);
        }

        /* FAB ADD BUTTON */
        .fab {
            position: fixed; bottom: 20px; right: 20px;
            width: 60px; height: 60px; background: var(--color-primary); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 2rem; box-shadow: 0 4px 15px rgba(219, 0, 56, 0.4);
            cursor: pointer; z-index: 100; transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: flex; align-items: flex-end; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; backdrop-filter: blur(2px);
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        
        @media (min-width: 768px) {
            .modal-overlay { align-items: center; justify-content: center; }
            .modal-sheet { width: 500px !important; border-radius: 20px !important; height: auto !important; max-height: 90vh; }
            .admin-header { border-radius: 0 0 30px 30px; padding-bottom: 80px; }
            .offer-dashboard { max-width: 800px; margin: -50px auto 20px auto; }
            .search-container { max-width: 800px; margin: 0 auto 20px auto; }
            .product-list { max-width: 800px; margin: 0 auto; }
            .fab { right: calc(50% - 400px + 20px); }
        }

        .modal-sheet {
            background: white; width: 100%; border-top-left-radius: 25px; border-top-right-radius: 25px;
            padding: 25px; max-height: 95vh; overflow-y: auto; display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-overlay.open .modal-sheet { transform: translateY(0); }

        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sheet-title { font-size: 1.1rem; font-weight: 700; color: var(--color-text); }
        
        /* FORMS */
        .form-section { margin-bottom: 20px; border-bottom: 1px dashed #eee; padding-bottom: 15px; }
        .form-section:last-child { border-bottom: none; }
        .section-label { font-size: 0.8rem; font-weight: 700; color: var(--color-primary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 5px; font-weight: 500; }
        
        .input-wrapper { position: relative; }
        .input-wrapper input, .input-wrapper textarea, .input-wrapper select {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            font-size: 0.9rem; background: #fafafa; transition: border 0.2s;
        }
        .input-wrapper input:focus { border-color: var(--color-primary); background: white; outline: none; }
        
        /* SWITCH TOGGLE */
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--color-primary); }
        .slider.purple input:checked + .slider { background-color: var(--color-offer); }
        
        input:focus + .slider { box-shadow: 0 0 1px var(--color-primary); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        /* WEBSITE SECTION STYLES (NEW) */
        .mp-fee-box {
            background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 15px;
            margin-top: 10px; position: relative;
        }
        .mp-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; color: #0369a1; font-weight: 700; font-size: 0.9rem; }
        .mp-fee-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; color: #555; }
        .mp-total-fee { border-top: 1px dashed #bae6fd; padding-top: 8px; margin-top: 8px; font-weight: 700; color: #0284c7; display: flex; justify-content: space-between; }
        
        /* OFFER MODAL STYLES */
        .offer-prod-header { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 12px; }
        .offer-prod-thumb { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; background: #eee; }
        .offer-prod-info h3 { font-size: 1rem; margin-bottom: 5px; }
        .offer-prod-info p { color: #666; font-size: 0.9rem; }
        
        .offer-control-row { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed #eee; 
        }
        .offer-status-label { font-weight: 700; font-size: 0.9rem; }
        .status-on { color: var(--color-offer); }
        .status-off { color: #999; }

        .offer-input-container { transition: opacity 0.3s; }
        .offer-input-container.disabled { opacity: 0.5; pointer-events: none; }

        /* IMAGES UPLOAD */
        .images-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .img-slot {
            width: 80px; height: 80px; border-radius: 8px; border: 2px dashed #ccc;
            display: flex; align-items: center; justify-content: center;
            background: #fafafa; cursor: pointer; position: relative; flex-shrink: 0; overflow: hidden;
        }
        .img-slot img { width: 100%; height: 100%; object-fit: cover; }
        .img-slot i { font-size: 1.5rem; color: #ccc; }
        .img-slot .remove-btn {
            position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.5); color: white;
            border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px;
        }

        /* SCANNER */
        .scan-btn {
            position: absolute; right: 8px; top: 8px; bottom: 8px;
            background: #eef2ff; color: #4f46e5; border: none; padding: 0 10px;
            border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; font-weight: 600;
        }
        #scanner-viewport {
            width: 100%; height: 200px; background: black; margin-bottom: 15px;
            display: none; position: relative; border-radius: 8px; overflow: hidden;
        }
        #scanner-viewport video { width: 100%; height: 100%; object-fit: cover; }

        /* BUTTONS */
        .btn-primary {
            width: 100%; padding: 15px; background: var(--color-primary); color: white;
            border: none; border-radius: var(--radius); font-size: 1rem; font-weight: 700; cursor: pointer;
            box-shadow: 0 4px 10px rgba(219, 0, 56, 0.3);
        }
        .btn-save-offer {
            width: 100%; padding: 15px; background: var(--color-offer); color: white;
            border: none; border-radius: var(--radius); font-size: 1rem; font-weight: 700; cursor: pointer;
        }
        .btn-secondary {
            background: #f0f0f0; color: #333; padding: 12px; border-radius: var(--radius); border: none; font-weight: 600; cursor: pointer; flex: 1;
        }
        .btn-danger {
            background: #fee2e2; color: #ef4444; padding: 12px; border-radius: var(--radius); border: none; font-weight: 600; cursor: pointer; flex: 1;
        }
        
        /* PROFIT BOX */
        .profit-box {
            background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 10px;
            display: flex; justify-content: space-between; align-items: center; margin-top: -5px; margin-bottom: 15px;
        }
        .profit-val { font-weight: 700; color: #16a34a; }
        
        /* LOADER */
        .loader-container { text-align: center; padding: 40px; }
        .spinner {
            width: 30px; height: 30px; border: 3px solid #eee; border-top-color: var(--color-primary);
            border-radius: 50%; animation: spin 1s infinite linear; margin: 0 auto;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- TELA DE LOGIN (BLOQUEIO) -->
    <div id="login-overlay">
        <div class="login-card">
            <img src="https://cdn-icons-png.flaticon.com/512/1554/1554591.png" alt="Logo" class="login-logo">
            <h2 style="color: #333; margin-bottom: 10px;">Painel Admin</h2>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 30px;">Acesso restrito a administradores autorizados.</p>
            
            <button class="google-btn" onclick="loginWithGoogle()">
                <i class='bx bxl-google'></i>
                Entrar com Google
            </button>
            <p id="login-msg" style="color: #db0038; font-size: 0.8rem; margin-top: 15px; display: none;"></p>
        </div>
    </div>

    <!-- CONTEÚDO PRINCIPAL (Protegido) -->
    <div id="app-content">
        <!-- CABEÇALHO -->
        <div class="admin-header">
            <div class="header-top">
                <a href="conta.html" class="btn-icon-header"><i class='bx bx-chevron-left' style="font-size: 24px;"></i></a>
                
                <div class="header-title" style="text-align: right;">
                    <h1>Gerenciador</h1>
                    <span>Floralchic / Dtudo</span>
                </div>

                <button class="btn-icon-header" onclick="handleLogout()" title="Sair" style="margin-left: 10px;">
                    <i class='bx bx-log-out' style="font-size: 20px;"></i>
                </button>
            </div>
        </div>

        <!-- DASHBOARD DE OFERTAS (Calculadora) -->
        <div class="offer-dashboard">
            <!-- Row 1: Investimento em Descontos -->
            <div class="offer-dash-row" style="border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; margin-bottom: 10px;">
                <div>
                    <span class="offer-dash-label">Investimento em Descontos</span>
                    <div class="offer-dash-value" id="total-discount-value">R$ 0,00</div>
                </div>
                <div style="font-size: 2rem;"><i class='bx bxs-offer'></i></div>
            </div>
            
            <!-- Row 2: Receita Bruta (Novo) -->
            <div class="offer-dash-row">
                <div>
                    <span class="offer-dash-label">Receita Bruta Potencial (Estoque)</span>
                    <div class="offer-dash-value" id="total-revenue-value">R$ 0,00</div>
                </div>
                <div style="font-size: 2rem;"><i class='bx bx-money'></i></div>
            </div>

            <!-- Row 3: Controls -->
            <div class="offer-dash-row" style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px;">
                <span class="offer-dash-label" id="products-with-offer-count">0 produtos em oferta</span>
                <button class="btn-reset-offers" onclick="deactivateAllOffers()">
                    <i class='bx bx-trash'></i> Desativar Todas
                </button>
            </div>
        </div>

        <!-- BUSCA -->
        <div class="search-container">
            <div class="search-box">
                <i class='bx bx-search'></i>
                <input type="text" id="search-input" placeholder="Buscar por nome, SKU ou marca...">
            </div>
        </div>

        <!-- LISTA DE PRODUTOS -->
        <div id="products-list" class="product-list">
            <div class="loader-container"><div class="spinner"></div></div>
        </div>

        <!-- BOTÃO ADICIONAR -->
        <div class="fab" onclick="openModal()">
            <i class='bx bx-plus'></i>
        </div>
    </div>

    <!-- MODAL DE OFERTA RÁPIDA -->
    <div class="modal-overlay" id="offerModal">
        <div class="modal-sheet" style="height: auto;">
            <div class="sheet-header">
                <h2 class="sheet-title">Gerenciar Oferta</h2>
                <div onclick="closeOfferModal()" style="cursor: pointer; padding: 5px;"><i class='bx bx-x' style="font-size: 24px;"></i></div>
            </div>

            <div id="offer-modal-content">
                <div class="offer-prod-header">
                    <img id="quick-offer-img" class="offer-prod-thumb" src="">
                    <div class="offer-prod-info">
                        <h3 id="quick-offer-name">Nome do Produto</h3>
                        <p>Preço Original: <strong id="quick-offer-original">R$ 0,00</strong></p>
                    </div>
                </div>

                <div class="offer-control-row">
                    <div>
                        <div class="offer-status-label" id="offer-status-label">Oferta Desativada</div>
                        <small style="color: #666;">Ative para definir um preço promocional</small>
                    </div>
                    <label class="switch purple">
                        <input type="checkbox" id="offer-toggle" onchange="toggleOfferInputs()">
                        <span class="slider round"></span>
                    </label>
                </div>

                <div class="form-group offer-input-container" id="offer-input-box">
                    <label style="color: var(--color-offer); font-weight: 700;">Preço de Oferta (R$)</label>
                    <div class="input-wrapper" style="border-color: var(--color-offer);">
                        <input type="number" id="quick-offer-price" step="0.01" placeholder="0.00">
                    </div>
                    <p id="last-offer-info" style="font-size: 0.75rem; color: #999; margin-top: 5px; display: none;">
                        Última oferta: R$ <span id="last-offer-val">--</span>
                    </p>
                </div>

                <input type="hidden" id="quick-offer-id">
                <button class="btn-save-offer" onclick="saveQuickOffer()">Salvar Alterações</button>
                <div style="height: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- MODAL DE CADASTRO/EDIÇÃO -->
    <div class="modal-overlay" id="productModal">
        <div class="modal-sheet">
            <div class="sheet-header">
                <h2 class="sheet-title" id="modal-title">Novo Produto</h2>
                <div onclick="closeModal()" style="cursor: pointer; padding: 5px;"><i class='bx bx-x' style="font-size: 24px;"></i></div>
            </div>

            <form id="productForm">
                <input type="hidden" id="prod-id">
                
                <!-- SEÇÃO IMAGENS -->
                <div class="form-section">
                    <div class="section-label">Imagens (Max 5)</div>
                    <div class="images-grid" id="images-container">
                        <!-- Slots gerados via JS -->
                    </div>
                    <p style="font-size: 0.7rem; color: #999; margin-top: 5px;">A primeira imagem será a capa.</p>
                </div>

                <!-- SEÇÃO DADOS BÁSICOS -->
                <div class="form-section">
                    <div class="section-label">Informações Básicas</div>
                    
                    <!-- Scanner View -->
                    <div id="scanner-viewport">
                        <button type="button" onclick="stopScanner()" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; padding: 5px 10px; border-radius: 4px; z-index: 20;">Fechar</button>
                    </div>

                    <div class="form-group">
                        <label>Código SKU / Barras</label>
                        <div class="input-wrapper">
                            <input type="text" id="prod-code" placeholder="Ex: 78910...">
                            <button type="button" class="scan-btn" onclick="startScanner()">
                                <i class='bx bx-scan'></i> Scan
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Nome do Produto *</label>
                        <div class="input-wrapper"><input type="text" id="prod-name" required placeholder="Ex: Tênis Esportivo Casual"></div>
                    </div>

                    <div class="form-group">
                        <label>Variantes (Opções)</label>
                        <div class="input-wrapper">
                            <input type="text" id="prod-variants" placeholder="Separe por ponto e vírgula. Ex: P; M; G; GG">
                        </div>
                        <p style="font-size: 0.7rem; color: #999; margin-top: 2px;">Usado para criar botões de seleção na loja.</p>
                    </div>
                </div>

                <!-- SEÇÃO PREÇOS -->
                <div class="form-section">
                    <div class="section-label">Preços e Lucro</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Custo (R$)</label>
                            <div class="input-wrapper"><input type="number" id="prod-cost" step="0.01" oninput="calculateMargin()"></div>
                        </div>
                        <div class="form-group">
                            <label>Venda (R$)</label>
                            <div class="input-wrapper"><input type="number" id="prod-price" step="0.01" required oninput="calculateMargin(); syncWebPrice();"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--color-primary);">Preço Oferta (Opcional)</label>
                        <div class="input-wrapper"><input type="number" id="prod-offer" step="0.01" placeholder="Vazio se não houver" oninput="calculateMargin()"></div>
                    </div>

                    <div class="profit-box">
                        <span style="font-size: 0.85rem;">Lucro Estimado:</span>
                        <div style="text-align: right;">
                            <div class="profit-val" id="profit-val">R$ 0,00</div>
                            <small id="margin-val" style="color: #666;">0% margem</small>
                        </div>
                    </div>
                </div>

                <!-- NOVA SEÇÃO: CONFIGURAÇÕES WEB (PARCELAMENTO) -->
                <div class="form-section" style="background: #fdfdfd; padding: 15px; border-radius: 12px; border: 1px solid #eee;">
                    <div class="section-label" style="color: var(--color-mp-blue); display:flex; align-items:center; gap:5px;">
                        <i class='bx bxs-credit-card'></i> Web Site: Parcelamento
                    </div>
                    
                    <div class="offer-control-row" style="margin-bottom: 10px; border-bottom: none;">
                        <span style="font-size: 0.9rem; font-weight: 500;">Vender Parcelado no Site</span>
                        <label class="switch">
                            <input type="checkbox" id="web-installments-active" onchange="toggleWebFields()">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div id="web-fields-container" style="display:none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Preço Parcelado (R$)</label>
                                <div class="input-wrapper">
                                    <input type="number" id="web-price" step="0.01" placeholder="Igual ao original" oninput="calcMpFees()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Máx. Parcelas</label>
                                <div class="input-wrapper">
                                    <select id="web-max-installments" onchange="calcMpFees()" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd;">
                                        <option value="1">1x (À vista)</option>
                                        <option value="2">2x</option>
                                        <option value="3">3x</option>
                                        <option value="4">4x</option>
                                        <option value="5">5x</option>
                                        <option value="6">6x</option>
                                        <option value="9">9x</option>
                                        <option value="10">10x</option>
                                        <option value="12" selected>12x</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- SIMULADOR DE TAXAS MP (RECEBER NA HORA) -->
                        <div class="mp-fee-box">
                            <div class="mp-header"><i class='bx bxs-calculator'></i> Simulação de Taxas (Na Hora)</div>
                            <div class="mp-fee-row">
                                <span>Preço de Venda:</span>
                                <strong id="mp-sim-price">R$ 0,00</strong>
                            </div>
                            <div class="mp-fee-row">
                                <span>Taxa Aprox. (<span id="mp-rate-display">0%</span>):</span>
                                <span style="color: #ef4444;">- <span id="mp-fee-val">R$ 0,00</span></span>
                            </div>
                            <div class="mp-total-fee">
                                <span>Você Recebe (Líquido):</span>
                                <span style="color: #16a34a; font-size: 1.1rem;" id="mp-net-val">R$ 0,00</span>
                            </div>
                            <p style="font-size: 0.7rem; color: #999; margin-top: 5px; text-align: center;">
                                *Estimativa baseada nas taxas de "Receber na hora" (4.99% base + tarifa de parcelamento).
                            </p>
                        </div>
                    </div>
                </div>

                <!-- SEÇÃO ESTOQUE -->
                <div class="form-section">
                    <div class="section-label">Estoque</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Qtd. Atual</label>
                            <div class="input-wrapper"><input type="number" id="prod-stock" required value="1"></div>
                        </div>
                        <div class="form-group">
                            <label>Estoque Mínimo</label>
                            <div class="input-wrapper"><input type="number" id="prod-min-stock" value="5"></div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Descrição Detalhada</label>
                    <div class="input-wrapper">
                        <textarea id="prod-desc" rows="4" placeholder="Detalhes técnicos, material, medidas..."></textarea>
                    </div>
                </div>

                <button type="submit" class="btn-primary" id="btn-save">Salvar Produto</button>
                
                <div id="edit-actions" style="display:none; gap: 10px; margin-top: 15px;">
                    <button type="button" class="btn-danger" onclick="deleteProduct()">Excluir</button>
                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancelar</button>
                </div>
                <div style="height: 20px;"></div>
            </form>
        </div>
    </div>

    <!-- LÓGICA DO SISTEMA -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        // Configuração Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAVQ3tf6Qu4_9PajpJclZAJjVvRgB4ZE2I",
            authDomain: "super-app25.firebaseapp.com",
            projectId: "super-app25",
            storageBucket: "super-app25.firebasestorage.app",
            messagingSenderId: "810900166273",
            appId: "1:810900166273:web:24b8f055a68c9f0a6b5f80"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'floralchic-loja';
        const ADMIN_EMAIL = 'eletroresponde@gmail.com'; // EMAIL DO ADM

        let currentUser = null;
        let productsData = [];
        let scannerIsRunning = false;
        const MAX_IMAGES = 5;

        // AUTH & LOGIN LOGIC
        window.loginWithGoogle = async function() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Erro login:", error);
                document.getElementById('login-msg').textContent = "Erro ao fazer login. Tente novamente.";
                document.getElementById('login-msg').style.display = 'block';
            }
        }

        window.handleLogout = async function() {
            try {
                await signOut(auth);
                window.location.reload();
            } catch (error) {
                console.error("Erro logout:", error);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // VERIFICAÇÃO DE EMAIL ADMIN
                if (user.email === ADMIN_EMAIL) {
                    currentUser = user;
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('app-content').style.display = 'block';
                    initProductsListener();
                } else {
                    document.getElementById('login-msg').textContent = `Acesso negado para ${user.email}. Use a conta administrativa.`;
                    document.getElementById('login-msg').style.display = 'block';
                    await signOut(auth);
                }
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('app-content').style.display = 'none';
                currentUser = null;
            }
        });

        // LEITURA EM TEMPO REAL
        function initProductsListener() {
            const colRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'products');
            
            onSnapshot(colRef, (snapshot) => {
                productsData = [];
                snapshot.forEach(doc => {
                    productsData.push({ id: doc.id, ...doc.data() });
                });
                productsData.sort((a,b) => a.name.localeCompare(b.name));
                renderProducts(productsData);
                calculateTotalOffers();
            });
        }

        // RENDERIZAÇÃO DA LISTA
        function renderProducts(list) {
            const container = document.getElementById('products-list');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:50px; color:#999;">
                        <i class='bx bx-package' style="font-size: 3rem;"></i>
                        <p>Nenhum produto encontrado.</p>
                    </div>`;
                return;
            }

            list.forEach(prod => {
                const thumb = prod.imgUrl || 'https://placehold.co/100x100/eee/999?text=Sem+Foto';
                
                const price = parseFloat(prod.price || 0);
                const offer = parseFloat(prod['price-oferta'] || 0);
                const hasOffer = (offer > 0 && offer < price);
                
                const fmtPrice = price.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                const fmtOffer = offer.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});

                const stockClass = (prod.stock <= (prod.minStock || 3)) ? 'low' : '';
                
                const offerBtnClass = hasOffer ? 'btn-quick-offer active' : 'btn-quick-offer';
                
                const html = `
                    <div class="prod-item" onclick="editProduct('${prod.id}')">
                        <img src="${thumb}" class="prod-thumb" loading="lazy">
                        <div class="prod-info">
                            <div class="prod-name">${prod.name}</div>
                            <div class="prod-meta">
                                <span>SKU: ${prod.code || '-'}</span>
                                <span class="stock-tag ${stockClass}">${prod.stock} un</span>
                            </div>
                            <div class="prod-prices">
                                ${hasOffer ? 
                                    `<span class="price-current">${fmtOffer}</span> <span class="price-old">${fmtPrice}</span>` : 
                                    `<span class="price-current">${fmtPrice}</span>`
                                }
                            </div>
                        </div>
                        <button class="${offerBtnClass}" onclick="openOfferModal(event, '${prod.id}')" title="Gerenciar Oferta">
                            <i class='bx bx-plus'></i>
                        </button>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // --- DASHBOARD DE OFERTAS ---
        function calculateTotalOffers() {
            let totalDiscount = 0;
            let totalRevenue = 0; // Nova variável
            let count = 0;

            productsData.forEach(p => {
                const price = parseFloat(p.price || 0);
                const offer = parseFloat(p['price-oferta'] || 0);
                const stock = parseInt(p.stock || 0);
                
                // Determina preço efetivo para cálculo de receita
                let effectivePrice = price;
                if (offer > 0 && offer < price) {
                    effectivePrice = offer;
                }

                // Cálculo de Receita (Potencial total baseado no estoque)
                if (stock > 0) {
                    totalRevenue += (effectivePrice * stock);
                }

                // Cálculo de Desconto
                if (offer > 0 && offer < price && stock > 0) {
                    const discountPerUnit = price - offer;
                    totalDiscount += (discountPerUnit * stock);
                    count++;
                }
            });

            document.getElementById('total-discount-value').textContent = totalDiscount.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('total-revenue-value').textContent = totalRevenue.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); // Atualiza novo elemento
            document.getElementById('products-with-offer-count').textContent = `${count} produtos em oferta`;
        }

        window.deactivateAllOffers = async function() {
            const activeOffers = productsData.filter(p => {
                const price = parseFloat(p.price || 0);
                const offer = parseFloat(p['price-oferta'] || 0);
                return (offer > 0 && offer < price);
            });

            if(activeOffers.length === 0) return alert("Não há ofertas ativas.");
            
            if(!confirm(`Deseja realmente desativar TODAS as ${activeOffers.length} ofertas ativas?`)) return;

            const btn = document.querySelector('.btn-reset-offers');
            const oldText = btn.innerHTML;
            btn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Processando...";

            try {
                const promises = activeOffers.map(p => {
                    const updates = { 
                        'price-oferta': 0, 
                        'lastOffer': p['price-oferta'], 
                        updatedAt: new Date().toISOString() 
                    };
                    return updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'products', p.id), updates);
                });
                
                await Promise.all(promises);
                alert("Todas as ofertas foram desativadas com sucesso!");
            } catch(e) {
                console.error(e);
                alert("Erro ao desativar ofertas.");
            } finally {
                btn.innerHTML = oldText;
            }
        }

        // --- WEB SITE LOGIC (PARCELAMENTO) ---
        
        window.toggleWebFields = function() {
            const active = document.getElementById('web-installments-active').checked;
            const container = document.getElementById('web-fields-container');
            container.style.display = active ? 'block' : 'none';
            
            if(active) {
                // Se ativou e o campo de preço tá vazio, preenche com o original
                const webPrice = document.getElementById('web-price');
                if(!webPrice.value) {
                    webPrice.value = document.getElementById('prod-price').value;
                }
                calcMpFees();
            }
        }

        window.syncWebPrice = function() {
            // Se parcelamento ainda não foi modificado, sugere o preço original
            const webPrice = document.getElementById('web-price');
            if(!document.getElementById('web-installments-active').checked) {
                webPrice.value = document.getElementById('prod-price').value;
            }
        }

        window.calcMpFees = function() {
            // TAXAS ESTIMADAS CHECKOUT TRANSPARENTE - PLANO RECEBER NA HORA
            // Crédito à vista (Na Hora): ~4.99% (Taxa Liberação)
            // Parcelado: 4.99% + Tarifa de Parcelamento (Assumindo Sem Juros para o cliente)
            // Exemplo Tarifa Parcelamento (Aprox. - pode variar por conta):
            
            const installmentRates = {
                1: 0,       // À vista (só paga taxa liberação)
                2: 4.59,
                3: 5.97,
                4: 7.33,
                5: 8.66,
                6: 9.96,
                9: 13.6,
                10: 14.7,
                12: 16.90 // Aprox 17%
            };
            
            const releaseFee = 4.99; // Taxa fixa de liberação "Na Hora"

            const price = parseFloat(document.getElementById('web-price').value) || 0;
            const parcelas = parseInt(document.getElementById('web-max-installments').value) || 1;

            const instRate = installmentRates[parcelas] || (parcelas * 1.4); // Fallback
            const totalRate = releaseFee + instRate;

            const feeAmount = price * (totalRate / 100);
            const netAmount = price - feeAmount;

            document.getElementById('mp-sim-price').textContent = price.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('mp-rate-display').textContent = totalRate.toFixed(2) + '%';
            document.getElementById('mp-fee-val').textContent = feeAmount.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('mp-net-val').textContent = netAmount.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
        }

        // --- GESTÃO RÁPIDA DE OFERTAS ---

        window.openOfferModal = function(e, id) {
            e.stopPropagation(); 
            const prod = productsData.find(p => p.id === id);
            if(!prod) return;

            document.getElementById('quick-offer-id').value = prod.id;
            document.getElementById('quick-offer-name').textContent = prod.name;
            document.getElementById('quick-offer-img').src = prod.imgUrl || 'https://placehold.co/100x100/eee/999?text=Sem+Foto';
            
            const originalPrice = parseFloat(prod.price || 0);
            document.getElementById('quick-offer-original').textContent = originalPrice.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});

            const currentOffer = parseFloat(prod['price-oferta'] || 0);
            const lastOffer = parseFloat(prod['lastOffer'] || 0);
            const toggle = document.getElementById('offer-toggle');
            const input = document.getElementById('quick-offer-price');

            if (currentOffer > 0 && currentOffer < originalPrice) {
                toggle.checked = true;
                input.value = currentOffer;
            } else {
                toggle.checked = false;
                if (lastOffer > 0) {
                    input.value = lastOffer;
                    document.getElementById('last-offer-val').textContent = lastOffer.toFixed(2);
                    document.getElementById('last-offer-info').style.display = 'block';
                } else {
                    input.value = '';
                    document.getElementById('last-offer-info').style.display = 'none';
                }
            }

            toggleOfferInputs(); 
            document.getElementById('offerModal').classList.add('open');
        }

        window.closeOfferModal = function() {
            document.getElementById('offerModal').classList.remove('open');
        }

        window.toggleOfferInputs = function() {
            const toggle = document.getElementById('offer-toggle');
            const inputBox = document.getElementById('offer-input-box');
            const label = document.getElementById('offer-status-label');

            if (toggle.checked) {
                inputBox.classList.remove('disabled');
                label.textContent = "Oferta Ativada";
                label.className = "offer-status-label status-on";
            } else {
                inputBox.classList.add('disabled');
                label.textContent = "Oferta Desativada";
                label.className = "offer-status-label status-off";
            }
        }

        window.saveQuickOffer = async function() {
            const id = document.getElementById('quick-offer-id').value;
            const toggle = document.getElementById('offer-toggle');
            const inputVal = parseFloat(document.getElementById('quick-offer-price').value);
            const prod = productsData.find(p => p.id === id);

            const updates = { updatedAt: new Date().toISOString() };
            
            if (toggle.checked) {
                if (!inputVal || inputVal <= 0) {
                    alert("Por favor, insira um preço de oferta válido.");
                    return;
                }
                if (inputVal >= parseFloat(prod.price)) {
                    alert("O preço de oferta deve ser menor que o preço original.");
                    return;
                }
                updates['price-oferta'] = inputVal;
                updates['lastOffer'] = inputVal; 
            } else {
                updates['price-oferta'] = 0; 
                if(inputVal > 0) {
                    updates['lastOffer'] = inputVal;
                }
            }

            try {
                const btn = document.querySelector('.btn-save-offer');
                const oldText = btn.textContent;
                btn.textContent = "Salvando...";
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'products', id), updates);
                closeOfferModal();
                btn.textContent = oldText;
            } catch (e) {
                console.error(e);
                alert("Erro ao salvar oferta.");
            }
        }

        // --- CRUD PRINCIPAL ---

        window.openModal = function() {
            resetForm();
            document.getElementById('modal-title').textContent = "Novo Produto";
            document.getElementById('edit-actions').style.display = 'none';
            document.getElementById('btn-save').style.display = 'block';
            document.getElementById('productModal').classList.add('open');
            renderImageSlots(); 
        }

        window.closeModal = function() {
            document.getElementById('productModal').classList.remove('open');
            stopScanner();
        }

        window.editProduct = function(id) {
            const prod = productsData.find(p => p.id === id);
            if(!prod) return;

            document.getElementById('prod-id').value = prod.id;
            document.getElementById('prod-name').value = prod.name;
            document.getElementById('prod-code').value = prod.code || '';
            document.getElementById('prod-variants').value = prod.variants || '';
            
            document.getElementById('prod-cost').value = prod.cost || '';
            document.getElementById('prod-price').value = prod.price || '';
            document.getElementById('prod-offer').value = prod['price-oferta'] || '';
            
            // WEB FIELDS (Novos)
            document.getElementById('web-installments-active').checked = !!prod.web_active;
            document.getElementById('web-price').value = prod.web_price || prod.price || '';
            document.getElementById('web-max-installments').value = prod.web_installments || 12;
            
            toggleWebFields(); // Atualiza visual e cálculo

            document.getElementById('prod-stock').value = prod.stock || 0;
            document.getElementById('prod-min-stock').value = prod.minStock || 5;
            document.getElementById('prod-desc').value = prod.desc || '';

            renderImageSlots(prod);
            calculateMargin();

            document.getElementById('modal-title').textContent = "Editar Produto";
            document.getElementById('btn-save').textContent = "Atualizar Produto";
            document.getElementById('edit-actions').style.display = 'flex';
            document.getElementById('productModal').classList.add('open');
        }

        function renderImageSlots(prod = {}) {
            const container = document.getElementById('images-container');
            container.innerHTML = '';

            let existingImages = [];
            if(prod.imgUrl) existingImages.push(prod.imgUrl);
            for(let i=1; i<MAX_IMAGES; i++) {
                if(prod[`imgUrl${i}`]) existingImages.push(prod[`imgUrl${i}`]);
            }

            const totalSlots = Math.min(existingImages.length + 1, MAX_IMAGES);
            
            for(let i=0; i < MAX_IMAGES; i++) {
                if(i < existingImages.length) {
                    createSlot(container, i, existingImages[i], true);
                } else if (i === existingImages.length) {
                    createSlot(container, i, null, false);
                }
            }
        }

        function createSlot(container, index, src, hasImage) {
            const div = document.createElement('div');
            div.className = 'img-slot';
            
            if(hasImage) {
                div.innerHTML = `
                    <img src="${src}">
                    <div class="remove-btn" onclick="removeImage(${index}); event.stopPropagation();">x</div>
                    <input type="hidden" class="img-base64" id="img-input-${index}" value="${src}">
                `;
            } else {
                div.innerHTML = `
                    <i class='bx bx-camera'></i>
                    <input type="file" style="display:none" accept="image/*" onchange="handleImage(this, ${index})">
                    <input type="hidden" class="img-base64" id="img-input-${index}">
                `;
                div.onclick = function() { this.querySelector('input[type=file]').click(); }
            }
            container.appendChild(div);
        }

        window.triggerImageUpload = function(idx) { }

        window.handleImage = function(input, index) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_DIM = 800; 
                        
                        let w = img.width, h = img.height;
                        if (w > h) {
                            if (w > MAX_DIM) { h *= MAX_DIM / w; w = MAX_DIM; }
                        } else {
                            if (h > MAX_DIM) { w *= MAX_DIM / h; h = MAX_DIM; }
                        }
                        
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        
                        const slot = input.parentElement;
                        slot.onclick = null; 
                        slot.innerHTML = `
                            <img src="${dataUrl}">
                            <div class="remove-btn" onclick="removeImage(${index}); event.stopPropagation();">x</div>
                            <input type="hidden" class="img-base64" id="img-input-${index}" value="${dataUrl}">
                        `;
                        
                        const container = document.getElementById('images-container');
                        if (container.children.length < MAX_IMAGES) {
                            createSlot(container, container.children.length, null, false);
                        }
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        window.removeImage = function(index) {
            const slot = document.getElementById(`img-input-${index}`).parentElement;
            slot.remove();
            
            const container = document.getElementById('images-container');
            const slots = container.querySelectorAll('.img-slot');
            let hasEmpty = false;
            slots.forEach(s => {
                if(!s.querySelector('img')) hasEmpty = true;
            });

            if(!hasEmpty && slots.length < MAX_IMAGES) {
                createSlot(container, slots.length, null, false);
            }
        }

        window.calculateMargin = function() {
            const cost = parseFloat(document.getElementById('prod-cost').value) || 0;
            const price = parseFloat(document.getElementById('prod-price').value) || 0;
            const offer = parseFloat(document.getElementById('prod-offer').value) || 0;

            const finalPrice = (offer > 0 && offer < price) ? offer : price;
            const profit = finalPrice - cost;
            let margin = 0;
            if (finalPrice > 0) margin = (profit / finalPrice) * 100;

            const box = document.querySelector('.profit-box');
            const valEl = document.getElementById('profit-val');
            const marginEl = document.getElementById('margin-val');

            valEl.textContent = profit.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            marginEl.textContent = margin.toFixed(1) + '% de margem';

            if(profit < 0) {
                box.style.background = '#fef2f2';
                box.style.borderColor = '#fecaca';
                valEl.style.color = '#dc2626';
            } else {
                box.style.background = '#f0fdf4';
                box.style.borderColor = '#bbf7d0';
                valEl.style.color = '#16a34a';
            }
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save');
            const originalText = btn.textContent;
            btn.textContent = "Salvando...";
            btn.disabled = true;

            try {
                const imgInputs = document.querySelectorAll('.img-base64');
                let images = [];
                imgInputs.forEach(inp => {
                    if(inp.value) images.push(inp.value);
                });

                const data = {
                    name: document.getElementById('prod-name').value,
                    code: document.getElementById('prod-code').value,
                    variants: document.getElementById('prod-variants').value,
                    
                    cost: parseFloat(document.getElementById('prod-cost').value) || 0,
                    price: parseFloat(document.getElementById('prod-price').value) || 0,
                    'price-oferta': parseFloat(document.getElementById('prod-offer').value) || 0,
                    
                    // NOVOS CAMPOS WEB SITE
                    web_active: document.getElementById('web-installments-active').checked,
                    web_price: parseFloat(document.getElementById('web-price').value) || 0,
                    web_installments: parseInt(document.getElementById('web-max-installments').value) || 12,
                    
                    stock: parseInt(document.getElementById('prod-stock').value) || 0,
                    minStock: parseInt(document.getElementById('prod-min-stock').value) || 5,
                    desc: document.getElementById('prod-desc').value,
                    
                    updatedAt: new Date().toISOString()
                };

                if(images.length > 0) data.imgUrl = images[0];
                else data.imgUrl = ''; 

                for(let i=1; i<MAX_IMAGES; i++) {
                    data[`imgUrl${i}`] = '';
                }
                for(let i=1; i<images.length; i++) {
                    data[`imgUrl${i}`] = images[i];
                }

                const id = document.getElementById('prod-id').value;
                const colRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'products');

                if (id) {
                    await updateDoc(doc(colRef, id), data);
                } else {
                    data.createdAt = new Date().toISOString();
                    await addDoc(colRef, data);
                }

                closeModal();
                alert('Produto salvo com sucesso!');

            } catch (error) {
                console.error(error);
                alert('Erro ao salvar. Verifique se as imagens não são muito pesadas.');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });

        window.deleteProduct = async function() {
            const id = document.getElementById('prod-id').value;
            if(!id) return;
            if(confirm("Tem certeza que deseja excluir este produto?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'products', id));
                closeModal();
            }
        }

        function resetForm() {
            document.getElementById('productForm').reset();
            document.getElementById('prod-id').value = '';
            document.getElementById('images-container').innerHTML = '';
            document.getElementById('profit-val').textContent = 'R$ 0,00';
            document.getElementById('margin-val').textContent = '0%';
            
            // Reset Web Fields
            document.getElementById('web-installments-active').checked = false;
            toggleWebFields();
        }

        window.startScanner = function() {
            const vp = document.getElementById('scanner-viewport');
            vp.style.display = 'block';
            
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: vp, constraints: { facingMode: "environment" } },
                decoder: { readers: ["ean_reader", "code_128_reader"] }
            }, function(err) {
                if(err) { console.error(err); alert("Erro na câmera"); return; }
                Quagga.start();
                scannerIsRunning = true;
            });

            Quagga.onDetected(function(result) {
                const code = result.codeResult.code;
                if(code) {
                    document.getElementById('prod-code').value = code;
                    stopScanner();
                    if(navigator.vibrate) navigator.vibrate(200);
                }
            });
        }

        window.stopScanner = function() {
            if(scannerIsRunning) {
                Quagga.stop();
                scannerIsRunning = false;
            }
            document.getElementById('scanner-viewport').style.display = 'none';
        }

        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = productsData.filter(p => 
                p.name.toLowerCase().includes(term) || 
                (p.code && p.code.includes(term))
            );
            renderProducts(filtered);
        });

    </script>
</body>
</html>