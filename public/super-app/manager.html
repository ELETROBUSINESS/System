<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1554/1554591.png">
    <title>Gerenciador | Dtudo</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

    <style>
        :root {
            --color-primary: #db0038;
            --color-primary-dark: #b71c1c;
            --color-bg: #f4f6f8;
            --color-white: #ffffff;
            --color-text: #1f2937;
            --color-text-light: #6b7280;
            --color-border: #e5e7eb;
            --color-offer: #7c3aed;
            --radius: 12px;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--color-bg);
            padding-bottom: 90px;
            color: var(--color-text);
        }

        /* --- LOGIN --- */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        .login-card {
            background: white;
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: var(--shadow-card);
            max-width: 400px;
            width: 100%;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 30px;
            background: white;
            color: #555;
            font-weight: 500;
            cursor: pointer;
            margin-top: 20px;
            transition: 0.2s;
        }

        .google-btn:hover {
            background: #f9f9f9;
        }

        /* --- HEADER --- */
        #app-content {
            display: none;
        }

        .admin-header {
            background: var(--color-primary);
            color: white;
            padding: 20px 20px 80px 20px;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: var(--shadow-card);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1000px;
            margin: 0 auto;
        }

        .btn-icon-header {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
        }

        /* --- DASHBOARD --- */
        .offer-dashboard {
            background: white;
            border-radius: var(--radius);
            margin: -60px auto 20px auto;
            padding: 20px;
            box-shadow: var(--shadow-card);
            max-width: 1000px;
            width: 90%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .dash-item {
            display: flex;
            flex-direction: column;
        }

        .dash-label {
            font-size: 0.8rem;
            color: var(--color-text-light);
            font-weight: 500;
        }

        .dash-value {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--color-text);
        }

        .dash-actions {
            grid-column: 1 / -1;
            border-top: 1px solid var(--color-border);
            padding-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- SEARCH & LIST --- */
        .search-container {
            max-width: 1000px;
            margin: 0 auto 20px auto;
            padding: 0 20px;
        }

        .search-box {
            background: white;
            border-radius: var(--radius);
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--color-border);
        }

        .search-box input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 1rem;
            color: var(--color-text);
        }

        .product-list {
            padding: 0 20px;
            display: grid;
            gap: 15px;
            max-width: 1000px;
            margin: 0 auto;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }

        .prod-item {
            background: white;
            border-radius: var(--radius);
            padding: 12px;
            display: flex;
            gap: 15px;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
            position: relative;
        }

        .prod-item:hover {
            transform: translateY(-2px);
            border-color: var(--color-primary);
        }

        .prod-thumb {
            width: 70px;
            height: 70px;
            border-radius: 8px;
            object-fit: cover;
            background: #eee;
            flex-shrink: 0;
        }

        .prod-info {
            flex: 1;
            overflow: hidden;
        }

        .prod-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        /* Garante que o container da linha meta alinhe os itens corretamente */
        .prod-meta-row {
            display: flex;
            align-items: flex-end;
            /* Alinha o estoque com a parte de baixo */
            justify-content: space-between;
            width: 100%;
            margin-top: 8px;
        }

        /* Ajuste do container de preços para COLUNA */
        .prod-prices {
            display: flex;
            flex-direction: column;
            /* Itens um abaixo do outro */
            gap: 0px;
            align-items: flex-start;
            /* Alinha tudo à esquerda */
            justify-content: center;
        }

        .price-current {
            color: var(--color-primary);
            font-weight: 900;
            font-size: 1rem;
            line-height: 1.2;
        }

        .price-old {
            text-decoration: line-through;
            color: #999;
            font-size: 0.75rem;
            margin-bottom: 2px;
            /* Pequeno espaço antes do preço novo */
        }

        /* TAGS ESTOQUE E DESCONTO */
        .stock-tag {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
            margin-left: auto;
        }

        .stock-ok {
            background: #dcfce7;
            color: #166534;
        }

        .stock-low {
            background: #ffedd5;
            color: #9a3412;
        }

        .stock-out {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Badge de Desconto ajustada para ficar abaixo */
        .discount-badge {
            background: #f1f1f1;
            color: var(--color-offer);
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 0;
            /* Remove margem lateral */
            margin-top: 4px;
            /* Espaço acima da badge */
            display: inline-block;
        }

        /* BOTÃO OFERTA RÁPIDA (LISTA) */
        .btn-quick-offer {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid #f3e8ff;
            background: white;
            color: #d8b4fe;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            margin-left: 10px;
            z-index: 5;
            transition: 0.2s;
        }

        .btn-quick-offer:hover {
            background: #f3e8ff;
            transform: scale(1.1);
        }

        .btn-quick-offer.active {
            background: var(--color-offer);
            color: white;
            border-color: var(--color-offer);
            box-shadow: 0 4px 10px rgba(124, 58, 237, 0.3);
        }

        /* --- MODAL PRINCIPAL --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal-sheet {
            background: white;
            width: 100%;
            max-width: 800px;
            height: 90vh;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s ease-out;
        }

        @media (min-width: 768px) {
            .modal-overlay {
                align-items: center;
            }

            .modal-sheet {
                height: auto;
                max-height: 90vh;
                border-radius: 24px;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9fafb;
        }

        .modal-footer {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid var(--color-border);
            display: flex;
            gap: 10px;
        }

        /* TABS */
        .tab-nav {
            display: flex;
            background: white;
            padding: 0 20px;
            border-bottom: 1px solid var(--color-border);
        }

        .tab-btn {
            padding: 15px;
            font-weight: 600;
            color: var(--color-text-light);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: 0.2s;
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* FORMS & INPUTS */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (min-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 5px;
        }

        .input-box {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
            transition: 0.2s;
        }

        .input-box:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(219, 0, 56, 0.1);
        }

        /* IMAGES */
        .images-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 5px;
        }

        .img-slot {
            width: 100px;
            height: 100px;
            flex-shrink: 0;
            border-radius: 8px;
            border: 2px dashed #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: white;
        }

        .img-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .img-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* VARIANT SEARCH */
        .variant-search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .variant-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: var(--shadow-card);
            display: none;
        }

        .variant-result-item {
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .variant-result-item:hover {
            background: #f3f4f6;
        }

        .added-variants-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .added-variant {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* INSTALLMENT BOX */
        .installment-info-box {
            background: #eef2ff;
            border: 1px solid #c7d2fe;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #374151;
        }

        .info-row.highlight {
            font-weight: 700;
            color: #4338ca;
            border-top: 1px solid #c7d2fe;
            padding-top: 8px;
            margin-top: 8px;
        }

        /* SWITCH TOGGLE (MODAL OFERTA) */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--color-offer);
        }

        input:checked+.slider:before {
            transform: translateX(22px);
        }

        /* BUTTONS & FAB */
        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
            flex: 2;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
            flex: 1;
        }

        .btn-danger {
            background: #fee2e2;
            color: #ef4444;
            flex: 1;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--color-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 4px 15px rgba(219, 0, 56, 0.4);
            cursor: pointer;
            z-index: 90;
        }

        .loader-center {
            display: flex;
            justify-content: center;
            padding: 20px;
        }
    </style>
</head>

<body>

    <div id="login-overlay">
        <div class="login-card">
            <h2 style="margin-bottom: 10px;">Administração</h2>
            <p style="color: #666;">Acesso restrito ao gerenciador.</p>
            <button class="google-btn" onclick="loginWithGoogle()"><i class='bx bxl-google'></i> Entrar com
                Google</button>
            <p id="login-msg" style="color: var(--color-primary); font-size: 0.8rem; margin-top: 15px; display: none;">
            </p>
        </div>
    </div>

    <div id="app-content">
        <div class="admin-header">
            <div class="header-top">
                <a href="index.html" class="btn-icon-header"><i class='bx bx-home-alt'></i></a>
                <h1 style="font-size: 1.2rem;">Gerenciador Dtudo</h1>
                <button class="btn-icon-header" onclick="handleLogout()"><i class='bx bx-log-out'></i></button>
            </div>
        </div>

        <div class="offer-dashboard">
            <div class="dash-item">
                <span class="dash-label">Investimento em Descontos</span>
                <span class="dash-value" id="dash-discount">R$ 0,00</span>
            </div>
            <div class="dash-item">
                <span class="dash-label">Receita Potencial (Estoque)</span>
                <span class="dash-value" id="dash-revenue">R$ 0,00</span>
            </div>
            <div class="dash-actions">
                <span id="dash-count" style="font-size: 0.8rem; color: #666;">0 ofertas ativas</span>
                <button onclick="deactivateAllOffers()"
                    style="background:none; border:none; color:var(--color-primary); font-weight:600; cursor:pointer;">
                    Limpar Ofertas
                </button>
            </div>
        </div>

        <div class="search-container">
            <div class="search-box">
                <i class='bx bx-search' style="color: #999; margin-right: 10px;"></i>
                <input type="text" id="search-input" placeholder="Buscar produtos...">
            </div>
        </div>

        <div id="products-list" class="product-list">
            <div class="loader-center">Carregando...</div>
        </div>

        <div class="fab" onclick="openProductModal()"><i class='bx bx-plus'></i></div>
    </div>

    <div class="modal-overlay" id="productModal">
        <div class="modal-sheet">
            <div class="modal-header">
                <h3 id="modal-title">Novo Produto</h3>
                <i class='bx bx-x' onclick="closeProductModal()" style="font-size: 1.5rem; cursor: pointer;"></i>
            </div>

            <div class="tab-nav">
                <div class="tab-btn active" onclick="switchTab('tab-details')">Detalhes</div>
                <div class="tab-btn" onclick="switchTab('tab-prices')">Preços & Taxas</div>
                <div class="tab-btn" onclick="switchTab('tab-variants')">Variações</div>
            </div>

            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="prod-id">

                    <div id="tab-details" class="tab-content active">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Imagens do Produto</label>
                            <div class="images-scroll" id="images-container">
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Nome do Produto *</label>
                            <input type="text" id="prod-name" class="input-box" required
                                placeholder="Ex: Tênis Esportivo">
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Código (SKU)</label>
                                <div style="display: flex; gap: 5px;">
                                    <input type="text" id="prod-code" class="input-box" placeholder="Scan ou Digite">
                                    <button type="button" onclick="startScanner()"
                                        style="padding: 0 15px; background: #eee; border: 1px solid #ccc; border-radius: 8px;"><i
                                            class='bx bx-scan'></i></button>
                                </div>
                                <div id="scanner-viewport"
                                    style="display:none; height: 150px; background:black; margin-top:5px;"></div>
                            </div>
                            <div class="form-group">
                                <label>Estoque Atual</label>
                                <input type="number" id="prod-stock" class="input-box" value="1">
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 15px;">
                            <label>Descrição</label>
                            <textarea id="prod-desc" class="input-box" rows="4"
                                placeholder="Detalhes técnicos..."></textarea>
                        </div>
                    </div>

                    <div id="tab-prices" class="tab-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Custo (R$)</label>
                                <input type="number" id="prod-cost" class="input-box" step="0.01"
                                    oninput="calculateFinancials()">
                            </div>
                            <div class="form-group">
                                <label>Venda (R$)</label>
                                <input type="number" id="prod-price" class="input-box" step="0.01" required
                                    oninput="calculateFinancials()">
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 15px;">
                            <label style="color: var(--color-offer);">Preço Promocional (Opcional)</label>
                            <input type="number" id="prod-offer" class="input-box" step="0.01"
                                placeholder="Vazio se não houver" style="border-color: var(--color-offer);"
                                oninput="calculateFinancials()">
                        </div>

                        <div class="installment-info-box">
                            <h4
                                style="margin-bottom: 10px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px;">
                                <i class='bx bxs-credit-card'></i> Simulação Web
                            </h4>
                            <div class="info-row">
                                <span>Regra de Parcelamento:</span>
                                <strong id="sim-rule">Até 12x</strong>
                            </div>
                            <div class="info-row">
                                <span>Taxa Total (Aprox):</span>
                                <span style="color: #ef4444;" id="sim-fee-percent">0%</span>
                            </div>
                            <div class="info-row">
                                <span>Desconto Taxas:</span>
                                <span style="color: #ef4444;" id="sim-fee-val">- R$ 0,00</span>
                            </div>
                            <div class="info-row highlight">
                                <span>Você Recebe (Líquido):</span>
                                <span id="sim-net">R$ 0,00</span>
                            </div>
                            <p style="font-size: 0.7rem; color: #666; margin-top: 8px;">
                                *Baseado em tabela: >=1000 (12x), >=800 (9x), >=625 (8x), >=600 (7x), >=300 (6x), >=250
                                (5x), <250 (4x). Inclui taxa "Receber na hora" . </p>
                        </div>
                    </div>

                    <div id="tab-variants" class="tab-content">
                        <div class="form-group">
                            <label>Adicionar Variação (Buscar Produto Existente)</label>
                            <div class="variant-search-box">
                                <input type="text" id="variant-search" class="input-box"
                                    placeholder="Digite o nome do produto..." oninput="searchForVariants(this.value)">
                                <div id="variant-results" class="variant-results"></div>
                            </div>
                        </div>

                        <label style="margin-bottom: 10px; display: block; font-size: 0.85rem;">Variações
                            Vinculadas:</label>
                        <div id="added-variants-list" class="added-variants-list">
                            <div style="text-align: center; color: #999; padding: 20px;">Nenhuma variação adicionada.
                            </div>
                        </div>
                    </div>

                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-delete" style="display:none;"
                    onclick="deleteProduct()">Excluir</button>
                <button type="button" class="btn btn-primary" id="btn-save"
                    onclick="submitProductForm()">Salvar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="offerModal">
        <div class="modal-sheet" style="height: auto; max-width: 500px;">
            <div class="modal-header">
                <h3>Gerenciar Oferta</h3>
                <i class='bx bx-x' onclick="closeOfferModal()" style="font-size: 1.5rem; cursor: pointer;"></i>
            </div>

            <div class="modal-body">
                <div
                    style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px; background: #f9f9f9; padding: 10px; border-radius: 12px;">
                    <img id="qo-img" src="" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover;">
                    <div>
                        <div id="qo-name" style="font-weight: 600; font-size: 0.9rem;">Nome do Produto</div>
                        <div style="font-size: 0.8rem; color: #666;">Original: <strong id="qo-original">R$ 0,00</strong>
                        </div>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <span style="font-weight: 600;">Ativar Preço de Oferta?</span>
                    <label class="switch">
                        <input type="checkbox" id="qo-toggle" onchange="toggleQuickOfferInputs()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div id="qo-input-container" style="opacity: 0.5; pointer-events: none; transition: 0.3s;">
                    <label style="font-size: 0.8rem; font-weight: 700; color: var(--color-offer);">Novo Preço
                        (R$)</label>
                    <input type="number" id="qo-price" class="input-box" step="0.01"
                        style="border-color: var(--color-offer); font-weight: 700;">
                </div>
            </div>

            <div class="modal-footer">
                <input type="hidden" id="qo-id">
                <button class="btn btn-secondary" onclick="closeOfferModal()">Cancelar</button>
                <button class="btn btn-primary" style="background: var(--color-offer);"
                    onclick="saveQuickOffer()">Salvar Oferta</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAVQ3tf6Qu4_9PajpJclZAJjVvRgB4ZE2I",
            authDomain: "super-app25.firebaseapp.com",
            projectId: "super-app25",
            storageBucket: "super-app25.firebasestorage.app",
            messagingSenderId: "810900166273",
            appId: "1:810900166273:web:24b8f055a68c9f0a6b5f80"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'floralchic-loja';
        const ADMIN_EMAIL = 'eletroresponde@gmail.com';

        let currentUser = null;
        let productsData = [];
        let currentVariants = [];

        // --- AUTH ---
        window.loginWithGoogle = async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); }
            catch (e) { alert("Erro ao logar: " + e.message); }
        }

        window.handleLogout = async () => { await signOut(auth); window.location.reload(); }

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                currentUser = user;
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                loadProducts();
            } else if (user) {
                document.getElementById('login-msg').style.display = 'block';
                document.getElementById('login-msg').textContent = "Acesso não autorizado.";
                signOut(auth);
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
            }
        });

        // --- PRODUTOS ---
        function loadProducts() {
            onSnapshot(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'products'), (snap) => {
                productsData = [];
                snap.forEach(d => productsData.push({ id: d.id, ...d.data() }));
                productsData.sort((a, b) => (b.updatedAt || '').localeCompare(a.updatedAt || ''));
                renderList(productsData);
                updateDashboard();
            });
        }

        function renderList(list) {
            const el = document.getElementById('products-list');
            el.innerHTML = '';

            if (list.length === 0) {
                el.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Nenhum produto encontrado.</div>';
                return;
            }

            list.forEach(p => {
                const price = parseFloat(p.price || 0);
                const offer = parseFloat(p['price-oferta'] || 0);
                const hasOffer = (offer > 0 && offer < price);
                const displayPrice = hasOffer ? offer : price;
                const stock = parseInt(p.stock || 0);

                // Lógica de Estoque
                let stockHtml = '';
                if (stock <= 0) stockHtml = `<span class="stock-tag stock-out">Esgotado</span>`;
                else if (stock <= 5) stockHtml = `<span class="stock-tag stock-low">Baixo: ${stock}</span>`;
                else stockHtml = `<span class="stock-tag stock-ok">Estoque: ${stock}</span>`;

                // Montagem dos Preços em Lista
                let priceBlockHtml = '';

                if (hasOffer) {
                    const pct = Math.round(((price - offer) / price) * 100);
                    // ORDEM: Preço Antigo -> Preço Novo -> Desconto
                    priceBlockHtml = `
                <span class="price-old">${price.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                <span class="price-current">${displayPrice.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                <span class="discount-badge">${pct}% OFF</span>
            `;
                } else {
                    // Apenas preço normal
                    priceBlockHtml = `
                <span class="price-current">${price.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
            `;
                }

                const btnClass = hasOffer ? 'btn-quick-offer active' : 'btn-quick-offer';

                el.innerHTML += `
            <div class="prod-item" onclick="editProduct('${p.id}')">
                <img src="${p.imgUrl || 'https://placehold.co/100'}" class="prod-thumb">
                <div class="prod-info">
                    <div class="prod-name">${p.name}</div>
                    <div class="prod-meta-row">
                        <div class="prod-prices">
                            ${priceBlockHtml}
                        </div>
                        ${stockHtml}
                    </div>
                </div>
                <button class="${btnClass}" onclick="openOfferModal(event, '${p.id}')">
                    <i class='bx bxs-offer'></i>
                </button>
            </div>
        `;
            });
        }

        function updateDashboard() {
            let totalDisc = 0, totalRev = 0, count = 0;
            productsData.forEach(p => {
                const stock = parseInt(p.stock || 0);
                if (stock > 0) {
                    const price = parseFloat(p.price || 0);
                    const offer = parseFloat(p['price-oferta'] || 0);
                    const activePrice = (offer > 0 && offer < price) ? offer : price;

                    totalRev += (activePrice * stock);
                    if (offer > 0 && offer < price) {
                        totalDisc += ((price - offer) * stock);
                        count++;
                    }
                }
            });
            document.getElementById('dash-discount').textContent = totalDisc.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('dash-revenue').textContent = totalRev.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('dash-count').textContent = `${count} produtos em oferta`;
        }

        window.deactivateAllOffers = async () => {
            if (!confirm("Desativar TODAS as ofertas?")) return;
            const batch = productsData.filter(p => parseFloat(p['price-oferta']) > 0);
            for (const p of batch) {
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'products', p.id), { 'price-oferta': 0 });
            }
        }

        // --- MODAL PRINCIPAL LÓGICA ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            // Encontra o botão clicado ou pelo ID
            const buttons = document.querySelectorAll('.tab-btn');
            if (tabId === 'tab-details') buttons[0].classList.add('active');
            if (tabId === 'tab-prices') buttons[1].classList.add('active');
            if (tabId === 'tab-variants') buttons[2].classList.add('active');
        }

        window.openProductModal = () => {
            resetModal();
            document.getElementById('modal-title').textContent = "Novo Produto";
            document.getElementById('btn-delete').style.display = 'none';
            document.getElementById('productModal').classList.add('open');
        }

        window.closeProductModal = () => {
            document.getElementById('productModal').classList.remove('open');
        }

        window.editProduct = (id) => {
            const p = productsData.find(x => x.id === id);
            if (!p) return;
            resetModal();

            document.getElementById('prod-id').value = p.id;
            document.getElementById('prod-name').value = p.name;
            document.getElementById('prod-code').value = p.code || '';
            document.getElementById('prod-stock').value = p.stock || 0;
            document.getElementById('prod-desc').value = p.desc || '';
            document.getElementById('prod-cost').value = p.cost || '';
            document.getElementById('prod-price').value = p.price || '';
            document.getElementById('prod-offer').value = p['price-oferta'] || '';

            // Imagens
            const container = document.getElementById('images-container');
            container.innerHTML = '';
            let imgs = [];
            if (p.imgUrl) imgs.push(p.imgUrl);
            for (let i = 1; i < 5; i++) if (p[`imgUrl${i}`]) imgs.push(p[`imgUrl${i}`]);

            imgs.forEach((url, idx) => createImgSlot(url, idx));
            createImgSlot(null, imgs.length);

            // Variantes (Linked)
            currentVariants = p.linkedVariants || [];
            renderAddedVariants();

            calculateFinancials();

            document.getElementById('modal-title').textContent = "Editar Produto";
            document.getElementById('btn-delete').style.display = 'block';
            document.getElementById('productModal').classList.add('open');
        }

        function resetModal() {
            document.getElementById('productForm').reset();
            document.getElementById('prod-id').value = '';
            document.getElementById('images-container').innerHTML = '';
            createImgSlot(null, 0);
            currentVariants = [];
            renderAddedVariants();

            // FORÇAR ABA DETALHES ATIVA
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-details').classList.add('active');
            document.querySelector('.tab-btn:first-child').classList.add('active');

            calculateFinancials();
        }

        // --- IMAGENS ---
        function createImgSlot(url, idx) {
            const div = document.createElement('div');
            div.className = 'img-slot';
            if (url) {
                div.innerHTML = `<img src="${url}"><div class="img-remove" onclick="removeImg(this)">x</div><input type="hidden" class="img-val" value="${url}">`;
            } else {
                div.innerHTML = `<i class='bx bx-camera' style="font-size:24px; color:#ccc;"></i><input type="file" style="display:none" accept="image/*" onchange="handleFile(this)">`;
                div.onclick = function (e) { if (e.target.tagName !== 'INPUT') this.querySelector('input').click(); }
            }
            document.getElementById('images-container').appendChild(div);
        }

        window.handleFile = (input) => {
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const slot = input.parentElement;
                slot.innerHTML = `<img src="${e.target.result}"><div class="img-remove" onclick="removeImg(this)">x</div><input type="hidden" class="img-val" value="${e.target.result}">`;
                slot.onclick = null;
                if (document.querySelectorAll('.img-slot').length < 5) createImgSlot(null, 0);
            }
            reader.readAsDataURL(input.files[0]);
        }
        window.removeImg = (el) => { el.parentElement.remove(); if (!document.querySelector('.img-slot input[type=file]')) createImgSlot(null, 0); }

        // --- CÁLCULO FINANCEIRO & PARCELAS ---
        window.calculateFinancials = () => {
            const price = parseFloat(document.getElementById('prod-price').value) || 0;
            const offer = parseFloat(document.getElementById('prod-offer').value) || 0;
            const finalPrice = (offer > 0 && offer < price) ? offer : price;

            // Regra de Parcelas
            let maxInst = 4;
            if (finalPrice >= 1000) maxInst = 12;
            else if (finalPrice >= 800) maxInst = 9;
            else if (finalPrice >= 625) maxInst = 8;
            else if (finalPrice >= 600) maxInst = 7;
            else if (finalPrice >= 300) maxInst = 6;
            else if (finalPrice >= 250) maxInst = 5;

            // Taxas Estimadas MP
            const rates = { 1: 0, 4: 7.33, 5: 8.66, 6: 9.96, 7: 11.5, 8: 12.8, 9: 13.6, 12: 16.9 };
            let instRate = rates[maxInst] || (maxInst * 1.4);
            let totalRate = 4.99 + instRate;

            let feeVal = finalPrice * (totalRate / 100);
            let net = finalPrice - feeVal;

            document.getElementById('sim-rule').textContent = `Até ${maxInst}x Sem Juros`;
            document.getElementById('sim-fee-percent').textContent = totalRate.toFixed(2) + '%';
            document.getElementById('sim-fee-val').textContent = `- ${feeVal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`;
            document.getElementById('sim-net').textContent = net.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // --- VARIAÇÕES (BUSCA) ---
        window.searchForVariants = (term) => {
            const resBox = document.getElementById('variant-results');
            if (term.length < 2) { resBox.style.display = 'none'; return; }

            const currentId = document.getElementById('prod-id').value;
            const matches = productsData.filter(p =>
                p.id !== currentId &&
                p.name.toLowerCase().includes(term.toLowerCase()) &&
                !currentVariants.some(v => v.id === p.id)
            );

            if (matches.length === 0) { resBox.style.display = 'none'; return; }

            resBox.innerHTML = '';
            matches.forEach(m => {
                const div = document.createElement('div');
                div.className = 'variant-result-item';
                div.innerHTML = `<img src="${m.imgUrl || ''}" style="width:30px;height:30px;border-radius:4px;"> <span>${m.name}</span>`;
                div.onclick = () => addVariant(m);
                resBox.appendChild(div);
            });
            resBox.style.display = 'block';
        }

        function addVariant(prod) {
            currentVariants.push({ id: prod.id, name: prod.name, img: prod.imgUrl });
            document.getElementById('variant-search').value = '';
            document.getElementById('variant-results').style.display = 'none';
            renderAddedVariants();
        }

        window.removeVariant = (idx) => {
            currentVariants.splice(idx, 1);
            renderAddedVariants();
        }

        function renderAddedVariants() {
            const list = document.getElementById('added-variants-list');
            list.innerHTML = '';
            if (currentVariants.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">Nenhuma variação adicionada.</div>';
                return;
            }
            currentVariants.forEach((v, idx) => {
                list.innerHTML += `
                    <div class="added-variant">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${v.img || ''}" style="width:40px;height:40px;border-radius:4px;object-fit:cover;">
                            <span style="font-size:0.9rem; font-weight:500;">${v.name}</span>
                        </div>
                        <i class='bx bx-trash' style="color:red; cursor:pointer;" onclick="removeVariant(${idx})"></i>
                    </div>
                `;
            });
        }

        // --- OFERTA RÁPIDA ---
        window.openOfferModal = function (e, id) {
            e.stopPropagation();
            const p = productsData.find(x => x.id === id);
            if (!p) return;

            document.getElementById('qo-id').value = p.id;
            document.getElementById('qo-name').textContent = p.name;
            document.getElementById('qo-img').src = p.imgUrl || 'https://placehold.co/50';
            document.getElementById('qo-original').textContent = parseFloat(p.price).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            const currentOffer = parseFloat(p['price-oferta'] || 0);
            const toggle = document.getElementById('qo-toggle');
            const input = document.getElementById('qo-price');

            if (currentOffer > 0 && currentOffer < parseFloat(p.price)) {
                toggle.checked = true;
                input.value = currentOffer;
            } else {
                toggle.checked = false;
                input.value = '';
            }

            toggleQuickOfferInputs();
            document.getElementById('offerModal').classList.add('open');
        }

        window.closeOfferModal = function () {
            document.getElementById('offerModal').classList.remove('open');
        }

        window.toggleQuickOfferInputs = function () {
            const checked = document.getElementById('qo-toggle').checked;
            const container = document.getElementById('qo-input-container');
            if (checked) {
                container.style.opacity = '1';
                container.style.pointerEvents = 'all';
            } else {
                container.style.opacity = '0.5';
                container.style.pointerEvents = 'none';
            }
        }

        window.saveQuickOffer = async function () {
            const id = document.getElementById('qo-id').value;
            const active = document.getElementById('qo-toggle').checked;
            const val = parseFloat(document.getElementById('qo-price').value);

            const p = productsData.find(x => x.id === id);
            if (active) {
                if (!val || val <= 0) return alert("Digite um valor válido");
                if (val >= parseFloat(p.price)) return alert("O valor da oferta deve ser menor que o original");
            }

            const newVal = active ? val : 0;

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'products', id), {
                    'price-oferta': newVal,
                    updatedAt: new Date().toISOString()
                });
                closeOfferModal();
            } catch (e) {
                console.error(e);
                alert("Erro ao salvar oferta.");
            }
        }

        // --- SALVAR PRINCIPAL ---
        window.submitProductForm = async () => {
            const btn = document.getElementById('btn-save');
            btn.textContent = "Salvando...";
            btn.disabled = true;

            try {
                const imgElements = document.querySelectorAll('.img-val');
                const images = Array.from(imgElements).map(el => el.value);

                const data = {
                    name: document.getElementById('prod-name').value,
                    code: document.getElementById('prod-code').value,
                    stock: parseInt(document.getElementById('prod-stock').value) || 0,
                    desc: document.getElementById('prod-desc').value,
                    cost: parseFloat(document.getElementById('prod-cost').value) || 0,
                    price: parseFloat(document.getElementById('prod-price').value) || 0,
                    'price-oferta': parseFloat(document.getElementById('prod-offer').value) || 0,
                    imgUrl: images[0] || '',
                    linkedVariants: currentVariants,
                    updatedAt: new Date().toISOString()
                };

                for (let i = 1; i < 5; i++) data[`imgUrl${i}`] = images[i] || '';

                const id = document.getElementById('prod-id').value;
                const col = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'products');

                if (id) await updateDoc(doc(col, id), data);
                else {
                    data.createdAt = new Date().toISOString();
                    await addDoc(col, data);
                }

                closeProductModal();
                alert("Salvo com sucesso!");
            } catch (e) {
                console.error(e);
                alert("Erro ao salvar.");
            } finally {
                btn.textContent = "Salvar";
                btn.disabled = false;
            }
        }

        window.deleteProduct = async () => {
            const id = document.getElementById('prod-id').value;
            if (confirm("Excluir permanentemente?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'products', id));
                closeProductModal();
            }
        }

        // --- SCANNER ---
        window.startScanner = () => {
            const vp = document.getElementById('scanner-viewport');
            vp.style.display = 'block';
            Quagga.init({ inputStream: { name: "Live", type: "LiveStream", target: vp }, decoder: { readers: ["ean_reader"] } }, (err) => {
                if (!err) Quagga.start();
            });
            Quagga.onDetected((res) => {
                document.getElementById('prod-code').value = res.codeResult.code;
                Quagga.stop();
                vp.style.display = 'none';
            });
        }

        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = productsData.filter(p => p.name.toLowerCase().includes(term) || (p.code && p.code.includes(term)));
            renderList(filtered);
        });

    </script>
</body>

</html>