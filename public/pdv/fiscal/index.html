<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiscal | PDV</title>
    <!-- Reutilizando estilos principais para manter identidade visual -->
    <link rel="stylesheet" href="../style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <!-- Bibliotecas para ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --btn-dark: #0f172a;
            --btn-dark-hover: #1e293b;
            --btn-outline: #ffffff;
            --btn-outline-border: #cbd5e1;
            --btn-outline-hover: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --warning-red: #ef4444;
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        body {
            background-color: var(--bg-body);
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        /* Fiscal Container */
        .fiscal-container {
            max-width: 1100px;
            margin: 40px auto;
            background: var(--bg-card);
            padding: 40px 48px;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: filter 0.3s ease;
        }

        /* Header */
        .header-fiscal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 32px;
        }

        .company-info h1 {
            font-size: 1.5rem;
            color: var(--text-main);
            margin: 0;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .company-info h2 {
            font-size: 0.95rem;
            color: var(--text-muted);
            margin: 6px 0 0;
            font-weight: 400;
        }

        .fiscal-info {
            text-align: right;
            background: #f8fafc;
            padding: 14px 20px;
            border-radius: 10px;
            border: 1px solid #f1f5f9;
        }

        .fiscal-info h3 {
            font-size: 1.1rem;
            color: var(--text-main);
            margin: 0;
            font-weight: 600;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            letter-spacing: -0.5px;
        }

        .fiscal-info p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin: 6px 0 0;
        }

        /* Controls */
        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f8fafc;
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .filter-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-main);
        }

        .month-select {
            padding: 8px 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95rem;
            min-width: 180px;
            background-color: var(--bg-card);
            color: var(--text-main);
            outline: none;
            transition: all 0.2s ease;
            cursor: pointer;
            font-weight: 500;
        }

        .month-select:focus {
            border-color: #94a3b8;
            box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.15);
        }

        .actions-group {
            display: flex;
            gap: 12px;
        }

        .btn-action {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            letter-spacing: -0.01em;
        }

        .btn-dark {
            background-color: var(--btn-dark);
            color: white;
            box-shadow: 0 2px 4px rgba(15, 23, 42, 0.1);
        }

        .btn-dark:hover {
            background-color: var(--btn-dark-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(15, 23, 42, 0.15);
        }

        .btn-dark:active {
            transform: translateY(0);
        }

        .btn-outline {
            background-color: var(--btn-outline);
            color: var(--text-main);
            border-color: var(--btn-outline-border);
            box-shadow: var(--shadow-sm);
        }

        .btn-outline:hover {
            background-color: var(--btn-outline-hover);
            border-color: #94a3b8;
        }

        .btn-icon-only {
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-main);
            cursor: pointer;
            transition: 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .btn-icon-only:hover {
            background: var(--btn-outline-hover);
            color: #0f172a;
            border-color: #94a3b8;
        }

        /* Table Structure */
        .table-responsive {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow-x: auto;
            background: var(--bg-card);
            box-shadow: var(--shadow-sm);
        }

        .fiscal-table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }

        .fiscal-table th,
        .fiscal-table td {
            padding: 16px 24px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .fiscal-table th {
            background-color: #f8fafc;
            font-weight: 500;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .fiscal-table tbody tr {
            transition: background-color 0.15s ease;
        }

        .fiscal-table tbody tr:hover {
            background-color: #f8fafc;
        }

        .fiscal-table tbody tr:last-child td {
            border-bottom: none;
        }

        .key-cell {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.85rem;
            color: var(--text-muted);
            letter-spacing: -0.02em;
        }

        .currency-cell {
            font-weight: 500;
            color: var(--text-main);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }

        /* Subtle Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-main);
        }

        .status-badge::before {
            content: '';
            display: block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .status-authorized::before {
            background-color: #10b981;
        }

        .status-rejected::before {
            background-color: #f43f5e;
        }

        .status-cancelled {
            color: var(--text-muted);
            text-decoration: line-through;
        }

        .status-cancelled::before {
            background-color: #94a3b8;
        }

        /* Summary */
        .summary-box {
            background: #f8fafc;
            padding: 24px 32px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: flex-end;
            margin-top: 32px;
            border: 1px solid var(--border-color);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            width: 340px;
            font-size: 0.95rem;
            color: var(--text-muted);
        }

        .summary-row span:last-child {
            color: var(--text-main);
            font-weight: 500;
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }

        .summary-row.total {
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            margin-top: 4px;
        }

        .summary-row.total span:first-child {
            font-weight: 600;
            color: var(--text-main);
            font-size: 1.1rem;
        }

        .summary-row.total span:last-child {
            font-weight: 600;
            font-size: 1.4rem;
            color: var(--text-main);
            letter-spacing: -0.02em;
        }

        .summary-row.projection span:last-child {
            color: var(--text-muted);
        }

        /* Modal Auth */
        #main-content.blurred {
            filter: blur(8px) grayscale(20%);
            pointer-events: none;
            user-select: none;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 40px;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalPop 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes modalPop {
            from {
                opacity: 0;
                transform: scale(0.96) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .auth-icon-wrapper {
            width: 56px;
            height: 56px;
            background: #f8fafc;
            color: #0f172a;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin: 0 auto 24px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .auth-title {
            font-size: 1.35rem;
            font-weight: 600;
            color: var(--text-main);
            margin: 0 0 8px;
            text-align: center;
            letter-spacing: -0.02em;
        }

        .auth-subtitle {
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 32px;
            font-size: 0.95rem;
        }

        .auth-input {
            width: 100%;
            box-sizing: border-box;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1.05rem;
            outline: none;
            transition: all 0.2s ease;
            text-align: center;
            letter-spacing: 3px;
            background: #f8fafc;
            font-weight: 500;
        }

        .auth-input:focus {
            border-color: #0f172a;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.1);
        }

        .auth-error {
            color: #ef4444;
            font-size: 0.85rem;
            text-align: center;
            margin-top: 12px;
            display: none;
            font-weight: 500;
        }

        .auth-actions {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }

        .btn-auth-confirm,
        .btn-auth-cancel {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-auth-confirm {
            background: var(--btn-dark);
            color: white;
            border: 1px solid var(--btn-dark);
            box-shadow: 0 2px 4px rgba(15, 23, 42, 0.1);
        }

        .btn-auth-confirm:hover {
            background: var(--btn-dark-hover);
            transform: translateY(-1px);
        }

        .btn-auth-cancel {
            background: white;
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }

        .btn-auth-cancel:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .empty-state {
            text-align: center;
            padding: 64px 24px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            display: block;
            color: #cbd5e1;
        }

        .shake {
            animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-3px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(3px, 0, 0);
            }
        }

        /* --- PRINT STYLES (A4 LANDSCAPE) CORRIGIDOS --- */
        @media print {
            @page {
                size: A4 landscape;
                margin: 1cm;
            }

            body {
                background-color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                margin: 0;
                padding: 0;
            }

            /* Esconde todos os elementos do nível do body exceto o main-content */
            body>*:not(#main-content) {
                display: none !important;
            }

            body>#main-content {
                display: block !important;
                visibility: visible !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
                max-width: none !important;
                width: 100% !important;
                filter: none !important;
                position: relative !important;
                left: 0 !important;
                top: 0 !important;
            }

            /* Esconde controles explicitamente */
            .controls-bar,
            #loading-spinner,
            #modal-admin-auth {
                display: none !important;
            }

            .header-fiscal {
                border-bottom: 2px solid #000;
                padding-bottom: 15px;
                margin-bottom: 25px;
            }

            .header-fiscal .fiscal-info {
                background: transparent !important;
                border: none !important;
                padding: 0 !important;
            }

            h1,
            h2,
            h3,
            p,
            th,
            td,
            span,
            div {
                color: black !important;
            }

            .fiscal-table th {
                background-color: transparent !important;
                border-bottom: 2px solid #000 !important;
                border-top: 1px solid #000 !important;
            }

            .fiscal-table td {
                border-bottom: 1px solid #ddd !important;
                padding: 8px 12px !important;
            }

            .table-responsive {
                border: none !important;
                box-shadow: none !important;
                overflow: visible !important;
            }

            #print-month-label {
                display: block !important;
                font-size: 1.1rem;
                margin-top: 8px;
                visibility: visible;
                font-weight: 600;
            }

            .status-badge {
                border: 1px solid #666 !important;
                box-shadow: none !important;
                background: transparent !important;
            }

            .status-authorized::before {
                background-color: #000 !important;
            }

            .status-rejected::before {
                background-color: #666 !important;
            }

            .status-cancelled::before {
                background-color: #ccc !important;
                text-decoration: none !important;
            }

            .summary-box {
                background: transparent !important;
                border: 1px solid #000 !important;
                padding: 15px 20px !important;
                margin-top: 25px !important;
                page-break-inside: avoid;
            }

            .summary-row.total span,
            .summary-row.projection span:last-child {
                color: #000 !important;
            }
        }
    </style>
</head>

<body>

    <!-- Modal de Autenticação -->
    <div id="modal-admin-auth" class="modal-overlay active">
        <div class="modal-content">
            <div class="modal-header auth-header">
                <div class="auth-icon-wrapper">
                    <i class='bx bxs-lock-alt'></i>
                </div>
            </div>
            <div class="modal-body">
                <h3 class="auth-title">Área Restrita</h3>
                <p class="auth-subtitle">Acesso aos dados fiscais.</p>

                <input type="password" id="admin-password-input" class="auth-input" placeholder="SENHA" autofocus
                    autocomplete="off">
                <p id="auth-error-msg" class="auth-error">Senha incorreta!</p>

                <div class="auth-actions">
                    <button id="btn-cancel-auth" class="btn-auth-cancel">Sair</button>
                    <button id="btn-confirm-auth" class="btn-auth-confirm">Acessar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="fiscal-container blurred" id="main-content">
        <div class="header-fiscal">
            <div class="company-info">
                <h1>A N F da Silva LTDA</h1>
                <h2>Dtudo Variedades & Utilidades</h2>
            </div>
            <div class="fiscal-info">
                <h3>45.692.327/0001-00</h3>
                <p>Inscrita sobre o CNPJ</p>
                <!-- Elemento extra para print mostrar o mês filtrado se o select sumir -->
                <p id="print-month-label" style="display:none; font-weight:bold; margin-top:5px;"></p>
            </div>
        </div>


        <div class="controls-bar">
            <div class="filter-group">
                <label for="month-filter">Mês</label>
                <select id="month-filter" class="month-select">
                    <!-- Opções geradas via JS -->
                </select>
                <button class="btn-icon-only" id="btn-refresh" title="Atualizar dados">
                    <i class='bx bx-refresh'></i>
                </button>
            </div>

            <div class="actions-group">
                <!-- Botão de Imprimir Adicionado -->
                <button class="btn-action btn-outline" id="btn-print" title="Imprimir Relatório (A4 Deitado)">
                    <i class='bx bx-printer'></i> Imprimir
                </button>

                <button class="btn-action btn-dark" id="btn-download-zip" title="Baixar todas as notas do mês em XML">
                    <i class='bx bx-download'></i> Baixar ZIP
                </button>
            </div>
        </div>

        <div class="table-responsive" style="margin-bottom: 20px;">
            <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--text-dark);">
                NF-e</h3>
            <table class="fiscal-table">
                <thead>
                    <tr>
                        <th width="35%">Chave NF-e</th>
                        <th width="15%">Emissão</th>
                        <th width="20%">Status</th>
                        <th width="15%">Número</th>
                        <th width="15%" style="text-align: right;">Valor (R$)</th>
                    </tr>
                </thead>
                <tbody id="fiscal-table-body-nfe">
                    <!-- Linhas geradas via JS -->
                </tbody>
            </table>
        </div>

        <div class="table-responsive">
            <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--text-dark);">
                NFC-e</h3>
            <table class="fiscal-table">
                <thead>
                    <tr>
                        <th width="35%">Chave NFC-e</th>
                        <th width="15%">Emissão</th>
                        <th width="20%">Status</th>
                        <th width="15%">Número</th>
                        <th width="15%" style="text-align: right;">Valor (R$)</th>
                    </tr>
                </thead>
                <tbody id="fiscal-table-body-nfce">
                    <!-- Linhas geradas via JS -->
                </tbody>
            </table>
            <div id="loading-spinner" style="display:none; text-align:center; padding: 20px;">
                <i class='bx bx-loader-alt bx-spin' style="font-size: 2rem; color: #666;"></i>
                <p style="color: #666; margin-top: 10px;">Buscando notas...</p>
                <small style="color:#999;">Carregando todas as notas da base unificada...</small>
            </div>
        </div>

        <div class="summary-box">
            <div class="summary-row" id="row-qtde-emitidas">
                <span>Notas Autorizadas:</span>
                <span id="qtde-emitidas">0</span>
            </div>
            <div class="summary-row" id="row-qtde-rejeitadas">
                <span>Notas Rejeitadas/Canceladas:</span>
                <span id="qtde-rejeitadas">0</span>
            </div>
            <div class="summary-row total">
                <span>Total NFC-e:</span>
                <span id="total-emitido-nfce">R$ 0,00</span>
            </div>
            <div class="summary-row total">
                <span>Total NF-e:</span>
                <span id="total-emitido-nfe">R$ 0,00</span>
            </div>
            <div class="summary-row total">
                <span>Total Geral Emitido:</span>
                <span id="total-emitido">R$ 0,00</span>
            </div>
            <div class="summary-row projection">
                <span>DAS Projeção (4%):</span>
                <span id="das-projection">R$ 0,00</span>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURAÇÃO
        const ADMIN_PASS = "ADM25-PASS"; // Senha identificada no sistema
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzB7dluoiNyJ4XK6oDK_iyuKZfwPTAJa4ua4RetQsUX9cMObgE-k_tFGI82HxW_OyMf/exec";
        const CENTRAL_API_URL = "https://script.google.com/macros/s/AKfycbyZtUsI44xA4MQQLZWJ6K93t6ZaSaN6hw7YQw9EclZG9E85kM6yOWQCQ0D-ZJpGmyq4/exec";
        const CURRENT_CNPJ = "45.692.327/0001-00";

        let ALL_FISCAL_NOTES = [];

        // ELEMENTOS
        const mainContent = document.getElementById('main-content');
        const modalAuth = document.getElementById('modal-admin-auth');
        const inputPass = document.getElementById('admin-password-input');
        const btnLogin = document.getElementById('btn-confirm-auth');
        const btnCancel = document.getElementById('btn-cancel-auth');
        const errorMsg = document.getElementById('auth-error-msg');

        const monthFilter = document.getElementById('month-filter');
        const loadingSpinner = document.getElementById('loading-spinner');
        const totalEl = document.getElementById('total-emitido');
        const dasEl = document.getElementById('das-projection');
        const btnDownload = document.getElementById('btn-download-zip');
        const btnPrint = document.getElementById('btn-print'); // Novo Botão
        const btnRefresh = document.getElementById('btn-refresh');
        const printMonthLabel = document.getElementById('print-month-label');

        // --- AUTH LOGIC ---
        function checkPassword() {
            if (inputPass.value === ADMIN_PASS) {
                modalAuth.classList.remove('active');
                mainContent.classList.remove('blurred');
                initSystem();
            } else {
                errorMsg.style.display = 'block';
                inputPass.classList.add('shake');
                inputPass.value = '';
                inputPass.focus();
                setTimeout(() => inputPass.classList.remove('shake'), 500);
            }
        }

        btnLogin.addEventListener('click', checkPassword);
        inputPass.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkPassword();
        });

        btnCancel.addEventListener('click', () => {
            window.location.href = '../index.html';
        });

        if (btnRefresh) {
            btnRefresh.addEventListener('click', () => {
                initSystem();
            });
        }

        if (btnPrint) {
            btnPrint.addEventListener('click', () => {
                // Atualiza label de mês para impressão
                const currentFilter = document.getElementById('month-filter');
                if (currentFilter && currentFilter.options[currentFilter.selectedIndex]) {
                    printMonthLabel.innerText = "Competência: " + currentFilter.options[currentFilter.selectedIndex].text;
                    printMonthLabel.style.display = 'block';
                }

                window.print();
            });
        }

        // --- SYSTEM LOGIC ---
        function formatCurrency(value) {
            return parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function formatDate(date) {
            if (!date) return '-';
            const d = new Date(date);
            if (isNaN(d.getTime())) return date;
            return d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        // Helper Parser Robusto
        function parseDate(dateStr) {
            if (!dateStr) return new Date();
            if (dateStr instanceof Date) return dateStr;

            // Se já for ISO
            let d = new Date(dateStr);
            if (!isNaN(d.getTime())) return d;

            // Tenta tratar formato PT-BR "DD/MM/YYYY às HH:MM:SS" ou similar
            if (typeof dateStr === 'string') {
                const cleanStr = dateStr.replace(' às ', ' ').trim();
                const parts = cleanStr.split(/[\/\-\s:]+/);

                if (parts.length >= 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    const hour = parts[3] ? parseInt(parts[3], 10) : 0;
                    const min = parts[4] ? parseInt(parts[4], 10) : 0;
                    const sec = parts[5] ? parseInt(parts[5], 10) : 0;

                    const newDate = new Date(year, month, day, hour, min, sec);
                    if (!isNaN(newDate.getTime())) return newDate;
                }
            }
            return new Date(); // Fallback
        }

        function getMonthLabel(date) {
            const d = new Date(date);
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            return `${monthNames[d.getMonth()]} ${d.getFullYear()}`;
        }

        function getMonthKey(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${d.getMonth()}`;
        }

        function extrairTagXML(xmlString, tag) {
            if (!xmlString || xmlString === "" || xmlString === "---") return null;
            const regex = new RegExp(`<${tag}>(.*?)<\/${tag}>`, 'i');
            const match = xmlString.match(regex);
            return match ? match[1] : null;
        }

        function initSystem() {
            fetchFiscalNotes();
        }

        async function fetchFiscalNotes() {
            document.getElementById('fiscal-table-body-nfce').innerHTML = '';
            document.getElementById('fiscal-table-body-nfe').innerHTML = '';
            loadingSpinner.style.display = 'block';

            try {
                // Fetch de ambas as APIs em paralelo
                const pOld = fetch(`${SCRIPT_URL}?action=listarNotasFiscais&offlimite=true`).then(r => r.json()).catch(e => ({ status: 'error', data: [] }));
                const pNew = fetch(`${CENTRAL_API_URL}?action=listar_notas_fiscais`).then(r => r.json()).catch(e => ({ success: false, data: [] }));

                const [resOld, resNew] = await Promise.all([pOld, pNew]);

                let combinedArray = [];

                if (resOld.status === 'success' && Array.isArray(resOld.data)) {
                    combinedArray = combinedArray.concat(resOld.data.map(item => ({
                        ...item,
                        modelo: "NFC-e", // Api antiga não tinha isso muito claro, mas geralmente é NFC-e
                        isNew: false
                    })));
                }

                if (resNew.success && Array.isArray(resNew.data)) {
                    combinedArray = combinedArray.concat(resNew.data.map(item => ({
                        ...item,
                        nNF: item.nNF || item.numeroNota, // Mapeamento
                        isNew: true
                    })));
                }

                // Deduplicação favorecendo API Nova (api de transição)
                const dedupMap = new Map();
                let duplicadasDetalhadas = [];

                for (const note of combinedArray) {
                    let key = "";

                    // Preferência 1: idVenda (único por transação, agrupa tentativas na mesma venda)
                    if (note.idVenda && String(note.idVenda).trim() !== '' && note.idVenda !== '---') {
                        key = "id_" + String(note.idVenda).trim();
                    }
                    // Preferência 2: Uma chave SEFAZ real (exatamente 44 caracteres)
                    else if (note.chave && typeof note.chave === 'string' && note.chave.trim().length === 44) {
                        key = "chave_" + note.chave.trim();
                    }
                    // Preferência 3: nNF válido
                    else if (note.nNF && note.nNF !== '---' && String(note.nNF).trim() !== '' && note.nNF !== '0') {
                        key = "nnf_" + String(note.nNF).trim();
                    }
                    // Fallback seguro: aleatório
                    else {
                        key = "rnd_" + Math.random().toString();
                    }

                    if (dedupMap.has(key) && !key.startsWith('rnd_')) {
                        const existing = dedupMap.get(key);
                        let docRef = String(key).replace('id_', 'ID_Venda: ').replace('chave_', 'Chave: ').replace('nnf_', 'NF: ');

                        // Queremos manter a mais atual/apropriada.
                        const newIsAuto = (note.status || '').toLowerCase().includes('autorizada') || (note.status || '').toLowerCase() === 'aprovada';
                        const extIsAuto = (existing.status || '').toLowerCase().includes('autorizada') || (existing.status || '').toLowerCase() === 'aprovada';

                        let replace = false;
                        if (newIsAuto && !extIsAuto) {
                            replace = true; // Uma nota autorizada sobrescreve uma rejeitada de mesmo idVenda
                        } else if (!newIsAuto && extIsAuto) {
                            replace = false; // Não sobrescreve autorizada com rejeitada
                        } else if (note.isNew && !existing.isNew) {
                            replace = true; // Ambas em mesmo estado -> prefere a Nova API
                        } else {
                            replace = true; // Mesma API -> a mais recente prevalece
                        }

                        // Apenas log de debug sem exibir mensagem confusa de 'duplicada' pro usuário.
                        // duplicadasDetalhadas.push(`Processada Atualização [${docRef}] - Feita por: [${replace ? (note.isNew ? 'NewAPI' : 'OldAPI') : (existing.isNew ? 'NewAPI' : 'OldAPI')}]`);

                        if (replace) {
                            dedupMap.set(key, note);
                        }
                    } else {
                        dedupMap.set(key, note);
                    }
                }

                const finalData = Array.from(dedupMap.values());
                console.log(`Recebidas ${finalData.length} notas processadas após junção.`);
                /*
                // Log comentado pois são retentativas idVenda naturais do sistema e não erro crítico.
                if (duplicadasDetalhadas.length > 0) {
                    console.log(`Acompanhamento de retentativas idVenda e migração:`);
                    console.log(duplicadasDetalhadas.join("\\n"));
                }
                */

                ALL_FISCAL_NOTES = finalData.map(item => {
                    const valorXML = extrairTagXML(item.xml, "vNF");
                    const valor = valorXML ? parseFloat(valorXML) : (parseFloat(item.total) || parseFloat(item.valor) || 0);
                    const dateObj = parseDate(item.timestamp);
                    let modRaw = item.modelo || "NFC-e";
                    let mod = String(modRaw).trim().toUpperCase();
                    if (mod === "55") mod = "NF-E";

                    return {
                        id: item.idVenda || item.id || Math.random().toString(),
                        chave: item.chave || 'SEM CHAVE',
                        emissao: dateObj,
                        modelo: mod,
                        cnpj: CURRENT_CNPJ,
                        numero: item.nNF || extrairTagXML(item.xml, "nNF") || '---',
                        valor: valor,
                        xml: item.xml || '',
                        status: item.status || 'Desconhecido'
                    };
                });

                populateFilter();
                renderTable();

            } catch (error) {
                console.error("Erro ao buscar notas:", error);
                document.getElementById('fiscal-table-body-nfce').innerHTML = `<tr>
                    <td colspan="5" style="text-align:center; padding: 20px;">
                        <span style="color:var(--warning-red); display:block; margin-bottom:10px; font-weight:bold;">
                            <i class='bx bx-error'></i> Falha ao carregar Notas
                        </span>
                        <small style="color:#666;">${error.message}</small>
                    </td>
                </tr>`;
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function populateFilter() {
            const currentFilter = document.getElementById('month-filter');
            if (ALL_FISCAL_NOTES.length === 0) {
                const now = new Date();
                const currentKey = `${now.getFullYear()}-${now.getMonth()}`;
                currentFilter.innerHTML = `<option value="${currentKey}">${getMonthLabel(now)}</option>`;
                return;
            }

            const uniqueMonths = new Set();
            ALL_FISCAL_NOTES.forEach(item => {
                if (item.emissao && !isNaN(item.emissao.getTime())) {
                    uniqueMonths.add(getMonthKey(item.emissao));
                }
            });

            const monthsArr = Array.from(uniqueMonths).sort((a, b) => {
                const [yA, mA] = a.split('-').map(Number);
                const [yB, mB] = b.split('-').map(Number);
                if (yA !== yB) return yB - yA;
                return mB - mA;
            });

            const currentSelection = currentFilter.value;

            currentFilter.innerHTML = '';
            monthsArr.forEach(key => {
                const [y, m] = key.split('-');
                const option = document.createElement('option');
                option.value = key;
                const dateObj = new Date(y, m, 1);
                option.textContent = getMonthLabel(dateObj);
                currentFilter.appendChild(option);
            });

            if (currentSelection && monthsArr.includes(currentSelection)) {
                currentFilter.value = currentSelection;
            } else if (monthsArr.length > 0) {
                currentFilter.value = monthsArr[0];
            }

            const newFilter = currentFilter.cloneNode(true);
            currentFilter.parentNode.replaceChild(newFilter, currentFilter);
            newFilter.addEventListener('change', () => renderTable());

            renderTable();
        }

        function renderTable() {
            const filterEl = document.getElementById('month-filter');
            const selectedKey = filterEl.value;
            if (!selectedKey) return;

            const [selYear, selMonth] = selectedKey.split('-').map(Number);

            // Atualiza label oculta para impressao
            if (printMonthLabel) {
                printMonthLabel.innerText = "Mês de Referência: " + getMonthLabel(new Date(selYear, selMonth, 1));
            }

            const filteredData = ALL_FISCAL_NOTES.filter(item => {
                if (!item.emissao || isNaN(item.emissao.getTime())) return false;
                return item.emissao.getFullYear() === selYear && item.emissao.getMonth() === selMonth;
            });

            filteredData.sort((a, b) => b.emissao - a.emissao);

            const tbodyNfce = document.getElementById('fiscal-table-body-nfce');
            const tbodyNfe = document.getElementById('fiscal-table-body-nfe');
            tbodyNfce.innerHTML = '';
            tbodyNfe.innerHTML = '';

            let totalGeneral = 0;
            let totalNfce = 0;
            let totalNfe = 0;
            let qtdeEmitidas = 0;
            let qtdeRejeitadas = 0;

            if (filteredData.length === 0) {
                tbodyNfce.innerHTML = `<tr><td colspan="5" class="empty-state"><i class='bx bx-search'></i> Nenhuma NFC-e encontrada neste mês.</td></tr>`;
                tbodyNfe.innerHTML = `<tr><td colspan="5" class="empty-state"><i class='bx bx-search'></i> Nenhuma NF-e encontrada neste mês.</td></tr>`;
                btnDownload.disabled = true;
                btnDownload.style.opacity = 0.5;
            } else {
                btnDownload.disabled = false;
                btnDownload.style.opacity = 1;

                let countNfce = 0;
                let countNfe = 0;

                filteredData.forEach(item => {
                    const tr = document.createElement('tr');

                    let statusClass = 'status-badge';
                    let statusText = item.status || '';
                    if (statusText.toLowerCase().includes('autorizada') || statusText.toLowerCase() === 'aprovada' || statusText.toLowerCase() === 'emitida') {
                        statusClass += ' status-authorized';
                        totalGeneral += item.valor;
                        if (item.modelo === 'NF-E' || item.modelo === '55') totalNfe += item.valor;
                        else totalNfce += item.valor;
                        qtdeEmitidas++;
                    }
                    else if (statusText.toLowerCase().includes('cancelada')) {
                        statusClass += ' status-cancelled';
                        qtdeRejeitadas++;
                    }
                    else if (statusText.toLowerCase().includes('erro') || statusText.toLowerCase().includes('rejeit')) {
                        statusClass += ' status-rejected';
                        qtdeRejeitadas++;
                    }
                    else {
                        statusClass += ' status-rejected'; // Garante que desconhecidos também tenham cor
                        qtdeRejeitadas++;
                    }

                    tr.innerHTML = `
                        <td class="key-cell" title="${item.chave}">${item.chave}</td>
                        <td>${formatDate(item.emissao)}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td>${item.numero}</td>
                        <td class="currency-cell" style="text-align: right;">${formatCurrency(item.valor)}</td>
                    `;

                    if (item.modelo === 'NF-E' || item.modelo === '55') {
                        tbodyNfe.appendChild(tr);
                        countNfe++;
                    } else {
                        tbodyNfce.appendChild(tr);
                        countNfce++;
                    }
                });

                if (countNfce === 0) tbodyNfce.innerHTML = `<tr><td colspan="5" class="empty-state">Nenhuma NFC-e neste mês.</td></tr>`;
                if (countNfe === 0) tbodyNfe.innerHTML = `<tr><td colspan="5" class="empty-state">Nenhuma NF-e neste mês.</td></tr>`;
            }

            const dasProj = totalGeneral * 0.04;
            totalEl.innerText = formatCurrency(totalGeneral);
            if (document.getElementById('total-emitido-nfce')) document.getElementById('total-emitido-nfce').innerText = formatCurrency(totalNfce);
            if (document.getElementById('total-emitido-nfe')) document.getElementById('total-emitido-nfe').innerText = formatCurrency(totalNfe);
            dasEl.innerText = formatCurrency(dasProj);
            if (document.getElementById('qtde-emitidas')) document.getElementById('qtde-emitidas').innerText = qtdeEmitidas;
            if (document.getElementById('qtde-rejeitadas')) document.getElementById('qtde-rejeitadas').innerText = qtdeRejeitadas;
        }

        btnDownload.addEventListener('click', () => {
            const filterEl = document.getElementById('month-filter');
            const selectedKey = filterEl.value;
            const [selYear, selMonth] = selectedKey.split('-').map(Number);

            const filteredData = ALL_FISCAL_NOTES.filter(item => {
                if (!item.emissao || isNaN(item.emissao.getTime())) return false;
                return item.emissao.getFullYear() === selYear && item.emissao.getMonth() === selMonth;
            });

            if (filteredData.length === 0) return;

            const zip = new JSZip();
            const baseFolderName = `Notas_${getMonthLabel(new Date(selYear, selMonth, 1)).replace(/ /g, '_')}`;
            const folderNfce = zip.folder(`${baseFolderName}/NFC-e`);
            const folderNfe = zip.folder(`${baseFolderName}/NF-e`);

            let count = 0;
            filteredData.forEach(item => {
                if (item.xml && item.xml.length > 50) {
                    if (item.modelo === 'NF-E' || item.modelo === '55') {
                        folderNfe.file(`NFe_${item.chave}.xml`, item.xml);
                    } else {
                        folderNfce.file(`NFCe_${item.chave}.xml`, item.xml);
                    }
                    count++;
                }
            });

            if (count === 0) {
                alert("As notas listadas não possuem XML armazenado (apenas registro de valor).");
                return;
            }

            const originalText = btnDownload.innerHTML;
            btnDownload.innerHTML = `<i class='bx bx-loader-alt bx-spin'></i> Gerando ZIP...`;

            zip.generateAsync({ type: "blob" }).then(function (content) {
                saveAs(content, `Notas_Fiscais_${selYear}_${selMonth + 1}.zip`);
                btnDownload.innerHTML = originalText;
            });
        });

    </script>
</body>

</html>