<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conferência de Estoque - ELETRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bibliotecas para geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .success-bg {
            background-color: #f0fdf4 !important;
        }

        .warning-bg {
            background-color: #fffbeb !important;
        }

        .sent-row {
            opacity: 0.8;
            background-color: #f8fafc;
            border-left: 4px solid #cbd5e1;
        }

        .loader {
            border-top-color: #3b82f6;
            animation: spinner 0.6s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .btn-confirm {
            transition: all 0.2s ease;
        }

        .btn-confirm:disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .btn-confirm:not(:disabled) {
            background-color: #2563eb;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }

        .btn-confirm:not(:disabled):hover {
            background-color: #1d4ed8;
            transform: translateY(-1px);
        }

        #initial-loader {
            backdrop-filter: blur(4px);
            transition: opacity 0.5s ease-out;
        }

        .financial-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <!-- Loader Inicial -->
    <div id="initial-loader"
        class="fixed inset-0 bg-white/90 z-[100] flex flex-col items-center justify-center text-center p-6">
        <div class="loader w-12 h-12 border-4 border-gray-200 border-t-blue-600 rounded-full mb-4"></div>
        <h2 class="text-lg font-bold text-gray-800">Sincronizando por Nome...</h2>
        <p class="text-sm text-gray-500 max-w-xs">Vinculando itens da matriz com os dados da planilha usando o nome do
            produto.</p>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-check-double text-blue-600"></i>
                        Conferência e Registro
                    </h1>
                    <p class="text-gray-500 text-sm">Busca baseada no <b>Nome do Produto</b> (chave primária).</p>
                </div>

                <div class="flex items-center gap-3">
                    <div class="relative w-full max-w-md">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" id="mainSearch" onkeyup="filterItems()"
                            class="block w-full pl-10 pr-3 py-2.5 border border-gray-200 rounded-xl bg-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm transition-all"
                            placeholder="Pesquisar por nome ou código...">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadReport()" title="Baixar Relatório PDF"
                            class="w-10 h-10 flex items-center justify-center bg-white border border-gray-200 text-gray-400 rounded-xl hover:text-red-600 transition-colors shadow-sm">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                        <button onclick="toggleConfig()" title="Importar/Copiar Dados"
                            class="w-10 h-10 flex items-center justify-center bg-white border border-gray-200 text-gray-400 rounded-xl hover:text-blue-600 transition-colors shadow-sm">
                            <i class="fas fa-database"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Config Section -->
        <div id="configSection"
            class="hidden mb-8 bg-white p-6 rounded-2xl border-2 border-dashed border-gray-200 animate-in fade-in zoom-in duration-300">
            <h3 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
                <i class="fas fa-file-csv text-emerald-600"></i>
                Importar Dados CSV
            </h3>
            <p class="text-xs text-gray-500 mb-4">Cole os dados do seu arquivo. O Nome será usado como chave de busca.
            </p>
            <textarea id="csvInput" rows="5"
                class="w-full p-4 text-xs font-mono bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none mb-4"
                placeholder='Codigo_Barras_NCM;Produto;Fator;Qtd_Real;Val_Unit_NF;Encargos;Custo_Unit_Real;Venda_Sugerida'></textarea>
            <div class="flex justify-between items-center">
                <div id="copyActionArea" class="hidden">
                    <button onclick="copyFormattedData()"
                        class="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 text-xs font-bold rounded-lg hover:bg-blue-100 transition-all border border-blue-200">
                        <i class="fas fa-copy"></i> Copiar para Banco de Dados
                    </button>
                </div>
                <div class="flex justify-end gap-2 ml-auto">
                    <button onclick="toggleConfig()" class="px-4 py-2 text-sm font-bold text-gray-500">Fechar</button>
                    <button onclick="processCSV()"
                        class="px-6 py-2 bg-emerald-600 text-white text-sm font-bold rounded-xl hover:bg-emerald-700 transition-all shadow-sm">Processar
                        e Atualizar</button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Pendentes</p>
                <h3 class="text-2xl font-black text-gray-800" id="statPending">0</h3>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-b-4 border-b-emerald-500">
                <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Enviados</p>
                <h3 class="text-2xl font-black text-emerald-600" id="statSent">0</h3>
            </div>
        </div>

        <!-- Tabela Principal -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden mb-8">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
                <h2 class="text-sm font-bold text-gray-700 uppercase tracking-wider">Itens em Conferência</h2>
                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-[10px] font-bold rounded italic">BUSCA POR NOME
                    ATIVA</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-separate border-spacing-0">
                    <thead class="bg-gray-50 text-gray-400 text-[10px] uppercase font-black sticky top-0 z-10">
                        <tr>
                            <th class="px-6 py-4">Produto</th>
                            <th class="px-4 py-4 text-center">Fator / Qtd</th>
                            <th class="px-4 py-4">Cód. Esperado (CSV)</th>
                            <th class="px-4 py-4">Bipar / Novo Código</th>
                            <th class="px-4 py-4 text-center">Precificação</th>
                            <th class="px-6 py-4 text-center">Confirmar</th>
                        </tr>
                    </thead>
                    <tbody id="pendingTableBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>

        <!-- Histórico -->
        <!--
        <div class="flex items-center gap-4 mb-6">
            <div class="flex-1 h-px bg-gray-300"></div>
            <div class="flex flex-col items-center gap-2 text-center">
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Já Registrados na Planilha</span>
                <button onclick="updateAllSentItems()" class="px-4 py-2 bg-white border-2 border-amber-400 text-amber-600 text-[10px] font-black rounded-xl hover:bg-amber-50 transition-all flex items-center gap-2 shadow-md group">
                    <i class="fas fa-sync-alt group-hover:rotate-180 transition-transform duration-500"></i> ATUALIZAR DADOS DOS REGISTRADOS
                </button>
            </div>
            <div class="flex-1 h-px bg-gray-300"></div>
        </div>
        -->

        <div class="bg-white/50 rounded-2xl border border-gray-200 overflow-hidden shadow-inner">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <tbody id="sentTableBody" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação Detalhada -->
    <div id="confirmChangesModal" class="fixed inset-0 bg-black/60 hidden z-[110] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-8 shadow-2xl text-center">
            <div
                class="w-16 h-16 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fas fa-edit"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Confirmar Alterações?</h3>
            <p id="modalDescription" class="text-gray-600 text-sm mb-6">O sistema identificou mudanças para este
                produto:</p>

            <div id="modalSummary"
                class="bg-gray-50 rounded-xl p-4 mb-6 text-left text-xs space-y-2 border border-gray-200"></div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeChangesModal()"
                    class="py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition-colors">Cancelar</button>
                <button id="finalConfirmBtn"
                    class="py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors">Confirmar
                    e Enviar</button>
            </div>
        </div>
    </div>

    <!-- Toast de Feedback -->
    <div id="loadingToast"
        class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-4 opacity-0 pointer-events-none transition-all duration-300 z-50">
        <div id="toastLoader" class="loader w-5 h-5 border-3 border-white/30 border-t-white rounded-full"></div>
        <i id="toastIcon" class="fas fa-check-circle text-emerald-400 hidden"></i>
        <span id="toastText" class="text-sm font-bold">Processando...</span>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzB7dluoiNyJ4XK6oDK_iyuKZfwPTAJa4ua4RetQsUX9cMObgE-k_tFGI82HxW_OyMf/exec";

        const INITIAL_CSV = `Codigo_Barras_NCM;Produto;Fator;Qtd_Real;Val_Unit_NF;Encargos;Custo_Unit_Real;Venda_Sugerida
"76151000";"FRIGIDEIRA ALUM AA 20CM 800ML TURIM VERMELHA 20260/720";"1";"1";"R$ 29,95";"R$ 0,00";"R$ 29,95";"R$ 59,90"
"48202000";"CAD C/D COLEGIAL C/AD 15M 240F ITS LOVE";"2";"1";"R$ 63,90";"R$ 0,00";"R$ 31,95";"R$ 49,90"
"48202000";"CAD C/D COLEGIAL C/AD 15M 240F CUTE CAT";"2";"1";"R$ 63,90";"R$ 0,00";"R$ 31,95";"R$ 49,90"
"39249000";"MAMADEIRA MASTER 240ML LISA 230 ";"10";"1";"R$ 49,95";"R$ 0,00";"R$ 4,995";"R$ 9,99"
"39241000";"PA DE LIXO GRANDE 0045 ";"1";"12";"R$ 4,95";"R$ 0,00";"R$ 4,95";"R$ 9,99"
"70133700";"COPO PROSA 300ML 7771/9643";"24";"1";"R$ 89,90";"R$ 0,00";"R$ 3,746";"R$ 6,50"
"48201000";"CADERNO DISCO INTELIGENTE 20X26CM 80F WPS20011";"1";"1";"R$ 39,95";"R$ 0,00";"R$ 39,95";"R$ 59,90"
"48201000";"CADERNO DISCO INTELIGENTE 20X26CM 80F WPS20010";"1";"1";"R$ 39,95";"R$ 0,00";"R$ 39,95";"R$ 59,90"
"48201000";"REFIL COM PAUTA P/ CADERNO DISCO INT. 25X18.5CM 50F WPS3000";"1";"5";"R$ 13,28";"R$ 0,00";"R$ 13,28";"R$ 19,99"
"48202000";"CAD C/D UNIV C/AD 15M 240F PAMPY";"2";"1";"R$ 76,50";"R$ 0,00";"R$ 38,25";"R$ 60,00"
`;

        let itemsState = [];

        window.onload = async () => {
            document.getElementById('csvInput').value = INITIAL_CSV;
            await processCSV(true);
        };

        async function processCSV(isInitial = false) {
            const raw = document.getElementById('csvInput').value;
            if (!raw) return;

            const lines = raw.trim().split('\n');
            const newDatabase = [];

            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(';');
                if (parts.length < 8) continue;

                const clean = (str) => str.replace(/"/g, '').trim();
                const parseMoney = (str) => parseFloat(clean(str).replace('R$', '').replace('.', '').replace(',', '.')) || 0;

                const id = clean(parts[0]);
                const produto = clean(parts[1]);
                const fator = clean(parts[2]);
                const qtdReal = clean(parts[3]);
                const custo = parseMoney(parts[6]);
                const venda = parseMoney(parts[7]);

                newDatabase.push({
                    id, ncm: detectNCM(produto, id), produto, fator, qtdReal, custo, venda, brand: detectBrand(produto),
                    sent: false,
                    currentInput: '',
                    newPrice: venda,
                    remotePrice: null
                });
            }

            itemsState = newDatabase;
            if (isInitial) {
                await syncWithAPI();
                const loader = document.getElementById('initial-loader');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.classList.add('hidden'), 500);
                }
                renderLists();
            } else {
                renderLists();
                showSuccessToast("Lista Processada!");
            }
        }

        async function syncWithAPI() {
            try {
                const response = await fetch(`${API_URL}?action=getProducts`);
                const result = await response.json();
                if (Array.isArray(result)) {
                    // CHAVE DE BUSCA AGORA É O NOME (case-insensitive)
                    const remoteDataByName = {};
                    result.forEach(p => {
                        if (p.name) remoteDataByName[String(p.name).trim().toUpperCase()] = p;
                    });

                    itemsState.forEach(item => {
                        const normalizedLocalName = String(item.produto).trim().toUpperCase();
                        const remoteMatch = remoteDataByName[normalizedLocalName];

                        if (remoteMatch) {
                            item.sent = true;
                            item.remotePrice = remoteMatch.price;
                            // Preenche o código que já está na planilha como o input atual
                            item.currentInput = String(remoteMatch.id || '');
                        }
                    });
                }
            } catch (error) { console.warn("API de consulta offline."); }
        }

        function renderLists() {
            const pendingBody = document.getElementById('pendingTableBody');
            const sentBody = document.getElementById('sentTableBody');
            if (!pendingBody || !sentBody) return;

            pendingBody.innerHTML = ''; sentBody.innerHTML = '';
            let countSent = 0; let countPending = 0;

            itemsState.forEach((item, index) => {
                if (item.sent) {
                    countSent++;
                    sentBody.innerHTML += `
                        <tr class="sent-row text-xs text-slate-500">
                            <td class="px-6 py-4 font-bold w-1/3 leading-tight">${item.produto}</td>
                            <td class="px-4 py-4 text-center">${item.fator} | ${item.qtdReal}</td>
                            <td class="px-4 py-4 font-mono">${item.id}</td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex flex-col items-end gap-1">
                                    <span class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full font-bold text-[9px] uppercase">Registrado</span>
                                    <span class="text-[8px] text-slate-400 font-bold">Planilha: R$ ${parseFloat(item.remotePrice || 0).toFixed(2)}</span>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    countPending++;
                    const markup = (((item.newPrice - item.custo) / (item.custo || 1)) * 100).toFixed(1);

                    pendingBody.innerHTML += `
                        <tr id="row-${index}" class="bg-white transition-all duration-300">
                            <td class="px-6 py-5">
                                <p class="text-sm font-bold text-gray-800 leading-tight">${item.produto}</p>
                                <div class="flex gap-2 mt-1">
                                    <span class="text-[9px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded font-bold uppercase">NCM: ${item.ncm}</span>
                                    <span class="text-[9px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-bold uppercase">${item.brand}</span>
                                </div>
                            </td>
                            <td class="px-4 py-5 text-center text-sm font-medium text-gray-500">${item.fator} | <span class="font-black text-gray-700">${item.qtdReal}</span></td>
                            <td class="px-4 py-5 text-xs font-mono text-gray-400">${item.id}</td>
                            <td class="px-4 py-5">
                                <div class="relative barcode-container">
                                    <input type="text" value="${item.currentInput}" oninput="updateInput(${index}, this.value)" placeholder="Bipe ou digite..." 
                                        class="barcode-input w-full text-xs font-bold p-3 border-2 border-gray-100 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 focus:outline-none transition-all">
                                </div>
                            </td>
                            <td class="px-4 py-5">
                                <div id="pricing-wrapper-${index}" class="invisible flex flex-col gap-2 min-w-[150px]">
                                    <div class="flex items-center gap-2">
                                        <span class="text-[9px] font-bold text-gray-400 uppercase">Venda:</span>
                                        <input type="number" step="0.01" value="${item.newPrice}" oninput="updatePrice(${index}, this.value)" 
                                            class="w-20 text-xs font-black p-1 border-b-2 border-blue-200 focus:border-blue-600 outline-none bg-transparent">
                                    </div>
                                    <div class="flex flex-wrap gap-1">
                                        <span class="financial-badge bg-gray-100 text-gray-600">Custo: R$ ${item.custo.toFixed(2)}</span>
                                        <span id="markup-badge-${index}" class="financial-badge bg-blue-100 text-blue-700">Mkup: ${markup}%</span>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-5 text-center">
                                <button id="confirm-btn-${index}" onclick="handleConfirmClick(${index})" disabled class="btn-confirm w-12 h-12 rounded-xl flex items-center justify-center text-lg shadow-sm">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }
            });
            document.getElementById('statPending').innerText = countPending;
            document.getElementById('statSent').innerText = countSent;
        }

        // Lógica de atualização direta para manter foco do leitor
        function updateInput(index, val) {
            const item = itemsState[index];
            item.currentInput = val.trim();

            const row = document.getElementById(`row-${index}`);
            if (!row) return;

            const input = row.querySelector('.barcode-input');
            const container = row.querySelector('.barcode-container');
            const pricingWrapper = document.getElementById(`pricing-wrapper-${index}`);
            const confirmBtn = document.getElementById(`confirm-btn-${index}`);

            const hasInput = item.currentInput.length > 0;
            const isCorrectCode = item.currentInput === item.id;

            row.classList.remove('success-bg', 'warning-bg', 'bg-white');
            if (hasInput) {
                row.classList.add(isCorrectCode ? 'success-bg' : 'warning-bg');
            } else {
                row.classList.add('bg-white');
            }

            input.classList.remove('border-emerald-500', 'border-amber-400', 'border-gray-100');
            if (hasInput) {
                input.classList.add(isCorrectCode ? 'border-emerald-500' : 'border-amber-400');
            } else {
                input.classList.add('border-gray-100');
            }

            let icon = container.querySelector('i');
            if (hasInput) {
                if (!icon) {
                    icon = document.createElement('i');
                    icon.className = "absolute right-3 top-1/2 -translate-y-1/2 text-lg";
                    container.appendChild(icon);
                }
                icon.className = `absolute right-3 top-1/2 -translate-y-1/2 text-lg ${isCorrectCode ? 'fas fa-check-circle text-emerald-500' : 'fas fa-exchange-alt text-amber-500'}`;
            } else if (icon) {
                icon.remove();
            }

            if (hasInput) {
                pricingWrapper.classList.remove('invisible');
                confirmBtn.disabled = false;
            } else {
                pricingWrapper.classList.add('invisible');
                confirmBtn.disabled = true;
            }
        }

        function updatePrice(index, value) {
            const item = itemsState[index];
            item.newPrice = parseFloat(value) || 0;
            const badge = document.getElementById(`markup-badge-${index}`);
            if (badge) {
                const markup = (((item.newPrice - item.custo) / (item.custo || 1)) * 100).toFixed(1);
                badge.innerText = `Mkup: ${markup}%`;
            }
        }

        function handleConfirmClick(index) {
            const item = itemsState[index];
            const priceChanged = Math.abs(item.newPrice - item.venda) > 0.001;
            const codeChanged = item.currentInput !== item.id;

            if (priceChanged || codeChanged) {
                showChangesModal(index, priceChanged, codeChanged);
            } else {
                sendItemToAPI(index);
            }
        }

        function showChangesModal(index, priceChanged, codeChanged) {
            const item = itemsState[index];
            const summary = document.getElementById('modalSummary');
            summary.innerHTML = '';

            if (codeChanged) {
                summary.innerHTML += `
                    <div class="flex justify-between items-center text-amber-700">
                        <span>Código Original (CSV):</span> <span class="font-mono">${item.id}</span>
                    </div>
                    <div class="flex justify-between items-center text-amber-700 font-bold">
                        <span>Novo Código Planilha:</span> <span class="font-mono">${item.currentInput}</span>
                    </div>
                    <hr class="border-amber-100">
                `;
            }

            if (priceChanged) {
                summary.innerHTML += `
                    <div class="flex justify-between items-center text-blue-700">
                        <span>Preço Original:</span> <span>R$ ${item.venda.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-blue-700 font-bold">
                        <span>Novo Preço:</span> <span>R$ ${item.newPrice.toFixed(2)}</span>
                    </div>
                `;
            }

            document.getElementById('confirmChangesModal').classList.remove('hidden');
            document.getElementById('finalConfirmBtn').onclick = () => {
                closeChangesModal();
                sendItemToAPI(index);
            };
        }

        async function sendItemToAPI(index) {
            const item = itemsState[index];
            showToast("Enviando...");
            const payload = {
                action: "saveProduct",
                data: {
                    id: String(item.currentInput),
                    name: String(item.produto),
                    price: Number(item.newPrice),
                    costPrice: Number(item.custo),
                    ncm: String(item.ncm),
                    brand: String(item.brand),
                    unit: String(item.fator),
                    category: "Material Escolar",
                    cadastrado: "Sim",
                    cfop: "5102",
                    origem: "0",
                    csosn: "102"
                }
            };
            try {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                itemsState[index].sent = true;
                itemsState[index].remotePrice = item.newPrice;
                renderLists();
                showSuccessToast("Registrado!");
            } catch (error) { console.error("Erro no envio:", error); }
            finally { setTimeout(() => toggleToast(false), 1500); }
        }

        // --- HELPERS ---
        function detectBrand(name) {
            const n = name.toUpperCase();
            if (n.includes("CIS")) return "CIS";
            if (n.includes("COMPACTOR")) return "COMPACTOR";
            if (n.includes("LEONORA") || n.includes("JOCAR")) return "LEONORA";
            if (n.includes("TRIS")) return "TRIS";
            if (n.includes("CDSIL") || n.includes("SÃO DOMINGOS")) return "SÃO DOMINGOS";
            return "DIVERSOS";
        }
        function detectNCM(name, id) {
            if (id.length === 8 && !isNaN(id)) return id;
            if (name.toUpperCase().includes("CANETA")) return "96081000";
            if (name.toUpperCase().includes("CADERNO")) return "48202000";
            return "00000000";
        }
        function toggleConfig() { document.getElementById('configSection').classList.toggle('hidden'); }
        function closeChangesModal() { document.getElementById('confirmChangesModal').classList.add('hidden'); }
        function filterItems() {
            const search = document.getElementById('mainSearch').value.toLowerCase();
            const pendingRows = document.getElementById('pendingTableBody').getElementsByTagName('tr');
            Array.from(pendingRows).forEach(row => { row.style.display = row.innerText.toLowerCase().includes(search) ? '' : 'none'; });
        }
        function showToast(text) {
            const toast = document.getElementById('loadingToast');
            document.getElementById('toastLoader').classList.remove('hidden');
            document.getElementById('toastIcon').classList.add('hidden');
            document.getElementById('toastText').innerText = text;
            toast.style.opacity = '1';
        }
        function showSuccessToast(text) {
            const toast = document.getElementById('loadingToast');
            document.getElementById('toastLoader').classList.add('hidden');
            document.getElementById('toastIcon').classList.remove('hidden');
            document.getElementById('toastText').innerText = text;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 2500);
        }
        function toggleToast(show) { document.getElementById('loadingToast').style.opacity = show ? '1' : '0'; }

        /*
        async function updateAllSentItems() {
            const sentItems = itemsState.filter(i => i.sent);
            if (sentItems.length === 0) return;
            if (!confirm(`Sincronizar metadados de ${sentItems.length} itens? Chave de busca será o NOME.`)) return;
            showToast("Sincronizando...");
            for (const item of sentItems) {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
                    action: "saveProduct", data: { id: item.currentInput, name: item.produto, price: item.remotePrice, costPrice: item.custo, ncm: item.ncm, brand: item.brand, category: "Material Escolar", cadastrado: "Sim" }
                })});
            }
            showSuccessToast("Finalizado!");
        }
        */

        function downloadReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            doc.setFontSize(16); doc.text("Relatório de Precificação - EletroBusiness", pageWidth / 2, 15, { align: 'center' });
            doc.setFontSize(10); doc.text(`Gerado em: ${new Date().toLocaleString()}`, pageWidth / 2, 22, { align: 'center' });
            const tableData = itemsState.map(i => [i.currentInput || i.id, i.produto, i.brand, i.fator, i.qtdReal, `R$ ${i.custo.toFixed(2)}`, `R$ ${i.newPrice.toFixed(2)}`, i.sent ? 'OK' : 'Pend']);
            doc.autoTable({ startY: 28, head: [['Código', 'Produto', 'Marca', 'Fator', 'Qtd', 'Custo', 'Venda', 'Status']], body: tableData, theme: 'striped', headStyles: { fillColor: [59, 130, 246] } });
            doc.save(`relatorio_${new Date().getTime()}.pdf`);
            showSuccessToast("PDF Gerado!");
        }

        function copyFormattedData() {
            if (itemsState.length === 0) return;
            const formatted = itemsState.map(item => {
                return `  { id: "${item.currentInput || item.id}", ncm: "${item.ncm}", produto: "${item.produto}", fator: "${item.fator}", qtdReal: "${item.qtdReal}", custo: ${item.custo}, venda: ${item.venda}, brand: "${item.brand}" }`;
            }).join(',\n');
            const el = document.createElement('textarea');
            el.value = `const PRODUCT_DATABASE = [\n${formatted}\n];`;
            document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            showSuccessToast("Copiado!");
        }
    </script>
</body>

</html>