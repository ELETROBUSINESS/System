<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        .ui-panel {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; text-align: center; width: 90%;
        }
        button {
            padding: 15px 25px; border-radius: 30px; border: none;
            background: #db0038; color: white; font-weight: bold; font-size: 16px;
        }
        #status { color: white; background: rgba(0,0,0,0.5); padding: 5px; margin-bottom: 10px; border-radius: 5px; display: none; }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">

    <div class="ui-panel">
        <div id="status">Gravando...</div>
        <button onclick="salvarLocalizacao()">MARCAR PRODUTO AQUI</button>
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
        <a-marker preset="hiro" id="ancora">
            <a-entity id="mapa-conteudo"></a-entity>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbznf7SeuiwZ_vtmV1w6u3KfRMRt-EettfRv9TccBUA8qtZTWb_j_h6E6PkaQdkUU1dt/exec";
        const mapaContainer = document.querySelector('#mapa-conteudo');

        // 1. Carregar o que já foi gravado ao abrir o site
        window.onload = () => {
            fetch(API_URL)
                .then(res => res.json())
                .then(pontos => {
                    pontos.forEach(p => renderizarPonto(p.produto, p.x, p.y, p.z));
                });
        };

        function renderizarPonto(nome, x, y, z) {
            // Cria a esfera visual
            const el = document.createElement('a-sphere');
            el.setAttribute('position', {x: x, y: y, z: z});
            el.setAttribute('radius', '0.15');
            el.setAttribute('color', '#db0038');

            // Adiciona o nome flutuando
            const txt = document.createElement('a-text');
            txt.setAttribute('value', nome);
            txt.setAttribute('align', 'center');
            txt.setAttribute('position', '0 0.3 0');
            txt.setAttribute('scale', '0.8 0.8 0.8');
            
            el.appendChild(txt);
            mapaContainer.appendChild(el);
        }

        function salvarLocalizacao() {
            const nome = prompt("Nome do produto ou setor:");
            if (!nome) return;

            // Pega a posição da câmera relativa ao marcador
            const camera = document.querySelector('[camera]');
            const worldPos = new THREE.Vector3();
            camera.object3D.getWorldPosition(worldPos);

            const dados = {
                produto: nome,
                x: worldPos.x.toFixed(2),
                y: worldPos.y.toFixed(2),
                z: worldPos.z.toFixed(2)
            };

            document.getElementById('status').style.display = 'block';

            // Envia para o Google Sheets
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(dados)
            }).then(() => {
                document.getElementById('status').style.display = 'none';
                renderizarPonto(dados.produto, dados.x, dados.y, dados.z); // Feedback Visual imediato
                alert("Produto mapeado com sucesso!");
            });
        }
    </script>
</body>
</html>