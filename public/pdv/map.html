<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eletro Business - Mapeamento</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css" />
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
        }

        #topo {
            background: #333;
            color: white;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-bottom: 2px solid #db0038;
        }

        #panorama {
            flex: 1;
            background: #000;
            position: relative;
        }

        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            border: 2px solid #db0038;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10;
        }

        #crosshair::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 4px;
            background: #db0038;
            border-radius: 50%;
        }

        .btn {
            background: #db0038;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        select {
            padding: 8px;
            border-radius: 4px;
            background: #444;
            color: white;
            border: 1px solid #666;
        }
    </style>
</head>

<body>

    <div id="topo">
        <div style="display: flex; flex-direction: column; gap: 5px;">
            <select id="lista-setores">
                <option>Carregando setores...</option>
            </select>
            <div style="font-size: 10px; color: #aaa; padding-left: 5px;" id="info-status">Modo: Navega√ß√£o</div>
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn" style="background: #6c757d;" onclick="triggerCamera()"
                title="Tirar foto com o celular">üì∏ C√¢mera</button>
            <button class="btn" onclick="addSetor()">+ Novo Setor</button>
            <div style="border-left: 1px solid #555; margin: 0 5px;"></div>
            <button class="btn btn-mode" id="btn-marcar" onclick="setMode('MARCADOR')"
                style="background: #28a745; opacity: 0.6;">üìç Marcar Item (P)</button>
            <button class="btn btn-mode" id="btn-vincular" onclick="setMode('VINCULO')"
                style="background: #007bff; opacity: 0.6;">üîó Criar Caminho (V)</button>
        </div>
        <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;"
            onchange="handleCameraUpload(this)">
    </div>

    <div id="panorama">
        <div id="crosshair"></div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbznf7SeuiwZ_vtmV1w6u3KfRMRt-EettfRv9TccBUA8qtZTWb_j_h6E6PkaQdkUU1dt/exec";
        let viewer = null;
        let currentMode = 'NAVEGAR';
        let currentData = null;

        function setMode(mode) {
            currentMode = (currentMode === mode) ? 'NAVEGAR' : mode;
            updateUI();
        }

        function updateUI() {
            document.getElementById('info-status').innerText = `Modo: ${currentMode}`;
            document.getElementById('btn-marcar').style.opacity = currentMode === 'MARCADOR' ? '1' : '0.6';
            document.getElementById('btn-vincular').style.opacity = currentMode === 'VINCULO' ? '1' : '0.6';
            document.getElementById('crosshair').style.display = currentMode !== 'NAVEGAR' ? 'block' : 'none';
        }

        // --- FUN√á√ïES DE C√ÇMERA ---
        function triggerCamera() {
            document.getElementById('camera-input').click();
        }

        function handleCameraUpload(input) {
            if (input.files && input.files[0]) {
                const tit = prompt("De um nome para esta nova foto (ex: Cozinha):");
                if (tit) {
                    alert("A imagem foi capturada! Em uma implementa√ß√£o de produ√ß√£o, agora far√≠amos o upload deste arquivo para o seu servidor ou Google Drive.\n\nDica: Use o modo 'PANORAMA' nativo do seu celular para melhores resultados 360.");
                }
            }
        }

        // 1. CONVERSOR AUTOM√ÅTICO DE LINK DO DRIVE - Otimizado para evitar bloqueios de CORS e avisos de v√≠rus
        function converterLink(link) {
            if (!link || typeof link !== 'string') return link;
            const id = link.match(/[-\w]{25,}/);
            if (id && (link.includes('drive.google.com') || link.includes('docs.google.com') || link.includes('googleusercontent.com'))) {
                // O endpoint lh3.googleusercontent.com/d/ID √© mais robusto para uso com WebGL/CORS e ignora o aviso de "arquivo grande"
                return `https://lh3.googleusercontent.com/d/${id[0]}`;
            }
            return link;
        }

        function getDimensions(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => resolve({ w: img.width, h: img.height });
                img.onerror = () => resolve({ w: 0, h: 0 });
                img.src = url;
            });
        }

        async function init() {
            try {
                const r = await fetch(API_URL);
                currentData = await r.json();
                const sel = document.getElementById('lista-setores');
                sel.innerHTML = "";

                if (currentData.scenes) {
                    for (const sceneId of Object.keys(currentData.scenes)) {
                        const scene = currentData.scenes[sceneId];
                        if (scene.panorama) {
                            scene.panorama = converterLink(scene.panorama);
                            const dims = await getDimensions(scene.panorama);
                            if (dims.w > 0) {
                                const aspect = dims.h / dims.w;
                                if (aspect < 0.48 || aspect > 0.52) {
                                    scene.vaov = (dims.h / (dims.w / 2)) * 180;
                                    scene.maxPitch = scene.vaov / 2;
                                    scene.minPitch = -scene.vaov / 2;
                                }
                            }
                        }

                        // Configura hotspots de rota (Google Maps Style)
                        if (scene.hotSpots) {
                            scene.hotSpots.forEach(hs => {
                                if (hs.text && hs.text.startsWith("üîó")) {
                                    const targetId = hs.text.replace("üîó Ir para: ", "").trim();
                                    hs.type = "scene";
                                    hs.sceneId = targetId;
                                    hs.text = `Ir para: ${currentData.scenes[targetId]?.title || targetId}`;
                                }
                            });
                        }

                        let opt = document.createElement('option');
                        opt.value = sceneId; opt.text = scene.title;
                        sel.appendChild(opt);
                    }
                }

                if (viewer) viewer.destroy();
                currentData.autoLoad = true;
                viewer = pannellum.viewer('panorama', currentData);
                sel.onchange = (e) => viewer.loadScene(e.target.value);
            } catch (e) { console.error("Erro no carregamento:", e); }
        }

        function addSetor() {
            const id = prompt("ID (ex: corredor1):");
            const tit = prompt("Nome:");
            const urlRaw = prompt("Link do Drive:");
            if (id && tit && urlRaw) {
                const dados = { tipo: "CENA", id: id, titulo: tit, url: converterLink(urlRaw) };
                fetch(API_URL, { method: 'POST', body: JSON.stringify(dados) }).then(() => location.reload());
            }
        }

        // Evento de clique para marca√ß√£o/v√≠nculo
        document.getElementById('panorama').addEventListener('dblclick', () => {
            if (currentMode === 'VINCULO') {
                const destino = prompt("Para qual setor este caminho leva? (Digite o ID ex: corredor2)");
                if (destino && currentData.scenes[destino]) {
                    const dados = {
                        tipo: "MARCADOR",
                        cena_pai: viewer.getScene(),
                        texto: `üîó Ir para: ${destino}`,
                        pitch: viewer.getPitch().toFixed(2),
                        yaw: viewer.getYaw().toFixed(2)
                    };
                    fetch(API_URL, { method: 'POST', body: JSON.stringify(dados) }).then(() => {
                        viewer.addHotSpot({ "pitch": viewer.getPitch(), "yaw": viewer.getYaw(), "type": "scene", "sceneId": destino, "text": `Ir para ${currentData.scenes[destino].title}` });
                        setMode('NAVEGAR');
                    });
                }
            } else if (currentMode === 'MARCADOR') {
                const nome = prompt("Nome do produto:");
                if (nome) {
                    const dados = { tipo: "MARCADOR", cena_pai: viewer.getScene(), texto: nome, pitch: viewer.getPitch().toFixed(2), yaw: viewer.getYaw().toFixed(2) };
                    fetch(API_URL, { method: 'POST', body: JSON.stringify(dados) }).then(() => {
                        viewer.addHotSpot({ "pitch": viewer.getPitch(), "yaw": viewer.getYaw(), "type": "info", "text": nome });
                        setMode('NAVEGAR');
                    });
                }
            }
        });

        window.addEventListener('keydown', e => {
            if (e.key.toLowerCase() === 'p') setMode('MARCADOR');
            if (e.key.toLowerCase() === 'v') setMode('VINCULO');
            if (e.key.toLowerCase() === 'escape') setMode('NAVEGAR');
        });

        init();
        updateUI();
    </script>
</body>

</html>