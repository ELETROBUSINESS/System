<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minha Fatura | D'TUDO</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #db0038;
            --primary-dark: #b8002e;
            --bg: #f3f4f6;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-light: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --radius-2xl: 32px;
            --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        }

        * {
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.01em;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* --- Custom Animations --- */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-up {
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* --- Card Holographic Effect --- */
        .holographic-card {
            background: linear-gradient(135deg, #db0038 0%, #ff3b6b 50%, #db0038 100%);
            background-size: 200% 200%;
            animation: gradientShift 5s ease infinite;
            position: relative;
            overflow: hidden;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .holographic-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(105deg, transparent 40%, rgba(255, 255, 255, 0.1) 45%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.1) 55%, transparent 60%);
            transform: translateX(-100%);
            animation: shine 4s infinite;
        }

        @keyframes shine {
            to {
                transform: translateX(100%);
            }
        }

        /* --- PIN Dots --- */
        .pin-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .pin-dot.filled {
            background: var(--primary);
            border-color: var(--primary);
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(219, 0, 56, 0.4);
        }

        /* --- Bottom Sheet --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(8px);
            z-index: 5000;
            display: none;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.4s;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .bottom-sheet {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: 40px 40px 0 0;
            padding: 24px;
            transform: translateY(100%);
            transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
        }

        .modal-overlay.active .bottom-sheet {
            transform: translateY(0);
        }

        /* --- Hide Scrollbars --- */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* --- Glass Effect for Navbar --- */
        .glass-nav {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>

<body class="pb-32">

    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-slate-50 z-[9999] flex items-center justify-center">
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-slate-200 border-t-[#db0038] rounded-full animate-spin"></div>
            <span class="mt-4 text-slate-400 font-bold text-xs uppercase tracking-widest">D'TUDO Sistemas</span>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-white z-[6000] hidden flex-col items-center justify-center p-10">
        <div class="w-full max-w-xs text-center">
            <div class="w-24 h-24 bg-rose-50 rounded-[32px] flex items-center justify-center mx-auto mb-8 shadow-inner">
                <i class='bx bxs-key text-4xl text-[#db0038]'></i>
            </div>
            <h1 id="login-name" class="text-3xl font-black text-slate-900 mb-2">Bem-vindo</h1>
            <p class="text-slate-400 font-medium mb-12">Informe seu PIN de acesso</p>

            <div class="pin-display flex justify-center gap-5 mb-14">
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
            </div>

            <div class="grid grid-cols-3 gap-6">
                <button
                    class="w-full aspect-square rounded-full bg-slate-50 text-2xl font-black text-slate-700 active:bg-[#db0038] active:text-white transition-all"
                    onclick="typePin(1)">1</button>
                <button
                    class="w-full aspect-square rounded-full bg-slate-50 text-2xl font-black text-slate-700 active:bg-[#db0038] active:text-white transition-all"
                    onclick="typePin(2)">2</button>
                <button
                    class="w-full aspect-square rounded-full bg-slate-50 text-2xl font-black text-slate-700 active:bg-[#db0038] active:text-white transition-all"
                    onclick="typePin(3)">3</button>
                <button
                    class="w-full aspect-square rounded-full bg-slate-50 text-2xl font-black text-slate-700 active:bg-[#db0038] active:text-white transition-all"
                    onclick="typePin(4)">4</button>
                <button
                    class="w-full aspect-square rounded-full bg-slate-50 text-2xl font-black text-slate-700 active:bg-[#db0038] active:text-white transition-all"
                    onclick="typePin(5)">5</button>
                <button
                    class="w-full aspect-square rounded-full bg-slate-50 text-2xl font-black text-slate-700 active:bg-[#db0038] active:text-white transition-all"
                    onclick="typePin(6)">6</button>
                <button
                    class="w-full aspect-square rounded-full bg-slate-50 text-2xl font-black text-slate-700 active:bg-[#db0038] active:text-white transition-all"
                    onclick="typePin(7)">7</button>
                <button
                    class="w-full aspect-square rounded-full bg-slate-50 text-2xl font-black text-slate-700 active:bg-[#db0038] active:text-white transition-all"
                    onclick="typePin(8)">8</button>
                <button
                    class="w-full aspect-square rounded-full bg-slate-50 text-2xl font-black text-slate-700 active:bg-[#db0038] active:text-white transition-all"
                    onclick="typePin(9)">9</button>
                <button class="w-full aspect-square rounded-full text-rose-500 font-bold"
                    onclick="clearPin()">Limpar</button>
                <button
                    class="w-full aspect-square rounded-full bg-slate-50 text-2xl font-black text-slate-700 active:bg-[#db0038] active:text-white transition-all"
                    onclick="typePin(0)">0</button>
                <button class="w-full aspect-square rounded-full text-slate-400" onclick="backspacePin()"><i
                        class='bx bx-chevron-left text-3xl'></i></button>
            </div>
            <p id="login-error" class="text-rose-600 mt-8 font-bold text-sm hidden"></p>
        </div>
    </div>

    <!-- Main Content -->
    <main id="app-content" class="hidden max-w-md mx-auto px-6 pt-10">

        <!-- Header -->
        <header class="flex justify-between items-center mb-10 animate-slide-up">
            <div>
                <span id="greeting-msg" class="text-slate-400 font-bold text-xs uppercase tracking-[0.2em]">Meus
                    Acessos</span>
                <h2 id="card-holder-name" class="text-2xl font-black text-slate-900 tracking-tighter">...</h2>
            </div>
            <button onclick="openProfile()"
                class="w-14 h-14 rounded-3xl bg-white shadow-premium flex items-center justify-center border border-slate-50 active:scale-90 transition-transform">
                <i class='bx bx-cog text-2xl text-slate-600'></i>
            </button>
        </header>

        <!-- Credit Card -->
        <section class="mb-10 animate-slide-up" style="animation-delay: 0.1s;">
            <div
                class="holographic-card rounded-[40px] p-8 text-white aspect-[1.6/1] flex flex-col justify-between shadow-2xl">
                <div class="flex justify-between items-start">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-12 h-12 bg-white/20 backdrop-blur-xl rounded-2xl flex items-center justify-center">
                            <i class='bx bx-chip text-3xl opacity-80'></i>
                        </div>
                        <span class="font-black text-sm tracking-tighter uppercase opacity-90">Cartão Platinum</span>
                    </div>
                    <span class="text-2xl font-black italic tracking-tighter">D'TUDO</span>
                </div>

                <div>
                    <span class="text-[10px] font-black uppercase tracking-widest opacity-60 block mb-1">Fatura em
                        Aberto</span>
                    <div id="hero-current-invoice" class="text-4xl font-black tracking-tighter mb-6">R$ 0,00</div>

                    <div class="flex justify-between items-end">
                        <div class="font-mono text-lg tracking-[0.2em] opacity-80">•••• •••• •••• <span
                                id="card-last-digits">0000</span></div>
                        <i class='bx bxl-visa text-4xl opacity-50'></i>
                    </div>
                </div>
            </div>
        </section>

        <!-- Limits Section -->
        <section class="bg-white rounded-[40px] p-8 shadow-premium mb-10 animate-slide-up"
            style="animation-delay: 0.2s;">
            <div class="flex justify-between items-center mb-6">
                <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest">Limite de Crédito</h4>
                <div id="val-avail" class="text-emerald-500 font-black text-xs">Carregando...</div>
            </div>

            <div id="limit-track-bg" class="h-4 bg-slate-50 rounded-full flex overflow-hidden p-1 shadow-inner">
                <div id="bar-current"
                    class="h-full bg-[#db0038] rounded-full transition-all duration-1000 shadow-lg shadow-rose-200"
                    style="width: 0%"></div>
                <div id="bar-future" class="h-full bg-amber-400 rounded-full transition-all duration-1000 ml-0.5"
                    style="width: 0%"></div>
            </div>

            <div class="flex justify-between mt-6">
                <div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Utilizado</p>
                    <p id="limit-total-text" class="text-xl font-black text-slate-900 tracking-tighter">R$ 0,00</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Limite Total</p>
                    <p class="text-xl font-black text-slate-300 tracking-tighter">R$ 5.000,00</p>
                </div>
            </div>
        </section>

        <!-- Quick Actions -->
        <section class="grid grid-cols-4 gap-4 mb-10 animate-slide-up" style="animation-delay: 0.3s;">
            <button onclick="document.getElementById('invoices-carousel').scrollIntoView({behavior:'smooth'})"
                class="flex flex-col items-center gap-3">
                <div
                    class="w-16 h-16 bg-white rounded-3xl flex items-center justify-center text-[#db0038] shadow-premium border border-slate-50 active:scale-95 transition-all">
                    <i class='bx bx-barcode-reader text-2xl'></i>
                </div>
                <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Pagar</span>
            </button>
            <button onclick="openProfile()" class="flex flex-col items-center gap-3">
                <div
                    class="w-16 h-16 bg-white rounded-3xl flex items-center justify-center text-blue-500 shadow-premium border border-slate-50 active:scale-95 transition-all">
                    <i class='bx bx-list-ul text-2xl'></i>
                </div>
                <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Extrato</span>
            </button>
            <button class="flex flex-col items-center gap-3 group opacity-40">
                <div
                    class="w-16 h-16 bg-white rounded-3xl flex items-center justify-center text-slate-400 shadow-premium border border-slate-50">
                    <i class='bx bx-lock-alt text-2xl'></i>
                </div>
                <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Cartão</span>
            </button>
            <button onclick="window.open('https://wa.me/5575991402778', '_blank')"
                class="flex flex-col items-center gap-3">
                <div
                    class="w-16 h-16 bg-emerald-50 rounded-3xl flex items-center justify-center text-emerald-600 shadow-premium border border-emerald-100 active:scale-95 transition-all">
                    <i class='bx bxl-whatsapp text-3xl'></i>
                </div>
                <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Ajuda</span>
            </button>
        </section>

        <!-- Invoice List -->
        <section class="mb-20 animate-slide-up" style="animation-delay: 0.4s;">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-lg font-black text-slate-900 tracking-tighter">Minhas Faturas</h3>
                <span
                    class="text-xs font-bold text-[#db0038] bg-rose-50 px-3 py-1 rounded-full uppercase tracking-widest">Ver
                    Tudo</span>
            </div>

            <div id="invoices-carousel" class="flex overflow-x-auto gap-5 no-scrollbar pb-10 -mx-6 px-6 snap-x">
                <!-- Items via JS -->
            </div>
        </section>
    </main>

    <!-- Navbar -->
    <nav
        class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[90%] max-w-sm glass-nav shadow-2xl rounded-[40px] h-20 flex items-center justify-around px-6 z-50">
        <button onclick="setActiveNav(this); window.scrollTo({top:0, behavior:'smooth'})"
            class="nav-item group flex flex-col items-center text-[#db0038] active">
            <i class='bx bxs-dashboard text-2xl transition-transform group-active:scale-125'></i>
            <span class="text-[9px] font-black uppercase mt-1 tracking-widest">Home</span>
        </button>
        <button
            onclick="setActiveNav(this); document.getElementById('invoices-carousel').scrollIntoView({behavior:'smooth'})"
            class="nav-item group flex flex-col items-center text-slate-400">
            <i class='bx bx-receipt text-2xl transition-transform group-active:scale-125'></i>
            <span class="text-[9px] font-black uppercase mt-1 tracking-widest">Faturas</span>
        </button>
        <button onclick="setActiveNav(this); openProfile()"
            class="nav-item group flex flex-col items-center text-slate-400">
            <i class='bx bx-user-circle text-2xl transition-transform group-active:scale-125'></i>
            <span class="text-[9px] font-black uppercase mt-1 tracking-widest">Perfil</span>
        </button>
    </nav>

    <!-- Modals (Bottom Sheets) -->
    <div id="modal-details" class="modal-overlay" onclick="if(event.target === this) closeModal('modal-details')">
        <div class="bottom-sheet shadow-2xl">
            <div class="w-16 h-1.5 bg-slate-100 rounded-full mx-auto mb-10"></div>
            <div class="flex justify-between items-center mb-10">
                <h3 id="sheet-month-title" class="text-2xl font-black text-slate-900 tracking-tighter">Detalhes</h3>
                <button onclick="closeModal('modal-details')"
                    class="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center text-slate-400"><i
                        class='bx bx-x text-2xl'></i></button>
            </div>
            <div id="sheet-list" class="space-y-4 max-h-[50vh] overflow-y-auto no-scrollbar pb-10">
                <!-- Transaction Items -->
            </div>
        </div>
    </div>

    <div id="modal-transaction-view" class="modal-overlay"
        onclick="if(event.target === this) closeModal('modal-transaction-view')">
        <div class="bottom-sheet">
            <div class="w-16 h-1.5 bg-slate-100 rounded-full mx-auto mb-10"></div>
            <div class="text-center mb-12">
                <div id="detail-icon"
                    class="w-20 h-20 mx-auto rounded-[32px] flex items-center justify-center text-3xl mb-6 shadow-premium">
                </div>
                <h2 id="detail-amount" class="text-5xl font-black text-slate-900 tracking-tighter mb-2">R$ 0,00</h2>
                <p id="detail-title" class="text-slate-400 font-bold text-xs uppercase tracking-[0.2em]">PAGAMENTO</p>
            </div>

            <div class="bg-slate-50 rounded-[32px] p-6 space-y-4 mb-8">
                <div class="flex justify-between items-center"><span
                        class="text-slate-400 text-sm font-bold">Data</span><span id="detail-date"
                        class="text-slate-900 font-black text-sm">--</span></div>
                <div class="flex justify-between items-center border-t border-white pt-4"><span
                        class="text-slate-400 text-sm font-bold">Descrição</span><span id="detail-desc"
                        class="text-slate-900 font-black text-sm text-right">...</span></div>
                <div class="flex justify-between items-center border-t border-white pt-4"><span
                        class="text-slate-400 text-sm font-bold">Categoria</span><span id="detail-type"
                        class="text-slate-900 font-black text-sm">...</span></div>
            </div>

            <button id="btn-view-receipt"
                class="w-full bg-[#db0038] text-white py-6 rounded-[32px] font-black text-sm uppercase tracking-widest shadow-xl shadow-rose-200 active:scale-95 transition-all flex items-center justify-center gap-3">
                <i class='bx bx-receipt text-xl'></i> Comprovante
            </button>
            <p id="no-receipt-msg"
                class="text-center text-slate-400 text-xs py-6 font-bold uppercase hidden tracking-widest">Sem anexo</p>
        </div>
    </div>

    <div id="modal-profile" class="modal-overlay" onclick="if(event.target === this) closeModal('modal-profile')">
        <div class="bottom-sheet">
            <div class="w-16 h-1.5 bg-slate-100 rounded-full mx-auto mb-10"></div>
            <h3 class="text-2xl font-black mb-10 text-center tracking-tighter">Minha Conta</h3>
            <div class="space-y-4">
                <div class="bg-slate-50 p-6 rounded-[32px] border border-white">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Nome Completo</p>
                    <p id="prof-name" class="font-black text-slate-800">...</p>
                </div>
                <div class="bg-slate-50 p-6 rounded-[32px] border border-white">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Endereço</p>
                    <p id="prof-address" class="font-black text-slate-800">...</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 p-6 rounded-[32px] border border-white">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Telefone</p>
                        <p id="prof-phone" class="font-black text-slate-800">...</p>
                    </div>
                    <div class="bg-slate-50 p-6 rounded-[32px] border border-white">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Vencimento</p>
                        <p id="prof-day" class="font-black text-slate-800">...</p>
                    </div>
                </div>
                <button onclick="window.location.reload()"
                    class="w-full bg-slate-900 text-white py-6 rounded-[32px] font-black text-xs uppercase tracking-widest mt-6 shadow-2xl active:scale-95 transition-all">Sair
                    do App</button>
            </div>
        </div>
    </div>

    <div id="modal-receipt" class="modal-overlay" style="background:rgba(15,23,42,0.95); z-index: 7000;">
        <div class="w-full h-full p-8 flex flex-col items-center justify-center">
            <button onclick="closeModal('modal-receipt')"
                class="absolute top-10 right-10 w-14 h-14 bg-white/10 rounded-full text-white text-4xl"><i
                    class='bx bx-x'></i></button>
            <img id="receipt-img"
                class="max-w-full max-h-[70vh] rounded-[40px] shadow-2xl border-4 border-white/10 object-contain" src=""
                alt="Comprovante">
            <div class="mt-8 text-center text-white/50 font-black text-[10px] uppercase tracking-[0.4em]">D'TUDO
                Autenticação</div>
        </div>
    </div>

    <div id="error-container"
        class="fixed top-8 inset-x-8 bg-[#db0038] text-white p-6 rounded-[32px] text-center font-black text-sm shadow-2xl z-[8000] hidden animate-slide-up">
    </div>

    <script>
        // --- UI Logic ---
        function setActiveNav(el) {
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('text-[#db0038]', 'active');
                n.classList.add('text-slate-400');
                const icon = n.querySelector('i');
                if (icon) icon.className = icon.className.replace('bxs-', 'bx-');
            });
            el.classList.add('text-[#db0038]', 'active');
            el.classList.remove('text-slate-400');
            const icon = el.querySelector('i');
            if (icon) icon.className = icon.className.replace('bx-', 'bxs-');
        }

        // --- Core Logic (Preserved IDs and Functionality) ---
        const API_URL = "https://script.google.com/macros/s/AKfycbzB7dluoiNyJ4XK6oDK_iyuKZfwPTAJa4ua4RetQsUX9cMObgE-k_tFGI82HxW_OyMf/exec";
        let CACHE_DATA = null, FATURAS = [], CURRENT_ITEMS = [], GLOBAL_ID = null, PIN = "";

        function parseDateSafe(d) {
            if (!d) return new Date();
            if (d instanceof Date) return d;
            if (typeof d === 'string' && d.includes('T')) return new Date(d);
            if (typeof d === 'string' && d.includes('/')) {
                const p = d.split(' ')[0].split('/');
                if (p.length === 3) return new Date(p[2], p[1] - 1, p[0], 12, 0, 0);
            }
            const res = new Date(d);
            return isNaN(res.getTime()) ? new Date() : res;
        }

        async function init() {
            const p = new URLSearchParams(window.location.search);
            GLOBAL_ID = p.get('q') || p.get('id');
            if (!GLOBAL_ID) { showError("Identificação inválida."); return; }
            await loadData();
        }

        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'flex';
                const url = `${API_URL}?action=obterDadosFatura&idCliente=${GLOBAL_ID}&pin=${PIN}`;
                const res = await fetch(url);
                const json = await res.json();
                document.getElementById('loading').style.display = 'none';

                if (json.status === 'auth_required') {
                    showLoginScreen(json.cliente.nome);
                } else if (json.status === 'success') {
                    CACHE_DATA = json;
                    hideLoginScreen();
                    renderHeader(json.cliente);
                    processarFaturasUnificadas(json);
                    renderLimitBar(json.cliente, FATURAS);
                    document.getElementById('app-content').classList.remove('hidden');
                } else {
                    if (PIN.length > 0) {
                        const err = document.getElementById('login-error');
                        err.textContent = "PIN incorreto. Tente novamente.";
                        err.classList.remove('hidden');
                        clearPin();
                    } else { showError(json.message); }
                }
            } catch (e) {
                document.getElementById('loading').style.display = 'none';
                showError("Erro na conexão: " + e.message);
            }
        }

        function processarFaturasUnificadas(data) {
            const logs = data.historico || [];
            const diaVenc = parseInt(data.cliente.diaVencimento) || 10;
            const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
            const fMap = {};

            logs.forEach(log => {
                let comp;
                if (log.vencimentoParcela && log.vencimentoParcela.length > 5) comp = parseDateSafe(log.vencimentoParcela);
                else {
                    const dV = parseDateSafe(log.data);
                    let b = new Date(dV.getFullYear(), dV.getMonth(), diaVenc);
                    if (dV.getDate() >= (diaVenc - 10)) b.setMonth(b.getMonth() + 1);
                    comp = b;
                }
                const key = `${comp.getFullYear()}-${String(comp.getMonth() + 1).padStart(2, '0')}`;
                if (!fMap[key]) fMap[key] = { dataVencimento: new Date(comp.getFullYear(), comp.getMonth(), diaVenc), totalCompras: 0, totalPagos: 0, itens: [] };
                fMap[key].itens.push(log);
                if (String(log.tipo).toLowerCase().includes('pagamento') || log.valor < 0) fMap[key].totalPagos += Math.abs(log.valor);
                else fMap[key].totalCompras += log.valor;
            });

            let crua = Object.values(fMap).sort((a, b) => a.dataVencimento - b.dataVencimento);
            let fin = [], atraso = { total: 0, itens: [] };

            crua.forEach(fat => {
                const s = fat.totalCompras - fat.totalPagos;
                if (fat.dataVencimento < hoje) {
                    atraso.total += s;
                    if (s > 0.01) fat.itens.forEach(i => { i.isAtrasado = true; atraso.itens.push(i); });
                } else fin.push(fat);
            });

            if (atraso.total > 0.01) {
                if (fin.length > 0) {
                    fin[0].totalCompras += atraso.total;
                    fin[0].itens = [...atraso.itens, ...fin[0].itens];
                    fin[0].hasAtraso = true;
                } else fin.push({ dataVencimento: hoje, totalCompras: atraso.total, totalPagos: 0, itens: atraso.itens, hasAtraso: true });
            }

            if (fin.length === 0) fin.push({ dataVencimento: new Date(hoje.getFullYear(), hoje.getMonth(), diaVenc), totalCompras: 0, totalPagos: 0, itens: [] });
            FATURAS = fin;
            renderCarousel();
        }

        function showLoginScreen(nome) {
            document.getElementById('login-name').textContent = `Olá, ${nome || "Cliente"}`;
            document.getElementById('login-screen').style.display = 'flex';
        }
        function hideLoginScreen() { document.getElementById('login-screen').style.display = 'none'; }
        function typePin(n) { if (PIN.length < 6) { PIN += n; updatePinDots(); if (PIN.length === 6) setTimeout(loadData, 300); } }
        function backspacePin() { PIN = PIN.slice(0, -1); updatePinDots(); document.getElementById('login-error').classList.add('hidden'); }
        function clearPin() { PIN = ""; updatePinDots(); }
        function updatePinDots() {
            document.querySelectorAll('.pin-dot').forEach((dot, i) => {
                if (i < PIN.length) dot.classList.add('filled'); else dot.classList.remove('filled');
            });
        }

        function renderHeader(cli) {
            document.getElementById('card-holder-name').textContent = cli.nome || "Cliente";
            document.getElementById('card-last-digits').textContent = (cli.id && cli.id.length >= 4) ? cli.id.slice(-4).toUpperCase() : "0000";
            document.getElementById('prof-name').textContent = cli.nome;
            document.getElementById('prof-day').textContent = "Dia " + (cli.diaVencimento || 10);
            document.getElementById('prof-address').textContent = cli.endereco || "Não cadastrado";
            document.getElementById('prof-phone').textContent = cli.telefone || "Não cadastrado";
        }

        function renderCarousel() {
            const container = document.getElementById('invoices-carousel'); container.innerHTML = '';
            const meses = ["JAN", "FEV", "MAR", "ABR", "MAI", "JUN", "JUL", "AGO", "SET", "OUT", "NOV", "DEZ"];
            const hoje = new Date(); hoje.setHours(0, 0, 0, 0);

            FATURAS.forEach((fat, idx) => {
                const saldo = fat.totalCompras - fat.totalPagos;
                let st = { txt: "ABERTA", bg: "bg-blue-50", col: "text-blue-600" };
                if (saldo <= 0.01) st = { txt: "PAGA", bg: "bg-emerald-50", col: "text-emerald-600" };
                else if (fat.hasAtraso || fat.dataVencimento < hoje) st = { txt: "ATRASADA", bg: "bg-rose-50", col: "text-rose-600" };
                else if (fat.dataVencimento > hoje && idx > 0) st = { txt: "FUTURA", bg: "bg-slate-50", col: "text-slate-400" };

                const vParts = saldo.toLocaleString('pt-BR', { minimumFractionDigits: 2 }).split(',');
                const card = document.createElement('div');
                card.className = 'min-w-[280px] bg-white rounded-[40px] p-8 shadow-premium border border-slate-50 snap-center flex flex-col justify-between active:scale-95 transition-all';
                card.onclick = () => showDetails(idx);

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-8">
                        <span class="text-[10px] font-black text-slate-300 uppercase tracking-widest">${meses[fat.dataVencimento.getMonth()]} ${fat.dataVencimento.getFullYear()}</span>
                        <span class="px-4 py-1.5 rounded-full text-[9px] font-black ${st.bg} ${st.col} uppercase tracking-widest">${st.txt}</span>
                    </div>
                    <div class="mb-8">
                        <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-1">Total</p>
                        <div class="text-3xl font-black text-slate-900 ${saldo <= 0.01 ? 'opacity-20 line-through' : ''} tracking-tighter">
                            <span class="text-sm">R$</span> ${vParts[0]}<span class="text-sm">,${vParts[1]}</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-6 border-t border-slate-50">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Vence ${fat.dataVencimento.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })}</span>
                        <i class='bx bx-right-arrow-alt text-2xl text-slate-300'></i>
                    </div>
                `;
                container.appendChild(card);
            });

            if (FATURAS.length > 0) document.getElementById('hero-current-invoice').textContent = formatBRL(FATURAS[0].totalCompras - FATURAS[0].totalPagos);
        }

        window.showDetails = (idx) => {
            const fat = FATURAS[idx];
            CURRENT_ITEMS = fat.itens;
            const container = document.getElementById('sheet-list'); container.innerHTML = '';
            document.getElementById('sheet-month-title').textContent = fat.dataVencimento.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

            if (fat.itens.length === 0) container.innerHTML = '<p class="text-center py-10 text-slate-400 font-bold uppercase text-xs tracking-widest">Nenhum registro</p>';
            else {
                fat.itens.sort((a, b) => parseDateSafe(b.data) - parseDateSafe(a.data)).forEach((item, i) => {
                    const isP = String(item.tipo).toLowerCase().includes('pagamento') || item.valor < 0;
                    const dS = parseDateSafe(item.data).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                    let icon = isP ? 'bx-check-shield' : (item.isAtrasado ? 'bx-error-circle' : 'bx-shopping-bag');
                    let cls = isP ? 'bg-emerald-50 text-emerald-500' : (item.isAtrasado ? 'bg-rose-50 text-rose-500' : 'bg-slate-50 text-slate-600');

                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-4 p-5 rounded-[32px] hover:bg-slate-50 transition-all active:scale-95';
                    div.onclick = () => showTransaction(i);
                    div.innerHTML = `
                        <div class="w-14 h-14 ${cls} rounded-2xl flex items-center justify-center text-xl shadow-sm"><i class='bx ${icon}'></i></div>
                        <div class="flex-1">
                            <span class="block text-sm font-black text-slate-800 line-clamp-1">${item.obs || item.tipo}</span>
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${dS}</span>
                        </div>
                        <div class="text-right">
                            <span class="block text-sm font-black ${isP ? 'text-emerald-500' : 'text-slate-900'}">${formatBRL(Math.abs(item.valor))}</span>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
            document.getElementById('modal-details').classList.add('active');
        };

        window.showTransaction = (idx) => {
            const item = CURRENT_ITEMS[idx];
            const isP = String(item.tipo).toLowerCase().includes('pagamento') || item.valor < 0;
            document.getElementById('detail-title').textContent = isP ? 'PAGAMENTO' : 'COMPRA';
            document.getElementById('detail-amount').textContent = formatBRL(Math.abs(item.valor));
            document.getElementById('detail-amount').className = `text-5xl font-black tracking-tighter mb-2 ${isP ? 'text-emerald-500' : 'text-slate-900'}`;
            document.getElementById('detail-date').textContent = parseDateSafe(item.data).toLocaleString('pt-BR');
            document.getElementById('detail-desc').textContent = item.obs || item.tipo;
            document.getElementById('detail-type').textContent = item.tipo;

            const iDiv = document.getElementById('detail-icon');
            iDiv.className = `w-20 h-20 mx-auto rounded-[32px] flex items-center justify-center text-3xl mb-6 shadow-premium ${isP ? 'bg-emerald-50 text-emerald-500' : 'bg-rose-50 text-rose-500'}`;
            iDiv.innerHTML = `<i class='bx ${isP ? 'bx-check-shield' : 'bx-shopping-bag'}'></i>`;

            const btn = document.getElementById('btn-view-receipt'), msg = document.getElementById('no-receipt-msg');
            if (item.anexo && item.anexo.length > 5) {
                btn.classList.remove('hidden'); btn.onclick = () => openReceiptImage(item.anexo); msg.classList.add('hidden');
            } else { btn.classList.add('hidden'); msg.classList.remove('hidden'); }
            document.getElementById('modal-transaction-view').classList.add('active');
        };

        function openReceiptImage(u) {
            let fId = null;
            const m = u.match(/[-\w]{25,}/);
            if (m) fId = m[0];
            document.getElementById('receipt-img').src = fId ? `https://lh3.googleusercontent.com/d/${fId}` : u;
            document.getElementById('modal-receipt').classList.add('active');
        }

        function renderLimitBar(cli, fats) {
            const lim = parseFloat(cli.limite) || 0;
            let atual = 0, fut = 0;
            fats.forEach((f, i) => {
                const s = f.totalCompras - f.totalPagos;
                if (s > 0.01) { if (i === 0) atual += s; else fut += s; }
            });
            const usado = atual + fut, disp = lim - usado, base = Math.max(lim, usado);
            let pa = base > 0 ? (atual / base) * 100 : 0, pf = base > 0 ? (fut / base) * 100 : 0;
            document.getElementById('bar-current').style.width = `${Math.max(pa, 2)}%`;
            document.getElementById('bar-future').style.width = `${pf}%`;
            document.getElementById('limit-total-text').textContent = formatBRL(usado);
            const el = document.getElementById('val-avail');
            if (disp >= 0) { el.textContent = `Disp. ${formatBRL(disp)}`; el.className = 'text-emerald-500 font-black text-[10px] uppercase tracking-widest'; }
            else { el.textContent = `Excedido ${formatBRL(Math.abs(disp))}`; el.className = 'text-rose-500 font-black text-[10px] uppercase tracking-widest'; }
        }

        function formatBRL(v) { return (v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function showError(m) { const e = document.getElementById('error-container'); e.textContent = m; e.classList.remove('hidden'); setTimeout(() => e.classList.add('hidden'), 5000); }
        window.openProfile = () => document.getElementById('modal-profile').classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');

        init();
    </script>
</body>

</html>