<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minha Fatura | D'TUDO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            --primary: #db0038;
            --primary-dark: #b8002e;
            --bg: #f8f9fa;
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --card-gradient: linear-gradient(135deg, #db0038 0%, #8a0023 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            padding-bottom: 40px;
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        .app-header {
            background: var(--surface);
            padding: 20px 24px 30px 24px;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }

        .header-top {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }

        .logo-area h2 { font-size: 1.4rem; font-weight: 900; letter-spacing: -0.5px; color: var(--primary); margin: 0; }
        .logo-area span { font-size: 0.8rem; color: var(--text-light); font-weight: 500; }

        .user-btn {
            background: #f3f4f6; border: none; width: 40px; height: 40px;
            border-radius: 50%; display: grid; place-items: center;
            color: var(--text-main); font-size: 1.2rem; cursor: pointer; transition: 0.2s;
        }
        .user-btn:active { transform: scale(0.95); background: #e5e7eb; }

        /* CARTÃO VIRTUAL */
        .virtual-card {
            background: var(--card-gradient);
            width: 100%; height: 200px;
            border-radius: 24px; padding: 24px;
            color: white; position: relative;
            box-shadow: 0 20px 40px -10px rgba(219, 0, 56, 0.5);
            display: flex; flex-direction: column; justify-content: space-between; overflow: hidden;
        }

        .virtual-card::before {
            content: ''; position: absolute; top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%); pointer-events: none;
        }

        .card-top { display: flex; justify-content: space-between; align-items: start; }
        .card-logo-img { width: 50px; height: auto; }

        .card-number { 
            font-size: 1.4rem; letter-spacing: 4px; font-family: monospace; 
            opacity: 0.9; margin-top: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-bottom { display: flex; justify-content: space-between; align-items: flex-end; }
        .card-label { font-size: 0.6rem; opacity: 0.8; display: block; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; }
        .card-holder { font-size: 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        .card-vip { font-weight: 800; font-size: 1.1rem; opacity: 0.8; font-style: italic; letter-spacing: 1px; }

        /* --- BARRA DE LIMITE --- */
        .limit-section { padding: 0 24px; margin-bottom: 30px; }
        .limit-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 12px; }
        .limit-title { font-size: 0.9rem; font-weight: 700; color: var(--text-main); }
        .limit-value { font-size: 0.85rem; font-weight: 600; color: var(--text-light); }
        
        .limit-track {
            width: 100%; height: 12px; background: #e5e7eb; border-radius: 6px;
            display: flex; overflow: hidden; position: relative;
        }
        
        .bar-segment { height: 100%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .bar-current { background-color: var(--primary); } 
        .bar-future { background-color: var(--warning); }
        
        .limit-legend {
            display: flex; gap: 15px; margin-top: 12px; font-size: 0.75rem; color: var(--text-light); font-weight: 500;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot.current { background: var(--primary); }
        .dot.future { background: var(--warning); }
        .dot.avail { background: #e5e7eb; border: 1px solid #ccc; }

        /* --- CARROSSEL --- */
        .carousel-title { padding: 0 24px; margin-bottom: 15px; font-size: 1.1rem; font-weight: 700; color: var(--text-main); }

        .carousel-container {
            overflow-x: auto; display: flex; scroll-snap-type: x mandatory;
            padding: 10px 24px 40px 24px; gap: 15px;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .carousel-container::-webkit-scrollbar { display: none; }

        .invoice-card {
            min-width: 88%; background: white; border-radius: 24px; padding: 24px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.06); scroll-snap-align: center;
            position: relative; border: 1px solid rgba(0,0,0,0.03);
            display: flex; flex-direction: column;
        }

        .invoice-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .invoice-status-pill {
            padding: 6px 14px; border-radius: 30px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .status-open { background: #fee2e2; color: var(--primary); }
        .status-future { background: #fff7ed; color: var(--warning); }
        .status-paid { background: #ecfdf5; color: var(--success); }

        .invoice-month { font-size: 0.9rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; }
        .invoice-label { font-size: 0.85rem; color: var(--text-light); margin-bottom: 4px; }
        .invoice-amount { font-size: 2.4rem; font-weight: 800; color: var(--text-main); letter-spacing: -1px; line-height: 1; margin-bottom: 20px;}
        .invoice-amount.paid { color: var(--success); text-decoration: line-through; opacity: 0.6; }
        .invoice-cents { font-size: 1.2rem; vertical-align: top; margin-top: 4px; display: inline-block;}

        .invoice-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; }
        .invoice-due { font-size: 0.85rem; font-weight: 500; color: var(--text-light); }
        .invoice-due strong { color: var(--text-main); }

        .btn-details {
            background: transparent; color: var(--primary); border: none;
            font-weight: 700; font-size: 0.9rem; cursor: pointer;
            display: flex; align-items: center; gap: 5px;
        }

        /* --- MODAIS --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; align-items: flex-end; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .bottom-sheet {
            background: white; width: 100%; max-width: 600px;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 30px 24px;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh; display: flex; flex-direction: column;
        }
        .modal-overlay.active .bottom-sheet { transform: translateY(0); }

        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .sheet-title { font-size: 1.2rem; font-weight: 700; color: var(--text-main); }
        .sheet-close { background: #f3f4f6; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 1.5rem; color: #666; cursor: pointer; display: grid; place-items: center; }
        .sheet-body { overflow-y: auto; padding-bottom: 20px; }

        /* Lista de Itens */
        .transaction-item { display: flex; align-items: center; gap: 15px; padding: 16px 0; border-bottom: 1px solid #f3f4f6; cursor: pointer; }
        .transaction-item:active { background-color: #f9fafb; }
        .trans-icon { width: 42px; height: 42px; border-radius: 12px; display: grid; place-items: center; font-size: 1.2rem; flex-shrink: 0; }
        .trans-icon.loja { background: #fff1f2; color: var(--primary); }
        .trans-icon.pagamento { background: #ecfdf5; color: var(--success); }
        .trans-icon.atraso { background: #fee2e2; color: var(--danger); }
        .trans-info { flex-grow: 1; }
        .trans-title { font-size: 0.95rem; font-weight: 600; color: var(--text-main); display: block; margin-bottom: 2px;}
        .trans-date { font-size: 0.75rem; color: var(--text-light); }
        .trans-amount { font-weight: 700; font-size: 1rem; color: var(--text-main); text-align: right; }
        .trans-amount.credit { color: var(--success); }

        /* Detalhe */
        .transaction-detail-box { text-align: center; padding: 10px 0; margin-bottom: 20px; }
        .big-amount { font-size: 2rem; font-weight: 800; color: var(--text-main); margin: 10px 0; }
        .detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem; }
        .detail-row span:last-child { font-weight: 600; color: var(--text-main); }
        
        .btn-view-receipt { background: var(--text-main); color: white; width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 600; font-size: 1rem; margin-top: 25px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none; }
        .btn-view-receipt:hover { opacity: 0.9; }

        /* Viewer IMG */
        #modal-receipt .modal-card { background: black; width: 100%; height: 100%; max-width: none; border-radius: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #receipt-img { max-width: 100%; max-height: 80vh; object-fit: contain; border-radius: 8px; box-shadow: 0 5px 20px rgba(255,255,255,0.1); }

        /* Login PIN */
        #login-screen { position: fixed; inset: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .login-card { background: white; padding: 40px 30px; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); width: 100%; max-width: 350px; animation: slideUp 0.4s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .login-avatar { width: 80px; height: 80px; background: var(--bg); border-radius: 50%; margin: 0 auto 20px; display: grid; place-items: center; font-size: 2.5rem; color: var(--primary); border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .pin-display { display: flex; gap: 10px; justify-content: center; margin: 25px 0; }
        .pin-dot { width: 15px; height: 15px; border-radius: 50%; border: 2px solid #ddd; transition: all 0.2s; }
        .pin-dot.filled { background: var(--primary); border-color: var(--primary); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .num-btn { background: none; border: 1px solid #eee; border-radius: 12px; padding: 15px 0; font-size: 1.5rem; font-weight: 600; cursor: pointer; transition: background 0.1s; }
        .num-btn:active { background: #f0f0f0; }
        .num-btn.clear { color: var(--danger); font-size: 1rem; display: grid; place-items: center;}

        /* Loading */
        #loading { position: fixed; inset: 0; background: var(--bg); z-index: 6000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .profile-row { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .profile-label { font-size: 0.75rem; color: var(--text-light); display: block; margin-bottom: 4px; }
        .profile-val { font-size: 1rem; font-weight: 600; color: var(--text-main); }

        #error-container { padding: 40px; text-align: center; color: var(--danger); display: none; }
        #app-content { display: none; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:#666; font-weight:500;">Carregando...</p>
    </div>

    <div id="login-screen">
        <div class="login-card">
            <div class="login-avatar">
                <i class='bx bxs-user'></i>
            </div>
            <h3 style="margin-bottom: 5px; color: var(--text-main);" id="login-name">Cliente</h3>
            <p style="color: var(--text-light); font-size: 0.9rem;">Digite sua senha de acesso</p>

            <div class="pin-display">
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            </div>

            <div class="numpad">
                <button class="num-btn" onclick="typePin(1)">1</button>
                <button class="num-btn" onclick="typePin(2)">2</button>
                <button class="num-btn" onclick="typePin(3)">3</button>
                <button class="num-btn" onclick="typePin(4)">4</button>
                <button class="num-btn" onclick="typePin(5)">5</button>
                <button class="num-btn" onclick="typePin(6)">6</button>
                <button class="num-btn" onclick="typePin(7)">7</button>
                <button class="num-btn" onclick="typePin(8)">8</button>
                <button class="num-btn" onclick="typePin(9)">9</button>
                <button class="num-btn clear" onclick="clearPin()">C</button>
                <button class="num-btn" onclick="typePin(0)">0</button>
                <button class="num-btn clear" onclick="backspacePin()"><i class='bx bx-left-arrow-alt'></i></button>
            </div>
            <p id="login-error" style="color: var(--danger); margin-top: 15px; font-size: 0.9rem; display:none;"></p>
        </div>
    </div>

    <div id="app-content">
        <header class="app-header">
            <div class="header-top">
                <div class="logo-area"><h2>D'TUDO</h2><span>Crediário Digital</span></div>
                <button class="user-btn" onclick="openProfile()"><i class='bx bx-user'></i></button>
            </div>
            <div class="virtual-card">
                <div class="card-top"><img src="assets/logo.png" alt="Logo" class="card-logo-img"></div>
                <div class="card-middle"><div class="card-number">**** **** **** <span id="card-last-digits">0000</span></div></div>
                <div class="card-bottom"><div><span class="card-label">CLIENTE VIP</span><span class="card-holder" id="card-holder-name">...</span></div><div class="card-vip">VIP</div></div>
            </div>
        </header>

        <div class="limit-section" id="limit-section">
            <div class="limit-header"><span class="limit-title">Limite de crédito</span><span class="limit-value" id="limit-total-text">R$ 0,00</span></div>
            <div class="limit-track" id="limit-track-bg">
                <div class="bar-segment bar-current" id="bar-current" style="width: 0%"></div>
                <div class="bar-segment bar-future" id="bar-future" style="width: 0%"></div>
            </div>
            <div class="limit-legend">
                <div class="legend-item"><div class="dot current"></div> <span>Atual</span></div>
                <div class="legend-item"><div class="dot future"></div> <span>Futuro</span></div>
                <div class="legend-item"><div class="dot avail"></div> <span id="val-avail" style="color:var(--success);">Disponível</span></div>
            </div>
        </div>

        <div class="carousel-title">Minhas Faturas</div>
        <div class="carousel-container" id="invoices-carousel"></div>
    </div>

    <div id="modal-details" class="modal-overlay" onclick="if(event.target === this) closeModal('modal-details')">
        <div class="bottom-sheet">
            <div class="sheet-header"><span class="sheet-title" id="sheet-month-title">Detalhes</span><button class="sheet-close" onclick="closeModal('modal-details')"><i class='bx bx-x'></i></button></div>
            <div class="sheet-body" id="sheet-list"></div>
        </div>
    </div>

    <div id="modal-transaction-view" class="modal-overlay" onclick="if(event.target === this) closeModal('modal-transaction-view')">
        <div class="bottom-sheet">
            <div class="sheet-header"><span class="sheet-title">Detalhes</span><button class="sheet-close" onclick="closeModal('modal-transaction-view')"><i class='bx bx-x'></i></button></div>
            <div class="sheet-body">
                <div class="transaction-detail-box">
                    <div class="trans-icon" id="detail-icon" style="margin: 0 auto 15px auto; width: 60px; height: 60px; font-size: 1.8rem;"></div>
                    <h4 id="detail-title" style="color:var(--text-light); margin-bottom:5px;">Compra</h4>
                    <div class="big-amount" id="detail-amount">R$ 0,00</div>
                </div>
                <div class="detail-row"><span>Data</span><span id="detail-date">--</span></div>
                <div class="detail-row"><span>Descrição</span><span id="detail-desc">...</span></div>
                <div class="detail-row"><span>Tipo</span><span id="detail-type">...</span></div>
                <button id="btn-view-receipt" class="btn-view-receipt" style="display: none;"><i class='bx bx-file'></i> Visualizar Comprovante</button>
                <p id="no-receipt-msg" style="text-align: center; color: #999; margin-top: 20px; font-size: 0.8rem; display: none;">Nenhum comprovante.</p>
            </div>
        </div>
    </div>

    <div id="modal-profile" class="modal-overlay" onclick="if(event.target === this) closeModal('modal-profile')">
        <div class="bottom-sheet">
            <div class="sheet-header"><span class="sheet-title">Meus Dados</span><button class="sheet-close" onclick="closeModal('modal-profile')"><i class='bx bx-x'></i></button></div>
            <div class="sheet-body">
                <div class="profile-row"><span class="profile-label">Nome</span><span class="profile-val" id="prof-name">...</span></div>
                <div class="profile-row"><span class="profile-label">Endereço</span><span class="profile-val" id="prof-address">...</span></div>
                <div class="profile-row"><span class="profile-label">Telefone</span><span class="profile-val" id="prof-phone">...</span></div>
                <div class="profile-row" style="border:none;"><span class="profile-label">Vencimento</span><span class="profile-val" id="prof-day">Dia 10</span></div>
            </div>
        </div>
    </div>

    <div id="modal-receipt" class="modal-overlay" style="background:rgba(0,0,0,0.95); z-index: 6000;">
        <div class="modal-card">
            <button onclick="closeModal('modal-receipt')" style="position:absolute; top:20px; right:20px; background:rgba(255,255,255,0.2); border:none; color:white; width:40px; height:40px; border-radius:50%; font-size:1.5rem; cursor:pointer; z-index:10;"><i class='bx bx-x'></i></button>
            <p style="color:white; margin-bottom:15px; font-weight:600;">Comprovante / Assinatura</p>
            <img id="receipt-img" src="" alt="Comprovante">
            <p style="color:#aaa; font-size:0.8rem; margin-top:15px;">D'TUDO SISTEMAS</p>
        </div>
    </div>

    <div id="error-container"></div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzB7dluoiNyJ4XK6oDK_iyuKZfwPTAJa4ua4RetQsUX9cMObgE-k_tFGI82HxW_OyMf/execc";
    
    let CACHE_DATA = null;
    let FATURAS = [];
    let CURRENT_ITEMS = [];
    let GLOBAL_ID = null;
    let PIN = "";

    // --- FUNÇÃO AUXILIAR DE DATA ROBUSTA ---
    function parseDateSafe(dateVal) {
        if (!dateVal) return new Date();
        if (dateVal instanceof Date) return dateVal;
        
        // Se for string ISO com T (ex: 2025-12-17T13:10:13)
        if (typeof dateVal === 'string' && dateVal.includes('T')) {
            return new Date(dateVal);
        }
        
        // Se for string BR (ex: 17/12/2025)
        if (typeof dateVal === 'string' && dateVal.includes('/')) {
            // Remove hora se tiver
            const parts = dateVal.split(' ')[0].split('/');
            if (parts.length === 3) {
                // Formato dd/mm/yyyy
                return new Date(parts[2], parts[1]-1, parts[0], 12, 0, 0);
            }
        }
        
        // Fallback
        const d = new Date(dateVal);
        if (isNaN(d.getTime())) return new Date(); // Retorna hoje se falhar
        return d;
    }

    async function init() {
        const urlParams = new URLSearchParams(window.location.search);
        GLOBAL_ID = urlParams.get('q') || urlParams.get('id');

        if (!GLOBAL_ID) { showError("Link inválido."); return; }
        await loadData();
    }

    async function loadData() {
        try {
            document.getElementById('loading').style.display = 'flex';
            const url = `${API_URL}?action=obterDadosFatura&idCliente=${GLOBAL_ID}&pin=${PIN}`;
            const res = await fetch(url);
            const json = await res.json();

            document.getElementById('loading').style.display = 'none';

            if (json.status === 'auth_required') {
                showLoginScreen(json.cliente.nome);
            } else if (json.status === 'success') {
                CACHE_DATA = json;
                hideLoginScreen();
                renderHeader(json.cliente);
                processarFaturasUnificadas(json); // LÓGICA CORRIGIDA AQUI
                renderLimitBar(json.cliente, FATURAS); 
                document.getElementById('app-content').style.display = 'block';
            } else {
                if (PIN.length > 0) {
                    document.getElementById('login-error').textContent = "Senha incorreta.";
                    document.getElementById('login-error').style.display = 'block';
                    clearPin();
                } else {
                    showError(json.message);
                }
            }
        } catch (e) {
            document.getElementById('loading').style.display = 'none';
            showError(e.message);
        }
    }

    // --- LÓGICA DE FATURAS (CORREÇÃO DO BUG DA BAIXA) ---
    function processarFaturasUnificadas(data) {
        const logs = data.historico || [];
        const diaVenc = parseInt(data.cliente.diaVencimento) || 10;
        const hoje = new Date();
        hoje.setHours(0,0,0,0);

        const faturasMap = {};

        logs.forEach(log => {
            let dataCompetencia;
            // Se tem parcela explícita
            if (log.vencimentoParcela && log.vencimentoParcela.length > 5) {
                dataCompetencia = parseDateSafe(log.vencimentoParcela);
            } else {
                // Compra/Pagamento avulso
                const dataVenda = parseDateSafe(log.data);
                let base = new Date(dataVenda.getFullYear(), dataVenda.getMonth(), diaVenc);
                let corte = new Date(base); corte.setDate(base.getDate() - 10);
                
                if (dataVenda >= corte) {
                    if (dataVenda.getDate() >= (diaVenc - 10)) base.setMonth(base.getMonth() + 1);
                }
                dataCompetencia = base;
            }
            
            // Chave YYYY-MM
            const chave = `${dataCompetencia.getFullYear()}-${String(dataCompetencia.getMonth()+1).padStart(2,'0')}`;
            
            if (!faturasMap[chave]) {
                faturasMap[chave] = {
                    dataVencimento: new Date(dataCompetencia.getFullYear(), dataCompetencia.getMonth(), diaVenc),
                    totalCompras: 0, totalPagos: 0, itens: []
                };
            }
            
            faturasMap[chave].itens.push(log);
            
            // CORREÇÃO CRÍTICA: Trata 'Baixa' (valor negativo) como pagamento, independente do nome do tipo
            if (String(log.tipo).toLowerCase().includes('pagamento') || log.valor < 0) {
                faturasMap[chave].totalPagos += Math.abs(log.valor);
            } else {
                faturasMap[chave].totalCompras += log.valor;
            }
        });

        let listaCrua = Object.values(faturasMap).sort((a, b) => a.dataVencimento - b.dataVencimento);
        let listaFinal = [];
        let acumuladoAtraso = { total: 0, itens: [] };

        // --- LOOP DE ACUMULAÇÃO CORRIGIDO ---
        listaCrua.forEach(fat => {
            // Saldo Algébrico (Compras - Pagamentos)
            // Se teve baixa (-394), o saldo será negativo (crédito) ou zero.
            const saldo = fat.totalCompras - fat.totalPagos;
            
            // Se a fatura é passada (< hoje)
            if (fat.dataVencimento < hoje) {
                // SOMA TUDO, POSITIVO OU NEGATIVO
                // Isso permite que o crédito de uma baixa anule o débito de uma compra antiga
                acumuladoAtraso.total += saldo;
                
                // Adiciona visualmente os itens (apenas se for relevante, ou esconde se for zero a zero)
                // Mas vamos guardar para mostrar no detalhe "Saldo Anterior"
                if (saldo !== 0) { // Opcional: filtrar itens zerados
                    fat.itens.forEach(i => { i.isAtrasado = true; acumuladoAtraso.itens.push(i); });
                }
            } else {
                // Fatura Futura ou Atual (Vence hoje ou depois)
                listaFinal.push(fat);
            }
        });

        // Se o acumulado final for positivo (> 0.01), significa que restou dívida REAL.
        // Se for 0 (ou negativo), a dívida foi quitada/baixada.
        if (acumuladoAtraso.total > 0.01) {
            // Soma na primeira fatura disponível (Atual)
            if (listaFinal.length > 0) {
                listaFinal[0].totalCompras += acumuladoAtraso.total;
                // Adiciona itens antigos no topo da lista
                listaFinal[0].itens = [...acumuladoAtraso.itens, ...listaFinal[0].itens];
                listaFinal[0].hasAtraso = true;
            } else {
                // Se não tem fatura futura, cria uma 'Vencida' para hoje
                listaFinal.push({
                    dataVencimento: hoje,
                    totalCompras: acumuladoAtraso.total,
                    totalPagos: 0,
                    itens: acumuladoAtraso.itens,
                    hasAtraso: true
                });
            }
        }
        // Se acumuladoAtraso <= 0.01, ignoramos (dívida foi paga/renegociada)

        // Se lista vazia (tudo pago/baixado e nada futuro), cria card zerado
        if (listaFinal.length === 0) {
            listaFinal.push({ dataVencimento: new Date(hoje.getFullYear(), hoje.getMonth(), diaVenc), totalCompras: 0, totalPagos: 0, itens: [] });
        }

        FATURAS = listaFinal;
        renderCarousel();
    }

    // --- RESTANTE DO CÓDIGO (Interface) ---
    
    function showLoginScreen(nome) {
        document.getElementById('login-name').textContent = nome || "Cliente";
        document.getElementById('login-screen').style.display = 'flex';
    }
    function hideLoginScreen() { document.getElementById('login-screen').style.display = 'none'; }
    function typePin(num) { if (PIN.length < 6) { PIN += num; updatePinDots(); if (PIN.length === 6) setTimeout(loadData, 300); } }
    function backspacePin() { PIN = PIN.slice(0, -1); updatePinDots(); document.getElementById('login-error').style.display = 'none'; }
    function clearPin() { PIN = ""; updatePinDots(); }
    function updatePinDots() {
        document.querySelectorAll('.pin-dot').forEach((dot, idx) => {
            if (idx < PIN.length) dot.classList.add('filled'); else dot.classList.remove('filled');
        });
    }

    function renderHeader(cli) {
        document.getElementById('card-holder-name').textContent = cli.nome || "Cliente";
        let last4 = (cli.id && cli.id.length >= 4) ? cli.id.slice(-4).toUpperCase() : "0000";
        document.getElementById('card-last-digits').textContent = last4;
        document.getElementById('prof-name').textContent = cli.nome;
        document.getElementById('prof-day').textContent = "Dia " + (cli.diaVencimento || 10);
        document.getElementById('prof-address').textContent = cli.endereco || "Não cadastrado";
        document.getElementById('prof-phone').textContent = cli.telefone || "Não cadastrado";
    }

    function renderCarousel() {
        const c = document.getElementById('invoices-carousel'); c.innerHTML = '';
        const meses = ["JAN", "FEV", "MAR", "ABR", "MAI", "JUN", "JUL", "AGO", "SET", "OUT", "NOV", "DEZ"];
        const hoje = new Date(); hoje.setHours(0,0,0,0);

        FATURAS.forEach((fat, idx) => {
            const saldo = fat.totalCompras - fat.totalPagos;
            let st = { txt: "ABERTA", bg: "#fee2e2", col: "var(--primary)" };
            if (saldo <= 0.01) st = { txt: "PAGA", bg: "#ecfdf5", col: "var(--success)" };
            else if (fat.hasAtraso || fat.dataVencimento < hoje) st = { txt: "ATRASADA", bg: "#fecaca", col: "#b91c1c" };
            else if (fat.dataVencimento > hoje && idx > 0) st = { txt: "FUTURA", bg: "#fff7ed", col: "#d97706" };

            const val = saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2}).split(',');
            const card = document.createElement('div'); card.className = 'invoice-card';
            card.innerHTML = `
                <div class="invoice-header"><span class="invoice-month">${meses[fat.dataVencimento.getMonth()]} ${fat.dataVencimento.getFullYear()}</span><span class="invoice-status-pill" style="background:${st.bg}; color:${st.col}">${st.txt}</span></div>
                <div class="invoice-body"><div class="invoice-label">Valor</div><div class="invoice-amount ${saldo<=0.01?'paid':''}" style="color:${saldo<=0.01?'var(--success)':'var(--text-main)'}"><span style="font-size:1rem;vertical-align:top;margin-top:6px;display:inline-block">R$</span>${val[0]}<span class="invoice-cents">,${val[1]}</span></div></div>
                <div class="invoice-footer"><div class="invoice-due">Vencimento <strong>${fat.dataVencimento.toLocaleDateString('pt-BR')}</strong></div><button class="btn-details" onclick="showDetails(${idx})">Ver detalhes <i class='bx bx-chevron-right'></i></button></div>
            `;
            c.appendChild(card);
        });
    }

    window.showDetails = (idx) => {
        const fat = FATURAS[idx];
        CURRENT_ITEMS = fat.itens;
        const c = document.getElementById('sheet-list'); c.innerHTML = '';
        const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        document.getElementById('sheet-month-title').textContent = `Fatura de ${meses[fat.dataVencimento.getMonth()]}`;

        if (fat.itens.length === 0) c.innerHTML = '<p style="text-align:center;padding:20px;color:#999;">Sem lançamentos.</p>';
        else {
            // Ordena: Mais recentes primeiro
            fat.itens.sort((a,b)=> parseDateSafe(b.data) - parseDateSafe(a.data));
            fat.itens.forEach((item, i) => {
                const isPag = String(item.tipo).toLowerCase().includes('pagamento') || item.valor < 0;
                const dateStr = parseDateSafe(item.data).toLocaleDateString('pt-BR', {day:'2-digit', month:'short'});
                let icon = isPag ? 'bx-dollar-circle' : (item.isAtrasado ? 'bx-time-five' : 'bx-shopping-bag');
                let cls = isPag ? 'pagamento' : (item.isAtrasado ? 'atraso' : 'loja');
                let title = isPag?'Pagamento':(item.obs||item.tipo);
                if(item.isAtrasado && !isPag) title += " (Atrasado)";

                const div = document.createElement('div'); div.className = 'transaction-item';
                div.onclick = () => showTransaction(i);
                div.innerHTML = `
                    <div class="trans-icon ${cls}"><i class='bx ${icon}'></i></div>
                    <div class="trans-info"><span class="trans-title">${title}</span><span class="trans-date">${dateStr}</span></div>
                    <div class="trans-amount ${isPag?'credit':''}">${isPag?'':''} ${formatBRL(Math.abs(item.valor))} <i class='bx bx-chevron-right' style="font-size:1.2rem;vertical-align:middle;color:#ccc;"></i></div>
                `;
                c.appendChild(div);
            });
        }
        document.getElementById('modal-details').classList.add('active');
    };

    window.showTransaction = (idx) => {
        const item = CURRENT_ITEMS[idx];
        const isPag = String(item.tipo).toLowerCase().includes('pagamento') || item.valor < 0;
        
        document.getElementById('detail-title').textContent = item.obs || item.tipo;
        document.getElementById('detail-amount').textContent = formatBRL(Math.abs(item.valor));
        document.getElementById('detail-amount').style.color = isPag ? 'var(--success)' : 'var(--text-main)';
        document.getElementById('detail-date').textContent = parseDateSafe(item.data).toLocaleString('pt-BR');
        document.getElementById('detail-desc').textContent = item.obs || "Sem descrição";
        document.getElementById('detail-type').textContent = item.tipo;

        const iconDiv = document.getElementById('detail-icon');
        iconDiv.className = `trans-icon ${isPag ? 'pagamento' : 'loja'}`;
        iconDiv.innerHTML = `<i class='bx ${isPag ? 'bx-dollar-circle' : 'bx-shopping-bag'}</i>`;

        const btn = document.getElementById('btn-view-receipt');
        const msg = document.getElementById('no-receipt-msg');

        if (item.anexo && item.anexo.length > 5) {
            btn.style.display = 'flex';
            btn.onclick = (e) => { e.preventDefault(); openReceiptImage(item.anexo); };
            msg.style.display = 'none';
        } else {
            btn.style.display = 'none';
            msg.style.display = 'block';
        }
        document.getElementById('modal-transaction-view').classList.add('active');
    };

    function openReceiptImage(url) {
        let fileId = null;
        const match1 = url.match(/\/d\/(.+?)\//);
        if (match1) fileId = match1[1];
        else { const match2 = url.match(/id=([^&]+)/); if (match2) fileId = match2[1]; }

        if (fileId) document.getElementById('receipt-img').src = `https://drive.google.com/uc?export=view&id=${fileId}`;
        else document.getElementById('receipt-img').src = url;
        
        document.getElementById('modal-receipt').classList.add('active');
    }

    function renderLimitBar(cli, faturas) {
        const lim = parseFloat(cli.limite) || 0;
        document.getElementById('limit-total-text').textContent = formatBRL(lim);
        if (lim <= 0) { document.getElementById('limit-section').style.display = 'none'; return; }

        let atual = 0, futuro = 0;
        faturas.forEach((f, i) => {
            const s = f.totalCompras - f.totalPagos;
            if (s > 0.01) { if (i === 0) atual += s; else futuro += s; }
        });

        const usado = atual + futuro;
        const disp = lim - usado;
        const base = Math.max(lim, usado);
        let pa = base>0 ? (atual/base)*100 : 0;
        let pf = base>0 ? (futuro/base)*100 : 0;
        if(atual>0 && pa<2) pa=2; if(futuro>0 && pf<2) pf=2;

        document.getElementById('bar-current').style.width = `${pa}%`;
        document.getElementById('bar-future').style.width = `${pf}%`;
        
        document.getElementById('limit-track-bg').style.background = usado > lim ? '#fee2e2' : '#e5e7eb';
        const el = document.getElementById('val-avail');
        if(disp >= 0) { el.textContent = `Disponível: ${formatBRL(disp)}`; el.style.color = 'var(--success)'; }
        else { el.textContent = `Excedido: ${formatBRL(Math.abs(disp))}`; el.style.color = 'var(--danger)'; }
    }

    function formatBRL(v) { return (v||0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
    function _somarDias(d, n) { let r = new Date(d); r.setDate(r.getDate()+n); return r; }
    function showError(m) { document.getElementById('error-container').textContent = m; document.getElementById('error-container').style.display = 'block'; }
    window.openProfile = () => document.getElementById('modal-profile').classList.add('active');
    window.closeModal = (id) => document.getElementById(id).classList.remove('active');

    init();
</script>
</body>
</html>