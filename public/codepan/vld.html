<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validação de Cartão</title>
    <style>
        :root {
            --cor-principal: #db0038;
            --cor-fundo: #f0f2f5;
            --cor-texto: #333;
            --cor-texto-claro: #fff;
            --cor-sombra: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: var(--cor-fundo);
            overflow: hidden; /* Evita barras de rolagem */
        }

        /* --- CONTÊINERES DE VISUALIZAÇÃO --- */
        .view {
            width: 100%;
            max-width: 420px;
            padding: 20px;
            box-sizing: border-box;
        }

        #loading-view, #error-view, #initial-view {
            text-align: center;
        }

        /* --- ESTILO DO CARTÃO (INSPIRAÇÃO) --- */
        .card-container {
            background: linear-gradient(135deg, var(--cor-principal), #a10028);
            border-radius: 20px;
            padding: 20px;
            color: var(--cor-texto-claro);
            box-shadow: 0 10px 30px rgba(219, 0, 56, 0.3);
            position: relative;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }
        .card-header .back-arrow {
            font-size: 24px;
            cursor: pointer;
            font-weight: bold;
        }
        .card-header .title {
            font-size: 18px;
            font-weight: 500;
        }
        .card-body {
            text-align: left;
        }
        .card-body .limit-label {
            font-size: 16px;
            opacity: 0.8;
        }
        .card-body .limit-value {
            font-size: 48px;
            font-weight: bold;
            margin: 5px 0 30px 0;
        }
        .card-footer {
            font-family: monospace;
            font-size: 20px;
            letter-spacing: 2px;
            text-align: center;
        }
        .card-footer .user-name {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto; /* Volta para a fonte padrão */
            font-size: 18px;
            letter-spacing: normal;
            margin-top: 10px;
            opacity: 0.9;
        }

        /* --- ESTADO DE ERRO --- */
        #error-view h2 {
            color: var(--cor-principal);
        }

    </style>
</head>
<body>

    <div class="view" id="initial-view">
        <h2>Aproxime um cartão para iniciar a validação.</h2>
    </div>

    <div class="view" id="loading-view" style="display: none;">
        <h2>Carregando dados...</h2>
    </div>

    <div class="view" id="card-view" style="display: none;">
        <div class="card-container">
            <div class="card-header">
                <span class="back-arrow" id="back-button">&#x2190;</span>
                <span class="title">Detalhes do Cartão</span>
                <span></span> </div>
            <div class="card-body">
                <div class="limit-label">Limite Disponível</div>
                <div class="limit-value" id="card-limit">R$ 0,00</div>
            </div>
            <div class="card-footer">
                <div class="card-number" id="card-number">•••• •••• •••• 0000</div>
                <div class="user-name" id="card-name">Nome do Usuário</div>
            </div>
        </div>
    </div>

    <div class="view" id="error-view" style="display: none;">
        <h2>Erro na Validação</h2>
        <p id="error-message">Mensagem de erro aqui.</p>
        <button id="back-button-error">Tentar Novamente</button>
    </div>


    <script>
        // --- ELEMENTOS DA PÁGINA ---
const initialView = document.getElementById('initial-view');
const loadingView = document.getElementById('loading-view');
const cardView = document.getElementById('card-view');
const errorView = document.getElementById('error-view');

const cardLimitEl = document.getElementById('card-limit');
const cardNumberEl = document.getElementById('card-number');
const cardNameEl = document.getElementById('card-name');
const errorMessageEl = document.getElementById('error-message');

const backButton = document.getElementById('back-button');
const backButtonError = document.getElementById('back-button-error');


// --- FUNÇÕES AUXILIARES ---

/** Mostra uma "view" e esconde as outras */
function showView(viewToShow) {
    initialView.style.display = 'none';
    loadingView.style.display = 'none';
    cardView.style.display = 'none';
    errorView.style.display = 'none';
    viewToShow.style.display = 'block';
}

/** Formata o número do cartão para "•••• •••• •••• 1234" */
function formatCardNumber(cardNumber) {
    const lastFourDigits = cardNumber.slice(-4);
    return `•••• •••• •••• ${lastFourDigits}`;
}

/** Formata o limite como moeda brasileira */
function formatLimit(limit) {
    const number = parseFloat(limit) || 0;
    return number.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

/** Reseta a página para o estado inicial */
function resetToInitialView() {
    showView(initialView);
}


// --- LÓGICA PRINCIPAL ---

// Roda assim que a página é carregada
document.addEventListener('DOMContentLoaded', function() {
    
    // 1. VERIFICAÇÃO DE SEGURANÇA (TOKEN DE LOGIN)
    const authTokenString = localStorage.getItem('authToken');
    let tokenValido = false;
    if (authTokenString) {
        const authToken = JSON.parse(authTokenString);
        const agora = new Date().getTime();
        const vinteHorasEmMs = 20 * 60 * 60 * 1000;
        if ((agora - authToken.loginTime) < vinteHorasEmMs) {
            tokenValido = true;
        } else {
            localStorage.removeItem('authToken');
        }
    }

    if (!tokenValido) {
        initialView.innerHTML = `<h2>Acesso Negado</h2><p>Sua sessão expirou ou você não tem permissão.</p>`;
        showView(initialView);
        return; // Para a execução
    }

    // 2. VERIFICAÇÃO DO PARÂMETRO NA URL
    const urlParams = new URLSearchParams(window.location.search);
    const idCartao = urlParams.get('id');

    if (idCartao) {
        // Se tem token e ID, começa o processo!
        showView(loadingView);
        buscarDadosDoCartao(idCartao);
    } else {
        // Se tem token mas não tem ID, fica na tela inicial
        showView(initialView);
    }
});

// Adiciona funcionalidade aos botões de "voltar"
backButton.addEventListener('click', resetToInitialView);
backButtonError.addEventListener('click', resetToInitialView);


// --- BUSCA DE DADOS (FETCH) ---
function buscarDadosDoCartao(id) {
    const scriptUrl = "https://script.google.com/macros/s/AKfycbzfBZz74Zlj-EHgNUxP2hWIzqw8MlaLiaOhNf_wIaOJgnA72HbMdk-yyZOErDIb4zU_fg/exec"; // << SUBSTITUA AQUI
    const tokenSecreto = "senhaSuperSecreta123";

    const urlCompleta = `${scriptUrl}?action=lookup&id=${id}&token=${tokenSecreto}`;

    fetch(urlCompleta)
        .then(response => response.json())
        .then(data => {
            // Atraso de 1 segundo para simular o carregamento e melhorar a UX
            setTimeout(() => {
                if (data.erro) {
                    // Se o script retornou um erro
                    errorMessageEl.innerText = data.erro;
                    showView(errorView);
                } else {
                    // Se os dados vieram com sucesso
                    cardLimitEl.innerText = formatLimit(data.limit);
                    cardNumberEl.innerText = formatCardNumber(id);
                    cardNameEl.innerText = data.nome;
                    showView(cardView);
                }
            }, 1000); 
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
            errorMessageEl.innerText = "Erro de comunicação com o servidor.";
            showView(errorView);
        });
}
    </script>

</body>
</html>