<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validar Comprovante - Eletro Business</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        :root { --primary: #db0038; --bg: #f4f4f9; --card: #ffffff; --text: #333; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .container { background: var(--card); width: 100%; max-width: 450px; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; position: relative; z-index: 1; }
        .logo { color: var(--primary); font-size: 2rem; margin-bottom: 10px; }
        h2 { margin-bottom: 8px; font-size: 1.2rem; }
        p { color: #666; font-size: 0.9rem; margin-bottom: 24px; line-height: 1.5; }
        
        /* Opções de Tipo */
        .type-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; text-align: left; }
        .type-card { border: 2px solid #eee; border-radius: 12px; padding: 15px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .type-card:hover { border-color: var(--primary); background-color: #fff0f3; }
        .type-card i { font-size: 40px; color: #333; margin-bottom: 10px; display: block; }
        .type-card span { font-weight: 600; font-size: 0.9rem; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn { border: 2px solid var(--primary); color: white; background-color: var(--primary); padding: 14px 20px; border-radius: 8px; font-size: 1rem; font-weight: bold; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-outline { background-color: transparent; color: var(--primary); border: 2px solid var(--primary); }
        
        .upload-btn-wrapper { position: relative; width: 100%; margin-bottom: 15px; }
        .upload-btn-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        #preview-container { position: relative; width: 100%; overflow: hidden; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 15px; }
        #preview-img { display: block; width: 100%; height: auto; }
        .scanner-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, transparent, rgba(255,0,0,0.4), transparent); border-bottom: 2px solid red; transform: translateY(-100%); opacity: 0; pointer-events: none; }
        .preview-container.scanning .scanner-overlay { opacity: 1; animation: scan 1.5s linear infinite; }
        @keyframes scan { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 0; visibility: hidden; transition: 0.3s; padding: 20px; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-box { background: white; padding: 30px; border-radius: 16px; text-align: center; max-width: 350px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <div id="state-loading">
            <div class="loader"></div>
            <h3>Buscando Venda...</h3>
            <p>Aguarde um momento.</p>
        </div>

        <div id="state-select-type" class="hidden">
            <div class="logo"><i class='bx bx-printer'></i></div>
            <h2>Tipo de Documento</h2>
            <p>Qual formato você imprimiu?</p>
            <div class="type-options">
                <div class="type-card" onclick="selectType('cupom')">
                    <i class='bx bx-receipt'></i>
                    <span>Cupom<br>Térmico</span>
                </div>
                <div class="type-card" onclick="selectType('a4')">
                    <i class='bx bx-file-blank'></i>
                    <span>Nota Auxiliar<br>(Folha A4)</span>
                </div>
            </div>
        </div>

        <div id="state-upload" class="hidden">
            <div class="logo"><i class='bx bxs-camera'></i></div>
            <h2 id="upload-title">Fotografar Documento</h2>
            <p>Cliente: <strong id="venda-data">...</strong></p>
            
            <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:20px; text-align:left; font-size:0.85rem;">
                <p style="margin:0 0 5px 0;"><strong><i class='bx bx-search'></i> Instrução:</strong></p>
                <p id="upload-instruction" style="margin:0; color:#db0038;">...</p>
            </div>

            <div class="upload-btn-wrapper">
                <button class="btn"><i class='bx bx-camera'></i> Tirar Foto</button>
                <input type="file" id="file-input" accept="image/*" capture="environment">
            </div>
        </div>

        <div id="state-preview" class="hidden">
            <div id="preview-container">
                <img id="preview-img" src="" alt="Preview">
                <div class="scanner-overlay"></div>
            </div>
            <button class="btn" id="confirm-btn"><i class='bx bx-check-circle'></i> Validar e Enviar</button>
            <button class="btn btn-outline" onclick="resetUpload()" style="margin-top: 10px;">Cancelar</button>
        </div>

        <div id="state-success" class="hidden">
            <i class='bx bx-check-circle' style="font-size: 50px; color: var(--primary);"></i>
            <h3>Sucesso!</h3>
            <p id="success-msg">Comprovante arquivado.</p>
            <a href="#" id="link-exists" target="_blank" class="btn hidden" style="text-decoration:none;">Ver Arquivo</a>
        </div>
    </div>

    <div class="modal-overlay" id="error-modal">
        <div class="modal-box">
            <i class='bx bx-error' style="font-size: 40px; color: #d32f2f;"></i>
            <h3 style="margin:10px 0;">Não Identificado</h3>
            <p id="modal-msg" style="font-size:0.9rem; color:#666;">...</p>
            <button class="btn" onclick="closeModal()">Tentar Novamente</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzvd0BBLEEQlu-ksnIbsmnYcjQNQuZcTrsCmXMKHGM5g7DPEk3Nj95X47LKbj7rRSAT/exec"; 
        
        let currentId = null;
        let currentIndex = null;
        let currentDocType = 'cupom'; // 'cupom' ou 'a4'
        let fileBase64 = null;

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            let id = params.get('id');
            if(!id) { const k=Array.from(params.keys()); if(k.length>0) id=k[0]; }
            
            if(!id) { showError("ID não fornecido."); return; }
            currentId = id;
            
            // Passo 1: Verificar Log no Backend
            verificarLog(id);
        });

        async function verificarLog(id) {
            try {
                const res = await fetch(`${SCRIPT_URL}?action=verificarUltimoLog&idCliente=${id}`);
                const json = await res.json();
                
                document.getElementById('state-loading').classList.add('hidden');
                
                if(json.status === 'success') {
                    currentIndex = json.data.rowIndex;
                    document.getElementById('venda-data').textContent = json.data.timestamp;
                    // Vai para seleção de tipo
                    document.getElementById('state-select-type').classList.remove('hidden');
                } else if (json.status === 'existente') {
                    showSuccess("Comprovante já enviado.", json.link);
                } else {
                    showError(json.message);
                }
            } catch(e) { showError("Erro de conexão."); }
        }

        // Seleção do Tipo
        window.selectType = (type) => {
            currentDocType = type;
            document.getElementById('state-select-type').classList.add('hidden');
            document.getElementById('state-upload').classList.remove('hidden');
            
            const instruction = document.getElementById('upload-instruction');
            const title = document.getElementById('upload-title');
            
            if(type === 'cupom') {
                title.textContent = "Fotografar Cupom";
                instruction.textContent = "O sistema buscará a palavra 'COMPROVANTE' ou o CNPJ.";
            } else {
                title.textContent = "Fotografar Nota A4";
                instruction.textContent = "O sistema buscará a frase 'COMPROVANTE DE COMPRA'.";
            }
        };

        // Upload e Compressão
        document.getElementById('file-input').addEventListener('change', async (e) => {
            if(!e.target.files[0]) return;
            const file = e.target.files[0];
            
            // Oculta upload, mostra preview
            document.getElementById('state-upload').classList.add('hidden');
            document.getElementById('state-preview').classList.remove('hidden');
            document.getElementById('confirm-btn').innerHTML = "Processando...";
            document.getElementById('confirm-btn').disabled = true;

            try {
                fileBase64 = await compressImage(file);
                document.getElementById('preview-img').src = fileBase64;
                document.getElementById('confirm-btn').innerHTML = "<i class='bx bx-check-circle'></i> Validar e Enviar";
                document.getElementById('confirm-btn').disabled = false;
            } catch(err) {
                showModal("Erro ao processar imagem.");
                resetUpload();
            }
        });

        // Lógica de Compressão (Escala de Cinza Suave)
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (ev) => {
                    const img = new Image();
                    img.src = ev.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        const max = 1500;
                        if(w > max) { h = Math.round(h*(max/w)); w = max; }
                        
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        
                        // Escala de cinza
                        const idata = ctx.getImageData(0,0,w,h);
                        const d = idata.data;
                        for(let i=0; i<d.length; i+=4) {
                            const v = (d[i]+d[i+1]+d[i+2])/3;
                            d[i]=d[i+1]=d[i+2]=v;
                        }
                        ctx.putImageData(idata,0,0);
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        };

        // Rotação
        const rotateImage = (base64) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64;
                img.onload = () => {
                    const c = document.createElement('canvas');
                    c.width = img.height; c.height = img.width;
                    const ctx = c.getContext('2d');
                    ctx.translate(c.width, 0);
                    ctx.rotate(90 * Math.PI / 180);
                    ctx.drawImage(img, 0, 0);
                    resolve(c.toDataURL('image/jpeg', 0.7));
                }
            });
        };

        // OCR e Envio
        document.getElementById('confirm-btn').addEventListener('click', async () => {
            const btn = document.getElementById('confirm-btn');
            const scanner = document.querySelector('.preview-container');
            
            btn.disabled = true;
            btn.innerHTML = "Lendo Texto...";
            scanner.classList.add('scanning');

            try {
                const worker = await Tesseract.createWorker('por');
                
                // Tentativa 1
                let ret = await worker.recognize(fileBase64);
                let text = ret.data.text.toUpperCase();
                let valid = checkText(text);

                // Tentativa 2 (Rotação) se falhar
                if(!valid) {
                    console.log("Tentando rotação...");
                    const rotated = await rotateImage(fileBase64);
                    ret = await worker.recognize(rotated);
                    text = ret.data.text.toUpperCase();
                    if(checkText(text)) {
                        fileBase64 = rotated; // Usa a girada
                        valid = true;
                    }
                }
                
                await worker.terminate();

                if(!valid) {
                    scanner.classList.remove('scanning');
                    let msg = "Não encontramos a palavra 'COMPROVANTE' ou o CNPJ.";
                    if(currentDocType === 'a4') msg = "Não encontramos a frase 'COMPROVANTE DE COMPRA'.";
                    showModal(msg);
                    btn.disabled = false; btn.innerHTML = "Tentar Novamente";
                    return;
                }

                // Envio
                btn.innerHTML = "Enviando...";
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'uploadComprovante',
                        idCliente: currentId,
                        rowIndex: currentIndex,
                        imageBase64: fileBase64
                    })
                });
                const json = await res.json();
                
                scanner.classList.remove('scanning');
                
                if(json.status === 'success') {
                    showSuccess("Salvo com sucesso!");
                } else {
                    showModal("Erro no servidor: " + json.message);
                    btn.disabled = false; btn.innerHTML = "Tentar Novamente";
                }

            } catch(e) {
                scanner.classList.remove('scanning');
                showModal("Erro técnico: " + e.message);
                btn.disabled = false; btn.innerHTML = "Tentar Novamente";
            }
        });

        // Função de Validação de Texto (O Cérebro)
        function checkText(text) {
            if(currentDocType === 'cupom') {
                // Para cupom: Procura "COMPROVANTE" ou o CNPJ
                if(text.includes("COMPROVANTE") || text.includes("45692327")) return true;
            } else {
                // Para A4: Procura frase específica
                if(text.includes("COMPROVANTE DE COMPRA") || text.includes("NOTA AUXILIAR")) return true;
            }
            return false;
        }

        // UI Helpers
        window.resetUpload = () => {
            document.getElementById('state-preview').classList.add('hidden');
            document.getElementById('state-upload').classList.remove('hidden');
            document.getElementById('file-input').value = '';
        };

        function showModal(msg) {
            document.getElementById('modal-msg').textContent = msg;
            document.getElementById('error-modal').classList.add('active');
        }
        window.closeModal = () => document.getElementById('error-modal').classList.remove('active');

        function showError(msg) {
            document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('state-error').classList.remove('hidden');
            document.getElementById('error-text').textContent = msg;
        }

        function showSuccess(msg, link) {
            document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('state-success').classList.remove('hidden');
            document.getElementById('success-msg').textContent = msg;
            if(link) {
                const btn = document.getElementById('link-exists');
                btn.href = link;
                btn.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>